# TG4 计时追踪（Time Tracking）验收记录

> 主工程：`lawclick-next/`  
> 约束：遵循 `prompt/1211架构设计.md`、`.agent/rules/lawclick.md`（无 mock、前后端真实闭环、MDI/浮窗落地）  
> 日期：2025-12-13

## 1. 交付物清单
- 子计划：`docs/TG4_计时追踪_子计划.md`
- 总计划状态更新：`docs/1211_架构落地开发总计划_v1.md`

## 2. 构建与基本验证
- 构建命令：`pnpm -C lawclick-next build`
- 结果：构建通过（Next.js 输出部分动态路由为 `ƒ` 属正常；同时存在若干 dynamic server usage 日志，不属于 TG4 变更范围）

## 3. 验收点（可执行清单）
1) 计时必须可回溯到案件/任务
- 计时开始入口：从任务看板卡片/案件看板进入（浮窗不允许“无关联 start”）
- 结果：所有新计时记录均强制带 `caseId`（并可选 `taskId`）；不允许将记录更新成“无关联”

2) 计时状态机闭环（RUNNING/PAUSED/COMPLETED）
- 在浮窗中执行：暂停 → 恢复 → 停止
- 结果：状态正确流转；`duration` 以“秒”为真源累加（支持多次 pause/resume）

3) `/time` 页面去 mock 且可用
- 页面：`/time`
- 结果：展示真实 DB 工时记录；支持“我的记录 + 审批”；支持本周日历视图拉取真实数据

4) 案件/任务联动
- 案件看板：拖动到 ACTIVE（可选自动开计时并弹出浮窗）
- 案件详情：工时列表时长显示为 `HH:MM:SS`（口径统一：秒）

## 4. 关键实现点（摘要）
- 后端真源：统一走 `src/actions/timelogs-crud.ts`（开始/暂停/恢复/停止/审批/计费标记/列表与汇总）
- 并发保护：禁止同一用户存在多个 RUNNING/PAUSED 计时
- 计费快照：停止或手动补录时写入 `billingRate/billingAmount`
- MDI 浮窗：计时器浮窗展示 DB 真源状态，并支持备注更新

## 5. 手工验收步骤（建议你本机浏览器执行）
1. 登录后进入任一案件 → 任务看板 → 找一个任务点“计时”
2. 确认弹出计时器浮窗，计时递增；执行暂停/恢复/停止
3. 打开 `/time`：确认列表出现记录，时长与浮窗一致
4. 进入案件详情 → 工时：确认该案件的工时记录存在且展示 `HH:MM:SS`

