# TG11｜全局搜索 / 通知闭环（清理剩余空壳入口）— 验收记录

> 主工程：`lawclick-next/`  
> 验收时间：2025-12-14  
> 验收目标：把 Header 的“全局搜索/通知”从空壳变为真实闭环，并确保通知触发点围绕案件业务流落库。

---

## 1. 代码级交付物清单（已落地）

### 1.1 数据层（Schema + Migration）
- Prisma Schema：新增 `NotificationType` 与 `Notification` 模型（含索引、actor/recipient 关系）。
  - 文件：`lawclick-next/prisma/schema.prisma`
- Migration：新增 `NotificationType` enum 与 `Notification` 表。
  - 文件：`lawclick-next/prisma/migrations/20251214200000_tg11_notifications/migration.sql`

### 1.2 后端（Server Actions / Domain Service）
- 全局搜索聚合：
  - `lawclick-next/src/actions/search-actions.ts`
  - `globalSearch(query)` 聚合 Case/Task/Document/Contact，并做权限过滤与 URL 映射。
- 通知读写与已读标记：
  - `lawclick-next/src/actions/notification-actions.ts`
  - `getMyNotifications / markNotificationRead / markAllNotificationsRead`
- 通知领域服务（统一写入入口）：
  - `lawclick-next/src/lib/notifications.ts`

### 1.3 触发点（通知写入，围绕案件主链路）
- 聊天新消息通知：
  - `lawclick-next/src/actions/chat-actions.ts`（`sendChatMessage` → 写 `CHAT_MESSAGE`）
- 案件创建/承办人变更通知：
  - `lawclick-next/src/actions/cases-crud.ts`（`createCase`/`updateCase`）
- 案件成员加入通知：
  - `lawclick-next/src/actions/members.ts`（`addCaseMember`）
- 任务分配/重新分配通知：
  - `lawclick-next/src/actions/tasks-crud.ts`（`createCaseTask`/`updateTask`）
- 协作邀请与回执通知：
  - `lawclick-next/src/actions/collaboration-actions.ts`（`createCollaborationInvite`/`respondToInvite`）

### 1.4 UI（Header 真闭环 + 通知列表页）
- Header 通知 + 搜索 UI 真接入：
  - `lawclick-next/src/components/layout/header-components.tsx`
- 新增通知中心页（不再空壳）：
  - `lawclick-next/src/app/(dashboard)/notifications/page.tsx`
- 跳转闭环增强：
  - `lawclick-next/src/app/(dashboard)/chat/page.tsx` 支持 `?threadId=...`
  - `lawclick-next/src/components/cases/CaseDetailClient.tsx` 支持 `?tab=tasks/documents/billing`
- 权限路由访问配置：
  - `lawclick-next/src/lib/permissions.ts` 新增 `/notifications`

### 1.5 数据基线口径（无 seed 假闭环）
- 不在 `prisma db seed` 中生成任何“示例通知”（避免假闭环）。
- 通知必须完全由真实业务触发（聊天消息、案件/任务分配、协作邀请与回执等），并真实落库。
- 如需快速看到历史数据与多角色权限差异：导入脱敏生产快照；否则可从空库起步，通过真实 UI 操作自然产生数据。

---

## 2. 已执行的本地命令级验证（本环境）

> 说明：本验收记录写于 2025-12-14；当时环境无法连接本机 Docker/Postgres，因此未能在此环境对真实数据库执行完整回归。现行复现请按 `pnpm -C lawclick-next exec prisma migrate deploy` + `pnpm -C lawclick-next restore:snapshot -- --file <path-to-dump> --reset --yes`（禁止 `prisma db seed` 造数）。

- ✅ `pnpm -C lawclick-next exec prisma validate`
- ✅ `pnpm -C lawclick-next exec prisma generate`
- ✅ `pnpm -C lawclick-next build`（通过；存在若干 Next dynamic server usage 提示，不阻塞构建）

---

## 3. 需在“可连接 Postgres”的环境执行的验收脚本（建议你本机）

1. 启动 Postgres（Docker 或 Supabase），确保 `.env` 的 `DATABASE_URL` 可连接。
2. 执行迁移与真源数据：
   - `pnpm -C lawclick-next exec prisma migrate deploy`
   - （可选）导入脱敏生产快照：`pnpm -C lawclick-next restore:snapshot -- --file <path-to-dump> --reset --yes`
3. 启动应用并验证：
   - `pnpm -C lawclick-next dev`

### 3.1 关键业务流验收（推荐用 `partner1@lawclick.com / password123`）
- Header 铃铛：显示 DB 未读数，Popover 展示由真实业务触发生成的通知；点击后变已读，未读数减少。
- Header `Ctrl/Cmd + K`：输入关键词能返回案件/任务/文档/客户结果并可跳转。
- Chat：发送消息后，其他账号登录可收到“新消息”通知；点击通知能跳到 `/chat?threadId=...`。
- Case：创建案件指定承办人/成员后，对应账号登录可收到案件通知；点击可进入案件页。
- Task：创建/改派任务给其他人后，对方账号能收到任务通知；点击可进入案件 `?tab=tasks`。
- Invite：发起协作邀请后，接收人能收到邀请通知并可去 `/dispatch` 处理；处理后发起人收到回执通知。

---

## 4. 已知限制 / 后续可优化
- 未做实时推送（WebSocket/SSE）：当前策略为“打开 Popover/进入通知页时拉取最新”。
- 搜索为 `contains` 聚合查询：后续可升级为 Postgres Full-Text + 权重排序 + 最近访问加权。
- 触发点仍可继续扩展：文档上传、审批流状态变更、日程变更等。
