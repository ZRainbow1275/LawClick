# 脱敏生产快照导入规范（极限标准｜dev=prod 1:1）

> 目标：在**严禁 synthetic seed（示例/造数）**的前提下，让开发/测试环境具备与生产 1:1 同构的数据基线，并且可复现、可审计、可回滚（至少可重新导入）。

---

## 1. 基本原则（必须遵守）

1. **必须脱敏**：任何包含个人信息/隐私/凭据/令牌/密钥的字段都必须脱敏或移除（包括但不限于：姓名、电话、邮箱、证件号、地址、聊天内容、文档正文、OAuth token、NextAuth token、API Key、Webhook Secret）。
2. **严禁入库假数据**：不得用脚本生成“看起来像真实业务”的示例数据来替代快照。
3. **严禁提交快照**：快照文件不得进入 git；本仓库已忽略本地目录：`lawclick-next/.data/`。
4. **数据一致性优先**：快照导入后，若与当前迁移版本不一致，优先以 `prisma migrate deploy` 对齐结构，再导入（或导入后再补齐迁移，按实际情况选择，但必须记录证据）。

---

## 2. 推荐存放路径（本机）

- 建议将快照放在：`lawclick-next/.data/snapshots/`
- 文件名建议包含日期与环境：`lawclick_YYYY-MM-DD.dump` / `lawclick_YYYY-MM-DD.sql`

> 注意：该目录仅用于本机，不得提交、不得上传到公共网盘；如需团队共享，必须使用受控的内部存储并记录审批/访问控制。

---

## 3. 支持的快照格式

脚本 `restore:snapshot` 当前支持：
- `*.dump` / `*.backup` / `*.tar`：pg_dump 自定义格式（推荐）
- `*.sql`：SQL 明文导出

不支持/不建议：
- 未脱敏的生产全量 dump
- 带私网依赖/外部对象存储耦合的“半成品”快照（例如 DB 有记录但 MinIO 无对象）

---

## 4. 一键导入（推荐）

前置条件：
- `lawclick-next/docker-compose.yml` 的 Postgres 容器已启动：`cd lawclick-next && docker compose up -d`
- `lawclick-next/.env` 的 `DATABASE_URL` 指向本机 docker-compose Postgres（默认端口 5434）

执行：
```powershell
pnpm -C lawclick-next exec prisma migrate deploy
pnpm restore:snapshot -- --file <path-to-dump> --reset --yes
```

脚本安全策略（故意严格）：
- 仅允许导入本机 docker-compose Postgres（默认容器：`lawclick-postgres`）。
- 会校验 `DATABASE_URL` 与容器配置/端口映射一致，避免“导入成功但应用仍空”的误判。

---

## 5. 导入后验证（必须）

命令级：
```powershell
pnpm -C lawclick-next verify:system
pnpm -C lawclick-next audit:tenant-scope
pnpm -C lawclick-next audit:routes
pnpm -C lawclick-next build
pnpm -C lawclick-next test
```

浏览器级（至少 2 角色）：
- 以 `partner` 创建案件并分配任务 → `lawyer` 收到通知 → 进入案件 `?tab=tasks` → 计时 → `/time` 回读。
- 文档上传到 MinIO → `/documents` 可见 → 下载可用（对象存在且权限正确）。

> 浏览器验收截图/日志应归档到 `docs/_artifacts/` 对应批次目录。

