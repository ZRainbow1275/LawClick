# TG12｜极限标准整改闭环（2025-12-19）

> 目标：以 `AGENTS.md` + `.agent/rules/lawclick.md` 的“极限标准”为裁判，对 `docs/TG12_极限标准审计_2025-12-19.md` 与 `docs/TG12_本轮开发批判性检视_2025-12-19.md` 标出的问题逐条整改，并给出可复验证据。
>
> 范围：以 `lawclick-next/` Web 主工程为主；按要求 **忽略 Flutter/mobile**（`apps/mobile/` 不纳入本轮整改）。

---

## 1. 整改结论（本轮）

- `lawclick-next/`：按两份 TG12 文档列出的 **P0/P1 级问题已完成整改闭环**（生产误配置不再“假成功”，输入校验覆盖到主线 actions，队列接口已加门禁且队列开始被业务使用）。
- 仍需持续治理（不阻断本轮）：Prisma 5→7 升级窗口、根目录 Rust 原型边界隔离（避免“名义后端”混淆）。

---

## 2. 问题对照与整改状态（逐条）

### 2.1 来自 `TG12_极限标准审计_2025-12-19.md`

| 问题 | 严重级 | 状态 | 关键修复点（代码） |
|---|---:|---|---|
| 邮件未配置仍返回 success（假闭环） | P0 | 已修复 | `lawclick-next/src/lib/email.ts`：未配置直接 `success:false`；`NEXTAUTH_URL` 无效直接失败 |
| S3/MinIO 默认值 + `ensureBucketExists` 吞错（生产不对齐） | P0 | 已修复 | `lawclick-next/src/lib/s3.ts`：强制 env schema；仅 NotFound 才创建 bucket；新增 `StorageProvider` |
| Prisma seed 脚本“造数”（违反严禁 mock/占位） | P0 | 已调整策略 | `lawclick-next/prisma/seed.ts`、`lawclick-next/prisma/seed.js`：默认拒绝 synthetic seed，改为导入脱敏生产快照；`lawclick-next/package.json` seed 指向 `seed.js` |
| 阶段文书用 `fileUrl:''`/`pending` 哑值表达“待上传” | P1 | 已修复 | `lawclick-next/src/actions/stage-management.ts`：改为 `fileUrl/fileType = null`（显式建模） |
| 权限过滤用 `__forbidden__` 哑值制造空结果集 | P1 | 已修复 | `lawclick-next/src/lib/server-auth.ts` + 多处 actions：改为显式 where/null/throw，避免“权限问题伪装成查无数据” |
| `/api/queue/process` 无鉴权（运维口裸露） | P0 | 已修复 | `lawclick-next/src/app/api/queue/process/route.ts`：secret header 或 admin 权限门禁 |
| Queue 系统“存在但业务不使用 + 占位 handler” | P0 | 已修复 | `lawclick-next/src/lib/notifications.ts`：新增 `notifyUsersWithEmailQueue`，通知触发写入 `TaskQueue.SEND_EMAIL`；`lawclick-next/src/lib/job-handlers.ts`、`lawclick-next/src/lib/queue.ts`：移除未实现 `GENERATE_*` job 类型 |
| TS Strict 未开启 / `any` / eslint-disable | P0 | 已修复 | `lawclick-next/tsconfig.json`：`strict:true`；主线清理 `any` 与相关 eslint disable |
| Actions 缺少 runtime schema 校验（Zod） | P1 | 已修复 | 主线 actions 入口普遍增加 `safeParse`/schema（参见证据目录中的扫描与门禁输出） |
| 吞异常（localStorage） | P1 | 已修复 | `lawclick-next/src/components/layout/app-sidebar.tsx`、`lawclick-next/src/components/layout/app-header.tsx`：catch 记录 warn |
| Schema 漂移（TaskPriority） | P2 | 已修复 | `lawclick-next/src/lib/schemas.ts`：priority 与 Prisma `TaskPriority` 对齐 |

### 2.2 来自 `TG12_本轮开发批判性检视_2025-12-19.md`

| 问题 | 严重级 | 状态 | 关键修复点（代码/文档） |
|---|---:|---|---|
| `/api/queue/process` 缺少鉴权 | P1 | 已修复 | 同上（route 门禁已补齐） |
| Node 运行 TS 脚本产生 Experimental/module-type 警告噪音 | P2 | 已修复 | `lawclick-next/scripts/init-s3.js`、`lawclick-next/scripts/verify-system.js` + `lawclick-next/package.json` 脚本替换 |
| Docker Compose `version:` obsolete warning | P2 | 已修复 | `lawclick-next/docker-compose.yml` 移除 `version:` |
| actions 旧/新并存漂移风险（tasks/timelogs/register） | P2 | 已修复/缓解 | `lawclick-next/src/actions/tasks.ts`、`lawclick-next/src/actions/timelogs.ts` 委托 `*-crud.ts`；`lawclick-next/src/actions/register.ts` 删除并统一到 `lawclick-next/src/actions/auth.ts` |
| 文档与实现不一致（API 文档口径漂移） | P2 | 已修复 | `docs/API接口文档.md` 已对齐主线实现（受控下载、队列鉴权、AI provider 抽象等） |
| TG3 缺少验收记录（过程对齐缺口） | P2 | 已修复 | 新增 `docs/TG3_任务协作与Trello看板_验收记录.md`、`docs/TG3_看板对齐增强（参照Focalboard_Planka）_验收记录.md` |
| Prisma 5→7 major upgrade 提示 | P2 | 未处理（需窗口） | 仅记录风险，建议单独 TG/窗口升级 |
| 根目录 Rust 原型易造成“名义后端”混淆 | P2 | 未处理（需治理） | 保持“非主线”定位，后续建议更强隔离/归档策略 |

---

## 3. 复验与证据（忠实落盘）

> 复验输出统一落盘（包含 lint/type-check/build/test/route-audit 与扫描快照）：`docs/_artifacts/tg12_remediation_2025-12-19/`

同时保留“当时审计快照”证据：
- `docs/_artifacts/critical_audit_2025-12-19/`
- `docs/_artifacts/extreme_audit_2025-12-19/`

---

## 4. 后续建议（不阻断本轮）

1. Prisma 5→7：单独 TG，制定迁移策略（生成器/Client 行为变更/迁移回滚方案）。
2. Rust 原型：明确“非主线”边界（目录级 README/归档/CI 排除），避免被误当生产后端。
3. Queue：生产环境需配置定时触发（Cron 调用 `/api/queue/process`，使用 `QUEUE_PROCESS_SECRET`），并补齐可观测性（失败告警/死信队列）。

> 2025-12-20 补充：根目录 Rust 原型已按“极限标准”完成可编译/可鉴权/可落库的竖切闭环治理，详见 `docs/TG13_Rust原型治理与闭环_2025-12-20.md`（证据：`docs/_artifacts/tg13_rust_backend_2025-12-20/`）。
