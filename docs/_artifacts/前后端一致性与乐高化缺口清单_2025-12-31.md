# 前后端一致性与乐高化缺口清单（2025-12-31）

> 目标：以“真实数据 + 全链路贯通（UI→Action→DB）+ 强一致性 + 可扩展（30–300）+ 全站可拖拽可记忆可恢复”的最高标准，逐项清零当前已知缺口。

## 0. 已核验（当前代码状态）

- `pnpm audit:routes`：OK（未发现断链路由引用）
- `pnpm audit:tenant-scope`：OK（tenant-scope-guard targets 已生成）
- `pnpm audit:actions-ui`：UI 范围内未引用的 actions 导出已清零（0）（见 `docs/_artifacts/质量门禁与审计复跑证据_2025-12-31.md`）

## 1. 当前缺口清单（必须真实修复）

### 1.1 Actions 导出但 UI 未引用（0，已清零）

> 原则：优先补齐真实 UI 入口（可拖拽 Widgets/Blocks），而不是“删除导出隐藏问题”。仅当确认属于内部 helper 且不应暴露为 Server Action 时，才收敛导出面。

结论：已通过补齐真实 UI 入口（页面/弹窗/可拖拽 Widgets/Blocks）清零。

### 1.2 “全站乐高化”覆盖仍不足

已具备：
- Dashboard 区域页面：`(dashboard)/layout.tsx` 全局 `PageWorkspace`（页面级可拖拽/保存/恢复）
- 部分页面内部：已使用 `SectionWorkspace` 将页面拆成可拖拽 Blocks（更细粒度 DIY）
- 实体详情页：`PageWorkspace` workspaceKey 自动包含 `::entity::UUID`，实现“按实体记忆/恢复布局”（并支持从旧 key 自动继承/迁移）
- 案件/项目详情：侧边栏已拆为可拖拽 `SectionWorkspace` blocks（避免“卡片栏固定不可 DIY”）
- `SectionWorkspace`/`PageWorkspace` 支持 `chrome: "none"`，允许把已有 Card 组件直接作为可拖拽 block/widget（避免嵌套卡片）

仍需补齐（优先 P1）：
- 更多“页面内部卡片栏/分栏/面板”拆分为 `SectionWorkspace`：继续覆盖案件详情（主内容区）、文档详情、合同详情等核心工作界面
- 对非 dashboard 区域（如登录/注册等）是否纳入 DIY：需要明确产品策略与边界（避免破坏最关键的登录流程体验）

### 1.3 一致性/可维护性风险（需要持续治理）

- Actions 返回口径仍需继续统一：本轮已对 `getEventById` / `getCaseTimeLogs` / `getAccessibleTasksForBoard` 等关键入口补齐 discriminated union 与稳定 data 类型；仍需把同口径推广到全 actions。
- “双 ORM / API 路由重叠 / 权限矩阵一致性”：需要明确 Next 主线与 Rust 原型的职责边界与部署策略，避免长期漂移

## 2. 解决策略（执行原则）

1. **先“发现→列清单→逐项闭环”**：以审计脚本与专项审查为基线，每次修复都要能被 `audit:*` 结果验证。
2. **优先“做成可拖拽 Widgets/Blocks”**：任何功能入口优先支持在任意页面通过工作区添加、拖拽、保存、恢复。
3. **真实数据 + 强校验 + 强权限**：所有输入走 Zod；所有业务在 actions 层强校验权限/tenant-scope；不引入 mock/占位数据。
4. **可扩展（30–300）**：列表/目录类 UI 必须支持搜索、分页/增量加载（必要时虚拟渲染），避免一次性拉全量数据。
