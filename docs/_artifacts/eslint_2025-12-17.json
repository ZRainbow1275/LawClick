[{"filePath":"D:\\Desktop\\LawClick_NEW\\lawclick-next\\analyze-lint.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\Desktop\\LawClick_NEW\\lawclick-next\\batch-lint-analysis.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\Desktop\\LawClick_NEW\\lawclick-next\\create-client-user.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\Desktop\\LawClick_NEW\\lawclick-next\\create-client-user.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\Desktop\\LawClick_NEW\\lawclick-next\\debug-auth-logic.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\Desktop\\LawClick_NEW\\lawclick-next\\debug-auth.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\Desktop\\LawClick_NEW\\lawclick-next\\debug-create-user.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\Desktop\\LawClick_NEW\\lawclick-next\\debug-login.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\Desktop\\LawClick_NEW\\lawclick-next\\eslint.config.mjs","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\Desktop\\LawClick_NEW\\lawclick-next\\find-critical-lints.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\Desktop\\LawClick_NEW\\lawclick-next\\jest.config.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\Desktop\\LawClick_NEW\\lawclick-next\\list-lint-files.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\Desktop\\LawClick_NEW\\lawclick-next\\next.config.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\Desktop\\LawClick_NEW\\lawclick-next\\playwright.config.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\Desktop\\LawClick_NEW\\lawclick-next\\postcss.config.mjs","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\Desktop\\LawClick_NEW\\lawclick-next\\prisma\\seed.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\Desktop\\LawClick_NEW\\lawclick-next\\prisma\\seed.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\Desktop\\LawClick_NEW\\lawclick-next\\scripts\\check-types.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\Desktop\\LawClick_NEW\\lawclick-next\\scripts\\init-s3.ts","messages":[],"suppressedMessages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'_e' is defined but never used.","line":21,"column":14,"nodeType":null,"messageId":"unusedVar","endLine":21,"endColumn":16,"suppressions":[{"kind":"directive","justification":""}]}],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\Desktop\\LawClick_NEW\\lawclick-next\\scripts\\route-audit.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\Desktop\\LawClick_NEW\\lawclick-next\\scripts\\verify-system.ts","messages":[],"suppressedMessages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":29,"column":17,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":29,"endColumn":20,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[958,961],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[958,961],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}],"suppressions":[{"kind":"directive","justification":""}]}],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\Desktop\\LawClick_NEW\\lawclick-next\\src\\actions\\ai-actions.ts","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":91,"column":17,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":91,"endColumn":20,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[2743,2746],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[2743,2746],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":96,"column":81,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":96,"endColumn":84,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[2925,2928],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[2925,2928],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":97,"column":75,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":97,"endColumn":78,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[3060,3063],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[3060,3063],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":98,"column":93,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":98,"endColumn":96,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[3204,3207],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[3204,3207],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":102,"column":64,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":102,"endColumn":67,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[3433,3436],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[3433,3436],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":307,"column":35,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":307,"endColumn":38,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[11018,11021],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[11018,11021],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":329,"column":42,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":329,"endColumn":45,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[11655,11658],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[11655,11658],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":370,"column":43,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":370,"endColumn":46,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[13014,13017],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[13014,13017],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":460,"column":60,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":460,"endColumn":63,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[16385,16388],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[16385,16388],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":492,"column":56,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":492,"endColumn":59,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[17596,17599],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[17596,17599],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":499,"column":44,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":499,"endColumn":47,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[17871,17874],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[17871,17874],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":504,"column":21,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":504,"endColumn":24,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[17980,17983],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[17980,17983],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":513,"column":56,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":513,"endColumn":59,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[18309,18312],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[18309,18312],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":590,"column":44,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":590,"endColumn":47,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[21231,21234],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[21231,21234],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":704,"column":44,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":704,"endColumn":47,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[25288,25291],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[25288,25291],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":717,"column":21,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":717,"endColumn":24,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[25816,25819],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[25816,25819],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":756,"column":77,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":756,"endColumn":80,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[27183,27186],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[27183,27186],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":17,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use server\"\n\nimport OpenAI from \"openai\"\nimport { revalidatePath } from \"next/cache\"\n\nimport { prisma } from \"@/lib/prisma\"\nimport { getSessionUserOrThrow, requireCaseAccess, requirePermission } from \"@/lib/server-auth\"\n\nfunction getOpenAIConfig() {\n    return {\n        apiKey: (process.env.OPENAI_API_KEY || \"\").trim(),\n        baseURL: (process.env.OPENAI_BASE_URL || \"https://api.openai.com/v1\").trim(),\n        model: (process.env.OPENAI_MODEL || \"gpt-3.5-turbo\").trim(),\n    }\n}\n\nfunction isOpenAIConfigured(apiKey: string): boolean {\n    if (!apiKey) return false\n    const lower = apiKey.toLowerCase()\n    if (lower.includes(\"your-key-here\")) return false\n    if (lower.includes(\"mock\")) return false\n    return true\n}\n\nfunction getOpenAIClient() {\n    const { apiKey, baseURL } = getOpenAIConfig()\n    if (!isOpenAIConfigured(apiKey)) return null\n    return new OpenAI({ apiKey, baseURL })\n}\n\nfunction clampText(text: string, maxChars: number): string {\n    const cleaned = (text || \"\").trim()\n    if (cleaned.length <= maxChars) return cleaned\n    return cleaned.slice(0, maxChars) + \"…\"\n}\n\nexport type AIContext = {\n    source?: string | null\n    caseId?: string | null\n    documentId?: string | null\n    taskId?: string | null\n    approvalId?: string | null\n    invoiceId?: string | null\n    expenseId?: string | null\n    contractId?: string | null\n}\n\nfunction normalizeContext(context?: AIContext | null): AIContext | null {\n    if (!context) return null\n    const normalized: AIContext = {\n        source: context.source || null,\n        caseId: context.caseId || null,\n        documentId: context.documentId || null,\n        taskId: context.taskId || null,\n        approvalId: context.approvalId || null,\n        invoiceId: context.invoiceId || null,\n        expenseId: context.expenseId || null,\n        contractId: context.contractId || null,\n    }\n\n    const hasAny =\n        normalized.caseId ||\n        normalized.documentId ||\n        normalized.taskId ||\n        normalized.approvalId ||\n        normalized.invoiceId ||\n        normalized.expenseId ||\n        normalized.contractId\n\n    return hasAny ? normalized : (normalized.source ? normalized : null)\n}\n\ntype ResolvedContext = {\n    context: AIContext | null\n    derivedCaseId: string | null\n    caseMeta?: { id: string; caseCode: string; title: string; serviceType: string; status: string } | null\n    documentMeta?: {\n        id: string\n        title: string\n        version: number\n        notes: string | null\n        summary: string | null\n        caseId: string\n        case: { id: string; caseCode: string; title: string }\n    } | null\n    approvalMeta?: {\n        id: string\n        title: string\n        type: string\n        status: string\n        amount: any\n        caseId: string | null\n        requesterId: string\n        approverId: string\n    } | null\n    invoiceMeta?: { id: string; invoiceNo: string; status: string; totalAmount: any; caseId: string | null; clientId: string | null } | null\n    expenseMeta?: { id: string; category: string; status: string; amount: any; caseId: string | null; userId: string } | null\n    contractMeta?: { id: string; contractNo: string; title: string; status: string; amount: any; caseId: string | null; clientId: string | null } | null\n    taskMeta?: { id: string; title: string; status: string; priority: string; caseId: string } | null\n}\n\nasync function resolveContextForUser(user: { id: string; role: any }, context?: AIContext | null): Promise<ResolvedContext> {\n    const normalized = normalizeContext(context)\n    if (!normalized) {\n        return { context: null, derivedCaseId: null }\n    }\n\n    const resolved: ResolvedContext = {\n        context: normalized,\n        derivedCaseId: normalized.caseId || null,\n        caseMeta: null,\n        documentMeta: null,\n        approvalMeta: null,\n        invoiceMeta: null,\n        expenseMeta: null,\n        contractMeta: null,\n        taskMeta: null,\n    }\n\n    if (normalized.caseId) {\n        await requireCaseAccess(normalized.caseId, user.id, user.role, \"case:view\")\n        resolved.caseMeta = await prisma.case.findUnique({\n            where: { id: normalized.caseId },\n            select: { id: true, caseCode: true, title: true, serviceType: true, status: true },\n        })\n    }\n\n    if (normalized.documentId) {\n        requirePermission(user.role, \"document:view\")\n        const doc = await prisma.document.findUnique({\n            where: { id: normalized.documentId },\n            select: {\n                id: true,\n                title: true,\n                version: true,\n                notes: true,\n                summary: true,\n                caseId: true,\n                case: { select: { id: true, caseCode: true, title: true } },\n            },\n        })\n        if (doc) {\n            await requireCaseAccess(doc.caseId, user.id, user.role, \"document:view\")\n            resolved.documentMeta = doc\n            resolved.derivedCaseId = resolved.derivedCaseId || doc.caseId\n        }\n    }\n\n    if (normalized.taskId) {\n        const task = await prisma.task.findUnique({\n            where: { id: normalized.taskId },\n            select: { id: true, title: true, status: true, priority: true, caseId: true },\n        })\n        if (task) {\n            await requireCaseAccess(task.caseId, user.id, user.role, \"case:view\")\n            resolved.taskMeta = task\n            resolved.derivedCaseId = resolved.derivedCaseId || task.caseId\n        }\n    }\n\n    if (normalized.approvalId) {\n        requirePermission(user.role, \"approval:create\")\n        const approval = await prisma.approvalRequest.findUnique({\n            where: { id: normalized.approvalId },\n            select: {\n                id: true,\n                title: true,\n                type: true,\n                status: true,\n                amount: true,\n                caseId: true,\n                requesterId: true,\n                approverId: true,\n            },\n        })\n        if (approval) {\n            if (approval.caseId) {\n                await requireCaseAccess(approval.caseId, user.id, user.role, \"case:view\")\n                resolved.derivedCaseId = resolved.derivedCaseId || approval.caseId\n            } else if (approval.requesterId !== user.id && approval.approverId !== user.id) {\n                requirePermission(user.role, \"approval:view_all\")\n            }\n            resolved.approvalMeta = approval\n        }\n    }\n\n    if (normalized.invoiceId) {\n        requirePermission(user.role, \"billing:view\")\n        const invoice = await prisma.invoice.findUnique({\n            where: { id: normalized.invoiceId },\n            select: { id: true, invoiceNo: true, status: true, totalAmount: true, caseId: true, clientId: true },\n        })\n        if (invoice) {\n            if (invoice.caseId) {\n                await requireCaseAccess(invoice.caseId, user.id, user.role, \"billing:view\")\n                resolved.derivedCaseId = resolved.derivedCaseId || invoice.caseId\n            }\n            resolved.invoiceMeta = invoice\n        }\n    }\n\n    if (normalized.expenseId) {\n        requirePermission(user.role, \"billing:view\")\n        const expense = await prisma.expense.findUnique({\n            where: { id: normalized.expenseId },\n            select: { id: true, category: true, status: true, amount: true, caseId: true, userId: true },\n        })\n        if (expense) {\n            if (expense.caseId) {\n                await requireCaseAccess(expense.caseId, user.id, user.role, \"billing:view\")\n                resolved.derivedCaseId = resolved.derivedCaseId || expense.caseId\n            }\n            resolved.expenseMeta = expense\n        }\n    }\n\n    if (normalized.contractId) {\n        requirePermission(user.role, \"billing:view\")\n        const contract = await prisma.contract.findUnique({\n            where: { id: normalized.contractId },\n            select: { id: true, contractNo: true, title: true, status: true, amount: true, caseId: true, clientId: true },\n        })\n        if (contract) {\n            if (contract.caseId) {\n                await requireCaseAccess(contract.caseId, user.id, user.role, \"billing:view\")\n                resolved.derivedCaseId = resolved.derivedCaseId || contract.caseId\n            }\n            resolved.contractMeta = contract\n        }\n    }\n\n    return resolved\n}\n\nexport async function getAIContextSnapshot(context?: AIContext | null) {\n    const user = await getSessionUserOrThrow()\n    requirePermission(user.role, \"ai:use\")\n\n    const resolved = await resolveContextForUser(user, context)\n\n    const lines: string[] = []\n    lines.push(`当前用户：${user.name || user.email}（角色：${user.role}）`)\n\n    if (resolved.caseMeta) {\n        lines.push(`案件：${resolved.caseMeta.caseCode}｜${resolved.caseMeta.title}`)\n        lines.push(`案件类型：${resolved.caseMeta.serviceType}；状态：${resolved.caseMeta.status}`)\n    }\n\n    if (resolved.documentMeta) {\n        lines.push(`文档：${resolved.documentMeta.title}（v${resolved.documentMeta.version}）｜所属案件：${resolved.documentMeta.case.caseCode}`)\n        if (resolved.documentMeta.summary) lines.push(`文档摘要：${clampText(resolved.documentMeta.summary, 500)}`)\n        if (resolved.documentMeta.notes) lines.push(`文档备注：${clampText(resolved.documentMeta.notes, 500)}`)\n    }\n\n    if (resolved.taskMeta) {\n        lines.push(`任务：${resolved.taskMeta.title}｜状态：${resolved.taskMeta.status}｜优先级：${resolved.taskMeta.priority}`)\n    }\n\n    if (resolved.approvalMeta) {\n        lines.push(`审批：${resolved.approvalMeta.title}｜类型：${resolved.approvalMeta.type}｜状态：${resolved.approvalMeta.status}`)\n    }\n\n    if (resolved.invoiceMeta) {\n        lines.push(`发票：${resolved.invoiceMeta.invoiceNo}｜状态：${resolved.invoiceMeta.status}｜总额：${resolved.invoiceMeta.totalAmount}`)\n    }\n\n    if (resolved.expenseMeta) {\n        lines.push(`费用：${resolved.expenseMeta.category}｜状态：${resolved.expenseMeta.status}｜金额：${resolved.expenseMeta.amount}`)\n    }\n\n    if (resolved.contractMeta) {\n        lines.push(`合同：${resolved.contractMeta.contractNo}｜${resolved.contractMeta.title}｜状态：${resolved.contractMeta.status}｜金额：${resolved.contractMeta.amount}`)\n    }\n\n    return {\n        derivedCaseId: resolved.derivedCaseId,\n        text: lines.join(\"\\n\"),\n    }\n}\n\n// ============================================================================\n// 会话管理\n// ============================================================================\n\nexport interface Message {\n    role: \"user\" | \"ai\"\n    content: string\n    timestamp: string\n}\n\nexport async function getConversations() {\n    const user = await getSessionUserOrThrow()\n    requirePermission(user.role, \"ai:use\")\n\n    const conversations = await prisma.aIConversation.findMany({\n        where: { userId: user.id },\n        orderBy: { updatedAt: \"desc\" },\n        take: 50,\n    })\n\n    return conversations.map((c) => {\n        const msgs = c.messages as unknown as Message[] | null\n        return {\n            id: c.id,\n            title: c.title || \"新对话\",\n            caseId: c.caseId,\n            context: c.context as any,\n            messageCount: Array.isArray(msgs) ? msgs.length : 0,\n            createdAt: c.createdAt,\n            updatedAt: c.updatedAt,\n        }\n    })\n}\n\nexport async function getConversation(conversationId: string) {\n    const user = await getSessionUserOrThrow()\n    requirePermission(user.role, \"ai:use\")\n\n    const conversation = await prisma.aIConversation.findFirst({\n        where: { id: conversationId, userId: user.id },\n    })\n\n    if (!conversation) return null\n\n    return {\n        id: conversation.id,\n        title: conversation.title,\n        caseId: conversation.caseId,\n        context: conversation.context as any,\n        messages: (conversation.messages as unknown as Message[]) || [],\n        createdAt: conversation.createdAt,\n        updatedAt: conversation.updatedAt,\n    }\n}\n\nexport async function createConversation(caseId?: string | null) {\n    const user = await getSessionUserOrThrow()\n    requirePermission(user.role, \"ai:use\")\n\n    const normalizedCaseId = caseId || null\n    if (normalizedCaseId) {\n        await requireCaseAccess(normalizedCaseId, user.id, user.role, \"case:view\")\n    }\n\n    const conversation = await prisma.aIConversation.create({\n        data: {\n            userId: user.id,\n            title: null,\n            messages: [],\n            caseId: normalizedCaseId,\n            context: normalizedCaseId ? ({ caseId: normalizedCaseId, source: \"case\" } satisfies AIContext) : null,\n        },\n    })\n\n    revalidatePath(\"/dashboard\")\n    return conversation.id\n}\n\nexport async function createConversationWithContext(context: AIContext) {\n    const user = await getSessionUserOrThrow()\n    requirePermission(user.role, \"ai:use\")\n\n    const resolved = await resolveContextForUser(user, context)\n    const conversation = await prisma.aIConversation.create({\n        data: {\n            userId: user.id,\n            title: null,\n            messages: [],\n            caseId: resolved.derivedCaseId,\n            context: (resolved.context as any) || null,\n        },\n    })\n\n    revalidatePath(\"/dashboard\")\n    return conversation.id\n}\n\nexport async function addMessageToConversation(conversationId: string, message: Message) {\n    const user = await getSessionUserOrThrow()\n    requirePermission(user.role, \"ai:use\")\n\n    const conversation = await prisma.aIConversation.findFirst({\n        where: { id: conversationId, userId: user.id },\n    })\n    if (!conversation) return false\n\n    const messages = ((conversation.messages as unknown as Message[]) || []).slice()\n    messages.push(message)\n\n    let title = conversation.title\n    if (!title && message.role === \"user\") {\n        title = message.content.slice(0, 50) + (message.content.length > 50 ? \"...\" : \"\")\n    }\n\n    await prisma.aIConversation.update({\n        where: { id: conversationId },\n        data: { messages: messages as unknown as object[], title },\n    })\n\n    return true\n}\n\nexport async function deleteConversation(conversationId: string) {\n    const user = await getSessionUserOrThrow()\n    requirePermission(user.role, \"ai:use\")\n\n    await prisma.aIConversation.deleteMany({ where: { id: conversationId, userId: user.id } })\n    revalidatePath(\"/dashboard\")\n    return true\n}\n\n// ============================================================================\n// AI 对话（增强版：上下文 + 审计）\n// ============================================================================\n\nexport async function chatWithAIEnhanced(input: { message: string; conversationId?: string | null; context?: AIContext | null }) {\n    const user = await getSessionUserOrThrow()\n    requirePermission(user.role, \"ai:use\")\n\n    const openai = getOpenAIClient()\n    const { baseURL, model } = getOpenAIConfig()\n    const provider = baseURL.includes(\"openai.com\") ? \"openai\" : \"openai-compatible\"\n\n    const message = (input.message || \"\").trim()\n    const conversationId = input.conversationId || null\n    const context = input.context || null\n\n    if (!message) return { error: \"请输入内容\", response: null }\n\n    try {\n        const snapshot = await getAIContextSnapshot(context)\n\n        let historyMessages: { role: \"system\" | \"user\" | \"assistant\"; content: string }[] = []\n        if (conversationId) {\n            const conversation = await getConversation(conversationId)\n            if (conversation?.messages) {\n                historyMessages = conversation.messages.slice(-10).map((m) => ({\n                    role: m.role === \"ai\" ? (\"assistant\" as const) : (\"user\" as const),\n                    content: m.content,\n                }))\n            }\n        }\n\n        const systemPrompt = `你是一名专业的法律助手 LawClick AI。\\n你的职责是协助律师处理案件、审查合同和解答法律问题。\\n请用专业、严谨但易懂的中文回答。\\n\\n当前上下文:\\n${snapshot.text || \"无\"}`\n\n        if (!openai) {\n            const errorMessage = \"AI 服务未配置（缺少 OPENAI_API_KEY），请先完成环境配置。\"\n\n            if (conversationId) {\n                const now = new Date().toISOString()\n                await addMessageToConversation(conversationId, { role: \"user\", content: message, timestamp: now })\n                await addMessageToConversation(conversationId, { role: \"ai\", content: errorMessage, timestamp: now })\n            }\n\n            await prisma.aIInvocation.create({\n                data: {\n                    type: \"CHAT\",\n                    userId: user.id,\n                    conversationId,\n                    context: (normalizeContext(context) as any) || null,\n                    prompt: clampText(message, 4000),\n                    response: null,\n                    provider,\n                    model,\n                    status: \"ERROR\",\n                    error: errorMessage,\n                    tokenUsage: null,\n                },\n            })\n\n            return { error: errorMessage, response: null }\n        }\n\n        const completion = await openai.chat.completions.create({\n            messages: [{ role: \"system\", content: systemPrompt }, ...historyMessages, { role: \"user\", content: message }],\n            model,\n        })\n\n        const response = completion.choices[0].message.content || \"抱歉，我暂时无法回答这个问题。\"\n\n        if (conversationId) {\n            const now = new Date().toISOString()\n            await addMessageToConversation(conversationId, { role: \"user\", content: message, timestamp: now })\n            await addMessageToConversation(conversationId, { role: \"ai\", content: response, timestamp: now })\n        }\n\n        await prisma.aIInvocation.create({\n            data: {\n                type: \"CHAT\",\n                userId: user.id,\n                conversationId,\n                context: (normalizeContext(context) as any) || null,\n                prompt: clampText(message, 4000),\n                response: clampText(response, 20_000),\n                provider,\n                model,\n                status: \"SUCCESS\",\n                error: null,\n                tokenUsage: (completion as any)?.usage || null,\n            },\n        })\n\n        return { error: null, response }\n    } catch (error: any) {\n        const messageText = error?.message || \"AI 服务暂时不可用，请检查配置。\"\n        console.error(\"AI Error:\", error)\n\n        await prisma.aIInvocation.create({\n            data: {\n                type: \"CHAT\",\n                userId: user.id,\n                conversationId,\n                context: (normalizeContext(context) as any) || null,\n                prompt: clampText(message, 4000),\n                response: null,\n                provider,\n                model,\n                status: \"ERROR\",\n                error: messageText,\n                tokenUsage: null,\n            },\n        })\n\n        return { error: \"AI 服务暂时不可用，请检查配置。\", response: null }\n    }\n}\n\n// ============================================================================\n// 文档分析（MVP：基于 notes/粘贴文本，不做全文抽取）\n// ============================================================================\n\nexport async function analyzeDocument(documentContent: string, analysisType: \"summary\" | \"keypoints\" | \"risks\" | \"timeline\") {\n    const user = await getSessionUserOrThrow()\n    requirePermission(user.role, \"ai:use\")\n\n    const openai = getOpenAIClient()\n    const { baseURL, model } = getOpenAIConfig()\n    const provider = baseURL.includes(\"openai.com\") ? \"openai\" : \"openai-compatible\"\n\n    const prompts: Record<typeof analysisType, string> = {\n        summary: \"请对以下法律文档进行专业总结，提炼核心内容，不超过500字：\",\n        keypoints: \"请提取以下法律文档的关键要点，以编号列表形式呈现：\",\n        risks: \"请分析以下法律文档可能存在的风险点和注意事项：\",\n        timeline: \"请从以下法律文档中提取时间线和关键日期节点：\",\n    }\n\n    try {\n        if (!openai) {\n            const errorMessage = \"AI 服务未配置（缺少 OPENAI_API_KEY），请先完成环境配置。\"\n            await prisma.aIInvocation.create({\n                data: {\n                    type: \"DOCUMENT_ANALYSIS\",\n                    userId: user.id,\n                    conversationId: null,\n                    context: { source: \"document_analysis\", analysisType },\n                    prompt: clampText(`[${analysisType}] ${documentContent}`, 4000),\n                    response: null,\n                    provider,\n                    model,\n                    status: \"ERROR\",\n                    error: errorMessage,\n                    tokenUsage: null,\n                },\n            })\n            return { error: errorMessage, result: null }\n        }\n\n        const completion = await openai.chat.completions.create({\n            messages: [\n                { role: \"system\", content: \"你是一名专业的法律文档分析师，擅长合同审查、文书分析和风险识别。请用中文输出，结构清晰，可操作。\" },\n                { role: \"user\", content: `${prompts[analysisType]}\\n\\n${documentContent.slice(0, 10000)}` },\n            ],\n            model,\n        })\n\n        const result = completion.choices[0].message.content || \"分析结果为空\"\n\n        await prisma.aIInvocation.create({\n            data: {\n                type: \"DOCUMENT_ANALYSIS\",\n                userId: user.id,\n                conversationId: null,\n                context: { source: \"document_analysis\", analysisType },\n                prompt: clampText(`${prompts[analysisType]}\\n\\n${documentContent}`, 4000),\n                response: clampText(result, 20_000),\n                provider,\n                model,\n                status: \"SUCCESS\",\n                error: null,\n                tokenUsage: (completion as any)?.usage || null,\n            },\n        })\n\n        return { error: null, result }\n    } catch (error) {\n        console.error(\"Document Analysis Error:\", error)\n        return { error: \"文档分析服务暂时不可用\", result: null }\n    }\n}\n\nexport async function analyzeDocumentById(input: {\n    documentId: string\n    analysisType: \"summary\" | \"keypoints\" | \"risks\" | \"timeline\"\n    contentSource: \"notes\" | \"pasted\"\n    pastedText?: string\n    writeSummaryBack?: boolean\n}) {\n    const user = await getSessionUserOrThrow()\n    requirePermission(user.role, \"ai:use\")\n    requirePermission(user.role, \"document:view\")\n\n    const document = await prisma.document.findUnique({\n        where: { id: input.documentId },\n        select: {\n            id: true,\n            title: true,\n            version: true,\n            notes: true,\n            summary: true,\n            caseId: true,\n            case: { select: { id: true, caseCode: true, title: true } },\n        },\n    })\n\n    if (!document) {\n        return { success: false as const, error: \"文档不存在\", result: null }\n    }\n\n    await requireCaseAccess(document.caseId, user.id, user.role, \"document:view\")\n\n    const content = input.contentSource === \"pasted\" ? (input.pastedText || \"\").trim() : (document.notes || \"\").trim()\n    if (!content) {\n        return { success: false as const, error: \"请提供待审查内容（文档备注或粘贴文本）\", result: null }\n    }\n\n    const openai = getOpenAIClient()\n    const { baseURL, model } = getOpenAIConfig()\n    const provider = baseURL.includes(\"openai.com\") ? \"openai\" : \"openai-compatible\"\n\n    const prompts: Record<typeof input.analysisType, string> = {\n        summary: \"请对以下法律文档进行专业总结，提炼核心内容，不超过500字：\",\n        keypoints: \"请提取以下法律文档的关键要点，以编号列表形式呈现：\",\n        risks: \"请分析以下法律文档可能存在的风险点和注意事项：\",\n        timeline: \"请从以下法律文档中提取时间线和关键日期节点：\",\n    }\n\n    const prompt = `${prompts[input.analysisType]}\\n\\n【文档】${document.title}（v${document.version}）\\n【案件】${document.case.caseCode}｜${document.case.title}\\n【内容来源】${input.contentSource === \"notes\" ? \"文档备注\" : \"粘贴文本\"}\\n\\n${content.slice(0, 10000)}`\n\n    if (!openai) {\n        const errorMessage = \"AI 服务未配置（缺少 OPENAI_API_KEY），请先完成环境配置。\"\n        await prisma.aIInvocation.create({\n            data: {\n                type: \"DOCUMENT_ANALYSIS\",\n                userId: user.id,\n                conversationId: null,\n                context: {\n                    source: \"documents_review\",\n                    caseId: document.caseId,\n                    documentId: document.id,\n                    analysisType: input.analysisType,\n                    contentSource: input.contentSource,\n                },\n                prompt: clampText(prompt, 4000),\n                response: null,\n                provider,\n                model,\n                status: \"ERROR\",\n                error: errorMessage,\n                tokenUsage: null,\n            },\n        })\n        return { success: false as const, error: errorMessage, result: null }\n    }\n\n    try {\n        const completion = await openai.chat.completions.create({\n            messages: [\n                { role: \"system\", content: \"你是一名专业的法律文档分析师，擅长合同审查、文书分析和风险识别。请用中文输出，结构清晰，可操作。\" },\n                { role: \"user\", content: prompt },\n            ],\n            model,\n        })\n\n        const result = completion.choices[0].message.content || \"分析结果为空\"\n\n        await prisma.aIInvocation.create({\n            data: {\n                type: \"DOCUMENT_ANALYSIS\",\n                userId: user.id,\n                conversationId: null,\n                context: {\n                    source: \"documents_review\",\n                    caseId: document.caseId,\n                    documentId: document.id,\n                    analysisType: input.analysisType,\n                    contentSource: input.contentSource,\n                },\n                prompt: clampText(prompt, 4000),\n                response: clampText(result, 20_000),\n                provider,\n                model,\n                status: \"SUCCESS\",\n                error: null,\n                tokenUsage: (completion as any)?.usage || null,\n            },\n        })\n\n        const shouldWriteBack = input.writeSummaryBack && input.analysisType === \"summary\"\n        if (shouldWriteBack) {\n            await prisma.document.update({ where: { id: document.id }, data: { summary: clampText(result, 2000) } })\n        }\n\n        revalidatePath(`/documents/${document.id}`)\n        revalidatePath(`/documents/${document.id}/review`)\n\n        return { success: true as const, error: null, result, wroteBackSummary: shouldWriteBack }\n    } catch (error: any) {\n        const messageText = error?.message || \"文档分析服务暂时不可用\"\n        console.error(\"Document Analysis Error:\", error)\n\n        await prisma.aIInvocation.create({\n            data: {\n                type: \"DOCUMENT_ANALYSIS\",\n                userId: user.id,\n                conversationId: null,\n                context: {\n                    source: \"documents_review\",\n                    caseId: document.caseId,\n                    documentId: document.id,\n                    analysisType: input.analysisType,\n                    contentSource: input.contentSource,\n                },\n                prompt: clampText(prompt, 4000),\n                response: null,\n                provider,\n                model,\n                status: \"ERROR\",\n                error: messageText,\n                tokenUsage: null,\n            },\n        })\n\n        return { success: false as const, error: \"文档分析服务暂时不可用\", result: null }\n    }\n}\n\nexport async function getDocumentAIInvocations(documentId: string) {\n    const user = await getSessionUserOrThrow()\n    requirePermission(user.role, \"ai:use\")\n    requirePermission(user.role, \"document:view\")\n\n    const doc = await prisma.document.findUnique({\n        where: { id: documentId },\n        select: { id: true, caseId: true },\n    })\n    if (!doc) return { success: false as const, error: \"文档不存在\", data: [] as any[] }\n\n    await requireCaseAccess(doc.caseId, user.id, user.role, \"document:view\")\n\n    const invocations = await prisma.aIInvocation.findMany({\n        where: {\n            type: \"DOCUMENT_ANALYSIS\",\n            context: {\n                path: [\"documentId\"],\n                equals: documentId,\n            },\n        },\n        orderBy: { createdAt: \"desc\" },\n        take: 20,\n        select: {\n            id: true,\n            createdAt: true,\n            status: true,\n            error: true,\n            provider: true,\n            model: true,\n            response: true,\n        },\n    })\n\n    return { success: true as const, error: null, data: invocations }\n}\n","usedDeprecatedRules":[]},{"filePath":"D:\\Desktop\\LawClick_NEW\\lawclick-next\\src\\actions\\approval-actions.ts","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":88,"column":22,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":88,"endColumn":25,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[3223,3226],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[3223,3226],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":333,"column":65,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":333,"endColumn":68,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[11912,11915],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[11912,11915],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":22,"column":31,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":22,"endColumn":34,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[787,790],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[787,790],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}],"suppressions":[{"kind":"directive","justification":""}]}],"errorCount":0,"fatalErrorCount":0,"warningCount":2,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use server\"\n\nimport { prisma } from \"@/lib/prisma\"\nimport { revalidatePath } from \"next/cache\"\nimport { ApprovalStatus, ApprovalType } from \"@prisma/client\"\nimport { hasPermission } from \"@/lib/permissions\"\nimport { getSessionUserOrThrow, requireCaseAccess, requirePermission } from \"@/lib/server-auth\"\n\n// ==============================================================================\n// [2.1] 创建审批申请\n// ==============================================================================\n\nexport async function createApprovalRequest(data: {\n    type: ApprovalType\n    title: string\n    description?: string\n    amount?: number\n    approverId?: string\n    caseId?: string\n    clientId?: string\n    // eslint-disable-next-line @typescript-eslint/no-explicit-any\n    metadata?: Record<string, any>\n    submit?: boolean // 是否直接提交\n}) {\n    try {\n        const user = await getSessionUserOrThrow()\n        requirePermission(user.role, \"approval:create\")\n\n        const caseId = data.caseId || null\n        if (caseId) {\n            await requireCaseAccess(caseId, user.id, user.role, \"case:view\")\n        }\n\n        let clientId = data.clientId || null\n        if (!clientId && caseId) {\n            const row = await prisma.case.findUnique({ where: { id: caseId }, select: { clientId: true } })\n            clientId = row?.clientId || null\n        }\n\n        const approval = await prisma.approvalRequest.create({\n            data: {\n                type: data.type,\n                title: data.title,\n                description: data.description,\n                amount: data.amount,\n                requesterId: user.id,\n                approverId: data.approverId || null,\n                metadata: data.metadata || {},\n                status: data.submit ? ApprovalStatus.PENDING : ApprovalStatus.DRAFT,\n                submittedAt: data.submit ? new Date() : null,\n                caseId,\n                clientId,\n            },\n            include: {\n                requester: { select: { id: true, name: true, avatarUrl: true, department: true } },\n                approver: { select: { id: true, name: true, avatarUrl: true, department: true } },\n                case: { select: { id: true, title: true, caseCode: true } },\n                client: { select: { id: true, name: true, type: true, email: true, phone: true } },\n            },\n        })\n\n        revalidatePath('/admin/approvals')\n        if (approval.caseId) revalidatePath(`/cases/${approval.caseId}`)\n        return { success: true, data: approval }\n    } catch (error) {\n        console.error('创建审批失败:', error)\n        return { success: false, error: '创建审批失败' }\n    }\r\n}\r\n\r\n// ==============================================================================\n// [2.2] 获取我的审批\n// ==============================================================================\n\nexport async function getMyApprovals(\n    filter: 'pending' | 'approved' | 'mine' = 'pending',\n    options?: { caseId?: string }\n) {\n    try {\n        const user = await getSessionUserOrThrow()\n\n        if (filter === \"mine\") {\n            requirePermission(user.role, \"approval:create\")\n        } else {\n            requirePermission(user.role, \"approval:approve\")\n        }\n\n        const where: any = {}\n        if (options?.caseId) where.caseId = options.caseId\n\n        if (filter === 'pending') {\n            // 待我审批的\n            where.status = ApprovalStatus.PENDING\n            where.OR = [{ approverId: user.id }, { approverId: null }]\n        } else if (filter === 'approved') {\n            // 我已处理的\n            where.approverId = user.id\n            where.status = { in: [ApprovalStatus.APPROVED, ApprovalStatus.REJECTED] }\n        } else {\n            // 我发起的\n            where.requesterId = user.id\n        }\n\n        const approvals = await prisma.approvalRequest.findMany({\n            where,\n            include: {\n                requester: { select: { id: true, name: true, avatarUrl: true } },\n                approver: { select: { id: true, name: true, avatarUrl: true } },\n                case: { select: { id: true, title: true, caseCode: true } },\n                client: { select: { id: true, name: true, type: true } },\n            },\n            orderBy: { createdAt: 'desc' },\n        })\n\n        return { success: true, data: approvals }\n    } catch (error) {\r\n        console.error('获取审批失败:', error)\r\n        return { success: false, error: '获取审批失败', data: [] }\r\n    }\r\n}\r\n\r\n// ==============================================================================\r\n// [2.3] 获取审批详情\r\n// ==============================================================================\r\n\r\nexport async function getApprovalById(id: string) {\n    try {\n        const user = await getSessionUserOrThrow()\n        const approval = await prisma.approvalRequest.findUnique({\n            where: { id },\n            include: {\n                requester: { select: { id: true, name: true, avatarUrl: true, department: true } },\n                approver: { select: { id: true, name: true, avatarUrl: true } },\n                case: { select: { id: true, title: true, caseCode: true } },\n                client: { select: { id: true, name: true, type: true } },\n            },\n        })\n\n        if (!approval) {\n            return { success: false, error: '审批不存在' }\n        }\n\n        const canView =\n            approval.requesterId === user.id ||\n            approval.approverId === user.id ||\n            hasPermission(user.role, \"approval:view_all\")\n\n        if (!canView) {\n            return { success: false, error: '无权查看该审批' }\n        }\n\n        return { success: true, data: approval }\n    } catch (error) {\n        console.error('获取审批详情失败:', error)\n        return { success: false, error: '获取审批详情失败' }\n    }\n}\n\n// ==============================================================================\n// [2.4] 批准\n// ==============================================================================\n\nexport async function approveRequest(id: string, note?: string) {\n    try {\n        const user = await getSessionUserOrThrow()\n        requirePermission(user.role, \"approval:approve\")\n\n        const approval = await prisma.approvalRequest.findUnique({ where: { id } })\n        if (!approval) {\n            return { success: false, error: '审批不存在' }\n        }\n\n        if (approval.approverId && approval.approverId !== user.id) {\n            return { success: false, error: '无权审批此申请' }\n        }\n\n        if (approval.status !== ApprovalStatus.PENDING) {\n            return { success: false, error: '此申请已处理' }\n        }\n\n        const updated = await prisma.approvalRequest.update({\n            where: { id },\n            data: {\n                status: ApprovalStatus.APPROVED,\n                approverId: user.id,\n                resolvedAt: new Date(),\n                approvalNote: note,\n            },\n        })\n\n        revalidatePath('/admin/approvals')\n        if (updated.caseId) revalidatePath(`/cases/${updated.caseId}`)\n        return { success: true, data: updated }\n    } catch (error) {\n        console.error('审批失败:', error)\n        return { success: false, error: '审批失败' }\n    }\r\n}\r\n\r\n// ==============================================================================\r\n// [2.5] 驳回\r\n// ==============================================================================\r\n\r\nexport async function rejectRequest(id: string, note?: string) {\n    try {\n        const user = await getSessionUserOrThrow()\n        requirePermission(user.role, \"approval:approve\")\n\n        const approval = await prisma.approvalRequest.findUnique({ where: { id } })\n        if (!approval) {\n            return { success: false, error: '审批不存在' }\n        }\n\r\n        if (approval.approverId && approval.approverId !== user.id) {\r\n            return { success: false, error: '无权审批此申请' }\r\n        }\r\n\r\n        if (approval.status !== ApprovalStatus.PENDING) {\n            return { success: false, error: '此申请已处理' }\n        }\n\n        const updated = await prisma.approvalRequest.update({\n            where: { id },\n            data: {\n                status: ApprovalStatus.REJECTED,\n                approverId: user.id,\n                resolvedAt: new Date(),\n                approvalNote: note || '已驳回',\n            },\n        })\n\n        revalidatePath('/admin/approvals')\n        if (updated.caseId) revalidatePath(`/cases/${updated.caseId}`)\n        return { success: true, data: updated }\n    } catch (error) {\n        console.error('驳回失败:', error)\n        return { success: false, error: '驳回失败' }\n    }\r\n}\r\n\r\n// ==============================================================================\r\n// [2.6] 撤回\r\n// ==============================================================================\r\n\r\nexport async function cancelRequest(id: string) {\n    try {\n        const user = await getSessionUserOrThrow()\n        requirePermission(user.role, \"approval:create\")\n\n        const approval = await prisma.approvalRequest.findUnique({ where: { id } })\n        if (!approval) {\n            return { success: false, error: '审批不存在' }\n        }\n\r\n        if (approval.requesterId !== user.id) {\r\n            return { success: false, error: '只有申请人可以撤回' }\r\n        }\r\n\r\n        if (approval.status !== ApprovalStatus.PENDING && approval.status !== ApprovalStatus.DRAFT) {\n            return { success: false, error: '已处理的申请无法撤回' }\n        }\n\n        const updated = await prisma.approvalRequest.update({\n            where: { id },\n            data: { status: ApprovalStatus.CANCELLED },\n        })\n\n        revalidatePath('/admin/approvals')\n        if (updated.caseId) revalidatePath(`/cases/${updated.caseId}`)\n        return { success: true, data: updated }\n    } catch (error) {\n        console.error('撤回失败:', error)\n        return { success: false, error: '撤回失败' }\n    }\r\n}\r\n\r\n// ==============================================================================\r\n// 获取可选审批人（上级/部门主管）\r\n// ==============================================================================\r\n\r\nexport async function getAvailableApprovers() {\n    try {\n        const user = await getSessionUserOrThrow()\n        requirePermission(user.role, \"approval:create\")\n\n        // 获取有审批权限的用户（合伙人/高级律师/管理员）\n        const approvers = await prisma.user.findMany({\n            where: {\n                isActive: true,\n                role: { in: ['PARTNER', 'SENIOR_LAWYER', 'ADMIN'] },\r\n            },\r\n            select: {\r\n                id: true,\r\n                name: true,\r\n                title: true,\r\n                department: true,\r\n                avatarUrl: true,\r\n            },\r\n            orderBy: { name: 'asc' },\r\n        })\r\n\n        return { success: true, data: approvers }\n    } catch (error) {\n        console.error('获取审批人失败:', error)\n        return { success: false, error: '获取审批人失败', data: [] }\n    }\n}\n\n// ==============================================================================\n// [2.7] 案件视角：按案件获取审批（用于案件详情联动）\n// ==============================================================================\n\nexport async function getApprovalsByCase(caseId: string) {\n    try {\n        const user = await getSessionUserOrThrow()\n        requirePermission(user.role, \"approval:create\")\n        await requireCaseAccess(caseId, user.id, user.role, \"case:view\")\n\n        const approvals = await prisma.approvalRequest.findMany({\n            where: { caseId },\n            include: {\n                requester: { select: { id: true, name: true, avatarUrl: true } },\n                approver: { select: { id: true, name: true, avatarUrl: true } },\n                case: { select: { id: true, title: true, caseCode: true } },\n                client: { select: { id: true, name: true, type: true } },\n            },\n            orderBy: { createdAt: \"desc\" },\n        })\n\n        return { success: true, data: approvals }\n    } catch (error) {\n        console.error(\"获取案件审批失败:\", error)\n        return { success: false, error: \"获取案件审批失败\", data: [] as any[] }\n    }\n}\n","usedDeprecatedRules":[]},{"filePath":"D:\\Desktop\\LawClick_NEW\\lawclick-next\\src\\actions\\auth.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\Desktop\\LawClick_NEW\\lawclick-next\\src\\actions\\billing-actions.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\Desktop\\LawClick_NEW\\lawclick-next\\src\\actions\\cases-crud.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\Desktop\\LawClick_NEW\\lawclick-next\\src\\actions\\cases.ts","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":102,"column":18,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":102,"endColumn":21,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[3417,3420],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[3417,3420],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use server\"\r\n\r\nimport { prisma } from \"@/lib/prisma\"\r\nimport { redirect } from \"next/navigation\"\r\nimport { getSessionUserOrThrow, requirePermission, requireCaseAccess } from \"@/lib/server-auth\"\r\nimport { hasPermission } from \"@/lib/permissions\"\r\nimport type { Prisma } from \"@prisma/client\"\r\n\r\nexport async function getDashboardData() {\r\n    let user\r\n    try {\r\n        user = await getSessionUserOrThrow()\r\n    } catch {\r\n        redirect(\"/auth/login\")\r\n    }\r\n\r\n    try {\r\n        requirePermission(user.role, \"dashboard:view\")\r\n        const canViewCases = hasPermission(user.role, \"case:view\")\r\n\r\n        const caseAccessWhere: Prisma.CaseWhereInput = canViewCases\r\n            ? user.role === \"PARTNER\" || user.role === \"ADMIN\"\r\n                ? {}\r\n                : {\r\n                      OR: [\r\n                          { originatorId: user.id },\r\n                          { handlerId: user.id },\r\n                          { members: { some: { userId: user.id } } },\r\n                      ],\r\n                  }\r\n            : { id: \"__forbidden__\" }\r\n\r\n        const [cases, tasks, events, timeLogs] = await Promise.all([\r\n            canViewCases\r\n                ? prisma.case.findMany({\r\n                      where: caseAccessWhere,\r\n                      take: 5,\r\n                      orderBy: { updatedAt: \"desc\" },\r\n                      include: {\r\n                          tasks: true,\r\n                          client: true,\r\n                      },\r\n                  })\r\n                : Promise.resolve([]),\r\n            prisma.task.findMany({\r\n                where: { assigneeId: user.id, status: { not: \"DONE\" } },\r\n                take: 5,\r\n                orderBy: { priority: 'asc' },\r\n                ...(canViewCases ? { include: { case: { select: { id: true, title: true, caseCode: true } } } } : {}),\r\n            }),\r\n            prisma.event.findMany({\n                where: {\n                    status: \"SCHEDULED\",\n                    startTime: { gte: new Date() },\n                    OR: [\n                        { creatorId: user.id },\n                        { participants: { some: { userId: user.id } } },\n                        ...(canViewCases ? [{ case: caseAccessWhere }] : []),\n                    ],\n                },\n                take: 5,\n                orderBy: { startTime: 'asc' },\n                ...(canViewCases ? { include: { case: { select: { id: true, title: true, caseCode: true } } } } : {}),\n            }),\n            canViewCases\r\n                ? prisma.timeLog.findMany({\r\n                      where: { userId: user.id },\r\n                      orderBy: { createdAt: \"desc\" },\r\n                      take: 5,\r\n                  })\r\n                : Promise.resolve([]),\r\n        ])\r\n\r\n        return {\r\n            user,\r\n            cases,\r\n            tasks,\r\n            events,\r\n            timeLogs\r\n        }\r\n    } catch (error) {\r\n        console.error(\"Dashboard data fetch error:\", error);\r\n        return {\r\n            user,\r\n            cases: [],\r\n            tasks: [],\r\n            events: [],\r\n            timeLogs: []\r\n        }\r\n    }\r\n}\r\n\r\nexport async function getCases(\n    query?: string,\n    status?: string,\n    type?: string\n) {\n    const user = await getSessionUserOrThrow()\r\n    requirePermission(user.role, \"case:view\")\r\n\r\n    // Use explicit type to avoid TS errors on any\r\n    const where: any = {}\r\n\r\n    if (query) {\r\n        where.OR = [\r\n            { title: { contains: query } },\r\n            { caseCode: { contains: query } },\r\n            { client: { name: { contains: query } } }\r\n        ]\r\n    }\r\n\r\n    if (status && status !== 'all') {\r\n        where.status = status\r\n    }\r\n\r\n    if (type && type !== 'all') {\r\n        where.serviceType = type\r\n    }\r\n\r\n    const accessWhere =\r\n        user.role === \"PARTNER\" || user.role === \"ADMIN\"\r\n            ? {}\r\n            : {\r\n                  OR: [\r\n                      { originatorId: user.id },\r\n                      { handlerId: user.id },\r\n                      { members: { some: { userId: user.id } } },\r\n                  ],\r\n              }\r\n\r\n    const cases = await prisma.case.findMany({\n        where: { AND: [where, accessWhere] },\n        orderBy: { updatedAt: 'desc' },\n        include: {\n            tasks: true,\n            client: true\n        }\n    })\n\n    return cases.map((c) => ({\n        ...c,\n        contractValue: c.contractValue ? Number(c.contractValue) : null,\n    }))\n}\n\r\nexport async function getCaseDetails(id: string) {\r\n    const user = await getSessionUserOrThrow()\r\n    requirePermission(user.role, \"case:view\")\r\n\r\n    const caseItem = await prisma.case.findUnique({\r\n        where: { id },\r\n        include: {\r\n            tasks: true,\r\n            events: true,\r\n            timeLogs: true,\r\n            documents: true,\r\n            members: { include: { user: true } },\r\n            originator: true,\r\n            handler: true,\r\n            client: true\r\n        }\r\n    })\r\n\r\n    if (!caseItem) return null\r\n\r\n    await requireCaseAccess(id, user.id, user.role, \"case:view\")\r\n\r\n    return caseItem\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"D:\\Desktop\\LawClick_NEW\\lawclick-next\\src\\actions\\chat-actions.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\Desktop\\LawClick_NEW\\lawclick-next\\src\\actions\\collaboration-actions.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\Desktop\\LawClick_NEW\\lawclick-next\\src\\actions\\contract-actions.ts","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":111,"column":22,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":111,"endColumn":25,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[3973,3976],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[3973,3976],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":154,"column":74,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":154,"endColumn":77,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[5608,5611],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[5608,5611],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":2,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use server\"\n\nimport { prisma } from \"@/lib/prisma\"\nimport { revalidatePath } from \"next/cache\"\nimport { ContractStatus } from \"@prisma/client\"\nimport { getSessionUserOrThrow, requireCaseAccess, requirePermission } from \"@/lib/server-auth\"\n\nfunction parseDateInput(value?: string | Date | null) {\n    if (value === undefined || value === null) return null\n    const date = value instanceof Date ? value : new Date(value)\n    if (Number.isNaN(date.getTime())) throw new Error(\"无效日期\")\n    return date\n}\n\nexport async function createContract(input: {\n    contractNo?: string\n    title: string\n    status?: ContractStatus\n    amount?: number\n    signedAt?: string | Date | null\n    startDate?: string | Date | null\n    endDate?: string | Date | null\n    notes?: string\n    caseId?: string\n    clientId?: string\n    documentId?: string\n}) {\n    try {\n        const user = await getSessionUserOrThrow()\n        requirePermission(user.role, \"billing:create\")\n\n        let caseId = input.caseId || null\n        let clientId = input.clientId || null\n\n        if (input.documentId) {\n            const doc = await prisma.document.findUnique({\n                where: { id: input.documentId },\n                select: { id: true, caseId: true },\n            })\n            if (!doc) return { success: false as const, error: \"文档不存在\" }\n\n            if (!caseId) caseId = doc.caseId\n            if (caseId !== doc.caseId) return { success: false as const, error: \"合同与文档所属案件不一致\" }\n        }\n\n        if (caseId) {\n            await requireCaseAccess(caseId, user.id, user.role, \"case:view\")\n            if (!clientId) {\n                const row = await prisma.case.findUnique({ where: { id: caseId }, select: { clientId: true } })\n                clientId = row?.clientId || null\n            }\n        }\n\n        const signedAt = parseDateInput(input.signedAt)\n        const startDate = parseDateInput(input.startDate)\n        const endDate = parseDateInput(input.endDate)\n\n        let contractNo = (input.contractNo || \"\").trim()\n        if (!contractNo) {\n            const today = new Date()\n            const prefix = `CTR-${today.getFullYear()}${String(today.getMonth() + 1).padStart(2, \"0\")}${String(today.getDate()).padStart(2, \"0\")}`\n            const count = await prisma.contract.count({ where: { contractNo: { startsWith: prefix } } })\n            contractNo = `${prefix}-${String(count + 1).padStart(4, \"0\")}`\n        }\n\n        const contract = await prisma.contract.create({\n            data: {\n                contractNo,\n                title: input.title,\n                status: input.status ?? ContractStatus.DRAFT,\n                amount: input.amount,\n                signedAt,\n                startDate,\n                endDate,\n                notes: input.notes,\n                caseId,\n                clientId,\n                documentId: input.documentId ?? null,\n                creatorId: user.id,\n            },\n            include: {\n                case: { select: { id: true, title: true, caseCode: true } },\n                client: { select: { id: true, name: true, type: true } },\n                document: { select: { id: true, title: true, fileType: true, fileUrl: true } },\n                creator: { select: { id: true, name: true } },\n            },\n        })\n\n        if (contract.caseId) revalidatePath(`/cases/${contract.caseId}`)\n        if (contract.clientId) revalidatePath(`/crm/customers/${contract.clientId}`)\n        revalidatePath(\"/admin/finance\")\n\n        return { success: true as const, data: contract }\n    } catch (error) {\n        console.error(\"创建合同失败:\", error)\n        return { success: false as const, error: \"创建合同失败\" }\n    }\n}\n\nexport async function getContracts(options?: {\n    caseId?: string\n    clientId?: string\n    status?: ContractStatus\n    search?: string\n    limit?: number\n}) {\n    try {\n        const user = await getSessionUserOrThrow()\n        requirePermission(user.role, \"billing:view\")\n\n        const where: any = {}\n\n        if (options?.caseId) {\n            await requireCaseAccess(options.caseId, user.id, user.role, \"case:view\")\n            where.caseId = options.caseId\n        } else if (user.role !== \"PARTNER\" && user.role !== \"ADMIN\") {\n            where.case = {\n                OR: [\n                    { originatorId: user.id },\n                    { handlerId: user.id },\n                    { members: { some: { userId: user.id } } },\n                ],\n            }\n        }\n\n        if (options?.clientId) where.clientId = options.clientId\n        if (options?.status) where.status = options.status\n\n        const search = (options?.search || \"\").trim()\n        if (search) {\n            where.OR = [\n                { contractNo: { contains: search, mode: \"insensitive\" } },\n                { title: { contains: search, mode: \"insensitive\" } },\n            ]\n        }\n\n        const take = Math.max(1, Math.min(200, options?.limit ?? 50))\n\n        const contracts = await prisma.contract.findMany({\n            where,\n            include: {\n                case: { select: { id: true, title: true, caseCode: true } },\n                client: { select: { id: true, name: true, type: true } },\n                document: { select: { id: true, title: true, fileType: true } },\n                creator: { select: { id: true, name: true } },\n            },\n            orderBy: { updatedAt: \"desc\" },\n            take,\n        })\n\n        return { success: true as const, data: contracts }\n    } catch (error) {\n        console.error(\"获取合同列表失败:\", error)\n        return { success: false as const, error: \"获取合同列表失败\", data: [] as any[] }\n    }\n}\n\nexport async function getContractById(id: string) {\n    try {\n        const user = await getSessionUserOrThrow()\n        requirePermission(user.role, \"billing:view\")\n\n        const contract = await prisma.contract.findUnique({\n            where: { id },\n            include: {\n                case: { select: { id: true, title: true, caseCode: true } },\n                client: { select: { id: true, name: true, type: true, email: true, phone: true } },\n                document: { select: { id: true, title: true, fileType: true, fileUrl: true } },\n                creator: { select: { id: true, name: true } },\n            },\n        })\n        if (!contract) return { success: false as const, error: \"合同不存在\" }\n\n        if (contract.caseId) {\n            await requireCaseAccess(contract.caseId, user.id, user.role, \"case:view\")\n        } else {\n            requirePermission(user.role, \"admin:access\")\n        }\n\n        return { success: true as const, data: contract }\n    } catch (error) {\n        console.error(\"获取合同详情失败:\", error)\n        return { success: false as const, error: \"获取合同详情失败\" }\n    }\n}\n\nexport async function updateContractStatus(id: string, status: ContractStatus) {\n    try {\n        const user = await getSessionUserOrThrow()\n        requirePermission(user.role, \"billing:edit\")\n\n        const existing = await prisma.contract.findUnique({ where: { id }, select: { caseId: true, clientId: true } })\n        if (!existing) return { success: false as const, error: \"合同不存在\" }\n        if (existing.caseId) await requireCaseAccess(existing.caseId, user.id, user.role, \"case:view\")\n\n        const updated = await prisma.contract.update({\n            where: { id },\n            data: { status },\n        })\n\n        revalidatePath(\"/admin/finance\")\n        if (existing.caseId) revalidatePath(`/cases/${existing.caseId}`)\n        if (existing.clientId) revalidatePath(`/crm/customers/${existing.clientId}`)\n\n        return { success: true as const, data: updated }\n    } catch (error) {\n        console.error(\"更新合同状态失败:\", error)\n        return { success: false as const, error: \"更新合同状态失败\" }\n    }\n}\n\nexport async function linkContractDocument(contractId: string, documentId: string) {\n    try {\n        const user = await getSessionUserOrThrow()\n        requirePermission(user.role, \"billing:edit\")\n\n        const [contract, doc] = await Promise.all([\n            prisma.contract.findUnique({ where: { id: contractId }, select: { id: true, caseId: true, clientId: true } }),\n            prisma.document.findUnique({ where: { id: documentId }, select: { id: true, caseId: true } }),\n        ])\n        if (!contract) return { success: false as const, error: \"合同不存在\" }\n        if (!doc) return { success: false as const, error: \"文档不存在\" }\n\n        const nextCaseId = contract.caseId ?? doc.caseId\n        if (nextCaseId !== doc.caseId) return { success: false as const, error: \"合同与文档所属案件不一致\" }\n\n        if (nextCaseId) await requireCaseAccess(nextCaseId, user.id, user.role, \"case:view\")\n\n        const updated = await prisma.contract.update({\n            where: { id: contractId },\n            data: {\n                documentId: doc.id,\n                caseId: nextCaseId,\n            },\n        })\n\n        revalidatePath(\"/admin/finance\")\n        if (nextCaseId) revalidatePath(`/cases/${nextCaseId}`)\n        if (contract.clientId) revalidatePath(`/crm/customers/${contract.clientId}`)\n\n        return { success: true as const, data: updated }\n    } catch (error) {\n        console.error(\"关联合同文档失败:\", error)\n        return { success: false as const, error: \"关联合同文档失败\" }\n    }\n}\n\n","usedDeprecatedRules":[]},{"filePath":"D:\\Desktop\\LawClick_NEW\\lawclick-next\\src\\actions\\customer-actions.ts","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":28,"column":22,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":28,"endColumn":25,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[881,884],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[881,884],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":387,"column":22,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":387,"endColumn":25,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[13092,13095],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[13092,13095],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":406,"column":65,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":406,"endColumn":68,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[13797,13800],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[13797,13800],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":3,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use server\"\n\nimport { prisma } from \"@/lib/prisma\"\nimport { revalidatePath } from \"next/cache\"\nimport { CustomerStage, CustomerGrade } from \"@prisma/client\"\nimport { getSessionUserOrThrow, requirePermission } from \"@/lib/server-auth\"\n\r\n// ==============================================================================\r\n// [2.1] 获取客户列表（分页+筛选+搜索）\r\n// ==============================================================================\r\n\r\nexport async function getCustomers(options?: {\r\n    page?: number\r\n    limit?: number\r\n    search?: string\r\n    stage?: CustomerStage\r\n    grade?: CustomerGrade\r\n    assigneeId?: string\r\n}) {\n    try {\n        const user = await getSessionUserOrThrow()\n        requirePermission(user.role, \"crm:view\")\n\n        const page = options?.page || 1\n        const limit = options?.limit || 20\n        const skip = (page - 1) * limit\n\r\n        const where: any = {}\r\n\r\n        // 搜索条件\r\n        if (options?.search) {\r\n            where.OR = [\r\n                { name: { contains: options.search, mode: 'insensitive' } },\r\n                { email: { contains: options.search, mode: 'insensitive' } },\r\n                { phone: { contains: options.search } },\r\n            ]\r\n        }\r\n\r\n        // 筛选条件\r\n        if (options?.stage) where.stage = options.stage\r\n        if (options?.grade) where.grade = options.grade\r\n        if (options?.assigneeId) where.assigneeId = options.assigneeId\r\n\r\n        const [customers, total] = await Promise.all([\r\n            prisma.contact.findMany({\r\n                where,\r\n                include: {\r\n                    assignee: { select: { id: true, name: true, avatarUrl: true } },\r\n                    tags: { select: { id: true, name: true, color: true } },\r\n                    _count: { select: { casesAsClient: true, serviceRecords: true } },\r\n                },\r\n                orderBy: { updatedAt: 'desc' },\r\n                skip,\r\n                take: limit,\r\n            }),\r\n            prisma.contact.count({ where }),\r\n        ])\r\n\r\n        return { success: true, data: customers, total, page, limit }\r\n    } catch (error) {\r\n        console.error('获取客户列表失败:', error)\r\n        return { success: false, error: '获取客户列表失败', data: [], total: 0 }\r\n    }\r\n}\r\n\r\n// ==============================================================================\r\n// [2.2] 获取客户详情\r\n// ==============================================================================\r\n\r\nexport async function getCustomerById(id: string) {\n    try {\n        const user = await getSessionUserOrThrow()\n        requirePermission(user.role, \"crm:view\")\n\n        const customer = await prisma.contact.findUnique({\n            where: { id },\n            include: {\n                assignee: { select: { id: true, name: true, avatarUrl: true, title: true } },\r\n                tags: { select: { id: true, name: true, color: true } },\r\n                casesAsClient: {\r\n                    select: { id: true, title: true, caseCode: true, status: true },\r\n                    take: 10,\r\n                    orderBy: { createdAt: 'desc' },\r\n                },\r\n                serviceRecords: {\r\n                    include: { lawyer: { select: { name: true } } },\r\n                    orderBy: { serviceDate: 'desc' },\r\n                    take: 10,\r\n                },\r\n            },\r\n        })\r\n\r\n        if (!customer) {\r\n            return { success: false, error: '客户不存在' }\r\n        }\r\n\r\n        return { success: true, data: customer }\r\n    } catch (error) {\r\n        console.error('获取客户详情失败:', error)\r\n        return { success: false, error: '获取客户详情失败' }\r\n    }\r\n}\r\n\r\n// ==============================================================================\r\n// [2.3] 创建客户\r\n// ==============================================================================\r\n\r\nexport async function createCustomer(data: {\n    name: string\r\n    type: 'COMPANY' | 'INDIVIDUAL'\r\n    email?: string\r\n    phone?: string\r\n    industry?: string\r\n    source?: string\r\n    address?: string\r\n    notes?: string\r\n    stage?: CustomerStage\r\n    grade?: CustomerGrade\r\n}) {\n    try {\n        const user = await getSessionUserOrThrow()\n        requirePermission(user.role, \"crm:edit\")\n\n        const customer = await prisma.contact.create({\n            data: {\n                name: data.name,\n                type: data.type,\r\n                email: data.email,\r\n                phone: data.phone,\r\n                industry: data.industry,\r\n                source: data.source,\r\n                address: data.address,\r\n                notes: data.notes,\r\n                stage: data.stage || 'POTENTIAL',\r\n                grade: data.grade || 'POTENTIAL',\r\n                assigneeId: user.id, // 创建人默认为负责人\r\n            },\r\n        })\r\n\r\n        revalidatePath('/crm/customers')\r\n        return { success: true, data: customer }\r\n    } catch (error) {\r\n        console.error('创建客户失败:', error)\r\n        return { success: false, error: '创建客户失败' }\n    }\n}\n\n// ==============================================================================\n// [2.3.1] 更新客户（基础信息/负责人/下次跟进）\n// ==============================================================================\n\nexport async function updateCustomer(id: string, data: {\n    name?: string\n    email?: string | null\n    phone?: string | null\n    industry?: string | null\n    source?: string | null\n    address?: string | null\n    notes?: string | null\n    stage?: CustomerStage\n    grade?: CustomerGrade\n    nextFollowUp?: Date | null\n    assigneeId?: string | null\n}) {\n    try {\n        const user = await getSessionUserOrThrow()\n        requirePermission(user.role, \"crm:edit\")\n\n        const updated = await prisma.contact.update({\n            where: { id },\n            data: {\n                ...(data.name !== undefined ? { name: data.name } : {}),\n                ...(data.email !== undefined ? { email: data.email } : {}),\n                ...(data.phone !== undefined ? { phone: data.phone } : {}),\n                ...(data.industry !== undefined ? { industry: data.industry } : {}),\n                ...(data.source !== undefined ? { source: data.source } : {}),\n                ...(data.address !== undefined ? { address: data.address } : {}),\n                ...(data.notes !== undefined ? { notes: data.notes } : {}),\n                ...(data.stage !== undefined ? { stage: data.stage } : {}),\n                ...(data.grade !== undefined ? { grade: data.grade } : {}),\n                ...(data.nextFollowUp !== undefined ? { nextFollowUp: data.nextFollowUp } : {}),\n                ...(data.assigneeId !== undefined ? { assigneeId: data.assigneeId } : {}),\n            },\n        })\n\n        revalidatePath('/crm/customers')\n        revalidatePath(`/crm/customers/${id}`)\n        return { success: true, data: updated }\n    } catch (error) {\n        console.error('更新客户失败:', error)\n        return { success: false, error: '更新客户失败' }\n    }\n}\n\n// ==============================================================================\n// [2.4] 更新客户阶段\n// ==============================================================================\n\r\nexport async function updateCustomerStage(id: string, stage: CustomerStage) {\n    try {\n        const user = await getSessionUserOrThrow()\n        requirePermission(user.role, \"crm:edit\")\n\n        const customer = await prisma.contact.update({\n            where: { id },\n            data: { stage },\n        })\r\n\r\n        revalidatePath('/crm/customers')\r\n        revalidatePath(`/crm/customers/${id}`)\r\n        return { success: true, data: customer }\r\n    } catch (error) {\r\n        console.error('更新客户阶段失败:', error)\r\n        return { success: false, error: '更新客户阶段失败' }\r\n    }\r\n}\r\n\r\n// ==============================================================================\r\n// [2.5] 标签管理\r\n// ==============================================================================\r\n\r\n// 获取所有标签\r\nexport async function getTags() {\n    try {\n        const user = await getSessionUserOrThrow()\n        requirePermission(user.role, \"crm:view\")\n\n        const tags = await prisma.customerTag.findMany({\n            include: { _count: { select: { contacts: true } } },\n            orderBy: { name: 'asc' },\n        })\n        return { success: true, data: tags }\r\n    } catch (error) {\r\n        console.error('获取标签失败:', error)\r\n        return { success: false, error: '获取标签失败', data: [] }\r\n    }\r\n}\r\n\r\n// 添加标签到客户\r\nexport async function addTagToCustomer(customerId: string, tagId: string) {\n    try {\n        const user = await getSessionUserOrThrow()\n        requirePermission(user.role, \"crm:edit\")\n\n        await prisma.contact.update({\n            where: { id: customerId },\n            data: {\n                tags: { connect: { id: tagId } },\r\n            },\r\n        })\r\n\r\n        revalidatePath(`/crm/customers/${customerId}`)\r\n        return { success: true }\r\n    } catch (error) {\r\n        console.error('添加标签失败:', error)\r\n        return { success: false, error: '添加标签失败' }\r\n    }\r\n}\r\n\r\n// 创建新标签\r\nexport async function createTag(name: string, color?: string) {\n    try {\n        const user = await getSessionUserOrThrow()\n        requirePermission(user.role, \"crm:edit\")\n\n        const tag = await prisma.customerTag.create({\n            data: { name, color: color || '#3b82f6' },\n        })\n\r\n        return { success: true, data: tag }\r\n    } catch (error) {\r\n        console.error('创建标签失败:', error)\r\n        return { success: false, error: '创建标签失败' }\r\n    }\r\n}\r\n\r\n// ==============================================================================\r\n// [2.6] 服务记录管理\r\n// ==============================================================================\r\n\r\n// 添加服务记录\r\nexport async function addServiceRecord(data: {\n    contactId: string\r\n    type: string\r\n    content: string\r\n    serviceDate: Date\r\n    satisfaction?: number\r\n    followUpNote?: string\r\n    nextAction?: string\r\n}) {\n    try {\n        const user = await getSessionUserOrThrow()\n        requirePermission(user.role, \"crm:edit\")\n\n        const record = await prisma.serviceRecord.create({\n            data: {\n                contactId: data.contactId,\n                lawyerId: user.id,\n                type: data.type,\r\n                content: data.content,\r\n                serviceDate: data.serviceDate,\r\n                satisfaction: data.satisfaction,\r\n                followUpNote: data.followUpNote,\r\n                nextAction: data.nextAction,\r\n            },\r\n        })\r\n\r\n        revalidatePath(`/crm/customers/${data.contactId}`)\r\n        return { success: true, data: record }\r\n    } catch (error) {\r\n        console.error('添加服务记录失败:', error)\r\n        return { success: false, error: '添加服务记录失败' }\r\n    }\r\n}\r\n\r\n// 获取服务记录\r\nexport async function getServiceRecords(contactId: string) {\n    try {\n        const user = await getSessionUserOrThrow()\n        requirePermission(user.role, \"crm:view\")\n\n        const records = await prisma.serviceRecord.findMany({\n            where: { contactId },\n            include: { lawyer: { select: { name: true, avatarUrl: true } } },\n            orderBy: { serviceDate: 'desc' },\n        })\n        return { success: true, data: records }\r\n    } catch (error) {\r\n        console.error('获取服务记录失败:', error)\r\n        return { success: false, error: '获取服务记录失败', data: [] }\r\n    }\r\n}\r\n\r\n// ==============================================================================\r\n// 客户统计\r\n// ==============================================================================\r\n\r\nexport async function getCustomerStats() {\n    try {\n        const user = await getSessionUserOrThrow()\n        requirePermission(user.role, \"crm:view\")\n\n        const [total, byStage, byGrade] = await Promise.all([\n            prisma.contact.count(),\n            prisma.contact.groupBy({\n                by: ['stage'],\r\n                _count: true,\r\n            }),\r\n            prisma.contact.groupBy({\r\n                by: ['grade'],\r\n                _count: true,\r\n            }),\r\n        ])\r\n\r\n        return {\r\n            success: true,\r\n            data: {\r\n                total,\r\n                byStage: byStage.reduce((acc, item) => {\r\n                    acc[item.stage] = item._count\r\n                    return acc\r\n                }, {} as Record<string, number>),\r\n                byGrade: byGrade.reduce((acc, item) => {\r\n                    acc[item.grade] = item._count\r\n                    return acc\r\n                }, {} as Record<string, number>),\r\n            },\r\n        }\r\n    } catch (error) {\r\n        console.error('获取客户统计失败:', error)\r\n        return { success: false, error: '获取客户统计失败' }\n    }\n}\n\n// ==============================================================================\n// 轻量目录（用于 Select/搜索）\n// ==============================================================================\n\nexport async function getCustomerDirectory(options?: { search?: string; limit?: number }) {\n    try {\n        const user = await getSessionUserOrThrow()\n        requirePermission(user.role, \"crm:view\")\n\n        const limit = Math.max(1, Math.min(100, options?.limit ?? 30))\n        const search = (options?.search || \"\").trim()\n\n        const where: any = {}\n        if (search) {\n            where.OR = [\n                { name: { contains: search, mode: \"insensitive\" } },\n                { email: { contains: search, mode: \"insensitive\" } },\n                { phone: { contains: search } },\n            ]\n        }\n\n        const rows = await prisma.contact.findMany({\n            where,\n            select: { id: true, name: true, type: true, email: true, phone: true, stage: true, grade: true },\n            orderBy: { updatedAt: \"desc\" },\n            take: limit,\n        })\n\n        return { success: true, data: rows }\n    } catch (error) {\n        console.error(\"获取客户目录失败:\", error)\n        return { success: false, error: \"获取客户目录失败\", data: [] as any[] }\n    }\n}\n","usedDeprecatedRules":[]},{"filePath":"D:\\Desktop\\LawClick_NEW\\lawclick-next\\src\\actions\\dashboard-layout.ts","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":110,"column":71,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":110,"endColumn":74,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[4288,4291],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[4288,4291],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":131,"column":50,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":131,"endColumn":53,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[5185,5188],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[5185,5188],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":143,"column":42,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":143,"endColumn":45,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[5537,5540],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[5537,5540],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":168,"column":72,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":168,"endColumn":75,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[6410,6413],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[6410,6413],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":169,"column":41,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":169,"endColumn":44,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[6457,6460],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[6457,6460],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":189,"column":72,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":189,"endColumn":75,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[7142,7145],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[7142,7145],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":190,"column":41,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":190,"endColumn":44,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[7189,7192],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[7189,7192],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":7,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use server\"\n\nimport { revalidatePath } from \"next/cache\"\nimport { prisma } from \"@/lib/prisma\"\nimport { getSessionUserOrThrow, requirePermission } from \"@/lib/server-auth\"\nimport { hasPermission } from \"@/lib/permissions\"\nimport {\n    DEFAULT_DASHBOARD_CONFIG_VERSION,\n    DEFAULT_DASHBOARD_KEY,\n    type DashboardConfig,\n    type DashboardGridItem,\n    type DashboardWidgetInstance,\n} from \"@/lib/dashboard/types\"\nimport { DASHBOARD_WIDGET_DEFINITIONS, getDashboardWidgetMetaById } from \"@/lib/dashboard-widgets\"\nimport type { Role } from \"@prisma/client\"\n\nfunction isWidgetAllowedForRole(role: Role, widgetId: string) {\n    const meta = getDashboardWidgetMetaById(widgetId)\n    if (!meta) return false\n    return meta.requiredPermissions.every((p) => hasPermission(role, p))\n}\n\nfunction buildDefaultDashboardConfigForRole(role: Role): DashboardConfig {\n    const canViewCases = hasPermission(role, \"case:view\")\n\n    const defaultWidgetIds = canViewCases ? [\"w_cases\", \"w_tasks\", \"w_events\", \"w_time\"] : [\"w_tasks\", \"w_events\"]\n    const widgets: DashboardWidgetInstance[] = defaultWidgetIds\n        .map((id) => getDashboardWidgetMetaById(id))\n        .filter(Boolean)\n        .map((meta) => ({ id: meta!.id, type: meta!.type }))\n\n    const layout: DashboardGridItem[] = canViewCases\n        ? [\n              {\n                  i: \"w_cases\",\n                  x: 0,\n                  y: 0,\n                  ...(getDashboardWidgetMetaById(\"w_cases\")?.defaultSize || { w: 8, h: 12, minW: 6, minH: 8 }),\n              },\n              {\n                  i: \"w_tasks\",\n                  x: 8,\n                  y: 0,\n                  ...(getDashboardWidgetMetaById(\"w_tasks\")?.defaultSize || { w: 4, h: 6, minW: 3, minH: 4 }),\n              },\n              {\n                  i: \"w_events\",\n                  x: 8,\n                  y: 6,\n                  ...(getDashboardWidgetMetaById(\"w_events\")?.defaultSize || { w: 4, h: 6, minW: 3, minH: 4 }),\n              },\n              {\n                  i: \"w_time\",\n                  x: 0,\n                  y: 12,\n                  ...(getDashboardWidgetMetaById(\"w_time\")?.defaultSize || { w: 6, h: 5, minW: 4, minH: 4 }),\n              },\n          ]\n        : [\n              {\n                  i: \"w_tasks\",\n                  x: 0,\n                  y: 0,\n                  w: 6,\n                  h: getDashboardWidgetMetaById(\"w_tasks\")?.defaultSize.h || 6,\n                  minW: getDashboardWidgetMetaById(\"w_tasks\")?.defaultSize.minW || 3,\n                  minH: getDashboardWidgetMetaById(\"w_tasks\")?.defaultSize.minH || 4,\n              },\n              {\n                  i: \"w_events\",\n                  x: 6,\n                  y: 0,\n                  w: 6,\n                  h: getDashboardWidgetMetaById(\"w_events\")?.defaultSize.h || 6,\n                  minW: getDashboardWidgetMetaById(\"w_events\")?.defaultSize.minW || 3,\n                  minH: getDashboardWidgetMetaById(\"w_events\")?.defaultSize.minH || 4,\n              },\n          ]\n\n    return { configVersion: DEFAULT_DASHBOARD_CONFIG_VERSION, widgets, layout }\n}\n\nfunction sanitizeConfigForRole(role: Role, input: DashboardConfig): DashboardConfig {\n    const configVersion =\n        typeof input.configVersion === \"number\" ? input.configVersion : DEFAULT_DASHBOARD_CONFIG_VERSION\n\n    const requestedWidgets = Array.isArray(input.widgets) ? input.widgets : []\n    const requestedLayout = Array.isArray(input.layout) ? input.layout : []\n\n    const allowedWidgetIds = new Set(\n        DASHBOARD_WIDGET_DEFINITIONS.filter((w) => w.requiredPermissions.every((p) => hasPermission(role, p))).map(\n            (w) => w.id\n        )\n    )\n\n    const widgets: DashboardWidgetInstance[] = []\n    const seen = new Set<string>()\n    for (const w of requestedWidgets) {\n        if (!w?.id || typeof w.id !== \"string\") continue\n        if (!allowedWidgetIds.has(w.id)) continue\n        if (seen.has(w.id)) continue\n        const meta = getDashboardWidgetMetaById(w.id)\n        if (!meta) continue\n        if (!isWidgetAllowedForRole(role, w.id)) continue\n        widgets.push({ id: meta.id, type: meta.type })\n        seen.add(w.id)\n    }\n\n    const widgetIds = new Set(widgets.map((w) => w.id))\n    const layout: DashboardGridItem[] = requestedLayout.filter((item: any) => item?.i && widgetIds.has(item.i))\n\n    return { configVersion, widgets, layout }\n}\n\nexport async function getMyDashboardConfig(dashboardKey = DEFAULT_DASHBOARD_KEY) {\n    try {\n        const user = await getSessionUserOrThrow()\n        requirePermission(user.role, \"dashboard:view\")\n\n        const existing = await prisma.dashboardLayout.findUnique({\n            where: { userId_dashboardKey: { userId: user.id, dashboardKey } },\n            select: { id: true, config: true },\n        })\n\n        if (existing?.config) {\n            const sanitized = sanitizeConfigForRole(user.role, existing.config as DashboardConfig)\n            const changed = JSON.stringify(sanitized) !== JSON.stringify(existing.config)\n            if (changed) {\n                await prisma.dashboardLayout.update({\n                    where: { id: existing.id },\n                    data: { config: sanitized as any },\n                })\n            }\n            return { success: true, data: sanitized }\n        }\n\n        const defaultConfig = buildDefaultDashboardConfigForRole(user.role)\n\n        await prisma.dashboardLayout.create({\n            data: {\n                userId: user.id,\n                dashboardKey,\n                config: defaultConfig as any,\n            },\n        })\n\n        return { success: true, data: defaultConfig }\n    } catch (error) {\n        console.error(\"获取仪表盘配置失败:\", error)\n        return {\n            success: false,\n            error: \"获取仪表盘配置失败\",\n            data: buildDefaultDashboardConfigForRole(\"LAWYER\"),\n        }\n    }\n}\n\nexport async function saveMyDashboardConfig(input: { dashboardKey?: string; config: DashboardConfig }) {\n    try {\n        const user = await getSessionUserOrThrow()\n        requirePermission(user.role, \"dashboard:edit\")\n\n        const dashboardKey = input.dashboardKey || DEFAULT_DASHBOARD_KEY\n        const config = sanitizeConfigForRole(user.role, input.config)\n\n        await prisma.dashboardLayout.upsert({\n            where: { userId_dashboardKey: { userId: user.id, dashboardKey } },\n            create: { userId: user.id, dashboardKey, config: config as any },\n            update: { config: config as any },\n        })\n\n        revalidatePath(\"/dashboard\")\n        return { success: true }\n    } catch (error) {\n        console.error(\"保存仪表盘配置失败:\", error)\n        return { success: false, error: \"保存仪表盘配置失败\" }\n    }\n}\n\nexport async function resetMyDashboardConfig(dashboardKey = DEFAULT_DASHBOARD_KEY) {\n    try {\n        const user = await getSessionUserOrThrow()\n        requirePermission(user.role, \"dashboard:edit\")\n\n        const config = buildDefaultDashboardConfigForRole(user.role)\n\n        await prisma.dashboardLayout.upsert({\n            where: { userId_dashboardKey: { userId: user.id, dashboardKey } },\n            create: { userId: user.id, dashboardKey, config: config as any },\n            update: { config: config as any },\n        })\n\n        revalidatePath(\"/dashboard\")\n        return { success: true, data: config }\n    } catch (error) {\n        console.error(\"重置仪表盘配置失败:\", error)\n        return { success: false, error: \"重置仪表盘配置失败\" }\n    }\n}\n","usedDeprecatedRules":[]},{"filePath":"D:\\Desktop\\LawClick_NEW\\lawclick-next\\src\\actions\\documents.ts","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":46,"column":22,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":46,"endColumn":25,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1574,1577],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1574,1577],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":70,"column":65,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":70,"endColumn":68,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[2547,2550],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[2547,2550],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":2,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use server\"\r\n\r\nimport { revalidatePath } from \"next/cache\"\r\nimport { DeleteObjectCommand, PutObjectCommand } from \"@aws-sdk/client-s3\"\r\nimport { randomUUID } from \"crypto\"\r\nimport { prisma } from \"@/lib/prisma\"\r\nimport { BUCKET_NAME, ensureBucketExists, s3Client } from \"@/lib/s3\"\r\nimport { getSessionUserOrThrow, requirePermission, requireCaseAccess } from \"@/lib/server-auth\"\r\nimport { compileTemplate } from \"@/lib/templates/registry\"\r\n\r\nfunction sanitizeFilename(filename: string) {\r\n    return filename\r\n        .replace(/[\\\\/:*?\"<>|]+/g, \"-\")\r\n        .replace(/\\s+/g, \" \")\r\n        .trim()\r\n}\r\n\r\nfunction buildObjectKey(input: {\r\n    caseId: string\r\n    documentId: string\r\n    version: number\r\n    filename: string\r\n}) {\r\n    const safeFilename = sanitizeFilename(input.filename || \"document\")\r\n    const ts = new Date().toISOString().replace(/[:.]/g, \"-\")\r\n    return `cases/${input.caseId}/documents/${input.documentId}/v${input.version}/${ts}-${safeFilename}`\r\n}\r\n\r\n// ==============================================================================\r\n// 获取文档列表\r\n// ==============================================================================\r\n\r\nexport async function getDocuments(options?: {\r\n    caseId?: string\r\n    category?: string\r\n    query?: string\r\n    onlyFavorites?: boolean\r\n}) {\r\n    try {\r\n        const user = await getSessionUserOrThrow()\r\n        requirePermission(user.role, \"document:view\")\r\n        if (options?.caseId) {\r\n            await requireCaseAccess(options.caseId, user.id, user.role, \"case:view\")\r\n        }\r\n\r\n        const where: any = {}\r\n\r\n        if (options?.caseId) where.caseId = options.caseId\r\n        if (options?.category && options.category !== \"all\") where.category = options.category\r\n        if (options?.onlyFavorites) where.isFavorite = true\r\n        if (options?.query) {\r\n            where.OR = [\r\n                { title: { contains: options.query, mode: \"insensitive\" } },\r\n                { notes: { contains: options.query, mode: \"insensitive\" } },\r\n            ]\r\n        }\r\n\r\n        const documents = await prisma.document.findMany({\r\n            where,\r\n            include: {\r\n                case: { select: { id: true, title: true, caseCode: true } },\r\n                uploader: { select: { id: true, name: true } },\r\n            },\r\n            orderBy: { updatedAt: \"desc\" },\r\n        })\r\n\r\n        return { success: true, data: documents }\r\n    } catch (error) {\r\n        console.error(\"获取文档列表失败:\", error)\r\n        return { success: false, error: \"获取文档列表失败\", data: [] as any[] }\r\n    }\r\n}\r\n\r\n// ==============================================================================\r\n// 获取文档详情（含版本）\r\n// ==============================================================================\r\n\r\nexport async function getDocumentById(id: string) {\r\n    try {\r\n        const user = await getSessionUserOrThrow()\r\n        requirePermission(user.role, \"document:view\")\r\n\r\n        const document = await prisma.document.findUnique({\r\n            where: { id },\r\n            include: {\r\n                case: { select: { id: true, title: true, caseCode: true } },\r\n                uploader: { select: { id: true, name: true } },\r\n                tasks: { select: { id: true, title: true, status: true } },\r\n                versions: {\r\n                    orderBy: { version: \"desc\" },\r\n                    include: { uploader: { select: { id: true, name: true } } },\r\n                },\r\n            },\r\n        })\r\n\r\n        if (!document) {\r\n            return { success: false, error: \"文档不存在\" }\r\n        }\r\n\r\n        await requireCaseAccess(document.caseId, user.id, user.role, \"case:view\")\r\n\r\n        return { success: true, data: document }\r\n    } catch (error) {\r\n        console.error(\"获取文档详情失败:\", error)\r\n        return { success: false, error: \"获取文档详情失败\" }\r\n    }\r\n}\r\n\r\n// ==============================================================================\r\n// 更新文档信息\r\n// ==============================================================================\r\n\r\nexport async function updateDocument(\r\n    id: string,\r\n    data: {\r\n        title?: string\r\n        category?: string\r\n        notes?: string\r\n        tags?: string[]\r\n        isConfidential?: boolean\r\n    }\r\n) {\r\n    try {\r\n        const user = await getSessionUserOrThrow()\r\n        requirePermission(user.role, \"document:edit\")\r\n\r\n        const existing = await prisma.document.findUnique({\r\n            where: { id },\r\n            select: { caseId: true },\r\n        })\r\n        if (!existing) {\r\n            return { success: false, error: \"文档不存在\" }\r\n        }\r\n\r\n        await requireCaseAccess(existing.caseId, user.id, user.role, \"case:view\")\r\n\r\n        const document = await prisma.document.update({\r\n            where: { id },\r\n            data: {\r\n                title: data.title,\r\n                category: data.category,\r\n                notes: data.notes,\r\n                tags: data.tags,\r\n                isConfidential: data.isConfidential,\r\n            },\r\n        })\r\n\r\n        revalidatePath(\"/documents\")\r\n        revalidatePath(`/documents/${id}`)\r\n        return { success: true, data: document }\r\n    } catch (error) {\r\n        console.error(\"更新文档失败:\", error)\r\n        return { success: false, error: \"更新文档失败\" }\r\n    }\r\n}\r\n\r\n// ==============================================================================\r\n// 删除文档（DB + MinIO 对象）\r\n// ==============================================================================\r\n\r\nexport async function deleteDocument(id: string) {\r\n    try {\r\n        const user = await getSessionUserOrThrow()\r\n        requirePermission(user.role, \"document:delete\")\r\n\r\n        const document = await prisma.document.findUnique({\r\n            where: { id },\r\n            include: { versions: { select: { fileKey: true } } },\r\n        })\r\n        if (!document) {\r\n            return { success: false, error: \"文档不存在\" }\r\n        }\r\n\r\n        await requireCaseAccess(document.caseId, user.id, user.role, \"case:view\")\r\n\r\n        const fileKeys = document.versions.map(v => v.fileKey).filter(Boolean)\r\n\r\n        await prisma.document.delete({ where: { id } })\r\n\r\n        try {\r\n            await ensureBucketExists()\r\n            await Promise.all(\r\n                fileKeys.map(key =>\r\n                    s3Client.send(new DeleteObjectCommand({ Bucket: BUCKET_NAME, Key: key })).catch(() => null)\r\n                )\r\n            )\r\n        } catch (e) {\r\n            console.warn(\"删除 MinIO 对象失败（已忽略）:\", e)\r\n        }\r\n\r\n        revalidatePath(\"/documents\")\r\n        revalidatePath(`/cases/${document.caseId}`)\r\n        return { success: true }\r\n    } catch (error) {\r\n        console.error(\"删除文档失败:\", error)\r\n        return { success: false, error: \"删除文档失败\" }\r\n    }\r\n}\r\n\r\n// ==============================================================================\r\n// 切换收藏\r\n// ==============================================================================\r\n\r\nexport async function toggleDocumentFavorite(id: string) {\r\n    try {\r\n        const user = await getSessionUserOrThrow()\r\n        requirePermission(user.role, \"document:edit\")\r\n\r\n        const document = await prisma.document.findUnique({ where: { id } })\r\n        if (!document) {\r\n            return { success: false, error: \"文档不存在\" }\r\n        }\r\n\r\n        await requireCaseAccess(document.caseId, user.id, user.role, \"case:view\")\r\n\r\n        const updated = await prisma.document.update({\r\n            where: { id },\r\n            data: { isFavorite: !document.isFavorite },\r\n        })\r\n\r\n        revalidatePath(\"/documents\")\r\n        revalidatePath(`/documents/${id}`)\r\n        return { success: true, data: updated }\r\n    } catch (error) {\r\n        console.error(\"切换收藏失败:\", error)\r\n        return { success: false, error: \"切换收藏失败\" }\r\n    }\r\n}\r\n\r\n// ==============================================================================\r\n// 标签：添加/移除\r\n// ==============================================================================\r\n\r\nexport async function addDocumentTag(id: string, tag: string) {\r\n    try {\r\n        const user = await getSessionUserOrThrow()\r\n        requirePermission(user.role, \"document:edit\")\r\n\r\n        const document = await prisma.document.findUnique({ where: { id } })\r\n        if (!document) {\r\n            return { success: false, error: \"文档不存在\" }\r\n        }\r\n\r\n        await requireCaseAccess(document.caseId, user.id, user.role, \"case:view\")\r\n\r\n        const newTags = [...(document.tags || []), tag].filter((v, i, a) => a.indexOf(v) === i)\r\n\r\n        const updated = await prisma.document.update({\r\n            where: { id },\r\n            data: { tags: newTags },\r\n        })\r\n\r\n        revalidatePath(\"/documents\")\r\n        revalidatePath(`/documents/${id}`)\r\n        return { success: true, data: updated }\r\n    } catch (error) {\r\n        console.error(\"添加标签失败:\", error)\r\n        return { success: false, error: \"添加标签失败\" }\r\n    }\r\n}\r\n\r\nexport async function removeDocumentTag(id: string, tag: string) {\r\n    try {\r\n        const user = await getSessionUserOrThrow()\r\n        requirePermission(user.role, \"document:edit\")\r\n\r\n        const document = await prisma.document.findUnique({ where: { id } })\r\n        if (!document) {\r\n            return { success: false, error: \"文档不存在\" }\r\n        }\r\n\r\n        await requireCaseAccess(document.caseId, user.id, user.role, \"case:view\")\r\n\r\n        const newTags = (document.tags || []).filter(t => t !== tag)\r\n\r\n        const updated = await prisma.document.update({\r\n            where: { id },\r\n            data: { tags: newTags },\r\n        })\r\n\r\n        revalidatePath(\"/documents\")\r\n        revalidatePath(`/documents/${id}`)\r\n        return { success: true, data: updated }\r\n    } catch (error) {\r\n        console.error(\"移除标签失败:\", error)\r\n        return { success: false, error: \"移除标签失败\" }\r\n    }\r\n}\r\n\r\nexport type GeneratedDoc = {\r\n    id: string\r\n    name: string\r\n    type: string\r\n    date: string\r\n    url: string\r\n}\r\n\r\nexport async function generateDocument(\r\n    caseId: string,\r\n    templateId: string,\r\n    data: Record<string, string>\r\n) {\r\n    try {\r\n        const user = await getSessionUserOrThrow()\r\n        requirePermission(user.role, \"document:upload\")\r\n        await requireCaseAccess(caseId, user.id, user.role, \"case:view\")\r\n\r\n        const compiled = compileTemplate(templateId, data)\r\n\r\n        const title = `${templateId}_Draft`\r\n        const document = await prisma.document.create({\r\n            data: {\r\n                title,\r\n                fileUrl: \"\",\r\n                fileType: \"pending\",\r\n                fileSize: 0,\r\n                caseId,\r\n                category: \"litigation\",\r\n                tags: [],\r\n                notes: `智能起草生成，占位文档，待后续编辑/上传。\\n\\n---\\n\\n${compiled}`,\r\n                uploaderId: user.id,\r\n            },\r\n        })\r\n\r\n        const newDoc: GeneratedDoc = {\r\n            id: document.id,\r\n            name: `${title}.pdf`,\r\n            type: \"pdf\",\r\n            date: document.createdAt.toISOString().split(\"T\")[0],\r\n            url: document.fileUrl || \"#\",\r\n        }\r\n\r\n        revalidatePath(`/cases/${caseId}`)\r\n        revalidatePath(\"/documents\")\r\n\r\n        return { success: true, document: newDoc }\r\n    } catch (error) {\r\n        console.error(\"Doc Gen Failed:\", error)\r\n        return { success: false, error: String(error) }\r\n    }\r\n}\r\n\r\nexport async function uploadDocument(formData: FormData) {\r\n    try {\r\n        const user = await getSessionUserOrThrow()\r\n        requirePermission(user.role, \"document:upload\")\r\n\r\n        const file = formData.get(\"file\") as File | null\r\n        const caseId = (formData.get(\"caseId\") as string | null)?.trim() || null\r\n        const documentId = (formData.get(\"documentId\") as string | null)?.trim() || null\r\n        const titleInput = (formData.get(\"title\") as string | null)?.trim() || null\r\n        const category = (formData.get(\"category\") as string | null)?.trim() || null\r\n        const notes = (formData.get(\"notes\") as string | null)?.trim() || null\r\n\r\n        if (!file) {\r\n            return { success: false, error: \"缺少文件\" }\r\n        }\r\n\r\n        const fileType = file.type || \"application/octet-stream\"\r\n        const fileSize = file.size || 0\r\n\r\n        await ensureBucketExists()\r\n\r\n        // 1) 上传到已有文档（占位文书/历史文档的新版本）\r\n        if (documentId) {\r\n            const existing = await prisma.document.findUnique({\r\n                where: { id: documentId },\r\n                select: { id: true, caseId: true, title: true, version: true, fileUrl: true },\r\n            })\r\n            if (!existing) {\r\n                return { success: false, error: \"文档不存在\" }\r\n            }\r\n\r\n            await requireCaseAccess(existing.caseId, user.id, user.role, \"case:view\")\r\n\r\n            const isFirstUpload = !existing.fileUrl\r\n            const nextVersion = isFirstUpload ? 1 : existing.version + 1\r\n            const title = titleInput || existing.title\r\n\r\n            const key = buildObjectKey({\r\n                caseId: existing.caseId,\r\n                documentId: existing.id,\r\n                version: nextVersion,\r\n                filename: file.name || title,\r\n            })\r\n\r\n            await s3Client.send(\r\n                new PutObjectCommand({\r\n                    Bucket: BUCKET_NAME,\r\n                    Key: key,\r\n                    Body: Buffer.from(await file.arrayBuffer()),\r\n                    ContentType: fileType,\r\n                })\r\n            )\r\n\r\n            await prisma.$transaction(async tx => {\r\n                await tx.documentVersion.create({\r\n                    data: {\r\n                        documentId: existing.id,\r\n                        version: nextVersion,\r\n                        fileKey: key,\r\n                        fileType,\r\n                        fileSize,\r\n                        uploaderId: user.id,\r\n                    },\r\n                })\r\n\r\n                await tx.document.update({\r\n                    where: { id: existing.id },\r\n                    data: {\r\n                        title: titleInput || undefined,\r\n                        category: category || undefined,\r\n                        notes: notes || undefined,\r\n                        fileUrl: key,\r\n                        fileType,\r\n                        fileSize,\r\n                        version: nextVersion,\r\n                        uploaderId: user.id,\r\n                    },\r\n                })\r\n            })\r\n\r\n            revalidatePath(\"/documents\")\r\n            revalidatePath(`/documents/${existing.id}`)\r\n            revalidatePath(`/cases/${existing.caseId}`)\r\n\r\n            return { success: true, documentId: existing.id }\r\n        }\r\n\r\n        // 2) 新建文档（必须选择关联案件）\r\n        if (!caseId) {\r\n            return { success: false, error: \"必须选择关联案件\" }\r\n        }\r\n        await requireCaseAccess(caseId, user.id, user.role, \"case:view\")\r\n\r\n        const title = titleInput || file.name || \"未命名文档\"\r\n        const newDocumentId = randomUUID()\r\n        const version = 1\r\n\r\n        const key = buildObjectKey({\r\n            caseId,\r\n            documentId: newDocumentId,\r\n            version,\r\n            filename: file.name || title,\r\n        })\r\n\r\n        await s3Client.send(\r\n            new PutObjectCommand({\r\n                Bucket: BUCKET_NAME,\r\n                Key: key,\r\n                Body: Buffer.from(await file.arrayBuffer()),\r\n                ContentType: fileType,\r\n            })\r\n        )\r\n\r\n        const document = await prisma.document.create({\r\n            data: {\r\n                id: newDocumentId,\r\n                title,\r\n                fileUrl: key,\r\n                fileType,\r\n                fileSize,\r\n                caseId,\r\n                category: category || undefined,\r\n                tags: [],\r\n                notes: notes || undefined,\r\n                uploaderId: user.id,\r\n                version,\r\n            },\r\n        })\r\n\r\n        await prisma.documentVersion.create({\r\n            data: {\r\n                documentId: document.id,\r\n                version,\r\n                fileKey: key,\r\n                fileType,\r\n                fileSize,\r\n                uploaderId: user.id,\r\n            },\r\n        })\r\n\r\n        revalidatePath(\"/documents\")\r\n        revalidatePath(`/documents/${document.id}`)\r\n        revalidatePath(`/cases/${caseId}`)\r\n\r\n        return { success: true, document }\r\n    } catch (error) {\r\n        console.error(\"Upload Failed:\", error)\r\n        return { success: false, error: String(error) }\r\n    }\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"D:\\Desktop\\LawClick_NEW\\lawclick-next\\src\\actions\\event-actions.ts","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":173,"column":67,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":173,"endColumn":70,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[6486,6489],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[6486,6489],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":239,"column":67,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":239,"endColumn":70,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[9214,9217],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[9214,9217],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":2,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use server\"\n\nimport { prisma } from \"@/lib/prisma\"\nimport { revalidatePath } from \"next/cache\"\nimport type { Prisma, Role } from \"@prisma/client\"\nimport { EventType, EventVisibility, EventStatus, EventParticipantStatus } from \"@prisma/client\"\nimport { getSessionUserOrThrow, requirePermission, requireCaseAccess } from \"@/lib/server-auth\"\nimport { hasPermission } from \"@/lib/permissions\"\n\n// ==============================================================================\n// 日程 / 调度：统一真源 Actions（TG7）\n// ==============================================================================\n\ntype Viewer = { id: string; role: Role }\n\nfunction isViewerInEvent(viewer: Viewer, event: { creatorId: string; participants?: { userId: string }[] }) {\n    if (event.creatorId === viewer.id) return true\n    return (event.participants || []).some((p) => p.userId === viewer.id)\n}\n\nfunction canViewerSeeDetails(\n    viewer: Viewer,\n    event: { creatorId: string; visibility: EventVisibility; participants?: { userId: string }[] },\n    canAccessCase: boolean\n) {\n    if (isViewerInEvent(viewer, event)) return true\n\n    if (event.visibility === EventVisibility.TEAM_PUBLIC) return true\n    if (event.visibility === EventVisibility.CASE_TEAM) return canAccessCase\n\n    // PRIVATE / TEAM_BUSY：非参与人一律 Busy-only\n    return false\n}\n\nfunction maskEventForViewer<T extends { title: string; description?: string | null; location?: string | null }>(event: T) {\n    return {\n        ...event,\n        title: \"忙碌\",\n        description: null,\n        location: null,\n    }\n}\n\nasync function getAccessibleCaseIdSet(user: Viewer, caseIds: string[]) {\n    if (caseIds.length === 0) return new Set<string>()\n    if (!hasPermission(user.role, \"case:view\")) return new Set<string>()\n    if (user.role === \"PARTNER\" || user.role === \"ADMIN\") return new Set(caseIds)\n\n    const rows = await prisma.case.findMany({\n        where: {\n            id: { in: caseIds },\n            OR: [\n                { originatorId: user.id },\n                { handlerId: user.id },\n                { members: { some: { userId: user.id } } },\n            ],\n        },\n        select: { id: true },\n    })\n    return new Set(rows.map((r) => r.id))\n}\n\nexport type CalendarEventDTO = {\n    id: string\n    title: string\n    description: string | null\n    type: EventType\n    visibility: EventVisibility\n    status: EventStatus\n    startTime: string\n    endTime: string\n    location: string | null\n    case: { id: string; title: string; caseCode: string | null } | null\n    task: { id: string; title: string } | null\n    creator: { id: string; name: string | null } | null\n    participants: { userId: string; status: EventParticipantStatus; user: { id: string; name: string | null; avatarUrl: string | null } }[]\n    canViewDetails: boolean\n    canEdit: boolean\n}\n\nexport type CalendarEventOccurrenceDTO = {\n    userId: string\n    event: CalendarEventDTO\n}\n\nfunction toIso(date: Date) {\n    return date.toISOString()\n}\n\nfunction parseDateInput(value: string | Date) {\n    const date = value instanceof Date ? value : new Date(value)\n    if (Number.isNaN(date.getTime())) throw new Error(\"无效日期\")\n    return date\n}\n\nexport async function getEventOccurrencesInRange(input: {\n    from: string | Date\n    to: string | Date\n    userIds?: string[]\n    caseId?: string\n    includeCancelled?: boolean\n}) {\n    try {\n        const viewer = await getSessionUserOrThrow()\n        requirePermission(viewer.role, \"team:view\")\n\n        const from = parseDateInput(input.from)\n        const to = parseDateInput(input.to)\n        if (from >= to) return { success: false as const, error: \"时间范围不合法\", data: [] as CalendarEventOccurrenceDTO[] }\n\n        const rawUserIds = (input.userIds && input.userIds.length > 0 ? input.userIds : [viewer.id]).filter(Boolean)\n        const userIds = Array.from(new Set(rawUserIds)).slice(0, 300)\n\n        if (input.caseId) {\n            await requireCaseAccess(input.caseId, viewer.id, viewer.role, \"case:view\")\n        }\n\n        const where: Prisma.EventWhereInput = {\n            ...(input.caseId ? { caseId: input.caseId } : {}),\n            ...(input.includeCancelled ? {} : { status: EventStatus.SCHEDULED }),\n            AND: [{ startTime: { lt: to } }, { endTime: { gt: from } }],\n            OR: [\n                { creatorId: { in: userIds } },\n                { participants: { some: { userId: { in: userIds } } } },\n            ],\n        }\n\n        const events = await prisma.event.findMany({\n            where,\n            include: {\n                case: { select: { id: true, title: true, caseCode: true } },\n                task: { select: { id: true, title: true, caseId: true } },\n                creator: { select: { id: true, name: true } },\n                participants: {\n                    select: {\n                        userId: true,\n                        status: true,\n                        user: { select: { id: true, name: true, avatarUrl: true } },\n                    },\n                },\n            },\n            orderBy: { startTime: \"asc\" },\n        })\n\n        const caseIds = Array.from(new Set(events.map((e) => e.caseId).filter(Boolean))) as string[]\n        const accessibleCaseIds = await getAccessibleCaseIdSet(viewer, caseIds)\n\n        const occurrences: CalendarEventOccurrenceDTO[] = []\n\n        for (const e of events) {\n            const relatedUserIds = new Set<string>([\n                e.creatorId,\n                ...e.participants.filter((p) => p.status !== EventParticipantStatus.DECLINED).map((p) => p.userId),\n            ])\n            const canAccessCase = e.caseId ? accessibleCaseIds.has(e.caseId) : false\n            const canViewDetails = canViewerSeeDetails(viewer, e, canAccessCase)\n\n            const canEdit = e.creatorId === viewer.id\n\n            const base: CalendarEventDTO = {\n                id: e.id,\n                title: e.title,\n                description: e.description ?? null,\n                type: e.type,\n                visibility: e.visibility,\n                status: e.status,\n                startTime: toIso(e.startTime),\n                endTime: toIso(e.endTime),\n                location: e.location ?? null,\n                case: canAccessCase && e.case ? e.case : null,\n                task: canAccessCase && e.task ? { id: e.task.id, title: e.task.title } : null,\n                creator: e.creator ? { id: e.creator.id, name: e.creator.name ?? null } : null,\n                participants: canViewDetails ? (e.participants as any) : [],\n                canViewDetails,\n                canEdit,\n            }\n\n            const dto = canViewDetails ? base : { ...maskEventForViewer(base), case: null, task: null, creator: null, participants: [], canViewDetails: false, canEdit: false }\n\n            for (const userId of userIds) {\n                if (!relatedUserIds.has(userId)) continue\n                occurrences.push({ userId, event: dto })\n            }\n        }\n\n        return { success: true as const, data: occurrences }\n    } catch (error) {\n        console.error(\"获取日程范围失败:\", error)\n        return { success: false as const, error: \"获取日程失败\", data: [] as CalendarEventOccurrenceDTO[] }\n    }\n}\n\n// ==============================================================================\n// 获取单个日程\n// ==============================================================================\n\nexport async function getEventById(id: string) {\n    try {\n        const viewer = await getSessionUserOrThrow()\n        requirePermission(viewer.role, \"team:view\")\n\n        const event = await prisma.event.findUnique({\n            where: { id },\n            include: {\n                case: { select: { id: true, title: true, caseCode: true } },\n                task: { select: { id: true, title: true, caseId: true } },\n                creator: { select: { id: true, name: true } },\n                participants: {\n                    select: {\n                        userId: true,\n                        status: true,\n                        user: { select: { id: true, name: true, avatarUrl: true } },\n                    },\n                },\n            },\n        })\n\n        if (!event) {\n            return { success: false, error: '日程不存在' }\n        }\n\n        const accessibleCaseIds = await getAccessibleCaseIdSet(viewer, event.caseId ? [event.caseId] : [])\n        const canAccessCase = event.caseId ? accessibleCaseIds.has(event.caseId) : false\n        const canViewDetails = canViewerSeeDetails(viewer, event, canAccessCase)\n\n        const dto: CalendarEventDTO = {\n            id: event.id,\n            title: event.title,\n            description: event.description ?? null,\n            type: event.type,\n            visibility: event.visibility,\n            status: event.status,\n            startTime: toIso(event.startTime),\n            endTime: toIso(event.endTime),\n            location: event.location ?? null,\n            case: canAccessCase && event.case ? event.case : null,\n            task: canAccessCase && event.task ? { id: event.task.id, title: event.task.title } : null,\n            creator: event.creator ? { id: event.creator.id, name: event.creator.name ?? null } : null,\n            participants: canViewDetails ? (event.participants as any) : [],\n            canViewDetails,\n            canEdit: event.creatorId === viewer.id,\n        }\n\n        return { success: true, data: canViewDetails ? dto : { ...maskEventForViewer(dto), case: null, task: null, creator: null, participants: [], canViewDetails: false, canEdit: false } }\n    } catch (error) {\n        console.error('获取日程详情失败:', error)\n        return { success: false, error: '获取日程详情失败' }\n    }\n}\r\n\r\n// ==============================================================================\r\n// 创建日程\r\n// ==============================================================================\r\n\r\nexport async function createEvent(data: {\n    title: string\n    description?: string\n    type?: string\n    startTime: Date | string\n    endTime: Date | string\n    location?: string\n    caseId?: string\n    taskId?: string\n    visibility?: string\n    participantIds?: string[]\n}) {\n    try {\n        const user = await getSessionUserOrThrow()\n        requirePermission(user.role, \"team:view\")\n\n        const startTime = parseDateInput(data.startTime)\n        const endTime = parseDateInput(data.endTime)\n        if (startTime >= endTime) {\n            return { success: false as const, error: \"结束时间必须晚于开始时间\" }\n        }\n\n        let caseId = data.caseId || null\n        if (data.taskId) {\n            const task = await prisma.task.findUnique({ where: { id: data.taskId }, select: { id: true, caseId: true } })\n            if (!task) return { success: false as const, error: \"任务不存在\" }\n            await requireCaseAccess(task.caseId, user.id, user.role, \"case:view\")\n            caseId = caseId || task.caseId\n        }\n\n        if (caseId) {\n            await requireCaseAccess(caseId, user.id, user.role, \"case:view\")\n        }\n\n        const participantIds = Array.from(new Set((data.participantIds || []).filter(Boolean))).filter((id) => id !== user.id)\n        const visibility = (data.visibility as EventVisibility) || (caseId || data.taskId ? EventVisibility.CASE_TEAM : EventVisibility.TEAM_BUSY)\n\n        const event = await prisma.$transaction(async (tx) => {\n            const created = await tx.event.create({\n                data: {\n                    title: data.title,\n                    description: data.description,\n                    type: (data.type as EventType) || EventType.MEETING,\n                    visibility,\n                    status: EventStatus.SCHEDULED,\n                    startTime,\n                    endTime,\n                    location: data.location,\n                    caseId,\n                    taskId: data.taskId || null,\n                    creatorId: user.id,\n                },\n            })\n\n            await tx.eventParticipant.createMany({\n                data: [\n                    { eventId: created.id, userId: user.id, status: EventParticipantStatus.ACCEPTED },\n                    ...participantIds.map((id) => ({ eventId: created.id, userId: id, status: EventParticipantStatus.INVITED })),\n                ],\n                skipDuplicates: true,\n            })\n\n            if (participantIds.length > 0) {\n                await tx.collaborationInvite.createMany({\n                    data: participantIds.map((receiverId) => ({\n                        type: \"MEETING\",\n                        targetId: created.id,\n                        senderId: user.id,\n                        receiverId,\n                        message: `邀请您参加：${created.title}`,\n                    })),\n                })\n            }\n\n            return created\n        })\n\n        revalidatePath(\"/calendar\")\n        revalidatePath(\"/dispatch\")\n        return { success: true, data: event }\n    } catch (error) {\n        console.error('创建日程失败:', error)\n        return { success: false, error: '创建日程失败' }\n    }\n}\r\n\r\n// ==============================================================================\r\n// 更新日程\r\n// ==============================================================================\r\n\r\nexport async function updateEvent(id: string, data: {\n    title?: string\n    description?: string\n    type?: string\n    startTime?: Date | string\n    endTime?: Date | string\n    location?: string\n    caseId?: string\n    taskId?: string\n    visibility?: string\n    participantIds?: string[]\n}) {\n    try {\n        const user = await getSessionUserOrThrow()\n        requirePermission(user.role, \"team:view\")\n\n        const existing = await prisma.event.findUnique({\n            where: { id },\n            include: { participants: { select: { userId: true, status: true } } },\n        })\n        if (!existing) {\n            return { success: false, error: \"日程不存在\" }\n        }\n\n        const canEdit = existing.creatorId === user.id\n        if (!canEdit) {\n            return { success: false, error: \"只有创建者可以编辑日程\" }\n        }\n\n        let caseId = data.caseId ?? existing.caseId\n        if (data.taskId) {\n            const task = await prisma.task.findUnique({ where: { id: data.taskId }, select: { id: true, caseId: true } })\n            if (!task) return { success: false as const, error: \"任务不存在\" }\n            await requireCaseAccess(task.caseId, user.id, user.role, \"case:view\")\n            caseId = caseId || task.caseId\n        }\n        if (caseId) {\n            await requireCaseAccess(caseId, user.id, user.role, \"case:view\")\n        }\n\n        const nextStart = data.startTime ? parseDateInput(data.startTime) : existing.startTime\n        const nextEnd = data.endTime ? parseDateInput(data.endTime) : existing.endTime\n        if (nextStart >= nextEnd) return { success: false as const, error: \"结束时间必须晚于开始时间\" }\n\n        const participantIds = data.participantIds\n            ? Array.from(new Set(data.participantIds.filter(Boolean))).filter((pid) => pid !== user.id)\n            : null\n\n        const updated = await prisma.$transaction(async (tx) => {\n            const event = await tx.event.update({\n                where: { id },\n                data: {\n                    title: data.title,\n                    description: data.description,\n                    type: data.type ? (data.type as EventType) : undefined,\n                    startTime: data.startTime ? nextStart : undefined,\n                    endTime: data.endTime ? nextEnd : undefined,\n                    location: data.location,\n                    caseId,\n                    taskId: data.taskId ?? undefined,\n                    visibility: data.visibility ? (data.visibility as EventVisibility) : undefined,\n                },\n            })\n\n            if (participantIds) {\n                const existingIds = new Set(existing.participants.map((p) => p.userId))\n                const desiredIds = new Set([user.id, ...participantIds])\n\n                const toRemove = Array.from(existingIds).filter((pid) => pid !== user.id && !desiredIds.has(pid))\n                const toAdd = Array.from(desiredIds).filter((pid) => pid !== user.id && !existingIds.has(pid))\n\n                if (toRemove.length > 0) {\n                    await tx.eventParticipant.deleteMany({ where: { eventId: id, userId: { in: toRemove } } })\n                }\n\n                if (toAdd.length > 0) {\n                    await tx.eventParticipant.createMany({\n                        data: toAdd.map((pid) => ({ eventId: id, userId: pid, status: EventParticipantStatus.INVITED })),\n                        skipDuplicates: true,\n                    })\n\n                    await tx.collaborationInvite.createMany({\n                        data: toAdd.map((receiverId) => ({\n                            type: \"MEETING\",\n                            targetId: id,\n                            senderId: user.id,\n                            receiverId,\n                            message: `邀请您参加：${event.title}`,\n                        })),\n                    })\n                }\n            }\n\n            return event\n        })\n\n        revalidatePath('/calendar')\n        revalidatePath(\"/dispatch\")\n        return { success: true, data: updated }\n    } catch (error) {\n        console.error('更新日程失败:', error)\n        return { success: false, error: '更新日程失败' }\n    }\n}\n\n// ==============================================================================\n// 取消/删除日程（取消优先）\n// ==============================================================================\n\nexport async function cancelEvent(id: string) {\n    try {\n        const user = await getSessionUserOrThrow()\n        requirePermission(user.role, \"team:view\")\n\n        const existing = await prisma.event.findUnique({\n            where: { id },\n            select: { creatorId: true, caseId: true },\n        })\n        if (!existing) return { success: false, error: \"日程不存在\" }\n        if (existing.creatorId !== user.id) return { success: false, error: \"只有创建者可以取消日程\" }\n        if (existing.caseId) {\n            await requireCaseAccess(existing.caseId, user.id, user.role, \"case:view\")\n        }\n\n        await prisma.event.update({ where: { id }, data: { status: EventStatus.CANCELLED } })\n\n        revalidatePath(\"/calendar\")\n        revalidatePath(\"/dispatch\")\n        return { success: true }\n    } catch (error) {\n        console.error(\"取消日程失败:\", error)\n        return { success: false, error: \"取消日程失败\" }\n    }\n}\n\nexport async function deleteEvent(id: string) {\n    try {\n        const user = await getSessionUserOrThrow()\n        requirePermission(user.role, \"team:view\")\n\n        const existing = await prisma.event.findUnique({\n            where: { id },\n            select: { caseId: true, creatorId: true },\n        })\n        if (!existing) {\n            return { success: false, error: \"日程不存在\" }\n        }\n        if (existing.creatorId !== user.id) {\n            return { success: false, error: \"只有创建者可以删除日程\" }\n        }\n        if (existing.caseId) {\n            await requireCaseAccess(existing.caseId, user.id, user.role, \"case:view\")\n        }\n\n        await prisma.event.delete({ where: { id } })\n\n        revalidatePath('/calendar')\n        revalidatePath(\"/dispatch\")\n        return { success: true }\n    } catch (error) {\n        console.error('删除日程失败:', error)\n        return { success: false, error: '删除日程失败' }\n    }\n}\n\n// ==============================================================================\n// 可用时段计算（MVP）：工作时段交集 - 忙碌事件差集\n// ==============================================================================\n\ntype Slot = { startTime: string; endTime: string }\n\nfunction overlaps(aStart: Date, aEnd: Date, bStart: Date, bEnd: Date) {\n    return aStart < bEnd && bStart < aEnd\n}\n\nfunction addMinutes(date: Date, minutes: number) {\n    return new Date(date.getTime() + minutes * 60_000)\n}\n\nexport async function getAvailableSlots(input: {\n    userIds: string[]\n    from: string | Date\n    to: string | Date\n    durationMinutes: number\n    slotIntervalMinutes?: number\n}) {\n    try {\n        const viewer = await getSessionUserOrThrow()\n        requirePermission(viewer.role, \"team:view\")\n\n        const from = parseDateInput(input.from)\n        const to = parseDateInput(input.to)\n        if (from >= to) return { success: false as const, error: \"时间范围不合法\", data: [] as { date: string; slots: Slot[] }[] }\n\n        const durationMinutes = Math.max(1, Math.min(8 * 60, Math.floor(input.durationMinutes)))\n        const slotIntervalMinutes = Math.max(5, Math.min(120, Math.floor(input.slotIntervalMinutes ?? 30)))\n\n        const userIds = Array.from(new Set((input.userIds || []).filter(Boolean))).slice(0, 30)\n        if (userIds.length === 0) return { success: false as const, error: \"请选择参与人\", data: [] as { date: string; slots: Slot[] }[] }\n\n        // 1) 获取/初始化默认排班（仅用于计算；未做完整 UI 管理）\n        const schedules = await prisma.schedule.findMany({\n            where: { userId: { in: userIds }, isDefault: true },\n            include: { rules: true },\n        })\n\n        const scheduleByUser = new Map<string, { timeZone: string; rules: { dayOfWeek: number; startMinute: number; endMinute: number }[] }>()\n        for (const s of schedules) {\n            scheduleByUser.set(s.userId, { timeZone: s.timeZone, rules: s.rules.map((r) => ({ dayOfWeek: r.dayOfWeek, startMinute: r.startMinute, endMinute: r.endMinute })) })\n        }\n\n        // 2) 查询忙碌区间：事件 + 外出\n        const [events, ooo] = await Promise.all([\n            prisma.event.findMany({\n                where: {\n                    status: EventStatus.SCHEDULED,\n                    AND: [{ startTime: { lt: to } }, { endTime: { gt: from } }],\n                    OR: [\n                        { creatorId: { in: userIds } },\n                        { participants: { some: { userId: { in: userIds } } } },\n                    ],\n                },\n                select: {\n                    id: true,\n                    creatorId: true,\n                    startTime: true,\n                    endTime: true,\n                    participants: { select: { userId: true, status: true } },\n                },\n            }),\n            prisma.outOfOffice.findMany({\n                where: {\n                    userId: { in: userIds },\n                    AND: [{ startTime: { lt: to } }, { endTime: { gt: from } }],\n                },\n                select: { userId: true, startTime: true, endTime: true },\n            }),\n        ])\n\n        const busyByUser = new Map<string, { startTime: Date; endTime: Date }[]>()\n        for (const uid of userIds) busyByUser.set(uid, [])\n\n        for (const e of events) {\n            const related = new Set<string>([\n                e.creatorId,\n                ...e.participants.filter((p) => p.status !== EventParticipantStatus.DECLINED).map((p) => p.userId),\n            ])\n            for (const uid of userIds) {\n                if (!related.has(uid)) continue\n                busyByUser.get(uid)!.push({ startTime: e.startTime, endTime: e.endTime })\n            }\n        }\n        for (const entry of ooo) {\n            busyByUser.get(entry.userId)?.push({ startTime: entry.startTime, endTime: entry.endTime })\n        }\n\n        // 3) 枚举槽位（MVP，适配 2-20 人约会/会议推荐）\n        const results: { date: string; slots: Slot[] }[] = []\n\n        const cursor = new Date(from)\n        cursor.setHours(0, 0, 0, 0)\n\n        while (cursor < to) {\n            const dayStart = new Date(cursor)\n            const dayEnd = new Date(cursor)\n            dayEnd.setHours(23, 59, 59, 999)\n\n            const slots: Slot[] = []\n\n            // 全员工作时段交集：先用“最保守默认”兜底（09:00-18:00）\n            const defaultWindows = [{ startMinute: 9 * 60, endMinute: 18 * 60 }]\n\n            const windowsByUser = userIds.map((uid) => {\n                const schedule = scheduleByUser.get(uid)\n                const rules = schedule?.rules?.filter((r) => r.dayOfWeek === dayStart.getDay()) ?? []\n                if (rules.length === 0) return defaultWindows\n                return rules.map((r) => ({ startMinute: r.startMinute, endMinute: r.endMinute }))\n            })\n\n            const dayFrom = from > dayStart ? from : dayStart\n            const dayTo = to < dayEnd ? to : dayEnd\n\n            // 以 30min 步长枚举候选起点\n            for (let minute = 0; minute <= 24 * 60 - durationMinutes; minute += slotIntervalMinutes) {\n                const start = new Date(dayStart)\n                start.setMinutes(minute, 0, 0)\n                const end = addMinutes(start, durationMinutes)\n\n                if (start < dayFrom || end > dayTo) continue\n\n                let ok = true\n\n                for (let i = 0; i < userIds.length && ok; i++) {\n                    const uid = userIds[i]\n                    const windows = windowsByUser[i]\n\n                    const withinWorking = windows.some((w) => {\n                        const ws = new Date(dayStart)\n                        ws.setMinutes(w.startMinute, 0, 0)\n                        const we = new Date(dayStart)\n                        we.setMinutes(w.endMinute, 0, 0)\n                        return start >= ws && end <= we\n                    })\n                    if (!withinWorking) {\n                        ok = false\n                        break\n                    }\n\n                    const busy = busyByUser.get(uid) || []\n                    if (busy.some((b) => overlaps(start, end, b.startTime, b.endTime))) {\n                        ok = false\n                        break\n                    }\n                }\n\n                if (ok) {\n                    slots.push({ startTime: toIso(start), endTime: toIso(end) })\n                }\n            }\n\n            if (slots.length > 0) {\n                results.push({ date: dayStart.toISOString().slice(0, 10), slots: slots.slice(0, 24) })\n            }\n\n            cursor.setDate(cursor.getDate() + 1)\n        }\n\n        return { success: true as const, data: results }\n    } catch (error) {\n        console.error(\"获取可用时段失败:\", error)\n        return { success: false as const, error: \"获取可用时段失败\", data: [] as { date: string; slots: Slot[] }[] }\n    }\n}\n","usedDeprecatedRules":[]},{"filePath":"D:\\Desktop\\LawClick_NEW\\lawclick-next\\src\\actions\\finance-actions.ts","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":22,"column":22,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":22,"endColumn":25,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[704,707],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[704,707],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":151,"column":27,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":151,"endColumn":30,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[4977,4980],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[4977,4980],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":278,"column":20,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":278,"endColumn":23,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[9225,9228],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[9225,9228],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":328,"column":22,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":328,"endColumn":25,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[10877,10880],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[10877,10880],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":4,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use server\"\n\nimport { prisma } from \"@/lib/prisma\"\nimport { revalidatePath } from \"next/cache\"\nimport { InvoiceStatus, PaymentMethod } from \"@prisma/client\"\nimport { getSessionUserOrThrow, requireCaseAccess, requirePermission } from \"@/lib/server-auth\"\n\n// ==============================================================================\n// 发票管理 Actions\n// ==============================================================================\n\r\n// 获取发票列表\r\nexport async function getInvoices(options?: {\n    caseId?: string\n    status?: InvoiceStatus\n    clientId?: string\n}) {\n    try {\n        const user = await getSessionUserOrThrow()\n        requirePermission(user.role, \"billing:view\")\n\n        const where: any = {}\n\n        if (options?.caseId) {\n            await requireCaseAccess(options.caseId, user.id, user.role, \"case:view\")\n            where.caseId = options.caseId\n        } else if (user.role !== \"PARTNER\" && user.role !== \"ADMIN\") {\n            where.case = {\n                OR: [\n                    { originatorId: user.id },\n                    { handlerId: user.id },\n                    { members: { some: { userId: user.id } } },\n                ],\n            }\n        }\n\n        if (options?.status) where.status = options.status\n        if (options?.clientId) where.clientId = options.clientId\n\n        const invoices = await prisma.invoice.findMany({\n            where,\n            include: {\n                case: { select: { id: true, title: true, caseCode: true } },\n                client: { select: { id: true, name: true } },\n                payments: { select: { id: true, amount: true, receivedAt: true } },\n            },\n            orderBy: { createdAt: 'desc' },\n        })\n\n        return { success: true, data: invoices }\n    } catch (error) {\n        console.error('获取发票列表失败:', error)\n        return { success: false, error: '获取发票列表失败', data: [] }\n    }\r\n}\r\n\r\n// 创建发票\r\nexport async function createInvoice(data: {\n    caseId?: string\n    clientId?: string\n    amount: number\n    tax?: number\n    description?: string\n    dueDate?: Date\n}) {\n    try {\n        const user = await getSessionUserOrThrow()\n        requirePermission(user.role, \"billing:create\")\n\n        const caseId = data.caseId || null\n        if (caseId) {\n            await requireCaseAccess(caseId, user.id, user.role, \"case:view\")\n        }\n\n        let clientId = data.clientId || null\n        if (!clientId && caseId) {\n            const row = await prisma.case.findUnique({ where: { id: caseId }, select: { clientId: true } })\n            clientId = row?.clientId || null\n        }\n\n        // 生成发票号：INV-YYYYMMDD-XXXX\n        const today = new Date()\n        const prefix = `INV-${today.getFullYear()}${String(today.getMonth() + 1).padStart(2, '0')}${String(today.getDate()).padStart(2, '0')}`\n        const count = await prisma.invoice.count({\n            where: { invoiceNo: { startsWith: prefix } }\n        })\n        const invoiceNo = `${prefix}-${String(count + 1).padStart(4, '0')}`\n\r\n        const tax = data.tax || 0\r\n        const totalAmount = data.amount + tax\r\n\r\n        const invoice = await prisma.invoice.create({\n            data: {\n                invoiceNo,\n                caseId,\n                clientId,\n                amount: data.amount,\n                tax,\n                totalAmount,\n                description: data.description,\n                dueDate: data.dueDate || null,\n                status: 'DRAFT',\n            },\n        })\n\n        revalidatePath('/admin/finance')\n        if (invoice.caseId) revalidatePath(`/cases/${invoice.caseId}`)\n        return { success: true, data: invoice }\n    } catch (error) {\n        console.error('创建发票失败:', error)\n        return { success: false, error: '创建发票失败' }\n    }\n}\n\r\n// 更新发票状态\r\nexport async function updateInvoiceStatus(id: string, status: InvoiceStatus) {\n    try {\n        const user = await getSessionUserOrThrow()\n        requirePermission(user.role, \"billing:edit\")\n\n        const existing = await prisma.invoice.findUnique({ where: { id }, select: { id: true, caseId: true } })\n        if (!existing) return { success: false, error: \"发票不存在\" }\n\n        if (existing.caseId) {\n            await requireCaseAccess(existing.caseId, user.id, user.role, \"case:view\")\n        }\n\n        const invoice = await prisma.invoice.update({\n            where: { id },\n            data: {\n                status,\n                issuedAt: status === 'PENDING' ? new Date() : undefined,\n            },\n        })\n\n        revalidatePath('/admin/finance')\n        if (invoice.caseId) revalidatePath(`/cases/${invoice.caseId}`)\n        return { success: true, data: invoice }\n    } catch (error) {\n        console.error('更新发票状态失败:', error)\n        return { success: false, error: '更新发票状态失败' }\n    }\r\n}\r\n\r\n// 获取发票统计\r\nexport async function getInvoiceStats() {\n    try {\n        const user = await getSessionUserOrThrow()\n        requirePermission(user.role, \"billing:view\")\n\n        const scopeWhere: any =\n            user.role === \"PARTNER\" || user.role === \"ADMIN\"\n                ? {}\n                : {\n                    case: {\n                        OR: [\n                            { originatorId: user.id },\n                            { handlerId: user.id },\n                            { members: { some: { userId: user.id } } },\n                        ],\n                    },\n                }\n\n        const [total, pending, paid, overdue] = await Promise.all([\n            prisma.invoice.aggregate({ where: scopeWhere, _sum: { totalAmount: true } }),\n            prisma.invoice.aggregate({\n                where: { ...scopeWhere, status: 'PENDING' },\n                _sum: { totalAmount: true },\n                _count: true,\n            }),\n            prisma.invoice.aggregate({\n                where: { ...scopeWhere, status: 'PAID' },\n                _sum: { totalAmount: true },\n                _count: true,\n            }),\n            prisma.invoice.aggregate({\n                where: { ...scopeWhere, status: 'OVERDUE' },\n                _sum: { totalAmount: true },\n                _count: true,\n            }),\n        ])\n\r\n        return {\r\n            success: true,\r\n            data: {\r\n                totalAmount: total._sum.totalAmount || 0,\r\n                pendingAmount: pending._sum.totalAmount || 0,\r\n                pendingCount: pending._count || 0,\r\n                paidAmount: paid._sum.totalAmount || 0,\r\n                paidCount: paid._count || 0,\r\n                overdueAmount: overdue._sum.totalAmount || 0,\r\n                overdueCount: overdue._count || 0,\r\n            },\r\n        }\r\n    } catch (error) {\r\n        console.error('获取发票统计失败:', error)\r\n        return { success: false, error: '获取发票统计失败' }\r\n    }\r\n}\r\n\r\n// ==============================================================================\r\n// 收款记录 Actions\r\n// ==============================================================================\r\n\r\n// 记录收款\r\nexport async function recordPayment(data: {\n    invoiceId: string\n    amount: number\n    method: PaymentMethod\n    receivedAt: Date\n    reference?: string\n    note?: string\n}) {\n    try {\n        const user = await getSessionUserOrThrow()\n        requirePermission(user.role, \"billing:edit\")\n\n        const invoice = await prisma.invoice.findUnique({\n            where: { id: data.invoiceId },\n            select: { id: true, caseId: true, totalAmount: true },\n        })\n        if (!invoice) return { success: false, error: \"发票不存在\" }\n\n        if (invoice.caseId) {\n            await requireCaseAccess(invoice.caseId, user.id, user.role, \"case:view\")\n        }\n\n        // 创建收款记录\n        const payment = await prisma.payment.create({\n            data: {\n                invoiceId: data.invoiceId,\n                amount: data.amount,\n                method: data.method,\n                receivedAt: data.receivedAt,\n                reference: data.reference,\n                note: data.note,\n                recorderId: user.id,\n            },\n        })\n\n        // 更新发票状态\n        const invoiceWithPayments = await prisma.invoice.findUnique({\n            where: { id: data.invoiceId },\n            include: { payments: true },\n        })\n\n        if (invoiceWithPayments) {\n            const totalPaid = invoiceWithPayments.payments.reduce((sum, p) => sum + Number(p.amount), 0)\n\n            let newStatus: InvoiceStatus = 'PENDING'\n            if (totalPaid >= Number(invoiceWithPayments.totalAmount)) {\n                newStatus = 'PAID'\n            } else if (totalPaid > 0) {\n                newStatus = 'PARTIAL'\n            }\n\n            await prisma.invoice.update({\n                where: { id: data.invoiceId },\n                data: { status: newStatus },\n            })\n        }\n\n        revalidatePath('/admin/finance')\n        if (invoice.caseId) revalidatePath(`/cases/${invoice.caseId}`)\n        return { success: true, data: payment }\n    } catch (error) {\n        console.error('记录收款失败:', error)\n        return { success: false, error: '记录收款失败' }\n    }\r\n}\r\n\r\n// 获取收款记录\r\nexport async function getPayments(invoiceId?: string) {\n    try {\n        const user = await getSessionUserOrThrow()\n        requirePermission(user.role, \"billing:view\")\n\n        let where: any = invoiceId ? { invoiceId } : {}\n\n        if (invoiceId) {\n            const invoice = await prisma.invoice.findUnique({ where: { id: invoiceId }, select: { caseId: true } })\n            if (invoice?.caseId) {\n                await requireCaseAccess(invoice.caseId, user.id, user.role, \"case:view\")\n            }\n        } else if (user.role !== \"PARTNER\" && user.role !== \"ADMIN\") {\n            where = {\n                invoice: {\n                    case: {\n                        OR: [\n                            { originatorId: user.id },\n                            { handlerId: user.id },\n                            { members: { some: { userId: user.id } } },\n                        ],\n                    },\n                },\n            }\n        }\n\n        const payments = await prisma.payment.findMany({\n            where,\n            include: {\n                invoice: { select: { invoiceNo: true, totalAmount: true } },\n            },\n            orderBy: { receivedAt: 'desc' },\n        })\n\r\n        return { success: true, data: payments }\r\n    } catch (error) {\r\n        console.error('获取收款记录失败:', error)\r\n        return { success: false, error: '获取收款记录失败', data: [] }\r\n    }\r\n}\r\n\r\n// ==============================================================================\r\n// 费用记录 Actions\r\n// ==============================================================================\r\n\r\n// 获取费用列表\r\nexport async function getExpenses(options?: {\n    caseId?: string\n    userId?: string\n    status?: string\n}) {\n    try {\n        const user = await getSessionUserOrThrow()\n        requirePermission(user.role, \"billing:view\")\n\n        const where: any = {}\n\n        if (options?.caseId) {\n            await requireCaseAccess(options.caseId, user.id, user.role, \"case:view\")\n            where.caseId = options.caseId\n        }\n\n        if (options?.userId) {\n            if (options.userId !== user.id && user.role !== \"PARTNER\" && user.role !== \"ADMIN\") {\n                requirePermission(user.role, \"user:view_all\")\n            }\n            where.userId = options.userId\n        } else if (!options?.caseId && user.role !== \"PARTNER\" && user.role !== \"ADMIN\") {\n            // 非管理员默认只看自己的费用\n            where.userId = user.id\n        }\n\n        if (options?.status) where.status = options.status\n\n        const expenses = await prisma.expense.findMany({\n            where,\n            include: {\r\n                case: { select: { id: true, title: true } },\r\n                user: { select: { id: true, name: true } },\r\n            },\r\n            orderBy: { expenseDate: 'desc' },\r\n        })\r\n\r\n        return { success: true, data: expenses }\r\n    } catch (error) {\r\n        console.error('获取费用列表失败:', error)\r\n        return { success: false, error: '获取费用列表失败', data: [] }\r\n    }\r\n}\r\n\r\n// 创建费用记录\r\nexport async function createExpense(data: {\n    caseId?: string\n    category: string\n    amount: number\n    description?: string\n    expenseDate: Date\n}) {\n    try {\n        const user = await getSessionUserOrThrow()\n        requirePermission(user.role, \"billing:create\")\n\n        const caseId = data.caseId || null\n        if (caseId) {\n            await requireCaseAccess(caseId, user.id, user.role, \"case:view\")\n        }\n\n        const expense = await prisma.expense.create({\n            data: {\n                caseId,\n                userId: user.id,\n                category: data.category,\n                amount: data.amount,\n                description: data.description,\n                expenseDate: data.expenseDate,\n                status: 'PENDING',\n            },\n        })\n\n        revalidatePath('/admin/finance')\n        if (expense.caseId) revalidatePath(`/cases/${expense.caseId}`)\n        return { success: true, data: expense }\n    } catch (error) {\n        console.error('创建费用记录失败:', error)\n        return { success: false, error: '创建费用记录失败' }\n    }\n}\n","usedDeprecatedRules":[]},{"filePath":"D:\\Desktop\\LawClick_NEW\\lawclick-next\\src\\actions\\members.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\Desktop\\LawClick_NEW\\lawclick-next\\src\\actions\\notification-actions.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\Desktop\\LawClick_NEW\\lawclick-next\\src\\actions\\party-actions.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\Desktop\\LawClick_NEW\\lawclick-next\\src\\actions\\register.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\Desktop\\LawClick_NEW\\lawclick-next\\src\\actions\\search-actions.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\Desktop\\LawClick_NEW\\lawclick-next\\src\\actions\\stage-management.ts","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'NON_LITIGATION_STAGE_CONFIGS' is defined but never used.","line":20,"column":5,"nodeType":null,"messageId":"unusedVar","endLine":20,"endColumn":33},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'getNextNonLitigationStage' is defined but never used.","line":23,"column":5,"nodeType":null,"messageId":"unusedVar","endLine":23,"endColumn":30},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'isLastNonLitigationStage' is defined but never used.","line":24,"column":5,"nodeType":null,"messageId":"unusedVar","endLine":24,"endColumn":29},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":248,"column":34,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":248,"endColumn":37,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[8600,8603],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[8600,8603],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":348,"column":30,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":348,"endColumn":33,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[11803,11806],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[11803,11806],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":5,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use server\"\r\n\r\nimport { prisma } from \"@/lib/prisma\"\r\nimport { revalidatePath } from \"next/cache\"\r\nimport { getSessionUserOrThrow, requireCaseAccess } from \"@/lib/server-auth\"\r\nimport {\r\n    LitigationStages,\r\n    LitigationStage,\r\n    LITIGATION_STAGE_ORDER,\r\n    LITIGATION_STAGE_CONFIGS,\r\n    getStageConfig,\r\n    getStageIndex,\r\n    getNextStage,\r\n    isLastStage\r\n} from \"@/lib/litigation-stages\"\r\nimport {\r\n    NonLitigationStages,\r\n    NonLitigationStage,\r\n    NON_LITIGATION_STAGE_ORDER,\r\n    NON_LITIGATION_STAGE_CONFIGS,\r\n    getNonLitigationStageConfig,\r\n    getNonLitigationStageIndex,\r\n    getNextNonLitigationStage,\r\n    isLastNonLitigationStage\r\n} from \"@/lib/non-litigation-stages\"\r\n\r\n// ==============================================================================\r\n// Types\r\n// ==============================================================================\r\n\r\nexport interface StageProgressInfo {\r\n    currentStage: string | null\r\n    stageIndex: number\r\n    totalStages: number\r\n    serviceType: 'LITIGATION' | 'NON_LITIGATION'\r\n    stages: Array<{\r\n        stage: string\r\n        name: string\r\n        description: string\r\n        icon: string\r\n        color: string\r\n        isCompleted: boolean\r\n        isCurrent: boolean\r\n        documentsTotal: number\r\n        documentsCompleted: number\r\n        tasksTotal: number\r\n        tasksCompleted: number\r\n    }>\r\n}\r\n\r\n// ==============================================================================\r\n// 获取案件阶段进度\r\n// ==============================================================================\r\n\r\nexport async function getCaseStageProgress(caseId: string): Promise<StageProgressInfo | null> {\r\n    try {\r\n        const user = await getSessionUserOrThrow()\r\n        await requireCaseAccess(caseId, user.id, user.role, \"case:view\")\r\n\r\n        const caseItem = await prisma.case.findUnique({\r\n            where: { id: caseId },\r\n            include: {\r\n                documents: {\r\n                    select: { id: true, stage: true, isCompleted: true }\r\n                },\r\n                tasks: {\r\n                    select: { id: true, stage: true, status: true }\r\n                }\r\n            }\r\n        })\r\n\r\n        if (!caseItem) return null\r\n\r\n        // 根据案件类型选择阶段配置\r\n        const isLitigation = caseItem.serviceType === 'LITIGATION' || caseItem.serviceType === 'ARBITRATION'\r\n\r\n        if (isLitigation) {\r\n            const currentStage = (caseItem.currentStage as LitigationStage) || LitigationStages.INTAKE_CONSULTATION\r\n            const currentIndex = getStageIndex(currentStage)\r\n\r\n            const stages = LITIGATION_STAGE_ORDER.map((stage, index) => {\r\n                const config = getStageConfig(stage)!\r\n                const stageDocuments = caseItem.documents.filter(d => d.stage === stage)\r\n                const stageTasks = caseItem.tasks.filter(t => t.stage === stage)\r\n\r\n                return {\r\n                    stage,\r\n                    name: config.name,\r\n                    description: config.description,\r\n                    icon: config.icon,\r\n                    color: config.color,\r\n                    isCompleted: index + 1 < currentIndex,\r\n                    isCurrent: stage === currentStage,\r\n                    documentsTotal: stageDocuments.length,\r\n                    documentsCompleted: stageDocuments.filter(d => d.isCompleted).length,\r\n                    tasksTotal: stageTasks.length,\r\n                    tasksCompleted: stageTasks.filter(t => t.status === 'DONE').length,\r\n                }\r\n            })\r\n\r\n            return {\r\n                currentStage,\r\n                stageIndex: currentIndex,\r\n                totalStages: LITIGATION_STAGE_ORDER.length,\r\n                serviceType: 'LITIGATION',\r\n                stages\r\n            }\r\n        } else {\r\n            // 非诉案件\r\n            const currentStage = (caseItem.currentStage as NonLitigationStage) || NonLitigationStages.DUE_DILIGENCE\r\n            const currentIndex = getNonLitigationStageIndex(currentStage)\r\n\r\n            const stages = NON_LITIGATION_STAGE_ORDER.map((stage, index) => {\r\n                const config = getNonLitigationStageConfig(stage)!\r\n                const stageDocuments = caseItem.documents.filter(d => d.stage === stage)\r\n                const stageTasks = caseItem.tasks.filter(t => t.stage === stage)\r\n\r\n                return {\r\n                    stage,\r\n                    name: config.name,\r\n                    description: config.description,\r\n                    icon: config.icon,\r\n                    color: config.color,\r\n                    isCompleted: index + 1 < currentIndex,\r\n                    isCurrent: stage === currentStage,\r\n                    documentsTotal: stageDocuments.length,\r\n                    documentsCompleted: stageDocuments.filter(d => d.isCompleted).length,\r\n                    tasksTotal: stageTasks.length,\r\n                    tasksCompleted: stageTasks.filter(t => t.status === 'DONE').length,\r\n                }\r\n            })\r\n\r\n            return {\r\n                currentStage,\r\n                stageIndex: currentIndex,\r\n                totalStages: NON_LITIGATION_STAGE_ORDER.length,\r\n                serviceType: 'NON_LITIGATION',\r\n                stages\r\n            }\r\n        }\r\n    } catch (error) {\r\n        console.error('获取阶段进度失败:', error)\r\n        return null\r\n    }\r\n}\r\n\r\n// ==============================================================================\r\n// 推进案件到下一阶段\r\n// ==============================================================================\r\n\r\nexport async function advanceCaseStage(caseId: string): Promise<{\r\n    success: boolean\r\n    newStage?: LitigationStage\r\n    error?: string\r\n}> {\r\n    try {\r\n        const user = await getSessionUserOrThrow()\r\n        await requireCaseAccess(caseId, user.id, user.role, \"case:edit\")\r\n\r\n        const caseItem = await prisma.case.findUnique({\r\n            where: { id: caseId }\r\n        })\r\n\r\n        if (!caseItem) {\r\n            return { success: false, error: '案件不存在' }\r\n        }\r\n\r\n        const currentStage = (caseItem.currentStage as LitigationStage) || LitigationStages.INTAKE_CONSULTATION\r\n\r\n        if (isLastStage(currentStage)) {\r\n            return { success: false, error: '已是最后阶段' }\r\n        }\r\n\r\n        const nextStage = getNextStage(currentStage)\r\n        if (!nextStage) {\r\n            return { success: false, error: '无法获取下一阶段' }\r\n        }\r\n\r\n        // 更新案件阶段\r\n        await prisma.case.update({\r\n            where: { id: caseId },\r\n            data: { currentStage: nextStage }\r\n        })\r\n\r\n        revalidatePath(`/cases/${caseId}`)\r\n\r\n        return { success: true, newStage: nextStage }\r\n    } catch (error) {\r\n        console.error('推进阶段失败:', error)\r\n        return { success: false, error: '推进阶段失败' }\r\n    }\r\n}\r\n\r\n// ==============================================================================\r\n// 获取指定阶段的文书清单\r\n// ==============================================================================\r\n\r\nexport async function getStageDocuments(caseId: string, stage?: string) {\r\n    try {\r\n        const user = await getSessionUserOrThrow()\r\n        await requireCaseAccess(caseId, user.id, user.role, \"case:view\")\r\n        const documents = await prisma.document.findMany({\r\n            where: {\r\n                caseId,\r\n                ...(stage ? { stage } : {})\r\n            },\r\n            orderBy: { createdAt: 'asc' }\r\n        })\r\n\r\n        return documents\r\n    } catch (error) {\r\n        console.error('获取阶段文书失败:', error)\r\n        return []\r\n    }\r\n}\r\n\r\n// ==============================================================================\r\n// 初始化阶段文书模板\r\n// ==============================================================================\r\n\r\nexport async function initializeStageDocuments(caseId: string): Promise<{\r\n    success: boolean\r\n    created: number\r\n    error?: string\r\n}> {\r\n    try {\r\n        const user = await getSessionUserOrThrow()\r\n        await requireCaseAccess(caseId, user.id, user.role, \"case:edit\")\r\n\r\n        const caseItem = await prisma.case.findUnique({\r\n            where: { id: caseId },\r\n            include: { documents: true }\r\n        })\r\n\r\n        if (!caseItem) {\r\n            return { success: false, created: 0, error: '案件不存在' }\r\n        }\r\n\r\n        // 只为诉讼类案件初始化\r\n        if (caseItem.serviceType !== 'LITIGATION') {\r\n            return { success: false, created: 0, error: '仅支持诉讼类案件' }\r\n        }\r\n\r\n        // 获取已创建的文书类型\r\n        const existingTypes = new Set(caseItem.documents.map(d => d.documentType))\r\n\r\n        // 为每个阶段创建必备文书占位\r\n        const documentsToCreate: any[] = []\r\n\r\n        for (const stageConfig of LITIGATION_STAGE_CONFIGS) {\r\n            for (const docConfig of stageConfig.documents) {\r\n                // 跳过已存在的文书类型\r\n                if (existingTypes.has(docConfig.type)) continue\r\n\r\n                documentsToCreate.push({\r\n                    caseId,\r\n                    title: docConfig.name,\r\n                    fileUrl: '', // 占位URL，等待上传\r\n                    fileType: 'pending',\r\n                    stage: stageConfig.stage,\r\n                    documentType: docConfig.type,\r\n                    isRequired: docConfig.isRequired,\r\n                    isCompleted: false,\r\n                })\r\n            }\r\n        }\r\n\r\n        if (documentsToCreate.length > 0) {\r\n            await prisma.document.createMany({\r\n                data: documentsToCreate\r\n            })\r\n        }\r\n\r\n        revalidatePath(`/cases/${caseId}`)\r\n\r\n        return { success: true, created: documentsToCreate.length }\r\n    } catch (error) {\r\n        console.error('初始化阶段文书失败:', error)\r\n        return { success: false, created: 0, error: '初始化失败' }\r\n    }\r\n}\r\n\r\n// ==============================================================================\r\n// 标记文书完成\r\n// ==============================================================================\r\n\r\nexport async function completeDocument(documentId: string, isCompleted: boolean): Promise<{\r\n    success: boolean\r\n    error?: string\r\n}> {\r\n    try {\r\n        const user = await getSessionUserOrThrow()\r\n\r\n        const existing = await prisma.document.findUnique({\r\n            where: { id: documentId },\r\n            select: { caseId: true },\r\n        })\r\n        if (!existing) {\r\n            return { success: false, error: \"文书不存在\" }\r\n        }\r\n        await requireCaseAccess(existing.caseId, user.id, user.role, \"case:edit\")\r\n\r\n        const document = await prisma.document.update({\r\n            where: { id: documentId },\r\n            data: { isCompleted }\r\n        })\r\n\r\n        revalidatePath(`/cases/${document.caseId}`)\r\n\r\n        return { success: true }\r\n    } catch (error) {\r\n        console.error('更新文书状态失败:', error)\r\n        return { success: false, error: '更新失败' }\r\n    }\r\n}\r\n\r\n// ==============================================================================\r\n// 初始化阶段默认任务\r\n// ==============================================================================\r\n\r\nexport async function initializeStageTasks(caseId: string): Promise<{\r\n    success: boolean\r\n    created: number\r\n    error?: string\r\n}> {\r\n    try {\r\n        const user = await getSessionUserOrThrow()\r\n        await requireCaseAccess(caseId, user.id, user.role, \"case:edit\")\r\n\r\n        const caseItem = await prisma.case.findUnique({\r\n            where: { id: caseId },\r\n            include: { tasks: true }\r\n        })\r\n\r\n        if (!caseItem) {\r\n            return { success: false, created: 0, error: '案件不存在' }\r\n        }\r\n\r\n        // 只为诉讼类案件初始化\r\n        if (caseItem.serviceType !== 'LITIGATION') {\r\n            return { success: false, created: 0, error: '仅支持诉讼类案件' }\r\n        }\r\n\r\n        // 获取已有任务标题\r\n        const existingTitles = new Set(caseItem.tasks.map(t => t.title))\r\n\r\n        // 为每个阶段创建默认任务\r\n        const tasksToCreate: any[] = []\r\n        let order = caseItem.tasks.length\r\n\r\n        for (const stageConfig of LITIGATION_STAGE_CONFIGS) {\r\n            for (const taskTitle of stageConfig.defaultTasks) {\r\n                // 跳过已存在的任务\r\n                if (existingTitles.has(taskTitle)) continue\r\n\r\n                tasksToCreate.push({\r\n                    caseId,\r\n                    title: taskTitle,\r\n                    stage: stageConfig.stage,\r\n                    status: 'TODO',\r\n                    priority: 'P2_MEDIUM',\r\n                    order: order++,\r\n                })\r\n            }\r\n        }\r\n\r\n        if (tasksToCreate.length > 0) {\r\n            await prisma.task.createMany({\r\n                data: tasksToCreate\r\n            })\r\n        }\r\n\r\n        revalidatePath(`/cases/${caseId}`)\r\n\r\n        return { success: true, created: tasksToCreate.length }\r\n    } catch (error) {\r\n        console.error('初始化阶段任务失败:', error)\r\n        return { success: false, created: 0, error: '初始化失败' }\r\n    }\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"D:\\Desktop\\LawClick_NEW\\lawclick-next\\src\\actions\\tasks-crud.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\Desktop\\LawClick_NEW\\lawclick-next\\src\\actions\\tasks.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\Desktop\\LawClick_NEW\\lawclick-next\\src\\actions\\team-directory.ts","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":20,"column":22,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":20,"endColumn":25,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[579,582],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[579,582],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use server\"\n\nimport { prisma } from \"@/lib/prisma\"\nimport { getSessionUserOrThrow, requirePermission } from \"@/lib/server-auth\"\n\nexport async function getTeamDirectory(options?: {\n    query?: string\n    take?: number\n    skip?: number\n    includeInactive?: boolean\n}) {\n    try {\n        const user = await getSessionUserOrThrow()\n        requirePermission(user.role, \"team:view\")\n\n        const take = Math.max(1, Math.min(200, options?.take ?? 50))\n        const skip = Math.max(0, options?.skip ?? 0)\n        const query = (options?.query || \"\").trim()\n\n        const where: any = {\n            ...(options?.includeInactive ? {} : { isActive: true }),\n        }\n\n        if (query) {\n            where.OR = [\n                { name: { contains: query } },\n                { email: { contains: query } },\n                { department: { contains: query } },\n                { title: { contains: query } },\n            ]\n        }\n\n        const [items, total] = await prisma.$transaction([\n            prisma.user.findMany({\n                where,\n                take,\n                skip,\n                orderBy: [{ isActive: \"desc\" }, { name: \"asc\" }],\n                select: {\n                    id: true,\n                    name: true,\n                    email: true,\n                    role: true,\n                    avatarUrl: true,\n                    department: true,\n                    title: true,\n                    status: true,\n                    statusMessage: true,\n                    lastActiveAt: true,\n                },\n            }),\n            prisma.user.count({ where }),\n        ])\n\n        return { success: true as const, data: items, total }\n    } catch (error) {\n        console.error(\"获取团队成员失败:\", error)\n        return { success: false as const, error: \"获取团队成员失败\", data: [], total: 0 }\n    }\n}\n\n","usedDeprecatedRules":[]},{"filePath":"D:\\Desktop\\LawClick_NEW\\lawclick-next\\src\\actions\\timeline-actions.ts","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":18,"column":31,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":18,"endColumn":34,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[605,608],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[605,608],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use server\"\r\n\r\nimport { prisma } from \"@/lib/prisma\"\r\nimport { getSessionUserOrThrow, requireCaseAccess } from \"@/lib/server-auth\"\r\n\r\n// ==============================================================================\r\n// 时间线事件类型\r\n// ==============================================================================\r\n\r\nexport interface TimelineEvent {\r\n    id: string\r\n    type: 'stage_change' | 'task_complete' | 'document_upload' | 'event' | 'timelog' | 'party_add'\r\n    title: string\r\n    description?: string\r\n    timestamp: Date\r\n    userId?: string\r\n    userName?: string\r\n    metadata?: Record<string, any>\r\n}\r\n\r\n// ==============================================================================\r\n// 获取案件时间线\r\n// ==============================================================================\r\n\r\nexport async function getCaseTimeline(caseId: string): Promise<{ success: boolean; data: TimelineEvent[]; error?: string }> {\r\n    try {\r\n        const user = await getSessionUserOrThrow()\r\n        await requireCaseAccess(caseId, user.id, user.role, \"case:view\")\r\n\r\n        const timeline: TimelineEvent[] = []\r\n\r\n        // 1. 获取案件事件\r\n        const events = await prisma.event.findMany({\r\n            where: { caseId },\r\n            include: { creator: true },\r\n            orderBy: { startTime: 'desc' },\r\n            take: 20\r\n        })\r\n\r\n        events.forEach(event => {\r\n            timeline.push({\r\n                id: `event-${event.id}`,\r\n                type: 'event',\r\n                title: event.title,\r\n                description: event.location || undefined,\r\n                timestamp: event.startTime,\r\n                userId: event.creatorId || undefined,\r\n                userName: event.creator?.name || undefined,\r\n                metadata: { type: event.type }\r\n            })\r\n        })\r\n\r\n        // 2. 获取已完成任务\r\n        const completedTasks = await prisma.task.findMany({\r\n            where: { caseId, status: 'DONE' },\r\n            include: { assignee: true },\r\n            orderBy: { updatedAt: 'desc' },\r\n            take: 20\r\n        })\r\n\r\n        completedTasks.forEach(task => {\r\n            timeline.push({\r\n                id: `task-${task.id}`,\r\n                type: 'task_complete',\r\n                title: `任务完成: ${task.title}`,\r\n                timestamp: task.updatedAt,\r\n                userId: task.assigneeId || undefined,\r\n                userName: task.assignee?.name || undefined\r\n            })\r\n        })\r\n\r\n        // 3. 获取文档上传记录\r\n        const documents = await prisma.document.findMany({\r\n            where: { caseId },\r\n            orderBy: { createdAt: 'desc' },\r\n            take: 20\r\n        })\r\n\r\n        documents.forEach(doc => {\r\n            timeline.push({\r\n                id: `doc-${doc.id}`,\r\n                type: 'document_upload',\r\n                title: `上传文档: ${doc.title}`,\r\n                timestamp: doc.createdAt,\r\n                metadata: { fileType: doc.fileType }\r\n            })\r\n        })\r\n\r\n        // 4. 获取工时记录\r\n        const timeLogs = await prisma.timeLog.findMany({\r\n            where: { caseId, status: 'COMPLETED' },\r\n            include: { user: true },\r\n            orderBy: { endTime: 'desc' },\r\n            take: 10\r\n        })\r\n\r\n        timeLogs.forEach(log => {\r\n            const hours = log.duration ? Math.round(log.duration / 3600 * 10) / 10 : 0\r\n            timeline.push({\r\n                id: `timelog-${log.id}`,\r\n                type: 'timelog',\r\n                title: `记录工时: ${hours}小时`,\r\n                description: log.description || undefined,\r\n                timestamp: log.endTime || log.startTime,\r\n                userId: log.userId,\r\n                userName: log.user?.name || undefined\r\n            })\r\n        })\r\n\r\n        // 5. 获取当事人添加记录\r\n        const parties = await prisma.party.findMany({\r\n            where: { caseId },\r\n            orderBy: { createdAt: 'desc' },\r\n            take: 10\r\n        })\r\n\r\n        parties.forEach(party => {\r\n            timeline.push({\r\n                id: `party-${party.id}`,\r\n                type: 'party_add',\r\n                title: `添加当事人: ${party.name}`,\r\n                timestamp: party.createdAt,\r\n                metadata: { type: party.type, relation: party.relation }\r\n            })\r\n        })\r\n\r\n        // 按时间排序\r\n        timeline.sort((a, b) => new Date(b.timestamp).getTime() - new Date(a.timestamp).getTime())\r\n\r\n        return { success: true, data: timeline.slice(0, 50) }\r\n    } catch (error) {\r\n        console.error('获取时间线失败:', error)\r\n        return { success: false, error: '获取时间线失败', data: [] }\r\n    }\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"D:\\Desktop\\LawClick_NEW\\lawclick-next\\src\\actions\\timelogs-crud.ts","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":389,"column":87,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":389,"endColumn":90,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[12261,12264],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[12261,12264],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":471,"column":38,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":471,"endColumn":41,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[14969,14972],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[14969,14972],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":756,"column":39,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":756,"endColumn":42,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[25503,25506],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[25503,25506],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'formatDuration' is defined but never used.","line":946,"column":10,"nodeType":null,"messageId":"unusedVar","endLine":946,"endColumn":24}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":4,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use server\"\r\n\r\nimport { prisma } from \"@/lib/prisma\"\r\nimport { revalidatePath } from \"next/cache\"\r\nimport { Prisma, TimeLogStatus } from \"@prisma/client\"\r\nimport { getSessionUserOrThrow, requirePermission, requireCaseAccess } from \"@/lib/server-auth\"\r\n\r\n// ==============================================================================\r\n// Types\r\n// ==============================================================================\r\n\r\nexport interface StartTimerInput {\r\n    caseId?: string\r\n    taskId?: string\r\n    description: string\r\n    isBillable?: boolean\r\n}\r\n\r\nexport interface TimeLogSummary {\r\n    totalSeconds: number\r\n    totalHours: number\r\n    billableSeconds: number\r\n    billableHours: number\r\n    count: number\r\n}\r\n\r\n// ==============================================================================\r\n// 开始计时\r\n// ==============================================================================\r\n\r\nexport async function startTimer(input: StartTimerInput): Promise<{\r\n    success: boolean\r\n    timeLogId?: string\r\n    error?: string\r\n}> {\r\n    try {\r\n        const user = await getSessionUserOrThrow()\r\n        requirePermission(user.role, \"case:view\")\r\n\r\n        let caseId = input.caseId\r\n        if (!caseId && input.taskId) {\r\n            const task = await prisma.task.findUnique({\r\n                where: { id: input.taskId },\r\n                select: { caseId: true },\r\n            })\r\n            if (!task) {\r\n                return { success: false, error: \"任务不存在\" }\r\n            }\r\n            caseId = task.caseId\r\n        }\r\n\r\n        if (caseId) {\r\n            await requireCaseAccess(caseId, user.id, user.role, \"case:view\")\r\n        }\r\n\r\n        if (!caseId) {\r\n            return { success: false, error: \"计时必须关联案件/任务\" }\r\n        }\r\n\r\n        // 检查是否有正在进行的计时\r\n        const activeTimer = await prisma.timeLog.findFirst({\r\n            where: {\r\n                userId: user.id,\r\n                status: { in: ['RUNNING', 'PAUSED'] }\r\n            }\r\n        })\r\n\r\n        if (activeTimer) {\r\n            return { success: false, error: '您有正在进行的计时，请先停止' }\r\n        }\r\n\r\n        const timeLog = await prisma.timeLog.create({\r\n            data: {\r\n                userId: user.id,\r\n                caseId,\r\n                taskId: input.taskId,\r\n                description: input.description,\r\n                isBillable: input.isBillable ?? true,\r\n                status: 'RUNNING',\r\n                startTime: new Date()\r\n            }\r\n        })\r\n\r\n        revalidatePath('/timelog')\r\n        revalidatePath('/time')\r\n        if (caseId) revalidatePath(`/cases/${caseId}`)\r\n\r\n        return { success: true, timeLogId: timeLog.id }\r\n    } catch (error) {\r\n        console.error('开始计时失败:', error)\r\n        return { success: false, error: '开始计时失败' }\r\n    }\r\n}\r\n\r\n// ==============================================================================\r\n// 停止计时\r\n// ==============================================================================\r\n\r\nexport async function stopTimer(timeLogId: string): Promise<{\r\n    success: boolean\r\n    duration?: number\r\n    error?: string\r\n}> {\r\n    try {\r\n        const user = await getSessionUserOrThrow()\r\n\r\n        const timeLog = await prisma.timeLog.findUnique({\r\n            where: { id: timeLogId }\r\n        })\r\n\r\n        if (!timeLog) {\r\n            return { success: false, error: '记录不存在' }\r\n        }\r\n\r\n        if (timeLog.userId !== user.id) {\r\n            return { success: false, error: '无权操作' }\r\n        }\r\n\r\n        if (timeLog.status !== 'RUNNING' && timeLog.status !== 'PAUSED') {\r\n            return { success: false, error: '计时已停止' }\r\n        }\r\n\r\n        const endTime = new Date()\r\n        const elapsed =\r\n            timeLog.status === \"RUNNING\"\r\n                ? Math.floor((endTime.getTime() - timeLog.startTime.getTime()) / 1000)\r\n                : 0\r\n        const duration = timeLog.duration + elapsed\r\n\r\n        const billingRate = timeLog.isBillable ? (timeLog.billingRate ?? user.hourlyRate) : null\r\n        const billingAmount = billingRate\r\n            ? billingRate.mul(new Prisma.Decimal(duration)).div(new Prisma.Decimal(3600))\r\n            : null\r\n\r\n        await prisma.timeLog.update({\r\n            where: { id: timeLogId },\r\n            data: {\r\n                endTime,\r\n                duration,\r\n                status: \"COMPLETED\",\r\n                billingRate,\r\n                billingAmount,\r\n            },\r\n        })\r\n\r\n        revalidatePath('/timelog')\r\n        revalidatePath('/time')\r\n        if (timeLog.caseId) revalidatePath(`/cases/${timeLog.caseId}`)\r\n\r\n        return { success: true, duration }\r\n    } catch (error) {\r\n        console.error('停止计时失败:', error)\r\n        return { success: false, error: '停止计时失败' }\r\n    }\r\n}\r\n\r\n// ==============================================================================\r\n// 暂停计时\r\n// ==============================================================================\r\n\r\nexport async function pauseTimer(timeLogId: string): Promise<{\r\n    success: boolean\r\n    error?: string\r\n}> {\r\n    try {\r\n        const user = await getSessionUserOrThrow()\r\n\r\n        const timeLog = await prisma.timeLog.findUnique({\r\n            where: { id: timeLogId }\r\n        })\r\n\r\n        if (!timeLog || timeLog.userId !== user.id) {\r\n            return { success: false, error: '无权操作' }\r\n        }\r\n\r\n        if (timeLog.status !== 'RUNNING') {\r\n            return { success: false, error: '计时未在进行中' }\r\n        }\r\n\r\n        // 计算已经过的时间\r\n        const now = new Date()\r\n        const elapsed = Math.floor((now.getTime() - timeLog.startTime.getTime()) / 1000)\r\n\r\n        await prisma.timeLog.update({\r\n            where: { id: timeLogId },\r\n            data: {\r\n                duration: timeLog.duration + elapsed,\r\n                status: 'PAUSED'\r\n            }\r\n        })\r\n\r\n        revalidatePath('/timelog')\r\n        revalidatePath('/time')\r\n\r\n        return { success: true }\r\n    } catch (error) {\r\n        console.error('暂停计时失败:', error)\r\n        return { success: false, error: '暂停计时失败' }\r\n    }\r\n}\r\n\r\n// ==============================================================================\r\n// 恢复计时\r\n// ==============================================================================\r\n\r\nexport async function resumeTimer(timeLogId: string): Promise<{\r\n    success: boolean\r\n    error?: string\r\n}> {\r\n    try {\r\n        const user = await getSessionUserOrThrow()\r\n\r\n        const timeLog = await prisma.timeLog.findUnique({\r\n            where: { id: timeLogId }\r\n        })\r\n\r\n        if (!timeLog || timeLog.userId !== user.id) {\r\n            return { success: false, error: '无权操作' }\r\n        }\r\n\r\n        if (timeLog.status !== 'PAUSED') {\r\n            return { success: false, error: '计时未暂停' }\r\n        }\r\n\r\n        await prisma.timeLog.update({\r\n            where: { id: timeLogId },\r\n            data: {\r\n                startTime: new Date(), // 重置开始时间\r\n                status: 'RUNNING'\r\n            }\r\n        })\r\n\r\n        revalidatePath('/timelog')\r\n        revalidatePath('/time')\r\n\r\n        return { success: true }\r\n    } catch (error) {\r\n        console.error('恢复计时失败:', error)\r\n        return { success: false, error: '恢复计时失败' }\r\n    }\r\n}\r\n\r\n// ==============================================================================\r\n// 获取当前用户正在进行的计时\r\n// ==============================================================================\r\n\r\nexport async function getActiveTimer() {\r\n    try {\r\n        const user = await getSessionUserOrThrow()\r\n\r\n        const timer = await prisma.timeLog.findFirst({\r\n            where: {\r\n                userId: user.id,\r\n                status: { in: ['RUNNING', 'PAUSED'] }\r\n            },\r\n            orderBy: { updatedAt: 'desc' },\r\n            include: {\r\n                case: {\r\n                    select: { id: true, title: true, caseCode: true }\r\n                },\r\n                task: {\r\n                    select: { id: true, title: true }\r\n                }\r\n            }\r\n        })\r\n\r\n        return timer\r\n    } catch (error) {\r\n        console.error('获取活动计时失败:', error)\r\n        return null\r\n    }\r\n}\r\n\r\n// ==============================================================================\r\n// 手动添加工时记录\r\n// ==============================================================================\r\n\r\nexport async function addManualTimeLog(input: {\r\n    caseId?: string\r\n    taskId?: string\r\n    description: string\r\n    startTime: string\r\n    endTime: string\r\n    isBillable?: boolean\r\n}): Promise<{ success: boolean; error?: string }> {\r\n    try {\r\n        const user = await getSessionUserOrThrow()\r\n        requirePermission(user.role, \"case:view\")\r\n\r\n        let caseId = input.caseId\r\n        if (!caseId && input.taskId) {\r\n            const task = await prisma.task.findUnique({\r\n                where: { id: input.taskId },\r\n                select: { caseId: true },\r\n            })\r\n            if (!task) {\r\n                return { success: false, error: \"任务不存在\" }\r\n            }\r\n            caseId = task.caseId\r\n        }\r\n\r\n        if (caseId) {\r\n            await requireCaseAccess(caseId, user.id, user.role, \"case:view\")\r\n        }\r\n\r\n        if (!caseId) {\r\n            return { success: false, error: \"工时记录必须关联案件/任务\" }\r\n        }\r\n\r\n        const startTime = new Date(input.startTime)\r\n        const endTime = new Date(input.endTime)\r\n        if (Number.isNaN(startTime.getTime()) || Number.isNaN(endTime.getTime())) {\r\n            return { success: false, error: \"无效的时间段\" }\r\n        }\r\n        if (endTime.getTime() <= startTime.getTime()) {\r\n            return { success: false, error: \"结束时间必须晚于开始时间\" }\r\n        }\r\n\r\n        const duration = Math.floor((endTime.getTime() - startTime.getTime()) / 1000)\r\n        const isBillable = input.isBillable ?? true\r\n        const billingRate = isBillable ? user.hourlyRate : null\r\n        const billingAmount = billingRate\r\n            ? billingRate.mul(new Prisma.Decimal(duration)).div(new Prisma.Decimal(3600))\r\n            : null\r\n\r\n        await prisma.timeLog.create({\r\n            data: {\r\n                userId: user.id,\r\n                caseId,\r\n                taskId: input.taskId,\r\n                description: input.description,\r\n                startTime,\r\n                endTime,\r\n                duration,\r\n                isBillable,\r\n                status: 'COMPLETED',\r\n                billingRate,\r\n                billingAmount,\r\n            }\r\n        })\r\n\r\n        revalidatePath('/timelog')\r\n        revalidatePath('/time')\r\n        if (caseId) revalidatePath(`/cases/${caseId}`)\r\n\r\n        return { success: true }\r\n    } catch (error) {\r\n        console.error('添加工时失败:', error)\r\n        return { success: false, error: '添加工时失败' }\r\n    }\r\n}\r\n\r\n// ==============================================================================\r\n// 获取案件工时汇总\r\n// ==============================================================================\r\n\r\nexport async function getCaseTimeSummary(caseId: string): Promise<TimeLogSummary> {\r\n    try {\r\n        const user = await getSessionUserOrThrow()\r\n        await requireCaseAccess(caseId, user.id, user.role, \"case:view\")\r\n        const logs = await prisma.timeLog.findMany({\r\n            where: {\r\n                caseId,\r\n                status: { in: ['COMPLETED', 'APPROVED', 'BILLED'] }\r\n            },\r\n            select: { duration: true, isBillable: true }\r\n        })\r\n\r\n        const totalSeconds = logs.reduce((sum, log) => sum + log.duration, 0)\r\n        const billableSeconds = logs.filter(l => l.isBillable).reduce((sum, log) => sum + log.duration, 0)\r\n\r\n        return {\r\n            totalSeconds,\r\n            totalHours: Math.round(totalSeconds / 36) / 100, // 保留2位小数\r\n            billableSeconds,\r\n            billableHours: Math.round(billableSeconds / 36) / 100,\r\n            count: logs.length\r\n        }\r\n    } catch (error) {\r\n        console.error('获取工时汇总失败:', error)\r\n        return { totalSeconds: 0, totalHours: 0, billableSeconds: 0, billableHours: 0, count: 0 }\r\n    }\r\n}\r\n\r\n// ==============================================================================\r\n// 获取用户今日工时\r\n// ==============================================================================\r\n\r\nexport async function getTodayTimeSummary(): Promise<TimeLogSummary & { runningTimer: any }> {\r\n    try {\r\n        const user = await getSessionUserOrThrow()\r\n\r\n        const today = new Date()\r\n        today.setHours(0, 0, 0, 0)\r\n\r\n        const logs = await prisma.timeLog.findMany({\r\n            where: {\r\n                userId: user.id,\r\n                startTime: { gte: today },\r\n                status: { in: ['COMPLETED', 'APPROVED', 'BILLED'] }\r\n            },\r\n            select: { duration: true, isBillable: true }\r\n        })\r\n\r\n        const runningTimer = await getActiveTimer()\r\n\r\n        const totalSeconds = logs.reduce((sum, log) => sum + log.duration, 0)\r\n        const billableSeconds = logs.filter(l => l.isBillable).reduce((sum, log) => sum + log.duration, 0)\r\n\r\n        return {\r\n            totalSeconds,\r\n            totalHours: Math.round(totalSeconds / 36) / 100,\r\n            billableSeconds,\r\n            billableHours: Math.round(billableSeconds / 36) / 100,\r\n            count: logs.length,\r\n            runningTimer\r\n        }\r\n    } catch (error) {\r\n        console.error('获取今日工时失败:', error)\r\n        return { totalSeconds: 0, totalHours: 0, billableSeconds: 0, billableHours: 0, count: 0, runningTimer: null }\r\n    }\r\n}\r\n\r\n// ==============================================================================\r\n// 获取案件工时列表\r\n// ==============================================================================\r\n\r\nexport async function getCaseTimeLogs(caseId: string) {\r\n    try {\r\n        const user = await getSessionUserOrThrow()\r\n        await requireCaseAccess(caseId, user.id, user.role, \"case:view\")\r\n        const logs = await prisma.timeLog.findMany({\r\n            where: { caseId },\r\n            orderBy: { startTime: 'desc' },\r\n            include: {\r\n                user: {\r\n                    select: { id: true, name: true, email: true }\r\n                },\r\n                task: {\r\n                    select: { id: true, title: true }\r\n                }\r\n            }\r\n        })\r\n\r\n        return logs\r\n    } catch (error) {\r\n        console.error('获取工时列表失败:', error)\r\n        return []\r\n    }\r\n}\r\n\r\n// ==============================================================================\r\n// 格式化时长\r\n// ==============================================================================\r\n\r\n// ==============================================================================\r\n// TG4: 工时列表 / 编辑 / 审批流\r\n// ==============================================================================\r\n\r\nexport interface GetMyTimeLogsInput {\r\n    from: string\r\n    to: string\r\n    status?: TimeLogStatus[]\r\n    caseId?: string\r\n    taskId?: string\r\n    take?: number\r\n}\r\n\r\nexport async function getMyTimeLogs(\r\n    input: GetMyTimeLogsInput\r\n): Promise<{ success: boolean; data: any[]; error?: string }> {\r\n    try {\r\n        const user = await getSessionUserOrThrow()\r\n        requirePermission(user.role, \"case:view\")\r\n\r\n        const from = new Date(input.from)\r\n        const to = new Date(input.to)\r\n        if (Number.isNaN(from.getTime()) || Number.isNaN(to.getTime())) {\r\n            return { success: false, error: \"无效的日期范围\", data: [] }\r\n        }\r\n\r\n        let caseId = input.caseId\r\n        const taskId = input.taskId\r\n\r\n        if (!caseId && taskId) {\r\n            const task = await prisma.task.findUnique({\r\n                where: { id: taskId },\r\n                select: { caseId: true },\r\n            })\r\n            if (!task) {\r\n                return { success: false, error: \"任务不存在\", data: [] }\r\n            }\r\n            caseId = task.caseId\r\n        }\r\n\r\n        if (caseId) {\r\n            await requireCaseAccess(caseId, user.id, user.role, \"case:view\")\r\n        }\r\n\r\n        const where: Prisma.TimeLogWhereInput = {\r\n            userId: user.id,\r\n            startTime: { gte: from, lt: to },\r\n        }\r\n\r\n        if (input.status?.length) {\r\n            where.status = { in: input.status }\r\n        }\r\n        if (caseId) where.caseId = caseId\r\n        if (taskId) where.taskId = taskId\r\n\r\n        const logs = await prisma.timeLog.findMany({\n            where,\n            orderBy: { startTime: \"desc\" },\n            take: input.take ?? 200,\n            include: {\n                case: { select: { id: true, title: true, caseCode: true } },\n                task: { select: { id: true, title: true } },\n            },\n        })\n\n        const safeLogs = logs.map((log) => ({\n            id: log.id,\n            description: log.description,\n            startTime: log.startTime,\n            endTime: log.endTime,\n            duration: log.duration,\n            status: log.status,\n            isBillable: log.isBillable,\n            userId: log.userId,\n            caseId: log.caseId,\n            taskId: log.taskId,\n            billingRate: log.billingRate ? Number(log.billingRate) : null,\n            billingAmount: log.billingAmount ? Number(log.billingAmount) : null,\n            case: log.case,\n            task: log.task,\n        }))\n\n        return { success: true, data: safeLogs }\n    } catch (error) {\n        console.error(\"获取工时记录失败:\", error)\n        return { success: false, error: \"获取工时记录失败\", data: [] }\n    }\n}\n\r\nexport async function getMyTimeSummary(input: {\r\n    from: string\r\n    to: string\r\n}): Promise<{ success: boolean; data: TimeLogSummary; error?: string }> {\r\n    try {\r\n        const user = await getSessionUserOrThrow()\r\n        requirePermission(user.role, \"case:view\")\r\n\r\n        const from = new Date(input.from)\r\n        const to = new Date(input.to)\r\n        if (Number.isNaN(from.getTime()) || Number.isNaN(to.getTime())) {\r\n            return {\r\n                success: false,\r\n                error: \"无效的日期范围\",\r\n                data: { totalSeconds: 0, totalHours: 0, billableSeconds: 0, billableHours: 0, count: 0 },\r\n            }\r\n        }\r\n\r\n        const logs = await prisma.timeLog.findMany({\r\n            where: {\r\n                userId: user.id,\r\n                startTime: { gte: from, lt: to },\r\n                status: { in: [\"COMPLETED\", \"APPROVED\", \"BILLED\"] },\r\n            },\r\n            select: { duration: true, isBillable: true },\r\n        })\r\n\r\n        const totalSeconds = logs.reduce((sum, log) => sum + log.duration, 0)\r\n        const billableSeconds = logs.filter((l) => l.isBillable).reduce((sum, log) => sum + log.duration, 0)\r\n\r\n        return {\r\n            success: true,\r\n            data: {\r\n                totalSeconds,\r\n                totalHours: Math.round(totalSeconds / 36) / 100,\r\n                billableSeconds,\r\n                billableHours: Math.round(billableSeconds / 36) / 100,\r\n                count: logs.length,\r\n            },\r\n        }\r\n    } catch (error) {\r\n        console.error(\"获取工时汇总失败:\", error)\r\n        return {\r\n            success: false,\r\n            error: \"获取工时汇总失败\",\r\n            data: { totalSeconds: 0, totalHours: 0, billableSeconds: 0, billableHours: 0, count: 0 },\r\n        }\r\n    }\r\n}\r\n\r\nexport interface UpdateTimeLogInput {\r\n    id: string\r\n    description?: string\r\n    isBillable?: boolean\r\n    startTime?: string\r\n    endTime?: string\r\n    caseId?: string | null\r\n    taskId?: string | null\r\n}\r\n\r\nexport async function updateTimeLog(input: UpdateTimeLogInput): Promise<{ success: boolean; error?: string }> {\r\n    try {\r\n        const user = await getSessionUserOrThrow()\r\n\r\n        const timeLog = await prisma.timeLog.findUnique({\r\n            where: { id: input.id },\r\n        })\r\n\r\n        if (!timeLog) return { success: false, error: \"工时记录不存在\" }\r\n        if (timeLog.userId !== user.id) return { success: false, error: \"无权操作\" }\r\n        if (timeLog.status === \"APPROVED\" || timeLog.status === \"BILLED\") {\r\n            return { success: false, error: \"已审批/已计费的工时不可修改\" }\r\n        }\r\n\r\n        const normalizeOptionalId = (value: string | null | undefined) => {\r\n            if (value === undefined) return undefined\r\n            if (value === null) return null\r\n            const trimmed = value.trim()\r\n            return trimmed ? trimmed : null\r\n        }\r\n\r\n        const requestedTaskId = normalizeOptionalId(input.taskId)\r\n        const requestedCaseId = normalizeOptionalId(input.caseId)\r\n\r\n        let nextTaskId: string | null = timeLog.taskId\r\n        let nextCaseId: string | null = timeLog.caseId\r\n\r\n        if (requestedTaskId !== undefined) {\r\n            if (requestedTaskId === null) {\r\n                nextTaskId = null\r\n            } else {\r\n                const task = await prisma.task.findUnique({\r\n                    where: { id: requestedTaskId },\r\n                    select: { caseId: true },\r\n                })\r\n                if (!task) return { success: false, error: \"任务不存在\" }\r\n                await requireCaseAccess(task.caseId, user.id, user.role, \"case:view\")\r\n                nextTaskId = requestedTaskId\r\n                nextCaseId = task.caseId\r\n            }\r\n        }\r\n\r\n        if (requestedCaseId !== undefined && (requestedTaskId === undefined || requestedTaskId === null)) {\r\n            if (requestedCaseId === null) {\r\n                nextCaseId = null\r\n            } else {\r\n                await requireCaseAccess(requestedCaseId, user.id, user.role, \"case:view\")\r\n                nextCaseId = requestedCaseId\r\n            }\r\n        }\r\n\r\n        if (!nextCaseId) {\r\n            return { success: false, error: \"工时必须关联案件/任务\" }\r\n        }\r\n\r\n        if ((input.startTime || input.endTime) && timeLog.status !== \"COMPLETED\") {\r\n            return { success: false, error: \"仅已完成的工时记录可修改时间段\" }\r\n        }\r\n\r\n        const data: Prisma.TimeLogUncheckedUpdateInput = {}\r\n\r\n        if (typeof input.description === \"string\") data.description = input.description\r\n        if (typeof input.isBillable === \"boolean\") data.isBillable = input.isBillable\r\n        if (requestedTaskId !== undefined) data.taskId = nextTaskId\r\n        if (requestedCaseId !== undefined || (requestedTaskId !== undefined && requestedTaskId !== null)) {\r\n            data.caseId = nextCaseId\r\n        }\r\n\r\n        let nextDuration = timeLog.duration\r\n        if (timeLog.status === \"COMPLETED\" && (input.startTime || input.endTime)) {\r\n            const startTime = input.startTime ? new Date(input.startTime) : timeLog.startTime\r\n            const endTime = input.endTime\r\n                ? new Date(input.endTime)\r\n                : timeLog.endTime\r\n                    ? new Date(timeLog.endTime)\r\n                    : null\r\n\r\n            if (!endTime || Number.isNaN(startTime.getTime()) || Number.isNaN(endTime.getTime())) {\r\n                return { success: false, error: \"无效的时间段\" }\r\n            }\r\n            if (endTime.getTime() <= startTime.getTime()) {\r\n                return { success: false, error: \"结束时间必须晚于开始时间\" }\r\n            }\r\n\r\n            nextDuration = Math.floor((endTime.getTime() - startTime.getTime()) / 1000)\r\n            data.startTime = startTime\r\n            data.endTime = endTime\r\n            data.duration = nextDuration\r\n        }\r\n\r\n        const nextIsBillable = typeof input.isBillable === \"boolean\" ? input.isBillable : timeLog.isBillable\r\n        if (timeLog.status === \"COMPLETED\" && (input.isBillable !== undefined || input.startTime || input.endTime)) {\r\n            const billingRate = nextIsBillable ? (timeLog.billingRate ?? user.hourlyRate) : null\r\n            const billingAmount = billingRate\r\n                ? billingRate.mul(new Prisma.Decimal(nextDuration)).div(new Prisma.Decimal(3600))\r\n                : null\r\n\r\n            data.billingRate = billingRate\r\n            data.billingAmount = billingAmount\r\n        }\r\n\r\n        const updated = await prisma.timeLog.update({\r\n            where: { id: input.id },\r\n            data,\r\n        })\r\n\r\n        revalidatePath(\"/timelog\")\r\n        revalidatePath(\"/time\")\r\n        if (timeLog.caseId) revalidatePath(`/cases/${timeLog.caseId}`)\r\n        if (updated.caseId && updated.caseId !== timeLog.caseId) revalidatePath(`/cases/${updated.caseId}`)\r\n\r\n        return { success: true }\r\n    } catch (error) {\r\n        console.error(\"更新工时记录失败:\", error)\r\n        return { success: false, error: \"更新工时记录失败\" }\r\n    }\r\n}\r\n\r\nexport async function deleteTimeLog(timeLogId: string): Promise<{ success: boolean; error?: string }> {\r\n    try {\r\n        const user = await getSessionUserOrThrow()\r\n\r\n        const timeLog = await prisma.timeLog.findUnique({\r\n            where: { id: timeLogId },\r\n            select: { id: true, userId: true, status: true, caseId: true },\r\n        })\r\n\r\n        if (!timeLog) return { success: false, error: \"工时记录不存在\" }\r\n        if (timeLog.userId !== user.id) return { success: false, error: \"无权操作\" }\r\n        if (timeLog.status === \"APPROVED\" || timeLog.status === \"BILLED\") {\r\n            return { success: false, error: \"已审批/已计费的工时不可删除\" }\r\n        }\r\n\r\n        await prisma.timeLog.delete({ where: { id: timeLogId } })\r\n\r\n        revalidatePath(\"/timelog\")\r\n        revalidatePath(\"/time\")\r\n        if (timeLog.caseId) revalidatePath(`/cases/${timeLog.caseId}`)\r\n\r\n        return { success: true }\r\n    } catch (error) {\r\n        console.error(\"删除工时记录失败:\", error)\r\n        return { success: false, error: \"删除工时记录失败\" }\r\n    }\r\n}\r\n\r\nexport async function getTimeLogsPendingApproval(input?: {\r\n    from?: string\r\n    to?: string\r\n    take?: number\r\n    status?: TimeLogStatus[]\r\n}): Promise<{ success: boolean; data: any[]; error?: string }> {\r\n    try {\r\n        const user = await getSessionUserOrThrow()\r\n        requirePermission(user.role, \"timelog:approve\")\r\n\r\n        const statusFilter: TimeLogStatus[] =\r\n            input?.status && input.status.length ? input.status : [\"COMPLETED\"]\r\n\r\n        const where: Prisma.TimeLogWhereInput = {\r\n            status: { in: statusFilter },\r\n        }\r\n\r\n        const from = input?.from ? new Date(input.from) : null\r\n        const to = input?.to ? new Date(input.to) : null\r\n        if (from && to && !Number.isNaN(from.getTime()) && !Number.isNaN(to.getTime())) {\r\n            where.startTime = { gte: from, lt: to }\r\n        }\r\n\r\n        if (user.role !== \"PARTNER\" && user.role !== \"ADMIN\") {\r\n            where.caseId = { not: null }\r\n            where.case = {\r\n                OR: [\r\n                    { originatorId: user.id },\r\n                    { handlerId: user.id },\r\n                    { members: { some: { userId: user.id } } },\r\n                ],\r\n            }\r\n        }\r\n\r\n        const logs = await prisma.timeLog.findMany({\n            where,\n            orderBy: { startTime: \"desc\" },\n            take: input?.take ?? 100,\n            include: {\n                user: { select: { id: true, name: true, email: true } },\n                case: { select: { id: true, title: true, caseCode: true } },\n                task: { select: { id: true, title: true } },\n            },\n        })\n\n        const safeLogs = logs.map((log) => ({\n            ...log,\n            billingRate: log.billingRate ? Number(log.billingRate) : null,\n            billingAmount: log.billingAmount ? Number(log.billingAmount) : null,\n        }))\n\n        return { success: true, data: safeLogs }\n    } catch (error) {\n        console.error(\"获取待审批工时失败:\", error)\n        return { success: false, error: \"获取待审批工时失败\", data: [] }\n    }\n}\n\r\nexport async function approveTimeLog(timeLogId: string): Promise<{ success: boolean; error?: string }> {\r\n    try {\r\n        const user = await getSessionUserOrThrow()\r\n        requirePermission(user.role, \"timelog:approve\")\r\n\r\n        const timeLog = await prisma.timeLog.findUnique({\r\n            where: { id: timeLogId },\r\n            include: { user: { select: { hourlyRate: true } } },\r\n        })\r\n\r\n        if (!timeLog) return { success: false, error: \"工时记录不存在\" }\r\n        if (timeLog.status !== \"COMPLETED\") return { success: false, error: \"仅已完成的工时记录可审批\" }\r\n        if (timeLog.caseId) {\r\n            await requireCaseAccess(timeLog.caseId, user.id, user.role, \"case:view\")\r\n        }\r\n\r\n        const billingRate = timeLog.isBillable ? (timeLog.billingRate ?? timeLog.user.hourlyRate) : null\r\n        const billingAmount = billingRate\r\n            ? billingRate.mul(new Prisma.Decimal(timeLog.duration)).div(new Prisma.Decimal(3600))\r\n            : null\r\n\r\n        await prisma.timeLog.update({\r\n            where: { id: timeLogId },\r\n            data: {\r\n                status: \"APPROVED\",\r\n                billingRate,\r\n                billingAmount,\r\n            },\r\n        })\r\n\r\n        revalidatePath(\"/timelog\")\r\n        revalidatePath(\"/time\")\r\n        if (timeLog.caseId) revalidatePath(`/cases/${timeLog.caseId}`)\r\n\r\n        return { success: true }\r\n    } catch (error) {\r\n        console.error(\"审批工时失败:\", error)\r\n        return { success: false, error: \"审批工时失败\" }\r\n    }\r\n}\r\n\r\nexport async function unapproveTimeLog(timeLogId: string): Promise<{ success: boolean; error?: string }> {\r\n    try {\r\n        const user = await getSessionUserOrThrow()\r\n        requirePermission(user.role, \"timelog:approve\")\r\n\r\n        const timeLog = await prisma.timeLog.findUnique({\r\n            where: { id: timeLogId },\r\n            select: { id: true, status: true, caseId: true },\r\n        })\r\n\r\n        if (!timeLog) return { success: false, error: \"工时记录不存在\" }\r\n        if (timeLog.status !== \"APPROVED\") return { success: false, error: \"仅已审批的工时记录可撤销\" }\r\n        if (timeLog.caseId) {\r\n            await requireCaseAccess(timeLog.caseId, user.id, user.role, \"case:view\")\r\n        }\r\n\r\n        await prisma.timeLog.update({\r\n            where: { id: timeLogId },\r\n            data: { status: \"COMPLETED\" },\r\n        })\r\n\r\n        revalidatePath(\"/timelog\")\r\n        revalidatePath(\"/time\")\r\n        if (timeLog.caseId) revalidatePath(`/cases/${timeLog.caseId}`)\r\n\r\n        return { success: true }\r\n    } catch (error) {\r\n        console.error(\"撤销审批失败:\", error)\r\n        return { success: false, error: \"撤销审批失败\" }\r\n    }\r\n}\r\n\r\nexport async function markTimeLogBilled(timeLogId: string): Promise<{ success: boolean; error?: string }> {\r\n    try {\r\n        const user = await getSessionUserOrThrow()\r\n        requirePermission(user.role, \"timelog:approve\")\r\n\r\n        const timeLog = await prisma.timeLog.findUnique({\r\n            where: { id: timeLogId },\r\n            select: { id: true, status: true, caseId: true },\r\n        })\r\n\r\n        if (!timeLog) return { success: false, error: \"工时记录不存在\" }\r\n        if (timeLog.status !== \"APPROVED\") return { success: false, error: \"仅已审批的工时记录可计费\" }\r\n        if (timeLog.caseId) {\r\n            await requireCaseAccess(timeLog.caseId, user.id, user.role, \"case:view\")\r\n        }\r\n\r\n        await prisma.timeLog.update({\r\n            where: { id: timeLogId },\r\n            data: { status: \"BILLED\" },\r\n        })\r\n\r\n        revalidatePath(\"/timelog\")\r\n        revalidatePath(\"/time\")\r\n        if (timeLog.caseId) revalidatePath(`/cases/${timeLog.caseId}`)\r\n\r\n        return { success: true }\r\n    } catch (error) {\r\n        console.error(\"标记计费失败:\", error)\r\n        return { success: false, error: \"标记计费失败\" }\r\n    }\r\n}\r\n\r\nexport async function unmarkTimeLogBilled(timeLogId: string): Promise<{ success: boolean; error?: string }> {\r\n    try {\r\n        const user = await getSessionUserOrThrow()\r\n        requirePermission(user.role, \"timelog:approve\")\r\n\r\n        const timeLog = await prisma.timeLog.findUnique({\r\n            where: { id: timeLogId },\r\n            select: { id: true, status: true, caseId: true },\r\n        })\r\n\r\n        if (!timeLog) return { success: false, error: \"工时记录不存在\" }\r\n        if (timeLog.status !== \"BILLED\") return { success: false, error: \"仅已计费的工时记录可撤销\" }\r\n        if (timeLog.caseId) {\r\n            await requireCaseAccess(timeLog.caseId, user.id, user.role, \"case:view\")\r\n        }\r\n\r\n        await prisma.timeLog.update({\r\n            where: { id: timeLogId },\r\n            data: { status: \"APPROVED\" },\r\n        })\r\n\r\n        revalidatePath(\"/timelog\")\r\n        revalidatePath(\"/time\")\r\n        if (timeLog.caseId) revalidatePath(`/cases/${timeLog.caseId}`)\r\n\r\n        return { success: true }\r\n    } catch (error) {\r\n        console.error(\"撤销计费失败:\", error)\r\n        return { success: false, error: \"撤销计费失败\" }\r\n    }\r\n}\r\n\r\nfunction formatDuration(seconds: number): string {\r\n    const hours = Math.floor(seconds / 3600)\r\n    const minutes = Math.floor((seconds % 3600) / 60)\r\n    const secs = seconds % 60\r\n\r\n    if (hours > 0) {\r\n        return `${hours}h ${minutes}m`\r\n    }\r\n    if (minutes > 0) {\r\n        return `${minutes}m ${secs}s`\r\n    }\r\n    return `${secs}s`\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"D:\\Desktop\\LawClick_NEW\\lawclick-next\\src\\actions\\timelogs.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\Desktop\\LawClick_NEW\\lawclick-next\\src\\actions\\tool-actions.ts","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":130,"column":22,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":130,"endColumn":25,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[4212,4215],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[4212,4215],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":287,"column":35,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":287,"endColumn":38,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[8969,8972],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[8969,8972],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":298,"column":21,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":298,"endColumn":24,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[9279,9282],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[9279,9282],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":3,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use server\"\n\nimport { prisma } from \"@/lib/prisma\"\nimport { revalidatePath } from \"next/cache\"\nimport { getSessionUserOrThrow, requirePermission } from \"@/lib/server-auth\"\nimport { hasPermission } from \"@/lib/permissions\"\nimport type { Prisma } from \"@prisma/client\"\nimport { lookup } from \"dns/promises\"\nimport net from \"net\"\n\n// ==============================================================================\n// 工具模块管理 Actions\n// ==============================================================================\n\ntype ToolModuleCategory = string\n\nfunction parseAllowlist(): string[] {\n    const raw = (process.env.TOOL_WEBHOOK_ALLOWLIST || \"\").trim()\n    if (!raw) return []\n    return raw\n        .split(\",\")\n        .map((s) => s.trim().toLowerCase())\n        .filter(Boolean)\n}\n\nfunction normalizeHostname(hostname: string): string {\n    return hostname.trim().toLowerCase().replace(/\\.$/, \"\")\n}\n\nfunction isPrivateIPv4(ip: string): boolean {\n    const parts = ip.split(\".\").map((x) => Number.parseInt(x, 10))\n    if (parts.length !== 4 || parts.some((n) => Number.isNaN(n))) return true\n\n    const [a, b] = parts\n    if (a === 10) return true\n    if (a === 127) return true\n    if (a === 0) return true\n    if (a === 169 && b === 254) return true\n    if (a === 192 && b === 168) return true\n    if (a === 172 && b >= 16 && b <= 31) return true\n    return false\n}\n\nfunction isPrivateIPv6(ip: string): boolean {\n    const lower = ip.toLowerCase()\n    if (lower === \"::1\") return true\n    if (lower.startsWith(\"fe80:\")) return true // link-local\n    if (lower.startsWith(\"fc\") || lower.startsWith(\"fd\")) return true // unique local (fc00::/7)\n    return false\n}\n\nasync function isHostSafe(hostname: string): Promise<{ ok: true } | { ok: false; reason: string }> {\n    const host = normalizeHostname(hostname)\n    if (!host) return { ok: false, reason: \"Webhook 地址缺少 hostname\" }\n    if (host === \"localhost\") return { ok: false, reason: \"禁止访问 localhost\" }\n\n    const ipType = net.isIP(host)\n    if (ipType === 4) {\n        if (isPrivateIPv4(host)) return { ok: false, reason: \"禁止访问私网/本机 IP\" }\n        return { ok: true }\n    }\n    if (ipType === 6) {\n        if (isPrivateIPv6(host)) return { ok: false, reason: \"禁止访问私网/本机 IP\" }\n        return { ok: true }\n    }\n\n    try {\n        const resolved = await lookup(host, { all: true })\n        for (const r of resolved) {\n            if (r.family === 4 && isPrivateIPv4(r.address)) {\n                return { ok: false, reason: \"Webhook 域名解析到私网/本机 IP\" }\n            }\n            if (r.family === 6 && isPrivateIPv6(r.address)) {\n                return { ok: false, reason: \"Webhook 域名解析到私网/本机 IP\" }\n            }\n        }\n        return { ok: true }\n    } catch {\n        return { ok: false, reason: \"Webhook 域名解析失败\" }\n    }\n}\n\nfunction isHostAllowedByAllowlist(hostname: string, allowlist: string[]): boolean {\n    const host = normalizeHostname(hostname)\n    if (allowlist.length === 0) return false\n\n    for (const entry of allowlist) {\n        const normalized = entry.replace(/^\\*\\./, \"\").replace(/^\\./, \"\")\n        if (!normalized) continue\n        if (host === normalized) return true\n        if (host.endsWith(\".\" + normalized)) return true\n    }\n    return false\n}\n\nasync function ensureWebhookUrlSafe(url: string): Promise<{ ok: true; url: URL } | { ok: false; error: string }> {\n    let parsed: URL\n    try {\n        parsed = new URL(url)\n    } catch {\n        return { ok: false, error: \"Webhook 地址格式不正确\" }\n    }\n\n    if (parsed.protocol !== \"https:\") {\n        return { ok: false, error: \"Webhook 仅允许 https\" }\n    }\n\n    const allowlist = parseAllowlist()\n    if (!isHostAllowedByAllowlist(parsed.hostname, allowlist)) {\n        return { ok: false, error: \"Webhook 域名不在 allowlist 中\" }\n    }\n\n    const safe = await isHostSafe(parsed.hostname)\n    if (safe.ok === false) {\n        return { ok: false, error: safe.reason }\n    }\n\n    return { ok: true, url: parsed }\n}\n\n// 获取所有工具模块\nexport async function getToolModules(\n    category?: ToolModuleCategory,\n    options?: { includeInactive?: boolean }\n) {\n    try {\n        const user = await getSessionUserOrThrow()\n        const canManage = hasPermission(user.role, \"tools:manage\")\n\n        const where: any = {}\n        if (!options?.includeInactive || !canManage) {\n            where.isActive = true\n        }\n        if (category) where.category = category\n\n        const modules = await prisma.toolModule.findMany({\n            where,\n            orderBy: [{ sortOrder: 'asc' }, { name: 'asc' }],\n        })\n\n        return { success: true, data: modules }\n    } catch (error) {\n        console.error('获取工具模块失败:', error)\n        return { success: false, error: '获取工具模块失败', data: [] }\n    }\n}\n\n// 创建工具模块（管理员功能）\nexport async function createToolModule(data: {\n    name: string\n    description?: string\n    icon?: string\n    url?: string\n    webhookUrl?: string\n    category: string\n    isActive?: boolean\n    sortOrder?: number\n}) {\n    try {\n        const user = await getSessionUserOrThrow()\n        requirePermission(user.role, \"tools:manage\")\n\n        const toolModule = await prisma.toolModule.create({\n            data: {\n                name: data.name,\n                description: data.description,\n                icon: data.icon,\n                url: data.url,\n                webhookUrl: data.webhookUrl,\n                category: data.category,\n                isActive: typeof data.isActive === \"boolean\" ? data.isActive : true,\n                sortOrder: data.sortOrder || 0,\n            },\n        })\n\n        revalidatePath('/tools')\n        return { success: true, data: toolModule }\n    } catch (error) {\n        console.error('创建工具模块失败:', error)\n        return { success: false, error: '创建工具模块失败' }\n    }\n}\n\n// 更新工具模块\nexport async function updateToolModule(id: string, data: {\n    name?: string\n    description?: string | null\n    icon?: string | null\n    url?: string | null\n    webhookUrl?: string | null\n    category?: string\n    isActive?: boolean\n    sortOrder?: number\n}) {\n    try {\n        const user = await getSessionUserOrThrow()\n        requirePermission(user.role, \"tools:manage\")\n\n        const toolModule = await prisma.toolModule.update({\n            where: { id },\n            data,\n        })\n\n        revalidatePath('/tools')\n        return { success: true, data: toolModule }\n    } catch (error) {\n        console.error('更新工具模块失败:', error)\n        return { success: false, error: '更新工具模块失败' }\n    }\n}\n\n// 删除工具模块\nexport async function deleteToolModule(id: string) {\n    try {\n        const user = await getSessionUserOrThrow()\n        requirePermission(user.role, \"tools:manage\")\n\n        await prisma.toolModule.delete({ where: { id } })\n\n        revalidatePath('/tools')\n        return { success: true }\n    } catch (error) {\n        console.error('删除工具模块失败:', error)\n        return { success: false, error: '删除工具模块失败' }\n    }\n}\n\n// 调用外部模块Webhook（N8N接入）\nexport async function triggerModuleWebhook(moduleId: string, payload?: Prisma.InputJsonValue) {\n    const user = await getSessionUserOrThrow()\n    const toolModule = await prisma.toolModule.findUnique({ where: { id: moduleId } })\n\n    if (!toolModule || !toolModule.isActive) {\n        return { success: false, error: '模块不存在或已停用' }\n    }\n    if (!toolModule.webhookUrl) {\n        return { success: false, error: '该模块未配置 Webhook' }\n    }\n\n    const basePayload: Prisma.InputJsonObject = {\n        moduleId: toolModule.id,\n        moduleName: toolModule.name,\n        userId: user.id,\n        userEmail: user.email,\n        timestamp: new Date().toISOString(),\n        payload: payload ?? {},\n    }\n\n    const safe = await ensureWebhookUrlSafe(toolModule.webhookUrl)\n    if (safe.ok === false) {\n        await prisma.toolInvocation.create({\n            data: {\n                toolModuleId: toolModule.id,\n                userId: user.id,\n                payload: basePayload,\n                response: null,\n                status: \"ERROR\",\n                error: safe.error,\n            },\n        })\n        return { success: false, error: safe.error }\n    }\n\n    const controller = new AbortController()\n    const timeout = setTimeout(() => controller.abort(), 15_000)\n\n    try {\n        const response = await fetch(safe.url.toString(), {\n            method: 'POST',\n            headers: { 'Content-Type': 'application/json' },\n            body: JSON.stringify(basePayload),\n            signal: controller.signal,\n        })\n\n        const contentType = response.headers.get('content-type') || ''\n        const body = contentType.includes('application/json')\n            ? await response.json().catch(() => null)\n            : await response.text().catch(() => null)\n\n        const status: \"SUCCESS\" | \"ERROR\" = response.ok ? \"SUCCESS\" : \"ERROR\"\n\n        await prisma.toolInvocation.create({\n            data: {\n                toolModuleId: toolModule.id,\n                userId: user.id,\n                payload: basePayload,\n                response: body as any,\n                status,\n                error: response.ok ? null : `Webhook 返回 ${response.status}`,\n            },\n        })\n\n        if (!response.ok) {\n            return { success: false, error: 'Webhook 调用失败', data: body }\n        }\n\n        return { success: true, data: body }\n    } catch (error: any) {\n        const message =\n            error?.name === 'AbortError'\n                ? 'Webhook 调用超时'\n                : (error?.message || '触发Webhook失败')\n\n        await prisma.toolInvocation.create({\n            data: {\n                toolModuleId: toolModule.id,\n                userId: user.id,\n                payload: basePayload,\n                response: null,\n                status: \"ERROR\",\n                error: message,\n            },\n        })\n\n        console.error('触发Webhook失败:', error)\n        return { success: false, error: message }\n    } finally {\n        clearTimeout(timeout)\n    }\n}\n","usedDeprecatedRules":[]},{"filePath":"D:\\Desktop\\LawClick_NEW\\lawclick-next\\src\\app\\(auth)\\auth\\login\\page.tsx","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":39,"column":25,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":39,"endColumn":28,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1340,1343],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1340,1343],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\"\r\n\r\nimport { useState } from \"react\"\r\nimport { Button } from \"@/components/ui/button\"\r\nimport { Input } from \"@/components/ui/input\"\r\nimport { Label } from \"@/components/ui/label\"\r\nimport { GlassPanel } from \"@/components/ui/glass-panel\"\r\nimport { signIn } from \"next-auth/react\"\r\nimport { useRouter } from \"next/navigation\"\r\nimport { toast } from \"sonner\"\r\nimport Link from \"next/link\"\r\nimport { Gavel, Loader2 } from \"lucide-react\"\r\n\r\nexport default function LoginPage() {\n    const isDev = process.env.NODE_ENV === \"development\"\n    const [email, setEmail] = useState(isDev ? \"partner1@lawclick.com\" : \"\")\n    const [password, setPassword] = useState(isDev ? \"password123\" : \"\")\n    const [loading, setLoading] = useState(false)\n    const router = useRouter()\n\r\n    async function handleSubmit(e: React.FormEvent) {\r\n        e.preventDefault()\r\n        setLoading(true)\r\n\r\n        try {\r\n            const result = await signIn(\"credentials\", {\r\n                email,\r\n                password,\r\n                redirect: false,\r\n            })\r\n\r\n            if (result?.error) {\r\n                toast.error(\"登录失败\", { description: \"邮箱或密码错误\" })\r\n            } else {\r\n                toast.success(\"登录成功\")\r\n                router.push(\"/dashboard\")\r\n                router.refresh()\r\n            }\r\n        } catch (error: any) {\r\n            toast.error(\"登录出错: \" + error.message)\r\n        } finally {\r\n            setLoading(false)\r\n        }\r\n    }\r\n\r\n    return (\r\n        <div className=\"dark min-h-screen flex items-center justify-center bg-[radial-gradient(ellipse_at_top,_var(--tw-gradient-stops))] from-slate-900 via-[#0a0a0a] to-black p-4 text-foreground relative\">\r\n            <GlassPanel intensity=\"high\" className=\"w-full max-w-md p-8 border-white/10 shadow-2xl bg-black/40\">\r\n                <div className=\"flex flex-col items-center justify-center mb-8 space-y-2\">\r\n                    <div className=\"bg-primary/20 p-3 rounded-xl ring-1 ring-white/20\">\r\n                        <Gavel className=\"h-8 w-8 text-primary\" />\r\n                    </div>\r\n                    <div className=\"text-center\">\r\n                        <h1 className=\"text-2xl font-bold tracking-tight text-white\">欢迎回来</h1>\r\n                        <p className=\"text-sm text-muted-foreground mt-1\">登录您的 LawClick 工作台</p>\r\n                    </div>\r\n                </div>\r\n\r\n                <form onSubmit={handleSubmit} className=\"space-y-4\">\r\n                    <div className=\"space-y-2\">\r\n                        <Label htmlFor=\"email\" className=\"text-zinc-300\">邮箱</Label>\r\n                        <Input\r\n                            id=\"email\"\r\n                            type=\"email\"\r\n                            placeholder=\"name@example.com\"\r\n                            value={email}\r\n                            onChange={(e) => setEmail(e.target.value)}\r\n                            required\r\n                            className=\"bg-white/5 border-white/10 text-white placeholder:text-zinc-500 focus-visible:ring-primary/50\"\r\n                        />\r\n                    </div>\r\n                    <div className=\"space-y-2\">\r\n                        <div className=\"flex items-center justify-between\">\r\n                            <Label htmlFor=\"password\" className=\"text-zinc-300\">密码</Label>\r\n                            <a href=\"/auth/reset-password\" className=\"text-xs text-primary hover:text-primary/80 transition-colors\">\r\n                                忘记密码？\r\n                            </a>\r\n                        </div>\r\n                        <Input\r\n                            id=\"password\"\r\n                            type=\"password\"\r\n                            value={password}\r\n                            onChange={(e) => setPassword(e.target.value)}\r\n                            required\r\n                            className=\"bg-white/5 border-white/10 text-white placeholder:text-zinc-500 focus-visible:ring-primary/50\"\r\n                        />\r\n                    </div>\r\n                    <Button type=\"submit\" className=\"w-full bg-primary hover:bg-primary/90 text-white font-medium\" disabled={loading}>\r\n                        {loading && <Loader2 className=\"mr-2 h-4 w-4 animate-spin\" />}\r\n                        {loading ? \"登录中...\" : \"登录\"}\r\n                    </Button>\r\n                </form>\r\n\r\n                <div className=\"mt-6 text-center text-sm\">\r\n                    <span className=\"text-zinc-500\">还没有账号？ </span>\r\n                    <Link href=\"/auth/register\" className=\"text-primary hover:text-primary/80 font-medium transition-colors\">\r\n                        立即注册\r\n                    </Link>\r\n                </div>\r\n            </GlassPanel>\r\n        </div>\r\n    )\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"D:\\Desktop\\LawClick_NEW\\lawclick-next\\src\\app\\(auth)\\auth\\register\\page.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'e' is defined but never used.","line":44,"column":18,"nodeType":null,"messageId":"unusedVar","endLine":44,"endColumn":19}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\"\r\n\r\nimport { useState } from \"react\"\r\nimport { useForm } from \"react-hook-form\"\r\nimport { zodResolver } from \"@hookform/resolvers/zod\"\r\nimport { RegisterSchema } from \"@/lib/schemas\"\r\nimport { register } from \"@/actions/register\"\r\nimport { useRouter } from \"next/navigation\"\r\nimport { Button } from \"@/components/ui/button\"\r\nimport { Input } from \"@/components/ui/input\"\r\nimport { Label } from \"@/components/ui/label\"\r\nimport { GlassPanel } from \"@/components/ui/glass-panel\"\r\nimport { toast } from \"sonner\"\r\nimport Link from \"next/link\"\r\nimport { Loader2, Scale } from \"lucide-react\"\r\nimport { z } from \"zod\"\r\n\r\ntype RegisterForm = z.infer<typeof RegisterSchema>\r\n\r\nexport default function RegisterPage() {\r\n    const [loading, setLoading] = useState(false)\r\n    const router = useRouter()\r\n\r\n    // Convert Zod schema type\r\n    const { register: registerField, handleSubmit, formState: { errors } } = useForm<RegisterForm>({\r\n        resolver: zodResolver(RegisterSchema)\r\n    })\r\n\r\n    const onSubmit = async (data: RegisterForm) => {\r\n        setLoading(true)\r\n        const formData = new FormData()\r\n        formData.append(\"name\", data.name)\r\n        formData.append(\"email\", data.email)\r\n        formData.append(\"password\", data.password)\r\n\r\n        try {\r\n            const res = await register(formData)\r\n            if (res.error) {\r\n                toast.error(\"注册失败\", { description: res.error })\r\n            } else {\r\n                toast.success(\"注册成功\", { description: \"请登录您的账号\" })\r\n                router.push(\"/auth/login\")\r\n            }\r\n        } catch (e) {\r\n            toast.error(\"系统错误\", { description: \"请稍后重试\" })\r\n        } finally {\r\n            setLoading(false)\r\n        }\r\n    }\r\n\r\n    return (\r\n        <div className=\"dark min-h-screen flex items-center justify-center bg-[radial-gradient(ellipse_at_top,_var(--tw-gradient-stops))] from-slate-900 via-[#0a0a0a] to-black p-4 text-foreground\">\r\n            <GlassPanel intensity=\"high\" className=\"w-full max-w-md p-8 border-white/10 shadow-2xl bg-black/40\">\r\n                <div className=\"flex flex-col items-center justify-center mb-8 space-y-2\">\r\n                    <div className=\"bg-primary/20 p-3 rounded-xl ring-1 ring-white/20\">\r\n                        <Scale className=\"h-8 w-8 text-primary\" />\r\n                    </div>\r\n                    <div className=\"text-center\">\r\n                        <h1 className=\"text-2xl font-bold tracking-tight text-white\">创建账号</h1>\r\n                        <p className=\"text-sm text-muted-foreground mt-1\">加入 LawClick 生态系统</p>\r\n                    </div>\r\n                </div>\r\n\r\n                <form onSubmit={handleSubmit(onSubmit)} className=\"space-y-4\">\r\n                    <div className=\"space-y-2\">\r\n                        <Label className=\"text-zinc-300\">姓名</Label>\r\n                        <Input\r\n                            {...registerField(\"name\")}\r\n                            placeholder=\"真实姓名\"\r\n                            className=\"bg-white/5 border-white/10 text-white placeholder:text-zinc-500 focus-visible:ring-primary/50\"\r\n                        />\r\n                        {errors.name && <p className=\"text-xs text-red-500\">{errors.name.message}</p>}\r\n                    </div>\r\n\r\n                    <div className=\"space-y-2\">\r\n                        <Label className=\"text-zinc-300\">邮箱</Label>\r\n                        <Input\r\n                            {...registerField(\"email\")}\r\n                            type=\"email\"\r\n                            placeholder=\"lawyer@firm.com\"\r\n                            className=\"bg-white/5 border-white/10 text-white placeholder:text-zinc-500 focus-visible:ring-primary/50\"\r\n                        />\r\n                        {errors.email && <p className=\"text-xs text-red-500\">{errors.email.message}</p>}\r\n                    </div>\r\n\r\n                    <div className=\"space-y-2\">\r\n                        <Label className=\"text-zinc-300\">密码</Label>\r\n                        <Input\r\n                            {...registerField(\"password\")}\r\n                            type=\"password\"\r\n                            placeholder=\"••••••••\"\r\n                            className=\"bg-white/5 border-white/10 text-white placeholder:text-zinc-500 focus-visible:ring-primary/50\"\r\n                        />\r\n                        {errors.password && <p className=\"text-xs text-red-500\">{errors.password.message}</p>}\r\n                    </div>\r\n\r\n                    <Button className=\"w-full bg-primary hover:bg-primary/90 text-white font-medium\" disabled={loading}>\r\n                        {loading && <Loader2 className=\"mr-2 h-4 w-4 animate-spin\" />}\r\n                        {loading ? \"注册中...\" : \"立即注册\"}\r\n                    </Button>\r\n                </form>\r\n\r\n                <div className=\"mt-6 text-center text-sm\">\r\n                    <span className=\"text-zinc-500\">已有账号？ </span>\r\n                    <Link href=\"/auth/login\" className=\"text-primary hover:text-primary/80 font-medium transition-colors\">\r\n                        立即登录\r\n                    </Link>\r\n                </div>\r\n            </GlassPanel>\r\n        </div>\r\n    )\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"D:\\Desktop\\LawClick_NEW\\lawclick-next\\src\\app\\(auth)\\auth\\reset-password\\page.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'e' is defined but never used.","line":24,"column":18,"nodeType":null,"messageId":"unusedVar","endLine":24,"endColumn":19}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\"\r\n\r\nimport { useState } from \"react\"\r\nimport { Button } from \"@/components/ui/button\"\r\nimport { Input } from \"@/components/ui/input\"\r\nimport { Label } from \"@/components/ui/label\"\r\nimport { Card, CardContent, CardDescription, CardHeader, CardTitle } from \"@/components/ui/card\"\r\nimport { requestPasswordReset } from \"@/app/actions\"\r\nimport { toast } from \"sonner\"\r\nimport Link from \"next/link\"\r\n\r\nexport default function ResetPasswordPage() {\r\n    const [loading, setLoading] = useState(false)\r\n\r\n    async function handleSubmit(formData: FormData) {\r\n        setLoading(true)\r\n        try {\r\n            const res = await requestPasswordReset(formData)\r\n            if (res.error) {\r\n                toast.error(\"请求失败\", { description: res.error })\r\n            } else {\r\n                toast.success(\"请求成功\", { description: res.message })\r\n            }\r\n        } catch (e) {\r\n            toast.error(\"请求出错\")\r\n        } finally {\r\n            setLoading(false)\r\n        }\r\n    }\r\n\r\n    return (\r\n        <div className=\"flex h-screen items-center justify-center bg-slate-50\">\r\n            <Card className=\"w-[350px]\">\r\n                <CardHeader>\r\n                    <CardTitle>重置密码</CardTitle>\r\n                    <CardDescription>请输入您的注册邮箱</CardDescription>\r\n                </CardHeader>\r\n                <CardContent>\r\n                    <form action={handleSubmit} className=\"space-y-4\">\r\n                        <div className=\"space-y-2\">\r\n                            <Label htmlFor=\"email\">邮箱</Label>\r\n                            <Input id=\"email\" name=\"email\" type=\"email\" placeholder=\"name@example.com\" required />\r\n                        </div>\r\n                        <Button type=\"submit\" className=\"w-full\" disabled={loading}>\r\n                            {loading ? \"发送重置链接\" : \"发送重置链接\"}\r\n                        </Button>\r\n                    </form>\r\n                    <div className=\"mt-4 text-center text-sm text-slate-500\">\r\n                        <Link href=\"/auth/login\" className=\"text-primary hover:underline\">返回登录</Link>\r\n                    </div>\r\n                </CardContent>\r\n            </Card>\r\n        </div>\r\n    )\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"D:\\Desktop\\LawClick_NEW\\lawclick-next\\src\\app\\(dashboard)\\admin\\approvals\\page.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\Desktop\\LawClick_NEW\\lawclick-next\\src\\app\\(dashboard)\\admin\\finance\\page.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\Desktop\\LawClick_NEW\\lawclick-next\\src\\app\\(dashboard)\\admin\\page.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\Desktop\\LawClick_NEW\\lawclick-next\\src\\app\\(dashboard)\\calendar\\page.tsx","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":38,"column":61,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":38,"endColumn":64,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1342,1345],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1342,1345],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { addDays, startOfWeek } from \"date-fns\"\n\nimport { getEventOccurrencesInRange } from \"@/actions/event-actions\"\nimport { getTeamDirectory } from \"@/actions/team-directory\"\nimport { CanvasCalendar } from \"@/components/calendar/CanvasCalendar\"\nimport { getSessionUserOrThrow, requirePermission } from \"@/lib/server-auth\"\n\nexport default async function CalendarPage() {\n    const user = await getSessionUserOrThrow()\n    requirePermission(user.role, \"team:view\")\n\n    const now = new Date()\n    const from = startOfWeek(now, { weekStartsOn: 1 })\n    const to = addDays(from, 7)\n\n    const [occRes, teamRes] = await Promise.all([\n        getEventOccurrencesInRange({ from, to, userIds: [user.id] }),\n        getTeamDirectory({ take: 200 }),\n    ])\n\n    const seen = new Set<string>()\n    const initialEvents = occRes.success\n        ? occRes.data\n              .map((o) => o.event)\n              .filter((e) => {\n                  if (seen.has(e.id)) return false\n                  seen.add(e.id)\n                  return true\n              })\n        : []\n\n    const teamMembers = teamRes.success\n        ? teamRes.data.map((m) => ({ id: m.id, name: m.name || m.email, avatarUrl: m.avatarUrl || null }))\n        : []\n\n    return (\n        <div className=\"h-[calc(100vh-100px)]\">\n            <CanvasCalendar initialEvents={initialEvents as any} currentUserId={user.id} teamMembers={teamMembers} />\n        </div>\n    )\n}\n","usedDeprecatedRules":[]},{"filePath":"D:\\Desktop\\LawClick_NEW\\lawclick-next\\src\\app\\(dashboard)\\cases\\[id]\\page.tsx","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":19,"column":30,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":19,"endColumn":33,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[593,596],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[593,596],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":35,"column":41,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":35,"endColumn":44,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1076,1079],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1076,1079],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":40,"column":22,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":40,"endColumn":25,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1249,1252],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1249,1252],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":41,"column":25,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":41,"endColumn":28,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1325,1328],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1325,1328],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":43,"column":66,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":43,"endColumn":69,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1407,1410],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1407,1410],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":56,"column":64,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":56,"endColumn":67,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1836,1839],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1836,1839],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":6,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { notFound, redirect } from \"next/navigation\"\nimport { getCaseDetails } from \"@/actions/cases\"\nimport { CaseDetailClient } from \"@/components/cases/CaseDetailClient\"\nimport { AuthError, PermissionError, getSessionUser } from \"@/lib/server-auth\"\n\nexport default async function CaseDetailPage({\n    params,\n}: {\n    params: Promise<{ id: string }>\n}) {\n    try {\n        const { id } = await params\n        const caseItem = await getCaseDetails(id)\n        if (!caseItem) {\n            notFound()\n        }\n\n        const currentUser = await getSessionUser()\n        const safeUser = (u: any | null | undefined) =>\n            u\n                ? {\n                      id: u.id,\n                      name: u.name,\n                      email: u.email,\n                      image: u.avatarUrl || null,\n                  }\n                : null\n\n        const safeCurrentUser = safeUser(currentUser)\n\n        const tasks = caseItem.tasks || []\n        const progress =\n            tasks.length > 0\n                ? Math.round(\n                      (tasks.filter((t: any) => t.status === \"DONE\").length / tasks.length) * 100\n                  )\n                : 0\n\n        const safeMembers = (caseItem.members || [])\n            .map((m: any) => ({ role: m.role, user: safeUser(m.user) }))\n            .filter((m: any) => m.user)\n\n        const safeTimeLogs = (caseItem.timeLogs || []).map((log: any) => ({\n            id: log.id,\n            description: log.description,\n            startTime: log.startTime,\n            endTime: log.endTime,\n            duration: log.duration,\n            status: log.status,\n            isBillable: log.isBillable,\n            userId: log.userId,\n            caseId: log.caseId,\n            taskId: log.taskId,\n        }))\n\n        const safeEvents = (caseItem.events || []).map((event: any) => ({\n            id: event.id,\n            title: event.title,\n            description: event.description ?? null,\n            type: event.type,\n            visibility: event.visibility,\n            status: event.status,\n            startTime: event.startTime,\n            endTime: event.endTime,\n            location: event.location ?? null,\n            caseId: event.caseId,\n            taskId: event.taskId,\n        }))\n\n        const viewModel = {\n            id: caseItem.id,\n            caseCode: caseItem.caseCode,\n            title: caseItem.title,\n            status: caseItem.status,\n            serviceType: caseItem.serviceType,\n            billingMode: caseItem.billingMode,\n            description: caseItem.description,\n            contractValue: caseItem.contractValue ? Number(caseItem.contractValue) : 0,\n            currentStage: caseItem.currentStage,\n            templateId: caseItem.templateId,\n            createdAt: caseItem.createdAt,\n            updatedAt: caseItem.updatedAt,\n            clientId: caseItem.clientId,\n            originatorId: caseItem.originatorId,\n            handlerId: caseItem.handlerId,\n            channelId: caseItem.channelId,\n            client: caseItem.client,\n            tasks: caseItem.tasks || [],\n            documents: caseItem.documents || [],\n            timeLogs: safeTimeLogs,\n            events: safeEvents,\n            members: safeMembers,\n            originator: safeUser(caseItem.originator),\n            handler: safeUser(caseItem.handler),\n            caseNumber: caseItem.caseCode,\n            caseType: caseItem.serviceType,\n            clientName: caseItem.client?.name || \"未知客户\",\n            progress,\n            owner: safeUser(caseItem.originator) || safeUser(caseItem.handler) || safeCurrentUser,\n        }\n\n        return <CaseDetailClient caseItem={viewModel} currentUser={safeCurrentUser} />\n    } catch (error) {\n        if (error instanceof AuthError) {\n            redirect(\"/auth/login\")\n        }\n        if (error instanceof PermissionError) {\n            notFound()\n        }\n        throw error\n    }\n}\n","usedDeprecatedRules":[]},{"filePath":"D:\\Desktop\\LawClick_NEW\\lawclick-next\\src\\app\\(dashboard)\\cases\\active\\page.tsx","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":6,"column":44,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":6,"endColumn":47,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[246,249],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[246,249],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":9,"column":39,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":9,"endColumn":42,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[370,373],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[370,373],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":18,"column":46,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":18,"endColumn":49,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[726,729],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[726,729],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":3,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { getCases } from \"@/actions/cases\"\r\nimport { CaseListClient } from \"@/components/cases/CaseListClient\"\r\n\r\nexport default async function ActiveCasesPage() {\r\n    const dbCases = await getCases()\r\n    const activeCases = dbCases.filter((c: any) => c.status === 'ACTIVE')\r\n\r\n    // Transform to match CaseListClient interface\r\n    const cases = activeCases.map((c: any) => ({\r\n        ...c,\r\n        caseCode: c.caseCode,\r\n        title: c.title,\r\n        status: c.status,\r\n        clientName: c.client?.name || \"未知客户\",\r\n        caseType: c.serviceType,\r\n        contractValue: c.contractValue ? Number(c.contractValue) : 0,\r\n        progress: c.tasks && c.tasks.length > 0\r\n            ? Math.round((c.tasks.filter((t: any) => t.status === 'DONE').length / c.tasks.length) * 100)\r\n            : 0,\r\n        updatedAt: c.updatedAt\r\n    }))\r\n\r\n    return (\r\n        <div className=\"space-y-6\">\r\n            <div className=\"flex items-center justify-between\">\r\n                <div>\r\n                    <h1 className=\"text-2xl font-bold tracking-tight\">我的案件</h1>\r\n                    <p className=\"text-muted-foreground\">当前正在进行的案件列表</p>\r\n                </div>\r\n            </div>\r\n            <CaseListClient initialCases={cases} />\r\n        </div>\r\n    )\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"D:\\Desktop\\LawClick_NEW\\lawclick-next\\src\\app\\(dashboard)\\cases\\archived\\page.tsx","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":6,"column":46,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":6,"endColumn":49,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[250,253],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[250,253],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":9,"column":41,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":9,"endColumn":44,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[403,406],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[403,406],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":18,"column":46,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":18,"endColumn":49,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[759,762],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[759,762],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":3,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { getCases } from \"@/actions/cases\"\r\nimport { CaseListClient } from \"@/components/cases/CaseListClient\"\r\n\r\nexport default async function ArchivedCasesPage() {\r\n    const dbCases = await getCases()\r\n    const archivedCases = dbCases.filter((c: any) => c.status === 'ARCHIVED' || c.status === 'CLOSED')\r\n\r\n    // Transform to match CaseListClient interface\r\n    const cases = archivedCases.map((c: any) => ({\r\n        ...c,\r\n        caseCode: c.caseCode,\r\n        title: c.title,\r\n        status: c.status,\r\n        clientName: c.client?.name || \"未知客户\",\r\n        caseType: c.serviceType,\r\n        contractValue: c.contractValue ? Number(c.contractValue) : 0,\r\n        progress: c.tasks && c.tasks.length > 0\r\n            ? Math.round((c.tasks.filter((t: any) => t.status === 'DONE').length / c.tasks.length) * 100)\r\n            : 0,\r\n        updatedAt: c.updatedAt\r\n    }))\r\n\r\n    return (\r\n        <div className=\"space-y-6\">\r\n            <div className=\"flex items-center justify-between\">\r\n                <div>\r\n                    <h1 className=\"text-2xl font-bold tracking-tight\">归档库</h1>\r\n                    <p className=\"text-muted-foreground\">已结案或归档的案件</p>\r\n                </div>\r\n            </div>\r\n            <CaseListClient initialCases={cases} />\r\n        </div>\r\n    )\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"D:\\Desktop\\LawClick_NEW\\lawclick-next\\src\\app\\(dashboard)\\cases\\intake\\page.tsx","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":6,"column":44,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":6,"endColumn":47,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[241,244],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[241,244],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":8,"column":39,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":8,"endColumn":42,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[334,337],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[334,337],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":18,"column":50,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":18,"endColumn":53,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[697,700],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[697,700],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":3,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { getCases } from \"@/actions/cases\"\nimport { CaseListClient } from \"@/components/cases/CaseListClient\"\n\nexport default async function IntakeCasesPage() {\n    const dbCases = await getCases()\n    const intakeCases = dbCases.filter((c: any) => c.status === \"INTAKE\" || c.status === \"LEAD\")\n\n    const cases = intakeCases.map((c: any) => ({\n        ...c,\n        caseCode: c.caseCode,\n        title: c.title,\n        status: c.status,\n        clientName: c.client?.name || \"未知客户\",\n        caseType: c.serviceType,\n        contractValue: c.contractValue ? Number(c.contractValue) : 0,\n        progress:\n            c.tasks && c.tasks.length > 0\n                ? Math.round((c.tasks.filter((t: any) => t.status === \"DONE\").length / c.tasks.length) * 100)\n                : 0,\n        updatedAt: c.updatedAt,\n    }))\n\n    return (\n        <div className=\"space-y-6\">\n            <div className=\"flex items-center justify-between\">\n                <div>\n                    <h1 className=\"text-2xl font-bold tracking-tight\">立案侦查</h1>\n                    <p className=\"text-muted-foreground\">待立案/冲突审查中的案件列表</p>\n                </div>\n            </div>\n            <CaseListClient initialCases={cases} />\n        </div>\n    )\n}\n\n","usedDeprecatedRules":[]},{"filePath":"D:\\Desktop\\LawClick_NEW\\lawclick-next\\src\\app\\(dashboard)\\cases\\page.tsx","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":20,"column":48,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":20,"endColumn":51,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[766,769],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[766,769],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { getCases } from \"@/app/actions\"\r\nimport { CaseListClient } from \"@/components/cases/CaseListClient\"\r\n\r\nexport default async function CasesPage({\r\n    searchParams,\r\n}: {\r\n    searchParams: Promise<{ [key: string]: string | string[] | undefined }>\r\n}) {\r\n    const params = await searchParams\r\n    const query = typeof params.q === 'string' ? params.q : undefined\r\n    const status = typeof params.status === 'string' ? params.status : undefined\r\n    const type = typeof params.type === 'string' ? params.type : undefined\r\n\r\n    const dbCases = await getCases(query, status, type)\n\n    const cases = dbCases.map((c) => {\n        const tasks = c.tasks || []\n        const progress =\n            tasks.length > 0\n                ? Math.round((tasks.filter((t: any) => t.status === \"DONE\").length / tasks.length) * 100)\n                : 0\n\n        return {\n            id: c.id,\n            caseCode: c.caseCode,\n            title: c.title,\n            clientName: c.client?.name || \"未知客户\",\n            status: c.status,\n            caseType: c.serviceType,\n            contractValue: c.contractValue ? Number(c.contractValue) : 0,\n            progress,\n            updatedAt: c.updatedAt,\n        }\n    })\n\n    return <CaseListClient initialCases={cases} />\n}\n","usedDeprecatedRules":[]},{"filePath":"D:\\Desktop\\LawClick_NEW\\lawclick-next\\src\\app\\(dashboard)\\chat\\page.tsx","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":20,"column":57,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":20,"endColumn":60,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[661,664],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[661,664],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":27,"column":33,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":27,"endColumn":36,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[963,966],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[963,966],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":28,"column":50,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":28,"endColumn":53,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1017,1020],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1017,1020],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":30,"column":63,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":30,"endColumn":66,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1130,1133],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1130,1133],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":4,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { getChatMessages, getMyChatThreads } from \"@/actions/chat-actions\"\nimport { ChatPageClient } from \"@/components/chat/ChatPageClient\"\n\nexport default async function ChatPage({\n    searchParams,\n}: {\n    searchParams: Promise<{ threadId?: string | string[] | undefined }>\n}) {\n    const bootstrap = await getMyChatThreads()\n\n    const sp = await searchParams\n    const rawThreadId = sp?.threadId\n    const requestedThreadId = Array.isArray(rawThreadId)\n        ? rawThreadId[0] ?? null\n        : typeof rawThreadId === \"string\"\n            ? rawThreadId\n            : null\n\n    const hasRequested =\n        requestedThreadId && bootstrap.threads.some((t: any) => t.id === requestedThreadId)\n\n    const initialThreadId = hasRequested ? requestedThreadId : bootstrap.threads[0]?.id ?? null\n    const initialMessagesRes = initialThreadId ? await getChatMessages(initialThreadId, 80) : null\n\n    return (\n        <ChatPageClient\n            me={bootstrap.me as any}\n            initialThreads={bootstrap.threads as any}\n            initialThreadId={initialThreadId}\n            initialMessages={(initialMessagesRes?.messages as any) || []}\n        />\n    )\n}\n","usedDeprecatedRules":[]},{"filePath":"D:\\Desktop\\LawClick_NEW\\lawclick-next\\src\\app\\(dashboard)\\contacts\\page.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\Desktop\\LawClick_NEW\\lawclick-next\\src\\app\\(dashboard)\\crm\\customers\\[id]\\page.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'Calendar' is defined but never used.","line":11,"column":43,"nodeType":null,"messageId":"unusedVar","endLine":11,"endColumn":51},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":140,"column":62,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":140,"endColumn":65,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[6904,6907],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[6904,6907],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":198,"column":75,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":198,"endColumn":78,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[9963,9966],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[9963,9966],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":244,"column":69,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":244,"endColumn":72,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[12874,12877],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[12874,12877],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":4,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { getCustomerById, getTags } from \"@/actions/customer-actions\"\nimport { getTeamDirectory } from \"@/actions/team-directory\"\nimport { AddServiceRecordDialog } from \"@/components/crm/AddServiceRecordDialog\"\nimport { CreateCaseFromCustomerDialog } from \"@/components/crm/CreateCaseFromCustomerDialog\"\nimport { CustomerEditDialog } from \"@/components/crm/CustomerEditDialog\"\nimport { ManageCustomerTagsDialog } from \"@/components/crm/ManageCustomerTagsDialog\"\nimport { Card, CardContent, CardHeader, CardTitle } from \"@/components/ui/card\"\nimport { Badge } from \"@/components/ui/badge\"\nimport { Button } from \"@/components/ui/button\"\nimport {\n    Building2, User, Mail, Phone, MapPin, Calendar,\n    FileText, Star, ChevronLeft, Clock\n} from \"lucide-react\"\nimport { Avatar, AvatarFallback, AvatarImage } from \"@/components/ui/avatar\"\nimport Link from \"next/link\"\nimport { notFound } from \"next/navigation\"\n\r\n// 阶段配置\r\nconst STAGE_CONFIG: Record<string, { label: string; color: string }> = {\r\n    POTENTIAL: { label: '潜在', color: 'bg-gray-500' },\r\n    CONTACTED: { label: '已接触', color: 'bg-blue-500' },\r\n    NEGOTIATING: { label: '沟通中', color: 'bg-yellow-500' },\r\n    QUOTING: { label: '报价中', color: 'bg-orange-500' },\r\n    SIGNED: { label: '已签约', color: 'bg-green-500' },\r\n    LONG_TERM: { label: '长期客户', color: 'bg-purple-500' },\r\n    LOST: { label: '已流失', color: 'bg-red-500' },\r\n}\r\n\r\nexport default async function CustomerDetailPage({\r\n    params\r\n}: {\r\n    params: Promise<{ id: string }>\r\n}) {\n    const { id } = await params\n    const [result, tagsResult, teamResult] = await Promise.all([\n        getCustomerById(id),\n        getTags(),\n        getTeamDirectory({ take: 200 }),\n    ])\n\n    if (!result.success || !result.data) {\n        notFound()\n    }\n\n    const customer = result.data\n    const stageConfig = STAGE_CONFIG[customer.stage] || STAGE_CONFIG.POTENTIAL\n    const allTags = tagsResult.success ? tagsResult.data : []\n    const teamMembers = teamResult.success ? teamResult.data.map((u) => ({ id: u.id, name: u.name })) : []\n\n    return (\n        <div className=\"space-y-6\">\n            {/* Header */}\n            <div className=\"flex items-center gap-4\">\n                <Link href=\"/crm/customers\">\r\n                    <Button variant=\"ghost\" size=\"icon\">\r\n                        <ChevronLeft className=\"h-5 w-5\" />\r\n                    </Button>\r\n                </Link>\r\n                <div className=\"flex-1\">\r\n                    <div className=\"flex items-center gap-3\">\r\n                        <h1 className=\"text-2xl font-bold\">{customer.name}</h1>\r\n                        {customer.grade === 'VIP' && (\r\n                            <Badge className=\"bg-amber-500 text-white\">\r\n                                <Star className=\"h-3 w-3 mr-1\" /> VIP\r\n                            </Badge>\r\n                        )}\r\n                        <Badge className={`${stageConfig.color} text-white`}>\r\n                            {stageConfig.label}\r\n                        </Badge>\r\n                    </div>\r\n                    <p className=\"text-muted-foreground\">\n                        {customer.type === 'COMPANY' ? '企业客户' : '个人客户'} ·\n                        创建于 {new Date(customer.createdAt).toLocaleDateString('zh-CN')}\n                    </p>\n                </div>\n                <div className=\"flex flex-wrap gap-2 justify-end\">\n                    <CreateCaseFromCustomerDialog customerId={customer.id} customerName={customer.name} />\n                    <CustomerEditDialog customer={customer} teamMembers={teamMembers} />\n                </div>\n            </div>\n\r\n            <div className=\"grid grid-cols-1 lg:grid-cols-3 gap-6\">\r\n                {/* 左侧：基本信息 */}\r\n                <div className=\"space-y-6\">\r\n                    {/* 基本信息卡片 */}\r\n                    <Card>\r\n                        <CardHeader>\r\n                            <CardTitle className=\"text-lg flex items-center gap-2\">\r\n                                {customer.type === 'COMPANY' ? (\r\n                                    <Building2 className=\"h-5 w-5\" />\r\n                                ) : (\r\n                                    <User className=\"h-5 w-5\" />\r\n                                )}\r\n                                基本信息\r\n                            </CardTitle>\r\n                        </CardHeader>\r\n                        <CardContent className=\"space-y-4\">\r\n                            {customer.email && (\r\n                                <div className=\"flex items-center gap-3\">\r\n                                    <Mail className=\"h-4 w-4 text-muted-foreground\" />\r\n                                    <span>{customer.email}</span>\r\n                                </div>\r\n                            )}\r\n                            {customer.phone && (\r\n                                <div className=\"flex items-center gap-3\">\r\n                                    <Phone className=\"h-4 w-4 text-muted-foreground\" />\r\n                                    <span>{customer.phone}</span>\r\n                                </div>\r\n                            )}\r\n                            {customer.address && (\r\n                                <div className=\"flex items-center gap-3\">\r\n                                    <MapPin className=\"h-4 w-4 text-muted-foreground\" />\r\n                                    <span>{customer.address}</span>\r\n                                </div>\r\n                            )}\r\n                            {customer.industry && (\r\n                                <div className=\"flex items-center gap-3\">\r\n                                    <Building2 className=\"h-4 w-4 text-muted-foreground\" />\r\n                                    <span>{customer.industry}</span>\r\n                                </div>\r\n                            )}\r\n                            {customer.source && (\r\n                                <div className=\"flex items-center gap-3\">\r\n                                    <FileText className=\"h-4 w-4 text-muted-foreground\" />\r\n                                    <span>来源: {customer.source}</span>\r\n                                </div>\r\n                            )}\r\n                        </CardContent>\r\n                    </Card>\r\n\r\n                    {/* 标签 */}\r\n                    <Card>\n                        <CardHeader className=\"flex flex-row items-center justify-between\">\n                            <CardTitle className=\"text-lg\">标签</CardTitle>\n                            <ManageCustomerTagsDialog customerId={customer.id} currentTags={customer.tags || []} allTags={allTags} />\n                        </CardHeader>\n                        <CardContent>\n                            {customer.tags && customer.tags.length > 0 ? (\n                                <div className=\"flex flex-wrap gap-2\">\n                                    {customer.tags.map((tag: any) => (\r\n                                        <Badge\r\n                                            key={tag.id}\r\n                                            variant=\"outline\"\r\n                                            style={{ borderColor: tag.color, color: tag.color }}\r\n                                        >\r\n                                            {tag.name}\r\n                                        </Badge>\r\n                                    ))}\r\n                                </div>\r\n                            ) : (\r\n                                <p className=\"text-sm text-muted-foreground\">暂无标签</p>\r\n                            )}\r\n                        </CardContent>\r\n                    </Card>\r\n\r\n                    {/* 负责人 */}\r\n                    <Card>\r\n                        <CardHeader>\r\n                            <CardTitle className=\"text-lg\">负责人</CardTitle>\r\n                        </CardHeader>\r\n                        <CardContent>\r\n                            {customer.assignee ? (\r\n                                <div className=\"flex items-center gap-3\">\r\n                                    <Avatar>\r\n                                        <AvatarImage src={customer.assignee.avatarUrl} />\r\n                                        <AvatarFallback>{customer.assignee.name?.[0]}</AvatarFallback>\r\n                                    </Avatar>\r\n                                    <div>\r\n                                        <p className=\"font-medium\">{customer.assignee.name}</p>\r\n                                        {customer.assignee.title && (\r\n                                            <p className=\"text-sm text-muted-foreground\">\r\n                                                {customer.assignee.title}\r\n                                            </p>\r\n                                        )}\r\n                                    </div>\r\n                                </div>\r\n                            ) : (\r\n                                <p className=\"text-sm text-muted-foreground\">暂无负责人</p>\r\n                            )}\r\n                        </CardContent>\r\n                    </Card>\r\n                </div>\r\n\r\n                {/* 中间：服务记录 */}\r\n                <div className=\"lg:col-span-2 space-y-6\">\r\n                    {/* 服务记录 */}\r\n                    <Card>\n                        <CardHeader className=\"flex flex-row items-center justify-between\">\n                            <CardTitle className=\"text-lg flex items-center gap-2\">\n                                <Clock className=\"h-5 w-5\" />\n                                服务记录\n                            </CardTitle>\n                            <AddServiceRecordDialog contactId={customer.id} />\n                        </CardHeader>\n                        <CardContent>\n                            {customer.serviceRecords && customer.serviceRecords.length > 0 ? (\n                                <div className=\"space-y-4\">\n                                    {customer.serviceRecords.map((record: any) => (\r\n                                        <div key={record.id} className=\"border-l-2 border-primary pl-4 pb-4\">\r\n                                            <div className=\"flex items-center justify-between\">\r\n                                                <div className=\"flex items-center gap-2\">\r\n                                                    <Badge variant=\"outline\">{record.type}</Badge>\r\n                                                    {record.satisfaction && (\r\n                                                        <span className=\"text-sm text-muted-foreground\">\r\n                                                            满意度: {record.satisfaction}/5\r\n                                                        </span>\r\n                                                    )}\r\n                                                </div>\r\n                                                <span className=\"text-sm text-muted-foreground\">\r\n                                                    {new Date(record.serviceDate).toLocaleDateString('zh-CN')}\r\n                                                </span>\r\n                                            </div>\r\n                                            <p className=\"mt-2 text-sm\">{record.content}</p>\r\n                                            {record.nextAction && (\r\n                                                <p className=\"mt-2 text-sm text-orange-500\">\r\n                                                    下一步: {record.nextAction}\r\n                                                </p>\r\n                                            )}\r\n                                            <p className=\"mt-1 text-xs text-muted-foreground\">\r\n                                                by {record.lawyer?.name}\r\n                                            </p>\r\n                                        </div>\r\n                                    ))}\r\n                                </div>\r\n                            ) : (\r\n                                <div className=\"text-center py-8 text-muted-foreground\">\r\n                                    暂无服务记录\r\n                                </div>\r\n                            )}\r\n                        </CardContent>\r\n                    </Card>\r\n\r\n                    {/* 关联案件 */}\r\n                    <Card>\r\n                        <CardHeader>\r\n                            <CardTitle className=\"text-lg flex items-center gap-2\">\r\n                                <FileText className=\"h-5 w-5\" />\r\n                                关联案件\r\n                            </CardTitle>\r\n                        </CardHeader>\r\n                        <CardContent>\r\n                            {customer.casesAsClient && customer.casesAsClient.length > 0 ? (\r\n                                <div className=\"space-y-2\">\r\n                                    {customer.casesAsClient.map((c: any) => (\r\n                                        <Link href={`/cases/${c.id}`} key={c.id}>\r\n                                            <div className=\"flex items-center justify-between p-3 rounded-lg hover:bg-muted transition-colors\">\r\n                                                <div>\r\n                                                    <p className=\"font-medium\">{c.title}</p>\r\n                                                    <p className=\"text-sm text-muted-foreground\">{c.caseCode}</p>\r\n                                                </div>\r\n                                                <Badge variant=\"outline\">{c.status}</Badge>\r\n                                            </div>\r\n                                        </Link>\r\n                                    ))}\r\n                                </div>\r\n                            ) : (\r\n                                <div className=\"text-center py-8 text-muted-foreground\">\r\n                                    暂无关联案件\r\n                                </div>\r\n                            )}\r\n                        </CardContent>\r\n                    </Card>\r\n\r\n                    {/* 备注 */}\r\n                    {customer.notes && (\r\n                        <Card>\r\n                            <CardHeader>\r\n                                <CardTitle className=\"text-lg\">备注</CardTitle>\r\n                            </CardHeader>\r\n                            <CardContent>\r\n                                <p className=\"text-sm whitespace-pre-wrap\">{customer.notes}</p>\r\n                            </CardContent>\r\n                        </Card>\r\n                    )}\r\n                </div>\r\n            </div>\r\n        </div>\r\n    )\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"D:\\Desktop\\LawClick_NEW\\lawclick-next\\src\\app\\(dashboard)\\crm\\customers\\page.tsx","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":196,"column":47,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":196,"endColumn":50,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[8919,8922],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[8919,8922],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":229,"column":91,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":229,"endColumn":94,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[11790,11793],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[11790,11793],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":2,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import Link from \"next/link\"\nimport type { CustomerGrade, CustomerStage } from \"@prisma/client\"\nimport { ChevronLeft, ChevronRight, Clock, Filter, Search, Star, TrendingUp, Users } from \"lucide-react\"\n\nimport { getCustomers, getCustomerStats } from \"@/actions/customer-actions\"\nimport { CreateCustomerDialog } from \"@/components/crm/CreateCustomerDialog\"\nimport { Avatar, AvatarFallback, AvatarImage } from \"@/components/ui/avatar\"\nimport { Badge } from \"@/components/ui/badge\"\nimport { Button } from \"@/components/ui/button\"\nimport { Card, CardContent } from \"@/components/ui/card\"\nimport { Input } from \"@/components/ui/input\"\n\nexport const dynamic = \"force-dynamic\"\n\nconst STAGE_CONFIG: Record<string, { label: string; color: string }> = {\n    POTENTIAL: { label: \"潜在\", color: \"bg-gray-500\" },\n    CONTACTED: { label: \"已接触\", color: \"bg-blue-500\" },\n    NEGOTIATING: { label: \"沟通中\", color: \"bg-yellow-500\" },\n    QUOTING: { label: \"报价中\", color: \"bg-orange-500\" },\n    SIGNED: { label: \"已签约\", color: \"bg-green-500\" },\n    LONG_TERM: { label: \"长期客户\", color: \"bg-purple-500\" },\n    LOST: { label: \"已流失\", color: \"bg-red-500\" },\n}\n\nconst GRADE_CONFIG: Record<string, { label: string; color: string }> = {\n    VIP: { label: \"VIP\", color: \"bg-amber-500\" },\n    NORMAL: { label: \"普通\", color: \"bg-blue-500\" },\n    POTENTIAL: { label: \"潜在\", color: \"bg-gray-500\" },\n}\n\nconst STAGE_OPTIONS = Object.keys(STAGE_CONFIG)\nconst GRADE_OPTIONS = Object.keys(GRADE_CONFIG)\n\nfunction clampInt(value: string | undefined, fallback: number) {\n    const num = Number(value)\n    if (!Number.isFinite(num)) return fallback\n    return Math.max(1, Math.floor(num))\n}\n\nexport default async function CustomersPage({\n    searchParams,\n}: {\n    searchParams: Promise<{ [key: string]: string | string[] | undefined }>\n}) {\n    const params = await searchParams\n    const getParam = (key: string) => {\n        const v = params[key]\n        return Array.isArray(v) ? v[0] : v\n    }\n\n    const q = (getParam(\"q\") || \"\").trim()\n    const stageRaw = getParam(\"stage\") || \"\"\n    const gradeRaw = getParam(\"grade\") || \"\"\n    const pageRaw = getParam(\"page\")\n\n    const stage = STAGE_OPTIONS.includes(stageRaw) ? (stageRaw as CustomerStage) : undefined\n    const grade = GRADE_OPTIONS.includes(gradeRaw) ? (gradeRaw as CustomerGrade) : undefined\n    const page = clampInt(pageRaw, 1)\n\n    const [customersResult, statsResult] = await Promise.all([\n        getCustomers({ page, limit: 20, search: q || undefined, stage, grade }),\n        getCustomerStats(),\n    ])\n\n    const customers = customersResult.success ? customersResult.data : []\n    const stats = statsResult.success ? statsResult.data : null\n\n    const total = customersResult.success ? customersResult.total : 0\n    const limit = customersResult.success ? customersResult.limit : 20\n    const totalPages = Math.max(1, Math.ceil(total / limit))\n\n    const makeHref = (nextPage: number) => {\n        const sp = new URLSearchParams()\n        if (q) sp.set(\"q\", q)\n        if (stage) sp.set(\"stage\", stage)\n        if (grade) sp.set(\"grade\", grade)\n        if (nextPage > 1) sp.set(\"page\", String(nextPage))\n        const query = sp.toString()\n        return query ? `/crm/customers?${query}` : \"/crm/customers\"\n    }\n\n    return (\n        <div className=\"space-y-6\">\n            <div className=\"flex items-center justify-between gap-4\">\n                <div>\n                    <h1 className=\"text-2xl font-bold\">客户管理</h1>\n                    <p className=\"text-muted-foreground\">客户信息、阶段跟进与服务记录</p>\n                </div>\n                <CreateCustomerDialog />\n            </div>\n\n            <Card>\n                <CardContent className=\"p-4\">\n                    <form action=\"/crm/customers\" method=\"get\" className=\"flex flex-col md:flex-row gap-2 md:items-center\">\n                        <div className=\"relative flex-1\">\n                            <Search className=\"absolute left-3 top-1/2 -translate-y-1/2 h-4 w-4 text-muted-foreground\" />\n                            <Input name=\"q\" defaultValue={q} className=\"pl-9\" placeholder=\"搜索客户名称/邮箱/电话\" />\n                        </div>\n\n                        <select\n                            name=\"stage\"\n                            defaultValue={stage || \"\"}\n                            className=\"h-10 rounded-md border bg-background px-3 text-sm\"\n                        >\n                            <option value=\"\">全部阶段</option>\n                            {STAGE_OPTIONS.map((s) => (\n                                <option key={s} value={s}>\n                                    {STAGE_CONFIG[s]?.label || s}\n                                </option>\n                            ))}\n                        </select>\n\n                        <select\n                            name=\"grade\"\n                            defaultValue={grade || \"\"}\n                            className=\"h-10 rounded-md border bg-background px-3 text-sm\"\n                        >\n                            <option value=\"\">全部等级</option>\n                            {GRADE_OPTIONS.map((g) => (\n                                <option key={g} value={g}>\n                                    {GRADE_CONFIG[g]?.label || g}\n                                </option>\n                            ))}\n                        </select>\n\n                        <Button type=\"submit\" variant=\"outline\" className=\"gap-2\">\n                            <Filter className=\"h-4 w-4\" />\n                            筛选\n                        </Button>\n                    </form>\n                </CardContent>\n            </Card>\n\n            {stats && (\n                <div className=\"grid grid-cols-1 md:grid-cols-5 gap-4\">\n                    <Card>\n                        <CardContent className=\"p-4 flex items-center gap-4\">\n                            <div className=\"p-3 rounded-full bg-primary/10\">\n                                <Users className=\"h-5 w-5 text-primary\" />\n                            </div>\n                            <div>\n                                <p className=\"text-2xl font-bold\">{stats.total}</p>\n                                <p className=\"text-sm text-muted-foreground\">总客户</p>\n                            </div>\n                        </CardContent>\n                    </Card>\n                    <Card>\n                        <CardContent className=\"p-4 flex items-center gap-4\">\n                            <div className=\"p-3 rounded-full bg-amber-500/10\">\n                                <Star className=\"h-5 w-5 text-amber-500\" />\n                            </div>\n                            <div>\n                                <p className=\"text-2xl font-bold\">{stats.byGrade?.VIP || 0}</p>\n                                <p className=\"text-sm text-muted-foreground\">VIP 客户</p>\n                            </div>\n                        </CardContent>\n                    </Card>\n                    <Card>\n                        <CardContent className=\"p-4 flex items-center gap-4\">\n                            <div className=\"p-3 rounded-full bg-green-500/10\">\n                                <TrendingUp className=\"h-5 w-5 text-green-500\" />\n                            </div>\n                            <div>\n                                <p className=\"text-2xl font-bold\">{stats.byStage?.SIGNED || 0}</p>\n                                <p className=\"text-sm text-muted-foreground\">已签约</p>\n                            </div>\n                        </CardContent>\n                    </Card>\n                    <Card>\n                        <CardContent className=\"p-4 flex items-center gap-4\">\n                            <div className=\"p-3 rounded-full bg-yellow-500/10\">\n                                <Clock className=\"h-5 w-5 text-yellow-500\" />\n                            </div>\n                            <div>\n                                <p className=\"text-2xl font-bold\">{stats.byStage?.NEGOTIATING || 0}</p>\n                                <p className=\"text-sm text-muted-foreground\">沟通中</p>\n                            </div>\n                        </CardContent>\n                    </Card>\n                    <Card>\n                        <CardContent className=\"p-4 flex items-center gap-4\">\n                            <div className=\"p-3 rounded-full bg-slate-500/10\">\n                                <Clock className=\"h-5 w-5 text-slate-500\" />\n                            </div>\n                            <div>\n                                <p className=\"text-2xl font-bold\">{stats.byStage?.LOST || 0}</p>\n                                <p className=\"text-sm text-muted-foreground\">已流失</p>\n                            </div>\n                        </CardContent>\n                    </Card>\n                </div>\n            )}\n\n            {customers.length > 0 ? (\n                <div className=\"space-y-3\">\n                    {customers.map((customer: any) => {\n                        const stageConfig = STAGE_CONFIG[customer.stage] || STAGE_CONFIG.POTENTIAL\n                        const gradeConfig = GRADE_CONFIG[customer.grade] || GRADE_CONFIG.POTENTIAL\n\n                        return (\n                            <Link href={`/crm/customers/${customer.id}`} key={customer.id}>\n                                <Card className=\"hover:shadow-md transition-shadow\">\n                                    <CardContent className=\"p-4\">\n                                        <div className=\"flex items-center justify-between gap-4\">\n                                            <div className=\"flex items-center gap-3 min-w-0\">\n                                                <div className={`h-10 w-10 rounded-lg flex items-center justify-center ${gradeConfig.color}/10`}>\n                                                    <Users className={`h-5 w-5 ${gradeConfig.color.replace(\"bg-\", \"text-\")}`} />\n                                                </div>\n                                                <div className=\"min-w-0\">\n                                                    <div className=\"flex items-center gap-2\">\n                                                        <span className=\"font-medium truncate\">{customer.name}</span>\n                                                        {customer.grade === \"VIP\" ? (\n                                                            <Badge className=\"bg-amber-500 text-white\">VIP</Badge>\n                                                        ) : null}\n                                                        <Badge variant=\"outline\" className=\"text-xs\">\n                                                            {customer.type === \"COMPANY\" ? \"企业\" : \"个人\"}\n                                                        </Badge>\n                                                    </div>\n                                                    <div className=\"flex items-center gap-3 mt-1 text-sm text-muted-foreground truncate\">\n                                                        {customer.industry ? <span className=\"truncate\">{customer.industry}</span> : null}\n                                                        {customer.phone ? <span className=\"truncate\">{customer.phone}</span> : null}\n                                                        {customer.email ? <span className=\"truncate\">{customer.email}</span> : null}\n                                                    </div>\n                                                </div>\n                                            </div>\n\n                                            <div className=\"flex items-center gap-4 shrink-0\">\n                                                <div className=\"hidden md:flex gap-1\">\n                                                    {customer.tags?.slice(0, 3).map((tag: any) => (\n                                                        <Badge\n                                                            key={tag.id}\n                                                            variant=\"outline\"\n                                                            style={{ borderColor: tag.color, color: tag.color }}\n                                                        >\n                                                            {tag.name}\n                                                        </Badge>\n                                                    ))}\n                                                </div>\n\n                                                <Badge className={`${stageConfig.color} text-white`}>{stageConfig.label}</Badge>\n\n                                                {customer.assignee ? (\n                                                    <Avatar className=\"h-8 w-8\">\n                                                        <AvatarImage src={customer.assignee.avatarUrl} />\n                                                        <AvatarFallback>{customer.assignee.name?.[0]}</AvatarFallback>\n                                                    </Avatar>\n                                                ) : null}\n\n                                                <ChevronRight className=\"h-5 w-5 text-muted-foreground\" />\n                                            </div>\n                                        </div>\n\n                                        <div className=\"flex gap-4 mt-3 pt-3 border-t text-sm text-muted-foreground\">\n                                            <span>案件: {customer._count?.casesAsClient || 0}</span>\n                                            <span>服务记录: {customer._count?.serviceRecords || 0}</span>\n                                            {customer.nextFollowUp ? (\n                                                <span className=\"text-orange-600\">\n                                                    下次跟进: {new Date(customer.nextFollowUp).toLocaleDateString(\"zh-CN\")}\n                                                </span>\n                                            ) : null}\n                                        </div>\n                                    </CardContent>\n                                </Card>\n                            </Link>\n                        )\n                    })}\n                </div>\n            ) : (\n                <Card>\n                    <CardContent className=\"flex flex-col items-center justify-center py-12\">\n                        <Users className=\"h-12 w-12 text-muted-foreground mb-4\" />\n                        <p className=\"text-lg font-medium\">暂无客户</p>\n                        <p className=\"text-muted-foreground\">使用右上角「新增客户」开始</p>\n                    </CardContent>\n                </Card>\n            )}\n\n            <div className=\"flex items-center justify-between\">\n                <Button asChild variant=\"outline\" disabled={page <= 1}>\n                    <Link href={makeHref(Math.max(1, page - 1))} aria-disabled={page <= 1} tabIndex={page <= 1 ? -1 : 0}>\n                        <ChevronLeft className=\"h-4 w-4 mr-2\" />\n                        上一页\n                    </Link>\n                </Button>\n                <div className=\"text-sm text-muted-foreground\">\n                    第 {page} / {totalPages} 页（共 {total} 条）\n                </div>\n                <Button asChild variant=\"outline\" disabled={page >= totalPages}>\n                    <Link\n                        href={makeHref(Math.min(totalPages, page + 1))}\n                        aria-disabled={page >= totalPages}\n                        tabIndex={page >= totalPages ? -1 : 0}\n                    >\n                        下一页\n                        <ChevronRight className=\"h-4 w-4 ml-2\" />\n                    </Link>\n                </Button>\n            </div>\n        </div>\n    )\n}\n","usedDeprecatedRules":[]},{"filePath":"D:\\Desktop\\LawClick_NEW\\lawclick-next\\src\\app\\(dashboard)\\dashboard\\page.tsx","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":46,"column":35,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":46,"endColumn":38,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[2243,2246],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[2243,2246],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":57,"column":56,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":57,"endColumn":59,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[2627,2630],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[2627,2630],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":62,"column":109,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":62,"endColumn":112,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[2838,2841],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[2838,2841],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":65,"column":106,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":65,"endColumn":109,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[3005,3008],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[3005,3008],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":72,"column":70,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":72,"endColumn":73,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[3264,3267],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[3264,3267],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":87,"column":29,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":87,"endColumn":32,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[3868,3871],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[3868,3871],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":105,"column":37,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":105,"endColumn":40,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[4672,4675],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[4672,4675],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":7,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { addDays, startOfDay, startOfWeek } from \"date-fns\"\n\nimport { getCases, getDashboardData } from \"@/actions/cases\"\nimport { getMyDashboardConfig } from \"@/actions/dashboard-layout\"\nimport { getActiveTimer, getMyTimeSummary } from \"@/actions/timelogs-crud\"\nimport { AddTaskDialog } from \"@/components/dashboard/AddTaskDialog\"\nimport { DashboardWorkspaceClient } from \"@/components/dashboard/DashboardWorkspaceClient\"\nimport { MyTasksWidget } from \"@/components/dashboard/widgets/MyTasksWidget\"\nimport { TimeSummaryWidget } from \"@/components/dashboard/widgets/TimeSummaryWidget\"\nimport { UpcomingEventsWidget } from \"@/components/dashboard/widgets/UpcomingEventsWidget\"\nimport { CaseKanban } from \"@/components/features/case-kanban\"\nimport { NewCaseWizard } from \"@/components/features/new-case-wizard\"\nimport { DASHBOARD_WIDGET_DEFINITIONS } from \"@/lib/dashboard-widgets\"\nimport { DEFAULT_DASHBOARD_KEY } from \"@/lib/dashboard/types\"\nimport { hasPermission } from \"@/lib/permissions\"\n\nexport const dynamic = \"force-dynamic\"\n\nexport default async function Dashboard() {\n    const now = new Date()\n    const todayFrom = startOfDay(now)\n    const todayTo = addDays(todayFrom, 1)\n    const weekFrom = startOfWeek(now, { weekStartsOn: 1 })\n    const weekTo = addDays(weekFrom, 7)\n\n    const [dashboardData, dashboardConfigRes, activeTimer] = await Promise.all([\n        getDashboardData(),\n        getMyDashboardConfig(DEFAULT_DASHBOARD_KEY),\n        getActiveTimer(),\n    ])\n\n    const { user, tasks, events } = dashboardData\n\n    const allowedWidgetDefs = DASHBOARD_WIDGET_DEFINITIONS.filter((w) =>\n        w.requiredPermissions.every((p) => hasPermission(user.role, p))\n    )\n    const needsCases = allowedWidgetDefs.some((w) => w.id === \"w_cases\")\n    const needsTime = allowedWidgetDefs.some((w) => w.id === \"w_time\")\n\n    const [cases, todaySummaryRes, weekSummaryRes] = await Promise.all([\n        needsCases ? getCases() : Promise.resolve([]),\n        needsTime ? getMyTimeSummary({ from: todayFrom.toISOString(), to: todayTo.toISOString() }) : Promise.resolve(null),\n        needsTime ? getMyTimeSummary({ from: weekFrom.toISOString(), to: weekTo.toISOString() }) : Promise.resolve(null),\n    ])\n\n    const kanbanCases = (cases as any[]).map((c) => ({\n        id: c.id,\n        title: c.title,\n        status: c.status,\n        updatedAt: c.updatedAt,\n        caseCode: c.caseCode,\n        caseNumber: c.caseNumber || c.caseCode,\n        clientName: c.clientName || c.client?.name || \"未知客户\",\n        client: c.client ? { name: c.client.name } : null,\n    }))\n\n    const dashboardConfig = dashboardConfigRes.data as any\n\n    const catalog = allowedWidgetDefs\n        .map((w) => {\n            if (w.id === \"w_cases\") {\n                return { id: w.id, type: w.type, title: w.title, content: <CaseKanban cases={kanbanCases as any} /> }\n            }\n            if (w.id === \"w_tasks\") {\n                return { id: w.id, type: w.type, title: w.title, content: <MyTasksWidget tasks={tasks as any[]} /> }\n            }\n            if (w.id === \"w_events\") {\n                return {\n                    id: w.id,\n                    type: w.type,\n                    title: w.title,\n                    content: <UpcomingEventsWidget events={events as any[]} />,\n                }\n            }\n            if (w.id === \"w_time\") {\n                const today = todaySummaryRes?.data || { totalHours: 0, billableHours: 0, count: 0 }\n                const week = weekSummaryRes?.data || { totalHours: 0, billableHours: 0, count: 0 }\n                return {\n                    id: w.id,\n                    type: w.type,\n                    title: w.title,\n                    content: <TimeSummaryWidget today={today} week={week} activeTimer={activeTimer} />,\n                }\n            }\n            return null\n        })\n        .filter(Boolean) as any\n\n    return (\n        <div className=\"space-y-4\">\n            <div className=\"flex items-center justify-between gap-2\">\n                <div>\n                    <div className=\"text-sm text-muted-foreground\">欢迎回来</div>\n                    <div className=\"text-lg font-semibold\">{user?.name || \"用户\"}</div>\n                </div>\n                <div className=\"flex items-center gap-2\">\n                    {hasPermission(user.role, \"case:create\") ? <NewCaseWizard /> : null}\n                    {hasPermission(user.role, \"task:create\") ? <AddTaskDialog userId={user.id} /> : null}\n                </div>\n            </div>\n\n            <DashboardWorkspaceClient\n                dashboardKey={DEFAULT_DASHBOARD_KEY}\n                initialConfig={dashboardConfig}\n                catalog={catalog as any}\n            />\n        </div>\n    )\n}\n","usedDeprecatedRules":[]},{"filePath":"D:\\Desktop\\LawClick_NEW\\lawclick-next\\src\\app\\(dashboard)\\dispatch\\page.tsx","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":22,"column":35,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":22,"endColumn":38,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[971,974],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[971,974],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":35,"column":41,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":35,"endColumn":44,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1455,1458],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1455,1458],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":56,"column":54,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":56,"endColumn":57,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[2520,2523],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[2520,2523],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":64,"column":46,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":64,"endColumn":49,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[2802,2805],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[2802,2805],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":72,"column":91,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":72,"endColumn":94,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[3173,3176],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[3173,3176],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":72,"column":107,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":72,"endColumn":110,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[3189,3192],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[3189,3192],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":80,"column":55,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":80,"endColumn":58,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[3605,3608],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[3605,3608],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":7,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { TeamHeatmap } from \"@/components/features/team-heatmap\"\nimport { DispatchScheduleBoardClient } from \"@/components/dispatch/DispatchScheduleBoardClient\"\nimport { PendingInvitesPanel } from \"@/components/dispatch/PendingInvitesPanel\"\nimport { CaseKanban } from \"@/components/features/case-kanban\"\nimport { Separator } from \"@/components/ui/separator\"\nimport { getCases } from \"@/actions/cases\"\nimport { getTeamStatus, getMyInvites } from \"@/actions/collaboration-actions\"\nimport { Badge } from \"@/components/ui/badge\"\nimport { Bell } from \"lucide-react\"\nimport { getSessionUserOrThrow, requirePermission } from \"@/lib/server-auth\"\n\nexport default async function DispatchPage() {\n    const viewer = await getSessionUserOrThrow()\n    requirePermission(viewer.role, \"team:view\")\n\n    const [cases, teamResult, invitesResult] = await Promise.all([\n        getCases(),\n        getTeamStatus(),\n        getMyInvites('received')\n    ])\n\n    const kanbanCases = (cases as any[]).map((c) => ({\n        id: c.id,\n        title: c.title,\n        status: c.status,\n        updatedAt: c.updatedAt,\n        caseCode: c.caseCode,\n        caseNumber: c.caseNumber || c.caseCode,\n        clientName: c.clientName || c.client?.name || \"未知客户\",\n        client: c.client ? { name: c.client.name } : null,\n    }))\n\n    const teamMembers = teamResult.success ? teamResult.data : []\n    const pendingInvites = invitesResult.success\n        ? invitesResult.data.filter((i: any) => i.status === 'PENDING')\n        : []\n\r\n    return (\r\n        <div className=\"flex flex-col gap-6 h-full\">\r\n            {/* Top: Team Heatmap */}\r\n            <section className=\"flex-shrink-0\">\n                <div className=\"flex items-center justify-between mb-4\">\n                    <div className=\"flex items-center gap-4\">\n                        <h2 className=\"text-xl font-semibold tracking-tight\">团队状态 - Live Heatmap</h2>\n                        <Badge variant=\"outline\" className=\"bg-green-500/10 text-green-500 border-green-500/20\">\n                            {teamMembers.length} 在线\n                        </Badge>\n                    </div>\n                    {pendingInvites.length > 0 && (\n                        <Badge variant=\"secondary\" className=\"bg-orange-500/10 text-orange-500\">\n                            <Bell className=\"h-3 w-3 mr-1\" />\n                            {pendingInvites.length} 待处理邀请\n                        </Badge>\n                    )}\n                </div>\n                <TeamHeatmap members={teamMembers as any} myUserId={viewer.id} />\n            </section>\n\n            <Separator className=\"bg-white/10\" />\n\n            {/* Team schedule lanes */}\n            <section className=\"flex-shrink-0\">\n                <DispatchScheduleBoardClient\n                    members={(teamMembers as any[]).map((m) => ({ id: m.id, name: m.name, role: m.role, avatarUrl: m.avatarUrl, status: m.status }))}\n                    currentUserId={viewer.id}\n                />\n            </section>\n\n            <Separator className=\"bg-white/10\" />\n\n            {/* Pending Invites */}\n            <PendingInvitesPanel invites={(invitesResult.success ? (invitesResult.data as any[]) : []) as any} />\n\n            {/* Bottom: Task/Case Pool */}\n            <section className=\"flex-1 min-h-0 flex flex-col\">\n                <div className=\"flex items-center justify-between mb-4\">\n                    <h2 className=\"text-xl font-semibold tracking-tight\">待分配案件池</h2>\n                </div>\r\n                <div className=\"flex-1 min-h-0 overflow-hidden\">\n                    <CaseKanban cases={kanbanCases as any} />\n                </div>\n            </section>\n        </div>\n    )\n}\n","usedDeprecatedRules":[]},{"filePath":"D:\\Desktop\\LawClick_NEW\\lawclick-next\\src\\app\\(dashboard)\\documents\\[id]\\page.tsx","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":17,"column":59,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":17,"endColumn":62,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[495,498],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[495,498],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { getDocumentById } from \"@/actions/documents\"\nimport { DocumentDetailClient } from \"@/components/documents/DocumentDetailClient\"\nimport { notFound } from \"next/navigation\"\n\nexport default async function DocumentDetailPage({\n    params,\n}: {\n    params: Promise<{ id: string }>\n}) {\n    const { id } = await params\n    const result = await getDocumentById(id)\n\n    if (!result.success || !result.data) {\n        notFound()\n    }\n\n    return <DocumentDetailClient document={result.data as any} />\n}\n\n","usedDeprecatedRules":[]},{"filePath":"D:\\Desktop\\LawClick_NEW\\lawclick-next\\src\\app\\(dashboard)\\documents\\[id]\\review\\page.tsx","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":13,"column":61,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":13,"endColumn":64,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[492,495],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[492,495],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { getDocumentById } from \"@/actions/documents\"\nimport { DocumentAIReviewClient } from \"@/components/documents/DocumentAIReviewClient\"\nimport { notFound } from \"next/navigation\"\n\nexport default async function DocumentReviewPage({ params }: { params: Promise<{ id: string }> }) {\n    const { id } = await params\n    const result = await getDocumentById(id)\n\n    if (!result.success || !result.data) {\n        notFound()\n    }\n\n    return <DocumentAIReviewClient document={result.data as any} />\n}\n","usedDeprecatedRules":[]},{"filePath":"D:\\Desktop\\LawClick_NEW\\lawclick-next\\src\\app\\(dashboard)\\documents\\page.tsx","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":13,"column":35,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":13,"endColumn":38,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[437,440],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[437,440],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":18,"column":68,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":18,"endColumn":71,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[576,579],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[576,579],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":2,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { getDocuments as getDocumentsFromActions } from \"@/actions/documents\"\nimport { getCases } from \"@/actions/cases\"\nimport { DocumentListClient } from \"@/components/documents/DocumentListClient\"\n\nexport const dynamic = \"force-dynamic\"\n\nexport default async function DocumentsPage() {\n    const [docsResult, cases] = await Promise.all([\n        getDocumentsFromActions(),\n        getCases()\n    ])\n\n    const caseOptions = (cases as any[]).map((c) => ({\n        id: c.id,\n        title: c.title,\n    }))\n\n    const documents = docsResult.success ? docsResult.data.map((d: any) => ({\n        id: d.id,\n        title: d.title,\n        fileUrl: d.fileUrl,\n        fileType: d.fileType,\r\n        fileSize: d.fileSize || 0,\r\n        updatedAt: d.updatedAt,\r\n        case: {\r\n            title: d.case?.title || '未关联',\r\n            caseCode: d.case?.caseCode || '-'\r\n        },\r\n        tags: d.tags || [],\r\n        notes: d.notes,\r\n        summary: d.summary,\n        category: d.category,\n        version: d.version?.toString(),\n        isFavorite: d.isFavorite,\n        isConfidential: d.isConfidential,\n    })) : []\n\n    return <DocumentListClient initialDocuments={documents} cases={caseOptions} />\n}\n","usedDeprecatedRules":[]},{"filePath":"D:\\Desktop\\LawClick_NEW\\lawclick-next\\src\\app\\(dashboard)\\layout.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\Desktop\\LawClick_NEW\\lawclick-next\\src\\app\\(dashboard)\\notifications\\page.tsx","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":47,"column":39,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":47,"endColumn":42,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1797,1800],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1797,1800],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\"\n\nimport { useEffect, useState } from \"react\"\nimport { useRouter } from \"next/navigation\"\nimport { Bell, Loader2 } from \"lucide-react\"\n\nimport { getMyNotifications, markAllNotificationsRead, markNotificationRead } from \"@/actions/notification-actions\"\nimport { Badge } from \"@/components/ui/badge\"\nimport { Button } from \"@/components/ui/button\"\nimport { Card, CardContent, CardHeader, CardTitle } from \"@/components/ui/card\"\nimport { ScrollArea } from \"@/components/ui/scroll-area\"\n\ntype NotificationActor = { id: string; name: string | null; email: string; avatarUrl: string | null }\n\ntype NotificationItem = {\n    id: string\n    type: string\n    title: string\n    content: string | null\n    actionUrl: string | null\n    readAt: string | Date | null\n    createdAt: string | Date\n    actor: NotificationActor | null\n}\n\nfunction formatRelativeTime(value: string | Date) {\n    const d = typeof value === \"string\" ? new Date(value) : value\n    if (Number.isNaN(d.getTime())) return \"\"\n    const diffMs = Date.now() - d.getTime()\n    if (diffMs < 60_000) return \"刚刚\"\n    if (diffMs < 60 * 60_000) return `${Math.floor(diffMs / 60_000)} 分钟前`\n    if (diffMs < 24 * 60 * 60_000) return `${Math.floor(diffMs / (60 * 60_000))} 小时前`\n    return d.toLocaleString(\"zh-CN\", { month: \"2-digit\", day: \"2-digit\", hour: \"2-digit\", minute: \"2-digit\" })\n}\n\nexport default function NotificationsPage() {\n    const router = useRouter()\n    const [items, setItems] = useState<NotificationItem[]>([])\n    const [unreadCount, setUnreadCount] = useState(0)\n    const [loading, setLoading] = useState(true)\n\n    const load = async () => {\n        setLoading(true)\n        try {\n            const res = await getMyNotifications({ take: 100 })\n            if (res.success) {\n                setItems(res.items as any)\n                setUnreadCount(res.unreadCount || 0)\n            }\n        } finally {\n            setLoading(false)\n        }\n    }\n\n    useEffect(() => {\n        void load()\n    }, [])\n\n    const markRead = async (id: string) => {\n        const target = items.find((n) => n.id === id)\n        if (!target || target.readAt) return\n\n        setItems((prev) => prev.map((n) => (n.id === id ? { ...n, readAt: new Date() } : n)))\n        setUnreadCount((prev) => Math.max(0, prev - 1))\n        await markNotificationRead(id)\n    }\n\n    const markAll = async () => {\n        await markAllNotificationsRead()\n        setItems((prev) => prev.map((n) => (n.readAt ? n : { ...n, readAt: new Date() })))\n        setUnreadCount(0)\n    }\n\n    return (\n        <div className=\"space-y-4\">\n            <div className=\"flex items-center justify-between\">\n                <div className=\"flex items-center gap-2\">\n                    <h1 className=\"text-xl font-semibold\">通知中心</h1>\n                    <Badge variant=\"secondary\" className=\"text-xs\">\n                        未读 {unreadCount}\n                    </Badge>\n                </div>\n                <div className=\"flex items-center gap-2\">\n                    <Button variant=\"outline\" onClick={load} disabled={loading}>\n                        刷新\n                    </Button>\n                    <Button onClick={markAll} disabled={unreadCount === 0}>\n                        全部已读\n                    </Button>\n                </div>\n            </div>\n\n            <Card>\n                <CardHeader className=\"pb-2\">\n                    <CardTitle className=\"text-base\">最近通知</CardTitle>\n                </CardHeader>\n                <CardContent>\n                    {loading ? (\n                        <div className=\"flex items-center justify-center py-12 text-muted-foreground\">\n                            <Loader2 className=\"h-5 w-5 mr-2 animate-spin\" />\n                            加载中...\n                        </div>\n                    ) : items.length === 0 ? (\n                        <div className=\"flex flex-col items-center justify-center py-12 text-muted-foreground\">\n                            <Bell className=\"h-10 w-10 mb-2 opacity-50\" />\n                            <div className=\"text-sm\">暂无通知</div>\n                        </div>\n                    ) : (\n                        <ScrollArea className=\"h-[calc(100vh-260px)] pr-2\">\n                            <div className=\"divide-y rounded-md border\">\n                                {items.map((n) => {\n                                    const unread = !n.readAt\n                                    return (\n                                        <button\n                                            key={n.id}\n                                            type=\"button\"\n                                            className={`w-full text-left p-3 hover:bg-muted/50 transition-colors ${unread ? \"bg-primary/5\" : \"\"\n                                                }`}\n                                            onClick={async () => {\n                                                await markRead(n.id)\n                                                if (n.actionUrl) router.push(n.actionUrl)\n                                            }}\n                                        >\n                                            <div className=\"flex items-start justify-between gap-4\">\n                                                <div className=\"min-w-0\">\n                                                    <div className=\"flex items-center gap-2\">\n                                                        <div className={`text-sm ${unread ? \"font-medium\" : \"\"} truncate`}>\n                                                            {n.title}\n                                                        </div>\n                                                        {unread ? (\n                                                            <span className=\"h-2 w-2 rounded-full bg-primary shrink-0\" />\n                                                        ) : null}\n                                                    </div>\n                                                    {n.content ? (\n                                                        <div className=\"text-xs text-muted-foreground mt-1 line-clamp-2\">\n                                                            {n.content}\n                                                        </div>\n                                                    ) : null}\n                                                </div>\n                                                <div className=\"text-[10px] text-muted-foreground shrink-0\">\n                                                    {formatRelativeTime(n.createdAt)}\n                                                </div>\n                                            </div>\n                                        </button>\n                                    )\n                                })}\n                            </div>\n                        </ScrollArea>\n                    )}\n                </CardContent>\n            </Card>\n        </div>\n    )\n}\n","usedDeprecatedRules":[]},{"filePath":"D:\\Desktop\\LawClick_NEW\\lawclick-next\\src\\app\\(dashboard)\\profile\\page.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\Desktop\\LawClick_NEW\\lawclick-next\\src\\app\\(dashboard)\\research\\page.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'FileText' is defined but never used.","line":7,"column":28,"nodeType":null,"messageId":"unusedVar","endLine":7,"endColumn":36}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\"\r\n\r\nimport { useState } from \"react\"\r\nimport { GlassPanel } from \"@/components/ui/glass-panel\"\r\nimport { Input } from \"@/components/ui/input\"\r\nimport { Button } from \"@/components/ui/button\"\r\nimport { Search, Sparkles, FileText, ArrowRight } from \"lucide-react\"\r\nimport { toast } from \"sonner\"\r\n\r\nexport default function ResearchPage() {\r\n    const [query, setQuery] = useState(\"\")\r\n    const [loading, setLoading] = useState(false)\r\n\r\n    const handleSearch = async () => {\r\n        setLoading(true)\n        toast.message(\"AI 知识检索模块开发中\", {\n            description: \"将于 TG13+（RAG/向量检索）专项落地\",\n        })\n        setLoading(false)\n    }\n\r\n    return (\r\n        <div className=\"max-w-4xl mx-auto p-8 space-y-8\">\r\n            <div className=\"text-center space-y-4\">\r\n                <h1 className=\"text-4xl font-bold tracking-tight bg-gradient-to-r from-primary to-purple-600 bg-clip-text text-transparent\">\r\n                    LawClick Intelligence\r\n                </h1>\r\n                <p className=\"text-muted-foreground text-lg\">\n                    Ask questions across your entire firm’s knowledge base.\n                </p>\n            </div>\n\r\n            <div className=\"relative\">\r\n                <GlassPanel intensity=\"high\" className=\"p-2 flex gap-2 rounded-full border-primary/20 shadow-brand-lg\">\r\n                    <Search className=\"ml-4 my-auto h-5 w-5 text-muted-foreground\" />\r\n                    <Input\r\n                        value={query}\r\n                        onChange={(e) => setQuery(e.target.value)}\r\n                        placeholder=\"e.g., 'What is our standard clause for IP indemnification?'\"\r\n                        className=\"border-0 bg-transparent focus-visible:ring-0 text-lg h-12\"\r\n                        onKeyDown={(e) => e.key === 'Enter' && handleSearch()}\r\n                    />\r\n                    <Button\r\n                        size=\"lg\"\r\n                        className=\"rounded-full px-8 gap-2 bg-gradient-to-r from-primary to-purple-600 hover:opacity-90\"\r\n                        onClick={handleSearch}\r\n                        disabled={loading}\r\n                    >\r\n                        {loading ? <Sparkles className=\"h-4 w-4 animate-spin\" /> : <ArrowRight className=\"h-4 w-4\" />}\r\n                        Research\r\n                    </Button>\r\n                </GlassPanel>\r\n            </div>\r\n\r\n            <GlassPanel intensity=\"low\" className=\"p-4 text-sm text-muted-foreground\">\n                本页面为 AI 知识检索入口，当前仅做接口预留与 UI 占位，具体 RAG/向量检索能力将在 TG13+ 专项落地。\n            </GlassPanel>\n        </div>\n    )\n}\n","usedDeprecatedRules":[]},{"filePath":"D:\\Desktop\\LawClick_NEW\\lawclick-next\\src\\app\\(dashboard)\\settings\\page.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\Desktop\\LawClick_NEW\\lawclick-next\\src\\app\\(dashboard)\\tasks\\page.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\Desktop\\LawClick_NEW\\lawclick-next\\src\\app\\(dashboard)\\time\\page.tsx","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":20,"column":39,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":20,"endColumn":42,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[724,727],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[724,727],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":31,"column":67,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":31,"endColumn":70,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1017,1020],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1017,1020],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":2,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { getCases, getDashboardData } from \"@/app/actions\"\nimport { getMyTimeLogs } from \"@/actions/timelogs-crud\"\nimport { TimeTrackingClient } from \"@/components/timelog/TimeTrackingClient\"\n\nexport default async function TimePage() {\n    const { user } = await getDashboardData()\n    const cases = await getCases()\n\n    const now = new Date()\n    const from = new Date(now.getFullYear(), now.getMonth(), 1, 0, 0, 0, 0)\n    const to = new Date(now.getFullYear(), now.getMonth() + 1, 1, 0, 0, 0, 0)\n\n    const logsRes = await getMyTimeLogs({\n        from: from.toISOString(),\n        to: to.toISOString(),\n        status: [\"COMPLETED\", \"APPROVED\", \"BILLED\"],\n        take: 300,\n    })\n\n    const caseOptions = cases.map((c: any) => ({\n        id: c.id,\n        title: c.title,\n        caseCode: c.caseCode,\n    }))\n\n    return (\n        <TimeTrackingClient\n            userId={user.id}\n            userRole={user.role}\n            cases={caseOptions}\n            initialLogs={(logsRes.success ? logsRes.data : []) as any}\n        />\n    )\n}\n\n","usedDeprecatedRules":[]},{"filePath":"D:\\Desktop\\LawClick_NEW\\lawclick-next\\src\\app\\(dashboard)\\timelog\\page.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\Desktop\\LawClick_NEW\\lawclick-next\\src\\app\\(dashboard)\\tools\\page.tsx","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":57,"column":67,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":57,"endColumn":70,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[2109,2112],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[2109,2112],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":239,"column":59,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":239,"endColumn":62,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[9887,9890],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[9887,9890],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":335,"column":32,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":335,"endColumn":35,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[13750,13753],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[13750,13753],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":394,"column":37,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":394,"endColumn":40,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[15433,15436],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[15433,15436],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":410,"column":43,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":410,"endColumn":46,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[15943,15946],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[15943,15946],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has a missing dependency: 'refreshManageModules'. Either include it or remove the dependency array.","line":424,"column":8,"nodeType":"ArrayExpression","endLine":424,"endColumn":13,"suggestions":[{"desc":"Update the dependencies array to be: [refreshManageModules, tab]","fix":{"range":[16193,16198],"text":"[refreshManageModules, tab]"}}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":486,"column":60,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":486,"endColumn":63,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[18298,18301],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[18298,18301],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":512,"column":60,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":512,"endColumn":63,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[19196,19199],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[19196,19199],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":528,"column":60,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":528,"endColumn":63,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[19740,19743],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[19740,19743],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":540,"column":60,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":540,"endColumn":63,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[20120,20123],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[20120,20123],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":10,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\"\n\nimport { useEffect, useMemo, useState, useTransition } from \"react\"\nimport { Card, CardContent, CardHeader, CardTitle, CardDescription } from \"@/components/ui/card\"\nimport { Button } from \"@/components/ui/button\"\nimport { Input } from \"@/components/ui/input\"\nimport { Label } from \"@/components/ui/label\"\nimport { Tabs, TabsContent, TabsList, TabsTrigger } from \"@/components/ui/tabs\"\nimport { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from \"@/components/ui/select\"\nimport { Badge } from \"@/components/ui/badge\"\nimport { Switch } from \"@/components/ui/switch\"\nimport { Dialog, DialogContent, DialogFooter, DialogHeader, DialogTitle, DialogTrigger } from \"@/components/ui/dialog\"\nimport {\n    AlertDialog,\n    AlertDialogAction,\n    AlertDialogCancel,\n    AlertDialogContent,\n    AlertDialogDescription,\n    AlertDialogFooter,\n    AlertDialogHeader,\n    AlertDialogTitle,\n    AlertDialogTrigger,\n} from \"@/components/ui/alert-dialog\"\nimport {\n    Calculator, Calendar, Percent, Scale, Gavel,\n    ExternalLink, Clock, TrendingUp, FileText, Wrench, Plus\n} from \"lucide-react\"\nimport {\n    calculateLitigationFee,\r\n    calculateInterest,\r\n    calculateDeadline,\r\n    CASE_TYPE_OPTIONS,\r\n    PERIOD_TYPE_OPTIONS,\n    LPR_RATES,\n} from \"@/lib/calculators\"\nimport { toast } from \"sonner\"\nimport { usePermission } from \"@/hooks/use-permission\"\nimport {\n    getToolModules,\n    createToolModule,\n    updateToolModule,\n    deleteToolModule,\n    triggerModuleWebhook,\n} from \"@/actions/tool-actions\"\n\r\n// ==============================================================================\r\n// 诉讼费计算器组件\r\n// ==============================================================================\r\n\r\nfunction LitigationFeeCalculator() {\r\n    const [amount, setAmount] = useState<string>(\"\")\r\n    const [caseType, setCaseType] = useState<string>(\"property\")\r\n    const [result, setResult] = useState<{ fee: number; breakdown: string[] } | null>(null)\r\n\r\n    const calculate = () => {\r\n        const numAmount = parseFloat(amount) || 0\r\n        const res = calculateLitigationFee(numAmount, caseType as any)\r\n        setResult(res)\r\n    }\r\n\r\n    return (\r\n        <Card>\r\n            <CardHeader>\r\n                <CardTitle className=\"flex items-center gap-2\">\r\n                    <Gavel className=\"h-5 w-5 text-primary\" /> 诉讼费计算器\r\n                </CardTitle>\r\n                <CardDescription>依据《诉讼费用交纳办法》计算</CardDescription>\r\n            </CardHeader>\r\n            <CardContent className=\"space-y-4\">\r\n                <div className=\"grid grid-cols-2 gap-4\">\r\n                    <div className=\"space-y-2\">\r\n                        <Label>案件类型</Label>\r\n                        <Select value={caseType} onValueChange={setCaseType}>\r\n                            <SelectTrigger>\r\n                                <SelectValue />\r\n                            </SelectTrigger>\r\n                            <SelectContent>\r\n                                {CASE_TYPE_OPTIONS.map(opt => (\r\n                                    <SelectItem key={opt.value} value={opt.value}>\r\n                                        {opt.label}\r\n                                    </SelectItem>\r\n                                ))}\r\n                            </SelectContent>\r\n                        </Select>\r\n                    </div>\r\n                    <div className=\"space-y-2\">\r\n                        <Label>标的金额（元）</Label>\r\n                        <Input\r\n                            type=\"number\"\r\n                            placeholder=\"请输入金额\"\r\n                            value={amount}\r\n                            onChange={(e) => setAmount(e.target.value)}\r\n                        />\r\n                    </div>\r\n                </div>\r\n\r\n                <Button onClick={calculate} className=\"w-full\">\r\n                    <Calculator className=\"h-4 w-4 mr-2\" /> 计算诉讼费\r\n                </Button>\r\n\r\n                {result && (\r\n                    <div className=\"mt-4 p-4 bg-muted rounded-lg space-y-2\">\r\n                        <div className=\"flex items-center justify-between\">\r\n                            <span className=\"text-muted-foreground\">应缴诉讼费</span>\r\n                            <span className=\"text-2xl font-bold text-primary\">\r\n                                ¥{result.fee.toLocaleString()}\r\n                            </span>\r\n                        </div>\r\n                        <div className=\"text-sm text-muted-foreground\">\r\n                            {result.breakdown.map((line, i) => (\r\n                                <p key={i}>{line}</p>\r\n                            ))}\r\n                        </div>\r\n                    </div>\r\n                )}\r\n            </CardContent>\r\n        </Card>\r\n    )\r\n}\r\n\r\n// ==============================================================================\r\n// 利息计算器组件\r\n// ==============================================================================\r\n\r\nfunction InterestCalculator() {\r\n    const [principal, setPrincipal] = useState<string>(\"\")\r\n    const [rate, setRate] = useState<string>(LPR_RATES.oneYear.toString())\r\n    const [startDate, setStartDate] = useState<string>(\"\")\r\n    const [endDate, setEndDate] = useState<string>(\"\")\r\n    const [result, setResult] = useState<{ interest: number; days: number; breakdown: string[] } | null>(null)\r\n\r\n    const calculate = () => {\r\n        const numPrincipal = parseFloat(principal) || 0\r\n        const numRate = parseFloat(rate) || 0\r\n        const start = new Date(startDate)\r\n        const end = new Date(endDate)\r\n\r\n        if (start >= end) {\r\n            alert(\"结束日期必须晚于起始日期\")\r\n            return\r\n        }\r\n\r\n        const res = calculateInterest(numPrincipal, numRate, start, end)\r\n        setResult(res)\r\n    }\r\n\r\n    return (\r\n        <Card>\r\n            <CardHeader>\r\n                <CardTitle className=\"flex items-center gap-2\">\r\n                    <Percent className=\"h-5 w-5 text-green-500\" /> 利息计算器\r\n                </CardTitle>\r\n                <CardDescription>支持LPR利率及自定义利率</CardDescription>\r\n            </CardHeader>\r\n            <CardContent className=\"space-y-4\">\r\n                <div className=\"grid grid-cols-2 gap-4\">\r\n                    <div className=\"space-y-2\">\r\n                        <Label>本金（元）</Label>\r\n                        <Input\r\n                            type=\"number\"\r\n                            placeholder=\"请输入本金\"\r\n                            value={principal}\r\n                            onChange={(e) => setPrincipal(e.target.value)}\r\n                        />\r\n                    </div>\r\n                    <div className=\"space-y-2\">\r\n                        <Label>年利率（%）</Label>\r\n                        <div className=\"flex gap-2\">\r\n                            <Input\r\n                                type=\"number\"\r\n                                step=\"0.01\"\r\n                                value={rate}\r\n                                onChange={(e) => setRate(e.target.value)}\r\n                            />\r\n                            <Button\r\n                                variant=\"outline\"\r\n                                size=\"sm\"\r\n                                onClick={() => setRate(LPR_RATES.oneYear.toString())}\r\n                            >\r\n                                LPR\r\n                            </Button>\r\n                        </div>\r\n                    </div>\r\n                    <div className=\"space-y-2\">\r\n                        <Label>起始日期</Label>\r\n                        <Input\r\n                            type=\"date\"\r\n                            value={startDate}\r\n                            onChange={(e) => setStartDate(e.target.value)}\r\n                        />\r\n                    </div>\r\n                    <div className=\"space-y-2\">\r\n                        <Label>结束日期</Label>\r\n                        <Input\r\n                            type=\"date\"\r\n                            value={endDate}\r\n                            onChange={(e) => setEndDate(e.target.value)}\r\n                        />\r\n                    </div>\r\n                </div>\r\n\r\n                <Button onClick={calculate} className=\"w-full\" variant=\"secondary\">\r\n                    <TrendingUp className=\"h-4 w-4 mr-2\" /> 计算利息\r\n                </Button>\r\n\r\n                {result && (\r\n                    <div className=\"mt-4 p-4 bg-green-500/10 rounded-lg space-y-2\">\r\n                        <div className=\"flex items-center justify-between\">\r\n                            <span className=\"text-muted-foreground\">应付利息</span>\r\n                            <span className=\"text-2xl font-bold text-green-600\">\r\n                                ¥{result.interest.toLocaleString()}\r\n                            </span>\r\n                        </div>\r\n                        <div className=\"text-sm text-muted-foreground\">\r\n                            {result.breakdown.map((line, i) => (\r\n                                <p key={i}>{line}</p>\r\n                            ))}\r\n                        </div>\r\n                    </div>\r\n                )}\r\n            </CardContent>\r\n        </Card>\r\n    )\r\n}\r\n\r\n// ==============================================================================\r\n// 日期计算器组件\r\n// ==============================================================================\r\n\r\nfunction DeadlineCalculator() {\r\n    const [baseDate, setBaseDate] = useState<string>(\"\")\r\n    const [periodType, setPeriodType] = useState<string>(\"appeal_judgment\")\r\n    const [customDays, setCustomDays] = useState<string>(\"\")\r\n    const [result, setResult] = useState<{ deadline: Date; daysRemaining: number; description: string } | null>(null)\r\n\r\n    const calculate = () => {\r\n        const base = new Date(baseDate)\r\n        const days = periodType === 'custom' ? parseInt(customDays) : undefined\r\n        const res = calculateDeadline(base, periodType as any, days)\r\n        setResult(res)\r\n    }\r\n\r\n    return (\r\n        <Card>\r\n            <CardHeader>\r\n                <CardTitle className=\"flex items-center gap-2\">\r\n                    <Calendar className=\"h-5 w-5 text-orange-500\" /> 期限计算器\r\n                </CardTitle>\r\n                <CardDescription>计算法定期限截止日期</CardDescription>\r\n            </CardHeader>\r\n            <CardContent className=\"space-y-4\">\r\n                <div className=\"grid grid-cols-2 gap-4\">\r\n                    <div className=\"space-y-2\">\r\n                        <Label>起算日期</Label>\r\n                        <Input\r\n                            type=\"date\"\r\n                            value={baseDate}\r\n                            onChange={(e) => setBaseDate(e.target.value)}\r\n                        />\r\n                    </div>\r\n                    <div className=\"space-y-2\">\r\n                        <Label>期限类型</Label>\r\n                        <Select value={periodType} onValueChange={setPeriodType}>\r\n                            <SelectTrigger>\r\n                                <SelectValue />\r\n                            </SelectTrigger>\r\n                            <SelectContent>\r\n                                {PERIOD_TYPE_OPTIONS.map(opt => (\r\n                                    <SelectItem key={opt.value} value={opt.value}>\r\n                                        {opt.label}\r\n                                    </SelectItem>\r\n                                ))}\r\n                            </SelectContent>\r\n                        </Select>\r\n                    </div>\r\n                </div>\r\n\r\n                {periodType === 'custom' && (\r\n                    <div className=\"space-y-2\">\r\n                        <Label>自定义天数</Label>\r\n                        <Input\r\n                            type=\"number\"\r\n                            placeholder=\"请输入天数\"\r\n                            value={customDays}\r\n                            onChange={(e) => setCustomDays(e.target.value)}\r\n                        />\r\n                    </div>\r\n                )}\r\n\r\n                <Button onClick={calculate} className=\"w-full\" variant=\"outline\">\r\n                    <Clock className=\"h-4 w-4 mr-2\" /> 计算截止日期\r\n                </Button>\r\n\r\n                {result && (\r\n                    <div className=\"mt-4 p-4 bg-orange-500/10 rounded-lg space-y-2\">\r\n                        <div className=\"flex items-center justify-between\">\r\n                            <span className=\"text-muted-foreground\">{result.description}</span>\r\n                            <span className=\"text-2xl font-bold text-orange-600\">\r\n                                {result.deadline.toLocaleDateString('zh-CN')}\r\n                            </span>\r\n                        </div>\r\n                        <div className=\"flex items-center gap-2\">\r\n                            <Badge variant={result.daysRemaining > 0 ? \"default\" : \"destructive\"}>\r\n                                {result.daysRemaining > 0\r\n                                    ? `剩余 ${result.daysRemaining} 天`\r\n                                    : `已逾期 ${Math.abs(result.daysRemaining)} 天`\r\n                                }\r\n                            </Badge>\r\n                        </div>\r\n                    </div>\r\n                )}\r\n            </CardContent>\r\n        </Card>\r\n    )\r\n}\r\n\r\n// ==============================================================================\n// DB 工具模块（ToolModule）\n// ==============================================================================\n\ntype ToolModuleItem = {\n    id: string\n    name: string\n    description: string | null\n    icon: string | null\n    url: string | null\n    webhookUrl: string | null\n    category: string\n    isActive: boolean\n    sortOrder: number\n    createdAt: Date | string\n    updatedAt: Date | string\n}\n\nconst ICON_MAP: Record<string, any> = {\n    FileText,\n    Scale,\n    Gavel,\n    Calendar,\n    Wrench,\n    ExternalLink,\n    Calculator,\n    Clock,\n    TrendingUp,\n    Percent,\n}\n\nconst CATEGORY_LABEL: Record<string, string> = {\n    link: \"常用链接\",\n    external: \"外部工具\",\n    calculator: \"工具组件\",\n}\n\n// ==============================================================================\n// 主页面\n// ==============================================================================\n\nexport default function ToolsPage() {\n    const { can } = usePermission()\n    const canManage = can(\"tools:manage\")\n\n    const [tab, setTab] = useState<string>(\"calculators\")\n    const [modulesLoading, setModulesLoading] = useState(true)\n    const [modules, setModules] = useState<ToolModuleItem[]>([])\n\n    const [manageLoading, setManageLoading] = useState(false)\n    const [manageModules, setManageModules] = useState<ToolModuleItem[]>([])\n\n    const [createOpen, setCreateOpen] = useState(false)\n    const [editOpen, setEditOpen] = useState(false)\n    const [editing, setEditing] = useState<ToolModuleItem | null>(null)\n    const [form, setForm] = useState({\n        name: \"\",\n        description: \"\",\n        icon: \"Wrench\",\n        url: \"\",\n        webhookUrl: \"\",\n        category: \"link\",\n        isActive: true,\n        sortOrder: 0,\n    })\n\n    const [isPending, startTransition] = useTransition()\n\n    const refreshModules = async () => {\n        setModulesLoading(true)\n        try {\n            const res = await getToolModules()\n            if (!res.success) {\n                toast.error(\"获取工具模块失败\", { description: res.error })\n                setModules([])\n                return\n            }\n            setModules((res.data as any) || [])\n        } finally {\n            setModulesLoading(false)\n        }\n    }\n\n    const refreshManageModules = async () => {\n        if (!canManage) return\n        setManageLoading(true)\n        try {\n            const res = await getToolModules(undefined, { includeInactive: true })\n            if (!res.success) {\n                toast.error(\"获取模块管理列表失败\", { description: res.error })\n                setManageModules([])\n                return\n            }\n            setManageModules((res.data as any) || [])\n        } finally {\n            setManageLoading(false)\n        }\n    }\n\n    useEffect(() => {\n        refreshModules()\n    }, [])\n\n    useEffect(() => {\n        if (tab === \"manage\") {\n            refreshManageModules()\n        }\n    }, [tab])\n\n    const groupedModules = useMemo(() => {\n        const groups = new Map<string, ToolModuleItem[]>()\n        for (const moduleItem of modules) {\n            const key = moduleItem.category || \"other\"\n            const arr = groups.get(key) || []\n            arr.push(moduleItem)\n            groups.set(key, arr)\n        }\n\n        for (const [key, arr] of groups.entries()) {\n            arr.sort((a, b) => (a.sortOrder || 0) - (b.sortOrder || 0))\n            groups.set(key, arr)\n        }\n\n        return Array.from(groups.entries()).sort(([a], [b]) => a.localeCompare(b))\n    }, [modules])\n\n    const openCreate = () => {\n        setForm({\n            name: \"\",\n            description: \"\",\n            icon: \"Wrench\",\n            url: \"\",\n            webhookUrl: \"\",\n            category: \"link\",\n            isActive: true,\n            sortOrder: 0,\n        })\n        setCreateOpen(true)\n    }\n\n    const openEdit = (moduleItem: ToolModuleItem) => {\n        setEditing(moduleItem)\n        setForm({\n            name: moduleItem.name || \"\",\n            description: moduleItem.description || \"\",\n            icon: moduleItem.icon || \"Wrench\",\n            url: moduleItem.url || \"\",\n            webhookUrl: moduleItem.webhookUrl || \"\",\n            category: moduleItem.category || \"link\",\n            isActive: moduleItem.isActive ?? true,\n            sortOrder: moduleItem.sortOrder || 0,\n        })\n        setEditOpen(true)\n    }\n\n    const handleCreate = () => {\n        startTransition(async () => {\n            const res = await createToolModule({\n                name: form.name.trim(),\n                description: form.description.trim() || undefined,\n                icon: form.icon.trim() || undefined,\n                url: form.url.trim() || undefined,\n                webhookUrl: form.webhookUrl.trim() || undefined,\n                category: form.category.trim() || \"link\",\n                isActive: form.isActive,\n                sortOrder: Number(form.sortOrder) || 0,\n            })\n\n            if (!res.success) {\n                toast.error(\"创建失败\", { description: (res as any).error })\n                return\n            }\n\n            toast.success(\"已创建工具模块\")\n            setCreateOpen(false)\n            await refreshModules()\n            await refreshManageModules()\n        })\n    }\n\n    const handleUpdate = () => {\n        if (!editing) return\n        startTransition(async () => {\n            const res = await updateToolModule(editing.id, {\n                name: form.name.trim(),\n                description: form.description.trim() || null,\n                icon: form.icon.trim() || null,\n                url: form.url.trim() || null,\n                webhookUrl: form.webhookUrl.trim() || null,\n                category: form.category.trim() || undefined,\n                isActive: form.isActive,\n                sortOrder: Number(form.sortOrder) || 0,\n            })\n\n            if (!res.success) {\n                toast.error(\"更新失败\", { description: (res as any).error })\n                return\n            }\n\n            toast.success(\"已更新模块\")\n            setEditOpen(false)\n            setEditing(null)\n            await refreshModules()\n            await refreshManageModules()\n        })\n    }\n\n    const handleToggleActive = (moduleItem: ToolModuleItem, nextActive: boolean) => {\n        startTransition(async () => {\n            const res = await updateToolModule(moduleItem.id, { isActive: nextActive })\n            if (!res.success) {\n                toast.error(\"更新失败\", { description: (res as any).error })\n                return\n            }\n            await refreshModules()\n            await refreshManageModules()\n        })\n    }\n\n    const handleDelete = (moduleId: string) => {\n        startTransition(async () => {\n            const res = await deleteToolModule(moduleId)\n            if (!res.success) {\n                toast.error(\"删除失败\", { description: (res as any).error })\n                return\n            }\n            toast.success(\"已删除模块\")\n            await refreshModules()\n            await refreshManageModules()\n        })\n    }\n\n    const handleRunWebhook = (moduleItem: ToolModuleItem) => {\n        startTransition(async () => {\n            const res = await triggerModuleWebhook(moduleItem.id, { source: \"tools_page\" })\n            if (!res.success) {\n                toast.error(\"运行失败\", { description: res.error })\n                return\n            }\n            toast.success(\"已触发 Webhook\")\n        })\n    }\n\n    return (\n        <div className=\"space-y-6\">\n            {/* Header */}\n            <div className=\"flex items-center justify-between\">\n                <div>\r\n                    <h1 className=\"text-2xl font-bold flex items-center gap-2\">\r\n                        <Wrench className=\"h-6 w-6\" /> 工具箱\r\n                    </h1>\r\n                    <p className=\"text-muted-foreground\">法律实用工具与快捷入口</p>\r\n                </div>\n            </div>\n\n            <Tabs value={tab} onValueChange={setTab} className=\"space-y-4\">\n                <TabsList>\n                    <TabsTrigger value=\"calculators\" className=\"gap-2\">\n                        <Calculator className=\"h-4 w-4\" /> 计算器\n                    </TabsTrigger>\n                    <TabsTrigger value=\"modules\" className=\"gap-2\">\n                        <Wrench className=\"h-4 w-4\" /> 工具模块\n                    </TabsTrigger>\n                    {canManage && (\n                        <TabsTrigger value=\"manage\" className=\"gap-2\">\n                            <TrendingUp className=\"h-4 w-4\" /> 管理\n                        </TabsTrigger>\n                    )}\n                </TabsList>\n\n                <TabsContent value=\"calculators\" className=\"space-y-6\">\n                    <div className=\"grid grid-cols-1 lg:grid-cols-2 gap-6\">\n                        <LitigationFeeCalculator />\n                        <InterestCalculator />\n                    </div>\n                    <DeadlineCalculator />\n                </TabsContent>\n\n                <TabsContent value=\"modules\" className=\"space-y-4\">\n                    {modulesLoading ? (\n                        <div className=\"text-sm text-muted-foreground\">正在加载工具模块...</div>\n                    ) : groupedModules.length === 0 ? (\n                        <div className=\"text-sm text-muted-foreground\">暂无工具模块，请先运行 seed 或由管理员创建。</div>\n                    ) : (\n                        groupedModules.map(([category, items]) => (\n                            <div key={category} className=\"space-y-3\">\n                                <div className=\"flex items-center justify-between\">\n                                    <div className=\"flex items-center gap-2\">\n                                        <Badge variant=\"secondary\">{CATEGORY_LABEL[category] || category}</Badge>\n                                        <span className=\"text-xs text-muted-foreground\">{items.length} 个</span>\n                                    </div>\n                                </div>\n                                <div className=\"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4\">\n                                    {items.map((moduleItem) => {\n                                        const Icon = ICON_MAP[moduleItem.icon || \"\"] || Wrench\n                                        return (\n                                            <Card key={moduleItem.id} className=\"hover:shadow-md transition-shadow\">\n                                                <CardContent className=\"p-4 space-y-3\">\n                                                    <div className=\"flex items-start justify-between gap-3\">\n                                                        <div className=\"flex items-start gap-3 min-w-0\">\n                                                            <div className=\"p-2 rounded-lg bg-primary/10 text-primary shrink-0\">\n                                                                <Icon className=\"h-5 w-5\" />\n                                                            </div>\n                                                            <div className=\"min-w-0\">\n                                                                <div className=\"font-medium truncate\">{moduleItem.name}</div>\n                                                                {moduleItem.description && (\n                                                                    <div className=\"text-xs text-muted-foreground mt-1 line-clamp-2\">\n                                                                        {moduleItem.description}\n                                                                    </div>\n                                                                )}\n                                                            </div>\n                                                        </div>\n                                                        {moduleItem.webhookUrl ? (\n                                                            <Badge variant=\"outline\" className=\"text-[10px] shrink-0\">\n                                                                Webhook\n                                                            </Badge>\n                                                        ) : (\n                                                            <Badge variant=\"outline\" className=\"text-[10px] shrink-0\">\n                                                                Link\n                                                            </Badge>\n                                                        )}\n                                                    </div>\n\n                                                    <div className=\"flex items-center gap-2\">\n                                                        {moduleItem.url && (\n                                                            <a href={moduleItem.url} target=\"_blank\" rel=\"noopener noreferrer\" className=\"flex-1\">\n                                                                <Button variant=\"outline\" className=\"w-full\" disabled={isPending}>\n                                                                    <ExternalLink className=\"h-4 w-4 mr-2\" /> 打开\n                                                                </Button>\n                                                            </a>\n                                                        )}\n                                                        {moduleItem.webhookUrl && (\n                                                            <Button\n                                                                className=\"flex-1\"\n                                                                onClick={() => handleRunWebhook(moduleItem)}\n                                                                disabled={isPending}\n                                                            >\n                                                                <Wrench className=\"h-4 w-4 mr-2\" /> 运行\n                                                            </Button>\n                                                        )}\n                                                    </div>\n                                                </CardContent>\n                                            </Card>\n                                        )\n                                    })}\n                                </div>\n                            </div>\n                        ))\n                    )}\n                </TabsContent>\n\n                {canManage && (\n                    <TabsContent value=\"manage\" className=\"space-y-4\">\n                        <div className=\"flex items-center justify-between\">\n                            <div className=\"text-sm text-muted-foreground\">\n                                模块管理仅对合伙人/管理员开放（后端强制权限）。\n                            </div>\n                            <Dialog open={createOpen} onOpenChange={setCreateOpen}>\n                                <DialogTrigger asChild>\n                                    <Button onClick={openCreate}>\n                                        <Plus className=\"h-4 w-4 mr-2\" /> 新建模块\n                                    </Button>\n                                </DialogTrigger>\n                                <DialogContent>\n                                    <DialogHeader>\n                                        <DialogTitle>新建工具模块</DialogTitle>\n                                    </DialogHeader>\n                                    <div className=\"space-y-3\">\n                                        <div className=\"grid gap-2\">\n                                            <Label>名称</Label>\n                                            <Input value={form.name} onChange={(e) => setForm((p) => ({ ...p, name: e.target.value }))} />\n                                        </div>\n                                        <div className=\"grid gap-2\">\n                                            <Label>分类</Label>\n                                            <Select value={form.category} onValueChange={(v) => setForm((p) => ({ ...p, category: v }))}>\n                                                <SelectTrigger>\n                                                    <SelectValue />\n                                                </SelectTrigger>\n                                                <SelectContent>\n                                                    <SelectItem value=\"link\">link（常用链接）</SelectItem>\n                                                    <SelectItem value=\"external\">external（外部工具）</SelectItem>\n                                                    <SelectItem value=\"calculator\">calculator（工具组件）</SelectItem>\n                                                </SelectContent>\n                                            </Select>\n                                        </div>\n                                        <div className=\"grid gap-2\">\n                                            <Label>描述</Label>\n                                            <Input\n                                                value={form.description}\n                                                onChange={(e) => setForm((p) => ({ ...p, description: e.target.value }))}\n                                            />\n                                        </div>\n                                        <div className=\"grid gap-2\">\n                                            <Label>图标（Lucide 名称）</Label>\n                                            <Input value={form.icon} onChange={(e) => setForm((p) => ({ ...p, icon: e.target.value }))} />\n                                        </div>\n                                        <div className=\"grid gap-2\">\n                                            <Label>外链 URL</Label>\n                                            <Input value={form.url} onChange={(e) => setForm((p) => ({ ...p, url: e.target.value }))} />\n                                        </div>\n                                        <div className=\"grid gap-2\">\n                                            <Label>Webhook URL（需 allowlist + https）</Label>\n                                            <Input\n                                                value={form.webhookUrl}\n                                                onChange={(e) => setForm((p) => ({ ...p, webhookUrl: e.target.value }))}\n                                            />\n                                        </div>\n                                        <div className=\"grid grid-cols-2 gap-3\">\n                                            <div className=\"grid gap-2\">\n                                                <Label>排序</Label>\n                                                <Input\n                                                    type=\"number\"\n                                                    value={String(form.sortOrder)}\n                                                    onChange={(e) => setForm((p) => ({ ...p, sortOrder: Number(e.target.value || 0) }))}\n                                                />\n                                            </div>\n                                            <div className=\"grid gap-2\">\n                                                <Label>启用</Label>\n                                                <div className=\"flex items-center h-10\">\n                                                    <Switch checked={form.isActive} onCheckedChange={(v) => setForm((p) => ({ ...p, isActive: v }))} />\n                                                </div>\n                                            </div>\n                                        </div>\n                                    </div>\n                                    <DialogFooter>\n                                        <Button variant=\"outline\" onClick={() => setCreateOpen(false)}>\n                                            取消\n                                        </Button>\n                                        <Button onClick={handleCreate} disabled={isPending || !form.name.trim()}>\n                                            {isPending ? \"处理中...\" : \"确认创建\"}\n                                        </Button>\n                                    </DialogFooter>\n                                </DialogContent>\n                            </Dialog>\n                        </div>\n\n                        {manageLoading ? (\n                            <div className=\"text-sm text-muted-foreground\">正在加载管理列表...</div>\n                        ) : manageModules.length === 0 ? (\n                            <div className=\"text-sm text-muted-foreground\">暂无模块</div>\n                        ) : (\n                            <div className=\"space-y-2\">\n                                {manageModules.map((m) => (\n                                    <Card key={m.id}>\n                                        <CardContent className=\"p-4 flex items-center justify-between gap-4\">\n                                            <div className=\"min-w-0\">\n                                                <div className=\"flex items-center gap-2\">\n                                                    <div className=\"font-medium truncate\">{m.name}</div>\n                                                    <Badge variant=\"secondary\">{m.category}</Badge>\n                                                    {!m.isActive && <Badge variant=\"outline\">已停用</Badge>}\n                                                </div>\n                                                <div className=\"text-xs text-muted-foreground mt-1 truncate\">\n                                                    {m.url ? `URL: ${m.url}` : m.webhookUrl ? \"Webhook 已配置\" : \"未配置 URL/Webhook\"}\n                                                </div>\n                                            </div>\n\n                                            <div className=\"flex items-center gap-2 shrink-0\">\n                                                <div className=\"flex items-center gap-2\">\n                                                    <span className=\"text-xs text-muted-foreground\">启用</span>\n                                                    <Switch\n                                                        checked={m.isActive}\n                                                        onCheckedChange={(v) => handleToggleActive(m, v)}\n                                                        disabled={isPending}\n                                                    />\n                                                </div>\n                                                <Button variant=\"outline\" onClick={() => openEdit(m)} disabled={isPending}>\n                                                    编辑\n                                                </Button>\n                                                <AlertDialog>\n                                                    <AlertDialogTrigger asChild>\n                                                        <Button variant=\"destructive\" disabled={isPending}>\n                                                            删除\n                                                        </Button>\n                                                    </AlertDialogTrigger>\n                                                    <AlertDialogContent>\n                                                        <AlertDialogHeader>\n                                                            <AlertDialogTitle>确认删除</AlertDialogTitle>\n                                                            <AlertDialogDescription>\n                                                                将永久删除模块「{m.name}」，且无法恢复。\n                                                            </AlertDialogDescription>\n                                                        </AlertDialogHeader>\n                                                        <AlertDialogFooter>\n                                                            <AlertDialogCancel>取消</AlertDialogCancel>\n                                                            <AlertDialogAction onClick={() => handleDelete(m.id)}>确认删除</AlertDialogAction>\n                                                        </AlertDialogFooter>\n                                                    </AlertDialogContent>\n                                                </AlertDialog>\n                                            </div>\n                                        </CardContent>\n                                    </Card>\n                                ))}\n                            </div>\n                        )}\n\n                        <Dialog open={editOpen} onOpenChange={setEditOpen}>\n                            <DialogContent>\n                                <DialogHeader>\n                                    <DialogTitle>编辑工具模块</DialogTitle>\n                                </DialogHeader>\n                                <div className=\"space-y-3\">\n                                    <div className=\"grid gap-2\">\n                                        <Label>名称</Label>\n                                        <Input value={form.name} onChange={(e) => setForm((p) => ({ ...p, name: e.target.value }))} />\n                                    </div>\n                                    <div className=\"grid gap-2\">\n                                        <Label>分类</Label>\n                                        <Select value={form.category} onValueChange={(v) => setForm((p) => ({ ...p, category: v }))}>\n                                            <SelectTrigger>\n                                                <SelectValue />\n                                            </SelectTrigger>\n                                            <SelectContent>\n                                                <SelectItem value=\"link\">link（常用链接）</SelectItem>\n                                                <SelectItem value=\"external\">external（外部工具）</SelectItem>\n                                                <SelectItem value=\"calculator\">calculator（工具组件）</SelectItem>\n                                            </SelectContent>\n                                        </Select>\n                                    </div>\n                                    <div className=\"grid gap-2\">\n                                        <Label>描述</Label>\n                                        <Input value={form.description} onChange={(e) => setForm((p) => ({ ...p, description: e.target.value }))} />\n                                    </div>\n                                    <div className=\"grid gap-2\">\n                                        <Label>图标（Lucide 名称）</Label>\n                                        <Input value={form.icon} onChange={(e) => setForm((p) => ({ ...p, icon: e.target.value }))} />\n                                    </div>\n                                    <div className=\"grid gap-2\">\n                                        <Label>外链 URL</Label>\n                                        <Input value={form.url} onChange={(e) => setForm((p) => ({ ...p, url: e.target.value }))} />\n                                    </div>\n                                    <div className=\"grid gap-2\">\n                                        <Label>Webhook URL（需 allowlist + https）</Label>\n                                        <Input value={form.webhookUrl} onChange={(e) => setForm((p) => ({ ...p, webhookUrl: e.target.value }))} />\n                                    </div>\n                                    <div className=\"grid grid-cols-2 gap-3\">\n                                        <div className=\"grid gap-2\">\n                                            <Label>排序</Label>\n                                            <Input\n                                                type=\"number\"\n                                                value={String(form.sortOrder)}\n                                                onChange={(e) => setForm((p) => ({ ...p, sortOrder: Number(e.target.value || 0) }))}\n                                            />\n                                        </div>\n                                        <div className=\"grid gap-2\">\n                                            <Label>启用</Label>\n                                            <div className=\"flex items-center h-10\">\n                                                <Switch checked={form.isActive} onCheckedChange={(v) => setForm((p) => ({ ...p, isActive: v }))} />\n                                            </div>\n                                        </div>\n                                    </div>\n                                </div>\n                                <DialogFooter>\n                                    <Button variant=\"outline\" onClick={() => setEditOpen(false)}>\n                                        取消\n                                    </Button>\n                                    <Button onClick={handleUpdate} disabled={isPending || !form.name.trim()}>\n                                        {isPending ? \"处理中...\" : \"确认保存\"}\n                                    </Button>\n                                </DialogFooter>\n                            </DialogContent>\n                        </Dialog>\n                    </TabsContent>\n                )}\n            </Tabs>\n        </div>\n    )\n}\n","usedDeprecatedRules":[]},{"filePath":"D:\\Desktop\\LawClick_NEW\\lawclick-next\\src\\app\\actions.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\Desktop\\LawClick_NEW\\lawclick-next\\src\\app\\api\\auth\\[...nextauth]\\route.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\Desktop\\LawClick_NEW\\lawclick-next\\src\\app\\api\\documents\\[id]\\file\\route.ts","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":11,"column":57,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":11,"endColumn":60,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[483,486],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[483,486],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":12,"column":29,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":12,"endColumn":32,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[540,543],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[540,543],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":14,"column":20,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":14,"endColumn":23,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[582,585],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[582,585],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":3,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { GetObjectCommand } from \"@aws-sdk/client-s3\"\nimport { prisma } from \"@/lib/prisma\"\nimport { BUCKET_NAME, s3Client } from \"@/lib/s3\"\nimport { AuthError, getSessionUserOrThrow, PermissionError, requireCaseAccess, requirePermission } from \"@/lib/server-auth\"\nimport { NextRequest, NextResponse } from \"next/server\"\nimport { Readable } from \"stream\"\n\nexport const runtime = \"nodejs\"\n\nfunction toWebStream(body: unknown) {\n    if (body instanceof Readable && typeof (Readable as any).toWeb === \"function\") {\n        return (Readable as any).toWeb(body)\n    }\n    return body as any\n}\n\nexport async function GET(\n    request: NextRequest,\n    { params }: { params: Promise<{ id: string }> }\n) {\n    try {\n        const { id } = await params\n        const url = new URL(request.url)\n        const versionId = url.searchParams.get(\"versionId\")\n        const download = url.searchParams.get(\"download\") === \"1\"\n\n        const user = await getSessionUserOrThrow()\n        requirePermission(user.role, \"document:view\")\n\n        const document = await prisma.document.findUnique({\n            where: { id },\n            select: {\n                id: true,\n                title: true,\n                caseId: true,\n                fileUrl: true,\n                fileType: true,\n            },\n        })\n\n        if (!document) {\n            return NextResponse.json({ error: \"文档不存在\" }, { status: 404 })\n        }\n\n        await requireCaseAccess(document.caseId, user.id, user.role, \"case:view\")\n\n        let fileKey = document.fileUrl\n        let fileType = document.fileType || \"application/octet-stream\"\n        let filename = document.title || \"document\"\n\n        if (versionId) {\n            const version = await prisma.documentVersion.findUnique({\n                where: { id: versionId },\n                select: { id: true, documentId: true, version: true, fileKey: true, fileType: true },\n            })\n            if (!version || version.documentId !== document.id) {\n                return NextResponse.json({ error: \"版本不存在\" }, { status: 404 })\n            }\n\n            fileKey = version.fileKey\n            fileType = version.fileType || fileType\n            filename = `${filename}_v${version.version}`\n        }\n\n        if (!fileKey) {\n            return NextResponse.json({ error: \"文档尚未上传文件\" }, { status: 404 })\n        }\n\n        const object = await s3Client.send(\n            new GetObjectCommand({\n                Bucket: BUCKET_NAME,\n                Key: fileKey,\n            })\n        )\n\n        if (!object.Body) {\n            return NextResponse.json({ error: \"文件不存在\" }, { status: 404 })\n        }\n\n        const headers = new Headers()\n        headers.set(\"Content-Type\", fileType)\n        headers.set(\"Cache-Control\", \"private, no-store\")\n        headers.set(\"X-Content-Type-Options\", \"nosniff\")\n\n        const disposition = download ? \"attachment\" : \"inline\"\n        headers.set(\n            \"Content-Disposition\",\n            `${disposition}; filename*=UTF-8''${encodeURIComponent(filename)}`\n        )\n\n        return new Response(toWebStream(object.Body), { headers })\n    } catch (error) {\n        if (error instanceof AuthError) {\n            return NextResponse.json({ error: error.message }, { status: 401 })\n        }\n        if (error instanceof PermissionError) {\n            return NextResponse.json({ error: error.message }, { status: 403 })\n        }\n        console.error(\"下载/预览文档失败:\", error)\n        return NextResponse.json({ error: \"下载/预览文档失败\" }, { status: 500 })\n    }\n}\n\n","usedDeprecatedRules":[]},{"filePath":"D:\\Desktop\\LawClick_NEW\\lawclick-next\\src\\app\\api\\queue\\process\\route.ts","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'error' is defined but never used.","line":14,"column":14,"nodeType":null,"messageId":"unusedVar","endLine":14,"endColumn":19}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { NextResponse } from \"next/server\"\r\nimport { queue } from \"@/lib/queue\"\r\n\r\n// API to manually trigger queue processing (e.g., via Cron or Admin Button)\r\nexport async function POST() {\r\n    try {\r\n        const jobId = await queue.processNext()\r\n\r\n        if (!jobId) {\r\n            return NextResponse.json({ processed: false, message: \"No pending jobs\" })\r\n        }\r\n\r\n        return NextResponse.json({ processed: true, jobId })\r\n    } catch (error) {\r\n        return NextResponse.json({ error: \"Failed to process queue\" }, { status: 500 })\r\n    }\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"D:\\Desktop\\LawClick_NEW\\lawclick-next\\src\\app\\layout.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\Desktop\\LawClick_NEW\\lawclick-next\\src\\auth.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\Desktop\\LawClick_NEW\\lawclick-next\\src\\components\\admin\\ApprovalsBoardClient.tsx","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":82,"column":45,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":82,"endColumn":48,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[3084,3087],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[3084,3087],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":102,"column":52,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":102,"endColumn":55,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[3882,3885],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[3882,3885],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":515,"column":61,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":515,"endColumn":64,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[24907,24910],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[24907,24910],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'e' is defined but never used.","line":541,"column":42,"nodeType":null,"messageId":"unusedVar","endLine":541,"endColumn":43}],"suppressedMessages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":44,"column":67,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":44,"endColumn":70,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1508,1511],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1508,1511],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}],"suppressions":[{"kind":"directive","justification":""}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":74,"column":21,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":74,"endColumn":24,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[2771,2774],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[2771,2774],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}],"suppressions":[{"kind":"directive","justification":""}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":76,"column":22,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":76,"endColumn":25,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[2865,2868],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[2865,2868],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}],"suppressions":[{"kind":"directive","justification":""}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":78,"column":18,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":78,"endColumn":21,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[2955,2958],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[2955,2958],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}],"suppressions":[{"kind":"directive","justification":""}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":145,"column":43,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":145,"endColumn":46,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[5079,5082],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[5079,5082],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}],"suppressions":[{"kind":"directive","justification":""}]}],"errorCount":0,"fatalErrorCount":0,"warningCount":4,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\"\n\nimport { useMemo, useState } from \"react\"\nimport Link from \"next/link\"\nimport { useRouter } from \"next/navigation\"\nimport { useSession } from \"next-auth/react\"\nimport { toast } from \"sonner\"\nimport {\n    Bot,\n    Calendar,\n    CheckCircle2,\n    Clock,\n    FileCheck,\n    FileText,\n    MoreHorizontal,\n    Receipt,\n    RefreshCw,\n    ShoppingCart,\n    XCircle,\n} from \"lucide-react\"\n\nimport {\n    approveRequest,\n    cancelRequest,\n    createApprovalRequest,\n    getAvailableApprovers,\n    rejectRequest,\n} from \"@/actions/approval-actions\"\nimport { getCases } from \"@/actions/cases\"\nimport { Badge } from \"@/components/ui/badge\"\nimport { Button } from \"@/components/ui/button\"\nimport { Card, CardContent } from \"@/components/ui/card\"\nimport { Dialog, DialogContent, DialogFooter, DialogHeader, DialogTitle, DialogTrigger } from \"@/components/ui/dialog\"\nimport { Input } from \"@/components/ui/input\"\nimport { Label } from \"@/components/ui/label\"\nimport { Tabs, TabsContent, TabsList, TabsTrigger } from \"@/components/ui/tabs\"\nimport { Textarea } from \"@/components/ui/textarea\"\nimport { Avatar, AvatarFallback, AvatarImage } from \"@/components/ui/avatar\"\nimport { usePermission } from \"@/hooks/use-permission\"\nimport { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from \"@/components/ui/select\"\nimport { useFloatStore } from \"@/store/float-store\"\n\n// eslint-disable-next-line @typescript-eslint/no-explicit-any\nconst APPROVAL_TYPE_CONFIG: Record<string, { label: string; icon: any; color: string }> = {\n    LEAVE: { label: \"请假申请\", icon: Calendar, color: \"bg-blue-500\" },\n    EXPENSE: { label: \"报销申请\", icon: Receipt, color: \"bg-green-500\" },\n    PURCHASE: { label: \"采购申请\", icon: ShoppingCart, color: \"bg-orange-500\" },\n    CONTRACT: { label: \"合同审批\", icon: FileText, color: \"bg-purple-500\" },\n    INVOICE: { label: \"发票申请\", icon: FileCheck, color: \"bg-cyan-500\" },\n    OTHER: { label: \"其他审批\", icon: MoreHorizontal, color: \"bg-gray-500\" },\n}\n\nconst STATUS_CONFIG: Record<string, { label: string; color: string }> = {\n    DRAFT: { label: \"草稿\", color: \"bg-gray-500\" },\n    PENDING: { label: \"待审批\", color: \"bg-yellow-500\" },\n    APPROVED: { label: \"已批准\", color: \"bg-green-500\" },\n    REJECTED: { label: \"已驳回\", color: \"bg-red-500\" },\n    CANCELLED: { label: \"已撤回\", color: \"bg-gray-400\" },\n}\n\nfunction safeCurrency(amount?: number | string | null) {\n    if (amount === null || amount === undefined) return \"\"\n    const num = typeof amount === \"number\" ? amount : Number(amount)\n    if (!Number.isFinite(num)) return \"\"\n    return `￥${num.toLocaleString()}`\n}\n\nexport function ApprovalsBoardClient({\n    initialPending,\n    initialApproved,\n    initialMine,\n}: {\n    // eslint-disable-next-line @typescript-eslint/no-explicit-any\n    initialPending: any[]\n    // eslint-disable-next-line @typescript-eslint/no-explicit-any\n    initialApproved: any[]\n    // eslint-disable-next-line @typescript-eslint/no-explicit-any\n    initialMine: any[]\n}) {\n    const router = useRouter()\n    const { data: session } = useSession()\n    const currentUserId = (session?.user as any)?.id as string | undefined\n    const { can } = usePermission()\n    const { openWindow } = useFloatStore()\n\n    const canApprove = can(\"approval:approve\")\n    const canCreate = can(\"approval:create\")\n\n    const pending = initialPending\n    const approved = initialApproved\n    const mine = initialMine\n\n    const refresh = () => router.refresh()\n\n    const myPendingCount = useMemo(() => mine.filter((a) => a.status === \"PENDING\").length, [mine])\n\n    // 创建审批 Dialog\n    const [createOpen, setCreateOpen] = useState(false)\n    const [creating, setCreating] = useState(false)\n    const [approvers, setApprovers] = useState<{ id: string; name: string | null; department?: string | null }[]>([])\n    const [caseQuery, setCaseQuery] = useState(\"\")\n    const [caseResults, setCaseResults] = useState<any[]>([])\n    const [pickedCase, setPickedCase] = useState<{ id: string; title: string; caseCode?: string | null } | null>(null)\n\n    const [draft, setDraft] = useState({\n        type: \"LEAVE\",\n        title: \"\",\n        description: \"\",\n        amount: \"\",\n        approverId: \"\",\n        submit: true,\n        extra: \"\",\n    })\n\n    const openCreate = async () => {\n        if (!canCreate) {\n            toast.error(\"无权限\", { description: \"缺少 approval:create\" })\n            return\n        }\n        setCreateOpen(true)\n        try {\n            const res = await getAvailableApprovers()\n            if (res.success) setApprovers(res.data)\n        } catch {\n            // ignore\n        }\n    }\n\n    const searchCases = async (q: string) => {\n        const query = q.trim()\n        setCaseQuery(q)\n        if (query.length < 2) {\n            setCaseResults([])\n            return\n        }\n        try {\n            const rows = await getCases(query, \"all\", \"all\")\n            setCaseResults((rows || []).slice(0, 10))\n        } catch {\n            setCaseResults([])\n        }\n    }\n\n    // eslint-disable-next-line @typescript-eslint/no-explicit-any\n    const renderApprovalCard = (approval: any) => {\n        const typeConfig = APPROVAL_TYPE_CONFIG[approval.type] || APPROVAL_TYPE_CONFIG.OTHER\n        const statusConfig = STATUS_CONFIG[approval.status] || STATUS_CONFIG.PENDING\n        const TypeIcon = typeConfig.icon\n\n        const canCancel = !!currentUserId && approval.requesterId === currentUserId && (approval.status === \"DRAFT\" || approval.status === \"PENDING\")\n\n        return (\n            <Card key={approval.id} className=\"hover:shadow-md transition-shadow\">\n                <CardContent className=\"p-4 space-y-3\">\n                    <div className=\"flex items-start justify-between gap-4\">\n                        <div className=\"flex items-center gap-3 min-w-0\">\n                            <div className={`p-2 rounded-lg ${typeConfig.color}/10`}>\n                                <TypeIcon className={`h-5 w-5 ${typeConfig.color.replace(\"bg-\", \"text-\")}`} />\n                            </div>\n                            <div className=\"min-w-0\">\n                                <h3 className=\"font-medium truncate\">{approval.title}</h3>\n                                <div className=\"flex flex-wrap items-center gap-2 mt-1 text-sm text-muted-foreground\">\n                                    <span>{typeConfig.label}</span>\n                                    {approval.amount ? <span className=\"font-medium text-foreground\">{safeCurrency(approval.amount)}</span> : null}\n                                    {approval.case ? (\n                                        <Link href={`/cases/${approval.case.id}`} className=\"text-primary hover:underline\">\n                                            {approval.case.caseCode || \"案件\"} · {approval.case.title}\n                                        </Link>\n                                    ) : null}\n                                </div>\n                            </div>\n                        </div>\n                        <div className=\"flex items-center gap-2 shrink-0\">\n                            <Button\n                                size=\"icon\"\n                                variant=\"outline\"\n                                onClick={() =>\n                                    openWindow(\n                                        \"ai-paralegal\",\n                                        \"AI_PARALEGAL\",\n                                        \"AI 助手 · 审批\",\n                                        {\n                                            approvalId: approval.id,\n                                            caseId: approval.case?.id || approval.caseId || null,\n                                            source: \"approval_center\",\n                                        }\n                                    )\n                                }\n                                title=\"AI 辅助（带审批上下文）\"\n                            >\n                                <Bot className=\"h-4 w-4\" />\n                            </Button>\n                            <Badge className={`${statusConfig.color} text-white`}>{statusConfig.label}</Badge>\n                        </div>\n                    </div>\n\n                    <div className=\"flex items-center justify-between pt-2 border-t\">\n                        <div className=\"flex items-center gap-2 min-w-0\">\n                            <Avatar className=\"h-6 w-6\">\n                                <AvatarImage src={approval.requester?.avatarUrl} />\n                                <AvatarFallback>{approval.requester?.name?.[0] || \"?\"}</AvatarFallback>\n                            </Avatar>\n                            <span className=\"text-sm text-muted-foreground truncate\">{approval.requester?.name}</span>\n                        </div>\n                        <div className=\"flex items-center gap-2 text-sm text-muted-foreground\">\n                            <Clock className=\"h-3 w-3\" />\n                            {new Date(approval.createdAt).toLocaleDateString(\"zh-CN\")}\n                        </div>\n                    </div>\n\n                    {approval.status === \"PENDING\" && canApprove ? (\n                        <div className=\"flex gap-2\">\n                            <Button\n                                size=\"sm\"\n                                className=\"flex-1 bg-green-600 hover:bg-green-700\"\n                                onClick={async () => {\n                                    const res = await approveRequest(approval.id)\n                                    if (!res.success) {\n                                        toast.error(\"审批失败\", { description: res.error })\n                                        return\n                                    }\n                                    toast.success(\"已批准\")\n                                    refresh()\n                                }}\n                            >\n                                <CheckCircle2 className=\"h-4 w-4 mr-1\" />\n                                批准\n                            </Button>\n                            <Button\n                                size=\"sm\"\n                                variant=\"outline\"\n                                className=\"flex-1 border-red-200 text-red-600 hover:bg-red-50\"\n                                onClick={async () => {\n                                    const res = await rejectRequest(approval.id)\n                                    if (!res.success) {\n                                        toast.error(\"驳回失败\", { description: res.error })\n                                        return\n                                    }\n                                    toast.success(\"已驳回\")\n                                    refresh()\n                                }}\n                            >\n                                <XCircle className=\"h-4 w-4 mr-1\" />\n                                驳回\n                            </Button>\n                        </div>\n                    ) : null}\n\n                    {canCancel ? (\n                        <Button\n                            size=\"sm\"\n                            variant=\"outline\"\n                            className=\"w-full\"\n                            onClick={async () => {\n                                const res = await cancelRequest(approval.id)\n                                if (!res.success) {\n                                    toast.error(\"撤回失败\", { description: res.error })\n                                    return\n                                }\n                                toast.success(\"已撤回\")\n                                refresh()\n                            }}\n                        >\n                            撤回申请\n                        </Button>\n                    ) : null}\n                </CardContent>\n            </Card>\n        )\n    }\n\n    return (\n        <div className=\"space-y-6\">\n            <div className=\"flex items-center justify-between gap-4\">\n                <div>\n                    <h1 className=\"text-2xl font-bold\">审批中心</h1>\n                    <p className=\"text-muted-foreground\">行政审批与案件关联审批（真实落库）</p>\n                </div>\n                <div className=\"flex gap-2\">\n                    <Button variant=\"outline\" onClick={() => refresh()} className=\"gap-2\">\n                        <RefreshCw className=\"h-4 w-4\" />\n                        刷新\n                    </Button>\n                    <Button onClick={openCreate} disabled={!canCreate}>\n                        新建申请\n                    </Button>\n                </div>\n            </div>\n\n            <div className=\"grid grid-cols-1 md:grid-cols-4 gap-4\">\n                <Card>\n                    <CardContent className=\"p-4 flex items-center gap-4\">\n                        <div className=\"p-3 rounded-full bg-yellow-500/10\">\n                            <Clock className=\"h-6 w-6 text-yellow-500\" />\n                        </div>\n                        <div>\n                            <p className=\"text-2xl font-bold\">{pending.length}</p>\n                            <p className=\"text-sm text-muted-foreground\">待审批</p>\n                        </div>\n                    </CardContent>\n                </Card>\n                <Card>\n                    <CardContent className=\"p-4 flex items-center gap-4\">\n                        <div className=\"p-3 rounded-full bg-green-500/10\">\n                            <CheckCircle2 className=\"h-6 w-6 text-green-500\" />\n                        </div>\n                        <div>\n                            <p className=\"text-2xl font-bold\">{approved.length}</p>\n                            <p className=\"text-sm text-muted-foreground\">已处理</p>\n                        </div>\n                    </CardContent>\n                </Card>\n                <Card>\n                    <CardContent className=\"p-4 flex items-center gap-4\">\n                        <div className=\"p-3 rounded-full bg-blue-500/10\">\n                            <FileText className=\"h-6 w-6 text-blue-500\" />\n                        </div>\n                        <div>\n                            <p className=\"text-2xl font-bold\">{mine.length}</p>\n                            <p className=\"text-sm text-muted-foreground\">我发起的</p>\n                        </div>\n                    </CardContent>\n                </Card>\n                <Card>\n                    <CardContent className=\"p-4 flex items-center gap-4\">\n                        <div className=\"p-3 rounded-full bg-purple-500/10\">\n                            <RefreshCw className=\"h-6 w-6 text-purple-500\" />\n                        </div>\n                        <div>\n                            <p className=\"text-2xl font-bold\">{myPendingCount}</p>\n                            <p className=\"text-sm text-muted-foreground\">审批中</p>\n                        </div>\n                    </CardContent>\n                </Card>\n            </div>\n\n            <Tabs defaultValue=\"pending\" className=\"space-y-4\" onValueChange={() => {}}>\n                <TabsList>\n                    <TabsTrigger value=\"pending\" className=\"gap-2\">\n                        待审批 <Badge variant=\"secondary\">{pending.length}</Badge>\n                    </TabsTrigger>\n                    <TabsTrigger value=\"approved\">已处理</TabsTrigger>\n                    <TabsTrigger value=\"mine\">我发起的</TabsTrigger>\n                </TabsList>\n\n                <TabsContent value=\"pending\" className=\"space-y-4\">\n                    {pending.length > 0 ? (\n                        <div className=\"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4\">\n                            {pending.map(renderApprovalCard)}\n                        </div>\n                    ) : (\n                        <Card>\n                            <CardContent className=\"flex flex-col items-center justify-center py-12\">\n                                <CheckCircle2 className=\"h-12 w-12 text-green-500 mb-4\" />\n                                <p className=\"text-lg font-medium\">暂无待审批事项</p>\n                                <p className=\"text-muted-foreground\">所有审批已处理完毕</p>\n                            </CardContent>\n                        </Card>\n                    )}\n                </TabsContent>\n\n                <TabsContent value=\"approved\" className=\"space-y-4\">\n                    {approved.length > 0 ? (\n                        <div className=\"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4\">\n                            {approved.map(renderApprovalCard)}\n                        </div>\n                    ) : (\n                        <Card>\n                            <CardContent className=\"flex flex-col items-center justify-center py-12\">\n                                <FileText className=\"h-12 w-12 text-muted-foreground mb-4\" />\n                                <p className=\"text-lg font-medium\">暂无已处理记录</p>\n                            </CardContent>\n                        </Card>\n                    )}\n                </TabsContent>\n\n                <TabsContent value=\"mine\" className=\"space-y-4\">\n                    {mine.length > 0 ? (\n                        <div className=\"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4\">\n                            {mine.map(renderApprovalCard)}\n                        </div>\n                    ) : (\n                        <Card>\n                            <CardContent className=\"flex flex-col items-center justify-center py-12\">\n                                <FileText className=\"h-12 w-12 text-muted-foreground mb-4\" />\n                                <p className=\"text-lg font-medium\">暂无发起的申请</p>\n                                <p className=\"text-muted-foreground\">点击右上角“新建申请”开始</p>\n                            </CardContent>\n                        </Card>\n                    )}\n                </TabsContent>\n            </Tabs>\n\n            <Dialog open={createOpen} onOpenChange={setCreateOpen}>\n                <DialogTrigger asChild>\n                    <span />\n                </DialogTrigger>\n                <DialogContent className=\"sm:max-w-[760px]\">\n                    <DialogHeader>\n                        <DialogTitle>新建审批申请</DialogTitle>\n                    </DialogHeader>\n\n                    <div className=\"grid grid-cols-1 md:grid-cols-2 gap-4\">\n                        <div className=\"space-y-2\">\n                            <Label>类型</Label>\n                            <Select value={draft.type} onValueChange={(v) => setDraft((p) => ({ ...p, type: v }))}>\n                                <SelectTrigger>\n                                    <SelectValue placeholder=\"选择审批类型\" />\n                                </SelectTrigger>\n                                <SelectContent>\n                                    {Object.keys(APPROVAL_TYPE_CONFIG).map((k) => (\n                                        <SelectItem key={k} value={k}>\n                                            {APPROVAL_TYPE_CONFIG[k]?.label || k}\n                                        </SelectItem>\n                                    ))}\n                                </SelectContent>\n                            </Select>\n                        </div>\n\n                        <div className=\"space-y-2\">\n                            <Label>审批人</Label>\n                            <Select\n                                value={draft.approverId || \"__none__\"}\n                                onValueChange={(v) => setDraft((p) => ({ ...p, approverId: v === \"__none__\" ? \"\" : v }))}\n                            >\n                                <SelectTrigger>\n                                    <SelectValue placeholder=\"选择审批人（可选）\" />\n                                </SelectTrigger>\n                                <SelectContent>\n                                    <SelectItem value=\"__none__\">不指定（可被有权限者处理）</SelectItem>\n                                    {approvers.map((a) => (\n                                        <SelectItem key={a.id} value={a.id}>\n                                            {a.name || a.id.slice(0, 6)}\n                                        </SelectItem>\n                                    ))}\n                                </SelectContent>\n                            </Select>\n                        </div>\n\n                        <div className=\"space-y-2 md:col-span-2\">\n                            <Label>标题</Label>\n                            <Input value={draft.title} onChange={(e) => setDraft((p) => ({ ...p, title: e.target.value }))} placeholder=\"例如：请假申请 / 报销申请...\" />\n                        </div>\n\n                        <div className=\"space-y-2 md:col-span-2\">\n                            <Label>说明</Label>\n                            <Textarea value={draft.description} onChange={(e) => setDraft((p) => ({ ...p, description: e.target.value }))} rows={3} placeholder=\"补充说明...\" />\n                        </div>\n\n                        <div className=\"space-y-2\">\n                            <Label>金额（可选）</Label>\n                            <Input value={draft.amount} onChange={(e) => setDraft((p) => ({ ...p, amount: e.target.value }))} placeholder=\"例如：860\" />\n                        </div>\n\n                        <div className=\"space-y-2\">\n                            <Label>关联案件（可选）</Label>\n                            {pickedCase ? (\n                                <div className=\"flex items-center justify-between rounded-md border px-3 py-2\">\n                                    <div className=\"text-sm\">\n                                        {pickedCase.caseCode ? `${pickedCase.caseCode} · ` : \"\"}\n                                        {pickedCase.title}\n                                    </div>\n                                    <Button variant=\"ghost\" size=\"sm\" onClick={() => setPickedCase(null)}>\n                                        清除\n                                    </Button>\n                                </div>\n                            ) : (\n                                <div className=\"space-y-2\">\n                                    <Input value={caseQuery} onChange={(e) => searchCases(e.target.value)} placeholder=\"搜索案件（按标题/案号/客户）\" />\n                                    {caseResults.length > 0 ? (\n                                        <div className=\"max-h-40 overflow-auto rounded-md border bg-white/50 p-2 space-y-1\">\n                                            {caseResults.map((c) => (\n                                                <button\n                                                    key={c.id}\n                                                    type=\"button\"\n                                                    className=\"w-full text-left text-sm px-2 py-1 rounded hover:bg-slate-50\"\n                                                    onClick={() => {\n                                                        setPickedCase({ id: c.id, title: c.title, caseCode: c.caseCode })\n                                                        setCaseResults([])\n                                                        setCaseQuery(\"\")\n                                                    }}\n                                                >\n                                                    {c.caseCode ? `${c.caseCode} · ` : \"\"}\n                                                    {c.title}\n                                                </button>\n                                            ))}\n                                        </div>\n                                    ) : null}\n                                </div>\n                            )}\n                        </div>\n\n                        <div className=\"space-y-2 md:col-span-2\">\n                            <Label>补充信息（可选）</Label>\n                            <Textarea value={draft.extra} onChange={(e) => setDraft((p) => ({ ...p, extra: e.target.value }))} rows={2} placeholder=\"例如：出差地点、请假原因、采购明细等\" />\n                        </div>\n                    </div>\n\n                    <DialogFooter>\n                        <Button variant=\"outline\" onClick={() => setCreateOpen(false)} disabled={creating}>\n                            取消\n                        </Button>\n                        <Button\n                            disabled={creating || !draft.title.trim()}\n                            onClick={async () => {\n                                setCreating(true)\n                                try {\n                                    const amount = draft.amount.trim() ? Number(draft.amount.trim()) : undefined\n                                    if (draft.amount.trim() && Number.isNaN(amount)) {\n                                        toast.error(\"金额格式不正确\")\n                                        return\n                                    }\n\n                                    const res = await createApprovalRequest({\n                                        type: draft.type as any,\n                                        title: draft.title.trim(),\n                                        description: draft.description.trim() || undefined,\n                                        amount,\n                                        approverId: draft.approverId || undefined,\n                                        caseId: pickedCase?.id,\n                                        metadata: draft.extra.trim() ? { extra: draft.extra.trim() } : {},\n                                        submit: true,\n                                    })\n                                    if (!res.success) {\n                                        toast.error(\"创建失败\", { description: res.error })\n                                        return\n                                    }\n                                    toast.success(\"已提交审批\")\n                                    setCreateOpen(false)\n                                    setPickedCase(null)\n                                    setDraft({\n                                        type: \"LEAVE\",\n                                        title: \"\",\n                                        description: \"\",\n                                        amount: \"\",\n                                        approverId: \"\",\n                                        submit: true,\n                                        extra: \"\",\n                                    })\n                                    refresh()\n                                } catch (e) {\n                                    toast.error(\"创建失败\")\n                                } finally {\n                                    setCreating(false)\n                                }\n                            }}\n                        >\n                            {creating ? \"提交中...\" : \"提交\"}\n                        </Button>\n                    </DialogFooter>\n                </DialogContent>\n            </Dialog>\n        </div>\n    )\n}\n","usedDeprecatedRules":[]},{"filePath":"D:\\Desktop\\LawClick_NEW\\lawclick-next\\src\\components\\admin\\FinanceCenterClient.tsx","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":46,"column":42,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":46,"endColumn":45,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1805,1808],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1805,1808],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":354,"column":118,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":354,"endColumn":121,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[21394,21397],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[21394,21397],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":58,"column":15,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":58,"endColumn":18,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[2108,2111],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[2108,2111],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}],"suppressions":[{"kind":"directive","justification":""}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":60,"column":15,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":60,"endColumn":18,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[2195,2198],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[2195,2198],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}],"suppressions":[{"kind":"directive","justification":""}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":62,"column":16,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":62,"endColumn":19,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[2283,2286],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[2283,2286],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}],"suppressions":[{"kind":"directive","justification":""}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":64,"column":12,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":64,"endColumn":15,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[2367,2370],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[2367,2370],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}],"suppressions":[{"kind":"directive","justification":""}]}],"errorCount":0,"fatalErrorCount":0,"warningCount":2,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\"\n\nimport Link from \"next/link\"\nimport { useRouter } from \"next/navigation\"\nimport { useMemo, useState } from \"react\"\nimport { toast } from \"sonner\"\nimport {\n    AlertCircle,\n    Bot,\n    Clock,\n    DollarSign,\n    FileText,\n    Receipt,\n    ShieldCheck,\n} from \"lucide-react\"\n\nimport { updateContractStatus } from \"@/actions/contract-actions\"\nimport { Badge } from \"@/components/ui/badge\"\nimport { Button } from \"@/components/ui/button\"\nimport { Card, CardContent } from \"@/components/ui/card\"\nimport { Tabs, TabsContent, TabsList, TabsTrigger } from \"@/components/ui/tabs\"\nimport { usePermission } from \"@/hooks/use-permission\"\nimport { CreateContractDialog } from \"@/components/finance/CreateContractDialog\"\nimport { CreateExpenseDialog } from \"@/components/finance/CreateExpenseDialog\"\nimport { CreateInvoiceDialog } from \"@/components/finance/CreateInvoiceDialog\"\nimport { RecordPaymentDialog } from \"@/components/finance/RecordPaymentDialog\"\nimport { useFloatStore } from \"@/store/float-store\"\n\nconst INVOICE_STATUS_CONFIG: Record<string, { label: string; color: string }> = {\n    DRAFT: { label: \"草稿\", color: \"bg-gray-500\" },\n    PENDING: { label: \"待付款\", color: \"bg-yellow-500\" },\n    PAID: { label: \"已付款\", color: \"bg-green-500\" },\n    PARTIAL: { label: \"部分付款\", color: \"bg-blue-500\" },\n    OVERDUE: { label: \"逾期\", color: \"bg-red-500\" },\n    CANCELLED: { label: \"已取消\", color: \"bg-gray-400\" },\n}\n\nconst CONTRACT_STATUS_CONFIG: Record<string, { label: string; color: string }> = {\n    DRAFT: { label: \"草稿\", color: \"bg-gray-500\" },\n    SIGNED: { label: \"已签署\", color: \"bg-blue-500\" },\n    ACTIVE: { label: \"生效中\", color: \"bg-green-500\" },\n    EXPIRED: { label: \"已到期\", color: \"bg-orange-500\" },\n    CANCELLED: { label: \"已作废\", color: \"bg-gray-400\" },\n}\n\nfunction sumPayments(payments: { amount: any }[] | undefined) {\n    if (!payments) return 0\n    return payments.reduce((sum, p) => sum + Number(p.amount || 0), 0)\n}\n\nexport function FinanceCenterClient({\n    invoices,\n    expenses,\n    contracts,\n    stats,\n}: {\n    // eslint-disable-next-line @typescript-eslint/no-explicit-any\n    invoices: any[]\n    // eslint-disable-next-line @typescript-eslint/no-explicit-any\n    expenses: any[]\n    // eslint-disable-next-line @typescript-eslint/no-explicit-any\n    contracts: any[]\n    // eslint-disable-next-line @typescript-eslint/no-explicit-any\n    stats: any | null\n}) {\n    const router = useRouter()\n    const { can } = usePermission()\n    const canEdit = can(\"billing:edit\")\n    const { openWindow } = useFloatStore()\n\n    const [updatingContractId, setUpdatingContractId] = useState<string | null>(null)\n    const [optimisticContractStatus, setOptimisticContractStatus] = useState<Record<string, string>>({})\n\n    const totalAmount = useMemo(() => Number(stats?.totalAmount || 0), [stats])\n    const pendingAmount = useMemo(() => Number(stats?.pendingAmount || 0), [stats])\n    const paidAmount = useMemo(() => Number(stats?.paidAmount || 0), [stats])\n    const overdueAmount = useMemo(() => Number(stats?.overdueAmount || 0), [stats])\n\n    return (\n        <div className=\"space-y-6\">\n            <div className=\"flex items-center justify-between gap-4\">\n                <div>\n                    <h1 className=\"text-2xl font-bold\">财务中心</h1>\n                    <p className=\"text-muted-foreground\">发票管理、收款跟进、费用台账与合同台账</p>\n                </div>\n                <div className=\"flex gap-2 flex-wrap justify-end\">\n                    <CreateExpenseDialog triggerVariant=\"outline\" />\n                    <CreateInvoiceDialog />\n                    <CreateContractDialog triggerVariant=\"outline\" triggerLabel=\"创建合同\" />\n                </div>\n            </div>\n\n            {stats ? (\n                <div className=\"grid grid-cols-1 md:grid-cols-4 gap-4\">\n                    <Card>\n                        <CardContent className=\"p-6\">\n                            <div className=\"flex items-center justify-between\">\n                                <div>\n                                    <p className=\"text-sm text-muted-foreground\">总应收</p>\n                                    <p className=\"text-2xl font-bold\">￥{Number(totalAmount).toLocaleString()}</p>\n                                </div>\n                                <div className=\"p-3 rounded-full bg-primary/10\">\n                                    <DollarSign className=\"h-6 w-6 text-primary\" />\n                                </div>\n                            </div>\n                        </CardContent>\n                    </Card>\n                    <Card>\n                        <CardContent className=\"p-6\">\n                            <div className=\"flex items-center justify-between\">\n                                <div>\n                                    <p className=\"text-sm text-muted-foreground\">待收款</p>\n                                    <p className=\"text-2xl font-bold text-yellow-700\">￥{Number(pendingAmount).toLocaleString()}</p>\n                                    <p className=\"text-xs text-muted-foreground mt-1\">{stats.pendingCount} 张发票</p>\n                                </div>\n                                <div className=\"p-3 rounded-full bg-yellow-500/10\">\n                                    <Clock className=\"h-6 w-6 text-yellow-600\" />\n                                </div>\n                            </div>\n                        </CardContent>\n                    </Card>\n                    <Card>\n                        <CardContent className=\"p-6\">\n                            <div className=\"flex items-center justify-between\">\n                                <div>\n                                    <p className=\"text-sm text-muted-foreground\">已收款</p>\n                                    <p className=\"text-2xl font-bold text-green-700\">￥{Number(paidAmount).toLocaleString()}</p>\n                                    <p className=\"text-xs text-muted-foreground mt-1\">{stats.paidCount} 张发票</p>\n                                </div>\n                                <div className=\"p-3 rounded-full bg-green-500/10\">\n                                    <ShieldCheck className=\"h-6 w-6 text-green-600\" />\n                                </div>\n                            </div>\n                        </CardContent>\n                    </Card>\n                    <Card>\n                        <CardContent className=\"p-6\">\n                            <div className=\"flex items-center justify-between\">\n                                <div>\n                                    <p className=\"text-sm text-muted-foreground\">逾期</p>\n                                    <p className=\"text-2xl font-bold text-red-700\">￥{Number(overdueAmount).toLocaleString()}</p>\n                                    <p className=\"text-xs text-muted-foreground mt-1\">{stats.overdueCount} 张发票</p>\n                                </div>\n                                <div className=\"p-3 rounded-full bg-red-500/10\">\n                                    <AlertCircle className=\"h-6 w-6 text-red-600\" />\n                                </div>\n                            </div>\n                        </CardContent>\n                    </Card>\n                </div>\n            ) : null}\n\n            <Tabs defaultValue=\"invoices\" className=\"space-y-4\">\n                <TabsList>\n                    <TabsTrigger value=\"invoices\" className=\"gap-2\">\n                        发票 <Badge variant=\"secondary\">{invoices.length}</Badge>\n                    </TabsTrigger>\n                    <TabsTrigger value=\"expenses\" className=\"gap-2\">\n                        费用 <Badge variant=\"secondary\">{expenses.length}</Badge>\n                    </TabsTrigger>\n                    <TabsTrigger value=\"contracts\" className=\"gap-2\">\n                        合同 <Badge variant=\"secondary\">{contracts.length}</Badge>\n                    </TabsTrigger>\n                </TabsList>\n\n                <TabsContent value=\"invoices\" className=\"space-y-3\">\n                    {invoices.length > 0 ? (\n                        invoices.map((invoice) => {\n                            const status = INVOICE_STATUS_CONFIG[invoice.status] || INVOICE_STATUS_CONFIG.PENDING\n                            const paid = sumPayments(invoice.payments)\n\n                            return (\n                                <Card key={invoice.id} className=\"hover:shadow-md transition-shadow\">\n                                    <CardContent className=\"p-4\">\n                                        <div className=\"flex items-start justify-between gap-4\">\n                                            <div className=\"min-w-0\">\n                                                <div className=\"flex items-center gap-2\">\n                                                    <p className=\"font-medium truncate\">{invoice.invoiceNo}</p>\n                                                    <Badge className={`${status.color} text-white`}>{status.label}</Badge>\n                                                </div>\n                                                <p className=\"text-sm text-muted-foreground mt-1 truncate\">\n                                                    {invoice.case ? (\n                                                        <Link href={`/cases/${invoice.case.id}`} className=\"hover:underline text-primary\">\n                                                            {invoice.case.caseCode || \"案件\"} · {invoice.case.title}\n                                                        </Link>\n                                                    ) : invoice.client ? (\n                                                        <Link href={`/crm/customers/${invoice.client.id}`} className=\"hover:underline text-primary\">\n                                                            {invoice.client.name}\n                                                        </Link>\n                                                    ) : (\n                                                        \"未关联\"\n                                                    )}\n                                                </p>\n                                            </div>\n                                            <div className=\"text-right shrink-0\">\n                                                <p className=\"text-lg font-bold\">￥{Number(invoice.totalAmount).toLocaleString()}</p>\n                                                {paid > 0 && paid < Number(invoice.totalAmount) ? (\n                                                    <p className=\"text-xs text-green-700\">已收 ￥{paid.toLocaleString()}</p>\n                                                ) : null}\n                                                {invoice.dueDate ? (\n                                                    <p className=\"text-xs text-muted-foreground mt-1\">\n                                                        截止 {new Date(invoice.dueDate).toLocaleDateString(\"zh-CN\")}\n                                                    </p>\n                                                ) : null}\n                                            </div>\n                                        </div>\n\n                                        <div className=\"flex gap-2 mt-3\">\n                                            <Button\n                                                size=\"sm\"\n                                                variant=\"outline\"\n                                                onClick={() =>\n                                                    openWindow(\"ai-paralegal\", \"AI_PARALEGAL\", \"AI 助手 · 发票\", {\n                                                        invoiceId: invoice.id,\n                                                        caseId: invoice.case?.id || invoice.caseId || null,\n                                                        source: \"finance_invoice\",\n                                                    })\n                                                }\n                                            >\n                                                <Bot className=\"h-4 w-4 mr-1\" />\n                                                AI 辅助\n                                            </Button>\n                                            {canEdit ? <RecordPaymentDialog invoiceId={invoice.id} /> : null}\n                                        </div>\n                                    </CardContent>\n                                </Card>\n                            )\n                        })\n                    ) : (\n                        <Card>\n                            <CardContent className=\"flex flex-col items-center justify-center py-12\">\n                                <FileText className=\"h-12 w-12 text-muted-foreground mb-4\" />\n                                <p className=\"text-lg font-medium\">暂无发票</p>\n                                <p className=\"text-muted-foreground\">点击右上角“创建发票”开始</p>\n                            </CardContent>\n                        </Card>\n                    )}\n                </TabsContent>\n\n                <TabsContent value=\"expenses\" className=\"space-y-3\">\n                    {expenses.length > 0 ? (\n                        expenses.map((expense) => (\n                            <Card key={expense.id} className=\"hover:shadow-md transition-shadow\">\n                                <CardContent className=\"p-4\">\n                                    <div className=\"flex items-center justify-between gap-4\">\n                                        <div className=\"flex items-center gap-4 min-w-0\">\n                                            <div className=\"p-2 rounded-lg bg-orange-500/10\">\n                                                <Receipt className=\"h-5 w-5 text-orange-600\" />\n                                            </div>\n                                            <div className=\"min-w-0\">\n                                                <p className=\"font-medium truncate\">{expense.category}</p>\n                                                <p className=\"text-sm text-muted-foreground truncate\">\n                                                    {expense.user?.name || \"未知\"} ·{\" \"}\n                                                    {expense.case ? (\n                                                        <Link href={`/cases/${expense.case.id}`} className=\"hover:underline text-primary\">\n                                                            {expense.case.title}\n                                                        </Link>\n                                                    ) : (\n                                                        \"无关联案件\"\n                                                    )}\n                                                </p>\n                                            </div>\n                                        </div>\n                                        <div className=\"text-right shrink-0\">\n                                            <p className=\"text-lg font-bold\">￥{Number(expense.amount).toLocaleString()}</p>\n                                            <Badge variant=\"outline\">{expense.status}</Badge>\n                                        </div>\n                                    </div>\n                                    <div className=\"flex gap-2 mt-3\">\n                                        <Button\n                                            size=\"sm\"\n                                            variant=\"outline\"\n                                            onClick={() =>\n                                                openWindow(\"ai-paralegal\", \"AI_PARALEGAL\", \"AI 助手 · 费用\", {\n                                                    expenseId: expense.id,\n                                                    caseId: expense.case?.id || expense.caseId || null,\n                                                    source: \"finance_expense\",\n                                                })\n                                            }\n                                        >\n                                            <Bot className=\"h-4 w-4 mr-1\" />\n                                            AI 辅助\n                                        </Button>\n                                    </div>\n                                </CardContent>\n                            </Card>\n                        ))\n                    ) : (\n                        <Card>\n                            <CardContent className=\"flex flex-col items-center justify-center py-12\">\n                                <Receipt className=\"h-12 w-12 text-muted-foreground mb-4\" />\n                                <p className=\"text-lg font-medium\">暂无费用记录</p>\n                                <p className=\"text-muted-foreground\">点击右上角“记录费用”开始</p>\n                            </CardContent>\n                        </Card>\n                    )}\n                </TabsContent>\n\n                <TabsContent value=\"contracts\" className=\"space-y-3\">\n                    {contracts.length > 0 ? (\n                        contracts.map((c) => {\n                            const status = CONTRACT_STATUS_CONFIG[c.status] || CONTRACT_STATUS_CONFIG.DRAFT\n                            return (\n                                <Card key={c.id} className=\"hover:shadow-md transition-shadow\">\n                                    <CardContent className=\"p-4\">\n                                        <div className=\"flex items-start justify-between gap-4\">\n                                            <div className=\"min-w-0\">\n                                                <div className=\"flex items-center gap-2\">\n                                                    <p className=\"font-medium truncate\">{c.contractNo}</p>\n                                                    <Badge className={`${status.color} text-white`}>{status.label}</Badge>\n                                                </div>\n                                                <p className=\"text-sm mt-1 truncate\">{c.title}</p>\n                                                <p className=\"text-xs text-muted-foreground mt-1 truncate\">\n                                                    {c.case ? (\n                                                        <Link href={`/cases/${c.case.id}`} className=\"hover:underline text-primary\">\n                                                            {c.case.caseCode || \"案件\"} · {c.case.title}\n                                                        </Link>\n                                                    ) : c.client ? (\n                                                        <Link href={`/crm/customers/${c.client.id}`} className=\"hover:underline text-primary\">\n                                                            {c.client.name}\n                                                        </Link>\n                                                    ) : (\n                                                        \"未关联\"\n                                                    )}\n                                                </p>\n                                            </div>\n                                            <div className=\"text-right shrink-0\">\n                                                <p className=\"text-lg font-bold\">{c.amount ? `￥${Number(c.amount).toLocaleString()}` : \"-\"}</p>\n                                                <Button\n                                                    size=\"sm\"\n                                                    variant=\"outline\"\n                                                    className=\"mt-2 w-full\"\n                                                    onClick={() =>\n                                                        openWindow(\"ai-paralegal\", \"AI_PARALEGAL\", \"AI 助手 · 合同\", {\n                                                            contractId: c.id,\n                                                            caseId: c.case?.id || c.caseId || null,\n                                                            source: \"finance_contract\",\n                                                        })\n                                                    }\n                                                >\n                                                    <Bot className=\"h-4 w-4 mr-1\" />\n                                                    AI 辅助\n                                                </Button>\n                                                {canEdit ? (\n                                                    <select\n                                                        value={optimisticContractStatus[c.id] ?? c.status}\n                                                        className=\"mt-2 h-9 rounded-md border bg-background px-2 text-sm\"\n                                                        disabled={updatingContractId === c.id}\n                                                        onChange={async (e) => {\n                                                            const next = e.target.value\n                                                            setOptimisticContractStatus((prev) => ({ ...prev, [c.id]: next }))\n                                                            setUpdatingContractId(c.id)\n                                                            try {\n                                                                const res = await updateContractStatus(c.id, next as any)\n                                                                if (!res.success) {\n                                                                    toast.error(\"更新失败\", { description: res.error })\n                                                                    setOptimisticContractStatus((prev) => {\n                                                                        const copy = { ...prev }\n                                                                        delete copy[c.id]\n                                                                        return copy\n                                                                    })\n                                                                    return\n                                                                }\n                                                                toast.success(\"已更新状态\")\n                                                                router.refresh()\n                                                            } finally {\n                                                                setUpdatingContractId(null)\n                                                            }\n                                                        }}\n                                                    >\n                                                        {Object.keys(CONTRACT_STATUS_CONFIG).map((k) => (\n                                                            <option key={k} value={k}>\n                                                                {CONTRACT_STATUS_CONFIG[k]?.label || k}\n                                                            </option>\n                                                        ))}\n                                                    </select>\n                                                ) : null}\n                                            </div>\n                                        </div>\n                                    </CardContent>\n                                </Card>\n                            )\n                        })\n                    ) : (\n                        <Card>\n                            <CardContent className=\"flex flex-col items-center justify-center py-12\">\n                                <FileText className=\"h-12 w-12 text-muted-foreground mb-4\" />\n                                <p className=\"text-lg font-medium\">暂无合同</p>\n                                <p className=\"text-muted-foreground\">点击右上角“创建合同”开始</p>\n                            </CardContent>\n                        </Card>\n                    )}\n                </TabsContent>\n            </Tabs>\n        </div>\n    )\n}\n","usedDeprecatedRules":[]},{"filePath":"D:\\Desktop\\LawClick_NEW\\lawclick-next\\src\\components\\approvals\\CreateApprovalDialog.tsx","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":176,"column":56,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":176,"endColumn":59,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[7385,7388],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[7385,7388],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'e' is defined but never used.","line":196,"column":38,"nodeType":null,"messageId":"unusedVar","endLine":196,"endColumn":39}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":2,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\"\n\nimport { useMemo, useState } from \"react\"\nimport { useRouter } from \"next/navigation\"\nimport { toast } from \"sonner\"\nimport { Plus } from \"lucide-react\"\n\nimport { createApprovalRequest, getAvailableApprovers } from \"@/actions/approval-actions\"\nimport { usePermission } from \"@/hooks/use-permission\"\nimport { Button } from \"@/components/ui/button\"\nimport { Dialog, DialogContent, DialogFooter, DialogHeader, DialogTitle, DialogTrigger } from \"@/components/ui/dialog\"\nimport { Input } from \"@/components/ui/input\"\nimport { Label } from \"@/components/ui/label\"\nimport { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from \"@/components/ui/select\"\nimport { Textarea } from \"@/components/ui/textarea\"\n\nconst APPROVAL_TYPE_OPTIONS = [\n    { value: \"LEAVE\", label: \"请假\" },\n    { value: \"EXPENSE\", label: \"报销\" },\n    { value: \"PURCHASE\", label: \"采购\" },\n    { value: \"CONTRACT\", label: \"合同\" },\n    { value: \"INVOICE\", label: \"发票\" },\n    { value: \"OTHER\", label: \"其他\" },\n] as const\n\nexport function CreateApprovalDialog({\n    caseId,\n    triggerLabel = \"新建审批\",\n    triggerVariant = \"outline\",\n    onSuccess,\n}: {\n    caseId: string\n    triggerLabel?: string\n    triggerVariant?: \"default\" | \"outline\"\n    onSuccess?: () => void\n}) {\n    const router = useRouter()\n    const { can } = usePermission()\n\n    const [open, setOpen] = useState(false)\n    const [creating, setCreating] = useState(false)\n    const [loadingApprovers, setLoadingApprovers] = useState(false)\n    const [approvers, setApprovers] = useState<{ id: string; name: string | null; department?: string | null }[]>([])\n\n    const [form, setForm] = useState({\n        type: \"LEAVE\",\n        title: \"\",\n        description: \"\",\n        amount: \"\",\n        approverId: \"\",\n        extra: \"\",\n    })\n\n    const canSubmit = useMemo(() => form.title.trim().length > 1, [form.title])\n\n    const loadApprovers = async () => {\n        if (!can(\"approval:create\")) return\n        setLoadingApprovers(true)\n        try {\n            const res = await getAvailableApprovers()\n            if (res.success) setApprovers(res.data)\n        } finally {\n            setLoadingApprovers(false)\n        }\n    }\n\n    return (\n        <Dialog\n            open={open}\n            onOpenChange={(v) => {\n                setOpen(v)\n                if (v) loadApprovers()\n            }}\n        >\n            <DialogTrigger asChild>\n                <Button\n                    variant={triggerVariant}\n                    onClick={(e) => {\n                        if (!can(\"approval:create\")) {\n                            e.preventDefault()\n                            toast.error(\"无权限\", { description: \"缺少 approval:create\" })\n                        }\n                    }}\n                >\n                    <Plus className=\"h-4 w-4 mr-2\" />\n                    {triggerLabel}\n                </Button>\n            </DialogTrigger>\n            <DialogContent className=\"sm:max-w-[760px]\">\n                <DialogHeader>\n                    <DialogTitle>新建审批（案件内）</DialogTitle>\n                </DialogHeader>\n\n                <div className=\"grid grid-cols-1 md:grid-cols-2 gap-4\">\n                    <div className=\"space-y-2\">\n                        <Label>类型</Label>\n                        <Select value={form.type} onValueChange={(v) => setForm((p) => ({ ...p, type: v }))}>\n                            <SelectTrigger>\n                                <SelectValue placeholder=\"选择类型\" />\n                            </SelectTrigger>\n                            <SelectContent>\n                                {APPROVAL_TYPE_OPTIONS.map((o) => (\n                                    <SelectItem key={o.value} value={o.value}>\n                                        {o.label}\n                                    </SelectItem>\n                                ))}\n                            </SelectContent>\n                        </Select>\n                    </div>\n                    <div className=\"space-y-2\">\n                        <Label>金额（可选）</Label>\n                        <Input\n                            value={form.amount}\n                            onChange={(e) => setForm((p) => ({ ...p, amount: e.target.value }))}\n                            placeholder=\"例如：5000\"\n                        />\n                    </div>\n                    <div className=\"space-y-2 md:col-span-2\">\n                        <Label>标题</Label>\n                        <Input\n                            value={form.title}\n                            onChange={(e) => setForm((p) => ({ ...p, title: e.target.value }))}\n                            placeholder=\"例如：差旅报销（北京出差）\"\n                        />\n                    </div>\n                    <div className=\"space-y-2 md:col-span-2\">\n                        <Label>说明（可选）</Label>\n                        <Textarea\n                            value={form.description}\n                            onChange={(e) => setForm((p) => ({ ...p, description: e.target.value }))}\n                            rows={3}\n                        />\n                    </div>\n                    <div className=\"space-y-2\">\n                        <Label>审批人（可选）</Label>\n                        <Select\n                            value={form.approverId || \"__none__\"}\n                            onValueChange={(v) => setForm((p) => ({ ...p, approverId: v === \"__none__\" ? \"\" : v }))}\n                            disabled={loadingApprovers}\n                        >\n                            <SelectTrigger>\n                                <SelectValue placeholder={loadingApprovers ? \"加载中...\" : \"默认：任一审批人\"} />\n                            </SelectTrigger>\n                            <SelectContent>\n                                <SelectItem value=\"__none__\">任一审批人</SelectItem>\n                                {approvers.map((u) => (\n                                    <SelectItem key={u.id} value={u.id}>\n                                        {u.name || u.id} {u.department ? `· ${u.department}` : \"\"}\n                                    </SelectItem>\n                                ))}\n                            </SelectContent>\n                        </Select>\n                    </div>\n                    <div className=\"space-y-2\">\n                        <Label>补充信息（可选）</Label>\n                        <Input value={form.extra} onChange={(e) => setForm((p) => ({ ...p, extra: e.target.value }))} placeholder=\"例如：出差城市/采购明细\" />\n                    </div>\n                </div>\n\n                <DialogFooter>\n                    <Button variant=\"outline\" onClick={() => setOpen(false)} disabled={creating}>\n                        取消\n                    </Button>\n                    <Button\n                        disabled={!canSubmit || creating}\n                        onClick={async () => {\n                            setCreating(true)\n                            try {\n                                const amount = form.amount.trim() ? Number(form.amount.trim()) : undefined\n                                if (form.amount.trim() && (!Number.isFinite(amount) || amount! < 0)) {\n                                    toast.error(\"金额格式不正确\")\n                                    return\n                                }\n\n                                const res = await createApprovalRequest({\n                                    type: form.type as any,\n                                    title: form.title.trim(),\n                                    description: form.description.trim() || undefined,\n                                    amount,\n                                    approverId: form.approverId || undefined,\n                                    caseId,\n                                    metadata: form.extra.trim() ? { extra: form.extra.trim() } : {},\n                                    submit: true,\n                                })\n\n                                if (!res.success) {\n                                    toast.error(\"创建失败\", { description: res.error })\n                                    return\n                                }\n\n                                toast.success(\"已提交审批\")\n                                setOpen(false)\n                                setForm({ type: \"LEAVE\", title: \"\", description: \"\", amount: \"\", approverId: \"\", extra: \"\" })\n                                router.refresh()\n                                onSuccess?.()\n                            } catch (e) {\n                                toast.error(\"创建失败\")\n                            } finally {\n                                setCreating(false)\n                            }\n                        }}\n                    >\n                        {creating ? \"提交中...\" : \"提交\"}\n                    </Button>\n                </DialogFooter>\n            </DialogContent>\n        </Dialog>\n    )\n}\n","usedDeprecatedRules":[]},{"filePath":"D:\\Desktop\\LawClick_NEW\\lawclick-next\\src\\components\\calendar\\CanvasCalendar.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'loadingEvents' is assigned a value but never used.","line":113,"column":12,"nodeType":null,"messageId":"unusedVar","endLine":113,"endColumn":25}],"suppressedMessages":[{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has a missing dependency: 'reloadEvents'. Either include it or remove the dependency array.","line":184,"column":8,"nodeType":"ArrayExpression","endLine":184,"endColumn":46,"suggestions":[{"desc":"Update the dependencies array to be: [currentDate, viewMode, currentUserId, reloadEvents]","fix":{"range":[6334,6372],"text":"[currentDate, viewMode, currentUserId, reloadEvents]"}}],"suppressions":[{"kind":"directive","justification":""}]}],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\"\n\nimport { useEffect, useMemo, useRef, useState } from \"react\"\nimport { toast } from \"sonner\"\nimport { Button } from \"@/components/ui/button\"\nimport { Badge } from \"@/components/ui/badge\"\nimport { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from \"@/components/ui/select\"\nimport { Dialog, DialogContent, DialogHeader, DialogTitle, DialogTrigger } from \"@/components/ui/dialog\"\nimport { Input } from \"@/components/ui/input\"\nimport { Label } from \"@/components/ui/label\"\nimport { Textarea } from \"@/components/ui/textarea\"\nimport type { CalendarEventDTO } from \"@/actions/event-actions\"\nimport { createEvent, getAvailableSlots, getEventOccurrencesInRange } from \"@/actions/event-actions\"\nimport { EventDetailDialog } from \"@/components/calendar/EventDetailDialog\"\nimport { useRouter } from \"next/navigation\"\nimport { cn } from \"@/lib/utils\"\nimport {\n    // Calendar as CalendarIcon,\n    Clock,\n    Plus,\n    ChevronLeft,\r\n    ChevronRight,\r\n    // Grid3X3,\r\n    // List,\r\n    // Users,\r\n    MapPin\r\n    // Video,\r\n    // Scale,\r\n    // MessageSquare,\r\n    // FileText\r\n} from \"lucide-react\"\n\ntype ViewMode = \"week\" | \"day\" | \"month\" | \"list\"\n\nfunction toDateTimeLocalValue(date: Date) {\n    const pad = (n: number) => n.toString().padStart(2, \"0\")\n    return `${date.getFullYear()}-${pad(date.getMonth() + 1)}-${pad(date.getDate())}T${pad(date.getHours())}:${pad(date.getMinutes())}`\n}\n\nfunction parseLocalInput(value: string) {\n    const d = new Date(value)\n    if (Number.isNaN(d.getTime())) return null\n    return d\n}\n\nexport function CanvasCalendar(props: {\n    initialEvents: CalendarEventDTO[]\n    currentUserId: string\n    teamMembers: { id: string; name: string; avatarUrl: string | null }[]\n}) {\n    const { initialEvents, currentUserId, teamMembers } = props\n    const [viewMode, setViewMode] = useState<ViewMode>('week')\n    const [currentDate, setCurrentDate] = useState(new Date())\n    const [events, setEvents] = useState<CalendarEventDTO[]>(initialEvents)\n    const [showCreateDialog, setShowCreateDialog] = useState(false)\n    const scrollRef = useRef<HTMLDivElement>(null)\n    const router = useRouter()\n    const didInit = useRef(false)\n\n    const [selectedEventId, setSelectedEventId] = useState<string | null>(null)\n    const selectedEvent = useMemo(() => events.find((e) => e.id === selectedEventId) || null, [events, selectedEventId])\n    const [showDetailDialog, setShowDetailDialog] = useState(false)\n\n    // 新建事件表单状态\n    const [newEvent, setNewEvent] = useState({\n        title: '',\n        type: 'MEETING',\n        startTime: '',\n        endTime: '',\n        location: '',\n        description: '',\n        visibility: 'TEAM_BUSY',\n        participantIds: [] as string[],\n    })\n    const [isCreating, setIsCreating] = useState(false)\n    const [memberQuery, setMemberQuery] = useState(\"\")\n\n    const filteredMembers = useMemo(() => {\n        const q = memberQuery.trim().toLowerCase()\n        return teamMembers\n            .filter((m) => m.id !== currentUserId)\n            .filter((m) => {\n                if (!q) return true\n                return (m.name || \"\").toLowerCase().includes(q)\n            })\n            .slice(0, 200)\n    }, [memberQuery, teamMembers, currentUserId])\n\n    // Scroll to 8 AM on mount\n    useEffect(() => {\n        if (scrollRef.current) {\n            scrollRef.current.scrollTop = 400 // Approx 8 AM\n        }\n    }, [viewMode])\n\r\n    const getWeekDays = (date: Date) => {\n        const start = new Date(date)\n        // Monday as the first day of week\n        const offset = (date.getDay() + 6) % 7\n        start.setDate(date.getDate() - offset)\n        start.setHours(0, 0, 0, 0)\n        const days = []\n        for (let i = 0; i < 7; i++) {\n            const d = new Date(start)\n            d.setDate(start.getDate() + i)\n            days.push(d)\r\n        }\r\n        return days\r\n    }\r\n\r\n    const weekDays = getWeekDays(currentDate)\n\n    const [loadingEvents, setLoadingEvents] = useState(false)\n\n    const computeRange = (date: Date, mode: ViewMode) => {\n        if (mode === \"day\") {\n            const from = new Date(date)\n            from.setHours(0, 0, 0, 0)\n            const to = new Date(from)\n            to.setDate(to.getDate() + 1)\n            return { from, to }\n        }\n\n        if (mode === \"month\") {\n            const first = new Date(date.getFullYear(), date.getMonth(), 1)\n            const firstOffset = (first.getDay() + 6) % 7\n            const from = new Date(first)\n            from.setDate(first.getDate() - firstOffset)\n            from.setHours(0, 0, 0, 0)\n\n            const last = new Date(date.getFullYear(), date.getMonth() + 1, 0)\n            const lastOffset = (7 - ((last.getDay() + 6) % 7) - 1 + 7) % 7\n            const to = new Date(last)\n            to.setDate(last.getDate() + lastOffset + 1)\n            to.setHours(0, 0, 0, 0)\n            return { from, to }\n        }\n\n        // week/list default\n        const start = new Date(date)\n        const offset = (start.getDay() + 6) % 7\n        start.setDate(start.getDate() - offset)\n        start.setHours(0, 0, 0, 0)\n        const end = new Date(start)\n        end.setDate(start.getDate() + 7)\n        return { from: start, to: end }\n    }\n\n    const reloadEvents = async (date = currentDate, mode = viewMode) => {\n        const { from, to } = computeRange(date, mode)\n        setLoadingEvents(true)\n        try {\n            const res = await getEventOccurrencesInRange({\n                from: from.toISOString(),\n                to: to.toISOString(),\n                userIds: [currentUserId],\n            })\n            if (!res.success) {\n                toast.error(\"获取日程失败\", { description: res.error })\n                return\n            }\n\n            const seen = new Set<string>()\n            const next = res.data\n                .map((o) => o.event)\n                .filter((e) => {\n                    if (seen.has(e.id)) return false\n                    seen.add(e.id)\n                    return true\n                })\n            setEvents(next)\n        } finally {\n            setLoadingEvents(false)\n        }\n    }\n\n    useEffect(() => {\n        if (!didInit.current) {\n            didInit.current = true\n            return\n        }\n        void reloadEvents()\n        // eslint-disable-next-line react-hooks/exhaustive-deps\n    }, [currentDate, viewMode, currentUserId])\n\r\n    const getEventTypeColor = (type: string, canViewDetails?: boolean) => {\n        if (canViewDetails === false) {\n            return \"bg-slate-100 text-slate-700 border-slate-200\"\n        }\n        const colors: Record<string, string> = {\n            HEARING: \"bg-orange-100 text-orange-800 border-orange-200\",\n            MEETING: \"bg-blue-100 text-blue-800 border-blue-200\",\n            DEADLINE: \"bg-red-100 text-red-800 border-red-200\",\n            OTHER: \"bg-gray-100 text-gray-800 border-gray-200\",\n        }\n        return colors[type] || colors.OTHER\n    }\n\r\n    const renderWeekView = () => {\n        const hours = Array.from({ length: 24 }, (_, i) => i)\n\r\n        return (\r\n            <div className=\"flex flex-col h-[calc(100vh-200px)] overflow-hidden bg-white rounded-lg border shadow-sm\">\r\n                {/* Header Row */}\r\n                <div className=\"flex border-b\">\r\n                    <div className=\"w-16 flex-shrink-0 border-r bg-slate-50\"></div>\r\n                    <div className=\"flex-1 grid grid-cols-7\">\r\n                        {weekDays.map((day, i) => {\r\n                            const isToday = day.toDateString() === new Date().toDateString()\r\n                            return (\r\n                                <div key={i} className={`text-center py-2 border-r last:border-r-0 ${isToday ? 'bg-blue-50' : ''}`}>\r\n                                    <div className={`text-xs font-medium ${isToday ? 'text-blue-600' : 'text-slate-500'}`}>\r\n                                        {day.toLocaleDateString('zh-CN', { weekday: 'short' })}\r\n                                    </div>\r\n                                    <div className={`text-lg font-bold ${isToday ? 'text-blue-700' : 'text-slate-900'}`}>\r\n                                        {day.getDate()}\r\n                                    </div>\r\n                                </div>\r\n                            )\r\n                        })}\r\n                    </div>\r\n                </div>\r\n\r\n                {/* Scrollable Grid */}\r\n                <div className=\"flex-1 overflow-y-auto relative\" ref={scrollRef}>\r\n                    <div className=\"flex relative min-h-[1440px]\"> {/* 24h * 60px/h */}\r\n                        {/* Time Labels */}\r\n                        <div className=\"w-16 flex-shrink-0 border-r bg-slate-50 text-xs text-slate-500 text-right pr-2 pt-2 select-none\">\r\n                            {hours.map(h => (\r\n                                <div key={h} className=\"h-[60px] relative -top-3\">\r\n                                    {h.toString().padStart(2, '0')}:00\r\n                                </div>\r\n                            ))}\r\n                        </div>\r\n\r\n                        {/* Grid Lines */}\r\n                        <div className=\"flex-1 grid grid-cols-7 relative\">\r\n                            {/* Horizontal Lines */}\r\n                            <div className=\"absolute inset-0 flex flex-col pointer-events-none\">\r\n                                {hours.map(h => (\r\n                                    <div key={h} className=\"h-[60px] border-b border-slate-100 w-full\"></div>\r\n                                ))}\r\n                            </div>\r\n\r\n                            {/* Vertical Lines & Day Columns */}\r\n                            {weekDays.map((day, dayIndex) => (\r\n                                <div key={dayIndex} className=\"border-r last:border-r-0 relative h-full\">\r\n                                    {/* Events for this day */}\r\n                                    {events\r\n                                        .filter(e => new Date(e.startTime).toDateString() === day.toDateString())\r\n                                        .map(event => {\r\n                                            const start = new Date(event.startTime)\r\n                                            const end = new Date(event.endTime)\r\n                                            const top = (start.getHours() * 60) + start.getMinutes()\r\n                                            const height = Math.max(30, ((end.getTime() - start.getTime()) / (1000 * 60))) // Min 30px height\r\n\r\n                                            return (\r\n                                                <div\r\n                                                    key={event.id}\r\n                                                    className={`absolute left-1 right-1 rounded px-2 py-1 text-xs border-l-4 cursor-pointer hover:brightness-95 transition-all shadow-sm z-10 ${getEventTypeColor(event.type, event.canViewDetails)}`}\n                                                    style={{ top: `${top}px`, height: `${height}px` }}\n                                                    onClick={() => {\n                                                        setSelectedEventId(event.id)\n                                                        setShowDetailDialog(true)\n                                                    }}\n                                                >\n                                                    <div className=\"font-bold truncate\">{event.title}</div>\n                                                    <div className=\"truncate opacity-80\">{event.location}</div>\n                                                </div>\n                                            )\r\n                                        })}\r\n\r\n                                    {/* Current Time Indicator (if today) */}\r\n                                    {day.toDateString() === new Date().toDateString() && (\r\n                                        <div\r\n                                            className=\"absolute w-full border-t-2 border-red-500 z-20 pointer-events-none\"\r\n                                            style={{ top: `${(new Date().getHours() * 60) + new Date().getMinutes()}px` }}\r\n                                        >\r\n                                            <div className=\"absolute -left-1.5 -top-1.5 h-3 w-3 rounded-full bg-red-500\"></div>\r\n                                        </div>\r\n                                    )}\r\n                                </div>\r\n                            ))}\r\n                        </div>\r\n                    </div>\r\n                </div>\r\n            </div>\r\n        )\n    }\n\n    const renderMonthView = () => {\n        const { from, to } = computeRange(currentDate, \"month\")\n        const days: Date[] = []\n        const cursor = new Date(from)\n        while (cursor < to) {\n            days.push(new Date(cursor))\n            cursor.setDate(cursor.getDate() + 1)\n        }\n\n        const weekdayLabels = [\"一\", \"二\", \"三\", \"四\", \"五\", \"六\", \"日\"]\n        const isSameMonth = (d: Date) => d.getMonth() === currentDate.getMonth() && d.getFullYear() === currentDate.getFullYear()\n\n        return (\n            <div className=\"bg-white rounded-lg border shadow-sm overflow-hidden\">\n                <div className=\"grid grid-cols-7 border-b bg-slate-50\">\n                    {weekdayLabels.map((label) => (\n                        <div key={label} className=\"py-2 text-center text-xs font-medium text-slate-500\">\n                            {label}\n                        </div>\n                    ))}\n                </div>\n\n                <div className=\"grid grid-cols-7\">\n                    {days.map((day) => {\n                        const inMonth = isSameMonth(day)\n                        const isToday = day.toDateString() === new Date().toDateString()\n                        const dayEvents = events\n                            .filter((e) => new Date(e.startTime).toDateString() === day.toDateString())\n                            .slice(0, 3)\n\n                        return (\n                            <div\n                                key={day.toISOString()}\n                                className={cn(\n                                    \"min-h-28 border-b border-r last:border-r-0 p-2 hover:bg-slate-50 cursor-pointer transition-colors\",\n                                    !inMonth && \"bg-slate-50/50 text-slate-400\",\n                                    isToday && \"bg-blue-50\"\n                                )}\n                                onClick={() => {\n                                    setCurrentDate(day)\n                                    setViewMode(\"day\")\n                                }}\n                            >\n                                <div className=\"flex items-center justify-between\">\n                                    <div className={cn(\"text-sm font-semibold\", isToday && \"text-blue-700\")}>{day.getDate()}</div>\n                                </div>\n\n                                <div className=\"mt-2 space-y-1\">\n                                    {dayEvents.map((event) => (\n                                        <div\n                                            key={event.id}\n                                            className={cn(\n                                                \"text-[11px] px-2 py-1 rounded border cursor-pointer hover:brightness-95\",\n                                                getEventTypeColor(event.type, event.canViewDetails)\n                                            )}\n                                            onClick={(e) => {\n                                                e.stopPropagation()\n                                                setSelectedEventId(event.id)\n                                                setShowDetailDialog(true)\n                                            }}\n                                        >\n                                            <div className=\"truncate\">{event.title}</div>\n                                        </div>\n                                    ))}\n                                    {events.filter((e) => new Date(e.startTime).toDateString() === day.toDateString()).length > 3 ? (\n                                        <div className=\"text-[11px] text-muted-foreground px-2\">更多...</div>\n                                    ) : null}\n                                </div>\n                            </div>\n                        )\n                    })}\n                </div>\n            </div>\n        )\n    }\n\n    return (\n        <div className=\"space-y-4 h-full flex flex-col\">\n            {/* Toolbar */}\n            <div className=\"flex items-center justify-between bg-white p-4 rounded-lg border shadow-sm\">\n                <div className=\"flex items-center gap-4\">\n                    <h2 className=\"text-xl font-bold text-slate-900\">\r\n                        {currentDate.toLocaleDateString('zh-CN', { year: 'numeric', month: 'long' })}\r\n                    </h2>\r\n                    <div className=\"flex items-center rounded-md border bg-slate-50\">\n                        <Button variant=\"ghost\" size=\"icon\" onClick={() => {\n                            const d = new Date(currentDate)\n                            if (viewMode === \"day\") d.setDate(d.getDate() - 1)\n                            else if (viewMode === \"month\") d.setMonth(d.getMonth() - 1)\n                            else d.setDate(d.getDate() - 7)\n                            setCurrentDate(d)\n                        }}>\n                            <ChevronLeft className=\"h-4 w-4\" />\n                        </Button>\n                        <Button variant=\"ghost\" size=\"sm\" onClick={() => setCurrentDate(new Date())}>今天</Button>\n                        <Button variant=\"ghost\" size=\"icon\" onClick={() => {\n                            const d = new Date(currentDate)\n                            if (viewMode === \"day\") d.setDate(d.getDate() + 1)\n                            else if (viewMode === \"month\") d.setMonth(d.getMonth() + 1)\n                            else d.setDate(d.getDate() + 7)\n                            setCurrentDate(d)\n                        }}>\n                            <ChevronRight className=\"h-4 w-4\" />\n                        </Button>\n                    </div>\n                </div>\n\n                <div className=\"flex items-center gap-2\">\n                    <Select value={viewMode} onValueChange={(v) => setViewMode(v as ViewMode)}>\n                        <SelectTrigger className=\"w-[120px]\">\n                            <SelectValue />\n                        </SelectTrigger>\n                        <SelectContent>\n                            <SelectItem value=\"week\">周视图</SelectItem>\n                            <SelectItem value=\"day\">日视图</SelectItem>\n                            <SelectItem value=\"month\">月视图</SelectItem>\n                            <SelectItem value=\"list\">列表</SelectItem>\n                        </SelectContent>\n                    </Select>\n                    <Dialog open={showCreateDialog} onOpenChange={setShowCreateDialog}>\r\n                        <DialogTrigger asChild>\r\n                            <Button className=\"bg-primary text-white\">\r\n                                <Plus className=\"mr-2 h-4 w-4\" /> 新建日程\r\n                            </Button>\r\n                        </DialogTrigger>\r\n                        <DialogContent className=\"sm:max-w-[500px]\">\r\n                            <DialogHeader>\r\n                                <DialogTitle>新建日程</DialogTitle>\r\n                            </DialogHeader>\r\n                            <div className=\"space-y-4 py-4\">\r\n                                <div className=\"space-y-2\">\r\n                                    <Label>标题</Label>\r\n                                    <Input\r\n                                        value={newEvent.title}\r\n                                        onChange={(e) => setNewEvent({ ...newEvent, title: e.target.value })}\r\n                                        placeholder=\"输入日程标题\"\r\n                                    />\r\n                                </div>\r\n                                <div className=\"grid grid-cols-2 gap-4\">\r\n                                    <div className=\"space-y-2\">\r\n                                        <Label>开始时间</Label>\r\n                                        <Input\r\n                                            type=\"datetime-local\"\r\n                                            value={newEvent.startTime}\r\n                                            onChange={(e) => setNewEvent({ ...newEvent, startTime: e.target.value })}\r\n                                        />\r\n                                    </div>\r\n                                    <div className=\"space-y-2\">\r\n                                        <Label>结束时间</Label>\r\n                                        <Input\r\n                                            type=\"datetime-local\"\r\n                                            value={newEvent.endTime}\r\n                                            onChange={(e) => setNewEvent({ ...newEvent, endTime: e.target.value })}\r\n                                        />\r\n                                    </div>\r\n                                </div>\r\n                                <div className=\"space-y-2\">\r\n                                    <Label>类型</Label>\r\n                                    <Select value={newEvent.type} onValueChange={(v) => setNewEvent({ ...newEvent, type: v })}>\r\n                                        <SelectTrigger>\r\n                                            <SelectValue />\r\n                                        </SelectTrigger>\r\n                                        <SelectContent>\n                                            <SelectItem value=\"MEETING\">会议</SelectItem>\n                                            <SelectItem value=\"HEARING\">开庭</SelectItem>\n                                            <SelectItem value=\"DEADLINE\">截止日期</SelectItem>\n                                            <SelectItem value=\"OTHER\">其他</SelectItem>\n                                        </SelectContent>\n                                    </Select>\n                                </div>\n                                <div className=\"space-y-2\">\n                                    <Label>可见性</Label>\n                                    <Select\n                                        value={newEvent.visibility}\n                                        onValueChange={(v) => setNewEvent({ ...newEvent, visibility: v })}\n                                    >\n                                        <SelectTrigger>\n                                            <SelectValue />\n                                        </SelectTrigger>\n                                        <SelectContent>\n                                            <SelectItem value=\"TEAM_BUSY\">团队忙闲（默认）</SelectItem>\n                                            <SelectItem value=\"TEAM_PUBLIC\">团队公开</SelectItem>\n                                            <SelectItem value=\"CASE_TEAM\">案件组可见</SelectItem>\n                                            <SelectItem value=\"PRIVATE\">仅我/参与人</SelectItem>\n                                        </SelectContent>\n                                    </Select>\n                                </div>\n\n                                <div className=\"space-y-2\">\n                                    <div className=\"flex items-center justify-between gap-2\">\n                                        <Label>参与人</Label>\n                                        <Button\n                                            type=\"button\"\n                                            variant=\"outline\"\n                                            size=\"sm\"\n                                            disabled={isCreating || newEvent.participantIds.length === 0}\n                                            onClick={async () => {\n                                                const start = parseLocalInput(newEvent.startTime) || new Date()\n                                                const end = parseLocalInput(newEvent.endTime)\n                                                const durationMinutes = end\n                                                    ? Math.max(15, Math.round((end.getTime() - start.getTime()) / 60_000))\n                                                    : 60\n\n                                                const from = new Date()\n                                                const to = new Date()\n                                                to.setDate(to.getDate() + 7)\n\n                                                const res = await getAvailableSlots({\n                                                    userIds: [currentUserId, ...newEvent.participantIds],\n                                                    from: from.toISOString(),\n                                                    to: to.toISOString(),\n                                                    durationMinutes,\n                                                })\n\n                                                if (!res.success) {\n                                                    toast.error(\"推荐失败\", { description: res.error })\n                                                    return\n                                                }\n                                                const first = res.data?.[0]?.slots?.[0]\n                                                if (!first) {\n                                                    toast.info(\"暂无可用时间\", { description: \"请调整参与人或时间范围\" })\n                                                    return\n                                                }\n                                                const s = new Date(first.startTime)\n                                                const e = new Date(first.endTime)\n                                                setNewEvent((prev) => ({\n                                                    ...prev,\n                                                    startTime: toDateTimeLocalValue(s),\n                                                    endTime: toDateTimeLocalValue(e),\n                                                }))\n                                                toast.success(\"已填入推荐时间\")\n                                            }}\n                                        >\n                                            推荐可用时间\n                                        </Button>\n                                    </div>\n                                    <Input\n                                        value={memberQuery}\n                                        onChange={(e) => setMemberQuery(e.target.value)}\n                                        placeholder=\"搜索成员（支持 30-300 人规模）\"\n                                    />\n                                    <div className=\"max-h-40 overflow-auto rounded-md border bg-white/50 p-2 space-y-1\">\n                                        {filteredMembers.length === 0 ? (\n                                            <div className=\"text-sm text-muted-foreground py-2\">未找到成员</div>\n                                        ) : (\n                                            filteredMembers.map((m) => {\n                                                const checked = newEvent.participantIds.includes(m.id)\n                                                return (\n                                                    <label\n                                                        key={m.id}\n                                                        className=\"flex items-center gap-2 text-sm px-2 py-1 rounded hover:bg-slate-50 cursor-pointer\"\n                                                    >\n                                                        <input\n                                                            type=\"checkbox\"\n                                                            checked={checked}\n                                                            onChange={(e) => {\n                                                                const next = e.target.checked\n                                                                    ? Array.from(new Set([...newEvent.participantIds, m.id]))\n                                                                    : newEvent.participantIds.filter((id) => id !== m.id)\n                                                                setNewEvent({ ...newEvent, participantIds: next })\n                                                            }}\n                                                        />\n                                                        <span className=\"truncate\">{m.name}</span>\n                                                    </label>\n                                                )\n                                            })\n                                        )}\n                                    </div>\n                                    {newEvent.participantIds.length > 0 ? (\n                                        <div className=\"flex flex-wrap gap-2\">\n                                            {newEvent.participantIds.slice(0, 8).map((id) => {\n                                                const member = teamMembers.find((m) => m.id === id)\n                                                return (\n                                                    <Badge key={id} variant=\"secondary\" className=\"text-xs\">\n                                                        {member?.name || id.slice(0, 6)}\n                                                    </Badge>\n                                                )\n                                            })}\n                                            {newEvent.participantIds.length > 8 ? (\n                                                <Badge variant=\"outline\" className=\"text-xs\">\n                                                    +{newEvent.participantIds.length - 8}\n                                                </Badge>\n                                            ) : null}\n                                        </div>\n                                    ) : null}\n                                </div>\n                                <div className=\"space-y-2\">\n                                    <Label>地点</Label>\n                                    <Input\n                                        value={newEvent.location}\n                                        onChange={(e) => setNewEvent({ ...newEvent, location: e.target.value })}\r\n                                        placeholder=\"会议地点或线上会议链接\"\r\n                                    />\r\n                                </div>\r\n                                <div className=\"space-y-2\">\r\n                                    <Label>描述</Label>\r\n                                    <Textarea\r\n                                        value={newEvent.description}\r\n                                        onChange={(e) => setNewEvent({ ...newEvent, description: e.target.value })}\r\n                                        placeholder=\"日程详情...\"\r\n                                        rows={3}\r\n                                    />\r\n                                </div>\r\n                                <Button\r\n                                    className=\"w-full\"\n                                    disabled={isCreating || !newEvent.title || !newEvent.startTime || !newEvent.endTime}\n                                    onClick={async () => {\n                                        setIsCreating(true)\n                                        try {\n                                            const start = parseLocalInput(newEvent.startTime)\n                                            const end = parseLocalInput(newEvent.endTime)\n                                            if (!start || !end) {\n                                                toast.error(\"时间格式不正确\")\n                                                return\n                                            }\n\n                                            const result = await createEvent({\n                                                title: newEvent.title.trim(),\n                                                type: newEvent.type,\n                                                startTime: start,\n                                                endTime: end,\n                                                location: newEvent.location || undefined,\n                                                description: newEvent.description || undefined,\n                                                visibility: newEvent.visibility,\n                                                participantIds: newEvent.participantIds,\n                                            })\n                                            if (!result.success) {\n                                                toast.error(\"创建失败\", { description: result.error })\n                                                return\n                                            }\n\n                                            setShowCreateDialog(false)\n                                            setNewEvent({\n                                                title: \"\",\n                                                type: \"MEETING\",\n                                                startTime: \"\",\n                                                endTime: \"\",\n                                                location: \"\",\n                                                description: \"\",\n                                                visibility: \"TEAM_BUSY\",\n                                                participantIds: [],\n                                            })\n                                            setMemberQuery(\"\")\n                                            await reloadEvents()\n                                            router.refresh()\n                                        } finally {\n                                            setIsCreating(false)\n                                        }\n                                    }}\n                                >\n                                    {isCreating ? '创建中...' : '创建日程'}\r\n                                </Button>\r\n                            </div>\r\n                        </DialogContent>\r\n                    </Dialog>\r\n                </div>\r\n            </div>\r\n\r\n            {/* Main View */}\n            <div className=\"flex-1 min-h-0\">\n                {viewMode === 'week' && renderWeekView()}\n                {viewMode === \"month\" && renderMonthView()}\n                {viewMode === 'day' && (\n                    <div className=\"flex flex-col h-[calc(100vh-200px)] overflow-hidden bg-white rounded-lg border shadow-sm\">\n                        <div className=\"p-4 border-b bg-slate-50\">\n                            <h3 className=\"text-lg font-bold\">\n                                {currentDate.toLocaleDateString('zh-CN', { month: 'long', day: 'numeric', weekday: 'long' })}\n                            </h3>\r\n                        </div>\r\n                        <div className=\"flex-1 overflow-y-auto p-4\">\r\n                            {events\r\n                                .filter(e => new Date(e.startTime).toDateString() === currentDate.toDateString())\r\n                                .map(event => (\r\n                                    <div\n                                        key={event.id}\n                                        className={`mb-3 p-4 rounded-lg border-l-4 cursor-pointer hover:bg-slate-50 ${getEventTypeColor(event.type, event.canViewDetails)}`}\n                                        onClick={() => {\n                                            setSelectedEventId(event.id)\n                                            setShowDetailDialog(true)\n                                        }}\n                                    >\n                                        <div className=\"flex justify-between items-start\">\r\n                                            <div>\r\n                                                <div className=\"font-bold text-lg\">{event.title}</div>\r\n                                                <div className=\"text-sm text-muted-foreground mt-1\">\r\n                                                    <Clock className=\"inline h-4 w-4 mr-1\" />\r\n                                                    {new Date(event.startTime).toLocaleTimeString('zh-CN', { hour: '2-digit', minute: '2-digit' })}\r\n                                                    {' - '}\r\n                                                    {new Date(event.endTime).toLocaleTimeString('zh-CN', { hour: '2-digit', minute: '2-digit' })}\r\n                                                </div>\r\n                                                {event.location && (\r\n                                                    <div className=\"text-sm text-muted-foreground mt-1\">\r\n                                                        <MapPin className=\"inline h-4 w-4 mr-1\" />\r\n                                                        {event.location}\r\n                                                    </div>\r\n                                                )}\r\n                                            </div>\r\n                                            <Badge variant=\"outline\">{event.type}</Badge>\r\n                                        </div>\r\n                                    </div>\r\n                                ))}\r\n                            {events.filter(e => new Date(e.startTime).toDateString() === currentDate.toDateString()).length === 0 && (\r\n                                <div className=\"text-center py-12 text-muted-foreground\">今天没有日程</div>\r\n                            )}\r\n                        </div>\r\n                    </div>\r\n                )}\r\n                {viewMode === 'list' && (\r\n                    <div className=\"bg-white rounded-lg border shadow-sm overflow-hidden\">\r\n                        <div className=\"divide-y\">\r\n                            {events.map(event => (\n                                <div\n                                    key={event.id}\n                                    className=\"p-4 hover:bg-slate-50 transition-colors cursor-pointer\"\n                                    onClick={() => {\n                                        setSelectedEventId(event.id)\n                                        setShowDetailDialog(true)\n                                    }}\n                                >\n                                    <div className=\"flex items-center gap-4\">\n                                        <div className={`w-1 h-12 rounded ${getEventTypeColor(event.type, event.canViewDetails).split(' ')[0]}`}></div>\n                                        <div className=\"flex-1\">\n                                            <div className=\"font-medium\">{event.title}</div>\n                                            <div className=\"text-sm text-muted-foreground\">\r\n                                                {new Date(event.startTime).toLocaleDateString('zh-CN', { month: 'short', day: 'numeric' })}\r\n                                                {' '}\r\n                                                {new Date(event.startTime).toLocaleTimeString('zh-CN', { hour: '2-digit', minute: '2-digit' })}\r\n                                            </div>\r\n                                        </div>\r\n                                        <Badge variant=\"outline\">{event.type}</Badge>\r\n                                    </div>\r\n                                </div>\r\n                            ))}\r\n                            {events.length === 0 && (\r\n                                <div className=\"text-center py-12 text-muted-foreground\">暂无日程</div>\r\n                            )}\r\n                        </div>\r\n                    </div>\r\n                )}\n            </div>\n\n            <EventDetailDialog\n                open={showDetailDialog}\n                onOpenChange={setShowDetailDialog}\n                event={selectedEvent}\n                currentUserId={currentUserId}\n                onEventChanged={() => void reloadEvents()}\n            />\n        </div>\n    )\n}\n","usedDeprecatedRules":[]},{"filePath":"D:\\Desktop\\LawClick_NEW\\lawclick-next\\src\\components\\calendar\\EventDetailDialog.tsx","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":61,"column":25,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":61,"endColumn":28,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1992,1995],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1992,1995],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":62,"column":62,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":62,"endColumn":65,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[2068,2071],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[2068,2071],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":2,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\"\n\nimport * as React from \"react\"\nimport { toast } from \"sonner\"\nimport { CalendarDays, Clock, FileText, MapPin, Users, XCircle } from \"lucide-react\"\nimport { useRouter } from \"next/navigation\"\n\nimport type { CalendarEventDTO } from \"@/actions/event-actions\"\nimport { cancelEvent } from \"@/actions/event-actions\"\nimport { createTask } from \"@/actions/tasks\"\nimport { Badge } from \"@/components/ui/badge\"\nimport { Button } from \"@/components/ui/button\"\nimport { Dialog, DialogContent, DialogHeader, DialogTitle } from \"@/components/ui/dialog\"\nimport { Separator } from \"@/components/ui/separator\"\n\nexport function EventDetailDialog(props: {\n    open: boolean\n    onOpenChange: (open: boolean) => void\n    event: CalendarEventDTO | null\n    currentUserId: string\n    onEventChanged?: () => void\n}) {\n    const { open, onOpenChange, event, currentUserId, onEventChanged } = props\n    const router = useRouter()\n    const [busy, setBusy] = React.useState(false)\n\n    const handleCancel = async () => {\n        if (!event) return\n        setBusy(true)\n        try {\n            const res = await cancelEvent(event.id)\n            if (!res.success) {\n                toast.error(\"取消失败\", { description: res.error })\n                return\n            }\n            toast.success(\"已取消日程\")\n            onOpenChange(false)\n            onEventChanged?.()\n            router.refresh()\n        } finally {\n            setBusy(false)\n        }\n    }\n\n    const handleCreateTask = async () => {\n        if (!event?.case?.id) {\n            toast.error(\"无法创建任务\", { description: \"该日程未关联案件\" })\n            return\n        }\n\n        setBusy(true)\n        try {\n            const fd = new FormData()\n            fd.set(\"title\", event.title)\n            fd.set(\"description\", event.description || \"\")\n            fd.set(\"priority\", \"P2_MEDIUM\")\n            fd.set(\"userId\", currentUserId)\n            fd.set(\"caseId\", event.case.id)\n\n            const res = await createTask(fd)\n            if ((res as any)?.error) {\n                toast.error(\"创建任务失败\", { description: (res as any).error })\n                return\n            }\n            toast.success(\"已从日程创建任务\")\n            router.refresh()\n        } finally {\n            setBusy(false)\n        }\n    }\n\n    const start = event ? new Date(event.startTime) : null\n    const end = event ? new Date(event.endTime) : null\n\n    return (\n        <Dialog open={open} onOpenChange={onOpenChange}>\n            <DialogContent className=\"sm:max-w-[560px]\">\n                <DialogHeader>\n                    <DialogTitle className=\"flex items-center justify-between gap-2\">\n                        <span className=\"truncate\">{event?.title || \"日程详情\"}</span>\n                        {event ? <Badge variant=\"outline\">{event.type}</Badge> : null}\n                    </DialogTitle>\n                </DialogHeader>\n\n                {!event ? (\n                    <div className=\"text-sm text-muted-foreground py-6\">未选择日程</div>\n                ) : (\n                    <div className=\"space-y-4\">\n                        <div className=\"space-y-2 text-sm\">\n                            <div className=\"flex items-center gap-2 text-muted-foreground\">\n                                <CalendarDays className=\"h-4 w-4\" />\n                                <span>\n                                    {start?.toLocaleDateString(\"zh-CN\", { year: \"numeric\", month: \"long\", day: \"numeric\", weekday: \"short\" })}\n                                </span>\n                            </div>\n                            <div className=\"flex items-center gap-2 text-muted-foreground\">\n                                <Clock className=\"h-4 w-4\" />\n                                <span>\n                                    {start?.toLocaleTimeString(\"zh-CN\", { hour: \"2-digit\", minute: \"2-digit\" })} -{\" \"}\n                                    {end?.toLocaleTimeString(\"zh-CN\", { hour: \"2-digit\", minute: \"2-digit\" })}\n                                </span>\n                            </div>\n                            {event.location ? (\n                                <div className=\"flex items-center gap-2 text-muted-foreground\">\n                                    <MapPin className=\"h-4 w-4\" />\n                                    <span className=\"truncate\">{event.location}</span>\n                                </div>\n                            ) : null}\n                        </div>\n\n                        {event.case ? (\n                            <div className=\"rounded-lg border bg-muted/10 p-3 text-sm\">\n                                <div className=\"text-xs text-muted-foreground mb-1\">关联案件</div>\n                                <div className=\"font-medium truncate\">\n                                    {event.case.caseCode ? `#${event.case.caseCode} ` : \"\"}\n                                    {event.case.title}\n                                </div>\n                            </div>\n                        ) : null}\n\n                        {event.task ? (\n                            <div className=\"rounded-lg border bg-muted/10 p-3 text-sm\">\n                                <div className=\"text-xs text-muted-foreground mb-1\">关联任务</div>\n                                <div className=\"font-medium truncate\">{event.task.title}</div>\n                            </div>\n                        ) : null}\n\n                        {event.description ? (\n                            <div className=\"rounded-lg border bg-white/50 p-3 text-sm\">\n                                <div className=\"text-xs text-muted-foreground mb-1\">描述</div>\n                                <div className=\"whitespace-pre-wrap\">{event.description}</div>\n                            </div>\n                        ) : null}\n\n                        {event.canViewDetails && event.participants?.length ? (\n                            <>\n                                <Separator />\n                                <div className=\"space-y-2\">\n                                    <div className=\"flex items-center gap-2 text-xs text-muted-foreground\">\n                                        <Users className=\"h-4 w-4\" />\n                                        <span>参与人</span>\n                                    </div>\n                                    <div className=\"flex flex-wrap gap-2\">\n                                        {event.participants.map((p) => (\n                                            <Badge key={p.userId} variant=\"secondary\" className=\"text-xs\">\n                                                {p.user?.name || p.userId.slice(0, 6)} · {p.status}\n                                            </Badge>\n                                        ))}\n                                    </div>\n                                </div>\n                            </>\n                        ) : null}\n\n                        <Separator />\n\n                        <div className=\"flex items-center justify-between gap-2\">\n                            <div className=\"flex items-center gap-2\">\n                                <Button\n                                    variant=\"secondary\"\n                                    size=\"sm\"\n                                    className=\"gap-2\"\n                                    onClick={handleCreateTask}\n                                    disabled={busy}\n                                >\n                                    <FileText className=\"h-4 w-4\" />\n                                    从日程创建任务\n                                </Button>\n                            </div>\n\n                            {event.canEdit ? (\n                                <Button\n                                    variant=\"outline\"\n                                    size=\"sm\"\n                                    className=\"gap-2 text-destructive hover:text-destructive\"\n                                    onClick={handleCancel}\n                                    disabled={busy}\n                                >\n                                    <XCircle className=\"h-4 w-4\" />\n                                    取消日程\n                                </Button>\n                            ) : null}\n                        </div>\n                    </div>\n                )}\n            </DialogContent>\n        </Dialog>\n    )\n}\n\n","usedDeprecatedRules":[]},{"filePath":"D:\\Desktop\\LawClick_NEW\\lawclick-next\\src\\components\\cases\\CaseBillingTab.tsx","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":77,"column":26,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":77,"endColumn":29,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[3087,3090],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[3087,3090],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":82,"column":32,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":82,"endColumn":35,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[3236,3239],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[3236,3239],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":89,"column":45,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":89,"endColumn":48,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[3520,3523],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[3520,3523],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":94,"column":46,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":94,"endColumn":49,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[3769,3772],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[3769,3772],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":95,"column":46,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":95,"endColumn":49,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[3825,3828],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[3825,3828],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":96,"column":48,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":96,"endColumn":51,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[3883,3886],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[3883,3886],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":97,"column":48,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":97,"endColumn":51,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[3941,3944],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[3941,3944],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":100,"column":36,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":100,"endColumn":39,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[4037,4040],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[4037,4040],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'e' is defined but never used.","line":123,"column":18,"nodeType":null,"messageId":"unusedVar","endLine":123,"endColumn":19}],"suppressedMessages":[{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has a missing dependency: 'loadData'. Either include it or remove the dependency array.","line":133,"column":8,"nodeType":"ArrayExpression","endLine":133,"endColumn":16,"suggestions":[{"desc":"Update the dependencies array to be: [caseId, loadData]","fix":{"range":[5401,5409],"text":"[caseId, loadData]"}}],"suppressions":[{"kind":"directive","justification":""}]}],"errorCount":0,"fatalErrorCount":0,"warningCount":9,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\"\n\nimport { useEffect, useMemo, useState } from \"react\"\nimport { useRouter } from \"next/navigation\"\nimport { useSession } from \"next-auth/react\"\nimport { toast } from \"sonner\"\nimport { Clock, FileCheck, Receipt, RefreshCw, User } from \"lucide-react\"\n\nimport { getApprovalsByCase, cancelRequest } from \"@/actions/approval-actions\"\nimport { getCaseBilling, getCaseBillingDetails, type BillingDetail, type BillingSummary } from \"@/actions/billing-actions\"\nimport { getContracts } from \"@/actions/contract-actions\"\nimport { getExpenses, getInvoices } from \"@/actions/finance-actions\"\nimport { CreateApprovalDialog } from \"@/components/approvals/CreateApprovalDialog\"\nimport { CreateContractDialog } from \"@/components/finance/CreateContractDialog\"\nimport { CreateExpenseDialog } from \"@/components/finance/CreateExpenseDialog\"\nimport { CreateInvoiceDialog } from \"@/components/finance/CreateInvoiceDialog\"\nimport { RecordPaymentDialog } from \"@/components/finance/RecordPaymentDialog\"\nimport { Badge } from \"@/components/ui/badge\"\nimport { Button } from \"@/components/ui/button\"\nimport { Card, CardContent, CardHeader, CardTitle } from \"@/components/ui/card\"\nimport {\n    Table,\n    TableBody,\n    TableCell,\n    TableHead,\n    TableHeader,\n    TableRow,\n} from \"@/components/ui/table\"\nimport { Tabs, TabsContent, TabsList, TabsTrigger } from \"@/components/ui/tabs\"\nimport { usePermission } from \"@/hooks/use-permission\"\n\ninterface CaseBillingTabProps {\n    caseId: string\n}\n\nconst INVOICE_STATUS_CONFIG: Record<string, { label: string; color: string }> = {\n    DRAFT: { label: \"草稿\", color: \"bg-gray-500\" },\n    PENDING: { label: \"待付款\", color: \"bg-yellow-500\" },\n    PAID: { label: \"已付款\", color: \"bg-green-500\" },\n    PARTIAL: { label: \"部分付款\", color: \"bg-blue-500\" },\n    OVERDUE: { label: \"逾期\", color: \"bg-red-500\" },\n    CANCELLED: { label: \"已取消\", color: \"bg-gray-400\" },\n}\n\nconst EXPENSE_STATUS_CONFIG: Record<string, { label: string; color: string }> = {\n    PENDING: { label: \"待审批\", color: \"bg-yellow-500\" },\n    APPROVED: { label: \"已批准\", color: \"bg-green-500\" },\n    REJECTED: { label: \"已驳回\", color: \"bg-red-500\" },\n    REIMBURSED: { label: \"已报销\", color: \"bg-blue-500\" },\n}\n\nconst APPROVAL_STATUS_CONFIG: Record<string, { label: string; color: string }> = {\n    DRAFT: { label: \"草稿\", color: \"bg-gray-500\" },\n    PENDING: { label: \"待审批\", color: \"bg-yellow-500\" },\n    APPROVED: { label: \"已批准\", color: \"bg-green-500\" },\n    REJECTED: { label: \"已驳回\", color: \"bg-red-500\" },\n    CANCELLED: { label: \"已撤回\", color: \"bg-gray-400\" },\n}\n\nconst CONTRACT_STATUS_CONFIG: Record<string, { label: string; color: string }> = {\n    DRAFT: { label: \"草稿\", color: \"bg-gray-500\" },\n    SIGNED: { label: \"已签署\", color: \"bg-blue-500\" },\n    ACTIVE: { label: \"生效中\", color: \"bg-green-500\" },\n    EXPIRED: { label: \"已到期\", color: \"bg-orange-500\" },\n    CANCELLED: { label: \"已作废\", color: \"bg-gray-400\" },\n}\n\nconst APPROVAL_TYPE_LABEL: Record<string, string> = {\n    LEAVE: \"请假\",\n    EXPENSE: \"报销\",\n    PURCHASE: \"采购\",\n    CONTRACT: \"合同\",\n    INVOICE: \"发票\",\n    OTHER: \"其他\",\n}\n\nfunction toNumber(value: any) {\n    const num = typeof value === \"number\" ? value : Number(value)\n    return Number.isFinite(num) ? num : 0\n}\n\nfunction sumPayments(payments: any[] | undefined) {\n    return (payments || []).reduce((sum, p) => sum + toNumber(p.amount), 0)\n}\n\nexport function CaseBillingTab({ caseId }: CaseBillingTabProps) {\n    const router = useRouter()\n    const { data: session } = useSession()\n    const currentUserId = (session?.user as any)?.id as string | undefined\n    const { can } = usePermission()\n\n    const [summary, setSummary] = useState<BillingSummary | null>(null)\n    const [details, setDetails] = useState<BillingDetail[]>([])\n    const [invoices, setInvoices] = useState<any[]>([])\n    const [expenses, setExpenses] = useState<any[]>([])\n    const [approvals, setApprovals] = useState<any[]>([])\n    const [contracts, setContracts] = useState<any[]>([])\n    const [loading, setLoading] = useState(true)\n\n    const formatCurrency = (value: any) => {\n        return new Intl.NumberFormat(\"zh-CN\", { style: \"currency\", currency: \"CNY\" }).format(toNumber(value))\n    }\n\n    const loadData = async () => {\n        setLoading(true)\n        try {\n            const [summaryResult, detailsResult, invoicesResult, expensesResult, approvalsResult, contractsResult] =\n                await Promise.all([\n                    getCaseBilling(caseId),\n                    getCaseBillingDetails(caseId),\n                    getInvoices({ caseId }),\n                    getExpenses({ caseId }),\n                    getApprovalsByCase(caseId),\n                    getContracts({ caseId }),\n                ])\n\n            setSummary(summaryResult.success ? summaryResult.data : null)\n            setDetails(detailsResult.success ? detailsResult.data : [])\n            setInvoices(invoicesResult.success ? invoicesResult.data : [])\n            setExpenses(expensesResult.success ? expensesResult.data : [])\n            setApprovals(approvalsResult.success ? approvalsResult.data : [])\n            setContracts(contractsResult.success ? contractsResult.data : [])\n        } catch (e) {\n            toast.error(\"加载失败\", { description: \"请稍后重试\" })\n        } finally {\n            setLoading(false)\n        }\n    }\n\n    useEffect(() => {\n        loadData()\n        // eslint-disable-next-line react-hooks/exhaustive-deps\n    }, [caseId])\n\n    const canBillingCreate = can(\"billing:create\")\n    const canBillingEdit = can(\"billing:edit\")\n    const canApprovalCreate = can(\"approval:create\")\n\n    const invoiceTotals = useMemo(() => {\n        const total = invoices.reduce((sum, inv) => sum + toNumber(inv.totalAmount), 0)\n        const paid = invoices.reduce((sum, inv) => sum + sumPayments(inv.payments), 0)\n        return { total, paid, outstanding: Math.max(0, total - paid) }\n    }, [invoices])\n\n    const expenseTotal = useMemo(() => expenses.reduce((sum, ex) => sum + toNumber(ex.amount), 0), [expenses])\n\n    if (loading) {\n        return (\n            <Card>\n                <CardContent className=\"py-8 text-center text-muted-foreground\">加载中...</CardContent>\n            </Card>\n        )\n    }\n\n    return (\n        <Card>\n            <CardHeader className=\"flex flex-row items-center justify-between\">\n                <CardTitle className=\"text-lg\">案件账务</CardTitle>\n                <Button\n                    variant=\"ghost\"\n                    size=\"sm\"\n                    onClick={async () => {\n                        await loadData()\n                        router.refresh()\n                    }}\n                >\n                    <RefreshCw className=\"h-4 w-4\" />\n                </Button>\n            </CardHeader>\n            <CardContent className=\"space-y-6\">\n                <div className=\"grid grid-cols-1 md:grid-cols-4 gap-4\">\n                    <Card>\n                        <CardContent className=\"pt-4\">\n                            <div className=\"flex items-center gap-2 text-sm text-muted-foreground mb-1\">\n                                <Clock className=\"h-4 w-4\" />\n                                总工时\n                            </div>\n                            <div className=\"text-2xl font-bold\">\n                                {summary?.totalHours || 0} <span className=\"text-sm font-normal\">小时</span>\n                            </div>\n                        </CardContent>\n                    </Card>\n                    <Card>\n                        <CardContent className=\"pt-4\">\n                            <div className=\"flex items-center gap-2 text-sm text-muted-foreground mb-1\">\n                                <Clock className=\"h-4 w-4\" />\n                                可计费工时\n                            </div>\n                            <div className=\"text-2xl font-bold text-green-700\">\n                                {summary?.billableHours || 0} <span className=\"text-sm font-normal\">小时</span>\n                            </div>\n                        </CardContent>\n                    </Card>\n                    <Card>\n                        <CardContent className=\"pt-4\">\n                            <div className=\"flex items-center gap-2 text-sm text-muted-foreground mb-1\">\n                                <FileCheck className=\"h-4 w-4\" />\n                                发票应收\n                            </div>\n                            <div className=\"text-2xl font-bold\">{formatCurrency(invoiceTotals.total)}</div>\n                            <div className=\"text-xs text-muted-foreground mt-1\">\n                                已收 {formatCurrency(invoiceTotals.paid)} · 待收 {formatCurrency(invoiceTotals.outstanding)}\n                            </div>\n                        </CardContent>\n                    </Card>\n                    <Card>\n                        <CardContent className=\"pt-4\">\n                            <div className=\"flex items-center gap-2 text-sm text-muted-foreground mb-1\">\n                                <Receipt className=\"h-4 w-4\" />\n                                费用合计\n                            </div>\n                            <div className=\"text-2xl font-bold text-orange-600\">{formatCurrency(expenseTotal)}</div>\n                        </CardContent>\n                    </Card>\n                </div>\n\n                <Tabs defaultValue=\"timelog\" className=\"w-full\">\n                    <TabsList className=\"flex flex-wrap\">\n                        <TabsTrigger value=\"timelog\">工时</TabsTrigger>\n                        <TabsTrigger value=\"invoice\">发票</TabsTrigger>\n                        <TabsTrigger value=\"expense\">费用</TabsTrigger>\n                        <TabsTrigger value=\"approval\">审批</TabsTrigger>\n                        <TabsTrigger value=\"contract\">合同</TabsTrigger>\n                    </TabsList>\n\n                    <TabsContent value=\"timelog\" className=\"space-y-4\">\n                        <Tabs defaultValue=\"byUser\">\n                            <TabsList>\n                                <TabsTrigger value=\"byUser\">按人员</TabsTrigger>\n                                <TabsTrigger value=\"details\">明细</TabsTrigger>\n                            </TabsList>\n\n                            <TabsContent value=\"byUser\">\n                                {summary?.byUser && summary.byUser.length > 0 ? (\n                                    <Table>\n                                        <TableHeader>\n                                            <TableRow>\n                                                <TableHead>人员</TableHead>\n                                                <TableHead className=\"text-right\">工时</TableHead>\n                                                <TableHead className=\"text-right\">金额</TableHead>\n                                            </TableRow>\n                                        </TableHeader>\n                                        <TableBody>\n                                            {summary.byUser.map((item) => (\n                                                <TableRow key={item.userId}>\n                                                    <TableCell>\n                                                        <div className=\"flex items-center gap-2\">\n                                                            <User className=\"h-4 w-4 text-muted-foreground\" />\n                                                            {item.userName}\n                                                        </div>\n                                                    </TableCell>\n                                                    <TableCell className=\"text-right\">{item.hours}h</TableCell>\n                                                    <TableCell className=\"text-right font-medium\">{formatCurrency(item.amount)}</TableCell>\n                                                </TableRow>\n                                            ))}\n                                        </TableBody>\n                                    </Table>\n                                ) : (\n                                    <div className=\"text-center py-8 text-muted-foreground\">暂无数据</div>\n                                )}\n                            </TabsContent>\n\n                            <TabsContent value=\"details\">\n                                {details.length > 0 ? (\n                                    <Table>\n                                        <TableHeader>\n                                            <TableRow>\n                                                <TableHead>日期</TableHead>\n                                                <TableHead>描述</TableHead>\n                                                <TableHead>人员</TableHead>\n                                                <TableHead className=\"text-right\">工时</TableHead>\n                                                <TableHead className=\"text-right\">金额</TableHead>\n                                                <TableHead>计费</TableHead>\n                                            </TableRow>\n                                        </TableHeader>\n                                        <TableBody>\n                                            {details.map((item) => (\n                                                <TableRow key={item.id}>\n                                                    <TableCell className=\"text-sm\">{new Date(item.date).toLocaleDateString(\"zh-CN\")}</TableCell>\n                                                    <TableCell>{item.description}</TableCell>\n                                                    <TableCell>{item.userName}</TableCell>\n                                                    <TableCell className=\"text-right\">{item.hours}h</TableCell>\n                                                    <TableCell className=\"text-right\">{item.isBillable ? formatCurrency(item.amount) : \"-\"}</TableCell>\n                                                    <TableCell>\n                                                        <Badge variant={item.isBillable ? \"default\" : \"secondary\"}>\n                                                            {item.isBillable ? \"可计费\" : \"不计费\"}\n                                                        </Badge>\n                                                    </TableCell>\n                                                </TableRow>\n                                            ))}\n                                        </TableBody>\n                                    </Table>\n                                ) : (\n                                    <div className=\"text-center py-8 text-muted-foreground\">暂无工时记录</div>\n                                )}\n                            </TabsContent>\n                        </Tabs>\n                    </TabsContent>\n\n                    <TabsContent value=\"invoice\" className=\"space-y-4\">\n                        <div className=\"flex items-center justify-between gap-4 flex-wrap\">\n                            <div className=\"text-sm text-muted-foreground\">共 {invoices.length} 张</div>\n                            <div className=\"flex items-center gap-2 flex-wrap justify-end\">\n                                {canBillingCreate ? <CreateInvoiceDialog caseId={caseId} onSuccess={loadData} /> : null}\n                            </div>\n                        </div>\n\n                        {invoices.length > 0 ? (\n                            <Table>\n                                <TableHeader>\n                                    <TableRow>\n                                        <TableHead>发票号</TableHead>\n                                        <TableHead className=\"text-right\">应收</TableHead>\n                                        <TableHead className=\"text-right\">已收</TableHead>\n                                        <TableHead className=\"text-right\">待收</TableHead>\n                                        <TableHead>状态</TableHead>\n                                        <TableHead>截止</TableHead>\n                                        <TableHead className=\"text-right\">操作</TableHead>\n                                    </TableRow>\n                                </TableHeader>\n                                <TableBody>\n                                    {invoices.map((inv) => {\n                                        const paid = sumPayments(inv.payments)\n                                        const total = toNumber(inv.totalAmount)\n                                        const outstanding = Math.max(0, total - paid)\n                                        const status = INVOICE_STATUS_CONFIG[inv.status] || { label: inv.status, color: \"bg-gray-500\" }\n\n                                        return (\n                                            <TableRow key={inv.id}>\n                                                <TableCell className=\"font-medium\">{inv.invoiceNo}</TableCell>\n                                                <TableCell className=\"text-right\">{formatCurrency(inv.totalAmount)}</TableCell>\n                                                <TableCell className=\"text-right\">{formatCurrency(paid)}</TableCell>\n                                                <TableCell className=\"text-right\">{formatCurrency(outstanding)}</TableCell>\n                                                <TableCell>\n                                                    <Badge className={`${status.color} text-white`}>{status.label}</Badge>\n                                                </TableCell>\n                                                <TableCell className=\"text-sm\">{inv.dueDate ? new Date(inv.dueDate).toLocaleDateString(\"zh-CN\") : \"-\"}</TableCell>\n                                                <TableCell className=\"text-right\">\n                                                    {canBillingEdit && inv.status !== \"CANCELLED\" && outstanding > 0 ? (\n                                                        <RecordPaymentDialog invoiceId={inv.id} onSuccess={loadData} />\n                                                    ) : (\n                                                        <span className=\"text-sm text-muted-foreground\">-</span>\n                                                    )}\n                                                </TableCell>\n                                            </TableRow>\n                                        )\n                                    })}\n                                </TableBody>\n                            </Table>\n                        ) : (\n                            <Card>\n                                <CardContent className=\"py-10 text-center text-muted-foreground\">暂无发票</CardContent>\n                            </Card>\n                        )}\n                    </TabsContent>\n\n                    <TabsContent value=\"expense\" className=\"space-y-4\">\n                        <div className=\"flex items-center justify-between gap-4 flex-wrap\">\n                            <div className=\"text-sm text-muted-foreground\">\n                                共 {expenses.length} 笔 · 合计 {formatCurrency(expenseTotal)}\n                            </div>\n                            <div className=\"flex items-center gap-2 flex-wrap justify-end\">\n                                {canBillingCreate ? <CreateExpenseDialog caseId={caseId} onSuccess={loadData} /> : null}\n                            </div>\n                        </div>\n\n                        {expenses.length > 0 ? (\n                            <Table>\n                                <TableHeader>\n                                    <TableRow>\n                                        <TableHead>日期</TableHead>\n                                        <TableHead>类别</TableHead>\n                                        <TableHead>说明</TableHead>\n                                        <TableHead>记录人</TableHead>\n                                        <TableHead className=\"text-right\">金额</TableHead>\n                                        <TableHead>状态</TableHead>\n                                    </TableRow>\n                                </TableHeader>\n                                <TableBody>\n                                    {expenses.map((ex) => {\n                                        const status = EXPENSE_STATUS_CONFIG[ex.status] || { label: ex.status, color: \"bg-gray-500\" }\n                                        return (\n                                            <TableRow key={ex.id}>\n                                                <TableCell className=\"text-sm\">{ex.expenseDate ? new Date(ex.expenseDate).toLocaleDateString(\"zh-CN\") : \"-\"}</TableCell>\n                                                <TableCell className=\"font-medium\">{ex.category}</TableCell>\n                                                <TableCell className=\"text-sm text-muted-foreground\">{ex.description || \"-\"}</TableCell>\n                                                <TableCell className=\"text-sm\">{ex.user?.name || \"-\"}</TableCell>\n                                                <TableCell className=\"text-right font-medium\">{formatCurrency(ex.amount)}</TableCell>\n                                                <TableCell>\n                                                    <Badge className={`${status.color} text-white`}>{status.label}</Badge>\n                                                </TableCell>\n                                            </TableRow>\n                                        )\n                                    })}\n                                </TableBody>\n                            </Table>\n                        ) : (\n                            <Card>\n                                <CardContent className=\"py-10 text-center text-muted-foreground\">暂无费用记录</CardContent>\n                            </Card>\n                        )}\n                    </TabsContent>\n\n                    <TabsContent value=\"approval\" className=\"space-y-4\">\n                        <div className=\"flex items-center justify-between gap-4 flex-wrap\">\n                            <div className=\"text-sm text-muted-foreground\">共 {approvals.length} 条</div>\n                            <div className=\"flex items-center gap-2 flex-wrap justify-end\">\n                                {canApprovalCreate ? <CreateApprovalDialog caseId={caseId} onSuccess={loadData} /> : null}\n                            </div>\n                        </div>\n\n                        {approvals.length > 0 ? (\n                            <Table>\n                                <TableHeader>\n                                    <TableRow>\n                                        <TableHead>类型</TableHead>\n                                        <TableHead>标题</TableHead>\n                                        <TableHead className=\"text-right\">金额</TableHead>\n                                        <TableHead>状态</TableHead>\n                                        <TableHead>申请人</TableHead>\n                                        <TableHead>审批人</TableHead>\n                                        <TableHead className=\"text-right\">操作</TableHead>\n                                    </TableRow>\n                                </TableHeader>\n                                <TableBody>\n                                    {approvals.map((a) => {\n                                        const status = APPROVAL_STATUS_CONFIG[a.status] || { label: a.status, color: \"bg-gray-500\" }\n                                        const typeLabel = APPROVAL_TYPE_LABEL[a.type] || a.type\n                                        const canWithdraw = Boolean(\n                                            currentUserId &&\n                                                a.requesterId === currentUserId &&\n                                                (a.status === \"PENDING\" || a.status === \"DRAFT\")\n                                        )\n\n                                        return (\n                                            <TableRow key={a.id}>\n                                                <TableCell className=\"text-sm\">{typeLabel}</TableCell>\n                                                <TableCell className=\"font-medium max-w-[360px] truncate\">{a.title}</TableCell>\n                                                <TableCell className=\"text-right\">{a.amount ? formatCurrency(a.amount) : \"-\"}</TableCell>\n                                                <TableCell>\n                                                    <Badge className={`${status.color} text-white`}>{status.label}</Badge>\n                                                </TableCell>\n                                                <TableCell className=\"text-sm\">{a.requester?.name || \"-\"}</TableCell>\n                                                <TableCell className=\"text-sm\">{a.approver?.name || \"任一审批人\"}</TableCell>\n                                                <TableCell className=\"text-right\">\n                                                    {canWithdraw ? (\n                                                        <Button\n                                                            size=\"sm\"\n                                                            variant=\"ghost\"\n                                                            onClick={async () => {\n                                                                const ok = window.confirm(\"确认撤回该审批？\")\n                                                                if (!ok) return\n                                                                try {\n                                                                    const res = await cancelRequest(a.id)\n                                                                    if (!res.success) {\n                                                                        toast.error(\"撤回失败\", { description: res.error })\n                                                                        return\n                                                                    }\n                                                                    toast.success(\"已撤回\")\n                                                                    await loadData()\n                                                                    router.refresh()\n                                                                } catch {\n                                                                    toast.error(\"撤回失败\")\n                                                                }\n                                                            }}\n                                                        >\n                                                            撤回\n                                                        </Button>\n                                                    ) : (\n                                                        <span className=\"text-sm text-muted-foreground\">-</span>\n                                                    )}\n                                                </TableCell>\n                                            </TableRow>\n                                        )\n                                    })}\n                                </TableBody>\n                            </Table>\n                        ) : (\n                            <Card>\n                                <CardContent className=\"py-10 text-center text-muted-foreground\">暂无审批</CardContent>\n                            </Card>\n                        )}\n                    </TabsContent>\n\n                    <TabsContent value=\"contract\" className=\"space-y-4\">\n                        <div className=\"flex items-center justify-between gap-4 flex-wrap\">\n                            <div className=\"text-sm text-muted-foreground\">共 {contracts.length} 份</div>\n                            <div className=\"flex items-center gap-2 flex-wrap justify-end\">\n                                {canBillingCreate ? <CreateContractDialog caseId={caseId} onSuccess={loadData} /> : null}\n                            </div>\n                        </div>\n\n                        {contracts.length > 0 ? (\n                            <Table>\n                                <TableHeader>\n                                    <TableRow>\n                                        <TableHead>合同号</TableHead>\n                                        <TableHead>标题</TableHead>\n                                        <TableHead className=\"text-right\">金额</TableHead>\n                                        <TableHead>状态</TableHead>\n                                        <TableHead>签署日期</TableHead>\n                                    </TableRow>\n                                </TableHeader>\n                                <TableBody>\n                                    {contracts.map((c) => {\n                                        const status = CONTRACT_STATUS_CONFIG[c.status] || { label: c.status, color: \"bg-gray-500\" }\n                                        return (\n                                            <TableRow key={c.id}>\n                                                <TableCell className=\"font-medium\">{c.contractNo}</TableCell>\n                                                <TableCell className=\"max-w-[420px] truncate\">{c.title}</TableCell>\n                                                <TableCell className=\"text-right\">{c.amount ? formatCurrency(c.amount) : \"-\"}</TableCell>\n                                                <TableCell>\n                                                    <Badge className={`${status.color} text-white`}>{status.label}</Badge>\n                                                </TableCell>\n                                                <TableCell className=\"text-sm\">{c.signedAt ? new Date(c.signedAt).toLocaleDateString(\"zh-CN\") : \"-\"}</TableCell>\n                                            </TableRow>\n                                        )\n                                    })}\n                                </TableBody>\n                            </Table>\n                        ) : (\n                            <Card>\n                                <CardContent className=\"py-10 text-center text-muted-foreground\">暂无合同</CardContent>\n                            </Card>\n                        )}\n                    </TabsContent>\n                </Tabs>\n            </CardContent>\n        </Card>\n    )\n}\n\n","usedDeprecatedRules":[]},{"filePath":"D:\\Desktop\\LawClick_NEW\\lawclick-next\\src\\components\\cases\\CaseDetailClient.tsx","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":53,"column":15,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":53,"endColumn":18,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[2048,2051],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[2048,2051],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":54,"column":19,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":54,"endColumn":22,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[2071,2074],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[2071,2074],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has missing dependencies: 'caseItem?.serviceType' and 'loadStageProgress'. Either include them or remove the dependency array.","line":105,"column":8,"nodeType":"ArrayExpression","endLine":105,"endColumn":22,"suggestions":[{"desc":"Update the dependencies array to be: [caseItem?.id, caseItem?.serviceType, loadStageProgress]","fix":{"range":[3786,3800],"text":"[caseItem?.id, caseItem?.serviceType, loadStageProgress]"}}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'newStage' is defined but never used.","line":123,"column":40,"nodeType":null,"messageId":"unusedVar","endLine":123,"endColumn":48},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'e' is defined but never used.","line":145,"column":18,"nodeType":null,"messageId":"unusedVar","endLine":145,"endColumn":19},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":152,"column":37,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":152,"endColumn":40,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[5275,5278],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[5275,5278],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'getStatusColor' is assigned a value but never used.","line":164,"column":11,"nodeType":null,"messageId":"unusedVar","endLine":164,"endColumn":25},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":349,"column":68,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":349,"endColumn":71,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[16444,16447],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[16444,16447],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":423,"column":71,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":423,"endColumn":74,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[21989,21992],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[21989,21992],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":455,"column":70,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":455,"endColumn":73,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[24393,24396],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[24393,24396],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":478,"column":70,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":478,"endColumn":73,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[26059,26062],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[26059,26062],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":11,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\"\r\n\r\nimport { useState, useEffect } from \"react\"\r\nimport { Card, CardContent, CardHeader, CardTitle } from \"@/components/ui/card\"\r\nimport { Button } from \"@/components/ui/button\"\r\nimport { Badge } from \"@/components/ui/badge\"\r\nimport { Dialog, DialogContent, DialogFooter, DialogHeader, DialogTitle, DialogTrigger } from \"@/components/ui/dialog\"\r\nimport { Input } from \"@/components/ui/input\"\r\nimport { Label } from \"@/components/ui/label\"\r\nimport { Textarea } from \"@/components/ui/textarea\"\r\nimport { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from \"@/components/ui/select\"\r\nimport { Progress } from \"@/components/ui/progress\"\r\nimport { Separator } from \"@/components/ui/separator\"\r\nimport {\n    Briefcase,\n    Calendar,\n    CheckSquare,\n    Clock,\n    FileText,\n    MoreHorizontal,\n    User,\n    ArrowLeft,\n    Plus,\n    Download,\n    Scale,\n    Bot,\n    Loader2,\n    Users,\n    Settings,\n    History,\n    CreditCard,\n    MessageCircle\n} from \"lucide-react\"\nimport Link from \"next/link\"\nimport { usePathname, useRouter, useSearchParams } from \"next/navigation\"\nimport { useFloatStore } from \"@/store/float-store\"\n\r\nimport { CaseTeamCard } from \"@/components/cases/CaseTeamCard\"\r\nimport { CaseStageTimeline } from \"@/components/cases/CaseStageTimeline\"\r\nimport { CaseTaskKanban } from \"@/components/cases/CaseTaskKanban\"\r\nimport { CasePartiesTab } from \"@/components/cases/CasePartiesTab\"\r\nimport { CaseTimelineTab } from \"@/components/cases/CaseTimelineTab\"\r\nimport { CaseBillingTab } from \"@/components/cases/CaseBillingTab\"\r\nimport { CaseSettingsTab } from \"@/components/cases/CaseSettingsTab\"\r\nimport { StageDocumentChecklist } from \"@/components/cases/StageDocumentChecklist\"\r\nimport { uploadDocument } from \"@/actions/documents\"\r\nimport { getCaseStageProgress, initializeStageDocuments, initializeStageTasks, type StageProgressInfo } from \"@/actions/stage-management\"\r\nimport { LitigationStage } from \"@/lib/litigation-stages\"\r\nimport { toast } from \"sonner\"\r\n\r\n \r\ninterface CaseDetailProps {\r\n    caseItem: any\r\n    currentUser?: any\r\n}\r\n\r\nexport function CaseDetailClient({ caseItem, currentUser }: CaseDetailProps) {\n    const [activeTab, setActiveTab] = useState(\"overview\")\n    const [stageProgress, setStageProgress] = useState<StageProgressInfo | null>(null)\n    const [loadingStage, setLoadingStage] = useState(true)\n    const [initializingDocs, setInitializingDocs] = useState(false)\n    const [uploadOpen, setUploadOpen] = useState(false)\n    const [uploading, setUploading] = useState(false)\n    const router = useRouter()\n    const pathname = usePathname()\n    const searchParams = useSearchParams()\n    const { openWindow } = useFloatStore()\n    const tabParam = searchParams.get(\"tab\")\n\n    const updateTabInUrl = (tab: string) => {\n        const params = new URLSearchParams(searchParams.toString())\n        params.set(\"tab\", tab)\n        const qs = params.toString()\n        const url = qs ? `${pathname}?${qs}` : pathname\n        window.history.replaceState(null, \"\", url)\n    }\n\n    // 支持通过 URL 直达指定 Tab（服务于全局搜索/通知跳转）\n    useEffect(() => {\n        if (!tabParam) return\n\n        const allowedTabs = new Set([\n            \"overview\",\n            \"parties\",\n            \"tasks\",\n            \"documents\",\n            \"timelog\",\n            \"events\",\n            \"timeline\",\n            \"billing\",\n            \"settings\",\n        ])\n\n        if (allowedTabs.has(tabParam)) setActiveTab(tabParam)\n    }, [tabParam])\n\r\n    // 加载阶段进度（诉讼、仲裁、非诉都支持）\r\n    useEffect(() => {\r\n        const supportedTypes = ['LITIGATION', 'ARBITRATION', 'NON_LITIGATION']\r\n        if (caseItem?.id && supportedTypes.includes(caseItem?.serviceType)) {\r\n            loadStageProgress()\r\n        } else {\r\n            setLoadingStage(false)\r\n        }\r\n    }, [caseItem?.id])\r\n\r\n    const loadStageProgress = async () => {\r\n        setLoadingStage(true)\r\n        const progress = await getCaseStageProgress(caseItem.id)\r\n        setStageProgress(progress)\r\n        setLoadingStage(false)\r\n    }\r\n\r\n    const handleInitializeDocs = async () => {\r\n        setInitializingDocs(true)\r\n        await initializeStageDocuments(caseItem.id)\r\n        await initializeStageTasks(caseItem.id)\r\n        router.refresh()\r\n        await loadStageProgress()\r\n        setInitializingDocs(false)\r\n    }\r\n\r\n    const handleStageAdvanced = async (newStage: LitigationStage) => {\r\n        await loadStageProgress()\r\n        router.refresh()\r\n    }\r\n\r\n    const formatFileTypeLabel = (fileType: string) => {\r\n        if (!fileType) return \"UNKNOWN\"\r\n        const normalized = fileType.includes(\"/\") ? (fileType.split(\"/\").pop() || fileType) : fileType\r\n        return normalized.toUpperCase()\r\n    }\r\n\r\n    const handleCaseDocUpload = async (formData: FormData) => {\r\n        setUploading(true)\r\n        try {\r\n            const res = await uploadDocument(formData)\r\n            if (!res.success) {\r\n                toast.error(\"上传失败\", { description: res.error })\r\n                return\r\n            }\r\n            toast.success(\"上传成功\")\r\n            setUploadOpen(false)\r\n            router.refresh()\r\n        } catch (e) {\r\n            toast.error(\"上传失败\")\r\n        } finally {\r\n            setUploading(false)\r\n        }\r\n    }\r\n\r\n    const handleDocDownload = (doc: any) => {\r\n        if (!doc?.fileUrl) {\r\n            toast.error(\"该文档尚未上传文件\")\r\n            return\r\n        }\r\n        window.open(`/api/documents/${doc.id}/file?download=1`, \"_blank\", \"noopener,noreferrer\")\r\n    }\r\n\r\n    if (!caseItem) {\r\n        return <div className=\"p-8 text-center\">案件不存在</div>\r\n    }\r\n\r\n    const getStatusColor = (status: string) => {\r\n        switch (status) {\r\n            case 'ACTIVE': return 'bg-green-500'\r\n            case 'WAITING': return 'bg-yellow-500'\r\n            case 'DONE': return 'bg-blue-500'\r\n            default: return 'bg-slate-500'\r\n        }\r\n    }\r\n\r\n    const formatDurationHMS = (seconds: number) => {\r\n        const s = Math.max(0, Math.floor(seconds || 0))\r\n        const h = Math.floor(s / 3600)\r\n        const m = Math.floor((s % 3600) / 60)\r\n        const sec = s % 60\r\n        return `${h.toString().padStart(2, '0')}:${m.toString().padStart(2, '0')}:${sec.toString().padStart(2, '0')}`\r\n    }\r\n\r\n    return (\r\n        <div className=\"space-y-6\">\r\n            {/* Top Navigation */}\r\n            <div className=\"flex items-center gap-2 text-sm text-slate-500\">\r\n                <Link href=\"/cases\" className=\"hover:text-slate-900 flex items-center gap-1\">\r\n                    <ArrowLeft className=\"h-4 w-4\" /> 返回案件列表\r\n                </Link>\r\n                <span>/</span>\r\n                <span className=\"text-slate-900 font-medium\">{caseItem.caseNumber}</span>\r\n            </div>\r\n\r\n            {/* Header Card */}\r\n            <Card className=\"border-none bg-white shadow-sm\">\r\n                <CardContent className=\"p-6\">\r\n                    <div className=\"flex flex-col md:flex-row justify-between gap-6\">\r\n                        <div className=\"flex-1 space-y-4\">\r\n                            <div className=\"flex items-start justify-between\">\r\n                                <div>\r\n                                    <h1 className=\"text-2xl font-bold text-slate-900\">{caseItem.title}</h1>\r\n                                    <div className=\"flex items-center gap-3 mt-2\">\r\n                                        <Badge variant=\"outline\" className=\"text-slate-600\">\r\n                                            {caseItem.caseType}\r\n                                        </Badge>\r\n                                        <div className=\"flex items-center gap-1.5 text-sm text-slate-500\">\r\n                                            <User className=\"h-4 w-4\" />\r\n                                            {caseItem.clientName}\r\n                                        </div>\r\n                                        <div className=\"flex items-center gap-1.5 text-sm text-slate-500\">\r\n                                            <Clock className=\"h-4 w-4\" />\r\n                                            更新于 {new Date(caseItem.updatedAt).toLocaleDateString()}\r\n                                        </div>\r\n                                    </div>\r\n                                </div>\n                                <div className=\"flex items-center gap-2\">\n                                    <Button\n                                        variant=\"outline\"\n                                        onClick={() =>\n                                            openWindow(\n                                                \"ai-paralegal\",\n                                                \"AI_PARALEGAL\",\n                                                `AI 助手 · ${caseItem.caseNumber || caseItem.caseCode || \"\"}`,\n                                                { caseId: caseItem.id, source: \"case_detail\" }\n                                            )\n                                        }\n                                    >\n                                        <Bot className=\"h-4 w-4 mr-2\" /> AI 助手\n                                    </Button>\n                                    <Button\n                                        variant=\"outline\"\n                                        onClick={() =>\n                                            openWindow(\n                                                `chat-case-${caseItem.id}`,\n                                                \"CHAT\",\n                                                `案件群聊 · ${caseItem.caseNumber || caseItem.caseCode || \"\"}`,\n                                                { caseId: caseItem.id, scope: \"CASE\" }\n                                            )\n                                        }\n                                    >\n                                        <MessageCircle className=\"h-4 w-4 mr-2\" /> 聊天\n                                    </Button>\n                                    <Button variant=\"outline\">编辑</Button>\n                                    <Button variant=\"outline\" size=\"icon\"><MoreHorizontal className=\"h-4 w-4\" /></Button>\n                                    <Button onClick={() => window.print()} variant=\"outline\" size=\"icon\"><Download className=\"h-4 w-4\" /></Button>\n                                </div>\n                            </div>\n\r\n                            <div className=\"flex items-center gap-4\">\r\n                                <div className=\"flex-1 max-w-md\">\r\n                                    <div className=\"flex justify-between text-sm mb-1\">\r\n                                        <span className=\"text-slate-500\">案件进度</span>\r\n                                        <span className=\"font-medium\">{caseItem.progress}%</span>\r\n                                    </div>\r\n                                    <Progress value={caseItem.progress} className=\"h-2\" />\r\n                                </div>\r\n                                <div className=\"h-8 w-[1px] bg-slate-200\"></div>\r\n                                <div>\r\n                                    <div className=\"text-sm text-slate-500\">标的额</div>\r\n                                    <div className=\"font-bold text-slate-900\">¥ {Number(caseItem.contractValue).toLocaleString()}</div>\r\n                                </div>\r\n                            </div>\r\n                        </div>\r\n                    </div>\r\n                </CardContent>\r\n            </Card>\r\n\r\n            {/* Main Content Grid */}\r\n            <div className=\"grid grid-cols-1 lg:grid-cols-3 gap-6\">\r\n                {/* Left Column: Tabs & Content */}\r\n                <div className=\"lg:col-span-2 space-y-6\">\r\n                    {/* Custom Tabs */}\n                    <div className=\"flex items-center gap-1 border-b\">\n                        {[\n                            { id: 'overview', label: '概览', icon: Briefcase },\n                            { id: 'parties', label: '当事人', icon: Users },\n                            { id: 'tasks', label: '任务', icon: CheckSquare },\r\n                            { id: 'documents', label: '文档', icon: FileText },\r\n                            { id: 'timelog', label: '工时', icon: Clock },\r\n                            { id: 'events', label: '日程', icon: Calendar },\r\n                            { id: 'timeline', label: '时间线', icon: History },\r\n                            { id: 'billing', label: '账务', icon: CreditCard },\r\n                            { id: 'settings', label: '设置', icon: Settings },\r\n                        ].map(tab => (\n                            <button\n                                key={tab.id}\n                                onClick={() => {\n                                    setActiveTab(tab.id)\n                                    updateTabInUrl(tab.id)\n                                }}\n                                className={`flex items-center gap-2 px-4 py-3 text-sm font-medium border-b-2 transition-colors ${activeTab === tab.id\n                                    ? 'border-primary text-primary'\n                                    : 'border-transparent text-slate-500 hover:text-slate-700'\n                                    }`}\n                            >\r\n                                <tab.icon className=\"h-4 w-4\" />\r\n                                {tab.label}\r\n                            </button>\r\n                        ))}\r\n                    </div>\r\n\r\n                    {/* Tab Content */}\r\n                    <div className=\"min-h-[400px]\">\r\n                        {activeTab === 'overview' && (\r\n                            <div className=\"space-y-6\">\r\n                                <Card>\r\n                                    <CardHeader>\r\n                                        <CardTitle className=\"text-base\">案件描述</CardTitle>\r\n                                    </CardHeader>\r\n                                    <CardContent>\r\n                                        <p className=\"text-slate-600 leading-relaxed\">\r\n                                            {caseItem.description || \"暂无描述\"}\r\n                                        </p>\r\n                                    </CardContent>\r\n                                </Card>\r\n\r\n                                <div className=\"grid grid-cols-2 gap-4\">\r\n                                    <Card>\r\n                                        <CardContent className=\"p-4 flex items-center gap-4\">\r\n                                            <div className=\"h-10 w-10 rounded-lg bg-blue-50 flex items-center justify-center text-blue-600\">\r\n                                                <CheckSquare className=\"h-5 w-5\" />\r\n                                            </div>\r\n                                            <div>\r\n                                                <div className=\"text-2xl font-bold\">{caseItem.tasks.length}</div>\r\n                                                <div className=\"text-xs text-slate-500\">关联任务</div>\r\n                                            </div>\r\n                                        </CardContent>\r\n                                    </Card>\r\n                                    <Card>\r\n                                        <CardContent className=\"p-4 flex items-center gap-4\">\r\n                                            <div className=\"h-10 w-10 rounded-lg bg-orange-50 flex items-center justify-center text-orange-600\">\r\n                                                <Clock className=\"h-5 w-5\" />\r\n                                            </div>\r\n                                            <div>\r\n                                                <div className=\"text-2xl font-bold\">{caseItem.timeLogs.length}</div>\r\n                                                <div className=\"text-xs text-slate-500\">工时记录</div>\r\n                                            </div>\r\n                                        </CardContent>\r\n                                    </Card>\r\n                                </div>\r\n                            </div>\r\n                        )}\r\n\r\n                        {activeTab === 'parties' && (\r\n                            <CasePartiesTab caseId={caseItem.id} />\r\n                        )}\r\n\r\n                        {activeTab === 'tasks' && (\r\n                            <CaseTaskKanban\r\n                                caseId={caseItem.id}\r\n                                lawyers={caseItem.members?.map((m: any) => m.user) || []}\r\n                            />\r\n                        )}\r\n\r\n                        {activeTab === 'documents' && (\r\n                            <Card>\r\n                                <CardHeader className=\"flex flex-row items-center justify-between\">\r\n                                    <CardTitle className=\"text-base\">案件文档</CardTitle>\r\n                                    <Dialog open={uploadOpen} onOpenChange={setUploadOpen}>\r\n                                        <DialogTrigger asChild>\r\n                                            <Button size=\"sm\" variant=\"outline\">\r\n                                                <Plus className=\"h-4 w-4 mr-1\" /> 上传文档\r\n                                            </Button>\r\n                                        </DialogTrigger>\r\n                                        <DialogContent>\r\n                                            <DialogHeader>\r\n                                                <DialogTitle>上传案件文档</DialogTitle>\r\n                                            </DialogHeader>\r\n                                            <form action={handleCaseDocUpload} className=\"space-y-4\">\r\n                                                <input type=\"hidden\" name=\"caseId\" value={caseItem.id} />\r\n                                                <div className=\"grid gap-2\">\r\n                                                    <Label htmlFor=\"file\">选择文件</Label>\r\n                                                    <Input id=\"file\" name=\"file\" type=\"file\" required />\r\n                                                </div>\r\n                                                <div className=\"grid gap-2\">\r\n                                                    <Label htmlFor=\"title\">文档标题</Label>\r\n                                                    <Input id=\"title\" name=\"title\" placeholder=\"例如：起诉状副本\" />\r\n                                                </div>\r\n                                                <div className=\"grid gap-2\">\r\n                                                    <Label htmlFor=\"category\">文档分类</Label>\r\n                                                    <Select name=\"category\">\r\n                                                        <SelectTrigger>\r\n                                                            <SelectValue placeholder=\"选择分类\" />\r\n                                                        </SelectTrigger>\r\n                                                        <SelectContent>\r\n                                                            <SelectItem value=\"litigation\">诉讼文书</SelectItem>\r\n                                                            <SelectItem value=\"evidence\">证据材料</SelectItem>\r\n                                                            <SelectItem value=\"contract\">合同文书</SelectItem>\r\n                                                            <SelectItem value=\"procedure\">程序文书</SelectItem>\r\n                                                            <SelectItem value=\"other\">其他</SelectItem>\r\n                                                        </SelectContent>\r\n                                                    </Select>\r\n                                                </div>\r\n                                                <div className=\"grid gap-2\">\r\n                                                    <Label htmlFor=\"notes\">备注</Label>\r\n                                                    <Textarea id=\"notes\" name=\"notes\" placeholder=\"添加文档备注...\" rows={2} />\r\n                                                </div>\r\n                                                <DialogFooter>\r\n                                                    <Button type=\"button\" variant=\"outline\" onClick={() => setUploadOpen(false)}>\r\n                                                        取消\r\n                                                    </Button>\r\n                                                    <Button type=\"submit\" disabled={uploading}>\r\n                                                        {uploading ? \"上传中...\" : \"确认上传\"}\r\n                                                    </Button>\r\n                                                </DialogFooter>\r\n                                            </form>\r\n                                        </DialogContent>\r\n                                    </Dialog>\r\n                                </CardHeader>\r\n                                <CardContent>\r\n                                    {stageProgress?.currentStage && ['LITIGATION', 'ARBITRATION'].includes(caseItem.serviceType) && (\r\n                                        <div className=\"mb-6\">\r\n                                            <StageDocumentChecklist\r\n                                                caseId={caseItem.id}\r\n                                                currentStage={stageProgress.currentStage as LitigationStage}\r\n                                                documents={caseItem.documents}\r\n                                                onDocumentUpdated={async () => {\r\n                                                    router.refresh()\r\n                                                    await loadStageProgress()\r\n                                                }}\r\n                                            />\r\n                                        </div>\r\n                                    )}\r\n                                    <div className=\"space-y-2\">\r\n                                        {caseItem.documents.map((doc: any) => (\r\n                                            <div key={doc.id} className=\"flex items-center justify-between p-3 rounded-lg border hover:bg-slate-50\">\r\n                                                <div className=\"flex items-center gap-3\">\r\n                                                    <FileText className=\"h-5 w-5 text-blue-500\" />\r\n                                                    <div>\r\n                                                        <Link href={`/documents/${doc.id}`} className=\"font-medium text-slate-900 hover:underline\">\r\n                                                            {doc.title}\r\n                                                        </Link>\r\n                                                        <div className=\"text-xs text-slate-500\">\r\n                                                            {formatFileTypeLabel(doc.fileType)} • {(doc.fileSize / 1024).toFixed(1)} KB\r\n                                                        </div>\r\n                                                    </div>\r\n                                                </div>\r\n                                                <Button size=\"icon\" variant=\"ghost\" onClick={() => handleDocDownload(doc)}>\r\n                                                    <Download className=\"h-4 w-4\" />\r\n                                                </Button>\r\n                                            </div>\r\n                                        ))}\r\n                                        {caseItem.documents.length === 0 && <div className=\"text-center py-8 text-slate-400\">暂无文档</div>}\r\n                                    </div>\r\n                                </CardContent>\r\n                            </Card>\r\n                        )}\r\n\r\n                        {activeTab === 'timelog' && (\r\n                            <Card>\r\n                                <CardHeader className=\"flex flex-row items-center justify-between\">\r\n                                    <CardTitle className=\"text-base\">工时记录</CardTitle>\r\n                                    <Button size=\"sm\" variant=\"outline\"><Plus className=\"h-4 w-4 mr-1\" /> 记工时</Button>\r\n                                </CardHeader>\r\n                                <CardContent>\r\n                                    <div className=\"space-y-4\">\r\n                                        {caseItem.timeLogs.map((log: any) => (\r\n                                            <div key={log.id} className=\"flex items-center justify-between border-b pb-4 last:border-0 last:pb-0\">\r\n                                                <div>\r\n                                                    <div className=\"font-medium\">{log.description}</div>\r\n                                                    <div className=\"text-xs text-slate-500\">{new Date(log.startTime).toLocaleString()}</div>\r\n                                                </div>\r\n                                                <div className=\"font-bold font-mono\">{formatDurationHMS(log.duration)}</div>\r\n                                            </div>\r\n                                        ))}\r\n                                        {caseItem.timeLogs.length === 0 && <div className=\"text-center py-8 text-slate-400\">暂无工时记录</div>}\r\n                                    </div>\r\n                                </CardContent>\r\n                            </Card>\r\n                        )}\r\n\r\n                        {activeTab === 'events' && (\r\n                            <Card>\r\n                                <CardHeader className=\"flex flex-row items-center justify-between\">\r\n                                    <CardTitle className=\"text-base\">相关日程</CardTitle>\r\n                                    <Button size=\"sm\" variant=\"outline\"><Plus className=\"h-4 w-4 mr-1\" /> 新建日程</Button>\r\n                                </CardHeader>\r\n                                <CardContent>\r\n                                    <div className=\"space-y-2\">\r\n                                        {caseItem.events.map((event: any) => (\r\n                                            <div key={event.id} className=\"flex items-center gap-4 p-3 rounded-lg border bg-slate-50\">\r\n                                                <div className=\"text-center min-w-[50px]\">\r\n                                                    <div className=\"text-xs text-red-500 font-bold\">{new Date(event.startTime).toLocaleString('default', { month: 'short' })}</div>\r\n                                                    <div className=\"text-xl font-bold text-slate-900\">{new Date(event.startTime).getDate()}</div>\r\n                                                </div>\r\n                                                <div>\r\n                                                    <div className=\"font-medium\">{event.title}</div>\r\n                                                    <div className=\"text-xs text-slate-500\">{new Date(event.startTime).toLocaleTimeString()} - {new Date(event.endTime).toLocaleTimeString()}</div>\r\n                                                </div>\r\n                                            </div>\r\n                                        ))}\r\n                                        {caseItem.events.length === 0 && <div className=\"text-center py-8 text-slate-400\">暂无日程</div>}\r\n                                    </div>\r\n                                </CardContent>\r\n                            </Card>\r\n                        )}\r\n\r\n                        {activeTab === 'timeline' && (\r\n                            <CaseTimelineTab caseId={caseItem.id} />\r\n                        )}\r\n\r\n                        {activeTab === 'billing' && (\r\n                            <CaseBillingTab caseId={caseItem.id} />\r\n                        )}\r\n\r\n                        {activeTab === 'settings' && (\r\n                            <CaseSettingsTab caseItem={caseItem} />\r\n                        )}\r\n                    </div>\r\n                </div>\r\n\r\n                {/* Right Column: Sidebar Info */}\r\n                <div className=\"space-y-6\">\r\n                    {/* Team Members */}\r\n                    <CaseTeamCard\r\n                        caseId={caseItem.id}\r\n                        owner={caseItem.owner}\r\n                        members={caseItem.members}\r\n                        currentUserId={currentUser?.id}\r\n                    />\r\n\r\n                    <Card>\r\n                        <CardHeader>\r\n                            <CardTitle className=\"text-base\">客户信息</CardTitle>\r\n                        </CardHeader>\r\n                        <CardContent className=\"space-y-4\">\r\n                            <div className=\"flex items-center gap-3\">\r\n                                <div className=\"h-10 w-10 rounded-full bg-slate-100 flex items-center justify-center\">\r\n                                    <User className=\"h-5 w-5 text-slate-500\" />\r\n                                </div>\r\n                                <div>\r\n                                    <div className=\"font-medium\">{caseItem.clientName}</div>\r\n                                    <div className=\"text-xs text-slate-500\">ID: {caseItem.id.slice(0, 8)}</div>\r\n                                </div>\r\n                            </div>\r\n                            <Separator />\r\n                            <div className=\"space-y-2 text-sm\">\r\n                                <div className=\"flex justify-between\">\n                                    <span className=\"text-slate-500\">联系电话</span>\n                                    <span className={caseItem.client?.phone ? \"text-blue-600\" : \"text-slate-400\"}>\n                                        {caseItem.client?.phone || \"未填写\"}\n                                    </span>\n                                </div>\n                                <div className=\"flex justify-between\">\n                                    <span className=\"text-slate-500\">邮箱</span>\n                                    <span className={caseItem.client?.email ? \"text-slate-900\" : \"text-slate-400\"}>\n                                        {caseItem.client?.email || \"未填写\"}\n                                    </span>\n                                </div>\n                            </div>\n                        </CardContent>\n                    </Card>\n\r\n                    {/* 阶段管理 - 诉讼/仲裁/非诉案件显示 */}\r\n                    {['LITIGATION', 'ARBITRATION', 'NON_LITIGATION'].includes(caseItem.serviceType) && (\r\n                        loadingStage ? (\r\n                            <Card>\r\n                                <CardContent className=\"p-6 flex items-center justify-center\">\r\n                                    <Loader2 className=\"h-6 w-6 animate-spin text-orange-500\" />\r\n                                </CardContent>\r\n                            </Card>\r\n                        ) : stageProgress ? (\r\n                            <CaseStageTimeline\r\n                                caseId={caseItem.id}\r\n                                stageProgress={stageProgress}\r\n                                onStageAdvanced={handleStageAdvanced}\r\n                            />\r\n                        ) : (\r\n                            <Card>\r\n                                <CardHeader>\r\n                                    <CardTitle className=\"text-base flex items-center gap-2\">\r\n                                        <Scale className=\"h-4 w-4 text-orange-500\" />\r\n                                        案件阶段管理\r\n                                    </CardTitle>\r\n                                </CardHeader>\r\n                                <CardContent>\r\n                                    <p className=\"text-sm text-muted-foreground mb-4\">\r\n                                        初始化阶段文书和任务模板\r\n                                    </p>\r\n                                    <Button\r\n                                        onClick={handleInitializeDocs}\r\n                                        disabled={initializingDocs}\r\n                                        className=\"w-full bg-orange-500 hover:bg-orange-600\"\r\n                                    >\r\n                                        {initializingDocs ? (\r\n                                            <>\r\n                                                <Loader2 className=\"h-4 w-4 mr-2 animate-spin\" />\r\n                                                初始化中...\r\n                                            </>\r\n                                        ) : (\r\n                                            '初始化阶段模板'\r\n                                        )}\r\n                                    </Button>\r\n                                </CardContent>\r\n                            </Card>\r\n                        )\r\n                    )}\r\n                </div>\r\n            </div>\r\n        </div>\r\n    )\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"D:\\Desktop\\LawClick_NEW\\lawclick-next\\src\\components\\cases\\CaseListClient.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'Filter' is defined but never used.","line":13,"column":5,"nodeType":null,"messageId":"unusedVar","endLine":13,"endColumn":11},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'Edit' is defined but never used.","line":20,"column":5,"nodeType":null,"messageId":"unusedVar","endLine":20,"endColumn":9},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'caseId' is defined but never used.","line":114,"column":29,"nodeType":null,"messageId":"unusedVar","endLine":114,"endColumn":35},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'caseCode' is defined but never used.","line":114,"column":37,"nodeType":null,"messageId":"unusedVar","endLine":114,"endColumn":45}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":4,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\"\r\n\r\nimport { useState, useEffect } from \"react\"\r\nimport { useRouter, useSearchParams } from \"next/navigation\"\r\nimport { Card, CardContent, CardHeader, CardTitle, CardDescription } from \"@/components/ui/card\"\r\nimport { Button } from \"@/components/ui/button\"\r\nimport { Input } from \"@/components/ui/input\"\r\nimport { Badge } from \"@/components/ui/badge\"\r\nimport { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from \"@/components/ui/select\"\r\nimport { Progress } from \"@/components/ui/progress\"\r\nimport {\r\n    Search,\r\n    Filter,\r\n    Plus,\r\n    FileText,\r\n    Clock,\r\n    Calendar,\r\n    Users,\r\n    Eye,\r\n    Edit,\r\n    MoreHorizontal,\r\n    Briefcase,\r\n    LayoutGrid,\r\n    Kanban,\r\n    List\r\n} from \"lucide-react\"\r\nimport Link from \"next/link\"\r\nimport { CreateCaseWizard } from \"./CreateCaseWizard\"\r\n\r\ninterface Case {\r\n    id: string\r\n    caseCode: string\r\n    title: string\r\n    clientName: string\r\n    status: string\r\n    caseType: string\r\n    progress: number\r\n    contractValue: number | string\r\n    updatedAt: Date\r\n}\r\n\r\ninterface CaseListClientProps {\r\n    initialCases: Case[]\r\n}\r\n\r\nexport function CaseListClient({ initialCases }: CaseListClientProps) {\r\n    const router = useRouter()\r\n    const searchParams = useSearchParams()\r\n\r\n    const [searchTerm, setSearchTerm] = useState(searchParams.get(\"q\") || \"\")\r\n    const [statusFilter, setStatusFilter] = useState(searchParams.get(\"status\") || \"all\")\r\n    const [typeFilter, setTypeFilter] = useState(searchParams.get(\"type\") || \"all\")\r\n    const [showWizard, setShowWizard] = useState(false)\r\n    const [viewMode, setViewMode] = useState<'grid' | 'kanban' | 'list'>('grid')\r\n\r\n    // Debounce search\n    useEffect(() => {\n        const timer = setTimeout(() => {\n            const params = new URLSearchParams()\n            if (searchTerm) params.set(\"q\", searchTerm)\n            if (statusFilter && statusFilter !== \"all\") params.set(\"status\", statusFilter)\n            if (typeFilter && typeFilter !== \"all\") params.set(\"type\", typeFilter)\n\n            const nextQuery = params.toString()\n            const currentQuery = searchParams.toString()\n            const nextUrl = nextQuery ? `/cases?${nextQuery}` : \"/cases\"\n            const currentUrl = currentQuery ? `/cases?${currentQuery}` : \"/cases\"\n\n            if (nextUrl !== currentUrl) {\n                router.push(nextUrl)\n            }\n        }, 300)\n\n        return () => clearTimeout(timer)\n    }, [searchTerm, statusFilter, typeFilter, router, searchParams])\n\r\n    const getStatusColor = (status: string) => {\r\n        switch (status) {\r\n            case 'ACTIVE': return 'bg-blue-100 text-blue-800 hover:bg-blue-100'\r\n            case 'COMPLETED': return 'bg-green-100 text-green-800 hover:bg-green-100'\r\n            case 'WAITING': return 'bg-yellow-100 text-yellow-800 hover:bg-yellow-100'\r\n            case 'DRAFT': return 'bg-slate-100 text-slate-800 hover:bg-slate-100'\r\n            default: return 'bg-slate-100 text-slate-800'\r\n        }\r\n    }\r\n\r\n    const getStatusText = (status: string) => {\r\n        switch (status) {\r\n            case 'ACTIVE': return '进行中'\r\n            case 'COMPLETED': return '已结案'\r\n            case 'WAITING': return '等待中'\r\n            case 'DRAFT': return '草稿'\r\n            default: return status\r\n        }\r\n    }\r\n\r\n    return (\r\n        <div className=\"space-y-6\">\r\n            {/* Header */}\r\n            <div className=\"flex flex-col sm:flex-row sm:items-center justify-between gap-4\">\r\n                <div>\r\n                    <h1 className=\"text-2xl font-bold tracking-tight\">案件管理</h1>\r\n                    <p className=\"text-muted-foreground\">管理和跟踪所有法律案件</p>\r\n                </div>\r\n                <Button className=\"bg-primary hover:bg-primary/90\" onClick={() => setShowWizard(true)}>\r\n                    <Plus className=\"mr-2 h-4 w-4\" /> 新建案件\r\n                </Button>\r\n            </div>\r\n\r\n            {/* 新建案件向导 */}\r\n            <CreateCaseWizard\r\n                open={showWizard}\r\n                onOpenChange={setShowWizard}\r\n                onSuccess={(caseId, caseCode) => {\r\n                    router.refresh()\r\n                }}\r\n            />\r\n\r\n            {/* Stats Cards */}\r\n            <div className=\"grid gap-4 md:grid-cols-4\">\r\n                <Card>\r\n                    <CardHeader className=\"flex flex-row items-center justify-between space-y-0 pb-2\">\r\n                        <CardTitle className=\"text-sm font-medium\">总案件数</CardTitle>\r\n                        <FileText className=\"h-4 w-4 text-muted-foreground\" />\r\n                    </CardHeader>\r\n                    <CardContent>\r\n                        <div className=\"text-2xl font-bold\">{initialCases.length}</div>\r\n                    </CardContent>\r\n                </Card>\r\n                <Card>\r\n                    <CardHeader className=\"flex flex-row items-center justify-between space-y-0 pb-2\">\r\n                        <CardTitle className=\"text-sm font-medium\">进行中</CardTitle>\r\n                        <Clock className=\"h-4 w-4 text-blue-500\" />\r\n                    </CardHeader>\r\n                    <CardContent>\r\n                        <div className=\"text-2xl font-bold text-blue-600\">\r\n                            {initialCases.filter(c => c.status === 'ACTIVE').length}\r\n                        </div>\r\n                    </CardContent>\r\n                </Card>\r\n                <Card>\r\n                    <CardHeader className=\"flex flex-row items-center justify-between space-y-0 pb-2\">\r\n                        <CardTitle className=\"text-sm font-medium\">待处理</CardTitle>\r\n                        <Calendar className=\"h-4 w-4 text-yellow-500\" />\r\n                    </CardHeader>\r\n                    <CardContent>\r\n                        <div className=\"text-2xl font-bold text-yellow-600\">\r\n                            {initialCases.filter(c => c.status === 'WAITING').length}\r\n                        </div>\r\n                    </CardContent>\r\n                </Card>\r\n                <Card>\r\n                    <CardHeader className=\"flex flex-row items-center justify-between space-y-0 pb-2\">\r\n                        <CardTitle className=\"text-sm font-medium\">已结案</CardTitle>\r\n                        <Users className=\"h-4 w-4 text-green-500\" />\r\n                    </CardHeader>\r\n                    <CardContent>\r\n                        <div className=\"text-2xl font-bold text-green-600\">\r\n                            {initialCases.filter(c => c.status === 'COMPLETED').length}\r\n                        </div>\r\n                    </CardContent>\r\n                </Card>\r\n            </div>\r\n\r\n            {/* Filters */}\r\n            <Card>\r\n                <CardHeader>\r\n                    <CardTitle>案件列表</CardTitle>\r\n                    <CardDescription>查看和筛选您的案件</CardDescription>\r\n                </CardHeader>\r\n                <CardContent>\r\n                    <div className=\"flex flex-col md:flex-row gap-4 mb-6\">\r\n                        <div className=\"relative flex-1\">\r\n                            <Search className=\"absolute left-3 top-1/2 transform -translate-y-1/2 h-4 w-4 text-muted-foreground\" />\r\n                            <Input\r\n                                placeholder=\"搜索案件标题、编号或客户...\"\r\n                                className=\"pl-10\"\r\n                                value={searchTerm}\r\n                                onChange={(e) => setSearchTerm(e.target.value)}\r\n                            />\r\n                        </div>\r\n                        <Select value={statusFilter} onValueChange={setStatusFilter}>\r\n                            <SelectTrigger className=\"w-[180px]\">\r\n                                <SelectValue placeholder=\"状态\" />\r\n                            </SelectTrigger>\r\n                            <SelectContent>\r\n                                <SelectItem value=\"all\">全部状态</SelectItem>\r\n                                <SelectItem value=\"LEAD\">线索</SelectItem>\r\n                                <SelectItem value=\"INTAKE\">立案中</SelectItem>\r\n                                <SelectItem value=\"ACTIVE\">在办</SelectItem>\r\n                                <SelectItem value=\"SUSPENDED\">中止</SelectItem>\r\n                                <SelectItem value=\"CLOSED\">结案</SelectItem>\r\n                                <SelectItem value=\"ARCHIVED\">归档</SelectItem>\r\n                            </SelectContent>\r\n                        </Select>\r\n                        <Select value={typeFilter} onValueChange={setTypeFilter}>\r\n                            <SelectTrigger className=\"w-[180px]\">\r\n                                <SelectValue placeholder=\"类型\" />\r\n                            </SelectTrigger>\r\n                            <SelectContent>\r\n                                <SelectItem value=\"all\">全部类型</SelectItem>\r\n                                <SelectItem value=\"LITIGATION\">诉讼</SelectItem>\r\n                                <SelectItem value=\"NON_LITIGATION\">非诉</SelectItem>\r\n                                <SelectItem value=\"ARBITRATION\">仲裁</SelectItem>\r\n                                <SelectItem value=\"ADVISORY\">顾问</SelectItem>\r\n                            </SelectContent>\r\n                        </Select>\r\n                        <div className=\"flex gap-1 border rounded-md p-1\">\r\n                            <Button\r\n                                variant={viewMode === 'grid' ? 'secondary' : 'ghost'}\r\n                                size=\"sm\"\r\n                                onClick={() => setViewMode('grid')}\r\n                            >\r\n                                <LayoutGrid className=\"h-4 w-4\" />\r\n                            </Button>\r\n                            <Button\r\n                                variant={viewMode === 'kanban' ? 'secondary' : 'ghost'}\r\n                                size=\"sm\"\r\n                                onClick={() => setViewMode('kanban')}\r\n                            >\r\n                                <Kanban className=\"h-4 w-4\" />\r\n                            </Button>\r\n                            <Button\r\n                                variant={viewMode === 'list' ? 'secondary' : 'ghost'}\r\n                                size=\"sm\"\r\n                                onClick={() => setViewMode('list')}\r\n                            >\r\n                                <List className=\"h-4 w-4\" />\r\n                            </Button>\r\n                        </div>\r\n                    </div>\r\n\r\n                    {/* 卡片视图 */}\r\n                    {viewMode === 'grid' && (\r\n                        <div className=\"grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-6\">\r\n                            {initialCases.map((caseItem) => (\r\n                                <Card key={caseItem.id} className=\"hover:shadow-md transition-shadow group\">\r\n                                    <CardContent className=\"p-6\">\r\n                                        <div className=\"flex justify-between items-start mb-4\">\r\n                                            <div className=\"space-y-1\">\r\n                                                <Link href={`/cases/${caseItem.id}`} className=\"font-semibold text-lg hover:text-primary transition-colors block\">\r\n                                                    {caseItem.title}\r\n                                                </Link>\r\n                                                <p className=\"text-sm text-muted-foreground\">{caseItem.caseCode}</p>\r\n                                            </div>\r\n                                            <Badge className={getStatusColor(caseItem.status)} variant=\"secondary\">\r\n                                                {getStatusText(caseItem.status)}\r\n                                            </Badge>\r\n                                        </div>\r\n\r\n                                        <div className=\"space-y-3 mb-4\">\r\n                                            <div className=\"flex justify-between text-sm\">\r\n                                                <span className=\"text-muted-foreground\">客户</span>\r\n                                                <span className=\"font-medium\">{caseItem.clientName}</span>\r\n                                            </div>\r\n                                            <div className=\"flex justify-between text-sm\">\r\n                                                <span className=\"text-muted-foreground\">类型</span>\r\n                                                <Badge variant=\"outline\">{caseItem.caseType}</Badge>\r\n                                            </div>\r\n                                            <div className=\"flex justify-between text-sm\">\r\n                                                <span className=\"text-muted-foreground\">标的额</span>\r\n                                                <span className=\"font-medium\">¥{Number(caseItem.contractValue).toLocaleString()}</span>\r\n                                            </div>\r\n                                        </div>\r\n\r\n                                        <div className=\"space-y-2 mb-4\">\r\n                                            <div className=\"flex justify-between text-xs text-muted-foreground\">\r\n                                                <span>进度</span>\r\n                                                <span>{caseItem.progress}%</span>\r\n                                            </div>\r\n                                            <Progress value={caseItem.progress} className=\"h-2\" />\r\n                                        </div>\r\n\r\n                                        <div className=\"flex gap-2 pt-2\">\r\n                                            <Button variant=\"outline\" size=\"sm\" className=\"flex-1\" asChild>\r\n                                                <Link href={`/cases/${caseItem.id}`}>\r\n                                                    <Eye className=\"mr-2 h-4 w-4\" /> 查看\r\n                                                </Link>\r\n                                            </Button>\r\n                                            <Button variant=\"ghost\" size=\"icon\" className=\"h-8 w-8\">\r\n                                                <MoreHorizontal className=\"h-4 w-4\" />\r\n                                            </Button>\r\n                                        </div>\r\n                                    </CardContent>\r\n                                </Card>\r\n                            ))}\r\n                        </div>\r\n                    )}\r\n\r\n                    {/* 看板视图 */}\r\n                    {viewMode === 'kanban' && (\r\n                        <div className=\"grid grid-cols-6 gap-4\">\r\n                            {['LEAD', 'INTAKE', 'ACTIVE', 'SUSPENDED', 'CLOSED', 'ARCHIVED'].map((status) => {\r\n                                const statusCases = initialCases.filter(c => c.status === status)\r\n                                const statusLabels: Record<string, string> = {\r\n                                    LEAD: '线索', INTAKE: '立案', ACTIVE: '在办',\r\n                                    SUSPENDED: '中止', CLOSED: '结案', ARCHIVED: '归档'\r\n                                }\r\n                                return (\r\n                                    <div key={status} className=\"bg-slate-50 rounded-lg p-3 min-h-[400px]\">\r\n                                        <div className=\"flex items-center justify-between mb-3\">\r\n                                            <h3 className=\"font-medium text-sm\">{statusLabels[status]}</h3>\r\n                                            <Badge variant=\"secondary\">{statusCases.length}</Badge>\r\n                                        </div>\r\n                                        <div className=\"space-y-2\">\r\n                                            {statusCases.map((c) => (\r\n                                                <Link key={c.id} href={`/cases/${c.id}`}>\r\n                                                    <Card className=\"cursor-pointer hover:shadow-sm transition-shadow\">\r\n                                                        <CardContent className=\"p-3\">\r\n                                                            <div className=\"font-medium text-sm truncate\">{c.title}</div>\r\n                                                            <div className=\"text-xs text-muted-foreground mt-1\">{c.caseCode}</div>\r\n                                                            <div className=\"text-xs text-muted-foreground\">{c.clientName}</div>\r\n                                                        </CardContent>\r\n                                                    </Card>\r\n                                                </Link>\r\n                                            ))}\r\n                                        </div>\r\n                                    </div>\r\n                                )\r\n                            })}\r\n                        </div>\r\n                    )}\r\n\r\n                    {/* 列表视图 */}\r\n                    {viewMode === 'list' && (\r\n                        <div className=\"border rounded-lg divide-y\">\r\n                            {initialCases.map((caseItem) => (\r\n                                <Link key={caseItem.id} href={`/cases/${caseItem.id}`}>\r\n                                    <div className=\"flex items-center justify-between p-4 hover:bg-slate-50 transition-colors\">\r\n                                        <div className=\"flex items-center gap-4\">\r\n                                            <div>\r\n                                                <div className=\"font-medium\">{caseItem.title}</div>\r\n                                                <div className=\"text-sm text-muted-foreground\">{caseItem.caseCode} · {caseItem.clientName}</div>\r\n                                            </div>\r\n                                        </div>\r\n                                        <div className=\"flex items-center gap-4\">\r\n                                            <Badge className={getStatusColor(caseItem.status)}>{getStatusText(caseItem.status)}</Badge>\r\n                                            <div className=\"text-sm w-16\">{caseItem.progress}%</div>\r\n                                            <div className=\"text-sm text-muted-foreground w-32\">¥{Number(caseItem.contractValue).toLocaleString()}</div>\r\n                                        </div>\r\n                                    </div>\r\n                                </Link>\r\n                            ))}\r\n                        </div>\r\n                    )}\r\n\r\n                    {initialCases.length === 0 && (\r\n                        <div className=\"text-center py-12\">\r\n                            <div className=\"inline-flex items-center justify-center w-12 h-12 rounded-full bg-slate-100 mb-4\">\r\n                                <Briefcase className=\"h-6 w-6 text-slate-400\" />\r\n                            </div>\r\n                            <h3 className=\"text-lg font-medium text-slate-900\">暂无案件</h3>\r\n                            <p className=\"text-slate-500 mt-1\">没有找到匹配的案件，请尝试调整筛选条件。</p>\r\n                        </div>\r\n                    )}\r\n                </CardContent>\r\n            </Card>\r\n        </div>\r\n    )\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"D:\\Desktop\\LawClick_NEW\\lawclick-next\\src\\components\\cases\\CasePartiesTab.tsx","messages":[{"ruleId":"react-hooks/set-state-in-effect","severity":1,"message":"Error: Calling setState synchronously within an effect can trigger cascading renders\n\nEffects are intended to synchronize state between React and external systems such as manually updating the DOM, state management libraries, or other platform APIs. In general, the body of an effect should do one or both of the following:\n* Update external systems with the latest state from React.\n* Subscribe for updates from some external system, calling setState in a callback function when external state changes.\n\nCalling setState synchronously within an effect body causes cascading renders that can hurt performance, and is not recommended. (https://react.dev/learn/you-might-not-need-an-effect).\n\nD:\\Desktop\\LawClick_NEW\\lawclick-next\\src\\components\\cases\\CasePartiesTab.tsx:78:9\n  76 |\n  77 |     useEffect(() => {\n> 78 |         loadParties()\n     |         ^^^^^^^^^^^ Avoid calling setState() directly within an effect\n  79 |     }, [caseId])\n  80 |\n  81 |     // 打开新增对话框","line":78,"column":9,"nodeType":null,"endLine":78,"endColumn":20},{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has a missing dependency: 'loadParties'. Either include it or remove the dependency array.","line":79,"column":8,"nodeType":"ArrayExpression","endLine":79,"endColumn":16,"suggestions":[{"desc":"Update the dependencies array to be: [caseId, loadParties]","fix":{"range":[2041,2049],"text":"[caseId, loadParties]"}}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":2,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\"\r\n\r\nimport { useState, useEffect } from \"react\"\r\nimport { Card, CardHeader, CardTitle, CardContent } from \"@/components/ui/card\"\r\nimport { Button } from \"@/components/ui/button\"\r\nimport { Input } from \"@/components/ui/input\"\r\nimport { Label } from \"@/components/ui/label\"\r\nimport { Badge } from \"@/components/ui/badge\"\r\nimport {\r\n    Dialog,\r\n    DialogContent,\r\n    DialogHeader,\r\n    DialogTitle,\r\n    DialogFooter,\r\n} from \"@/components/ui/dialog\"\r\nimport {\r\n    Select,\r\n    SelectContent,\r\n    SelectItem,\r\n    SelectTrigger,\r\n    SelectValue,\r\n} from \"@/components/ui/select\"\r\nimport {\r\n    Table,\r\n    TableBody,\r\n    TableCell,\r\n    TableHead,\r\n    TableHeader,\r\n    TableRow,\r\n} from \"@/components/ui/table\"\r\nimport { Textarea } from \"@/components/ui/textarea\"\r\nimport {\r\n    UserPlus,\r\n    Pencil,\r\n    Trash2,\r\n    User,\r\n    Building2,\r\n    Phone,\r\n    Mail,\r\n} from \"lucide-react\"\r\nimport {\n    getCaseParties,\n    addParty,\n    updateParty,\n    deleteParty,\n    type PartyInput,\n} from \"@/actions/party-actions\"\nimport { PARTY_RELATION_LABELS, PARTY_TYPE_LABELS } from \"@/lib/party-labels\"\nimport type { PartyType, PartyRelation, Party } from \"@prisma/client\"\n\r\ninterface CasePartiesTabProps {\r\n    caseId: string\r\n}\r\n\r\nexport function CasePartiesTab({ caseId }: CasePartiesTabProps) {\r\n    const [parties, setParties] = useState<Party[]>([])\r\n    const [loading, setLoading] = useState(true)\r\n    const [dialogOpen, setDialogOpen] = useState(false)\r\n    const [editingParty, setEditingParty] = useState<Party | null>(null)\r\n    const [formData, setFormData] = useState<Partial<PartyInput>>({\r\n        caseId,\r\n        type: 'PLAINTIFF',\r\n        relation: 'CLIENT',\r\n        entityType: 'INDIVIDUAL',\r\n    })\r\n\r\n    // 加载当事人列表\r\n    const loadParties = async () => {\r\n        setLoading(true)\r\n        const result = await getCaseParties(caseId)\r\n        if (result.success) {\r\n            setParties(result.data)\r\n        }\r\n        setLoading(false)\r\n    }\r\n\r\n    useEffect(() => {\r\n        loadParties()\r\n    }, [caseId])\r\n\r\n    // 打开新增对话框\r\n    const handleAdd = () => {\r\n        setEditingParty(null)\r\n        setFormData({\r\n            caseId,\r\n            type: 'PLAINTIFF',\r\n            relation: 'CLIENT',\r\n            entityType: 'INDIVIDUAL',\r\n        })\r\n        setDialogOpen(true)\r\n    }\r\n\r\n    // 打开编辑对话框\r\n    const handleEdit = (party: Party) => {\r\n        setEditingParty(party)\r\n        setFormData({\r\n            ...party,\r\n            entityType: (party.entityType as 'INDIVIDUAL' | 'COMPANY') || 'INDIVIDUAL',\r\n        })\r\n        setDialogOpen(true)\r\n    }\r\n\r\n    // 删除当事人\r\n    const handleDelete = async (id: string) => {\r\n        if (!confirm('确定删除此当事人？')) return\r\n        const result = await deleteParty(id)\r\n        if (result.success) {\r\n            loadParties()\r\n        }\r\n    }\r\n\r\n    // 提交表单\r\n    const handleSubmit = async () => {\r\n        if (!formData.name) return\r\n\r\n        const input: PartyInput = {\r\n            caseId,\r\n            name: formData.name,\r\n            type: formData.type as PartyType,\r\n            relation: formData.relation as PartyRelation,\r\n            entityType: formData.entityType,\r\n            idType: formData.idType,\r\n            idNumber: formData.idNumber,\r\n            phone: formData.phone,\r\n            email: formData.email,\r\n            address: formData.address,\r\n            attorney: formData.attorney,\r\n            attorneyPhone: formData.attorneyPhone,\r\n            notes: formData.notes,\r\n        }\r\n\r\n        let result\r\n        if (editingParty) {\r\n            result = await updateParty(editingParty.id, input)\r\n        } else {\r\n            result = await addParty(input)\r\n        }\r\n\r\n        if (result.success) {\r\n            setDialogOpen(false)\r\n            loadParties()\r\n        }\r\n    }\r\n\r\n    // 关系Badge颜色\r\n    const getRelationColor = (relation: PartyRelation) => {\r\n        switch (relation) {\r\n            case 'CLIENT':\r\n                return 'bg-green-100 text-green-700'\r\n            case 'OPPONENT':\r\n                return 'bg-red-100 text-red-700'\r\n            default:\r\n                return 'bg-slate-100 text-slate-700'\r\n        }\r\n    }\r\n\r\n    return (\r\n        <Card>\r\n            <CardHeader className=\"flex flex-row items-center justify-between\">\r\n                <CardTitle className=\"text-lg\">当事人管理</CardTitle>\r\n                <Button onClick={handleAdd} size=\"sm\">\r\n                    <UserPlus className=\"h-4 w-4 mr-2\" />\r\n                    添加当事人\r\n                </Button>\r\n            </CardHeader>\r\n            <CardContent>\r\n                {loading ? (\r\n                    <div className=\"text-center py-8 text-muted-foreground\">加载中...</div>\r\n                ) : parties.length === 0 ? (\r\n                    <div className=\"text-center py-8 text-muted-foreground\">\r\n                        暂无当事人信息\r\n                    </div>\r\n                ) : (\r\n                    <Table>\r\n                        <TableHeader>\r\n                            <TableRow>\r\n                                <TableHead>姓名/公司</TableHead>\r\n                                <TableHead>诉讼地位</TableHead>\r\n                                <TableHead>关系</TableHead>\r\n                                <TableHead>联系方式</TableHead>\r\n                                <TableHead className=\"text-right\">操作</TableHead>\r\n                            </TableRow>\r\n                        </TableHeader>\r\n                        <TableBody>\r\n                            {parties.map((party) => (\r\n                                <TableRow key={party.id}>\r\n                                    <TableCell>\r\n                                        <div className=\"flex items-center gap-2\">\r\n                                            {party.entityType === 'COMPANY' ? (\r\n                                                <Building2 className=\"h-4 w-4 text-muted-foreground\" />\r\n                                            ) : (\r\n                                                <User className=\"h-4 w-4 text-muted-foreground\" />\r\n                                            )}\r\n                                            <span className=\"font-medium\">{party.name}</span>\r\n                                        </div>\r\n                                        {party.idNumber && (\r\n                                            <div className=\"text-xs text-muted-foreground mt-1\">\r\n                                                {party.idType}: {party.idNumber}\r\n                                            </div>\r\n                                        )}\r\n                                    </TableCell>\r\n                                    <TableCell>\r\n                                        <Badge variant=\"outline\">\r\n                                            {PARTY_TYPE_LABELS[party.type]}\r\n                                        </Badge>\r\n                                    </TableCell>\r\n                                    <TableCell>\r\n                                        <Badge className={getRelationColor(party.relation)}>\r\n                                            {PARTY_RELATION_LABELS[party.relation]}\r\n                                        </Badge>\r\n                                    </TableCell>\r\n                                    <TableCell>\r\n                                        <div className=\"space-y-1\">\r\n                                            {party.phone && (\r\n                                                <div className=\"flex items-center gap-1 text-sm\">\r\n                                                    <Phone className=\"h-3 w-3\" />\r\n                                                    {party.phone}\r\n                                                </div>\r\n                                            )}\r\n                                            {party.email && (\r\n                                                <div className=\"flex items-center gap-1 text-sm\">\r\n                                                    <Mail className=\"h-3 w-3\" />\r\n                                                    {party.email}\r\n                                                </div>\r\n                                            )}\r\n                                        </div>\r\n                                    </TableCell>\r\n                                    <TableCell className=\"text-right\">\r\n                                        <Button\r\n                                            variant=\"ghost\"\r\n                                            size=\"sm\"\r\n                                            onClick={() => handleEdit(party)}\r\n                                        >\r\n                                            <Pencil className=\"h-4 w-4\" />\r\n                                        </Button>\r\n                                        <Button\r\n                                            variant=\"ghost\"\r\n                                            size=\"sm\"\r\n                                            onClick={() => handleDelete(party.id)}\r\n                                        >\r\n                                            <Trash2 className=\"h-4 w-4 text-red-500\" />\r\n                                        </Button>\r\n                                    </TableCell>\r\n                                </TableRow>\r\n                            ))}\r\n                        </TableBody>\r\n                    </Table>\r\n                )}\r\n            </CardContent>\r\n\r\n            {/* 添加/编辑对话框 */}\r\n            <Dialog open={dialogOpen} onOpenChange={setDialogOpen}>\r\n                <DialogContent className=\"max-w-2xl\">\r\n                    <DialogHeader>\r\n                        <DialogTitle>\r\n                            {editingParty ? '编辑当事人' : '添加当事人'}\r\n                        </DialogTitle>\r\n                    </DialogHeader>\r\n\r\n                    <div className=\"grid grid-cols-2 gap-4 py-4\">\r\n                        {/* 基本信息 */}\r\n                        <div className=\"space-y-2\">\r\n                            <Label>姓名/公司名 *</Label>\r\n                            <Input\r\n                                value={formData.name || ''}\r\n                                onChange={(e) => setFormData({ ...formData, name: e.target.value })}\r\n                                placeholder=\"输入姓名或公司名称\"\r\n                            />\r\n                        </div>\r\n\r\n                        <div className=\"space-y-2\">\r\n                            <Label>主体类型</Label>\r\n                            <Select\r\n                                value={formData.entityType}\r\n                                onValueChange={(v) => setFormData({ ...formData, entityType: v as 'INDIVIDUAL' | 'COMPANY' })}\r\n                            >\r\n                                <SelectTrigger>\r\n                                    <SelectValue />\r\n                                </SelectTrigger>\r\n                                <SelectContent>\r\n                                    <SelectItem value=\"INDIVIDUAL\">自然人</SelectItem>\r\n                                    <SelectItem value=\"COMPANY\">法人/企业</SelectItem>\r\n                                </SelectContent>\r\n                            </Select>\r\n                        </div>\r\n\r\n                        <div className=\"space-y-2\">\r\n                            <Label>诉讼地位 *</Label>\r\n                            <Select\r\n                                value={formData.type}\r\n                                onValueChange={(v) => setFormData({ ...formData, type: v as PartyType })}\r\n                            >\r\n                                <SelectTrigger>\r\n                                    <SelectValue />\r\n                                </SelectTrigger>\r\n                                <SelectContent>\r\n                                    {Object.entries(PARTY_TYPE_LABELS).map(([key, label]) => (\r\n                                        <SelectItem key={key} value={key}>{label}</SelectItem>\r\n                                    ))}\r\n                                </SelectContent>\r\n                            </Select>\r\n                        </div>\r\n\r\n                        <div className=\"space-y-2\">\r\n                            <Label>与本所关系 *</Label>\r\n                            <Select\r\n                                value={formData.relation}\r\n                                onValueChange={(v) => setFormData({ ...formData, relation: v as PartyRelation })}\r\n                            >\r\n                                <SelectTrigger>\r\n                                    <SelectValue />\r\n                                </SelectTrigger>\r\n                                <SelectContent>\r\n                                    {Object.entries(PARTY_RELATION_LABELS).map(([key, label]) => (\r\n                                        <SelectItem key={key} value={key}>{label}</SelectItem>\r\n                                    ))}\r\n                                </SelectContent>\r\n                            </Select>\r\n                        </div>\r\n\r\n                        {/* 证件信息 */}\r\n                        <div className=\"space-y-2\">\r\n                            <Label>证件类型</Label>\r\n                            <Select\r\n                                value={formData.idType || ''}\r\n                                onValueChange={(v) => setFormData({ ...formData, idType: v })}\r\n                            >\r\n                                <SelectTrigger>\r\n                                    <SelectValue placeholder=\"选择证件类型\" />\r\n                                </SelectTrigger>\r\n                                <SelectContent>\r\n                                    <SelectItem value=\"身份证\">身份证</SelectItem>\r\n                                    <SelectItem value=\"营业执照\">营业执照</SelectItem>\r\n                                    <SelectItem value=\"护照\">护照</SelectItem>\r\n                                    <SelectItem value=\"其他\">其他</SelectItem>\r\n                                </SelectContent>\r\n                            </Select>\r\n                        </div>\r\n\r\n                        <div className=\"space-y-2\">\r\n                            <Label>证件号码</Label>\r\n                            <Input\r\n                                value={formData.idNumber || ''}\r\n                                onChange={(e) => setFormData({ ...formData, idNumber: e.target.value })}\r\n                                placeholder=\"输入证件号码\"\r\n                            />\r\n                        </div>\r\n\r\n                        {/* 联系方式 */}\r\n                        <div className=\"space-y-2\">\r\n                            <Label>联系电话</Label>\r\n                            <Input\r\n                                value={formData.phone || ''}\r\n                                onChange={(e) => setFormData({ ...formData, phone: e.target.value })}\r\n                                placeholder=\"输入电话号码\"\r\n                            />\r\n                        </div>\r\n\r\n                        <div className=\"space-y-2\">\r\n                            <Label>电子邮箱</Label>\r\n                            <Input\r\n                                type=\"email\"\r\n                                value={formData.email || ''}\r\n                                onChange={(e) => setFormData({ ...formData, email: e.target.value })}\r\n                                placeholder=\"输入邮箱地址\"\r\n                            />\r\n                        </div>\r\n\r\n                        <div className=\"col-span-2 space-y-2\">\r\n                            <Label>地址</Label>\r\n                            <Input\r\n                                value={formData.address || ''}\r\n                                onChange={(e) => setFormData({ ...formData, address: e.target.value })}\r\n                                placeholder=\"输入联系地址\"\r\n                            />\r\n                        </div>\r\n\r\n                        {/* 代理人信息 */}\r\n                        <div className=\"space-y-2\">\r\n                            <Label>代理律师</Label>\r\n                            <Input\r\n                                value={formData.attorney || ''}\r\n                                onChange={(e) => setFormData({ ...formData, attorney: e.target.value })}\r\n                                placeholder=\"输入代理律师姓名\"\r\n                            />\r\n                        </div>\r\n\r\n                        <div className=\"space-y-2\">\r\n                            <Label>代理律师电话</Label>\r\n                            <Input\r\n                                value={formData.attorneyPhone || ''}\r\n                                onChange={(e) => setFormData({ ...formData, attorneyPhone: e.target.value })}\r\n                                placeholder=\"输入代理律师电话\"\r\n                            />\r\n                        </div>\r\n\r\n                        {/* 备注 */}\r\n                        <div className=\"col-span-2 space-y-2\">\r\n                            <Label>备注</Label>\r\n                            <Textarea\r\n                                value={formData.notes || ''}\r\n                                onChange={(e) => setFormData({ ...formData, notes: e.target.value })}\r\n                                placeholder=\"其他备注信息\"\r\n                                rows={2}\r\n                            />\r\n                        </div>\r\n                    </div>\r\n\r\n                    <DialogFooter>\r\n                        <Button variant=\"outline\" onClick={() => setDialogOpen(false)}>\r\n                            取消\r\n                        </Button>\r\n                        <Button onClick={handleSubmit} disabled={!formData.name}>\r\n                            {editingParty ? '保存' : '添加'}\r\n                        </Button>\r\n                    </DialogFooter>\r\n                </DialogContent>\r\n            </Dialog>\r\n        </Card>\r\n    )\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"D:\\Desktop\\LawClick_NEW\\lawclick-next\\src\\components\\cases\\CaseSettingsTab.tsx","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":34,"column":15,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":34,"endColumn":18,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1011,1014],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1011,1014],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":174,"column":65,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":174,"endColumn":68,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[6814,6817],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[6814,6817],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":2,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\"\n\nimport { useState } from \"react\"\nimport { useRouter } from \"next/navigation\"\nimport { Card, CardHeader, CardTitle, CardContent, CardDescription } from \"@/components/ui/card\"\nimport { Button } from \"@/components/ui/button\"\nimport { Input } from \"@/components/ui/input\"\nimport { Label } from \"@/components/ui/label\"\nimport { Badge } from \"@/components/ui/badge\"\nimport { Separator } from \"@/components/ui/separator\"\nimport {\n    Select,\n    SelectContent,\n    SelectItem,\n    SelectTrigger,\n    SelectValue,\n} from \"@/components/ui/select\"\nimport {\n    AlertDialog,\n    AlertDialogAction,\n    AlertDialogCancel,\n    AlertDialogContent,\n    AlertDialogDescription,\n    AlertDialogFooter,\n    AlertDialogHeader,\n    AlertDialogTitle,\n    AlertDialogTrigger,\n} from \"@/components/ui/alert-dialog\"\nimport { Settings, Archive, Trash2, Save } from \"lucide-react\"\nimport { updateCase, archiveCase } from \"@/actions/cases-crud\"\nimport { toast } from \"sonner\"\n\ninterface CaseSettingsTabProps {\n    caseItem: any\n}\n\nexport function CaseSettingsTab({ caseItem }: CaseSettingsTabProps) {\n    const router = useRouter()\n    const [saving, setSaving] = useState(false)\n\n    const [title, setTitle] = useState(caseItem.title || \"\")\n    const [description, setDescription] = useState(caseItem.description || \"\")\n    const [billingMode, setBillingMode] = useState(caseItem.billingMode || \"HOURLY\")\n\n    const handleSave = async () => {\n        setSaving(true)\n        const result = await updateCase(caseItem.id, {\n            title,\n            description,\n            billingMode,\n        })\n        if (!result.success) {\n            toast.error(\"保存失败\", { description: result.error })\n        } else {\n            toast.success(\"案件信息已保存\")\n            router.refresh()\n        }\n        setSaving(false)\n    }\n\n    const handleArchive = async () => {\n        const result = await archiveCase(caseItem.id)\n        if (!result.success) {\n            toast.error(\"归档失败\", { description: result.error })\n            return\n        }\n        toast.success(\"案件已归档\")\n        router.push(\"/cases\")\n    }\n\n    const serviceTypeLabel =\n        caseItem.serviceType === \"LITIGATION\"\n            ? \"诉讼\"\n            : caseItem.serviceType === \"NON_LITIGATION\"\n                ? \"非诉\"\n                : caseItem.serviceType === \"ARBITRATION\"\n                    ? \"仲裁\"\n                    : caseItem.serviceType === \"ADVISORY\"\n                        ? \"顾问\"\n                        : caseItem.serviceType\n\n    return (\n        <div className=\"space-y-6\">\n            <Card>\n                <CardHeader>\n                    <CardTitle className=\"text-base flex items-center gap-2\">\n                        <Settings className=\"h-4 w-4\" />\n                        基本信息\n                    </CardTitle>\n                    <CardDescription>编辑案件的基础信息与计费方式</CardDescription>\n                </CardHeader>\n                <CardContent className=\"space-y-4\">\n                    <div className=\"grid gap-4\">\n                        <div className=\"space-y-2\">\n                            <Label>案件名称</Label>\n                            <Input\n                                value={title}\n                                onChange={(e) => setTitle(e.target.value)}\n                                placeholder=\"输入案件名称\"\n                            />\n                        </div>\n\n                        <div className=\"space-y-2\">\n                            <Label>案号</Label>\n                            <Input value={caseItem.caseCode} disabled />\n                        </div>\n\n                        <div className=\"grid grid-cols-2 gap-4\">\n                            <div className=\"space-y-2\">\n                                <Label>案件类型</Label>\n                                <Input value={serviceTypeLabel} disabled />\n                            </div>\n\n                            <div className=\"space-y-2\">\n                                <Label>计费模式</Label>\n                                <Select value={billingMode} onValueChange={setBillingMode}>\n                                    <SelectTrigger>\n                                        <SelectValue />\n                                    </SelectTrigger>\n                                    <SelectContent>\n                                        <SelectItem value=\"HOURLY\">计时收费</SelectItem>\n                                        <SelectItem value=\"FIXED\">固定收费</SelectItem>\n                                        <SelectItem value=\"CAPPED\">风险/封顶</SelectItem>\n                                    </SelectContent>\n                                </Select>\n                            </div>\n                        </div>\n\n                        <div className=\"space-y-2\">\n                            <Label>案件描述</Label>\n                            <Input\n                                value={description}\n                                onChange={(e) => setDescription(e.target.value)}\n                                placeholder=\"输入案件简要描述\"\n                            />\n                        </div>\n\n                        <div className=\"flex justify-end\">\n                            <Button onClick={handleSave} disabled={saving}>\n                                <Save className=\"h-4 w-4 mr-2\" />\n                                {saving ? \"保存中...\" : \"保存修改\"}\n                            </Button>\n                        </div>\n                    </div>\n\n                    <Separator />\n\n                    <div className=\"grid gap-3 text-sm\">\n                        <div className=\"flex items-center justify-between\">\n                            <div>\n                                <div className=\"font-medium\">承办律师</div>\n                                <div className=\"text-muted-foreground\">\n                                    {caseItem.handler?.name || \"未分配\"}\n                                </div>\n                            </div>\n                            <Badge>承办人</Badge>\n                        </div>\n\n                        <div className=\"flex items-center justify-between\">\n                            <div>\n                                <div className=\"font-medium\">案源律师</div>\n                                <div className=\"text-muted-foreground\">\n                                    {caseItem.originator?.name || \"未分配\"}\n                                </div>\n                            </div>\n                            <Badge variant=\"outline\">案源</Badge>\n                        </div>\n\n                        <div>\n                            <div className=\"font-medium mb-2\">\n                                团队成员（{caseItem.members?.length || 0}人）\n                            </div>\n                            <div className=\"flex flex-wrap gap-2\">\n                                {caseItem.members?.map((member: any) => (\n                                    <Badge key={member.id} variant=\"secondary\">\n                                        {member.user?.name}\n                                    </Badge>\n                                ))}\n                            </div>\n                        </div>\n                    </div>\n                </CardContent>\n            </Card>\n\n            <Card className=\"border-red-200\">\n                <CardHeader>\n                    <CardTitle className=\"text-base text-red-600\">危险操作</CardTitle>\n                    <CardDescription>以下操作不可逆，请谨慎执行</CardDescription>\n                </CardHeader>\n                <CardContent className=\"space-y-4\">\n                    <div className=\"flex items-center justify-between\">\n                        <div>\n                            <div className=\"font-medium\">归档案件</div>\n                            <div className=\"text-sm text-muted-foreground\">\n                                归档后案件会进入归档库，可随时恢复\n                            </div>\n                        </div>\n                        <AlertDialog>\n                            <AlertDialogTrigger asChild>\n                                <Button variant=\"outline\">\n                                    <Archive className=\"h-4 w-4 mr-2\" />\n                                    归档\n                                </Button>\n                            </AlertDialogTrigger>\n                            <AlertDialogContent>\n                                <AlertDialogHeader>\n                                    <AlertDialogTitle>确认归档该案件？</AlertDialogTitle>\n                                    <AlertDialogDescription>\n                                        归档后案件将移至归档库，你可以稍后从归档库恢复。\n                                    </AlertDialogDescription>\n                                </AlertDialogHeader>\n                                <AlertDialogFooter>\n                                    <AlertDialogCancel>取消</AlertDialogCancel>\n                                    <AlertDialogAction onClick={handleArchive}>\n                                        确认归档\n                                    </AlertDialogAction>\n                                </AlertDialogFooter>\n                            </AlertDialogContent>\n                        </AlertDialog>\n                    </div>\n\n                    <Separator />\n\n                    <div className=\"flex items-center justify-between\">\n                        <div>\n                            <div className=\"font-medium text-red-600\">删除案件</div>\n                            <div className=\"text-sm text-muted-foreground\">\n                                永久删除案件及所有相关数据（暂未开放）\n                            </div>\n                        </div>\n                        <Button variant=\"destructive\" disabled>\n                            <Trash2 className=\"h-4 w-4 mr-2\" />\n                            删除\n                        </Button>\n                    </div>\n                </CardContent>\n            </Card>\n        </div>\n    )\n}\n\n","usedDeprecatedRules":[]},{"filePath":"D:\\Desktop\\LawClick_NEW\\lawclick-next\\src\\components\\cases\\CaseStageTimeline.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'LITIGATION_STAGE_ORDER' is defined but never used.","line":20,"column":27,"nodeType":null,"messageId":"unusedVar","endLine":20,"endColumn":49},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'e' is defined but never used.","line":63,"column":18,"nodeType":null,"messageId":"unusedVar","endLine":63,"endColumn":19},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'index' is defined but never used.","line":109,"column":59,"nodeType":null,"messageId":"unusedVar","endLine":109,"endColumn":64}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":3,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\"\r\n\r\nimport * as React from \"react\"\r\nimport { useState } from \"react\"\r\nimport { Button } from \"@/components/ui/button\"\r\nimport { Badge } from \"@/components/ui/badge\"\r\nimport { Card, CardContent, CardHeader, CardTitle } from \"@/components/ui/card\"\r\nimport { Progress } from \"@/components/ui/progress\"\r\nimport {\r\n    Handshake,\r\n    FileCheck,\r\n    ClipboardList,\r\n    Scale,\r\n    CheckCircle,\r\n    ChevronRight,\r\n    Loader2,\r\n    Lock\r\n} from \"lucide-react\"\r\nimport { advanceCaseStage, type StageProgressInfo } from \"@/actions/stage-management\"\r\nimport { LitigationStage, LITIGATION_STAGE_ORDER } from \"@/lib/litigation-stages\"\r\n\r\n// ==============================================================================\r\n// Types\r\n// ==============================================================================\r\n\r\ninterface CaseStageTimelineProps {\r\n    caseId: string\r\n    stageProgress: StageProgressInfo\r\n    onStageAdvanced?: (newStage: LitigationStage) => void\r\n}\r\n\r\n// ==============================================================================\r\n// Icon Mapping\r\n// ==============================================================================\r\n\r\nconst STAGE_ICONS: Record<string, React.ElementType> = {\r\n    'Handshake': Handshake,\r\n    'FileCheck': FileCheck,\r\n    'ClipboardList': ClipboardList,\r\n    'Scale': Scale,\r\n    'CheckCircle': CheckCircle,\r\n}\r\n\r\n// ==============================================================================\r\n// Component\r\n// ==============================================================================\r\n\r\nexport function CaseStageTimeline({ caseId, stageProgress, onStageAdvanced }: CaseStageTimelineProps) {\r\n    const [isAdvancing, setIsAdvancing] = useState(false)\r\n    const [error, setError] = useState<string | null>(null)\r\n\r\n    const handleAdvanceStage = async () => {\r\n        setIsAdvancing(true)\r\n        setError(null)\r\n\r\n        try {\r\n            const result = await advanceCaseStage(caseId)\r\n            if (result.success && result.newStage) {\r\n                onStageAdvanced?.(result.newStage)\r\n            } else {\r\n                setError(result.error || '推进失败')\r\n            }\r\n        } catch (e) {\r\n            setError('系统错误')\r\n        } finally {\r\n            setIsAdvancing(false)\r\n        }\r\n    }\r\n\r\n    const currentIndex = stageProgress.stageIndex\r\n    const progress = ((currentIndex - 1) / (stageProgress.totalStages - 1)) * 100\r\n\r\n    const currentStageInfo = stageProgress.stages.find(s => s.isCurrent)\r\n    const canAdvance = currentIndex < stageProgress.totalStages\r\n\r\n    return (\r\n        <Card className=\"overflow-hidden\">\r\n            <CardHeader className=\"pb-2\">\r\n                <div className=\"flex items-center justify-between\">\r\n                    <CardTitle className=\"text-lg flex items-center gap-2\">\r\n                        <Scale className=\"h-5 w-5 text-orange-500\" />\r\n                        诉讼阶段进度\r\n                    </CardTitle>\r\n                    <Badge\r\n                        variant=\"outline\"\r\n                        className=\"text-sm\"\r\n                        style={{ borderColor: currentStageInfo?.color, color: currentStageInfo?.color }}\r\n                    >\r\n                        {currentStageInfo?.name || '未开始'}\r\n                    </Badge>\r\n                </div>\r\n            </CardHeader>\r\n            <CardContent className=\"space-y-4\">\r\n                {/* 进度条 */}\r\n                <div className=\"space-y-1\">\r\n                    <div className=\"flex justify-between text-xs text-muted-foreground\">\r\n                        <span>第 {currentIndex} / {stageProgress.totalStages} 阶段</span>\r\n                        <span>{Math.round(progress)}%</span>\r\n                    </div>\r\n                    <Progress value={progress} className=\"h-2\" />\r\n                </div>\r\n\r\n                {/* 阶段时间线 */}\r\n                <div className=\"relative\">\r\n                    {/* 连接线 */}\r\n                    <div className=\"absolute left-5 top-5 bottom-5 w-0.5 bg-gray-200\" />\r\n\r\n                    <div className=\"space-y-3\">\r\n                        {stageProgress.stages.map((stage, index) => {\r\n                            const IconComponent = STAGE_ICONS[stage.icon] || CheckCircle\r\n                            const isCompleted = stage.isCompleted\r\n                            const isCurrent = stage.isCurrent\r\n                            const isLocked = !isCompleted && !isCurrent\r\n\r\n                            return (\r\n                                <div\r\n                                    key={stage.stage}\r\n                                    className={`relative flex items-start gap-3 p-3 rounded-lg transition-colors ${isCurrent ? 'bg-orange-50 border border-orange-200' :\r\n                                            isCompleted ? 'bg-green-50/50' : 'bg-gray-50/50'\r\n                                        }`}\r\n                                >\r\n                                    {/* 图标 */}\r\n                                    <div\r\n                                        className={`relative z-10 flex items-center justify-center w-10 h-10 rounded-full ${isCompleted ? 'bg-green-500 text-white' :\r\n                                                isCurrent ? 'bg-orange-500 text-white' :\r\n                                                    'bg-gray-200 text-gray-400'\r\n                                            }`}\r\n                                    >\r\n                                        {isCompleted ? (\r\n                                            <CheckCircle className=\"h-5 w-5\" />\r\n                                        ) : isLocked ? (\r\n                                            <Lock className=\"h-4 w-4\" />\r\n                                        ) : (\r\n                                            <IconComponent className=\"h-5 w-5\" />\r\n                                        )}\r\n                                    </div>\r\n\r\n                                    {/* 内容 */}\r\n                                    <div className=\"flex-1 min-w-0\">\r\n                                        <div className=\"flex items-center gap-2\">\r\n                                            <span className={`font-medium ${isCurrent ? 'text-orange-700' :\r\n                                                    isCompleted ? 'text-green-700' :\r\n                                                        'text-gray-400'\r\n                                                }`}>\r\n                                                {stage.name}\r\n                                            </span>\r\n                                            {isCurrent && (\r\n                                                <Badge className=\"bg-orange-500 text-white text-xs\">\r\n                                                    当前\r\n                                                </Badge>\r\n                                            )}\r\n                                        </div>\r\n                                        <p className=\"text-xs text-muted-foreground mt-0.5\">\r\n                                            {stage.description}\r\n                                        </p>\r\n\r\n                                        {/* 进度统计（仅当前阶段显示） */}\r\n                                        {isCurrent && (stage.documentsTotal > 0 || stage.tasksTotal > 0) && (\r\n                                            <div className=\"flex gap-4 mt-2 text-xs\">\r\n                                                {stage.documentsTotal > 0 && (\r\n                                                    <span className=\"text-muted-foreground\">\r\n                                                        文书: {stage.documentsCompleted}/{stage.documentsTotal}\r\n                                                    </span>\r\n                                                )}\r\n                                                {stage.tasksTotal > 0 && (\r\n                                                    <span className=\"text-muted-foreground\">\r\n                                                        任务: {stage.tasksCompleted}/{stage.tasksTotal}\r\n                                                    </span>\r\n                                                )}\r\n                                            </div>\r\n                                        )}\r\n                                    </div>\r\n                                </div>\r\n                            )\r\n                        })}\r\n                    </div>\r\n                </div>\r\n\r\n                {/* 推进按钮 */}\r\n                {canAdvance && (\r\n                    <div className=\"pt-2\">\r\n                        <Button\r\n                            onClick={handleAdvanceStage}\r\n                            disabled={isAdvancing}\r\n                            className=\"w-full bg-orange-500 hover:bg-orange-600\"\r\n                        >\r\n                            {isAdvancing ? (\r\n                                <>\r\n                                    <Loader2 className=\"h-4 w-4 mr-2 animate-spin\" />\r\n                                    推进中...\r\n                                </>\r\n                            ) : (\r\n                                <>\r\n                                    进入下一阶段\r\n                                    <ChevronRight className=\"h-4 w-4 ml-2\" />\r\n                                </>\r\n                            )}\r\n                        </Button>\r\n                        {error && (\r\n                            <p className=\"text-sm text-red-500 text-center mt-2\">{error}</p>\r\n                        )}\r\n                    </div>\r\n                )}\r\n            </CardContent>\r\n        </Card>\r\n    )\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"D:\\Desktop\\LawClick_NEW\\lawclick-next\\src\\components\\cases\\CaseTaskKanban.tsx","messages":[{"ruleId":"react-hooks/set-state-in-effect","severity":1,"message":"Error: Calling setState synchronously within an effect can trigger cascading renders\n\nEffects are intended to synchronize state between React and external systems such as manually updating the DOM, state management libraries, or other platform APIs. In general, the body of an effect should do one or both of the following:\n* Update external systems with the latest state from React.\n* Subscribe for updates from some external system, calling setState in a callback function when external state changes.\n\nCalling setState synchronously within an effect body causes cascading renders that can hurt performance, and is not recommended. (https://react.dev/learn/you-might-not-need-an-effect).\n\nD:\\Desktop\\LawClick_NEW\\lawclick-next\\src\\components\\cases\\CaseTaskKanban.tsx:74:14\n  72 |\n  73 |     useEffect(() => {\n> 74 |         void loadTasks()\n     |              ^^^^^^^^^ Avoid calling setState() directly within an effect\n  75 |     }, [loadTasks])\n  76 |\n  77 |     const handleCreateTask = async () => {","line":74,"column":14,"nodeType":null,"endLine":74,"endColumn":23}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\"\n\nimport * as React from \"react\"\nimport { useEffect, useState } from \"react\"\nimport { Button } from \"@/components/ui/button\"\nimport { Card, CardContent, CardHeader, CardTitle } from \"@/components/ui/card\"\nimport { Badge } from \"@/components/ui/badge\"\nimport { Input } from \"@/components/ui/input\"\nimport { Textarea } from \"@/components/ui/textarea\"\nimport {\n    Dialog,\n    DialogContent,\n    DialogFooter,\n    DialogHeader,\n    DialogTitle,\n} from \"@/components/ui/dialog\"\nimport { Label } from \"@/components/ui/label\"\nimport {\n    Select,\n    SelectContent,\n    SelectItem,\n    SelectTrigger,\n    SelectValue,\n} from \"@/components/ui/select\"\nimport { Plus, Loader2 } from \"lucide-react\"\nimport {\n    createCaseTask,\n    getCaseTasksByStatus,\n    type CreateTaskInput,\n} from \"@/actions/tasks-crud\"\nimport { TASK_TYPES } from \"@/lib/task-types\"\nimport { TaskPriority, type TaskStatus } from \"@prisma/client\"\nimport { TaskKanban, type TaskItem } from \"@/components/tasks/TaskKanban\"\n\ninterface CaseTaskKanbanProps {\n    caseId: string\n    lawyers?: Array<{ id: string; name: string | null; email: string }>\n    onTaskCreated?: () => void\n}\n\nconst PRIORITY_OPTIONS: Array<{ value: TaskPriority; label: string }> = [\n    { value: \"P0_URGENT\", label: \"紧急\" },\n    { value: \"P1_HIGH\", label: \"高\" },\n    { value: \"P2_MEDIUM\", label: \"中\" },\n    { value: \"P3_LOW\", label: \"低\" },\n]\n\nexport function CaseTaskKanban({ caseId, lawyers = [], onTaskCreated }: CaseTaskKanbanProps) {\n    const [tasks, setTasks] = useState<TaskItem[]>([])\n    const [loading, setLoading] = useState(true)\n    const [showNewTask, setShowNewTask] = useState(false)\n    const [creatingTask, setCreatingTask] = useState(false)\n    const [newTask, setNewTask] = useState<Partial<CreateTaskInput>>({\n        caseId,\n        title: \"\",\n        priority: \"P2_MEDIUM\",\n        taskType: \"OTHER\",\n    })\n\n    const loadTasks = React.useCallback(async () => {\n        setLoading(true)\n        const grouped = (await getCaseTasksByStatus(caseId)) as Record<TaskStatus, TaskItem[]>\n        const flat = [\n            ...grouped.TODO,\n            ...grouped.IN_PROGRESS,\n            ...grouped.REVIEW,\n            ...grouped.DONE,\n        ]\n        setTasks(flat)\n        setLoading(false)\n    }, [caseId])\n\n    useEffect(() => {\n        void loadTasks()\n    }, [loadTasks])\n\n    const handleCreateTask = async () => {\n        if (!newTask.title?.trim()) return\n        setCreatingTask(true)\n        const res = await createCaseTask({\n            ...(newTask as CreateTaskInput),\n            caseId,\n            title: newTask.title.trim(),\n        })\n        if (res.success) {\n            await loadTasks()\n            setShowNewTask(false)\n            setNewTask({ caseId, title: \"\", priority: \"P2_MEDIUM\", taskType: \"OTHER\" })\n            onTaskCreated?.()\n        }\n        setCreatingTask(false)\n    }\n\n    return (\n        <div className=\"space-y-4\">\n            <Card>\n                <CardHeader className=\"flex flex-row items-center justify-between space-y-0 pb-3\">\n                    <div className=\"flex items-center gap-2\">\n                        <CardTitle className=\"text-base\">任务看板</CardTitle>\n                        <Badge variant=\"secondary\" className=\"text-xs\">\n                            {tasks.length} 项\n                        </Badge>\n                    </div>\n                    <Button size=\"sm\" onClick={() => setShowNewTask(true)} className=\"bg-orange-500 hover:bg-orange-600\">\n                        <Plus className=\"h-4 w-4 mr-1\" />\n                        新建任务\n                    </Button>\n                </CardHeader>\n                <CardContent>\n                    {loading ? (\n                        <div className=\"flex items-center justify-center py-16 text-muted-foreground\">\n                            <Loader2 className=\"h-5 w-5 mr-2 animate-spin\" />\n                            加载任务中...\n                        </div>\n                    ) : (\n                        <TaskKanban\n                            initialTasks={tasks}\n                            caseId={caseId}\n                            assignees={lawyers}\n                            onTasksChange={setTasks}\n                        />\n                    )}\n                </CardContent>\n            </Card>\n\n            <Dialog open={showNewTask} onOpenChange={setShowNewTask}>\n                <DialogContent className=\"max-w-lg\">\n                    <DialogHeader>\n                        <DialogTitle>新建任务</DialogTitle>\n                    </DialogHeader>\n\n                    <div className=\"space-y-4 py-2\">\n                        <div className=\"space-y-2\">\n                            <Label>任务标题</Label>\n                            <Input\n                                placeholder=\"例如：撰写起诉状初稿\"\n                                value={newTask.title || \"\"}\n                                onChange={e => setNewTask(prev => ({ ...prev, title: e.target.value }))}\n                            />\n                        </div>\n\n                        <div className=\"space-y-2\">\n                            <Label>任务描述</Label>\n                            <Textarea\n                                placeholder=\"补充任务背景与要求...\"\n                                value={newTask.description || \"\"}\n                                onChange={e => setNewTask(prev => ({ ...prev, description: e.target.value }))}\n                            />\n                        </div>\n\n                        <div className=\"grid grid-cols-2 gap-4\">\n                            <div className=\"space-y-2\">\n                                <Label>负责人</Label>\n                                <Select\n                                    value={newTask.assigneeId || \"unassigned\"}\n                                    onValueChange={value =>\n                                        setNewTask(prev => ({\n                                            ...prev,\n                                            assigneeId: value === \"unassigned\" ? undefined : value,\n                                        }))\n                                    }\n                                >\n                                    <SelectTrigger>\n                                        <SelectValue placeholder=\"选择负责人\" />\n                                    </SelectTrigger>\n                                    <SelectContent>\n                                        <SelectItem value=\"unassigned\">未分配</SelectItem>\n                                        {lawyers.map(l => (\n                                            <SelectItem key={l.id} value={l.id}>\n                                                {l.name || l.email}\n                                            </SelectItem>\n                                        ))}\n                                    </SelectContent>\n                                </Select>\n                            </div>\n\n                            <div className=\"space-y-2\">\n                                <Label>优先级</Label>\n                                <Select\n                                    value={(newTask.priority as TaskPriority) || \"P2_MEDIUM\"}\n                                    onValueChange={value =>\n                                        setNewTask(prev => ({ ...prev, priority: value as TaskPriority }))\n                                    }\n                                >\n                                    <SelectTrigger>\n                                        <SelectValue />\n                                    </SelectTrigger>\n                                    <SelectContent>\n                                        {PRIORITY_OPTIONS.map(p => (\n                                            <SelectItem key={p.value} value={p.value}>\n                                                {p.label}\n                                            </SelectItem>\n                                        ))}\n                                    </SelectContent>\n                                </Select>\n                            </div>\n                        </div>\n\n                        <div className=\"grid grid-cols-2 gap-4\">\n                            <div className=\"space-y-2\">\n                                <Label>截止日期</Label>\n                                <Input\n                                    type=\"date\"\n                                    value={\n                                        newTask.dueDate\n                                            ? new Date(newTask.dueDate).toISOString().slice(0, 10)\n                                            : \"\"\n                                    }\n                                    onChange={e =>\n                                        setNewTask(prev => ({\n                                            ...prev,\n                                            dueDate: e.target.value ? new Date(e.target.value) : undefined,\n                                        }))\n                                    }\n                                />\n                            </div>\n\n                            <div className=\"space-y-2\">\n                                <Label>所属阶段</Label>\n                                <Input\n                                    placeholder=\"例如：FILING\"\n                                    value={newTask.stage || \"\"}\n                                    onChange={e => setNewTask(prev => ({ ...prev, stage: e.target.value }))}\n                                />\n                            </div>\n                        </div>\n\n                        <div className=\"grid grid-cols-2 gap-4\">\n                            <div className=\"space-y-2\">\n                                <Label>任务类型</Label>\n                                <Select\n                                    value={newTask.taskType || \"OTHER\"}\n                                    onValueChange={value =>\n                                        setNewTask(prev => ({\n                                            ...prev,\n                                            taskType: value as CreateTaskInput[\"taskType\"],\n                                        }))\n                                    }\n                                >\n                                    <SelectTrigger>\n                                        <SelectValue />\n                                    </SelectTrigger>\n                                    <SelectContent>\n                                        {TASK_TYPES.map(t => (\n                                            <SelectItem key={t.value} value={t.value}>\n                                                {t.label}\n                                            </SelectItem>\n                                        ))}\n                                    </SelectContent>\n                                </Select>\n                            </div>\n\n                            <div className=\"space-y-2\">\n                                <Label>预估工时（小时）</Label>\n                                <Input\n                                    type=\"number\"\n                                    placeholder=\"例如：2.5\"\n                                    value={newTask.estimatedHours ?? \"\"}\n                                    onChange={e =>\n                                        setNewTask(prev => ({\n                                            ...prev,\n                                            estimatedHours: e.target.value\n                                                ? parseFloat(e.target.value)\n                                                : undefined,\n                                        }))\n                                    }\n                                />\n                            </div>\n                        </div>\n                    </div>\n\n                    <DialogFooter>\n                        <Button variant=\"outline\" onClick={() => setShowNewTask(false)}>\n                            取消\n                        </Button>\n                        <Button\n                            onClick={handleCreateTask}\n                            disabled={creatingTask || !newTask.title?.trim()}\n                            className=\"bg-orange-500 hover:bg-orange-600\"\n                        >\n                            {creatingTask ? (\n                                <>\n                                    <Loader2 className=\"h-4 w-4 mr-2 animate-spin\" />\n                                    创建中...\n                                </>\n                            ) : (\n                                \"创建任务\"\n                            )}\n                        </Button>\n                    </DialogFooter>\n                </DialogContent>\n            </Dialog>\n        </div>\n    )\n}\n","usedDeprecatedRules":[]},{"filePath":"D:\\Desktop\\LawClick_NEW\\lawclick-next\\src\\components\\cases\\CaseTeamCard.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'UserIcon' is defined but never used.","line":12,"column":27,"nodeType":null,"messageId":"unusedVar","endLine":12,"endColumn":35},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'e' is defined but never used.","line":61,"column":18,"nodeType":null,"messageId":"unusedVar","endLine":61,"endColumn":19},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'e' is defined but never used.","line":77,"column":18,"nodeType":null,"messageId":"unusedVar","endLine":77,"endColumn":19}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":3,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\"\r\n\r\nimport { useState } from \"react\"\r\nimport { Card, CardContent, CardHeader, CardTitle } from \"@/components/ui/card\"\r\nimport { Button } from \"@/components/ui/button\"\r\nimport { Avatar, AvatarFallback, AvatarImage } from \"@/components/ui/avatar\"\r\nimport { Dialog, DialogContent, DialogHeader, DialogTitle, DialogTrigger, DialogFooter } from \"@/components/ui/dialog\"\r\nimport { Input } from \"@/components/ui/input\"\r\nimport { Label } from \"@/components/ui/label\"\r\nimport { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from \"@/components/ui/select\"\r\nimport { Badge } from \"@/components/ui/badge\"\r\nimport { Plus, X, User as UserIcon } from \"lucide-react\"\r\nimport { addCaseMember, removeCaseMember } from \"@/actions/members\"\r\nimport { toast } from \"sonner\"\r\n\r\ninterface CaseTeamCardProps {\r\n    caseId: string\r\n    owner: {\r\n        id: string\r\n        name?: string | null\r\n        email?: string | null\r\n        image?: string | null\r\n    }\r\n    members: Array<{\r\n        role: string\r\n        user: {\r\n            id: string\r\n            name?: string | null\r\n            email?: string | null\r\n            image?: string | null\r\n        }\r\n    }>\r\n    currentUserId: string\r\n}\r\n\r\nexport function CaseTeamCard({ caseId, owner, members, currentUserId }: CaseTeamCardProps) {\r\n    const [isInviteOpen, setIsInviteOpen] = useState(false)\r\n    const [email, setEmail] = useState(\"\")\r\n    const [role, setRole] = useState(\"VIEWER\")\r\n    const [loading, setLoading] = useState(false)\r\n\r\n    const isOwner = currentUserId === owner.id\r\n\r\n    const handleInvite = async () => {\r\n        if (!email) return\r\n        setLoading(true)\r\n        try {\r\n            const formData = new FormData()\r\n            formData.append(\"caseId\", caseId)\r\n            formData.append(\"email\", email)\r\n            formData.append(\"role\", role)\r\n\r\n            const result = await addCaseMember(formData)\r\n            if (result.error) {\r\n                toast.error(result.error)\r\n            } else {\r\n                toast.success(\"邀请成功\")\r\n                setIsInviteOpen(false)\r\n                setEmail(\"\")\r\n            }\r\n        } catch (e) {\r\n            toast.error(\"邀请失败\")\r\n        } finally {\r\n            setLoading(false)\r\n        }\r\n    }\r\n\r\n    const handleRemove = async (userId: string) => {\r\n        if (!confirm(\"确定要移除该成员吗？\")) return\r\n        try {\r\n            const result = await removeCaseMember(caseId, userId)\r\n            if (result.error) {\r\n                toast.error(result.error)\r\n            } else {\r\n                toast.success(\"移除成功\")\r\n            }\r\n        } catch (e) {\r\n            toast.error(\"操作失败\")\r\n        }\r\n    }\r\n\r\n    return (\r\n        <Card>\r\n            <CardHeader className=\"flex flex-row items-center justify-between pb-2\">\r\n                <CardTitle className=\"text-base font-bold\">项目成员</CardTitle>\r\n                {isOwner && (\r\n                    <Dialog open={isInviteOpen} onOpenChange={setIsInviteOpen}>\r\n                        <DialogTrigger asChild>\r\n                            <Button size=\"sm\" variant=\"outline\" className=\"h-8\">\r\n                                <Plus className=\"h-3 w-3 mr-1\" /> 邀请\r\n                            </Button>\r\n                        </DialogTrigger>\r\n                        <DialogContent>\r\n                            <DialogHeader>\r\n                                <DialogTitle>邀请新成员关联案件</DialogTitle>\r\n                            </DialogHeader>\r\n                            <div className=\"grid gap-4 py-4\">\r\n                                <div className=\"grid grid-cols-4 items-center gap-4\">\r\n                                    <Label htmlFor=\"email\" className=\"text-right\">\r\n                                        邮箱\r\n                                    </Label>\r\n                                    <Input\r\n                                        id=\"email\"\r\n                                        value={email}\r\n                                        onChange={(e) => setEmail(e.target.value)}\r\n                                        placeholder=\"例如：lawyer@example.com\"\r\n                                        className=\"col-span-3\"\r\n                                    />\r\n                                </div>\r\n                                <div className=\"grid grid-cols-4 items-center gap-4\">\r\n                                    <Label htmlFor=\"role\" className=\"text-right\">\r\n                                        角色\r\n                                    </Label>\r\n                                    <Select value={role} onValueChange={setRole}>\r\n                                        <SelectTrigger className=\"col-span-3\">\r\n                                            <SelectValue placeholder=\"选择角色\" />\r\n                                        </SelectTrigger>\r\n                                        <SelectContent>\r\n                                            <SelectItem value=\"VIEWER\">观察者 (只读)</SelectItem>\r\n                                            <SelectItem value=\"EDITOR\">协作者 (编辑)</SelectItem>\r\n                                            <SelectItem value=\"OWNER\">管理员 (完全权限)</SelectItem>\r\n                                        </SelectContent>\r\n                                    </Select>\r\n                                </div>\r\n                            </div>\r\n                            <DialogFooter>\r\n                                <Button variant=\"outline\" onClick={() => setIsInviteOpen(false)}>取消</Button>\r\n                                <Button onClick={handleInvite} disabled={loading}>{loading ? \"发送中...\" : \"发送邀请\"}</Button>\r\n                            </DialogFooter>\r\n                        </DialogContent>\r\n                    </Dialog>\r\n                )}\r\n            </CardHeader>\r\n            <CardContent className=\"space-y-4\">\r\n                {/* Owner */}\r\n                <div className=\"flex items-center justify-between group\">\r\n                    <div className=\"flex items-center gap-3\">\r\n                        <Avatar className=\"h-8 w-8\">\r\n                            <AvatarImage src={owner.image || \"\"} />\r\n                            <AvatarFallback>{owner.name?.[0] || \"O\"}</AvatarFallback>\r\n                        </Avatar>\r\n                        <div>\r\n                            <div className=\"text-sm font-medium leading-none\">{owner.name}</div>\r\n                            <div className=\"text-xs text-muted-foreground\">负责人</div>\r\n                        </div>\r\n                    </div>\r\n                </div>\r\n\r\n                {/* Members */}\r\n                {members.map((member) => (\r\n                    <div key={member.user.id} className=\"flex items-center justify-between group\">\r\n                        <div className=\"flex items-center gap-3\">\r\n                            <Avatar className=\"h-8 w-8\">\r\n                                <AvatarImage src={member.user.image || \"\"} />\r\n                                <AvatarFallback>{member.user.name?.[0] || \"U\"}</AvatarFallback>\r\n                            </Avatar>\r\n                            <div>\r\n                                <div className=\"text-sm font-medium leading-none\">{member.user.name}</div>\r\n                                <div className=\"text-xs text-muted-foreground flex items-center gap-1\">\r\n                                    <Badge variant=\"outline\" className=\"text-[10px] h-4 px-1 py-0\">{member.role}</Badge>\r\n                                </div>\r\n                            </div>\r\n                        </div>\r\n                        {isOwner && (\r\n                            <Button\r\n                                variant=\"ghost\"\r\n                                size=\"icon\"\r\n                                className=\"h-6 w-6 opacity-0 group-hover:opacity-100 transition-opacity text-muted-foreground hover:text-red-500\"\r\n                                onClick={() => handleRemove(member.user.id)}\r\n                            >\r\n                                <X className=\"h-3 w-3\" />\r\n                            </Button>\r\n                        )}\r\n                    </div>\r\n                ))}\r\n\r\n                {members.length === 0 && (\r\n                    <div className=\"text-xs text-center text-slate-400 py-2\">\r\n                        暂无其他成员\r\n                    </div>\r\n                )}\r\n            </CardContent>\r\n        </Card>\r\n    )\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"D:\\Desktop\\LawClick_NEW\\lawclick-next\\src\\components\\cases\\CaseTimelineTab.tsx","messages":[{"ruleId":"react-hooks/set-state-in-effect","severity":1,"message":"Error: Calling setState synchronously within an effect can trigger cascading renders\n\nEffects are intended to synchronize state between React and external systems such as manually updating the DOM, state management libraries, or other platform APIs. In general, the body of an effect should do one or both of the following:\n* Update external systems with the latest state from React.\n* Subscribe for updates from some external system, calling setState in a callback function when external state changes.\n\nCalling setState synchronously within an effect body causes cascading renders that can hurt performance, and is not recommended. (https://react.dev/learn/you-might-not-need-an-effect).\n\nD:\\Desktop\\LawClick_NEW\\lawclick-next\\src\\components\\cases\\CaseTimelineTab.tsx:54:9\n  52 |\n  53 |     useEffect(() => {\n> 54 |         loadTimeline()\n     |         ^^^^^^^^^^^^ Avoid calling setState() directly within an effect\n  55 |     }, [caseId])\n  56 |\n  57 |     const formatDate = (date: Date) => {","line":54,"column":9,"nodeType":null,"endLine":54,"endColumn":21},{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has a missing dependency: 'loadTimeline'. Either include it or remove the dependency array.","line":55,"column":8,"nodeType":"ArrayExpression","endLine":55,"endColumn":16,"suggestions":[{"desc":"Update the dependencies array to be: [caseId, loadTimeline]","fix":{"range":[1560,1568],"text":"[caseId, loadTimeline]"}}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":2,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\"\r\n\r\nimport { useState, useEffect } from \"react\"\r\nimport { Card, CardHeader, CardTitle, CardContent } from \"@/components/ui/card\"\r\nimport { Badge } from \"@/components/ui/badge\"\r\nimport {\r\n    Calendar,\r\n    CheckCircle2,\r\n    FileText,\r\n    Clock,\r\n    Users,\r\n    ArrowRight,\r\n    RefreshCw,\r\n} from \"lucide-react\"\r\nimport { Button } from \"@/components/ui/button\"\r\nimport { getCaseTimeline, type TimelineEvent } from \"@/actions/timeline-actions\"\r\n\r\ninterface CaseTimelineTabProps {\r\n    caseId: string\r\n}\r\n\r\nconst EVENT_ICONS: Record<string, React.ElementType> = {\r\n    event: Calendar,\r\n    task_complete: CheckCircle2,\r\n    document_upload: FileText,\r\n    timelog: Clock,\r\n    party_add: Users,\r\n    stage_change: ArrowRight,\r\n}\r\n\r\nconst EVENT_COLORS: Record<string, string> = {\r\n    event: 'bg-blue-100 text-blue-600',\r\n    task_complete: 'bg-green-100 text-green-600',\r\n    document_upload: 'bg-purple-100 text-purple-600',\r\n    timelog: 'bg-orange-100 text-orange-600',\r\n    party_add: 'bg-cyan-100 text-cyan-600',\r\n    stage_change: 'bg-amber-100 text-amber-600',\r\n}\r\n\r\nexport function CaseTimelineTab({ caseId }: CaseTimelineTabProps) {\r\n    const [events, setEvents] = useState<TimelineEvent[]>([])\r\n    const [loading, setLoading] = useState(true)\r\n\r\n    const loadTimeline = async () => {\r\n        setLoading(true)\r\n        const result = await getCaseTimeline(caseId)\r\n        if (result.success) {\r\n            setEvents(result.data)\r\n        }\r\n        setLoading(false)\r\n    }\r\n\r\n    useEffect(() => {\r\n        loadTimeline()\r\n    }, [caseId])\r\n\r\n    const formatDate = (date: Date) => {\r\n        const d = new Date(date)\r\n        return d.toLocaleDateString('zh-CN', {\r\n            month: 'short',\r\n            day: 'numeric',\r\n            hour: '2-digit',\r\n            minute: '2-digit'\r\n        })\r\n    }\r\n\r\n    return (\r\n        <Card>\r\n            <CardHeader className=\"flex flex-row items-center justify-between\">\r\n                <CardTitle className=\"text-lg\">案件时间线</CardTitle>\r\n                <Button variant=\"ghost\" size=\"sm\" onClick={loadTimeline}>\r\n                    <RefreshCw className=\"h-4 w-4\" />\r\n                </Button>\r\n            </CardHeader>\r\n            <CardContent>\r\n                {loading ? (\r\n                    <div className=\"text-center py-8 text-muted-foreground\">加载中...</div>\r\n                ) : events.length === 0 ? (\r\n                    <div className=\"text-center py-8 text-muted-foreground\">暂无时间线事件</div>\r\n                ) : (\r\n                    <div className=\"relative\">\r\n                        {/* 时间线轴 */}\r\n                        <div className=\"absolute left-4 top-0 bottom-0 w-0.5 bg-slate-200\" />\r\n\r\n                        <div className=\"space-y-4\">\r\n                            {events.map((event) => {\r\n                                const Icon = EVENT_ICONS[event.type] || Calendar\r\n                                const colorClass = EVENT_COLORS[event.type] || 'bg-slate-100 text-slate-600'\r\n\r\n                                return (\r\n                                    <div key={event.id} className=\"relative flex gap-4 pl-10\">\r\n                                        {/* 时间线节点 */}\r\n                                        <div className={`absolute left-2 w-5 h-5 rounded-full flex items-center justify-center ${colorClass}`}>\r\n                                            <Icon className=\"h-3 w-3\" />\r\n                                        </div>\r\n\r\n                                        {/* 内容 */}\r\n                                        <div className=\"flex-1 pb-4 border-b last:border-0\">\r\n                                            <div className=\"flex items-center justify-between\">\r\n                                                <div className=\"font-medium text-sm\">{event.title}</div>\r\n                                                <Badge variant=\"outline\" className=\"text-xs\">\r\n                                                    {formatDate(event.timestamp)}\r\n                                                </Badge>\r\n                                            </div>\r\n                                            {event.description && (\r\n                                                <div className=\"text-sm text-muted-foreground mt-1\">\r\n                                                    {event.description}\r\n                                                </div>\r\n                                            )}\r\n                                            {event.userName && (\r\n                                                <div className=\"text-xs text-muted-foreground mt-1\">\r\n                                                    操作人: {event.userName}\r\n                                                </div>\r\n                                            )}\r\n                                        </div>\r\n                                    </div>\r\n                                )\r\n                            })}\r\n                        </div>\r\n                    </div>\r\n                )}\r\n            </CardContent>\r\n        </Card>\r\n    )\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"D:\\Desktop\\LawClick_NEW\\lawclick-next\\src\\components\\cases\\CreateCaseWizard.tsx","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":100,"column":17,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":100,"endColumn":20,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[2408,2411],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[2408,2411],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":113,"column":18,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":113,"endColumn":21,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[2935,2938],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[2935,2938],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'error' is defined but never used.","line":283,"column":18,"nodeType":null,"messageId":"unusedVar","endLine":283,"endColumn":23}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":3,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\"\r\n\r\nimport * as React from \"react\"\r\nimport { useState, useEffect } from \"react\"\r\nimport { useRouter } from \"next/navigation\"\r\nimport {\r\n    Dialog,\r\n    DialogContent,\r\n    DialogHeader,\r\n    DialogTitle,\r\n    DialogDescription,\r\n    DialogFooter,\r\n} from \"@/components/ui/dialog\"\r\nimport { Button } from \"@/components/ui/button\"\r\nimport { Input } from \"@/components/ui/input\"\r\nimport { Label } from \"@/components/ui/label\"\r\nimport { Textarea } from \"@/components/ui/textarea\"\r\nimport {\r\n    Select,\r\n    SelectContent,\r\n    SelectItem,\r\n    SelectTrigger,\r\n    SelectValue,\r\n} from \"@/components/ui/select\"\r\nimport { RadioGroup, RadioGroupItem } from \"@/components/ui/radio-group\"\r\nimport { Badge } from \"@/components/ui/badge\"\r\nimport { Card, CardContent } from \"@/components/ui/card\"\r\nimport { Progress } from \"@/components/ui/progress\"\r\nimport {\r\n    createCase,\r\n    getClientsForSelect,\r\n    getLawyersForSelect,\r\n    type CreateCaseInput\r\n} from \"@/actions/cases-crud\"\r\nimport { ServiceType, BillingMode } from \"@prisma/client\"\r\nimport {\r\n    Briefcase,\r\n    Users,\r\n    FileText,\r\n    UserCheck,\r\n    AlertTriangle,\r\n    CheckCircle,\r\n    ChevronLeft,\r\n    ChevronRight,\r\n    Loader2,\r\n    Building2,\r\n    User,\r\n    Plus,\r\n    X\r\n} from \"lucide-react\"\r\n\r\n// ==============================================================================\r\n// Types\r\n// ==============================================================================\r\n\r\ninterface CreateCaseWizardProps {\r\n    open: boolean\r\n    onOpenChange: (open: boolean) => void\r\n    onSuccess?: (caseId: string, caseCode: string) => void\r\n}\r\n\r\ninterface WizardFormData {\r\n    // Step 1 - 基本信息\r\n    title: string\r\n    description: string\r\n\r\n    // Step 2 - 客户信息\r\n    clientType: 'existing' | 'new'\r\n    clientId: string\r\n    newClientName: string\r\n    newClientType: 'COMPANY' | 'INDIVIDUAL'\r\n    newClientEmail: string\r\n    newClientPhone: string\r\n    opposingParties: string[]\r\n\r\n    // Step 3 - 案件类型\r\n    serviceType: ServiceType\r\n    billingMode: BillingMode\r\n    contractValue: string\r\n\r\n    // Step 4 - 团队配置\r\n    originatorId: string\r\n    handlerId: string\r\n    memberIds: string[]\r\n}\r\n\r\ninterface Client {\r\n    id: string\r\n    name: string\r\n    type: string\r\n    email: string | null\r\n    phone: string | null\r\n}\r\n\r\ninterface Lawyer {\r\n    id: string\r\n    name: string | null\r\n    email: string\r\n    role: string\r\n    hourlyRate: any\r\n}\r\n\r\n// ==============================================================================\r\n// Component\r\n// ==============================================================================\r\n\r\nexport function CreateCaseWizard({ open, onOpenChange, onSuccess }: CreateCaseWizardProps) {\r\n    const router = useRouter()\r\n    const [step, setStep] = useState(1)\r\n    const [isSubmitting, setIsSubmitting] = useState(false)\r\n    const [conflictResult, setConflictResult] = useState<{\r\n        hasConflict: boolean\r\n        details: any[]\r\n    } | null>(null)\r\n    const [submitError, setSubmitError] = useState<string | null>(null)\r\n    const [submitSuccess, setSubmitSuccess] = useState<{\r\n        caseId: string\r\n        caseCode: string\r\n    } | null>(null)\r\n\r\n    // 数据加载\r\n    const [clients, setClients] = useState<Client[]>([])\r\n    const [lawyers, setLawyers] = useState<Lawyer[]>([])\r\n    const [loadingData, setLoadingData] = useState(true)\r\n\r\n    // 表单数据\r\n    const [formData, setFormData] = useState<WizardFormData>({\r\n        title: '',\r\n        description: '',\r\n        clientType: 'existing',\r\n        clientId: '',\r\n        newClientName: '',\r\n        newClientType: 'COMPANY',\r\n        newClientEmail: '',\r\n        newClientPhone: '',\r\n        opposingParties: [],\r\n        serviceType: 'LITIGATION',\r\n        billingMode: 'HOURLY',\r\n        contractValue: '',\r\n        originatorId: '',\r\n        handlerId: '',\r\n        memberIds: []\r\n    })\r\n\r\n    const [newOpposingParty, setNewOpposingParty] = useState('')\r\n\r\n    // 加载数据\r\n    useEffect(() => {\r\n        if (open) {\r\n            setLoadingData(true)\r\n            Promise.all([\r\n                getClientsForSelect(),\r\n                getLawyersForSelect()\r\n            ]).then(([clientsData, lawyersData]) => {\r\n                setClients(clientsData)\r\n                setLawyers(lawyersData)\r\n                setLoadingData(false)\r\n            })\r\n        }\r\n    }, [open])\r\n\r\n    // 重置表单\r\n    useEffect(() => {\r\n        if (!open) {\r\n            setStep(1)\r\n            setConflictResult(null)\r\n            setSubmitError(null)\r\n            setSubmitSuccess(null)\r\n            setFormData({\r\n                title: '',\r\n                description: '',\r\n                clientType: 'existing',\r\n                clientId: '',\r\n                newClientName: '',\r\n                newClientType: 'COMPANY',\r\n                newClientEmail: '',\r\n                newClientPhone: '',\r\n                opposingParties: [],\r\n                serviceType: 'LITIGATION',\r\n                billingMode: 'HOURLY',\r\n                contractValue: '',\r\n                originatorId: '',\r\n                handlerId: '',\r\n                memberIds: []\r\n            })\r\n        }\r\n    }, [open])\r\n\r\n    const updateFormData = (updates: Partial<WizardFormData>) => {\r\n        setFormData(prev => ({ ...prev, ...updates }))\r\n    }\r\n\r\n    const addOpposingParty = () => {\r\n        if (newOpposingParty.trim()) {\r\n            updateFormData({\r\n                opposingParties: [...formData.opposingParties, newOpposingParty.trim()]\r\n            })\r\n            setNewOpposingParty('')\r\n        }\r\n    }\r\n\r\n    const removeOpposingParty = (index: number) => {\r\n        updateFormData({\r\n            opposingParties: formData.opposingParties.filter((_, i) => i !== index)\r\n        })\r\n    }\r\n\r\n    const toggleMember = (userId: string) => {\r\n        if (formData.memberIds.includes(userId)) {\r\n            updateFormData({\r\n                memberIds: formData.memberIds.filter(id => id !== userId)\r\n            })\r\n        } else {\r\n            updateFormData({\r\n                memberIds: [...formData.memberIds, userId]\r\n            })\r\n        }\r\n    }\r\n\r\n    // 步骤验证\r\n    const validateStep = (stepNum: number): boolean => {\r\n        switch (stepNum) {\r\n            case 1:\r\n                return formData.title.trim().length > 0\r\n            case 2:\r\n                if (formData.clientType === 'existing') {\r\n                    return formData.clientId.length > 0\r\n                } else {\r\n                    return formData.newClientName.trim().length > 0\r\n                }\r\n            case 3:\r\n                return true // 都有默认值\r\n            case 4:\r\n                return formData.handlerId.length > 0\r\n            default:\r\n                return true\r\n        }\r\n    }\r\n\r\n    const canProceed = validateStep(step)\r\n\r\n    // 提交表单\r\n    const handleSubmit = async () => {\r\n        setIsSubmitting(true)\r\n        setSubmitError(null)\r\n\r\n        try {\r\n            const input: CreateCaseInput = {\r\n                title: formData.title,\r\n                description: formData.description || undefined,\r\n                serviceType: formData.serviceType,\r\n                billingMode: formData.billingMode,\r\n                contractValue: formData.contractValue ? parseFloat(formData.contractValue) : undefined,\r\n                handlerId: formData.handlerId,\r\n                originatorId: formData.originatorId || undefined,\r\n                memberIds: formData.memberIds.length > 0 ? formData.memberIds : undefined,\r\n                opposingParties: formData.opposingParties.length > 0 ? formData.opposingParties : undefined,\r\n            }\r\n\r\n            if (formData.clientType === 'existing') {\r\n                input.clientId = formData.clientId\r\n            } else {\r\n                input.newClient = {\r\n                    name: formData.newClientName,\r\n                    type: formData.newClientType,\r\n                    email: formData.newClientEmail || undefined,\r\n                    phone: formData.newClientPhone || undefined,\r\n                }\r\n            }\r\n\r\n            const result = await createCase(input)\r\n\r\n            if (result.success && result.caseId && result.caseCode) {\r\n                setConflictResult(result.conflictCheck || null)\r\n                setSubmitSuccess({\r\n                    caseId: result.caseId,\r\n                    caseCode: result.caseCode\r\n                })\r\n                setStep(6) // 跳到确认页\r\n            } else {\r\n                setSubmitError(result.error || '创建失败')\r\n            }\r\n        } catch (error) {\r\n            setSubmitError('系统错误，请稍后重试')\r\n        } finally {\r\n            setIsSubmitting(false)\r\n        }\r\n    }\r\n\r\n    const handleClose = () => {\r\n        if (submitSuccess) {\r\n            onSuccess?.(submitSuccess.caseId, submitSuccess.caseCode)\r\n            router.push(`/cases/${submitSuccess.caseId}`)\r\n        }\r\n        onOpenChange(false)\r\n    }\r\n\r\n    // 步骤配置\r\n    const steps = [\r\n        { num: 1, title: '基本信息', icon: FileText },\r\n        { num: 2, title: '客户信息', icon: Building2 },\r\n        { num: 3, title: '案件类型', icon: Briefcase },\r\n        { num: 4, title: '团队配置', icon: Users },\r\n        { num: 5, title: '冲突检查', icon: AlertTriangle },\r\n        { num: 6, title: '完成', icon: CheckCircle },\r\n    ]\r\n\r\n    const progress = ((step - 1) / 5) * 100\r\n\r\n    return (\r\n        <Dialog open={open} onOpenChange={onOpenChange}>\r\n            <DialogContent className=\"max-w-2xl max-h-[90vh] overflow-y-auto\">\r\n                <DialogHeader>\r\n                    <DialogTitle className=\"flex items-center gap-2\">\r\n                        <Briefcase className=\"h-5 w-5 text-orange-500\" />\r\n                        新建案件\r\n                    </DialogTitle>\r\n                    <DialogDescription>\r\n                        填写案件基本信息，系统将自动进行利益冲突检查\r\n                    </DialogDescription>\r\n                </DialogHeader>\r\n\r\n                {/* 进度条 */}\r\n                <div className=\"space-y-2\">\r\n                    <Progress value={progress} className=\"h-2\" />\r\n                    <div className=\"flex justify-between\">\r\n                        {steps.map((s) => (\r\n                            <div\r\n                                key={s.num}\r\n                                className={`flex flex-col items-center ${step >= s.num ? 'text-orange-500' : 'text-gray-400'\r\n                                    }`}\r\n                            >\r\n                                <s.icon className=\"h-4 w-4\" />\r\n                                <span className=\"text-xs mt-1\">{s.title}</span>\r\n                            </div>\r\n                        ))}\r\n                    </div>\r\n                </div>\r\n\r\n                {loadingData ? (\r\n                    <div className=\"flex items-center justify-center py-12\">\r\n                        <Loader2 className=\"h-8 w-8 animate-spin text-orange-500\" />\r\n                    </div>\r\n                ) : (\r\n                    <div className=\"py-4\">\r\n                        {/* Step 1: 基本信息 */}\r\n                        {step === 1 && (\r\n                            <div className=\"space-y-4\">\r\n                                <div>\r\n                                    <Label htmlFor=\"title\">案件名称 *</Label>\r\n                                    <Input\r\n                                        id=\"title\"\r\n                                        placeholder=\"请输入案件名称，如：张三诉李四民间借贷纠纷\"\r\n                                        value={formData.title}\r\n                                        onChange={(e) => updateFormData({ title: e.target.value })}\r\n                                        className=\"mt-1\"\r\n                                    />\r\n                                </div>\r\n                                <div>\r\n                                    <Label htmlFor=\"description\">案件描述</Label>\r\n                                    <Textarea\r\n                                        id=\"description\"\r\n                                        placeholder=\"请简要描述案件情况...\"\r\n                                        value={formData.description}\r\n                                        onChange={(e) => updateFormData({ description: e.target.value })}\r\n                                        className=\"mt-1\"\r\n                                        rows={4}\r\n                                    />\r\n                                </div>\r\n                            </div>\r\n                        )}\r\n\r\n                        {/* Step 2: 客户信息 */}\r\n                        {step === 2 && (\r\n                            <div className=\"space-y-4\">\r\n                                <div>\r\n                                    <Label>客户类型</Label>\r\n                                    <RadioGroup\r\n                                        value={formData.clientType}\r\n                                        onValueChange={(v) => updateFormData({ clientType: v as 'existing' | 'new' })}\r\n                                        className=\"flex gap-4 mt-2\"\r\n                                    >\r\n                                        <div className=\"flex items-center space-x-2\">\r\n                                            <RadioGroupItem value=\"existing\" id=\"existing\" />\r\n                                            <Label htmlFor=\"existing\">现有客户</Label>\r\n                                        </div>\r\n                                        <div className=\"flex items-center space-x-2\">\r\n                                            <RadioGroupItem value=\"new\" id=\"new\" />\r\n                                            <Label htmlFor=\"new\">新建客户</Label>\r\n                                        </div>\r\n                                    </RadioGroup>\r\n                                </div>\r\n\r\n                                {formData.clientType === 'existing' ? (\r\n                                    <div>\r\n                                        <Label>选择客户 *</Label>\r\n                                        <Select\r\n                                            value={formData.clientId}\r\n                                            onValueChange={(v) => updateFormData({ clientId: v })}\r\n                                        >\r\n                                            <SelectTrigger className=\"mt-1\">\r\n                                                <SelectValue placeholder=\"请选择客户\" />\r\n                                            </SelectTrigger>\r\n                                            <SelectContent>\r\n                                                {clients.map((client) => (\r\n                                                    <SelectItem key={client.id} value={client.id}>\r\n                                                        <div className=\"flex items-center gap-2\">\r\n                                                            {client.type === 'COMPANY' ? (\r\n                                                                <Building2 className=\"h-4 w-4 text-gray-400\" />\r\n                                                            ) : (\r\n                                                                <User className=\"h-4 w-4 text-gray-400\" />\r\n                                                            )}\r\n                                                            {client.name}\r\n                                                        </div>\r\n                                                    </SelectItem>\r\n                                                ))}\r\n                                            </SelectContent>\r\n                                        </Select>\r\n                                    </div>\r\n                                ) : (\r\n                                    <div className=\"space-y-3\">\r\n                                        <div>\r\n                                            <Label htmlFor=\"newClientName\">客户名称 *</Label>\r\n                                            <Input\r\n                                                id=\"newClientName\"\r\n                                                placeholder=\"公司名称或个人姓名\"\r\n                                                value={formData.newClientName}\r\n                                                onChange={(e) => updateFormData({ newClientName: e.target.value })}\r\n                                                className=\"mt-1\"\r\n                                            />\r\n                                        </div>\r\n                                        <div>\r\n                                            <Label>客户类型</Label>\r\n                                            <RadioGroup\r\n                                                value={formData.newClientType}\r\n                                                onValueChange={(v) => updateFormData({ newClientType: v as 'COMPANY' | 'INDIVIDUAL' })}\r\n                                                className=\"flex gap-4 mt-2\"\r\n                                            >\r\n                                                <div className=\"flex items-center space-x-2\">\r\n                                                    <RadioGroupItem value=\"COMPANY\" id=\"company\" />\r\n                                                    <Label htmlFor=\"company\">企业</Label>\r\n                                                </div>\r\n                                                <div className=\"flex items-center space-x-2\">\r\n                                                    <RadioGroupItem value=\"INDIVIDUAL\" id=\"individual\" />\r\n                                                    <Label htmlFor=\"individual\">个人</Label>\r\n                                                </div>\r\n                                            </RadioGroup>\r\n                                        </div>\r\n                                        <div className=\"grid grid-cols-2 gap-3\">\r\n                                            <div>\r\n                                                <Label htmlFor=\"newClientEmail\">邮箱</Label>\r\n                                                <Input\r\n                                                    id=\"newClientEmail\"\r\n                                                    type=\"email\"\r\n                                                    placeholder=\"client@example.com\"\r\n                                                    value={formData.newClientEmail}\r\n                                                    onChange={(e) => updateFormData({ newClientEmail: e.target.value })}\r\n                                                    className=\"mt-1\"\r\n                                                />\r\n                                            </div>\r\n                                            <div>\r\n                                                <Label htmlFor=\"newClientPhone\">电话</Label>\r\n                                                <Input\r\n                                                    id=\"newClientPhone\"\r\n                                                    placeholder=\"13800138000\"\r\n                                                    value={formData.newClientPhone}\r\n                                                    onChange={(e) => updateFormData({ newClientPhone: e.target.value })}\r\n                                                    className=\"mt-1\"\r\n                                                />\r\n                                            </div>\r\n                                        </div>\r\n                                    </div>\r\n                                )}\r\n\r\n                                {/* 对方当事人 */}\r\n                                <div>\r\n                                    <Label>对方当事人（用于利益冲突检查）</Label>\r\n                                    <div className=\"flex gap-2 mt-1\">\r\n                                        <Input\r\n                                            placeholder=\"输入对方当事人名称\"\r\n                                            value={newOpposingParty}\r\n                                            onChange={(e) => setNewOpposingParty(e.target.value)}\r\n                                            onKeyDown={(e) => e.key === 'Enter' && (e.preventDefault(), addOpposingParty())}\r\n                                        />\r\n                                        <Button type=\"button\" variant=\"outline\" size=\"icon\" onClick={addOpposingParty}>\r\n                                            <Plus className=\"h-4 w-4\" />\r\n                                        </Button>\r\n                                    </div>\r\n                                    {formData.opposingParties.length > 0 && (\r\n                                        <div className=\"flex flex-wrap gap-2 mt-2\">\r\n                                            {formData.opposingParties.map((party, index) => (\r\n                                                <Badge key={index} variant=\"secondary\" className=\"gap-1\">\r\n                                                    {party}\r\n                                                    <X\r\n                                                        className=\"h-3 w-3 cursor-pointer\"\r\n                                                        onClick={() => removeOpposingParty(index)}\r\n                                                    />\r\n                                                </Badge>\r\n                                            ))}\r\n                                        </div>\r\n                                    )}\r\n                                </div>\r\n                            </div>\r\n                        )}\r\n\r\n                        {/* Step 3: 案件类型 */}\r\n                        {step === 3 && (\r\n                            <div className=\"space-y-4\">\r\n                                <div>\r\n                                    <Label>服务类型 *</Label>\r\n                                    <RadioGroup\r\n                                        value={formData.serviceType}\r\n                                        onValueChange={(v) => updateFormData({ serviceType: v as ServiceType })}\r\n                                        className=\"grid grid-cols-2 gap-3 mt-2\"\r\n                                    >\r\n                                        <div className=\"flex items-center space-x-2 p-3 border rounded-lg hover:bg-gray-50\">\r\n                                            <RadioGroupItem value=\"LITIGATION\" id=\"litigation\" />\r\n                                            <Label htmlFor=\"litigation\" className=\"cursor-pointer\">诉讼</Label>\r\n                                        </div>\r\n                                        <div className=\"flex items-center space-x-2 p-3 border rounded-lg hover:bg-gray-50\">\r\n                                            <RadioGroupItem value=\"NON_LITIGATION\" id=\"non_litigation\" />\r\n                                            <Label htmlFor=\"non_litigation\" className=\"cursor-pointer\">非诉</Label>\r\n                                        </div>\r\n                                        <div className=\"flex items-center space-x-2 p-3 border rounded-lg hover:bg-gray-50\">\r\n                                            <RadioGroupItem value=\"ARBITRATION\" id=\"arbitration\" />\r\n                                            <Label htmlFor=\"arbitration\" className=\"cursor-pointer\">仲裁</Label>\r\n                                        </div>\r\n                                        <div className=\"flex items-center space-x-2 p-3 border rounded-lg hover:bg-gray-50\">\r\n                                            <RadioGroupItem value=\"ADVISORY\" id=\"advisory\" />\r\n                                            <Label htmlFor=\"advisory\" className=\"cursor-pointer\">常年顾问</Label>\r\n                                        </div>\r\n                                    </RadioGroup>\r\n                                </div>\r\n\r\n                                <div>\r\n                                    <Label>收费模式</Label>\r\n                                    <Select\r\n                                        value={formData.billingMode}\r\n                                        onValueChange={(v) => updateFormData({ billingMode: v as BillingMode })}\r\n                                    >\r\n                                        <SelectTrigger className=\"mt-1\">\r\n                                            <SelectValue />\r\n                                        </SelectTrigger>\r\n                                        <SelectContent>\r\n                                            <SelectItem value=\"HOURLY\">计时收费</SelectItem>\r\n                                            <SelectItem value=\"FIXED\">固定收费</SelectItem>\r\n                                            <SelectItem value=\"CAPPED\">风险/封顶收费</SelectItem>\r\n                                        </SelectContent>\r\n                                    </Select>\r\n                                </div>\r\n\r\n                                <div>\r\n                                    <Label htmlFor=\"contractValue\">合同金额（元）</Label>\r\n                                    <Input\r\n                                        id=\"contractValue\"\r\n                                        type=\"number\"\r\n                                        placeholder=\"请输入合同金额\"\r\n                                        value={formData.contractValue}\r\n                                        onChange={(e) => updateFormData({ contractValue: e.target.value })}\r\n                                        className=\"mt-1\"\r\n                                    />\r\n                                </div>\r\n                            </div>\r\n                        )}\r\n\r\n                        {/* Step 4: 团队配置 */}\r\n                        {step === 4 && (\r\n                            <div className=\"space-y-4\">\r\n                                <div>\r\n                                    <Label>案源律师</Label>\r\n                                    <Select\r\n                                        value={formData.originatorId}\r\n                                        onValueChange={(v) => updateFormData({ originatorId: v })}\r\n                                    >\r\n                                        <SelectTrigger className=\"mt-1\">\r\n                                            <SelectValue placeholder=\"选择案源律师（可选）\" />\r\n                                        </SelectTrigger>\r\n                                        <SelectContent>\r\n                                            {lawyers.filter(l => ['ADMIN', 'LAWYER'].includes(l.role)).map((lawyer) => (\r\n                                                <SelectItem key={lawyer.id} value={lawyer.id}>\r\n                                                    {lawyer.name || lawyer.email}\r\n                                                </SelectItem>\r\n                                            ))}\r\n                                        </SelectContent>\r\n                                    </Select>\r\n                                </div>\r\n\r\n                                <div>\r\n                                    <Label>承办律师 *</Label>\r\n                                    <Select\r\n                                        value={formData.handlerId}\r\n                                        onValueChange={(v) => updateFormData({ handlerId: v })}\r\n                                    >\r\n                                        <SelectTrigger className=\"mt-1\">\r\n                                            <SelectValue placeholder=\"选择承办律师\" />\r\n                                        </SelectTrigger>\r\n                                        <SelectContent>\r\n                                            {lawyers.filter(l => ['ADMIN', 'LAWYER'].includes(l.role)).map((lawyer) => (\r\n                                                <SelectItem key={lawyer.id} value={lawyer.id}>\r\n                                                    {lawyer.name || lawyer.email}\r\n                                                </SelectItem>\r\n                                            ))}\r\n                                        </SelectContent>\r\n                                    </Select>\r\n                                </div>\r\n\r\n                                <div>\r\n                                    <Label>团队成员</Label>\r\n                                    <div className=\"grid grid-cols-2 gap-2 mt-2\">\r\n                                        {lawyers.map((lawyer) => (\r\n                                            <div\r\n                                                key={lawyer.id}\r\n                                                className={`p-3 border rounded-lg cursor-pointer transition-colors ${formData.memberIds.includes(lawyer.id)\r\n                                                        ? 'border-orange-500 bg-orange-50'\r\n                                                        : 'hover:bg-gray-50'\r\n                                                    }`}\r\n                                                onClick={() => toggleMember(lawyer.id)}\r\n                                            >\r\n                                                <div className=\"flex items-center gap-2\">\r\n                                                    <UserCheck className={`h-4 w-4 ${formData.memberIds.includes(lawyer.id) ? 'text-orange-500' : 'text-gray-400'\r\n                                                        }`} />\r\n                                                    <div>\r\n                                                        <div className=\"text-sm font-medium\">{lawyer.name || lawyer.email}</div>\r\n                                                        <div className=\"text-xs text-gray-500\">{lawyer.role}</div>\r\n                                                    </div>\r\n                                                </div>\r\n                                            </div>\r\n                                        ))}\r\n                                    </div>\r\n                                </div>\r\n                            </div>\r\n                        )}\r\n\r\n                        {/* Step 5: 提交确认 */}\r\n                        {step === 5 && (\r\n                            <div className=\"space-y-4\">\r\n                                <Card>\r\n                                    <CardContent className=\"pt-6\">\r\n                                        <h3 className=\"font-semibold mb-4\">案件信息确认</h3>\r\n                                        <dl className=\"space-y-2 text-sm\">\r\n                                            <div className=\"flex justify-between\">\r\n                                                <dt className=\"text-gray-500\">案件名称</dt>\r\n                                                <dd className=\"font-medium\">{formData.title}</dd>\r\n                                            </div>\r\n                                            <div className=\"flex justify-between\">\r\n                                                <dt className=\"text-gray-500\">服务类型</dt>\r\n                                                <dd>\r\n                                                    <Badge variant=\"outline\">\r\n                                                        {formData.serviceType === 'LITIGATION' ? '诉讼' :\r\n                                                            formData.serviceType === 'NON_LITIGATION' ? '非诉' :\r\n                                                                formData.serviceType === 'ARBITRATION' ? '仲裁' : '顾问'}\r\n                                                    </Badge>\r\n                                                </dd>\r\n                                            </div>\r\n                                            <div className=\"flex justify-between\">\r\n                                                <dt className=\"text-gray-500\">收费模式</dt>\r\n                                                <dd>\r\n                                                    {formData.billingMode === 'HOURLY' ? '计时' :\r\n                                                        formData.billingMode === 'FIXED' ? '固定' : '风险'}\r\n                                                </dd>\r\n                                            </div>\r\n                                            <div className=\"flex justify-between\">\r\n                                                <dt className=\"text-gray-500\">承办律师</dt>\r\n                                                <dd>{lawyers.find(l => l.id === formData.handlerId)?.name || '-'}</dd>\r\n                                            </div>\r\n                                        </dl>\r\n                                    </CardContent>\r\n                                </Card>\r\n\r\n                                {submitError && (\r\n                                    <div className=\"p-3 bg-red-50 border border-red-200 rounded-lg text-red-600 text-sm\">\r\n                                        {submitError}\r\n                                    </div>\r\n                                )}\n\n                                <p className=\"text-sm text-gray-500 text-center\">\n                                    点击“创建案件”将自动进行利益冲突检查并创建案件\n                                </p>\n                            </div>\n                        )}\n\r\n                        {/* Step 6: 完成 */}\r\n                        {step === 6 && submitSuccess && (\r\n                            <div className=\"text-center py-8\">\r\n                                <CheckCircle className=\"h-16 w-16 text-green-500 mx-auto mb-4\" />\r\n                                <h3 className=\"text-xl font-semibold mb-2\">案件创建成功</h3>\r\n                                <p className=\"text-gray-500 mb-4\">\r\n                                    案号：<span className=\"font-mono font-bold text-orange-500\">{submitSuccess.caseCode}</span>\r\n                                </p>\r\n\r\n                                {conflictResult?.hasConflict && (\r\n                                    <div className=\"p-4 bg-yellow-50 border border-yellow-200 rounded-lg text-left mb-4\">\r\n                                        <div className=\"flex items-center gap-2 text-yellow-700 font-medium mb-2\">\r\n                                            <AlertTriangle className=\"h-5 w-5\" />\r\n                                            发现潜在利益冲突\r\n                                        </div>\r\n                                        <ul className=\"text-sm text-yellow-600 space-y-1\">\r\n                                            {conflictResult.details.map((d, i) => (\r\n                                                <li key={i}>• {d.reason}</li>\r\n                                            ))}\r\n                                        </ul>\r\n                                    </div>\r\n                                )}\r\n\r\n                                <Button onClick={handleClose} className=\"bg-orange-500 hover:bg-orange-600\">\r\n                                    查看案件详情\r\n                                </Button>\r\n                            </div>\r\n                        )}\r\n                    </div>\r\n                )}\r\n\r\n                {/* 底部按钮 */}\r\n                {step < 6 && (\r\n                    <DialogFooter className=\"gap-2\">\r\n                        {step > 1 && (\r\n                            <Button\r\n                                variant=\"outline\"\r\n                                onClick={() => setStep(s => s - 1)}\r\n                                disabled={isSubmitting}\r\n                            >\r\n                                <ChevronLeft className=\"h-4 w-4 mr-1\" />\r\n                                上一步\r\n                            </Button>\r\n                        )}\r\n                        {step < 5 ? (\r\n                            <Button\r\n                                onClick={() => setStep(s => s + 1)}\r\n                                disabled={!canProceed}\r\n                                className=\"bg-orange-500 hover:bg-orange-600\"\r\n                            >\r\n                                下一步\r\n                                <ChevronRight className=\"h-4 w-4 ml-1\" />\r\n                            </Button>\r\n                        ) : (\r\n                            <Button\r\n                                onClick={handleSubmit}\r\n                                disabled={isSubmitting || !canProceed}\r\n                                className=\"bg-orange-500 hover:bg-orange-600\"\r\n                            >\r\n                                {isSubmitting ? (\r\n                                    <>\r\n                                        <Loader2 className=\"h-4 w-4 mr-2 animate-spin\" />\r\n                                        创建中...\r\n                                    </>\r\n                                ) : (\r\n                                    '创建案件'\r\n                                )}\r\n                            </Button>\r\n                        )}\r\n                    </DialogFooter>\r\n                )}\r\n            </DialogContent>\r\n        </Dialog>\r\n    )\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"D:\\Desktop\\LawClick_NEW\\lawclick-next\\src\\components\\cases\\StageDocumentChecklist.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\Desktop\\LawClick_NEW\\lawclick-next\\src\\components\\cases\\new-draft-dialog.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'TemplateVariable' is defined but never used.","line":24,"column":21,"nodeType":null,"messageId":"unusedVar","endLine":24,"endColumn":37},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":30,"column":30,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":30,"endColumn":33,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[804,807],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[804,807],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'error' is defined but never used.","line":60,"column":18,"nodeType":null,"messageId":"unusedVar","endLine":60,"endColumn":23}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":3,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\"\r\n\r\nimport { Button } from \"@/components/ui/button\"\r\nimport {\r\n    Dialog,\r\n    DialogContent,\r\n    DialogDescription,\r\n    DialogFooter,\r\n    DialogHeader,\r\n    DialogTitle,\r\n    DialogTrigger,\r\n} from \"@/components/ui/dialog\"\r\nimport {\r\n    Select,\r\n    SelectContent,\r\n    SelectItem,\r\n    SelectTrigger,\r\n    SelectValue,\r\n} from \"@/components/ui/select\"\r\nimport { Input } from \"@/components/ui/input\"\r\nimport { Label } from \"@/components/ui/label\"\r\nimport { FilePlus, Sparkles, Loader2 } from \"lucide-react\"\r\nimport { useState } from \"react\"\r\nimport { TEMPLATES, TemplateVariable } from \"@/lib/templates/registry\"\r\nimport { generateDocument } from \"@/actions/documents\"\r\nimport { toast } from \"sonner\"\r\n\r\ninterface NewDraftDialogProps {\r\n    caseId: string\r\n    onDocumentCreated: (doc: any) => void\r\n}\r\n\r\nexport function NewDraftDialog({ caseId, onDocumentCreated }: NewDraftDialogProps) {\r\n    const [open, setOpen] = useState(false)\r\n    const [selectedTemplateId, setSelectedTemplateId] = useState<string>(\"\")\r\n    const [formData, setFormData] = useState<Record<string, string>>({})\r\n    const [isGenerating, setIsGenerating] = useState(false)\r\n\r\n    const selectedTemplate = TEMPLATES.find(t => t.id === selectedTemplateId)\r\n\r\n    const handleGenerate = async () => {\r\n        if (!selectedTemplateId) return\r\n\r\n        setIsGenerating(true)\r\n        try {\r\n            const result = await generateDocument(caseId, selectedTemplateId, formData)\r\n\r\n            if (result.success && result.document) {\r\n                toast.success(\"Document Drafted Successfully\", {\r\n                    description: `Created ${result.document.name}`\r\n                })\r\n                onDocumentCreated(result.document)\r\n                setOpen(false)\r\n                // Reset form\r\n                setFormData({})\r\n                setSelectedTemplateId(\"\")\r\n            } else {\r\n                toast.error(\"Generation Failed\")\r\n            }\r\n        } catch (error) {\r\n            toast.error(\"Error generating document\")\r\n        } finally {\r\n            setIsGenerating(false)\r\n        }\r\n    }\r\n\r\n    return (\r\n        <Dialog open={open} onOpenChange={setOpen}>\r\n            <DialogTrigger asChild>\r\n                <Button className=\"bg-gradient-to-r from-orange-400 to-amber-500 hover:from-orange-500 hover:to-amber-600 text-white border-0 shadow-lg shadow-orange-500/20\">\r\n                    <Sparkles className=\"mr-2 h-4 w-4\" />\r\n                    Smart Draft\r\n                </Button>\r\n            </DialogTrigger>\r\n            <DialogContent className=\"sm:max-w-[425px]\">\r\n                <DialogHeader>\r\n                    <DialogTitle className=\"flex items-center gap-2\">\r\n                        <Sparkles className=\"h-5 w-5 text-orange-500\" />\r\n                        Smart Document Drafting\r\n                    </DialogTitle>\r\n                    <DialogDescription>\r\n                        Select a template to auto-generate a legal document.\r\n                    </DialogDescription>\r\n                </DialogHeader>\r\n                <div className=\"grid gap-4 py-4\">\r\n                    <div className=\"grid grid-cols-4 items-center gap-4\">\r\n                        <Label htmlFor=\"template\" className=\"text-right\">\r\n                            Template\r\n                        </Label>\r\n                        <Select onValueChange={setSelectedTemplateId} value={selectedTemplateId}>\r\n                            <SelectTrigger className=\"col-span-3\">\r\n                                <SelectValue placeholder=\"Select template...\" />\r\n                            </SelectTrigger>\r\n                            <SelectContent>\r\n                                {TEMPLATES.map(t => (\r\n                                    <SelectItem key={t.id} value={t.id}>{t.name}</SelectItem>\r\n                                ))}\r\n                            </SelectContent>\r\n                        </Select>\r\n                    </div>\r\n\r\n                    {selectedTemplate && (\r\n                        <div className=\"space-y-3 border-t pt-4 mt-2\">\r\n                            <p className=\"text-xs text-muted-foreground italic mb-2\">\r\n                                {selectedTemplate.description}\r\n                            </p>\r\n                            {selectedTemplate.variables.map(variable => (\r\n                                <div key={variable.key} className=\"grid grid-cols-4 items-center gap-4\">\r\n                                    <Label htmlFor={variable.key} className=\"text-right text-xs\">\r\n                                        {variable.label}\r\n                                    </Label>\r\n                                    <Input\r\n                                        id={variable.key}\r\n                                        className=\"col-span-3 h-8 text-sm\"\r\n                                        placeholder={`Enter ${variable.label}`}\r\n                                        value={formData[variable.key] || ''}\r\n                                        onChange={(e) => setFormData(prev => ({ ...prev, [variable.key]: e.target.value }))}\r\n                                    />\r\n                                </div>\r\n                            ))}\r\n                        </div>\r\n                    )}\r\n                </div>\r\n                <DialogFooter>\r\n                    <Button type=\"button\" variant=\"secondary\" onClick={() => setOpen(false)}>\r\n                        Cancel\r\n                    </Button>\r\n                    <Button type=\"submit\" onClick={handleGenerate} disabled={!selectedTemplateId || isGenerating} className=\"bg-orange-500 hover:bg-orange-600 text-white\">\r\n                        {isGenerating ? (\r\n                            <>\r\n                                <Loader2 className=\"mr-2 h-4 w-4 animate-spin\" />\r\n                                Drafting...\r\n                            </>\r\n                        ) : (\r\n                            <>\r\n                                <FilePlus className=\"mr-2 h-4 w-4\" />\r\n                                Generate Draft\r\n                            </>\r\n                        )}\r\n                    </Button>\r\n                </DialogFooter>\r\n            </DialogContent>\r\n        </Dialog>\r\n    )\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"D:\\Desktop\\LawClick_NEW\\lawclick-next\\src\\components\\cases\\similar-cases.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'currentCaseId' is defined but never used.","line":14,"column":32,"nodeType":null,"messageId":"unusedVar","endLine":14,"endColumn":45},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'caseType' is defined but never used.","line":14,"column":47,"nodeType":null,"messageId":"unusedVar","endLine":14,"endColumn":55},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'currentStatus' is defined but never used.","line":14,"column":57,"nodeType":null,"messageId":"unusedVar","endLine":14,"endColumn":70}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":3,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\"\r\n\r\nimport { Card, CardHeader, CardTitle, CardContent } from \"@/components/ui/card\"\r\nimport { Badge } from \"@/components/ui/badge\"\r\nimport { Scale, ArrowRight } from \"lucide-react\"\r\nimport Link from \"next/link\"\r\n\r\ninterface SimilarCasesProps {\r\n    currentCaseId: string\r\n    caseType: string\r\n    currentStatus: string\r\n}\r\n\r\nexport function SimilarCases({ currentCaseId, caseType, currentStatus }: SimilarCasesProps) {\r\n    // MOCK: Logic to find similar cases\r\n    // In real app, this would be a server component or fetch from Vector DB/Search Index\r\n\r\n    // Mock recommendations\r\n    const recommendations = [\r\n        { id: 'mock1', title: 'Previous Arbitration v. Tech', similarity: 89, reason: 'Same Opposing Counsel' },\r\n        { id: 'mock2', title: 'Contract Dispute 2023', similarity: 74, reason: 'Similar Contract Clause' },\r\n    ]\r\n\r\n    return (\r\n        <Card className=\"border-orange-100/50 bg-gradient-to-b from-orange-50/30 to-white/50 backdrop-blur-sm\">\r\n            <CardHeader className=\"pb-3\">\r\n                <CardTitle className=\"text-sm font-medium flex items-center gap-2 text-orange-800\">\r\n                    <Scale className=\"h-4 w-4\" />\r\n                    Smart Context\r\n                </CardTitle>\r\n            </CardHeader>\r\n            <CardContent className=\"space-y-3\">\r\n                {recommendations.map(rec => (\r\n                    <Link key={rec.id} href={`/cases/${rec.id}`} className=\"block group\">\r\n                        <div className=\"flex items-start justify-between rounded-lg p-2 hover:bg-orange-50 transition-colors border border-transparent hover:border-orange-100\">\r\n                            <div className=\"space-y-1\">\r\n                                <div className=\"text-sm font-medium leading-none group-hover:text-orange-700 transition-colors\">\r\n                                    {rec.title}\r\n                                </div>\r\n                                <div className=\"text-xs text-muted-foreground flex items-center gap-1.5\">\r\n                                    <Badge variant=\"outline\" className=\"h-4 px-1 text-[9px] bg-white border-orange-200 text-orange-600\">\r\n                                        {rec.similarity}% Match\r\n                                    </Badge>\r\n                                    <span>• {rec.reason}</span>\r\n                                </div>\r\n                            </div>\r\n                            <ArrowRight className=\"h-3 w-3 text-muted-foreground group-hover:text-orange-500 opacity-0 group-hover:opacity-100 transition-all -translate-x-2 group-hover:translate-x-0\" />\r\n                        </div>\r\n                    </Link>\r\n                ))}\r\n            </CardContent>\r\n        </Card>\r\n    )\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"D:\\Desktop\\LawClick_NEW\\lawclick-next\\src\\components\\chat\\ChatPageClient.tsx","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":61,"column":36,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":61,"endColumn":39,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1671,1674],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1671,1674],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":103,"column":41,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":103,"endColumn":44,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[3288,3291],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[3288,3291],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'e' is defined but never used.","line":107,"column":18,"nodeType":null,"messageId":"unusedVar","endLine":107,"endColumn":19},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":156,"column":43,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":156,"endColumn":46,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[4930,4933],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[4930,4933],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has missing dependencies: 'handleSelectThread', 'selectedThreadId', and 'threads'. Either include them or remove the dependency array.","line":141,"column":8,"nodeType":"ArrayExpression","endLine":141,"endColumn":23,"suggestions":[{"desc":"Update the dependencies array to be: [handleSelectThread, selectedThreadId, threadIdParam, threads]","fix":{"range":[4498,4513],"text":"[handleSelectThread, selectedThreadId, threadIdParam, threads]"}}],"suppressions":[{"kind":"directive","justification":""}]}],"errorCount":0,"fatalErrorCount":0,"warningCount":4,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\"\n\nimport { useEffect, useMemo, useRef, useState } from \"react\"\nimport { useSession } from \"next-auth/react\"\nimport { usePathname, useSearchParams } from \"next/navigation\"\n\nimport { getChatMessages, sendChatMessage } from \"@/actions/chat-actions\"\nimport { Card, CardContent, CardHeader, CardTitle } from \"@/components/ui/card\"\nimport { Button } from \"@/components/ui/button\"\nimport { Badge } from \"@/components/ui/badge\"\nimport { ScrollArea } from \"@/components/ui/scroll-area\"\nimport { Input } from \"@/components/ui/input\"\nimport { Avatar, AvatarFallback } from \"@/components/ui/avatar\"\nimport { toast } from \"sonner\"\nimport { Briefcase, Hash, MoreHorizontal, Search, Send, Users } from \"lucide-react\"\n\ntype ChatUserLite = {\n    id: string\n    name: string | null\n    email: string\n    avatarUrl: string | null\n}\n\ntype ThreadItem = {\n    id: string\n    key: string\n    type: \"TEAM\" | \"CASE\" | \"DIRECT\"\n    title: string\n    case: { id: string; title: string; caseCode: string } | null\n    lastMessage: {\n        id: string\n        content: string\n        createdAt: string | Date\n        sender: ChatUserLite\n    } | null\n    unreadCount: number\n    participants: ChatUserLite[]\n}\n\ntype MessageItem = {\n    id: string\n    content: string\n    createdAt: string | Date\n    senderId: string\n    sender: ChatUserLite\n    type: \"TEXT\" | \"SYSTEM\"\n}\n\nexport function ChatPageClient({\n    me,\n    initialThreads,\n    initialThreadId,\n    initialMessages,\n}: {\n    me: ChatUserLite\n    initialThreads: ThreadItem[]\n    initialThreadId: string | null\n    initialMessages: MessageItem[]\n}) {\n    const { data: session } = useSession()\n    const myId = (session?.user as any)?.id || me.id\n\n    const [threads, setThreads] = useState<ThreadItem[]>(initialThreads)\n    const [selectedThreadId, setSelectedThreadId] = useState<string | null>(initialThreadId)\n    const [messages, setMessages] = useState<MessageItem[]>(initialMessages)\n    const [messageInput, setMessageInput] = useState(\"\")\n    const [searchQuery, setSearchQuery] = useState(\"\")\n    const [loadingMessages, setLoadingMessages] = useState(false)\n\n    const messagesEndRef = useRef<HTMLDivElement>(null)\n    const searchParams = useSearchParams()\n    const pathname = usePathname()\n    const threadIdParam = searchParams.get(\"threadId\")\n\n    const selectedThread = useMemo(\n        () => threads.find((t) => t.id === selectedThreadId) || null,\n        [threads, selectedThreadId]\n    )\n\n    const filteredThreads = useMemo(() => {\n        const q = searchQuery.trim().toLowerCase()\n        if (!q) return threads\n        return threads.filter((t) => {\n            const display = getThreadDisplay(t, myId)\n            return display.name.toLowerCase().includes(q)\n        })\n    }, [threads, searchQuery, myId])\n\n    useEffect(() => {\n        messagesEndRef.current?.scrollIntoView({ behavior: \"smooth\" })\n    }, [messages.length, selectedThreadId])\n\n    useEffect(() => {\n        if (!selectedThreadId && threads.length > 0) {\n            setSelectedThreadId(threads[0].id)\n        }\n    }, [threads, selectedThreadId])\n\n    const loadMessages = async (threadId: string) => {\n        setLoadingMessages(true)\n        try {\n            const res = await getChatMessages(threadId, 80)\n            setMessages(res.messages as any)\n            setThreads((prev) =>\n                prev.map((t) => (t.id === threadId ? { ...t, unreadCount: 0 } : t))\n            )\n        } catch (e) {\n            toast.error(\"加载消息失败\")\n        } finally {\n            setLoadingMessages(false)\n        }\n    }\n\n    const updateThreadInUrl = (threadId: string) => {\n        const params = new URLSearchParams(searchParams.toString())\n        params.set(\"threadId\", threadId)\n        const qs = params.toString()\n        const url = qs ? `${pathname}?${qs}` : pathname\n        window.history.replaceState(null, \"\", url)\n    }\n\n    const handleSelectThread = async (threadId: string) => {\n        setSelectedThreadId(threadId)\n        updateThreadInUrl(threadId)\n        await loadMessages(threadId)\n    }\n\n    // 支持 /chat?threadId=... 同页跳转定位（通知 actionUrl 场景）\n    useEffect(() => {\n        if (!threadIdParam) return\n        if (threadIdParam === selectedThreadId) return\n\n        const exists = threads.some((t) => t.id === threadIdParam)\n        if (!exists) {\n            toast.error(\"无法打开会话：会话不存在或无权限访问\")\n            return\n        }\n\n        void handleSelectThread(threadIdParam)\n        // eslint-disable-next-line react-hooks/exhaustive-deps\n    }, [threadIdParam])\n\n    const handleSendMessage = async () => {\n        if (!selectedThreadId) return\n        const text = messageInput.trim()\n        if (!text) return\n\n        setMessageInput(\"\")\n\n        const result = await sendChatMessage(selectedThreadId, text)\n        if (!result.success) {\n            toast.error(\"发送失败\", { description: result.error })\n            return\n        }\n\n        const created = result.message as any as MessageItem\n        setMessages((prev) => [...prev, created])\n        setThreads((prev) =>\n            prev\n                .map((t) =>\n                    t.id === selectedThreadId\n                        ? {\n                            ...t,\n                            lastMessage: {\n                                id: created.id,\n                                content: created.content,\n                                createdAt: created.createdAt,\n                                sender: created.sender,\n                            },\n                            unreadCount: 0,\n                        }\n                        : t\n                )\n                .sort((a, b) => {\n                    const aTime = a.lastMessage?.createdAt ? new Date(a.lastMessage.createdAt).getTime() : 0\n                    const bTime = b.lastMessage?.createdAt ? new Date(b.lastMessage.createdAt).getTime() : 0\n                    return bTime - aTime\n                })\n        )\n    }\n\n    return (\n        <div className=\"h-[calc(100vh-8rem)] flex gap-4\">\n            {/* 左侧会话列表 */}\n            <Card className=\"w-80 flex flex-col\">\n                <CardHeader className=\"pb-2\">\n                    <div className=\"flex items-center justify-between\">\n                        <CardTitle className=\"text-base\">消息</CardTitle>\n                        <Button variant=\"ghost\" size=\"icon\" className=\"h-8 w-8\" disabled>\n                            <MoreHorizontal className=\"h-4 w-4\" />\n                        </Button>\n                    </div>\n                    <div className=\"relative\">\n                        <Search className=\"absolute left-2 top-2.5 h-4 w-4 text-muted-foreground\" />\n                        <Input\n                            placeholder=\"搜索会话...\"\n                            value={searchQuery}\n                            onChange={(e) => setSearchQuery(e.target.value)}\n                            className=\"pl-8 h-9\"\n                        />\n                    </div>\n                </CardHeader>\n                <CardContent className=\"flex-1 p-0 overflow-hidden\">\n                    <ScrollArea className=\"h-full\">\n                        {filteredThreads.length === 0 ? (\n                            <div className=\"p-6 text-sm text-muted-foreground text-center\">\n                                暂无会话\n                            </div>\n                        ) : (\n                            <div className=\"p-2 space-y-1\">\n                                {filteredThreads.map((t) => {\n                                    const display = getThreadDisplay(t, myId)\n                                    const active = selectedThreadId === t.id\n\n                                    const lastTime = t.lastMessage?.createdAt\n                                        ? formatTime(t.lastMessage.createdAt)\n                                        : \"\"\n\n                                    return (\n                                        <div\n                                            key={t.id}\n                                            className={`flex items-center gap-3 p-2 rounded-lg cursor-pointer transition-colors ${active ? \"bg-primary/10\" : \"hover:bg-muted\"\n                                                }`}\n                                            onClick={() => void handleSelectThread(t.id)}\n                                        >\n                                            <div className=\"relative\">\n                                                <Avatar className=\"h-10 w-10\">\n                                                    <AvatarFallback className=\"bg-slate-100 text-slate-600\">\n                                                        {t.type === \"TEAM\" ? (\n                                                            <Hash className=\"h-4 w-4\" />\n                                                        ) : t.type === \"CASE\" ? (\n                                                            <Briefcase className=\"h-4 w-4 text-orange-500\" />\n                                                        ) : (\n                                                            display.avatarText\n                                                        )}\n                                                    </AvatarFallback>\n                                                </Avatar>\n                                                {t.unreadCount > 0 && (\n                                                    <span className=\"absolute -top-1 -right-1 h-5 min-w-5 rounded-full bg-red-500 text-[10px] font-medium text-white flex items-center justify-center px-1\">\n                                                        {t.unreadCount > 99 ? \"99+\" : t.unreadCount}\n                                                    </span>\n                                                )}\n                                            </div>\n\n                                            <div className=\"flex-1 min-w-0\">\n                                                <div className=\"flex items-center justify-between gap-2\">\n                                                    <span className=\"font-medium text-sm truncate\">{display.name}</span>\n                                                    <span className=\"text-[10px] text-muted-foreground shrink-0\">{lastTime}</span>\n                                                </div>\n                                                <p className=\"text-xs text-muted-foreground truncate\">\n                                                    {t.lastMessage?.content || \"暂无消息\"}\n                                                </p>\n                                            </div>\n                                        </div>\n                                    )\n                                })}\n                            </div>\n                        )}\n                    </ScrollArea>\n                </CardContent>\n            </Card>\n\n            {/* 右侧聊天区域 */}\n            <Card className=\"flex-1 flex flex-col\">\n                <CardHeader className=\"pb-3 border-b\">\n                    {selectedThread ? (\n                        <ChatHeader thread={selectedThread} myId={myId} />\n                    ) : (\n                        <div className=\"text-sm text-muted-foreground\">请选择一个会话</div>\n                    )}\n                </CardHeader>\n\n                <CardContent className=\"flex-1 p-0 overflow-hidden\">\n                    <ScrollArea className=\"h-full p-4\">\n                        {loadingMessages ? (\n                            <div className=\"text-sm text-muted-foreground text-center py-10\">加载中...</div>\n                        ) : (\n                            <div className=\"space-y-4\">\n                                {messages.map((msg) => (\n                                    <MessageRow key={msg.id} msg={msg} myId={myId} />\n                                ))}\n                                <div ref={messagesEndRef} />\n                            </div>\n                        )}\n                    </ScrollArea>\n                </CardContent>\n\n                <div className=\"border-t p-4\">\n                    <form\n                        className=\"flex items-center gap-2\"\n                        onSubmit={(e) => {\n                            e.preventDefault()\n                            void handleSendMessage()\n                        }}\n                    >\n                        <Input\n                            placeholder={selectedThread ? \"输入消息...\" : \"请选择会话\"}\n                            value={messageInput}\n                            onChange={(e) => setMessageInput(e.target.value)}\n                            disabled={!selectedThreadId}\n                            className=\"flex-1\"\n                        />\n                        <Button type=\"submit\" size=\"icon\" disabled={!selectedThreadId || !messageInput.trim()}>\n                            <Send className=\"h-4 w-4\" />\n                        </Button>\n                    </form>\n                </div>\n            </Card>\n        </div>\n    )\n}\n\nfunction ChatHeader({ thread, myId }: { thread: ThreadItem; myId: string }) {\n    const display = getThreadDisplay(thread, myId)\n    return (\n        <div className=\"flex items-center justify-between\">\n            <div className=\"flex items-center gap-3\">\n                <Avatar className=\"h-10 w-10\">\n                    <AvatarFallback className=\"bg-slate-100 text-slate-600\">\n                        {thread.type === \"TEAM\" ? (\n                            <Hash className=\"h-4 w-4\" />\n                        ) : thread.type === \"CASE\" ? (\n                            <Briefcase className=\"h-4 w-4 text-orange-500\" />\n                        ) : (\n                            display.avatarText\n                        )}\n                    </AvatarFallback>\n                </Avatar>\n                <div>\n                    <div className=\"flex items-center gap-2\">\n                        <span className=\"font-medium text-sm\">{display.name}</span>\n                        {thread.type === \"TEAM\" ? (\n                            <Badge variant=\"secondary\" className=\"text-[10px]\">团队</Badge>\n                        ) : null}\n                        {thread.type === \"CASE\" && thread.case ? (\n                            <Badge variant=\"secondary\" className=\"text-[10px] bg-orange-50 text-orange-700\">\n                                {thread.case.caseCode}\n                            </Badge>\n                        ) : null}\n                    </div>\n                    {thread.type === \"CASE\" && thread.case ? (\n                        <p className=\"text-xs text-muted-foreground\">关联案件：{thread.case.title}</p>\n                    ) : null}\n                </div>\n            </div>\n            <div className=\"flex items-center gap-1\">\n                <Button variant=\"ghost\" size=\"icon\" className=\"h-8 w-8\" disabled>\n                    <Users className=\"h-4 w-4\" />\n                </Button>\n            </div>\n        </div>\n    )\n}\n\nfunction MessageRow({ msg, myId }: { msg: MessageItem; myId: string }) {\n    const isMe = msg.senderId === myId\n    const time = formatTime(msg.createdAt)\n\n    if (msg.type === \"SYSTEM\") {\n        return (\n            <div className=\"text-center text-xs text-muted-foreground\">\n                {msg.content}\n            </div>\n        )\n    }\n\n    return (\n        <div className={`flex ${isMe ? \"justify-end\" : \"justify-start\"}`}>\n            <div className={`flex gap-2 max-w-[70%] ${isMe ? \"flex-row-reverse\" : \"\"}`}>\n                {!isMe ? (\n                    <Avatar className=\"h-8 w-8\">\n                        <AvatarFallback className=\"text-xs bg-orange-100 text-orange-600\">\n                            {(msg.sender?.name || msg.sender?.email || \"U\").slice(0, 1)}\n                        </AvatarFallback>\n                    </Avatar>\n                ) : null}\n\n                <div>\n                    {!isMe ? (\n                        <p className=\"text-xs text-muted-foreground mb-1\">\n                            {msg.sender?.name || msg.sender?.email}\n                        </p>\n                    ) : null}\n                    <div\n                        className={`rounded-lg px-3 py-2 ${isMe ? \"bg-primary text-primary-foreground\" : \"bg-muted\"\n                            }`}\n                    >\n                        <p className=\"text-sm whitespace-pre-wrap break-words\">{msg.content}</p>\n                    </div>\n                    <p className={`text-[10px] text-muted-foreground mt-1 ${isMe ? \"text-right\" : \"\"}`}>\n                        {time}\n                    </p>\n                </div>\n            </div>\n        </div>\n    )\n}\n\nfunction getThreadDisplay(thread: ThreadItem, myId: string) {\n    if (thread.type === \"DIRECT\") {\n        const other = thread.participants.find((p) => p.id !== myId)\n        const name = other?.name || other?.email || \"私聊\"\n        return { name, avatarText: (name || \"U\").slice(0, 1) }\n    }\n    if (thread.type === \"CASE\") {\n        const name = thread.case?.title || thread.title\n        return { name, avatarText: \"案\" }\n    }\n    return { name: thread.title || \"团队群聊\", avatarText: \"#\" }\n}\n\nfunction formatTime(value: string | Date) {\n    const d = typeof value === \"string\" ? new Date(value) : value\n    if (Number.isNaN(d.getTime())) return \"\"\n    return d.toLocaleString(\"zh-CN\", { month: \"2-digit\", day: \"2-digit\", hour: \"2-digit\", minute: \"2-digit\" })\n}\n","usedDeprecatedRules":[]},{"filePath":"D:\\Desktop\\LawClick_NEW\\lawclick-next\\src\\components\\crm\\AddServiceRecordDialog.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'e' is defined but never used.","line":155,"column":38,"nodeType":null,"messageId":"unusedVar","endLine":155,"endColumn":39}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\"\n\nimport { useMemo, useState } from \"react\"\nimport { useRouter } from \"next/navigation\"\nimport { toast } from \"sonner\"\nimport { Plus } from \"lucide-react\"\n\nimport { addServiceRecord } from \"@/actions/customer-actions\"\nimport { Button } from \"@/components/ui/button\"\nimport { Dialog, DialogContent, DialogFooter, DialogHeader, DialogTitle, DialogTrigger } from \"@/components/ui/dialog\"\nimport { Input } from \"@/components/ui/input\"\nimport { Label } from \"@/components/ui/label\"\nimport { Textarea } from \"@/components/ui/textarea\"\nimport { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from \"@/components/ui/select\"\n\nconst TYPE_OPTIONS = [\n    { value: \"咨询\", label: \"咨询\" },\n    { value: \"案件沟通\", label: \"案件沟通\" },\n    { value: \"尽调\", label: \"尽调\" },\n    { value: \"非诉\", label: \"非诉\" },\n    { value: \"诉讼\", label: \"诉讼\" },\n    { value: \"常年法顾\", label: \"常年法顾\" },\n    { value: \"其他\", label: \"其他\" },\n] as const\n\nexport function AddServiceRecordDialog({ contactId }: { contactId: string }) {\n    const router = useRouter()\n    const [open, setOpen] = useState(false)\n    const [saving, setSaving] = useState(false)\n\n    const [form, setForm] = useState({\n        type: \"咨询\",\n        serviceDate: new Date().toISOString().slice(0, 10),\n        satisfaction: \"\",\n        content: \"\",\n        followUpNote: \"\",\n        nextAction: \"\",\n    })\n\n    const canSave = useMemo(() => form.content.trim().length > 3, [form.content])\n\n    return (\n        <Dialog open={open} onOpenChange={setOpen}>\n            <DialogTrigger asChild>\n                <Button variant=\"outline\">\n                    <Plus className=\"h-4 w-4 mr-2\" />\n                    添加服务记录\n                </Button>\n            </DialogTrigger>\n            <DialogContent className=\"sm:max-w-[720px]\">\n                <DialogHeader>\n                    <DialogTitle>新增服务记录</DialogTitle>\n                </DialogHeader>\n\n                <div className=\"grid grid-cols-1 md:grid-cols-2 gap-4\">\n                    <div className=\"space-y-2\">\n                        <Label>类型</Label>\n                        <Select value={form.type} onValueChange={(v) => setForm((p) => ({ ...p, type: v }))}>\n                            <SelectTrigger>\n                                <SelectValue placeholder=\"选择类型\" />\n                            </SelectTrigger>\n                            <SelectContent>\n                                {TYPE_OPTIONS.map((o) => (\n                                    <SelectItem key={o.value} value={o.value}>\n                                        {o.label}\n                                    </SelectItem>\n                                ))}\n                            </SelectContent>\n                        </Select>\n                    </div>\n                    <div className=\"space-y-2\">\n                        <Label>服务日期</Label>\n                        <Input\n                            type=\"date\"\n                            value={form.serviceDate}\n                            onChange={(e) => setForm((p) => ({ ...p, serviceDate: e.target.value }))}\n                        />\n                    </div>\n\n                    <div className=\"space-y-2\">\n                        <Label>满意度（可选）</Label>\n                        <Select\n                            value={form.satisfaction || \"__none__\"}\n                            onValueChange={(v) => setForm((p) => ({ ...p, satisfaction: v === \"__none__\" ? \"\" : v }))}\n                        >\n                            <SelectTrigger>\n                                <SelectValue placeholder=\"选择满意度\" />\n                            </SelectTrigger>\n                            <SelectContent>\n                                <SelectItem value=\"__none__\">不填写</SelectItem>\n                                {[1, 2, 3, 4, 5].map((n) => (\n                                    <SelectItem key={n} value={String(n)}>\n                                        {n}\n                                    </SelectItem>\n                                ))}\n                            </SelectContent>\n                        </Select>\n                    </div>\n\n                    <div className=\"space-y-2 md:col-span-2\">\n                        <Label>服务内容</Label>\n                        <Textarea\n                            value={form.content}\n                            onChange={(e) => setForm((p) => ({ ...p, content: e.target.value }))}\n                            placeholder=\"记录沟通要点、结论与建议...\"\n                            rows={4}\n                        />\n                    </div>\n\n                    <div className=\"space-y-2 md:col-span-2\">\n                        <Label>跟进备注（可选）</Label>\n                        <Textarea\n                            value={form.followUpNote}\n                            onChange={(e) => setForm((p) => ({ ...p, followUpNote: e.target.value }))}\n                            rows={2}\n                        />\n                    </div>\n\n                    <div className=\"space-y-2 md:col-span-2\">\n                        <Label>下一步动作（可选）</Label>\n                        <Input\n                            value={form.nextAction}\n                            onChange={(e) => setForm((p) => ({ ...p, nextAction: e.target.value }))}\n                            placeholder=\"例如：整理证据清单 / 输出报价 / 预约复盘...\"\n                        />\n                    </div>\n                </div>\n\n                <DialogFooter>\n                    <Button variant=\"outline\" onClick={() => setOpen(false)} disabled={saving}>\n                        取消\n                    </Button>\n                    <Button\n                        disabled={!canSave || saving}\n                        onClick={async () => {\n                            if (!canSave) return\n                            setSaving(true)\n                            try {\n                                const res = await addServiceRecord({\n                                    contactId,\n                                    type: form.type,\n                                    content: form.content.trim(),\n                                    serviceDate: new Date(form.serviceDate + \"T00:00:00\"),\n                                    satisfaction: form.satisfaction ? Number(form.satisfaction) : undefined,\n                                    followUpNote: form.followUpNote.trim() || undefined,\n                                    nextAction: form.nextAction.trim() || undefined,\n                                })\n                                if (!res.success) {\n                                    toast.error(\"添加失败\", { description: res.error })\n                                    return\n                                }\n                                toast.success(\"已添加服务记录\")\n                                setOpen(false)\n                                router.refresh()\n                            } catch (e) {\n                                toast.error(\"添加失败\")\n                            } finally {\n                                setSaving(false)\n                            }\n                        }}\n                    >\n                        {saving ? \"保存中...\" : \"保存\"}\n                    </Button>\n                </DialogFooter>\n            </DialogContent>\n        </Dialog>\n    )\n}\n\n","usedDeprecatedRules":[]},{"filePath":"D:\\Desktop\\LawClick_NEW\\lawclick-next\\src\\components\\crm\\CreateCaseFromCustomerDialog.tsx","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":39,"column":45,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":39,"endColumn":48,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1301,1304],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1301,1304],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":157,"column":70,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":157,"endColumn":73,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[6654,6657],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[6654,6657],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":158,"column":70,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":158,"endColumn":73,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[6728,6731],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[6728,6731],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'e' is defined but never used.","line":184,"column":38,"nodeType":null,"messageId":"unusedVar","endLine":184,"endColumn":39}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":4,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\"\n\nimport { useMemo, useState } from \"react\"\nimport { useRouter } from \"next/navigation\"\nimport { useSession } from \"next-auth/react\"\nimport { toast } from \"sonner\"\nimport { Briefcase } from \"lucide-react\"\n\nimport { createCase } from \"@/actions/cases-crud\"\nimport { Button } from \"@/components/ui/button\"\nimport { Dialog, DialogContent, DialogFooter, DialogHeader, DialogTitle, DialogTrigger } from \"@/components/ui/dialog\"\nimport { Input } from \"@/components/ui/input\"\nimport { Label } from \"@/components/ui/label\"\nimport { Textarea } from \"@/components/ui/textarea\"\nimport { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from \"@/components/ui/select\"\n\nconst SERVICE_TYPES = [\n    { value: \"LITIGATION\", label: \"诉讼\" },\n    { value: \"ARBITRATION\", label: \"仲裁\" },\n    { value: \"NON_LITIGATION\", label: \"非诉\" },\n    { value: \"ADVISORY\", label: \"常年顾问\" },\n] as const\n\nconst BILLING_MODES = [\n    { value: \"HOURLY\", label: \"计时\" },\n    { value: \"FIXED\", label: \"固定\" },\n    { value: \"CAPPED\", label: \"封顶/风险\" },\n] as const\n\nexport function CreateCaseFromCustomerDialog({\n    customerId,\n    customerName,\n}: {\n    customerId: string\n    customerName: string\n}) {\n    const router = useRouter()\n    const { data: session } = useSession()\n    const currentUserId = (session?.user as any)?.id as string | undefined\n\n    const [open, setOpen] = useState(false)\n    const [creating, setCreating] = useState(false)\n\n    const [form, setForm] = useState({\n        title: \"\",\n        serviceType: \"LITIGATION\",\n        billingMode: \"HOURLY\",\n        contractValue: \"\",\n        description: \"\",\n    })\n\n    const canCreate = useMemo(() => form.title.trim().length > 3 && !!currentUserId, [form.title, currentUserId])\n\n    return (\n        <Dialog open={open} onOpenChange={setOpen}>\n            <DialogTrigger asChild>\n                <Button>\n                    <Briefcase className=\"h-4 w-4 mr-2\" />\n                    创建案件\n                </Button>\n            </DialogTrigger>\n            <DialogContent className=\"sm:max-w-[720px]\">\n                <DialogHeader>\n                    <DialogTitle>从客户创建案件</DialogTitle>\n                </DialogHeader>\n\n                <div className=\"space-y-4\">\n                    <div className=\"text-sm text-muted-foreground\">\n                        客户：<span className=\"font-medium text-foreground\">{customerName}</span>\n                    </div>\n\n                    <div className=\"space-y-2\">\n                        <Label>案件标题</Label>\n                        <Input\n                            value={form.title}\n                            onChange={(e) => setForm((p) => ({ ...p, title: e.target.value }))}\n                            placeholder=\"例如：××公司合同纠纷诉讼案\"\n                        />\n                    </div>\n\n                    <div className=\"grid grid-cols-1 md:grid-cols-2 gap-4\">\n                        <div className=\"space-y-2\">\n                            <Label>业务类型</Label>\n                            <Select value={form.serviceType} onValueChange={(v) => setForm((p) => ({ ...p, serviceType: v }))}>\n                                <SelectTrigger>\n                                    <SelectValue placeholder=\"选择业务类型\" />\n                                </SelectTrigger>\n                                <SelectContent>\n                                    {SERVICE_TYPES.map((o) => (\n                                        <SelectItem key={o.value} value={o.value}>\n                                            {o.label}\n                                        </SelectItem>\n                                    ))}\n                                </SelectContent>\n                            </Select>\n                        </div>\n\n                        <div className=\"space-y-2\">\n                            <Label>计费模式</Label>\n                            <Select value={form.billingMode} onValueChange={(v) => setForm((p) => ({ ...p, billingMode: v }))}>\n                                <SelectTrigger>\n                                    <SelectValue placeholder=\"选择计费模式\" />\n                                </SelectTrigger>\n                                <SelectContent>\n                                    {BILLING_MODES.map((o) => (\n                                        <SelectItem key={o.value} value={o.value}>\n                                            {o.label}\n                                        </SelectItem>\n                                    ))}\n                                </SelectContent>\n                            </Select>\n                        </div>\n                    </div>\n\n                    <div className=\"space-y-2\">\n                        <Label>合同金额（可选）</Label>\n                        <Input\n                            value={form.contractValue}\n                            onChange={(e) => setForm((p) => ({ ...p, contractValue: e.target.value }))}\n                            placeholder=\"例如：500000\"\n                        />\n                    </div>\n\n                    <div className=\"space-y-2\">\n                        <Label>案件说明（可选）</Label>\n                        <Textarea\n                            value={form.description}\n                            onChange={(e) => setForm((p) => ({ ...p, description: e.target.value }))}\n                            rows={3}\n                            placeholder=\"简述案情与目标...\"\n                        />\n                    </div>\n                </div>\n\n                <DialogFooter>\n                    <Button variant=\"outline\" onClick={() => setOpen(false)} disabled={creating}>\n                        取消\n                    </Button>\n                    <Button\n                        disabled={!canCreate || creating}\n                        onClick={async () => {\n                            if (!currentUserId) {\n                                toast.error(\"请先登录\")\n                                return\n                            }\n                            if (form.title.trim().length < 4) return\n                            setCreating(true)\n                            try {\n                                const contractValueNum = form.contractValue.trim() ? Number(form.contractValue.trim()) : undefined\n                                if (form.contractValue.trim() && Number.isNaN(contractValueNum)) {\n                                    toast.error(\"合同金额格式不正确\")\n                                    return\n                                }\n\n                                const res = await createCase({\n                                    title: form.title.trim(),\n                                    serviceType: form.serviceType as any,\n                                    billingMode: form.billingMode as any,\n                                    description: form.description.trim() || undefined,\n                                    contractValue: contractValueNum,\n                                    clientId: customerId,\n                                    handlerId: currentUserId,\n                                    originatorId: currentUserId,\n                                    memberIds: [],\n                                    opposingParties: [],\n                                })\n\n                                if (!res.success || !res.caseId) {\n                                    toast.error(\"创建失败\", { description: res.error })\n                                    return\n                                }\n\n                                if (res.conflictCheck?.hasConflict) {\n                                    toast.warning(\"已创建案件，但存在冲突风险\", {\n                                        description: (res.conflictCheck.details || []).slice(0, 2).map((d) => d.reason).join(\"；\"),\n                                    })\n                                } else {\n                                    toast.success(\"已创建案件\")\n                                }\n\n                                setOpen(false)\n                                router.push(`/cases/${res.caseId}`)\n                                router.refresh()\n                            } catch (e) {\n                                toast.error(\"创建失败\")\n                            } finally {\n                                setCreating(false)\n                            }\n                        }}\n                    >\n                        {creating ? \"创建中...\" : \"创建\"}\n                    </Button>\n                </DialogFooter>\n            </DialogContent>\n        </Dialog>\n    )\n}\n\n","usedDeprecatedRules":[]},{"filePath":"D:\\Desktop\\LawClick_NEW\\lawclick-next\\src\\components\\crm\\CreateCustomerDialog.tsx","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":208,"column":58,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":208,"endColumn":61,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[8665,8668],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[8665,8668],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":209,"column":58,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":209,"endColumn":61,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[8727,8730],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[8727,8730],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'e' is defined but never used.","line":221,"column":38,"nodeType":null,"messageId":"unusedVar","endLine":221,"endColumn":39}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":3,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\"\n\nimport { useMemo, useState } from \"react\"\nimport { useRouter } from \"next/navigation\"\nimport { toast } from \"sonner\"\nimport { UserPlus } from \"lucide-react\"\n\nimport { createCustomer } from \"@/actions/customer-actions\"\nimport { Button } from \"@/components/ui/button\"\nimport { Dialog, DialogContent, DialogFooter, DialogHeader, DialogTitle, DialogTrigger } from \"@/components/ui/dialog\"\nimport { Input } from \"@/components/ui/input\"\nimport { Label } from \"@/components/ui/label\"\nimport { Textarea } from \"@/components/ui/textarea\"\nimport { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from \"@/components/ui/select\"\n\nconst STAGE_OPTIONS = [\n    { value: \"POTENTIAL\", label: \"潜在\" },\n    { value: \"CONTACTED\", label: \"已接触\" },\n    { value: \"NEGOTIATING\", label: \"沟通中\" },\n    { value: \"QUOTING\", label: \"报价中\" },\n    { value: \"SIGNED\", label: \"已签约\" },\n    { value: \"LONG_TERM\", label: \"长期客户\" },\n    { value: \"LOST\", label: \"已流失\" },\n] as const\n\nconst GRADE_OPTIONS = [\n    { value: \"VIP\", label: \"VIP\" },\n    { value: \"NORMAL\", label: \"普通\" },\n    { value: \"POTENTIAL\", label: \"潜在\" },\n] as const\n\nexport function CreateCustomerDialog({ buttonLabel = \"新增客户\" }: { buttonLabel?: string }) {\n    const router = useRouter()\n    const [open, setOpen] = useState(false)\n    const [submitting, setSubmitting] = useState(false)\n\n    const [form, setForm] = useState({\n        name: \"\",\n        type: \"COMPANY\" as \"COMPANY\" | \"INDIVIDUAL\",\n        email: \"\",\n        phone: \"\",\n        industry: \"\",\n        source: \"\",\n        address: \"\",\n        notes: \"\",\n        stage: \"POTENTIAL\",\n        grade: \"POTENTIAL\",\n    })\n\n    const canSubmit = useMemo(() => form.name.trim().length > 1, [form.name])\n\n    return (\n        <Dialog open={open} onOpenChange={setOpen}>\n            <DialogTrigger asChild>\n                <Button>\n                    <UserPlus className=\"h-4 w-4 mr-2\" />\n                    {buttonLabel}\n                </Button>\n            </DialogTrigger>\n            <DialogContent className=\"sm:max-w-[720px]\">\n                <DialogHeader>\n                    <DialogTitle>新增客户</DialogTitle>\n                </DialogHeader>\n\n                <div className=\"grid grid-cols-1 md:grid-cols-2 gap-4\">\n                    <div className=\"space-y-2\">\n                        <Label>客户名称</Label>\n                        <Input\n                            value={form.name}\n                            onChange={(e) => setForm((p) => ({ ...p, name: e.target.value }))}\n                            placeholder=\"公司名或个人姓名\"\n                        />\n                    </div>\n\n                    <div className=\"space-y-2\">\n                        <Label>类型</Label>\n                        <Select\n                            value={form.type}\n                            onValueChange={(v) => setForm((p) => ({ ...p, type: v as \"COMPANY\" | \"INDIVIDUAL\" }))}\n                        >\n                            <SelectTrigger>\n                                <SelectValue placeholder=\"选择类型\" />\n                            </SelectTrigger>\n                            <SelectContent>\n                                <SelectItem value=\"COMPANY\">企业</SelectItem>\n                                <SelectItem value=\"INDIVIDUAL\">个人</SelectItem>\n                            </SelectContent>\n                        </Select>\n                    </div>\n\n                    <div className=\"space-y-2\">\n                        <Label>邮箱</Label>\n                        <Input\n                            value={form.email}\n                            onChange={(e) => setForm((p) => ({ ...p, email: e.target.value }))}\n                            placeholder=\"可选\"\n                        />\n                    </div>\n\n                    <div className=\"space-y-2\">\n                        <Label>电话</Label>\n                        <Input\n                            value={form.phone}\n                            onChange={(e) => setForm((p) => ({ ...p, phone: e.target.value }))}\n                            placeholder=\"可选\"\n                        />\n                    </div>\n\n                    <div className=\"space-y-2\">\n                        <Label>行业</Label>\n                        <Input\n                            value={form.industry}\n                            onChange={(e) => setForm((p) => ({ ...p, industry: e.target.value }))}\n                            placeholder=\"可选\"\n                        />\n                    </div>\n\n                    <div className=\"space-y-2\">\n                        <Label>来源</Label>\n                        <Input\n                            value={form.source}\n                            onChange={(e) => setForm((p) => ({ ...p, source: e.target.value }))}\n                            placeholder=\"推荐 / 广告 / 自来...\"\n                        />\n                    </div>\n\n                    <div className=\"space-y-2 md:col-span-2\">\n                        <Label>地址</Label>\n                        <Input\n                            value={form.address}\n                            onChange={(e) => setForm((p) => ({ ...p, address: e.target.value }))}\n                            placeholder=\"可选\"\n                        />\n                    </div>\n\n                    <div className=\"space-y-2\">\n                        <Label>阶段</Label>\n                        <Select\n                            value={form.stage}\n                            onValueChange={(v) => setForm((p) => ({ ...p, stage: v }))}\n                        >\n                            <SelectTrigger>\n                                <SelectValue placeholder=\"选择阶段\" />\n                            </SelectTrigger>\n                            <SelectContent>\n                                {STAGE_OPTIONS.map((o) => (\n                                    <SelectItem key={o.value} value={o.value}>\n                                        {o.label}\n                                    </SelectItem>\n                                ))}\n                            </SelectContent>\n                        </Select>\n                    </div>\n\n                    <div className=\"space-y-2\">\n                        <Label>等级</Label>\n                        <Select\n                            value={form.grade}\n                            onValueChange={(v) => setForm((p) => ({ ...p, grade: v }))}\n                        >\n                            <SelectTrigger>\n                                <SelectValue placeholder=\"选择等级\" />\n                            </SelectTrigger>\n                            <SelectContent>\n                                {GRADE_OPTIONS.map((o) => (\n                                    <SelectItem key={o.value} value={o.value}>\n                                        {o.label}\n                                    </SelectItem>\n                                ))}\n                            </SelectContent>\n                        </Select>\n                    </div>\n\n                    <div className=\"space-y-2 md:col-span-2\">\n                        <Label>备注</Label>\n                        <Textarea\n                            value={form.notes}\n                            onChange={(e) => setForm((p) => ({ ...p, notes: e.target.value }))}\n                            placeholder=\"客户背景、偏好、风险点...\"\n                            rows={3}\n                        />\n                    </div>\n                </div>\n\n                <DialogFooter>\n                    <Button\n                        variant=\"outline\"\n                        onClick={() => setOpen(false)}\n                        disabled={submitting}\n                    >\n                        取消\n                    </Button>\n                    <Button\n                        disabled={!canSubmit || submitting}\n                        onClick={async () => {\n                            if (!canSubmit) return\n                            setSubmitting(true)\n                            try {\n                                const res = await createCustomer({\n                                    name: form.name.trim(),\n                                    type: form.type,\n                                    email: form.email.trim() || undefined,\n                                    phone: form.phone.trim() || undefined,\n                                    industry: form.industry.trim() || undefined,\n                                    source: form.source.trim() || undefined,\n                                    address: form.address.trim() || undefined,\n                                    notes: form.notes.trim() || undefined,\n                                    stage: form.stage as any,\n                                    grade: form.grade as any,\n                                })\n\n                                if (!res.success || !res.data) {\n                                    toast.error(\"创建失败\", { description: res.error })\n                                    return\n                                }\n\n                                toast.success(\"已创建客户\")\n                                setOpen(false)\n                                router.push(`/crm/customers/${res.data.id}`)\n                                router.refresh()\n                            } catch (e) {\n                                toast.error(\"创建失败\")\n                            } finally {\n                                setSubmitting(false)\n                            }\n                        }}\n                    >\n                        {submitting ? \"创建中...\" : \"创建\"}\n                    </Button>\n                </DialogFooter>\n            </DialogContent>\n        </Dialog>\n    )\n}\n\n","usedDeprecatedRules":[]},{"filePath":"D:\\Desktop\\LawClick_NEW\\lawclick-next\\src\\components\\crm\\CustomerEditDialog.tsx","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":201,"column":58,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":201,"endColumn":61,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[8870,8873],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[8870,8873],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":202,"column":58,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":202,"endColumn":61,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[8932,8935],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[8932,8935],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'e' is defined but never used.","line":214,"column":38,"nodeType":null,"messageId":"unusedVar","endLine":214,"endColumn":39}],"suppressedMessages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":51,"column":15,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":51,"endColumn":18,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1623,1626],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1623,1626],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}],"suppressions":[{"kind":"directive","justification":""}]}],"errorCount":0,"fatalErrorCount":0,"warningCount":3,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\"\n\nimport { useMemo, useState } from \"react\"\nimport { useRouter } from \"next/navigation\"\nimport { toast } from \"sonner\"\nimport { Edit } from \"lucide-react\"\n\nimport { updateCustomer } from \"@/actions/customer-actions\"\nimport { Button } from \"@/components/ui/button\"\nimport { Dialog, DialogContent, DialogFooter, DialogHeader, DialogTitle, DialogTrigger } from \"@/components/ui/dialog\"\nimport { Input } from \"@/components/ui/input\"\nimport { Label } from \"@/components/ui/label\"\nimport { Textarea } from \"@/components/ui/textarea\"\nimport { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from \"@/components/ui/select\"\n\ntype TeamMember = {\n    id: string\n    name: string | null\n    department?: string | null\n    title?: string | null\n}\n\nconst STAGE_OPTIONS = [\n    { value: \"POTENTIAL\", label: \"潜在\" },\n    { value: \"CONTACTED\", label: \"已接触\" },\n    { value: \"NEGOTIATING\", label: \"沟通中\" },\n    { value: \"QUOTING\", label: \"报价中\" },\n    { value: \"SIGNED\", label: \"已签约\" },\n    { value: \"LONG_TERM\", label: \"长期客户\" },\n    { value: \"LOST\", label: \"已流失\" },\n] as const\n\nconst GRADE_OPTIONS = [\n    { value: \"VIP\", label: \"VIP\" },\n    { value: \"NORMAL\", label: \"普通\" },\n    { value: \"POTENTIAL\", label: \"潜在\" },\n] as const\n\nfunction toDateInputValue(value?: string | Date | null) {\n    if (!value) return \"\"\n    const d = value instanceof Date ? value : new Date(value)\n    if (Number.isNaN(d.getTime())) return \"\"\n    return d.toISOString().slice(0, 10)\n}\n\nexport function CustomerEditDialog({\n    customer,\n    teamMembers,\n}: {\n    // eslint-disable-next-line @typescript-eslint/no-explicit-any\n    customer: any\n    teamMembers: TeamMember[]\n}) {\n    const router = useRouter()\n    const [open, setOpen] = useState(false)\n    const [saving, setSaving] = useState(false)\n\n    const [form, setForm] = useState(() => ({\n        name: customer?.name || \"\",\n        email: customer?.email || \"\",\n        phone: customer?.phone || \"\",\n        industry: customer?.industry || \"\",\n        source: customer?.source || \"\",\n        address: customer?.address || \"\",\n        notes: customer?.notes || \"\",\n        stage: customer?.stage || \"POTENTIAL\",\n        grade: customer?.grade || \"POTENTIAL\",\n        nextFollowUp: toDateInputValue(customer?.nextFollowUp),\n        assigneeId: customer?.assigneeId || customer?.assignee?.id || \"\",\n    }))\n\n    const canSave = useMemo(() => String(form.name || \"\").trim().length > 1, [form.name])\n\n    return (\n        <Dialog open={open} onOpenChange={setOpen}>\n            <DialogTrigger asChild>\n                <Button variant=\"outline\">\n                    <Edit className=\"h-4 w-4 mr-2\" />\n                    编辑\n                </Button>\n            </DialogTrigger>\n            <DialogContent className=\"sm:max-w-[720px]\">\n                <DialogHeader>\n                    <DialogTitle>编辑客户</DialogTitle>\n                </DialogHeader>\n\n                <div className=\"grid grid-cols-1 md:grid-cols-2 gap-4\">\n                    <div className=\"space-y-2\">\n                        <Label>客户名称</Label>\n                        <Input value={form.name} onChange={(e) => setForm((p) => ({ ...p, name: e.target.value }))} />\n                    </div>\n                    <div className=\"space-y-2\">\n                        <Label>负责人</Label>\n                        <Select value={form.assigneeId || \"__none__\"} onValueChange={(v) => setForm((p) => ({ ...p, assigneeId: v === \"__none__\" ? \"\" : v }))}>\n                            <SelectTrigger>\n                                <SelectValue placeholder=\"选择负责人\" />\n                            </SelectTrigger>\n                            <SelectContent>\n                                <SelectItem value=\"__none__\">未指定</SelectItem>\n                                {teamMembers.map((m) => (\n                                    <SelectItem key={m.id} value={m.id}>\n                                        {m.name || m.id.slice(0, 6)}\n                                    </SelectItem>\n                                ))}\n                            </SelectContent>\n                        </Select>\n                    </div>\n\n                    <div className=\"space-y-2\">\n                        <Label>邮箱</Label>\n                        <Input value={form.email} onChange={(e) => setForm((p) => ({ ...p, email: e.target.value }))} />\n                    </div>\n                    <div className=\"space-y-2\">\n                        <Label>电话</Label>\n                        <Input value={form.phone} onChange={(e) => setForm((p) => ({ ...p, phone: e.target.value }))} />\n                    </div>\n\n                    <div className=\"space-y-2\">\n                        <Label>行业</Label>\n                        <Input value={form.industry} onChange={(e) => setForm((p) => ({ ...p, industry: e.target.value }))} />\n                    </div>\n                    <div className=\"space-y-2\">\n                        <Label>来源</Label>\n                        <Input value={form.source} onChange={(e) => setForm((p) => ({ ...p, source: e.target.value }))} />\n                    </div>\n\n                    <div className=\"space-y-2 md:col-span-2\">\n                        <Label>地址</Label>\n                        <Input value={form.address} onChange={(e) => setForm((p) => ({ ...p, address: e.target.value }))} />\n                    </div>\n\n                    <div className=\"space-y-2\">\n                        <Label>阶段</Label>\n                        <Select value={form.stage} onValueChange={(v) => setForm((p) => ({ ...p, stage: v }))}>\n                            <SelectTrigger>\n                                <SelectValue placeholder=\"选择阶段\" />\n                            </SelectTrigger>\n                            <SelectContent>\n                                {STAGE_OPTIONS.map((o) => (\n                                    <SelectItem key={o.value} value={o.value}>\n                                        {o.label}\n                                    </SelectItem>\n                                ))}\n                            </SelectContent>\n                        </Select>\n                    </div>\n                    <div className=\"space-y-2\">\n                        <Label>等级</Label>\n                        <Select value={form.grade} onValueChange={(v) => setForm((p) => ({ ...p, grade: v }))}>\n                            <SelectTrigger>\n                                <SelectValue placeholder=\"选择等级\" />\n                            </SelectTrigger>\n                            <SelectContent>\n                                {GRADE_OPTIONS.map((o) => (\n                                    <SelectItem key={o.value} value={o.value}>\n                                        {o.label}\n                                    </SelectItem>\n                                ))}\n                            </SelectContent>\n                        </Select>\n                    </div>\n\n                    <div className=\"space-y-2\">\n                        <Label>下次跟进</Label>\n                        <Input\n                            type=\"date\"\n                            value={form.nextFollowUp}\n                            onChange={(e) => setForm((p) => ({ ...p, nextFollowUp: e.target.value }))}\n                        />\n                    </div>\n\n                    <div className=\"space-y-2 md:col-span-2\">\n                        <Label>备注</Label>\n                        <Textarea\n                            value={form.notes}\n                            onChange={(e) => setForm((p) => ({ ...p, notes: e.target.value }))}\n                            rows={3}\n                        />\n                    </div>\n                </div>\n\n                <DialogFooter>\n                    <Button variant=\"outline\" onClick={() => setOpen(false)} disabled={saving}>\n                        取消\n                    </Button>\n                    <Button\n                        disabled={!canSave || saving}\n                        onClick={async () => {\n                            if (!canSave) return\n                            setSaving(true)\n                            try {\n                                const nextFollowUp = form.nextFollowUp ? new Date(form.nextFollowUp + \"T00:00:00\") : null\n                                const res = await updateCustomer(customer.id, {\n                                    name: form.name.trim(),\n                                    email: form.email.trim() || null,\n                                    phone: form.phone.trim() || null,\n                                    industry: form.industry.trim() || null,\n                                    source: form.source.trim() || null,\n                                    address: form.address.trim() || null,\n                                    notes: form.notes.trim() || null,\n                                    stage: form.stage as any,\n                                    grade: form.grade as any,\n                                    nextFollowUp,\n                                    assigneeId: form.assigneeId || null,\n                                })\n\n                                if (!res.success) {\n                                    toast.error(\"保存失败\", { description: res.error })\n                                    return\n                                }\n                                toast.success(\"已保存\")\n                                setOpen(false)\n                                router.refresh()\n                            } catch (e) {\n                                toast.error(\"保存失败\")\n                            } finally {\n                                setSaving(false)\n                            }\n                        }}\n                    >\n                        {saving ? \"保存中...\" : \"保存\"}\n                    </Button>\n                </DialogFooter>\n            </DialogContent>\n        </Dialog>\n    )\n}\n\n","usedDeprecatedRules":[]},{"filePath":"D:\\Desktop\\LawClick_NEW\\lawclick-next\\src\\components\\crm\\ManageCustomerTagsDialog.tsx","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":55,"column":54,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":55,"endColumn":57,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[2087,2090],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[2087,2090],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":75,"column":53,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":75,"endColumn":56,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[3108,3111],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[3108,3111],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'e' is defined but never used.","line":95,"column":46,"nodeType":null,"messageId":"unusedVar","endLine":95,"endColumn":47},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'e' is defined but never used.","line":131,"column":46,"nodeType":null,"messageId":"unusedVar","endLine":131,"endColumn":47}],"suppressedMessages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":22,"column":18,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":22,"endColumn":21,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[747,750],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[747,750],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}],"suppressions":[{"kind":"directive","justification":""}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":24,"column":14,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":24,"endColumn":17,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[833,836],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[833,836],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}],"suppressions":[{"kind":"directive","justification":""}]}],"errorCount":0,"fatalErrorCount":0,"warningCount":4,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\"\n\nimport { useMemo, useState } from \"react\"\nimport { useRouter } from \"next/navigation\"\nimport { toast } from \"sonner\"\nimport { Tag } from \"lucide-react\"\n\nimport { addTagToCustomer, createTag } from \"@/actions/customer-actions\"\nimport { Badge } from \"@/components/ui/badge\"\nimport { Button } from \"@/components/ui/button\"\nimport { Dialog, DialogContent, DialogFooter, DialogHeader, DialogTitle, DialogTrigger } from \"@/components/ui/dialog\"\nimport { Input } from \"@/components/ui/input\"\nimport { Label } from \"@/components/ui/label\"\n\nexport function ManageCustomerTagsDialog({\n    customerId,\n    currentTags,\n    allTags,\n}: {\n    customerId: string\n    // eslint-disable-next-line @typescript-eslint/no-explicit-any\n    currentTags: any[]\n    // eslint-disable-next-line @typescript-eslint/no-explicit-any\n    allTags: any[]\n}) {\n    const router = useRouter()\n    const [open, setOpen] = useState(false)\n    const [busy, setBusy] = useState(false)\n\n    const currentIds = useMemo(() => new Set((currentTags || []).map((t) => t.id)), [currentTags])\n    const candidates = useMemo(() => (allTags || []).filter((t) => !currentIds.has(t.id)), [allTags, currentIds])\n\n    const [pickId, setPickId] = useState<string>(\"\")\n    const [newName, setNewName] = useState(\"\")\n    const [newColor, setNewColor] = useState(\"#3b82f6\")\n\n    return (\n        <Dialog open={open} onOpenChange={setOpen}>\n            <DialogTrigger asChild>\n                <Button variant=\"outline\">\n                    <Tag className=\"h-4 w-4 mr-2\" />\n                    标签\n                </Button>\n            </DialogTrigger>\n            <DialogContent className=\"sm:max-w-[720px]\">\n                <DialogHeader>\n                    <DialogTitle>客户标签</DialogTitle>\n                </DialogHeader>\n\n                <div className=\"space-y-4\">\n                    <div className=\"space-y-2\">\n                        <Label>已绑定</Label>\n                        {currentTags?.length ? (\n                            <div className=\"flex flex-wrap gap-2\">\n                                {currentTags.map((t: any) => (\n                                    <Badge key={t.id} variant=\"outline\" style={{ borderColor: t.color, color: t.color }}>\n                                        {t.name}\n                                    </Badge>\n                                ))}\n                            </div>\n                        ) : (\n                            <div className=\"text-sm text-muted-foreground\">暂无标签</div>\n                        )}\n                    </div>\n\n                    <div className=\"space-y-2\">\n                        <Label>添加已有标签</Label>\n                        <div className=\"flex gap-2\">\n                            <select\n                                value={pickId}\n                                onChange={(e) => setPickId(e.target.value)}\n                                className=\"h-10 flex-1 rounded-md border bg-background px-3 text-sm\"\n                            >\n                                <option value=\"\">请选择标签</option>\n                                {candidates.map((t: any) => (\n                                    <option key={t.id} value={t.id}>\n                                        {t.name}\n                                    </option>\n                                ))}\n                            </select>\n                            <Button\n                                disabled={!pickId || busy}\n                                onClick={async () => {\n                                    if (!pickId) return\n                                    setBusy(true)\n                                    try {\n                                        const res = await addTagToCustomer(customerId, pickId)\n                                        if (!res.success) {\n                                            toast.error(\"添加失败\", { description: res.error })\n                                            return\n                                        }\n                                        toast.success(\"已添加标签\")\n                                        setPickId(\"\")\n                                        router.refresh()\n                                    } catch (e) {\n                                        toast.error(\"添加失败\")\n                                    } finally {\n                                        setBusy(false)\n                                    }\n                                }}\n                            >\n                                添加\n                            </Button>\n                        </div>\n                    </div>\n\n                    <div className=\"space-y-2\">\n                        <Label>创建新标签</Label>\n                        <div className=\"grid grid-cols-1 md:grid-cols-3 gap-2\">\n                            <Input value={newName} onChange={(e) => setNewName(e.target.value)} placeholder=\"标签名\" />\n                            <Input value={newColor} onChange={(e) => setNewColor(e.target.value)} placeholder=\"#3b82f6\" />\n                            <Button\n                                disabled={busy || newName.trim().length < 2}\n                                onClick={async () => {\n                                    if (newName.trim().length < 2) return\n                                    setBusy(true)\n                                    try {\n                                        const created = await createTag(newName.trim(), newColor.trim() || undefined)\n                                        if (!created.success || !created.data) {\n                                            toast.error(\"创建失败\", { description: created.error })\n                                            return\n                                        }\n                                        const linked = await addTagToCustomer(customerId, created.data.id)\n                                        if (!linked.success) {\n                                            toast.error(\"绑定失败\", { description: linked.error })\n                                            return\n                                        }\n                                        toast.success(\"已创建并绑定\")\n                                        setNewName(\"\")\n                                        router.refresh()\n                                    } catch (e) {\n                                        toast.error(\"创建失败\")\n                                    } finally {\n                                        setBusy(false)\n                                    }\n                                }}\n                            >\n                                创建并绑定\n                            </Button>\n                        </div>\n                        <div className=\"text-xs text-muted-foreground\">当前版本仅支持添加标签（不做移除/排序）。</div>\n                    </div>\n                </div>\n\n                <DialogFooter>\n                    <Button variant=\"outline\" onClick={() => setOpen(false)} disabled={busy}>\n                        关闭\n                    </Button>\n                </DialogFooter>\n            </DialogContent>\n        </Dialog>\n    )\n}\n\n","usedDeprecatedRules":[]},{"filePath":"D:\\Desktop\\LawClick_NEW\\lawclick-next\\src\\components\\dashboard\\AddTaskDialog.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\Desktop\\LawClick_NEW\\lawclick-next\\src\\components\\dashboard\\DashboardWorkspaceClient.tsx","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":52,"column":64,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":52,"endColumn":67,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1991,1994],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1991,1994],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":58,"column":77,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":58,"endColumn":80,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[2301,2304],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[2301,2304],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":64,"column":50,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":64,"endColumn":53,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[2501,2504],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[2501,2504],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":92,"column":96,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":92,"endColumn":99,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[3537,3540],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[3537,3540],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":93,"column":14,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":93,"endColumn":17,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[3555,3558],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[3555,3558],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":111,"column":35,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":111,"endColumn":38,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[4083,4086],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[4083,4086],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'e' is defined but never used.","line":121,"column":18,"nodeType":null,"messageId":"unusedVar","endLine":121,"endColumn":19},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":136,"column":42,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":136,"endColumn":45,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[4876,4879],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[4876,4879],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'e' is defined but never used.","line":138,"column":18,"nodeType":null,"messageId":"unusedVar","endLine":138,"endColumn":19},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":231,"column":35,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":231,"endColumn":38,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[9321,9324],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[9321,9324],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":10,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\"\n\nimport { useEffect, useMemo, useState } from \"react\"\nimport { useRouter } from \"next/navigation\"\nimport { toast } from \"sonner\"\nimport ReactGridLayout, { WidthProvider, type Layout } from \"react-grid-layout/legacy\"\nimport { saveMyDashboardConfig, resetMyDashboardConfig } from \"@/actions/dashboard-layout\"\nimport type { DashboardConfig, DashboardWidgetType } from \"@/lib/dashboard/types\"\nimport { getDashboardWidgetDefaultSize } from \"@/lib/dashboard-widgets\"\nimport { Button } from \"@/components/ui/button\"\nimport { Card } from \"@/components/ui/card\"\nimport { DropdownMenu, DropdownMenuContent, DropdownMenuItem, DropdownMenuTrigger } from \"@/components/ui/dropdown-menu\"\nimport { cn } from \"@/lib/utils\"\nimport { GripVertical, LayoutGrid, Plus, Save, Settings2, Trash2 } from \"lucide-react\"\nimport { useSidebar } from \"@/components/ui/sidebar\"\n\nconst RGL = WidthProvider(ReactGridLayout)\n\ntype WidgetCatalogItem = {\n    id: string\n    type: DashboardWidgetType\n    title: string\n    content: React.ReactNode\n}\n\nfunction findNextY(layout: Layout) {\n    if (!layout.length) return 0\n    return layout.reduce((max, item) => Math.max(max, item.y + item.h), 0)\n}\n\nexport function DashboardWorkspaceClient({\n    dashboardKey = \"default\",\n    initialConfig,\n    catalog,\n}: {\n    dashboardKey?: string\n    initialConfig: DashboardConfig\n    catalog: WidgetCatalogItem[]\n}) {\n    const router = useRouter()\n    const { state: sidebarState } = useSidebar()\n\n    const catalogById = useMemo(() => {\n        return new Map(catalog.map((c) => [c.id, c]))\n    }, [catalog])\n\n    const sanitizedInitial = useMemo(() => {\n        const allowedIds = new Set(catalog.map((c) => c.id))\n        const widgets = (initialConfig.widgets || []).filter((w) => allowedIds.has(w.id))\n        const dedupWidgets = Array.from(new Map(widgets.map((w) => [w.id, w])).values())\n        const widgetIds = new Set(dedupWidgets.map((w) => w.id))\n        const layout = (initialConfig.layout || []).filter((l: any) => widgetIds.has(l.i))\n        return { widgets: dedupWidgets, layout }\n    }, [initialConfig, catalog])\n\n    const [isEditing, setIsEditing] = useState(false)\n    const [widgets, setWidgets] = useState(sanitizedInitial.widgets)\n    const [layout, setLayout] = useState<Layout>(sanitizedInitial.layout as any)\n    const [saving, setSaving] = useState(false)\n\n    useEffect(() => {\n        if (!isEditing) {\n            setWidgets(sanitizedInitial.widgets)\n            setLayout(sanitizedInitial.layout as any)\n        }\n    }, [sanitizedInitial, isEditing])\n\n    // Sidebar 折叠/展开会改变容器宽度，但不会触发 window.resize；这里主动触发布局重算\n    useEffect(() => {\n        const t = setTimeout(() => {\n            window.dispatchEvent(new Event(\"resize\"))\n        }, 240)\n        return () => clearTimeout(t)\n    }, [sidebarState])\n\n    const activeWidgetIds = useMemo(() => new Set(widgets.map(w => w.id)), [widgets])\n    const availableToAdd = useMemo(() => catalog.filter(c => !activeWidgetIds.has(c.id)), [catalog, activeWidgetIds])\n\n    const handleLayoutChange = (nextLayout: Layout) => {\n        setLayout(nextLayout)\n    }\n\n    const handleAddWidget = (id: string) => {\n        const item = catalogById.get(id)\n        if (!item) return\n\n        const nextWidgets = [...widgets, { id: item.id, type: item.type }]\n        const y = findNextY(layout)\n        const size = getDashboardWidgetDefaultSize(item.type)\n        const nextLayout = [\n            ...layout,\n            { i: item.id, x: 0, y, w: size.w, h: size.h, minW: size.minW, minH: size.minH } as any,\n        ] as any\n\n        setWidgets(nextWidgets)\n        setLayout(nextLayout)\n        toast.success(\"组件已添加（记得保存布局）\")\n    }\n\n    const handleRemoveWidget = (id: string) => {\n        setWidgets(prev => prev.filter(w => w.id !== id))\n        setLayout(prev => prev.filter(l => l.i !== id))\n    }\n\n    const handleSave = async () => {\n        setSaving(true)\n        try {\n            const config: DashboardConfig = {\n                configVersion: initialConfig.configVersion || 1,\n                widgets,\n                layout: layout as any,\n            }\n            const res = await saveMyDashboardConfig({ dashboardKey, config })\n            if (!res.success) {\n                toast.error(\"保存失败\", { description: res.error })\n                return\n            }\n            toast.success(\"布局已保存\")\n            setIsEditing(false)\n            router.refresh()\n        } catch (e) {\n            toast.error(\"保存失败\")\n        } finally {\n            setSaving(false)\n        }\n    }\n\n    const handleReset = async () => {\n        try {\n            const res = await resetMyDashboardConfig(dashboardKey)\n            if (!res.success || !res.data) {\n                toast.error(\"重置失败\", { description: res.error })\n                return\n            }\n            setWidgets(res.data.widgets)\n            setLayout(res.data.layout as any)\n            toast.success(\"已重置为默认布局（记得保存）\")\n        } catch (e) {\n            toast.error(\"重置失败\")\n        }\n    }\n\n    const gridItems = widgets\n        .map((w) => {\n            const meta = catalogById.get(w.id)\n            if (!meta) return null\n            return (\n                <div key={w.id} className=\"h-full\">\n                    <Card\n                        className={cn(\n                            \"h-full flex flex-col overflow-hidden border-border/60 bg-white/80\",\n                            isEditing && \"ring-1 ring-orange-200 shadow-sm\"\n                        )}\n                    >\n                        <div className=\"flex items-center justify-between px-3 py-2 border-b bg-muted/40\">\n                            <div className=\"flex items-center gap-2 min-w-0\">\n                                <GripVertical className=\"h-4 w-4 text-muted-foreground dashboard-widget-drag-handle cursor-grab active:cursor-grabbing\" />\n                                <span className=\"text-sm font-medium truncate\">{meta.title}</span>\n                            </div>\n                            {isEditing && (\n                                <Button\n                                    variant=\"ghost\"\n                                    size=\"icon-sm\"\n                                    className=\"h-7 w-7 hover:bg-red-50 hover:text-red-600\"\n                                    onClick={() => handleRemoveWidget(w.id)}\n                                    title=\"移除组件\"\n                                >\n                                    <Trash2 className=\"h-4 w-4\" />\n                                </Button>\n                            )}\n                        </div>\n                        <div className=\"flex-1 min-h-0 overflow-auto p-3\">{meta.content}</div>\n                    </Card>\n                </div>\n            )\n        })\n        .filter(Boolean)\n\n    return (\n        <div className=\"space-y-4\">\n            <div className=\"flex items-center justify-between gap-2\">\n                <div className=\"flex items-center gap-2\">\n                    <LayoutGrid className=\"h-5 w-5 text-orange-500\" />\n                    <h1 className=\"text-xl font-bold tracking-tight\">仪表盘工作台</h1>\n                </div>\n                <div className=\"flex items-center gap-2\">\n                    <Button variant={isEditing ? \"default\" : \"outline\"} onClick={() => setIsEditing(v => !v)}>\n                        <Settings2 className=\"h-4 w-4 mr-2\" />\n                        {isEditing ? \"退出编辑\" : \"编辑布局\"}\n                    </Button>\n                    <DropdownMenu>\n                        <DropdownMenuTrigger asChild>\n                            <Button variant=\"outline\" disabled={!isEditing || availableToAdd.length === 0}>\n                                <Plus className=\"h-4 w-4 mr-2\" />\n                                添加组件\n                            </Button>\n                        </DropdownMenuTrigger>\n                        <DropdownMenuContent align=\"end\">\n                            {availableToAdd.map((w) => (\n                                <DropdownMenuItem key={w.id} onClick={() => handleAddWidget(w.id)}>\n                                    {w.title}\n                                </DropdownMenuItem>\n                            ))}\n                        </DropdownMenuContent>\n                    </DropdownMenu>\n                    <Button onClick={handleSave} disabled={!isEditing || saving}>\n                        <Save className=\"h-4 w-4 mr-2\" />\n                        {saving ? \"保存中...\" : \"保存布局\"}\n                    </Button>\n                    <Button variant=\"ghost\" onClick={handleReset} disabled={!isEditing}>\n                        重置\n                    </Button>\n                </div>\n            </div>\n\n            <div className=\"rounded-xl border bg-background/60 p-2\">\n                <RGL\n                    className=\"layout\"\n                    layout={layout}\n                    cols={12}\n                    rowHeight={28}\n                    margin={[12, 12]}\n                    containerPadding={[0, 0]}\n                    compactType=\"vertical\"\n                    isDraggable={isEditing}\n                    isResizable={isEditing}\n                    draggableHandle=\".dashboard-widget-drag-handle\"\n                    onLayoutChange={handleLayoutChange}\n                    useCSSTransforms\n                >\n                    {gridItems as any}\n                </RGL>\n            </div>\n        </div>\n    )\n}\n","usedDeprecatedRules":[]},{"filePath":"D:\\Desktop\\LawClick_NEW\\lawclick-next\\src\\components\\dashboard\\dashboard-view-switcher.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'view' is assigned a value but never used.","line":15,"column":12,"nodeType":null,"messageId":"unusedVar","endLine":15,"endColumn":16}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\"\r\n\r\nimport { useState } from \"react\"\r\nimport { Tabs, TabsContent, TabsList, TabsTrigger } from \"@/components/ui/tabs\"\r\nimport { LayoutGrid, Kanban, Briefcase } from \"lucide-react\"\r\nimport { FirmOverview } from \"@/components/dashboard/firm-overview\"\r\n\r\n// Types\r\ninterface DashboardClientProps {\r\n    children: React.ReactNode // Default KPI/Cards View\r\n    kanbanView: React.ReactNode // CaseKanban Component\r\n}\r\n\r\nexport function DashboardViewSwitcher({ children, kanbanView }: DashboardClientProps) {\r\n    const [view, setView] = useState('overview')\r\n\r\n    return (\r\n        <Tabs defaultValue=\"overview\" className=\"space-y-4\" onValueChange={setView}>\r\n            <div className=\"flex items-center justify-between\">\r\n                <TabsList>\r\n                    <TabsTrigger value=\"overview\" className=\"flex items-center gap-2\">\r\n                        <LayoutGrid className=\"h-4 w-4\" />\r\n                        概览\r\n                    </TabsTrigger>\r\n                    <TabsTrigger value=\"kanban\" className=\"flex items-center gap-2\">\r\n                        <Kanban className=\"h-4 w-4\" />\r\n                        案件看板\r\n                    </TabsTrigger>\r\n                    <TabsTrigger value=\"firm\" className=\"flex items-center gap-2\">\r\n                        <Briefcase className=\"h-4 w-4\" />\r\n                        律所管理\r\n                    </TabsTrigger>\r\n                </TabsList>\r\n            </div>\r\n\r\n            <TabsContent value=\"overview\" className=\"space-y-4 animate-in fade-in-50 duration-300\">\r\n                {children}\r\n            </TabsContent>\r\n\r\n            <TabsContent value=\"kanban\" className=\"animate-in fade-in-50 duration-300\">\r\n                {kanbanView}\r\n            </TabsContent>\r\n\r\n            <TabsContent value=\"firm\" className=\"animate-in fade-in-50 duration-300\">\r\n                <FirmOverview />\r\n            </TabsContent>\r\n        </Tabs>\r\n    )\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"D:\\Desktop\\LawClick_NEW\\lawclick-next\\src\\components\\dashboard\\firm-overview.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\Desktop\\LawClick_NEW\\lawclick-next\\src\\components\\dashboard\\widgets\\MyTasksWidget.tsx","messages":[],"suppressedMessages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":25,"column":12,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":25,"endColumn":15,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[824,827],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[824,827],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}],"suppressions":[{"kind":"directive","justification":""}]}],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\Desktop\\LawClick_NEW\\lawclick-next\\src\\components\\dashboard\\widgets\\OpenTimerWindowButton.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\Desktop\\LawClick_NEW\\lawclick-next\\src\\components\\dashboard\\widgets\\TimeSummaryWidget.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\Desktop\\LawClick_NEW\\lawclick-next\\src\\components\\dashboard\\widgets\\UpcomingEventsWidget.tsx","messages":[],"suppressedMessages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":9,"column":13,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":9,"endColumn":16,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[257,260],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[257,260],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}],"suppressions":[{"kind":"directive","justification":""}]}],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\Desktop\\LawClick_NEW\\lawclick-next\\src\\components\\dispatch\\DispatchScheduleBoardClient.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\Desktop\\LawClick_NEW\\lawclick-next\\src\\components\\dispatch\\PendingInvitesPanel.tsx","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":19,"column":14,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":19,"endColumn":17,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[650,653],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[650,653],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\"\n\nimport * as React from \"react\"\nimport { toast } from \"sonner\"\nimport { useRouter } from \"next/navigation\"\nimport { Bell, CheckCircle2, XCircle } from \"lucide-react\"\n\nimport { respondToInvite } from \"@/actions/collaboration-actions\"\nimport { Badge } from \"@/components/ui/badge\"\nimport { Button } from \"@/components/ui/button\"\nimport { Card, CardContent } from \"@/components/ui/card\"\n\ntype Invite = {\n    id: string\n    type: \"CASE\" | \"TASK\" | \"MEETING\"\n    status: \"PENDING\" | \"ACCEPTED\" | \"REJECTED\" | \"EXPIRED\"\n    message?: string | null\n    sender?: { id: string; name: string | null; avatarUrl: string | null } | null\n    target?: any\n}\n\nfunction formatInviteTitle(invite: Invite) {\n    if (invite.type === \"MEETING\") return \"会议\"\n    if (invite.type === \"TASK\") return \"任务\"\n    if (invite.type === \"CASE\") return \"案件\"\n    return \"协作\"\n}\n\nexport function PendingInvitesPanel({ invites }: { invites: Invite[] }) {\n    const router = useRouter()\n    const [busyId, setBusyId] = React.useState<string | null>(null)\n\n    const pendingInvites = invites.filter((i) => i.status === \"PENDING\")\n    if (pendingInvites.length === 0) return null\n\n    const handle = async (inviteId: string, accept: boolean) => {\n        setBusyId(inviteId)\n        try {\n            const res = await respondToInvite(inviteId, accept)\n            if (!res.success) {\n                toast.error(\"操作失败\", { description: res.error })\n                return\n            }\n            toast.success(accept ? \"已接受邀请\" : \"已拒绝邀请\")\n            router.refresh()\n        } finally {\n            setBusyId(null)\n        }\n    }\n\n    return (\n        <section>\n            <div className=\"flex items-center justify-between mb-3\">\n                <h2 className=\"text-lg font-semibold flex items-center gap-2\">\n                    <Bell className=\"h-4 w-4\" />\n                    待处理的协作邀请\n                </h2>\n                <Badge variant=\"secondary\" className=\"bg-orange-500/10 text-orange-500\">\n                    {pendingInvites.length} 待处理\n                </Badge>\n            </div>\n\n            <div className=\"grid gap-2\">\n                {pendingInvites.slice(0, 6).map((invite) => {\n                    const targetTitle = invite.target?.title\n                    const targetTime =\n                        invite.type === \"MEETING\" && invite.target?.startTime\n                            ? `${new Date(invite.target.startTime).toLocaleString(\"zh-CN\", { hour: \"2-digit\", minute: \"2-digit\" })}`\n                            : null\n\n                    return (\n                        <Card key={invite.id} className=\"bg-card/50\">\n                            <CardContent className=\"p-4 flex items-center justify-between gap-3\">\n                                <div className=\"min-w-0\">\n                                    <p className=\"font-medium truncate\">\n                                        {invite.sender?.name || \"未知\"} 邀请您加入{formatInviteTitle(invite)}\n                                        {targetTitle ? `：${targetTitle}` : \"\"}\n                                    </p>\n                                    {targetTime ? <p className=\"text-sm text-muted-foreground\">{targetTime}</p> : null}\n                                    {invite.message ? <p className=\"text-sm text-muted-foreground\">{invite.message}</p> : null}\n                                </div>\n                                <div className=\"flex gap-2 shrink-0\">\n                                    <Button\n                                        size=\"sm\"\n                                        variant=\"outline\"\n                                        className=\"gap-1 hover:bg-green-500/10 hover:text-green-600\"\n                                        disabled={busyId === invite.id}\n                                        onClick={() => handle(invite.id, true)}\n                                    >\n                                        <CheckCircle2 className=\"h-4 w-4\" /> 接受\n                                    </Button>\n                                    <Button\n                                        size=\"sm\"\n                                        variant=\"outline\"\n                                        className=\"gap-1 hover:bg-red-500/10 hover:text-red-600\"\n                                        disabled={busyId === invite.id}\n                                        onClick={() => handle(invite.id, false)}\n                                    >\n                                        <XCircle className=\"h-4 w-4\" /> 拒绝\n                                    </Button>\n                                </div>\n                            </CardContent>\n                        </Card>\n                    )\n                })}\n            </div>\n        </section>\n    )\n}\n\n","usedDeprecatedRules":[]},{"filePath":"D:\\Desktop\\LawClick_NEW\\lawclick-next\\src\\components\\documents\\DocumentAIReviewClient.tsx","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":59,"column":36,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":59,"endColumn":39,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[2167,2170],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[2167,2170],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has a missing dependency: 'refreshHistory'. Either include it or remove the dependency array.","line":67,"column":8,"nodeType":"ArrayExpression","endLine":67,"endColumn":21,"suggestions":[{"desc":"Update the dependencies array to be: [document.id, refreshHistory]","fix":{"range":[2300,2313],"text":"[document.id, refreshHistory]"}}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":151,"column":105,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":151,"endColumn":108,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[5984,5987],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[5984,5987],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":166,"column":107,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":166,"endColumn":110,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[6925,6928],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[6925,6928],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":4,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\"\n\nimport { useEffect, useState, useTransition } from \"react\"\nimport Link from \"next/link\"\nimport { useRouter } from \"next/navigation\"\nimport { toast } from \"sonner\"\nimport { ArrowLeft, Copy, Sparkles } from \"lucide-react\"\n\nimport { Button } from \"@/components/ui/button\"\nimport { Card, CardContent, CardHeader, CardTitle } from \"@/components/ui/card\"\nimport { Badge } from \"@/components/ui/badge\"\nimport { Label } from \"@/components/ui/label\"\nimport { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from \"@/components/ui/select\"\nimport { Switch } from \"@/components/ui/switch\"\nimport { Textarea } from \"@/components/ui/textarea\"\nimport { ScrollArea } from \"@/components/ui/scroll-area\"\n\nimport { analyzeDocumentById, getDocumentAIInvocations } from \"@/actions/ai-actions\"\n\ntype DocumentAIReviewDoc = {\n    id: string\n    title: string\n    version: number\n    notes?: string | null\n    summary?: string | null\n    case: { id: string; title: string; caseCode?: string | null }\n}\n\ntype InvocationItem = {\n    id: string\n    createdAt: Date | string\n    status: \"SUCCESS\" | \"ERROR\"\n    error: string | null\n    provider: string\n    model: string\n    response: string | null\n}\n\nexport function DocumentAIReviewClient({ document }: { document: DocumentAIReviewDoc }) {\n    const router = useRouter()\n    const [analysisType, setAnalysisType] = useState<\"summary\" | \"keypoints\" | \"risks\" | \"timeline\">(\"risks\")\n    const [contentSource, setContentSource] = useState<\"notes\" | \"pasted\">(\"notes\")\n    const [pastedText, setPastedText] = useState(\"\")\n    const [writeSummaryBack, setWriteSummaryBack] = useState(true)\n\n    const [result, setResult] = useState<string>(\"\")\n    const [history, setHistory] = useState<InvocationItem[]>([])\n    const [loadingHistory, setLoadingHistory] = useState(true)\n    const [isPending, startTransition] = useTransition()\n\n    const refreshHistory = async () => {\n        setLoadingHistory(true)\n        try {\n            const res = await getDocumentAIInvocations(document.id)\n            if (!res.success) {\n                setHistory([])\n                return\n            }\n            setHistory(res.data as any)\n        } finally {\n            setLoadingHistory(false)\n        }\n    }\n\n    useEffect(() => {\n        refreshHistory()\n    }, [document.id])\n\n    const contentPreview =\n        contentSource === \"notes\" ? (document.notes || \"\").trim() : pastedText.trim()\n\n    const handleAnalyze = () => {\n        startTransition(async () => {\n            const res = await analyzeDocumentById({\n                documentId: document.id,\n                analysisType,\n                contentSource,\n                pastedText: contentSource === \"pasted\" ? pastedText : undefined,\n                writeSummaryBack,\n            })\n\n            if (!res.success) {\n                toast.error(\"AI 审查失败\", { description: res.error || \"请稍后重试\" })\n                return\n            }\n\n            setResult(res.result || \"\")\n            toast.success(\"已生成 AI 审查结果\", {\n                description: res.wroteBackSummary ? \"已写回文档摘要（Document.summary）\" : undefined,\n            })\n            await refreshHistory()\n        })\n    }\n\n    const handleCopy = async () => {\n        try {\n            await navigator.clipboard.writeText(result || \"\")\n            toast.success(\"已复制到剪贴板\")\n        } catch {\n            toast.error(\"复制失败\")\n        }\n    }\n\n    return (\n        <div className=\"space-y-6\">\n            <div className=\"flex items-center justify-between gap-3\">\n                <div className=\"flex items-center gap-3 min-w-0\">\n                    <Button variant=\"ghost\" size=\"icon\" onClick={() => router.back()}>\n                        <ArrowLeft className=\"h-4 w-4\" />\n                    </Button>\n                    <div className=\"min-w-0\">\n                        <div className=\"text-sm text-muted-foreground\">\n                            <Link href=\"/documents\" className=\"hover:underline\">\n                                文档中心\n                            </Link>\n                            <span className=\"mx-2\">/</span>\n                            <Link href={`/documents/${document.id}`} className=\"hover:underline\">\n                                文档详情\n                            </Link>\n                        </div>\n                        <div className=\"flex items-center gap-2 min-w-0\">\n                            <h1 className=\"text-xl font-bold truncate\">AI 审查：{document.title}</h1>\n                            <Badge variant=\"secondary\">v{document.version || 1}</Badge>\n                        </div>\n                    </div>\n                </div>\n                <Button variant=\"outline\" onClick={() => router.push(`/cases/${document.case.id}`)}>\n                    进入案件\n                </Button>\n            </div>\n\n            <div className=\"grid grid-cols-1 lg:grid-cols-2 gap-6\">\n                <Card>\n                    <CardHeader className=\"pb-3\">\n                        <CardTitle className=\"text-base flex items-center gap-2\">\n                            <Sparkles className=\"h-4 w-4 text-orange-500\" /> 审查输入\n                        </CardTitle>\n                    </CardHeader>\n                    <CardContent className=\"space-y-4\">\n                        <div className=\"flex items-center gap-2 text-xs text-muted-foreground\">\n                            <span>案件：</span>\n                            <Link href={`/cases/${document.case.id}`} className=\"hover:underline\">\n                                {document.case.caseCode ? `${document.case.caseCode}｜` : \"\"}\n                                {document.case.title}\n                            </Link>\n                        </div>\n\n                        <div className=\"grid grid-cols-1 md:grid-cols-2 gap-4\">\n                            <div className=\"grid gap-2\">\n                                <Label>分析类型</Label>\n                                <Select value={analysisType} onValueChange={(v) => setAnalysisType(v as any)}>\n                                    <SelectTrigger>\n                                        <SelectValue />\n                                    </SelectTrigger>\n                                    <SelectContent>\n                                        <SelectItem value=\"summary\">总结（summary）</SelectItem>\n                                        <SelectItem value=\"keypoints\">要点（keypoints）</SelectItem>\n                                        <SelectItem value=\"risks\">风险（risks）</SelectItem>\n                                        <SelectItem value=\"timeline\">时间线（timeline）</SelectItem>\n                                    </SelectContent>\n                                </Select>\n                            </div>\n\n                            <div className=\"grid gap-2\">\n                                <Label>内容来源</Label>\n                                <Select value={contentSource} onValueChange={(v) => setContentSource(v as any)}>\n                                    <SelectTrigger>\n                                        <SelectValue />\n                                    </SelectTrigger>\n                                    <SelectContent>\n                                        <SelectItem value=\"notes\">文档备注（notes）</SelectItem>\n                                        <SelectItem value=\"pasted\">粘贴文本（pasted）</SelectItem>\n                                    </SelectContent>\n                                </Select>\n                            </div>\n                        </div>\n\n                        {analysisType === \"summary\" && (\n                            <div className=\"flex items-center justify-between rounded-lg border p-3\">\n                                <div>\n                                    <div className=\"text-sm font-medium\">写回文档摘要</div>\n                                    <div className=\"text-xs text-muted-foreground\">将 summary 写入 `Document.summary`，便于后续复盘与检索。</div>\n                                </div>\n                                <Switch checked={writeSummaryBack} onCheckedChange={setWriteSummaryBack} />\n                            </div>\n                        )}\n\n                        <div className=\"grid gap-2\">\n                            <Label>待审查内容</Label>\n                            {contentSource === \"notes\" ? (\n                                <Textarea value={(document.notes || \"\").trim()} readOnly rows={10} />\n                            ) : (\n                                <Textarea\n                                    value={pastedText}\n                                    onChange={(e) => setPastedText(e.target.value)}\n                                    placeholder=\"请粘贴待审查的合同/文书内容（MVP：不做文件全文抽取）\"\n                                    rows={10}\n                                />\n                            )}\n                            <div className=\"text-[11px] text-muted-foreground\">\n                                当前内容长度：{contentPreview.length} 字（最多取前 10000 字参与分析）\n                            </div>\n                        </div>\n\n                        <Button onClick={handleAnalyze} disabled={isPending || contentPreview.length === 0} className=\"w-full\">\n                            {isPending ? \"分析中...\" : \"生成 AI 审查结果\"}\n                        </Button>\n                    </CardContent>\n                </Card>\n\n                <div className=\"space-y-6\">\n                    <Card>\n                        <CardHeader className=\"pb-3\">\n                            <CardTitle className=\"text-base flex items-center justify-between gap-3\">\n                                <span className=\"flex items-center gap-2\">\n                                    <Sparkles className=\"h-4 w-4 text-orange-500\" /> 输出结果\n                                </span>\n                                <div className=\"flex items-center gap-2\">\n                                    <Button variant=\"outline\" size=\"sm\" onClick={handleCopy} disabled={!result}>\n                                        <Copy className=\"h-4 w-4 mr-2\" /> 复制\n                                    </Button>\n                                </div>\n                            </CardTitle>\n                        </CardHeader>\n                        <CardContent>\n                            {result ? (\n                                <ScrollArea className=\"h-[320px] rounded-lg border bg-muted/30 p-3\">\n                                    <pre className=\"whitespace-pre-wrap text-sm leading-relaxed\">{result}</pre>\n                                </ScrollArea>\n                            ) : (\n                                <div className=\"text-sm text-muted-foreground\">尚未生成结果</div>\n                            )}\n                        </CardContent>\n                    </Card>\n\n                    <Card>\n                        <CardHeader className=\"pb-3\">\n                            <CardTitle className=\"text-base\">审计记录（最近 20 次）</CardTitle>\n                        </CardHeader>\n                        <CardContent className=\"space-y-2\">\n                            {loadingHistory ? (\n                                <div className=\"text-sm text-muted-foreground\">加载中...</div>\n                            ) : history.length === 0 ? (\n                                <div className=\"text-sm text-muted-foreground\">暂无记录</div>\n                            ) : (\n                                history.map((h) => (\n                                    <button\n                                        key={h.id}\n                                        type=\"button\"\n                                        className=\"w-full text-left rounded-lg border p-3 hover:bg-muted/30 transition-colors\"\n                                        onClick={() => setResult(h.response || \"\")}\n                                    >\n                                        <div className=\"flex items-center justify-between gap-3\">\n                                            <div className=\"flex items-center gap-2\">\n                                                <Badge variant={h.status === \"SUCCESS\" ? \"secondary\" : \"destructive\"}>\n                                                    {h.status}\n                                                </Badge>\n                                                <span className=\"text-xs text-muted-foreground\">\n                                                    {new Date(h.createdAt).toLocaleString(\"zh-CN\")}\n                                                </span>\n                                            </div>\n                                            <span className=\"text-[10px] text-muted-foreground\">\n                                                {h.provider} / {h.model}\n                                            </span>\n                                        </div>\n                                        {h.error && <div className=\"text-xs text-red-600 mt-2\">{h.error}</div>}\n                                        {h.response && (\n                                            <div className=\"text-xs text-muted-foreground mt-2 line-clamp-2\">\n                                                {h.response}\n                                            </div>\n                                        )}\n                                    </button>\n                                ))\n                            )}\n                        </CardContent>\n                    </Card>\n                </div>\n            </div>\n        </div>\n    )\n}\n\n","usedDeprecatedRules":[]},{"filePath":"D:\\Desktop\\LawClick_NEW\\lawclick-next\\src\\components\\documents\\DocumentDetailClient.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'e' is defined but never used.","line":104,"column":18,"nodeType":null,"messageId":"unusedVar","endLine":104,"endColumn":19},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'e' is defined but never used.","line":119,"column":18,"nodeType":null,"messageId":"unusedVar","endLine":119,"endColumn":19},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'e' is defined but never used.","line":135,"column":18,"nodeType":null,"messageId":"unusedVar","endLine":135,"endColumn":19}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":3,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\"\n\nimport Link from \"next/link\"\nimport { useRouter } from \"next/navigation\"\nimport { useState } from \"react\"\nimport { toast } from \"sonner\"\nimport { uploadDocument, updateDocument, toggleDocumentFavorite } from \"@/actions/documents\"\nimport { Badge } from \"@/components/ui/badge\"\nimport { Button } from \"@/components/ui/button\"\nimport { Card, CardContent, CardHeader, CardTitle } from \"@/components/ui/card\"\nimport { Dialog, DialogContent, DialogFooter, DialogHeader, DialogTitle, DialogTrigger } from \"@/components/ui/dialog\"\nimport { Input } from \"@/components/ui/input\"\nimport { Label } from \"@/components/ui/label\"\nimport { Separator } from \"@/components/ui/separator\"\nimport { Textarea } from \"@/components/ui/textarea\"\nimport { ArrowLeft, Bot, Download, Eye, GitBranch, Star, Upload } from \"lucide-react\"\nimport { useFloatStore } from \"@/store/float-store\"\n\ntype DocumentVersionItem = {\n    id: string\n    version: number\n    fileKey: string\n    fileType: string\n    fileSize: number\n    createdAt: Date | string\n    uploader?: { id: string; name: string | null } | null\n}\n\ntype DocumentDetail = {\n    id: string\n    title: string\n    fileUrl: string\n    fileType: string\n    fileSize: number\n    version: number\n    category?: string | null\n    tags?: string[]\n    notes?: string | null\n    isFavorite?: boolean\n    isConfidential?: boolean\n    updatedAt: Date | string\n    case: { id: string; title: string; caseCode?: string | null }\n    uploader?: { id: string; name: string | null } | null\n    versions: DocumentVersionItem[]\n}\n\nexport function DocumentDetailClient({ document }: { document: DocumentDetail }) {\n    const router = useRouter()\n    const { openWindow } = useFloatStore()\n    const [title, setTitle] = useState(document.title)\n    const [notes, setNotes] = useState(document.notes || \"\")\n    const [saving, setSaving] = useState(false)\n    const [uploading, setUploading] = useState(false)\n    const [uploadOpen, setUploadOpen] = useState(false)\n\n    const formatSize = (bytes: number) => {\n        if (bytes === 0) return \"0 B\"\n        const k = 1024\n        const sizes = [\"B\", \"KB\", \"MB\", \"GB\"]\n        const i = Math.floor(Math.log(bytes) / Math.log(k))\n        return `${parseFloat((bytes / Math.pow(k, i)).toFixed(1))} ${sizes[i]}`\n    }\n\n    const formatFileTypeLabel = (fileType: string) => {\n        if (!fileType) return \"UNKNOWN\"\n        const normalized = fileType.includes(\"/\") ? (fileType.split(\"/\").pop() || fileType) : fileType\n        return normalized.toUpperCase()\n    }\n\n    const buildFileUrl = (opts?: { versionId?: string; download?: boolean }) => {\n        const params = new URLSearchParams()\n        if (opts?.versionId) params.set(\"versionId\", opts.versionId)\n        if (opts?.download) params.set(\"download\", \"1\")\n        const qs = params.toString()\n        return qs ? `/api/documents/${document.id}/file?${qs}` : `/api/documents/${document.id}/file`\n    }\n\n    const handlePreviewLatest = () => {\n        if (!document.fileUrl) {\n            toast.error(\"该文档尚未上传文件\")\n            return\n        }\n        window.open(buildFileUrl(), \"_blank\", \"noopener,noreferrer\")\n    }\n\n    const handleDownloadLatest = () => {\n        if (!document.fileUrl) {\n            toast.error(\"该文档尚未上传文件\")\n            return\n        }\n        window.open(buildFileUrl({ download: true }), \"_blank\", \"noopener,noreferrer\")\n    }\n\n    const handleSave = async () => {\n        setSaving(true)\n        try {\n            const res = await updateDocument(document.id, { title, notes })\n            if (!res.success) {\n                toast.error(\"保存失败\", { description: res.error })\n                return\n            }\n            toast.success(\"已保存\")\n            router.refresh()\n        } catch (e) {\n            toast.error(\"保存失败\")\n        } finally {\n            setSaving(false)\n        }\n    }\n\n    const handleToggleFavorite = async () => {\n        try {\n            const res = await toggleDocumentFavorite(document.id)\n            if (!res.success) {\n                toast.error(\"更新收藏失败\", { description: res.error })\n                return\n            }\n            router.refresh()\n        } catch (e) {\n            toast.error(\"更新收藏失败\")\n        }\n    }\n\n    const handleUploadVersion = async (formData: FormData) => {\n        setUploading(true)\n        try {\n            const res = await uploadDocument(formData)\n            if (!res.success) {\n                toast.error(\"上传失败\", { description: res.error })\n                return\n            }\n            toast.success(\"上传成功\")\n            setUploadOpen(false)\n            router.refresh()\n        } catch (e) {\n            toast.error(\"上传失败\")\n        } finally {\n            setUploading(false)\n        }\n    }\n\n    return (\n        <div className=\"space-y-6\">\n            <div className=\"flex items-center justify-between\">\n                <div className=\"flex items-center gap-3\">\n                    <Button variant=\"ghost\" size=\"icon\" onClick={() => router.back()}>\n                        <ArrowLeft className=\"h-4 w-4\" />\n                    </Button>\n                    <div>\n                        <div className=\"text-sm text-muted-foreground\">\n                            <Link href=\"/documents\" className=\"hover:underline\">\n                                文档中心\n                            </Link>\n                            <span className=\"mx-2\">/</span>\n                            <Link href={`/cases/${document.case.id}`} className=\"hover:underline\">\n                                {document.case.title}\n                            </Link>\n                        </div>\n                        <div className=\"flex items-center gap-2\">\n                            <h1 className=\"text-xl font-bold\">{document.title}</h1>\n                            <Button\n                                variant=\"ghost\"\n                                size=\"icon\"\n                                onClick={handleToggleFavorite}\n                                className={document.isFavorite ? \"text-yellow-500\" : \"\"}\n                            >\n                                <Star className={document.isFavorite ? \"h-4 w-4 fill-current\" : \"h-4 w-4\"} />\n                            </Button>\n                        </div>\n                    </div>\n                </div>\n\n                <div className=\"flex items-center gap-2\">\n                    <Button\n                        variant=\"outline\"\n                        onClick={() =>\n                            openWindow(\n                                \"ai-paralegal\",\n                                \"AI_PARALEGAL\",\n                                `AI 助手 · ${document.title}`,\n                                { documentId: document.id, caseId: document.case.id, source: \"document_detail\" }\n                            )\n                        }\n                    >\n                        <Bot className=\"h-4 w-4 mr-2\" /> AI 助手\n                    </Button>\n                    <Button variant=\"outline\" onClick={handlePreviewLatest}>\n                        <Eye className=\"h-4 w-4 mr-2\" /> 预览\n                    </Button>\n                    <Button variant=\"outline\" onClick={handleDownloadLatest}>\n                        <Download className=\"h-4 w-4 mr-2\" /> 下载\n                    </Button>\n                    <Dialog open={uploadOpen} onOpenChange={setUploadOpen}>\n                        <DialogTrigger asChild>\n                            <Button>\n                                <Upload className=\"h-4 w-4 mr-2\" /> 上传新版本\n                            </Button>\n                        </DialogTrigger>\n                        <DialogContent>\n                            <DialogHeader>\n                                <DialogTitle>上传新版本</DialogTitle>\n                            </DialogHeader>\n                            <form action={handleUploadVersion} className=\"space-y-4\">\n                                <input type=\"hidden\" name=\"documentId\" value={document.id} />\n                                <div className=\"grid gap-2\">\n                                    <Label htmlFor=\"file\">选择文件</Label>\n                                    <Input id=\"file\" name=\"file\" type=\"file\" required />\n                                </div>\n                                <DialogFooter>\n                                    <Button type=\"button\" variant=\"outline\" onClick={() => setUploadOpen(false)}>\n                                        取消\n                                    </Button>\n                                    <Button type=\"submit\" disabled={uploading}>\n                                        {uploading ? \"上传中...\" : \"确认上传\"}\n                                    </Button>\n                                </DialogFooter>\n                            </form>\n                        </DialogContent>\n                    </Dialog>\n                </div>\n            </div>\n\n            <div className=\"grid grid-cols-1 lg:grid-cols-3 gap-6\">\n                <Card className=\"lg:col-span-2\">\n                    <CardHeader>\n                        <CardTitle className=\"text-base\">基本信息</CardTitle>\n                    </CardHeader>\n                    <CardContent className=\"space-y-4\">\n                        <div className=\"grid gap-2\">\n                            <Label htmlFor=\"title\">标题</Label>\n                            <Input id=\"title\" value={title} onChange={(e) => setTitle(e.target.value)} />\n                        </div>\n                        <div className=\"grid gap-2\">\n                            <Label htmlFor=\"notes\">备注</Label>\n                            <Textarea\n                                id=\"notes\"\n                                value={notes}\n                                onChange={(e) => setNotes(e.target.value)}\n                                rows={6}\n                            />\n                        </div>\n                        <Button onClick={handleSave} disabled={saving}>\n                            {saving ? \"保存中...\" : \"保存\"}\n                        </Button>\n                    </CardContent>\n                </Card>\n\n                <Card>\n                    <CardHeader>\n                        <CardTitle className=\"text-base\">概览</CardTitle>\n                    </CardHeader>\n                    <CardContent className=\"space-y-3 text-sm\">\n                        <div className=\"flex items-center justify-between\">\n                            <span className=\"text-muted-foreground\">版本</span>\n                            <Badge variant=\"secondary\">\n                                <GitBranch className=\"h-3 w-3 mr-1\" /> v{document.version || 1}\n                            </Badge>\n                        </div>\n                        <div className=\"flex items-center justify-between\">\n                            <span className=\"text-muted-foreground\">类型</span>\n                            <span>{formatFileTypeLabel(document.fileType)}</span>\n                        </div>\n                        <div className=\"flex items-center justify-between\">\n                            <span className=\"text-muted-foreground\">大小</span>\n                            <span>{formatSize(document.fileSize || 0)}</span>\n                        </div>\n                        <div className=\"flex items-center justify-between\">\n                            <span className=\"text-muted-foreground\">案件</span>\n                            <span className=\"truncate max-w-[180px]\" title={document.case.title}>\n                                {document.case.title}\n                            </span>\n                        </div>\n                        <Separator />\n                        <div className=\"text-xs text-muted-foreground\">\n                            更新于 {new Date(document.updatedAt).toLocaleString()}\n                        </div>\n                    </CardContent>\n                </Card>\n            </div>\n\n            <Card>\n                <CardHeader>\n                    <CardTitle className=\"text-base\">版本历史</CardTitle>\n                </CardHeader>\n                <CardContent className=\"space-y-2\">\n                    {document.versions.length === 0 ? (\n                        <div className=\"text-sm text-muted-foreground\">暂无版本记录</div>\n                    ) : (\n                        document.versions.map((v) => (\n                            <div key={v.id} className=\"flex items-center justify-between p-3 rounded-lg border\">\n                                <div className=\"min-w-0\">\n                                    <div className=\"flex items-center gap-2\">\n                                        <Badge variant=\"secondary\">v{v.version}</Badge>\n                                        <span className=\"text-sm font-medium\">{formatFileTypeLabel(v.fileType)}</span>\n                                        <span className=\"text-xs text-muted-foreground\">{formatSize(v.fileSize || 0)}</span>\n                                    </div>\n                                    <div className=\"text-xs text-muted-foreground mt-1\">\n                                        {new Date(v.createdAt).toLocaleString()}\n                                        {v.uploader?.name ? ` • ${v.uploader.name}` : \"\"}\n                                    </div>\n                                </div>\n                                <div className=\"flex items-center gap-2\">\n                                    <Button\n                                        variant=\"outline\"\n                                        size=\"sm\"\n                                        onClick={() =>\n                                            window.open(buildFileUrl({ versionId: v.id }), \"_blank\", \"noopener,noreferrer\")\n                                        }\n                                    >\n                                        <Eye className=\"h-4 w-4 mr-1\" /> 预览\n                                    </Button>\n                                    <Button\n                                        variant=\"outline\"\n                                        size=\"sm\"\n                                        onClick={() =>\n                                            window.open(\n                                                buildFileUrl({ versionId: v.id, download: true }),\n                                                \"_blank\",\n                                                \"noopener,noreferrer\"\n                                            )\n                                        }\n                                    >\n                                        <Download className=\"h-4 w-4 mr-1\" /> 下载\n                                    </Button>\n                                </div>\n                            </div>\n                        ))\n                    )}\n                </CardContent>\n            </Card>\n        </div>\n    )\n}\n","usedDeprecatedRules":[]},{"filePath":"D:\\Desktop\\LawClick_NEW\\lawclick-next\\src\\components\\documents\\DocumentListClient.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'CardHeader' is defined but never used.","line":4,"column":29,"nodeType":null,"messageId":"unusedVar","endLine":4,"endColumn":39},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'CardTitle' is defined but never used.","line":4,"column":41,"nodeType":null,"messageId":"unusedVar","endLine":4,"endColumn":50},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'Edit' is defined but never used.","line":26,"column":5,"nodeType":null,"messageId":"unusedVar","endLine":26,"endColumn":9},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'Clock' is defined but never used.","line":29,"column":5,"nodeType":null,"messageId":"unusedVar","endLine":29,"endColumn":10},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":80,"column":12,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":80,"endColumn":15,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1971,1974],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1971,1974],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'e' is defined but never used.","line":137,"column":18,"nodeType":null,"messageId":"unusedVar","endLine":137,"endColumn":19},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'e' is defined but never used.","line":193,"column":18,"nodeType":null,"messageId":"unusedVar","endLine":193,"endColumn":19},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'e' is defined but never used.","line":217,"column":18,"nodeType":null,"messageId":"unusedVar","endLine":217,"endColumn":19},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'e' is defined but never used.","line":239,"column":18,"nodeType":null,"messageId":"unusedVar","endLine":239,"endColumn":19},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'e' is defined but never used.","line":259,"column":18,"nodeType":null,"messageId":"unusedVar","endLine":259,"endColumn":19}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":10,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\"\r\n\r\nimport { useState, useEffect } from \"react\"\r\nimport { Card, CardContent, CardHeader, CardTitle } from \"@/components/ui/card\"\r\nimport { Button } from \"@/components/ui/button\"\r\nimport { Input } from \"@/components/ui/input\"\r\nimport { Badge } from \"@/components/ui/badge\"\r\nimport { Textarea } from \"@/components/ui/textarea\"\r\nimport { Dialog, DialogContent, DialogHeader, DialogTitle, DialogTrigger, DialogFooter } from \"@/components/ui/dialog\"\r\nimport { Label } from \"@/components/ui/label\"\r\nimport { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from \"@/components/ui/select\"\r\nimport { Tabs, TabsList, TabsTrigger } from \"@/components/ui/tabs\"\r\nimport {\r\n    FileText,\r\n    Upload,\r\n    Search,\r\n    Filter,\r\n    Download,\r\n    Eye,\r\n    Tag,\r\n    MessageSquare,\r\n    Sparkles,\r\n    Grid3X3,\r\n    List,\r\n    MoreHorizontal,\r\n    Edit,\r\n    ExternalLink,\r\n    Briefcase,\r\n    Clock,\r\n    Star,\r\n    Lock,\r\n    GitBranch\r\n} from \"lucide-react\"\r\nimport {\r\n    addDocumentTag,\r\n    removeDocumentTag,\r\n    toggleDocumentFavorite,\r\n    updateDocument,\r\n    uploadDocument,\r\n} from \"@/actions/documents\"\r\nimport { toast } from \"sonner\"\r\nimport { useRouter } from \"next/navigation\"\r\nimport {\r\n    DropdownMenu,\r\n    DropdownMenuContent,\r\n    DropdownMenuItem,\r\n    DropdownMenuSeparator,\r\n    DropdownMenuTrigger,\r\n} from \"@/components/ui/dropdown-menu\"\r\nimport {\r\n    Popover,\r\n    PopoverContent,\r\n    PopoverTrigger,\r\n} from \"@/components/ui/popover\"\r\n\r\ninterface Document {\r\n    id: string\r\n    title: string\r\n    fileUrl: string\r\n    fileType: string\r\n    fileSize: number\r\n    updatedAt: Date\r\n    case: {\r\n        title: string\r\n        caseCode: string\r\n    }\r\n    // 扩展字段\r\n    tags?: string[]\r\n    notes?: string\r\n    summary?: string\r\n    category?: string\r\n    // 新增字段\r\n    version?: string\r\n    isFavorite?: boolean\r\n    isConfidential?: boolean\r\n}\r\n\r\ninterface DocumentListClientProps {\r\n    initialDocuments: Document[]\r\n    cases: any[]\r\n}\r\n\r\n// 文档分类\r\nconst DOCUMENT_CATEGORIES = [\r\n    { value: \"all\", label: \"全部\" },\r\n    { value: \"litigation\", label: \"诉讼文书\" },\r\n    { value: \"evidence\", label: \"证据材料\" },\r\n    { value: \"contract\", label: \"合同文书\" },\r\n    { value: \"procedure\", label: \"程序文书\" },\r\n    { value: \"other\", label: \"其他\" },\r\n]\r\n\r\n// 可选标签（后续将落库为全局/案件标签）\r\nconst AVAILABLE_TAGS = [\"重要\", \"待审核\", \"已归档\", \"紧急\", \"草稿\", \"最终版\"]\r\n\r\nexport function DocumentListClient({ initialDocuments, cases }: DocumentListClientProps) {\r\n    const [documents, setDocuments] = useState(initialDocuments)\r\n    const [open, setOpen] = useState(false)\r\n    const [uploading, setUploading] = useState(false)\r\n    const [viewMode, setViewMode] = useState<\"grid\" | \"list\">(\"grid\")\r\n    const [searchQuery, setSearchQuery] = useState(\"\")\r\n    const [categoryFilter, setCategoryFilter] = useState(\"all\")\r\n    const [selectedDoc, setSelectedDoc] = useState<Document | null>(null)\r\n    const [noteDialogOpen, setNoteDialogOpen] = useState(false)\r\n    const [editingNote, setEditingNote] = useState(\"\")\r\n    const router = useRouter()\r\n\r\n    const [mounted, setMounted] = useState(false)\r\n\r\n    useEffect(() => {\r\n        setMounted(true)\r\n    }, [])\r\n\r\n    useEffect(() => {\r\n        setDocuments(initialDocuments)\r\n    }, [initialDocuments])\r\n\r\n    // 筛选文档\r\n    const filteredDocs = documents.filter(doc => {\r\n        const matchesSearch = doc.title.toLowerCase().includes(searchQuery.toLowerCase()) ||\r\n            doc.case.title.toLowerCase().includes(searchQuery.toLowerCase())\r\n        const matchesCategory = categoryFilter === \"all\" || doc.category === categoryFilter\r\n        return matchesSearch && matchesCategory\r\n    })\r\n\r\n    async function handleUpload(formData: FormData) {\r\n        setUploading(true)\r\n        try {\r\n            const res = await uploadDocument(formData)\r\n            if (res.error) {\r\n                toast.error(\"上传失败\", { description: res.error })\r\n            } else {\r\n                toast.success(\"文档上传成功\")\r\n                setOpen(false)\r\n                router.refresh()\r\n            }\r\n        } catch (e) {\r\n            toast.error(\"上传出错\")\r\n        } finally {\r\n            setUploading(false)\r\n        }\r\n    }\r\n\r\n    const formatSize = (bytes: number) => {\r\n        if (bytes === 0) return '0 B'\r\n        const k = 1024\r\n        const sizes = ['B', 'KB', 'MB', 'GB']\r\n        const i = Math.floor(Math.log(bytes) / Math.log(k))\r\n        return parseFloat((bytes / Math.pow(k, i)).toFixed(1)) + ' ' + sizes[i]\r\n    }\r\n\r\n    const formatFileTypeLabel = (fileType: string) => {\r\n        if (!fileType) return \"UNKNOWN\"\r\n        const normalized = fileType.includes(\"/\") ? (fileType.split(\"/\").pop() || fileType) : fileType\r\n        return normalized.toUpperCase()\r\n    }\r\n\r\n    const getFileUrl = (docId: string, opts?: { download?: boolean }) => {\r\n        const params = new URLSearchParams()\r\n        if (opts?.download) params.set(\"download\", \"1\")\r\n        const qs = params.toString()\r\n        return qs ? `/api/documents/${docId}/file?${qs}` : `/api/documents/${docId}/file`\r\n    }\r\n\r\n    const handlePreview = (doc: Document) => {\r\n        if (!doc.fileUrl) {\r\n            toast.error(\"该文档尚未上传文件\")\r\n            return\r\n        }\r\n        window.open(getFileUrl(doc.id), \"_blank\", \"noopener,noreferrer\")\r\n    }\r\n\r\n    const handleDownload = (doc: Document) => {\r\n        if (!doc.fileUrl) {\r\n            toast.error(\"该文档尚未上传文件\")\r\n            return\r\n        }\r\n        window.open(getFileUrl(doc.id, { download: true }), \"_blank\", \"noopener,noreferrer\")\r\n    }\r\n\r\n    const handleSaveNote = async () => {\r\n        if (!selectedDoc) return\r\n\r\n        try {\r\n            const res = await updateDocument(selectedDoc.id, { notes: editingNote })\r\n            if (!res.success) {\r\n                toast.error(\"保存失败\", { description: res.error })\r\n                return\r\n            }\r\n            toast.success(\"备注已保存\")\r\n            setNoteDialogOpen(false)\r\n            router.refresh()\r\n        } catch (e) {\r\n            toast.error(\"保存失败\")\r\n        }\r\n    }\r\n\r\n    const handleAddTag = async (docId: string, tag: string) => {\r\n        setDocuments(docs =>\r\n            docs.map(d => {\r\n                if (d.id !== docId) return d\r\n                const currentTags = d.tags || []\r\n                if (currentTags.includes(tag)) return d\r\n                return { ...d, tags: [...currentTags, tag] }\r\n            })\r\n        )\r\n\r\n        try {\r\n            const res = await addDocumentTag(docId, tag)\r\n            if (!res.success) {\r\n                toast.error(\"添加标签失败\", { description: res.error })\r\n                router.refresh()\r\n                return\r\n            }\r\n            toast.success(`已添加标签: ${tag}`)\r\n            router.refresh()\r\n        } catch (e) {\r\n            toast.error(\"添加标签失败\")\r\n            router.refresh()\r\n        }\r\n    }\r\n\r\n    const handleRemoveTag = async (docId: string, tag: string) => {\r\n        setDocuments(docs =>\r\n            docs.map(d => {\r\n                if (d.id !== docId) return d\r\n                return { ...d, tags: (d.tags || []).filter(t => t !== tag) }\r\n            })\r\n        )\r\n\r\n        try {\r\n            const res = await removeDocumentTag(docId, tag)\r\n            if (!res.success) {\r\n                toast.error(\"移除标签失败\", { description: res.error })\r\n                router.refresh()\r\n                return\r\n            }\r\n            router.refresh()\r\n        } catch (e) {\r\n            toast.error(\"移除标签失败\")\r\n            router.refresh()\r\n        }\r\n    }\r\n\r\n    const handleToggleFavorite = async (doc: Document) => {\r\n        setDocuments(docs =>\r\n            docs.map(d => (d.id === doc.id ? { ...d, isFavorite: !d.isFavorite } : d))\r\n        )\r\n\r\n        try {\r\n            const res = await toggleDocumentFavorite(doc.id)\r\n            if (!res.success) {\r\n                toast.error(\"更新收藏失败\", { description: res.error })\r\n                router.refresh()\r\n                return\r\n            }\r\n            toast.success(doc.isFavorite ? \"已取消收藏\" : \"已添加收藏\")\r\n            router.refresh()\r\n        } catch (e) {\r\n            toast.error(\"更新收藏失败\")\r\n            router.refresh()\r\n        }\r\n    }\r\n\r\n    return (\r\n        <div className=\"space-y-6\">\r\n            {/* Header */}\r\n            <div className=\"flex flex-col md:flex-row justify-between items-start md:items-center gap-4\">\r\n                <div>\r\n                    <h1 className=\"text-2xl font-bold text-slate-900\">文档中心</h1>\r\n                    <p className=\"text-slate-500\">集中管理所有案件相关的法律文书与证据材料</p>\r\n                </div>\r\n                {mounted ? (\r\n                    <Dialog open={open} onOpenChange={setOpen}>\r\n                        <DialogTrigger asChild>\r\n                            <Button className=\"bg-primary hover:bg-primary/90\">\r\n                                <Upload className=\"mr-2 h-4 w-4\" /> 上传文档\r\n                            </Button>\r\n                        </DialogTrigger>\r\n                        <DialogContent>\r\n                            <DialogHeader>\r\n                                <DialogTitle>上传新文档</DialogTitle>\r\n                            </DialogHeader>\r\n                            <form action={handleUpload} className=\"space-y-4\">\r\n                                <div className=\"grid gap-2\">\r\n                                    <Label htmlFor=\"file\">选择文件</Label>\r\n                                    <Input id=\"file\" name=\"file\" type=\"file\" required />\r\n                                </div>\r\n                                <div className=\"grid gap-2\">\r\n                                    <Label htmlFor=\"title\">文档标题</Label>\r\n                                    <Input id=\"title\" name=\"title\" placeholder=\"例如：起诉状副本\" />\r\n                                </div>\r\n                                <div className=\"grid gap-2\">\r\n                                    <Label htmlFor=\"category\">文档分类</Label>\r\n                                    <Select name=\"category\">\r\n                                        <SelectTrigger>\r\n                                            <SelectValue placeholder=\"选择分类\" />\r\n                                        </SelectTrigger>\r\n                                        <SelectContent>\r\n                                            {DOCUMENT_CATEGORIES.slice(1).map(c => (\r\n                                                <SelectItem key={c.value} value={c.value}>{c.label}</SelectItem>\r\n                                            ))}\r\n                                        </SelectContent>\r\n                                    </Select>\r\n                                </div>\r\n                                <div className=\"grid gap-2\">\r\n                                    <Label htmlFor=\"caseId\">关联案件</Label>\r\n                                    <Select name=\"caseId\" required>\r\n                                        <SelectTrigger>\r\n                                            <SelectValue placeholder=\"选择关联案件\" />\r\n                                        </SelectTrigger>\r\n                                        <SelectContent>\r\n                                            {cases.map(c => (\r\n                                                <SelectItem key={c.id} value={c.id}>{c.title}</SelectItem>\r\n                                            ))}\r\n                                        </SelectContent>\r\n                                    </Select>\r\n                                </div>\r\n                                <div className=\"grid gap-2\">\r\n                                    <Label htmlFor=\"notes\">备注</Label>\r\n                                    <Textarea id=\"notes\" name=\"notes\" placeholder=\"添加文档备注...\" rows={2} />\r\n                                </div>\r\n                                <Button type=\"submit\" className=\"w-full\" disabled={uploading}>\r\n                                    {uploading ? \"上传中...\" : \"确认上传\"}\r\n                                </Button>\r\n                            </form>\r\n                        </DialogContent>\r\n                    </Dialog>\r\n                ) : (\r\n                    <Button className=\"bg-primary hover:bg-primary/90\">\r\n                        <Upload className=\"mr-2 h-4 w-4\" /> 上传文档\r\n                    </Button>\r\n                )}\r\n            </div>\r\n\r\n            {/* Toolbar */}\r\n            <div className=\"flex flex-col md:flex-row items-start md:items-center gap-4 bg-white p-4 rounded-lg border shadow-sm\">\r\n                <div className=\"relative flex-1 max-w-sm\">\r\n                    <Search className=\"absolute left-3 top-1/2 -translate-y-1/2 h-4 w-4 text-slate-400\" />\r\n                    <Input\r\n                        placeholder=\"搜索文档...\"\r\n                        className=\"pl-9\"\r\n                        value={searchQuery}\r\n                        onChange={(e) => setSearchQuery(e.target.value)}\r\n                    />\r\n                </div>\r\n                <div className=\"flex items-center gap-2\">\r\n                    <Select value={categoryFilter} onValueChange={setCategoryFilter}>\r\n                        <SelectTrigger className=\"w-32\">\r\n                            <Filter className=\"h-4 w-4 mr-2\" />\r\n                            <SelectValue />\r\n                        </SelectTrigger>\r\n                        <SelectContent>\r\n                            {DOCUMENT_CATEGORIES.map(c => (\r\n                                <SelectItem key={c.value} value={c.value}>{c.label}</SelectItem>\r\n                            ))}\r\n                        </SelectContent>\r\n                    </Select>\r\n                    <Tabs value={viewMode} onValueChange={(v) => setViewMode(v as \"grid\" | \"list\")}>\r\n                        <TabsList className=\"h-9\">\r\n                            <TabsTrigger value=\"grid\" className=\"px-2\">\r\n                                <Grid3X3 className=\"h-4 w-4\" />\r\n                            </TabsTrigger>\r\n                            <TabsTrigger value=\"list\" className=\"px-2\">\r\n                                <List className=\"h-4 w-4\" />\r\n                            </TabsTrigger>\r\n                        </TabsList>\r\n                    </Tabs>\r\n                </div>\r\n            </div>\r\n\r\n            {/* Document List/Grid */}\r\n            {viewMode === \"grid\" ? (\r\n                <div className=\"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6\">\r\n                    {filteredDocs.map(doc => (\r\n                        <Card key={doc.id} className={`group hover:shadow-md transition-shadow ${doc.isFavorite ? 'ring-2 ring-yellow-200' : ''}`}>\r\n                            <CardContent className=\"p-4 flex flex-col h-full\">\r\n                                <div className=\"flex items-start justify-between mb-3\">\r\n                                    <div className=\"relative\">\r\n                                        <div className={`h-10 w-10 rounded-lg flex items-center justify-center ${doc.isConfidential ? 'bg-red-50 text-red-600' : 'bg-blue-50 text-blue-600'}`}>\r\n                                            <FileText className=\"h-5 w-5\" />\r\n                                        </div>\r\n                                        {doc.isConfidential && (\r\n                                            <Lock className=\"h-3 w-3 absolute -top-1 -right-1 text-red-600\" />\r\n                                        )}\r\n                                    </div>\r\n                                    <div className=\"flex items-center gap-1\">\r\n                                        <Button\r\n                                            size=\"icon\"\r\n                                            variant=\"ghost\"\r\n                                            className={`h-7 w-7 ${doc.isFavorite ? 'text-yellow-500' : 'opacity-0 group-hover:opacity-100'}`}\r\n                                            onClick={() => handleToggleFavorite(doc)}\r\n                                        >\r\n                                            <Star className={`h-4 w-4 ${doc.isFavorite ? 'fill-current' : ''}`} />\r\n                                        </Button>\r\n                                        <DropdownMenu>\r\n                                            <DropdownMenuTrigger asChild>\r\n                                                <Button size=\"icon\" variant=\"ghost\" className=\"h-8 w-8 opacity-0 group-hover:opacity-100\">\r\n                                                    <MoreHorizontal className=\"h-4 w-4\" />\r\n                                                </Button>\r\n                                            </DropdownMenuTrigger>\r\n                                            <DropdownMenuContent align=\"end\">\r\n                                                <DropdownMenuItem onClick={() => router.push(`/documents/${doc.id}`)}>\r\n                                                    <ExternalLink className=\"h-4 w-4 mr-2\" /> 详情\r\n                                                </DropdownMenuItem>\r\n                                                <DropdownMenuItem onClick={() => router.push(`/documents/${doc.id}/review`)}>\r\n                                                    <Sparkles className=\"h-4 w-4 mr-2\" /> AI 审查\r\n                                                </DropdownMenuItem>\r\n                                                <DropdownMenuItem onClick={() => handlePreview(doc)}>\r\n                                                    <Eye className=\"h-4 w-4 mr-2\" /> 预览\r\n                                                </DropdownMenuItem>\r\n                                                <DropdownMenuItem onClick={() => handleDownload(doc)}>\r\n                                                    <Download className=\"h-4 w-4 mr-2\" /> 下载\r\n                                                </DropdownMenuItem>\r\n                                                <DropdownMenuSeparator />\r\n                                                <DropdownMenuItem onClick={() => {\r\n                                                    setSelectedDoc(doc)\r\n                                                    setEditingNote(doc.notes || \"\")\r\n                                                    setNoteDialogOpen(true)\r\n                                                }}>\r\n                                                    <MessageSquare className=\"h-4 w-4 mr-2\" /> 编辑备注\r\n                                                </DropdownMenuItem>\r\n                                            </DropdownMenuContent>\r\n                                        </DropdownMenu>\r\n                                    </div>\r\n                                </div>\r\n\r\n                                <div className=\"flex-1\">\r\n                                    <h3 className=\"font-medium text-slate-900 truncate\" title={doc.title}>{doc.title}</h3>\r\n                                    <p className=\"text-xs text-slate-500 mt-1 truncate flex items-center gap-1\">\r\n                                        <Briefcase className=\"h-3 w-3\" />\r\n                                        {doc.case.title}\r\n                                    </p>\r\n\r\n                                    {/* Tags */}\r\n                                    {doc.tags && doc.tags.length > 0 && (\r\n                                        <div className=\"flex flex-wrap gap-1 mt-2\">\r\n                                            {doc.tags.map(tag => (\r\n                                                <Badge\r\n                                                    key={tag}\r\n                                                    variant=\"secondary\"\r\n                                                    className={`text-[10px] cursor-pointer ${tag === \"重要\" ? \"bg-red-100 text-red-700\" :\r\n                                                        tag === \"紧急\" ? \"bg-orange-100 text-orange-700\" :\r\n                                                            tag === \"最终版\" ? \"bg-green-100 text-green-700\" :\r\n                                                                \"\"\r\n                                                        }`}\r\n                                                    onClick={() => handleRemoveTag(doc.id, tag)}\r\n                                                >\r\n                                                    {tag} ×\r\n                                                </Badge>\r\n                                            ))}\r\n                                        </div>\r\n                                    )}\r\n\r\n                                    {/* Notes preview */}\r\n                                    {doc.notes && (\r\n                                        <p className=\"text-xs text-muted-foreground mt-2 line-clamp-2 bg-muted/30 p-1.5 rounded\">\r\n                                            {doc.notes}\r\n                                        </p>\r\n                                    )}\r\n\r\n                                    {/* AI Summary */}\r\n                                    {doc.summary && (\r\n                                        <div className=\"mt-2 p-2 bg-orange-50 rounded text-xs text-orange-700 flex items-start gap-1.5\">\r\n                                            <Sparkles className=\"h-3 w-3 mt-0.5 shrink-0\" />\r\n                                            <span className=\"line-clamp-2\">{doc.summary}</span>\r\n                                        </div>\r\n                                    )}\r\n                                </div>\r\n\r\n                                <div className=\"mt-4 pt-3 border-t\">\r\n                                    <div className=\"flex items-center justify-between text-xs text-slate-400\">\r\n                                        <span className=\"flex items-center gap-1\">\r\n                                            <GitBranch className=\"h-3 w-3\" />\r\n                                            {doc.version ? `v${doc.version}` : \"v1\"}\r\n                                        </span>\r\n                                        <span>{formatFileTypeLabel(doc.fileType)} • {formatSize(doc.fileSize)}</span>\r\n                                    </div>\r\n                                    {/* Add tag button */}\r\n                                    <Popover>\r\n                                        <PopoverTrigger asChild>\r\n                                            <Button variant=\"ghost\" size=\"sm\" className=\"w-full mt-2 text-xs h-7\">\r\n                                                <Tag className=\"h-3 w-3 mr-1\" /> 添加标签\r\n                                            </Button>\r\n                                        </PopoverTrigger>\r\n                                        <PopoverContent className=\"w-48 p-2\">\r\n                                            <div className=\"space-y-1\">\r\n                                                {AVAILABLE_TAGS.filter(t => !(doc.tags || []).includes(t)).map(tag => (\r\n                                                    <Button\r\n                                                        key={tag}\r\n                                                        variant=\"ghost\"\r\n                                                        size=\"sm\"\r\n                                                        className=\"w-full justify-start text-xs h-7\"\r\n                                                        onClick={() => handleAddTag(doc.id, tag)}\r\n                                                    >\r\n                                                        {tag}\r\n                                                    </Button>\r\n                                                ))}\r\n                                            </div>\r\n                                        </PopoverContent>\r\n                                    </Popover>\r\n                                </div>\r\n                            </CardContent>\r\n                        </Card>\r\n                    ))}\r\n                    {filteredDocs.length === 0 && (\r\n                        <div className=\"col-span-full text-center py-12 text-slate-400 bg-slate-50 rounded-lg border border-dashed\">\r\n                            <FileText className=\"h-12 w-12 mx-auto mb-4 opacity-50\" />\r\n                            <p>暂无文档，请点击右上角上传</p>\r\n                        </div>\r\n                    )}\r\n                </div>\r\n            ) : (\r\n                /* List View */\r\n                <div className=\"bg-white rounded-lg border divide-y\">\r\n                    {filteredDocs.map(doc => (\r\n                        <div key={doc.id} className=\"flex items-center justify-between p-4 hover:bg-muted/30 transition-colors\">\r\n                            <div className=\"flex items-center gap-4 flex-1 min-w-0\">\r\n                                <div className=\"h-10 w-10 rounded-lg bg-blue-50 flex items-center justify-center text-blue-600 shrink-0\">\r\n                                    <FileText className=\"h-5 w-5\" />\r\n                                </div>\r\n                                <div className=\"flex-1 min-w-0\">\r\n                                    <div className=\"flex items-center gap-2\">\r\n                                        <h3 className=\"font-medium truncate\">{doc.title}</h3>\r\n                                        {doc.tags?.map(tag => (\r\n                                            <Badge key={tag} variant=\"secondary\" className=\"text-[10px]\">{tag}</Badge>\r\n                                        ))}\r\n                                    </div>\r\n                                    <div className=\"flex items-center gap-3 text-xs text-muted-foreground mt-1\">\r\n                                        <span className=\"flex items-center gap-1\">\r\n                                            <Briefcase className=\"h-3 w-3\" />\r\n                                            {doc.case.title}\r\n                                        </span>\r\n                                        <span>{formatFileTypeLabel(doc.fileType)}</span>\r\n                                        <span>{formatSize(doc.fileSize)}</span>\r\n                                    </div>\r\n                                    {doc.notes && (\r\n                                        <p className=\"text-xs text-muted-foreground mt-1 truncate\">{doc.notes}</p>\r\n                                    )}\r\n                                </div>\r\n                            </div>\r\n                            <div className=\"flex items-center gap-2 shrink-0 ml-4\">\r\n                                <Button size=\"sm\" variant=\"ghost\" onClick={() => router.push(`/documents/${doc.id}/review`)}>\r\n                                    <Sparkles className=\"h-4 w-4 mr-1\" /> AI审查\r\n                                </Button>\r\n                                <Button size=\"icon\" variant=\"ghost\" onClick={() => handlePreview(doc)}><Eye className=\"h-4 w-4\" /></Button>\r\n                                <Button size=\"icon\" variant=\"ghost\" onClick={() => handleDownload(doc)}><Download className=\"h-4 w-4\" /></Button>\r\n                            </div>\r\n                        </div>\r\n                    ))}\r\n                </div>\r\n            )}\r\n\r\n            {/* Note Edit Dialog */}\r\n            <Dialog open={noteDialogOpen} onOpenChange={setNoteDialogOpen}>\r\n                <DialogContent>\r\n                    <DialogHeader>\r\n                        <DialogTitle>编辑文档备注</DialogTitle>\r\n                    </DialogHeader>\r\n                    <div className=\"space-y-4\">\r\n                        <div>\r\n                            <Label>文档: {selectedDoc?.title}</Label>\r\n                        </div>\r\n                        <div>\r\n                            <Label>备注</Label>\r\n                            <Textarea\r\n                                value={editingNote}\r\n                                onChange={(e) => setEditingNote(e.target.value)}\r\n                                placeholder=\"添加备注信息...\"\r\n                                rows={4}\r\n                                className=\"mt-2\"\r\n                            />\r\n                        </div>\r\n                    </div>\r\n                    <DialogFooter>\r\n                        <Button variant=\"outline\" onClick={() => setNoteDialogOpen(false)}>取消</Button>\r\n                        <Button onClick={handleSaveNote}>保存</Button>\r\n                    </DialogFooter>\r\n                </DialogContent>\r\n            </Dialog>\r\n        </div>\r\n    )\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"D:\\Desktop\\LawClick_NEW\\lawclick-next\\src\\components\\features\\case-kanban.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'Briefcase' is defined but never used.","line":5,"column":32,"nodeType":null,"messageId":"unusedVar","endLine":5,"endColumn":41},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":102,"column":79,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":102,"endColumn":82,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[3579,3582],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[3579,3582],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":2,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\"\r\n\r\nimport Link from \"next/link\"\r\nimport * as React from \"react\"\r\nimport { MoreHorizontal, Plus, Briefcase, User, Calendar } from \"lucide-react\"\r\nimport { formatDistanceToNow } from \"date-fns\"\r\nimport { zhCN } from \"date-fns/locale/zh-CN\"\r\nimport { Button } from \"@/components/ui/button\"\r\nimport { Card, CardContent } from \"@/components/ui/card\"\r\nimport { ScrollArea } from \"@/components/ui/scroll-area\"\r\nimport { Badge } from \"@/components/ui/badge\"\r\nimport { cn } from \"@/lib/utils\"\r\n// Drag and Drop\r\nimport { DragDropContext, Droppable, Draggable, DropResult } from \"@hello-pangea/dnd\"\r\nimport { useDispatchStore } from \"@/store/dispatch-store\"\r\nimport { toast } from \"sonner\"\r\nimport { changeCaseStatus } from \"@/actions/cases-crud\"\r\nimport { startTimer } from \"@/actions/timelogs-crud\"\r\nimport { useFloatStore } from \"@/store/float-store\"\r\n\r\ninterface Case {\r\n    id: string\r\n    title: string\r\n    status: string\r\n    updatedAt: Date\r\n    // Backward-compatible fields (some pages pass Prisma Case directly)\r\n    clientName?: string\r\n    caseNumber?: string\r\n    caseCode?: string\r\n    client?: { name?: string | null } | null\r\n}\r\n\r\ninterface CaseKanbanProps {\r\n    cases: Case[]\r\n}\r\n\r\nconst COLUMNS = [\r\n    { id: 'LEAD', title: '线索', color: 'bg-slate-100 border-slate-200' },\r\n    { id: 'INTAKE', title: '立案审查', color: 'bg-blue-50 border-blue-100' },\r\n    { id: 'ACTIVE', title: '在办', color: 'bg-green-50 border-green-100' },\r\n    { id: 'SUSPENDED', title: '中止', color: 'bg-yellow-50 border-yellow-100' },\r\n    { id: 'CLOSED', title: '结案', color: 'bg-gray-50 border-gray-200' },\r\n    { id: 'ARCHIVED', title: '归档', color: 'bg-slate-50 border-slate-200' },\r\n]\r\n\r\nexport function CaseKanban({ cases: initialCases }: CaseKanbanProps) {\r\n    // Local state for optimistic UI updates\r\n    const [cases, setCases] = React.useState(initialCases)\r\n    const { selectTask, selectedTaskId } = useDispatchStore()\r\n    const { openWindow } = useFloatStore()\r\n    const [enabled, setEnabled] = React.useState(false)\r\n\r\n    React.useEffect(() => {\r\n        const animation = requestAnimationFrame(() => setEnabled(true))\r\n        return () => {\r\n            cancelAnimationFrame(animation)\r\n            setEnabled(false)\r\n        }\r\n    }, [])\r\n\r\n    // Grouping Logic\r\n    const groupedCases = React.useMemo(() => {\r\n        const groups: Record<string, Case[]> = {\r\n            LEAD: [],\r\n            INTAKE: [],\r\n            ACTIVE: [],\r\n            SUSPENDED: [],\r\n            CLOSED: [],\r\n            ARCHIVED: [],\r\n        }\r\n        cases.forEach(c => {\r\n            let colId = c.status\r\n            if (!groups[colId]) colId = 'ACTIVE'\r\n            if (groups[colId]) groups[colId].push(c)\r\n        })\r\n        return groups\r\n    }, [cases])\r\n\r\n    if (!enabled) {\r\n        return null\r\n    }\r\n\r\n    const onDragEnd = async (result: DropResult) => {\r\n        const { source, destination, draggableId } = result\r\n\r\n        // Dropped outside or same position\r\n        if (!destination) return\r\n        if (source.droppableId === destination.droppableId && source.index === destination.index) return\r\n\r\n        // Find the case and update status\r\n        const movedCase = cases.find(c => c.id === draggableId)\r\n        if (!movedCase) return\r\n\r\n        const newStatus = destination.droppableId\r\n\r\n        // Optimistic Update\r\n        const updatedCases = cases.map(c =>\r\n            c.id === draggableId ? { ...c, status: newStatus } : c\r\n        )\r\n        setCases(updatedCases)\r\n\r\n        const statusResult = await changeCaseStatus(draggableId, newStatus as any)\r\n        if (!statusResult.success) {\r\n            setCases(cases)\r\n            toast.error(\"状态更新失败\", { description: statusResult.error })\r\n            return\r\n        }\r\n\r\n        // Smart Timer Logic: If moving to ACTIVE, auto start timer (backend truth)\r\n        if (newStatus === 'ACTIVE' && source.droppableId !== 'ACTIVE') {\r\n            const timerRes = await startTimer({\r\n                caseId: movedCase.id,\r\n                description: `处理案件：${movedCase.title}`,\r\n                isBillable: true,\r\n            })\r\n            if (timerRes.success) {\r\n                openWindow('timer', 'TIMER', '计时器')\r\n                toast.success(\"已自动开始计时\", {\r\n                    description: `已将「${movedCase.title}」移入在办`\r\n                })\r\n            } else {\r\n                toast.error(\"自动计时失败\", { description: timerRes.error })\r\n            }\r\n        }\r\n    }\r\n\r\n    return (\r\n        <DragDropContext onDragEnd={onDragEnd}>\r\n            <div className=\"flex h-full min-h-0 gap-4 overflow-x-auto pb-4\">\r\n                {COLUMNS.map(col => (\r\n                    <div key={col.id} className={cn(\"flex-shrink-0 w-80 flex flex-col rounded-lg border\", col.color)}>\r\n                        {/* Column Header */}\r\n                        <div className=\"p-3 border-b bg-white/50 backdrop-blur-sm flex items-center justify-between sticky top-0 z-10\">\r\n                            <div className=\"flex items-center gap-2\">\r\n                                <h3 className=\"font-semibold text-sm\">{col.title}</h3>\r\n                                <Badge variant=\"secondary\" className=\"bg-white/50 text-xs text-muted-foreground\">\r\n                                    {groupedCases[col.id]?.length || 0}\r\n                                </Badge>\r\n                            </div>\r\n                            <Button variant=\"ghost\" size=\"icon\" className=\"h-6 w-6\">\r\n                                <Plus className=\"h-3 w-3\" />\r\n                            </Button>\r\n                        </div>\r\n\r\n                        {/* Droppable Area */}\r\n                        <Droppable droppableId={col.id}>\r\n                            {(provided) => (\r\n                                <ScrollArea className=\"flex-1 p-3\">\r\n                                    <div\r\n                                        {...provided.droppableProps}\r\n                                        ref={provided.innerRef}\r\n                                        className=\"space-y-3 min-h-[100px]\"\r\n                                    >\r\n                                        {groupedCases[col.id]?.map((c, index) => (\r\n                                            <Draggable key={c.id} draggableId={c.id} index={index}>\r\n                                                {(provided, snapshot) => (\r\n                                                    <div\r\n                                                        ref={provided.innerRef}\r\n                                                        {...provided.draggableProps}\r\n                                                        {...provided.dragHandleProps}\r\n                                                        style={{ ...provided.draggableProps.style }}\r\n                                                    >\r\n                                                        {/* Link wrapper is tricky with DnD, usually better to put Click handler or put Link inside Card content area but not blocking drag */}\r\n                                                        {/* For Kanban, we usually click title to open, drag everywhere else. Making whole card a Link conflicts with Drag. */}\r\n                                                        {/* Solution: Make title a Link, Card is drag handle */}\r\n\r\n                                                        <Card className={cn(\r\n                                                            \"bg-white hover:border-primary/50 transition-colors group\",\r\n                                                            snapshot.isDragging ? \"shadow-lg rotate-2 opacity-90 scale-105 z-50 ring-2 ring-primary\" : \"hover:shadow-md\"\r\n                                                        )}>\r\n                                                            <CardContent className=\"p-3 space-y-3\">\r\n                                                                <div className=\"flex items-start justify-between\">\r\n                                                                <Badge variant=\"outline\" className=\"text-[10px] px-1 py-0 h-5 border-primary/20 text-primary bg-primary/5\">\r\n                                                                        {c.caseNumber || c.caseCode || \"—\"}\r\n                                                                </Badge>\r\n                                                                    <div className=\"flex gap-1\">\r\n                                                                        <Link href={`/cases/${c.id}`}>\r\n                                                                            <Button variant=\"ghost\" size=\"icon\" className=\"h-6 w-6 -mt-1 text-muted-foreground hover:text-primary\">\r\n                                                                                <MoreHorizontal className=\"h-3 w-3\" />\r\n                                                                            </Button>\r\n                                                                        </Link>\r\n                                                                    </div>\r\n                                                                </div>\r\n\r\n                                                                <div\r\n                                                                    onClick={() => selectTask(c.id, c.title)}\r\n                                                                    className={cn(\r\n                                                                        \"cursor-pointer rounded p-1 transition-all\",\r\n                                                                        selectedTaskId === c.id ? \"bg-primary/10 ring-1 ring-primary\" : \"hover:bg-muted\"\r\n                                                                    )}\r\n                                                                >\r\n                                                                    <h4 className=\"font-medium text-sm leading-tight mb-1\">{c.title}</h4>\r\n                                                                    <div className=\"flex items-center gap-1.5 text-xs text-muted-foreground\">\r\n                                                                        <User className=\"h-3 w-3\" />\r\n                                                                        <span className=\"truncate max-w-[150px]\">\r\n                                                                            {c.clientName || c.client?.name || \"未知客户\"}\r\n                                                                        </span>\r\n                                                                    </div>\r\n                                                                </div>\r\n\r\n                                                                <div className=\"flex items-center justify-between pt-2 border-t border-dashed\">\r\n                                                                    <div className=\"flex -space-x-1.5\">\r\n                                                                        <div className=\"h-5 w-5 rounded-full bg-slate-200 border-2 border-white\" />\r\n                                                                        <div className=\"h-5 w-5 rounded-full bg-slate-300 border-2 border-white\" />\r\n                                                                    </div>\r\n                                                                    <div className=\"flex items-center gap-1 text-[10px] text-muted-foreground bg-slate-50 px-1.5 py-0.5 rounded\">\r\n                                                                        <Calendar className=\"h-3 w-3\" />\r\n                                                                        {formatDistanceToNow(new Date(c.updatedAt), {\r\n                                                                            addSuffix: true,\r\n                                                                            locale: zhCN,\r\n                                                                        })}\r\n                                                                    </div>\r\n                                                                </div>\r\n                                                            </CardContent>\r\n                                                        </Card>\r\n                                                    </div>\r\n                                                )}\r\n                                            </Draggable>\r\n                                        ))}\r\n                                        {provided.placeholder}\r\n                                    </div>\r\n                                </ScrollArea>\r\n                            )}\r\n                        </Droppable>\r\n                    </div>\r\n                ))}\r\n            </div>\r\n        </DragDropContext>\r\n    )\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"D:\\Desktop\\LawClick_NEW\\lawclick-next\\src\\components\\features\\command-palette.tsx","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":43,"column":47,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":43,"endColumn":50,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1188,1191],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1188,1191],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\"\r\n\r\nimport * as React from \"react\"\r\nimport {\n    Calculator,\n    Calendar,\n    User,\n    Briefcase,\n    FileText\n} from \"lucide-react\"\n\r\nimport {\r\n    CommandDialog,\r\n    CommandEmpty,\r\n    CommandGroup,\r\n    CommandInput,\r\n    CommandItem,\r\n    CommandList,\r\n    CommandSeparator,\r\n    CommandShortcut,\r\n} from \"@/components/ui/command\"\r\nimport { useRouter } from \"next/navigation\"\r\nimport { getCases } from \"@/actions/cases\"\r\n\r\nexport function CommandPalette() {\r\n    const [open, setOpen] = React.useState(false)\r\n    const router = useRouter()\r\n    const [cases, setCases] = React.useState<{ id: string, title: string, caseNumber: string, clientName: string }[]>([])\r\n\r\n    React.useEffect(() => {\r\n        const down = (e: KeyboardEvent) => {\r\n            if (e.key === \"k\" && (e.metaKey || e.ctrlKey)) {\r\n                e.preventDefault()\r\n                setOpen((open) => !open)\r\n            }\r\n        }\r\n        document.addEventListener(\"keydown\", down)\r\n\r\n            // Predownload search index\n            const fetchIndex = async () => {\n                try {\n                    const allCases = await getCases()\n                    setCases(allCases.map((c: any) => ({\n                        id: c.id,\n                        title: c.title,\n                    clientName: c.clientName || c.client?.name || 'Unknown Client',\r\n                    caseNumber: c.caseNumber || c.caseCode || 'N/A'\r\n                })))\r\n            } catch (e) {\r\n                console.error(\"Failed to load search index\", e)\r\n            }\r\n        }\r\n        fetchIndex()\r\n\r\n        return () => document.removeEventListener(\"keydown\", down)\r\n    }, [])\r\n\r\n    const runCommand = React.useCallback((command: () => unknown) => {\r\n        setOpen(false)\r\n        command()\r\n    }, [])\r\n\r\n    return (\r\n        <CommandDialog open={open} onOpenChange={setOpen}>\r\n            <CommandInput placeholder=\"Type a command or search...\" />\r\n            <CommandList>\r\n                <CommandEmpty>No results found.</CommandEmpty>\r\n                <CommandGroup heading=\"Suggestions\">\r\n                    <CommandItem onSelect={() => runCommand(() => router.push('/dashboard'))}>\r\n                        <Calendar className=\"mr-2 h-4 w-4\" />\r\n                        <span>Dashboard</span>\r\n                    </CommandItem>\r\n                    <CommandItem onSelect={() => runCommand(() => router.push('/cases'))}>\r\n                        <Briefcase className=\"mr-2 h-4 w-4\" />\r\n                        <span>Cases Directory</span>\r\n                    </CommandItem>\r\n                    <CommandItem onSelect={() => runCommand(() => router.push('/dispatch'))}>\r\n                        <Calculator className=\"mr-2 h-4 w-4\" />\r\n                        <span>Dispatch Center</span>\r\n                    </CommandItem>\r\n                </CommandGroup>\r\n                <CommandSeparator />\r\n                <CommandGroup heading=\"Recent Cases\">\r\n                    {cases.slice(0, 5).map(c => (\r\n                        <CommandItem\r\n                            key={c.id}\r\n                            value={`${c.title} ${c.caseNumber} ${c.clientName}`}\r\n                            onSelect={() => runCommand(() => router.push(`/cases/${c.id}`))}\r\n                        >\r\n                            <FileText className=\"mr-2 h-4 w-4 text-muted-foreground\" />\r\n                            <span>{c.title}</span>\r\n                            <span className=\"ml-2 text-xs text-muted-foreground\">#{c.caseNumber}</span>\r\n                        </CommandItem>\r\n                    ))}\r\n                </CommandGroup>\n                <CommandSeparator />\n                <CommandGroup heading=\"Account\">\n                    <CommandItem onSelect={() => runCommand(() => router.push('/profile'))}>\n                        <User className=\"mr-2 h-4 w-4\" />\n                        <span>Profile</span>\n                        <CommandShortcut>⌘P</CommandShortcut>\n                    </CommandItem>\n                </CommandGroup>\n            </CommandList>\n        </CommandDialog>\n    )\n}\n","usedDeprecatedRules":[]},{"filePath":"D:\\Desktop\\LawClick_NEW\\lawclick-next\\src\\components\\features\\conflict-check-wizard.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\Desktop\\LawClick_NEW\\lawclick-next\\src\\components\\features\\cws\\chat-interface.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'Separator' is defined but never used.","line":9,"column":10,"nodeType":null,"messageId":"unusedVar","endLine":9,"endColumn":19}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\"\r\n\r\nimport * as React from \"react\"\r\nimport { Send, Paperclip, Smile, Search, MoreHorizontal, FileText } from \"lucide-react\"\r\nimport { Button } from \"@/components/ui/button\"\r\nimport { Input } from \"@/components/ui/input\"\r\nimport { Avatar, AvatarFallback, AvatarImage } from \"@/components/ui/avatar\"\r\nimport { ScrollArea } from \"@/components/ui/scroll-area\"\r\nimport { Separator } from \"@/components/ui/separator\"\r\nimport { cn } from \"@/lib/utils\"\r\n\r\ninterface Message {\r\n    id: string\r\n    senderId: string\r\n    senderName: string\r\n    avatar?: string\r\n    content: string\r\n    timestamp: Date\r\n    attachments?: { type: 'file' | 'link' | 'case', title: string, url: string }[]\r\n    isSelf: boolean\r\n}\r\n\r\n// Mock Data\r\nconst MOCK_MESSAGES: Message[] = [\r\n    {\r\n        id: '1',\r\n        senderId: 'other',\r\n        senderName: 'Sarah Chen',\r\n        avatar: '/avatars/sarah.jpg',\r\n        content: 'I have reviewed the initial contract draft. There are a few clauses in Section 4 that seem problematic regarding the liability cap.',\r\n        timestamp: new Date(Date.now() - 3600000),\r\n        isSelf: false\r\n    },\r\n    {\r\n        id: '2',\r\n        senderId: 'self',\r\n        senderName: 'Me',\r\n        content: 'Thanks Sarah. Can you point out the specific sub-clauses? I relied on the standard template.',\r\n        timestamp: new Date(Date.now() - 3500000),\r\n        isSelf: true\r\n    },\r\n    {\r\n        id: '3',\r\n        senderId: 'other',\r\n        senderName: 'Sarah Chen',\r\n        avatar: '/avatars/sarah.jpg',\r\n        content: 'Sure, specifically 4.2(a) and 4.3. I annotated them in the attached doc.',\r\n        timestamp: new Date(Date.now() - 3400000),\r\n        attachments: [\r\n            { type: 'file', title: 'Contract_v1_Annotated.docx', url: '#' }\r\n        ],\r\n        isSelf: false\r\n    }\r\n]\r\n\r\nexport function ChatInterface() {\r\n    const [message, setMessage] = React.useState(\"\")\r\n    const [messages, setMessages] = React.useState<Message[]>(MOCK_MESSAGES)\r\n\r\n    const handleSend = () => {\r\n        if (!message.trim()) return\r\n        const newMsg: Message = {\r\n            id: Date.now().toString(),\r\n            senderId: 'self',\r\n            senderName: 'Me',\r\n            content: message,\r\n            timestamp: new Date(),\r\n            isSelf: true\r\n        }\r\n        setMessages([...messages, newMsg])\r\n        setMessage(\"\")\r\n    }\r\n\r\n    return (\r\n        <div className=\"flex flex-col h-full bg-background border-l\">\r\n            {/* Header */}\r\n            <div className=\"h-14 border-b flex items-center justify-between px-4 bg-muted/10\">\r\n                <div className=\"flex items-center gap-3\">\r\n                    <Avatar className=\"h-8 w-8\">\r\n                        <AvatarImage src=\"/avatars/group.jpg\" />\r\n                        <AvatarFallback>C</AvatarFallback>\r\n                    </Avatar>\r\n                    <div>\r\n                        <h3 className=\"font-semibold text-sm\">Case Discussion</h3>\r\n                        <p className=\"text-xs text-muted-foreground\">3 participants</p>\r\n                    </div>\r\n                </div>\r\n                <div className=\"flex items-center gap-1\">\r\n                    <Button variant=\"ghost\" size=\"icon\" className=\"h-8 w-8 text-muted-foreground\">\r\n                        <Search className=\"h-4 w-4\" />\r\n                    </Button>\r\n                    <Button variant=\"ghost\" size=\"icon\" className=\"h-8 w-8 text-muted-foreground\">\r\n                        <MoreHorizontal className=\"h-4 w-4\" />\r\n                    </Button>\r\n                </div>\r\n            </div>\r\n\r\n            {/* Messages Area */}\r\n            <ScrollArea className=\"flex-1 p-4\">\r\n                <div className=\"space-y-4\">\r\n                    {messages.map((msg) => (\r\n                        <div\r\n                            key={msg.id}\r\n                            className={cn(\r\n                                \"flex gap-3 max-w-[85%]\",\r\n                                msg.isSelf ? \"ml-auto flex-row-reverse\" : \"\"\r\n                            )}\r\n                        >\r\n                            {!msg.isSelf && (\r\n                                <Avatar className=\"h-8 w-8 mt-1\">\r\n                                    <AvatarImage src={msg.avatar} />\r\n                                    <AvatarFallback>{msg.senderName[0]}</AvatarFallback>\r\n                                </Avatar>\r\n                            )}\r\n\r\n                            <div className={cn(\r\n                                \"flex flex-col gap-1\",\r\n                                msg.isSelf ? \"items-end\" : \"items-start\"\r\n                            )}>\r\n                                <div className={cn(\r\n                                    \"p-3 rounded-lg text-sm shadow-sm\",\r\n                                    msg.isSelf\r\n                                        ? \"bg-primary text-primary-foreground rounded-tr-none\"\r\n                                        : \"bg-white border rounded-tl-none\"\r\n                                )}>\r\n                                    <p>{msg.content}</p>\r\n                                </div>\r\n\r\n                                {msg.attachments?.map((att, index) => (\r\n                                    <div key={index} className=\"flex items-center gap-2 p-2 rounded border bg-muted/20 text-xs w-full max-w-[200px] cursor-pointer hover:bg-muted/40 transition-colors\">\r\n                                        <div className=\"h-8 w-8 rounded bg-blue-100 flex items-center justify-center text-blue-600\">\r\n                                            <FileText className=\"h-4 w-4\" />\r\n                                        </div>\r\n                                        <div className=\"flex-1 truncate\">\r\n                                            <p className=\"font-medium truncate\">{att.title}</p>\r\n                                            <p className=\"text-[10px] text-muted-foreground\">Document</p>\r\n                                        </div>\r\n                                    </div>\r\n                                ))}\r\n\r\n                                <span className=\"text-[10px] text-muted-foreground\">\r\n                                    {msg.timestamp.getHours()}:{msg.timestamp.getMinutes().toString().padStart(2, '0')}\r\n                                </span>\r\n                            </div>\r\n                        </div>\r\n                    ))}\r\n                </div>\r\n            </ScrollArea>\r\n\r\n            {/* Input Area */}\r\n            <div className=\"p-4 border-t bg-background\">\r\n                <div className=\"flex items-end gap-2 bg-muted/20 p-2 rounded-lg border focus-within:ring-1 focus-within:ring-ring transition-all\">\r\n                    <Button variant=\"ghost\" size=\"icon\" className=\"h-8 w-8 text-muted-foreground flex-shrink-0\">\r\n                        <Paperclip className=\"h-4 w-4\" />\r\n                    </Button>\r\n                    <Input\r\n                        className=\"border-none bg-transparent shadow-none focus-visible:ring-0 min-h-[40px] px-2\"\r\n                        placeholder=\"Type a message...\"\r\n                        value={message}\r\n                        onChange={(e) => setMessage(e.target.value)}\r\n                        onKeyDown={(e) => e.key === 'Enter' && handleSend()}\r\n                    />\r\n                    <Button variant=\"ghost\" size=\"icon\" className=\"h-8 w-8 text-muted-foreground flex-shrink-0\">\r\n                        <Smile className=\"h-4 w-4\" />\r\n                    </Button>\r\n                    <Button\r\n                        size=\"icon\"\r\n                        className=\"h-8 w-8 flex-shrink-0\"\r\n                        disabled={!message.trim()}\r\n                        onClick={handleSend}\r\n                    >\r\n                        <Send className=\"h-4 w-4\" />\r\n                    </Button>\r\n                </div>\r\n            </div>\r\n        </div>\r\n    )\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"D:\\Desktop\\LawClick_NEW\\lawclick-next\\src\\components\\features\\index.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\Desktop\\LawClick_NEW\\lawclick-next\\src\\components\\features\\new-case-wizard.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\Desktop\\LawClick_NEW\\lawclick-next\\src\\components\\features\\rbac-verification.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\Desktop\\LawClick_NEW\\lawclick-next\\src\\components\\features\\team-heatmap.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\Desktop\\LawClick_NEW\\lawclick-next\\src\\components\\features\\timesheet\\timesheet-calendar.tsx","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":69,"column":55,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":69,"endColumn":58,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[2115,2118],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[2115,2118],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\"\n\nimport * as React from \"react\"\nimport { ChevronLeft, ChevronRight, Clock, Loader2 } from \"lucide-react\"\n\nimport { getMyTimeLogs } from \"@/actions/timelogs-crud\"\nimport { Button } from \"@/components/ui/button\"\nimport { Card, CardContent, CardHeader, CardTitle } from \"@/components/ui/card\"\nimport { cn } from \"@/lib/utils\"\n\ntype TimesheetEntry = {\n    id: string\n    day: number // 1..5 (Mon..Fri)\n    startHour: number\n    startMinute: number\n    durationHours: number\n    title: string\n    color: string\n}\n\nconst HOURS = Array.from({ length: 11 }, (_, i) => i + 8) // 8:00 to 18:00\nconst DAYS = [\"Mon\", \"Tue\", \"Wed\", \"Thu\", \"Fri\"]\n\nfunction startOfWeekMonday(date: Date) {\n    const d = new Date(date)\n    const day = d.getDay()\n    const diffToMonday = (day + 6) % 7\n    d.setDate(d.getDate() - diffToMonday)\n    d.setHours(0, 0, 0, 0)\n    return d\n}\n\nfunction addDays(date: Date, days: number) {\n    const d = new Date(date)\n    d.setDate(d.getDate() + days)\n    return d\n}\n\nfunction formatWeekLabel(weekStart: Date) {\n    const weekEnd = addDays(weekStart, 6)\n    const startLabel = weekStart.toLocaleDateString(\"zh-CN\", { month: \"short\", day: \"numeric\" })\n    const endLabel = weekEnd.toLocaleDateString(\"zh-CN\", { month: \"short\", day: \"numeric\" })\n    return `${startLabel} - ${endLabel}`\n}\n\nexport function TimesheetCalendar() {\n    const [currentWeek, setCurrentWeek] = React.useState(() => new Date())\n    const [loading, setLoading] = React.useState(true)\n    const [entries, setEntries] = React.useState<TimesheetEntry[]>([])\n\n    const load = React.useCallback(async () => {\n        setLoading(true)\n        const weekStart = startOfWeekMonday(currentWeek)\n        const weekEnd = addDays(weekStart, 7)\n\n        const res = await getMyTimeLogs({\n            from: weekStart.toISOString(),\n            to: weekEnd.toISOString(),\n            status: [\"COMPLETED\", \"APPROVED\", \"BILLED\"],\n            take: 500,\n        })\n\n        if (!res.success) {\n            setEntries([])\n            setLoading(false)\n            return\n        }\n\n        const mapped: TimesheetEntry[] = (res.data as any[])\n            .map((log) => {\n                const start = new Date(log.startTime)\n                const dayIndex = ((start.getDay() + 6) % 7) + 1 // Mon=1 ... Sun=7\n                if (dayIndex < 1 || dayIndex > 5) return null\n\n                return {\n                    id: log.id,\n                    day: dayIndex,\n                    startHour: start.getHours(),\n                    startMinute: start.getMinutes(),\n                    durationHours: (log.duration || 0) / 3600,\n                    title: log.case ? `${log.case.caseCode} · ${log.description}` : log.description,\n                    color: log.isBillable\n                        ? \"bg-blue-100 border-blue-200 text-blue-800\"\n                        : \"bg-slate-100 border-slate-200 text-slate-800\",\n                } satisfies TimesheetEntry\n            })\n            .filter(Boolean) as TimesheetEntry[]\n\n        setEntries(mapped)\n        setLoading(false)\n    }, [currentWeek])\n\n    React.useEffect(() => {\n        load()\n    }, [load])\n\n    const weekStart = startOfWeekMonday(currentWeek)\n\n    return (\n        <Card className=\"h-full\">\n            <CardHeader className=\"flex flex-row items-center justify-between space-y-0 pb-2 border-b\">\n                <div className=\"flex items-center gap-2\">\n                    <Clock className=\"h-5 w-5 text-muted-foreground\" />\n                    <CardTitle className=\"text-base font-semibold\">Weekly Timesheet</CardTitle>\n                </div>\n                <div className=\"flex items-center gap-2\">\n                    <Button\n                        variant=\"outline\"\n                        size=\"icon\"\n                        className=\"h-7 w-7\"\n                        onClick={() => setCurrentWeek((d) => addDays(d, -7))}\n                    >\n                        <ChevronLeft className=\"h-4 w-4\" />\n                    </Button>\n                    <span className=\"text-sm font-medium w-40 text-center\">{formatWeekLabel(weekStart)}</span>\n                    <Button\n                        variant=\"outline\"\n                        size=\"icon\"\n                        className=\"h-7 w-7\"\n                        onClick={() => setCurrentWeek((d) => addDays(d, 7))}\n                    >\n                        <ChevronRight className=\"h-4 w-4\" />\n                    </Button>\n                </div>\n            </CardHeader>\n            <CardContent className=\"p-0 overflow-auto\">\n                <div className=\"min-w-[600px]\">\n                    <div className=\"flex border-b\">\n                        <div className=\"w-16 flex-shrink-0 border-r bg-muted/30\"></div>\n                        {DAYS.map((day, i) => (\n                            <div\n                                key={day}\n                                className=\"flex-1 text-center py-2 text-sm font-medium border-r last:border-r-0 bg-muted/10\"\n                            >\n                                {day}{\" \"}\n                                <span className=\"text-muted-foreground font-normal ml-1\">\n                                    {addDays(weekStart, i).getDate()}\n                                </span>\n                            </div>\n                        ))}\n                    </div>\n\n                    <div className=\"relative\">\n                        {HOURS.map((hour) => (\n                            <div key={hour} className=\"flex h-16 border-b last:border-b-0\">\n                                <div className=\"w-16 flex-shrink-0 border-r bg-muted/5 text-xs text-muted-foreground p-1 text-right\">\n                                    {hour}:00\n                                </div>\n                                {DAYS.map((day) => (\n                                    <div key={day} className=\"flex-1 border-r last:border-r-0 relative\"></div>\n                                ))}\n                            </div>\n                        ))}\n\n                        {loading ? (\n                            <div className=\"absolute inset-0 flex items-center justify-center bg-background/70\">\n                                <Loader2 className=\"h-5 w-5 animate-spin text-muted-foreground\" />\n                            </div>\n                        ) : (\n                            entries.map((entry) => {\n                                const topOffset =\n                                    (entry.startHour - 8) * 64 + (entry.startMinute / 60) * 64\n                                const height = entry.durationHours * 64\n                                const leftPercent = ((entry.day - 1) / 5) * 100\n                                const widthPercent = (1 / 5) * 100\n\n                                return (\n                                    <div\n                                        key={entry.id}\n                                        className={cn(\n                                            \"absolute rounded mt-px mx-px p-2 text-xs font-medium cursor-pointer hover:brightness-95 transition-all shadow-sm flex flex-col items-start justify-center border\",\n                                            entry.color\n                                        )}\n                                        style={{\n                                            top: `${topOffset}px`,\n                                            height: `${Math.max(20, height - 2)}px`,\n                                            left: `calc(4rem + ${leftPercent}%)`,\n                                            width: `calc(${widthPercent}% - 2px)`,\n                                        }}\n                                        title={entry.title}\n                                    >\n                                        <span className=\"font-bold line-clamp-2\">{entry.title}</span>\n                                    </div>\n                                )\n                            })\n                        )}\n                    </div>\n                </div>\n            </CardContent>\n        </Card>\n    )\n}\n\n","usedDeprecatedRules":[]},{"filePath":"D:\\Desktop\\LawClick_NEW\\lawclick-next\\src\\components\\finance\\CreateContractDialog.tsx","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":41,"column":52,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":41,"endColumn":55,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1420,1423],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1420,1423],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":201,"column":60,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":201,"endColumn":63,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[8884,8887],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[8884,8887],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'e' is defined but never used.","line":218,"column":38,"nodeType":null,"messageId":"unusedVar","endLine":218,"endColumn":39}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":3,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\"\n\nimport { useMemo, useState } from \"react\"\nimport { useRouter } from \"next/navigation\"\nimport { toast } from \"sonner\"\nimport { FileText } from \"lucide-react\"\n\nimport { createContract } from \"@/actions/contract-actions\"\nimport { getCases } from \"@/actions/cases\"\nimport { Button } from \"@/components/ui/button\"\nimport { Dialog, DialogContent, DialogFooter, DialogHeader, DialogTitle, DialogTrigger } from \"@/components/ui/dialog\"\nimport { Input } from \"@/components/ui/input\"\nimport { Label } from \"@/components/ui/label\"\nimport { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from \"@/components/ui/select\"\nimport { Textarea } from \"@/components/ui/textarea\"\n\nconst STATUS_OPTIONS = [\n    { value: \"DRAFT\", label: \"草稿\" },\n    { value: \"SIGNED\", label: \"已签署\" },\n    { value: \"ACTIVE\", label: \"生效中\" },\n    { value: \"EXPIRED\", label: \"已到期\" },\n    { value: \"CANCELLED\", label: \"已作废\" },\n] as const\n\nexport function CreateContractDialog({\n    caseId: initialCaseId,\n    triggerLabel = \"创建合同\",\n    triggerVariant = \"outline\",\n    onSuccess,\n}: {\n    caseId?: string\n    triggerLabel?: string\n    triggerVariant?: \"default\" | \"outline\"\n    onSuccess?: () => void\n}) {\n    const router = useRouter()\n    const [open, setOpen] = useState(false)\n    const [creating, setCreating] = useState(false)\n\n    const [caseQuery, setCaseQuery] = useState(\"\")\n    const [caseResults, setCaseResults] = useState<any[]>([])\n    const [pickedCaseId, setPickedCaseId] = useState<string | undefined>(initialCaseId)\n    const [pickedCaseLabel, setPickedCaseLabel] = useState<string>(\"\")\n\n    const [form, setForm] = useState({\n        title: \"\",\n        status: \"DRAFT\",\n        amount: \"\",\n        signedAt: \"\",\n        startDate: \"\",\n        endDate: \"\",\n        notes: \"\",\n    })\n\n    const canCreate = useMemo(() => form.title.trim().length > 2, [form.title])\n\n    const searchCases = async (q: string) => {\n        setCaseQuery(q)\n        const query = q.trim()\n        if (query.length < 2) {\n            setCaseResults([])\n            return\n        }\n        try {\n            const rows = await getCases(query, \"all\", \"all\")\n            setCaseResults((rows || []).slice(0, 10))\n        } catch {\n            setCaseResults([])\n        }\n    }\n\n    return (\n        <Dialog\n            open={open}\n            onOpenChange={(v) => {\n                setOpen(v)\n                if (v) setPickedCaseId(initialCaseId)\n            }}\n        >\n            <DialogTrigger asChild>\n                <Button variant={triggerVariant}>\n                    <FileText className=\"h-4 w-4 mr-2\" />\n                    {triggerLabel}\n                </Button>\n            </DialogTrigger>\n            <DialogContent className=\"sm:max-w-[760px]\">\n                <DialogHeader>\n                    <DialogTitle>创建合同台账</DialogTitle>\n                </DialogHeader>\n\n                {!initialCaseId ? (\n                    <div className=\"space-y-2\">\n                        <Label>关联案件（可选）</Label>\n                        {pickedCaseId ? (\n                            <div className=\"flex items-center justify-between rounded-md border px-3 py-2\">\n                                <div className=\"text-sm\">{pickedCaseLabel || pickedCaseId}</div>\n                                <Button\n                                    variant=\"ghost\"\n                                    size=\"sm\"\n                                    onClick={() => {\n                                        setPickedCaseId(undefined)\n                                        setPickedCaseLabel(\"\")\n                                    }}\n                                >\n                                    清除\n                                </Button>\n                            </div>\n                        ) : (\n                            <div className=\"space-y-2\">\n                                <Input value={caseQuery} onChange={(e) => searchCases(e.target.value)} placeholder=\"搜索案件（标题/案号/客户）\" />\n                                {caseResults.length > 0 ? (\n                                    <div className=\"max-h-40 overflow-auto rounded-md border bg-white/50 p-2 space-y-1\">\n                                        {caseResults.map((c) => (\n                                            <button\n                                                key={c.id}\n                                                type=\"button\"\n                                                className=\"w-full text-left text-sm px-2 py-1 rounded hover:bg-slate-50\"\n                                                onClick={() => {\n                                                    setPickedCaseId(c.id)\n                                                    setPickedCaseLabel(`${c.caseCode ? c.caseCode + \" · \" : \"\"}${c.title}`)\n                                                    setCaseResults([])\n                                                    setCaseQuery(\"\")\n                                                }}\n                                            >\n                                                {c.caseCode ? `${c.caseCode} · ` : \"\"}\n                                                {c.title}\n                                            </button>\n                                        ))}\n                                    </div>\n                                ) : null}\n                            </div>\n                        )}\n                    </div>\n                ) : null}\n\n                <div className=\"grid grid-cols-1 md:grid-cols-2 gap-4\">\n                    <div className=\"space-y-2 md:col-span-2\">\n                        <Label>标题</Label>\n                        <Input value={form.title} onChange={(e) => setForm((p) => ({ ...p, title: e.target.value }))} placeholder=\"例如：委托代理合同 / 尽调服务合同\" />\n                    </div>\n\n                    <div className=\"space-y-2\">\n                        <Label>状态</Label>\n                        <Select value={form.status} onValueChange={(v) => setForm((p) => ({ ...p, status: v }))}>\n                            <SelectTrigger>\n                                <SelectValue placeholder=\"选择状态\" />\n                            </SelectTrigger>\n                            <SelectContent>\n                                {STATUS_OPTIONS.map((o) => (\n                                    <SelectItem key={o.value} value={o.value}>\n                                        {o.label}\n                                    </SelectItem>\n                                ))}\n                            </SelectContent>\n                        </Select>\n                    </div>\n\n                    <div className=\"space-y-2\">\n                        <Label>金额（可选）</Label>\n                        <Input value={form.amount} onChange={(e) => setForm((p) => ({ ...p, amount: e.target.value }))} placeholder=\"例如：500000\" />\n                    </div>\n\n                    <div className=\"space-y-2\">\n                        <Label>签署日期（可选）</Label>\n                        <Input type=\"date\" value={form.signedAt} onChange={(e) => setForm((p) => ({ ...p, signedAt: e.target.value }))} />\n                    </div>\n\n                    <div className=\"space-y-2\">\n                        <Label>开始日期（可选）</Label>\n                        <Input type=\"date\" value={form.startDate} onChange={(e) => setForm((p) => ({ ...p, startDate: e.target.value }))} />\n                    </div>\n\n                    <div className=\"space-y-2\">\n                        <Label>结束日期（可选）</Label>\n                        <Input type=\"date\" value={form.endDate} onChange={(e) => setForm((p) => ({ ...p, endDate: e.target.value }))} />\n                    </div>\n\n                    <div className=\"space-y-2 md:col-span-2\">\n                        <Label>备注（可选）</Label>\n                        <Textarea value={form.notes} onChange={(e) => setForm((p) => ({ ...p, notes: e.target.value }))} rows={3} />\n                    </div>\n                </div>\n\n                <DialogFooter>\n                    <Button variant=\"outline\" onClick={() => setOpen(false)} disabled={creating}>\n                        取消\n                    </Button>\n                    <Button\n                        disabled={!canCreate || creating}\n                        onClick={async () => {\n                            setCreating(true)\n                            try {\n                                const amount = form.amount.trim() ? Number(form.amount.trim()) : undefined\n                                if (form.amount.trim() && (!Number.isFinite(amount) || amount! < 0)) {\n                                    toast.error(\"金额格式不正确\")\n                                    return\n                                }\n\n                                const res = await createContract({\n                                    title: form.title.trim(),\n                                    status: form.status as any,\n                                    amount,\n                                    signedAt: form.signedAt ? new Date(form.signedAt + \"T00:00:00\") : null,\n                                    startDate: form.startDate ? new Date(form.startDate + \"T00:00:00\") : null,\n                                    endDate: form.endDate ? new Date(form.endDate + \"T00:00:00\") : null,\n                                    notes: form.notes.trim() || undefined,\n                                    caseId: initialCaseId || pickedCaseId,\n                                })\n                                if (!res.success) {\n                                    toast.error(\"创建失败\", { description: res.error })\n                                    return\n                                }\n                                toast.success(\"已创建合同\")\n                                setOpen(false)\n                                setForm({ title: \"\", status: \"DRAFT\", amount: \"\", signedAt: \"\", startDate: \"\", endDate: \"\", notes: \"\" })\n                                router.refresh()\n                                onSuccess?.()\n                            } catch (e) {\n                                toast.error(\"创建失败\")\n                            } finally {\n                                setCreating(false)\n                            }\n                        }}\n                    >\n                        {creating ? \"创建中...\" : \"创建\"}\n                    </Button>\n                </DialogFooter>\n            </DialogContent>\n        </Dialog>\n    )\n}\n","usedDeprecatedRules":[]},{"filePath":"D:\\Desktop\\LawClick_NEW\\lawclick-next\\src\\components\\finance\\CreateExpenseDialog.tsx","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":32,"column":52,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":32,"endColumn":55,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1079,1082],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1079,1082],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'e' is defined but never used.","line":196,"column":38,"nodeType":null,"messageId":"unusedVar","endLine":196,"endColumn":39}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":2,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\"\n\nimport { useMemo, useState } from \"react\"\nimport { useRouter } from \"next/navigation\"\nimport { toast } from \"sonner\"\nimport { Receipt } from \"lucide-react\"\n\nimport { createExpense } from \"@/actions/finance-actions\"\nimport { getCases } from \"@/actions/cases\"\nimport { Button } from \"@/components/ui/button\"\nimport { Dialog, DialogContent, DialogFooter, DialogHeader, DialogTitle, DialogTrigger } from \"@/components/ui/dialog\"\nimport { Input } from \"@/components/ui/input\"\nimport { Label } from \"@/components/ui/label\"\nimport { Textarea } from \"@/components/ui/textarea\"\n\nexport function CreateExpenseDialog({\n    caseId: initialCaseId,\n    triggerLabel = \"记录费用\",\n    triggerVariant = \"outline\",\n    onSuccess,\n}: {\n    caseId?: string\n    triggerLabel?: string\n    triggerVariant?: \"default\" | \"outline\"\n    onSuccess?: () => void\n}) {\n    const router = useRouter()\n    const [open, setOpen] = useState(false)\n    const [creating, setCreating] = useState(false)\n\n    const [caseQuery, setCaseQuery] = useState(\"\")\n    const [caseResults, setCaseResults] = useState<any[]>([])\n    const [pickedCaseId, setPickedCaseId] = useState<string | undefined>(initialCaseId)\n    const [pickedCaseLabel, setPickedCaseLabel] = useState<string>(\"\")\n\n    const [form, setForm] = useState({\n        category: \"\",\n        amount: \"\",\n        expenseDate: new Date().toISOString().slice(0, 10),\n        description: \"\",\n    })\n\n    const canCreate = useMemo(() => {\n        const amount = Number(form.amount)\n        return form.category.trim().length > 1 && Number.isFinite(amount) && amount > 0\n    }, [form.category, form.amount])\n\n    const searchCases = async (q: string) => {\n        setCaseQuery(q)\n        const query = q.trim()\n        if (query.length < 2) {\n            setCaseResults([])\n            return\n        }\n        try {\n            const rows = await getCases(query, \"all\", \"all\")\n            setCaseResults((rows || []).slice(0, 10))\n        } catch {\n            setCaseResults([])\n        }\n    }\n\n    return (\n        <Dialog\n            open={open}\n            onOpenChange={(v) => {\n                setOpen(v)\n                if (v) setPickedCaseId(initialCaseId)\n            }}\n        >\n            <DialogTrigger asChild>\n                <Button variant={triggerVariant}>\n                    <Receipt className=\"h-4 w-4 mr-2\" />\n                    {triggerLabel}\n                </Button>\n            </DialogTrigger>\n            <DialogContent className=\"sm:max-w-[720px]\">\n                <DialogHeader>\n                    <DialogTitle>记录费用</DialogTitle>\n                </DialogHeader>\n\n                {!initialCaseId ? (\n                    <div className=\"space-y-2\">\n                        <Label>关联案件（可选）</Label>\n                        {pickedCaseId ? (\n                            <div className=\"flex items-center justify-between rounded-md border px-3 py-2\">\n                                <div className=\"text-sm\">{pickedCaseLabel || pickedCaseId}</div>\n                                <Button\n                                    variant=\"ghost\"\n                                    size=\"sm\"\n                                    onClick={() => {\n                                        setPickedCaseId(undefined)\n                                        setPickedCaseLabel(\"\")\n                                    }}\n                                >\n                                    清除\n                                </Button>\n                            </div>\n                        ) : (\n                            <div className=\"space-y-2\">\n                                <Input\n                                    value={caseQuery}\n                                    onChange={(e) => searchCases(e.target.value)}\n                                    placeholder=\"搜索案件（标题/案号/客户）\"\n                                />\n                                {caseResults.length > 0 ? (\n                                    <div className=\"max-h-40 overflow-auto rounded-md border bg-white/50 p-2 space-y-1\">\n                                        {caseResults.map((c) => (\n                                            <button\n                                                key={c.id}\n                                                type=\"button\"\n                                                className=\"w-full text-left text-sm px-2 py-1 rounded hover:bg-slate-50\"\n                                                onClick={() => {\n                                                    setPickedCaseId(c.id)\n                                                    setPickedCaseLabel(`${c.caseCode ? c.caseCode + \" · \" : \"\"}${c.title}`)\n                                                    setCaseResults([])\n                                                    setCaseQuery(\"\")\n                                                }}\n                                            >\n                                                {c.caseCode ? `${c.caseCode} · ` : \"\"}\n                                                {c.title}\n                                            </button>\n                                        ))}\n                                    </div>\n                                ) : null}\n                            </div>\n                        )}\n                    </div>\n                ) : null}\n\n                <div className=\"grid grid-cols-1 md:grid-cols-2 gap-4\">\n                    <div className=\"space-y-2\">\n                        <Label>类别</Label>\n                        <Input\n                            value={form.category}\n                            onChange={(e) => setForm((p) => ({ ...p, category: e.target.value }))}\n                            placeholder=\"例如：差旅-交通 / 复印 / 快递\"\n                        />\n                    </div>\n                    <div className=\"space-y-2\">\n                        <Label>金额</Label>\n                        <Input\n                            value={form.amount}\n                            onChange={(e) => setForm((p) => ({ ...p, amount: e.target.value }))}\n                            placeholder=\"例如：860\"\n                        />\n                    </div>\n                    <div className=\"space-y-2\">\n                        <Label>发生日期</Label>\n                        <Input\n                            type=\"date\"\n                            value={form.expenseDate}\n                            onChange={(e) => setForm((p) => ({ ...p, expenseDate: e.target.value }))}\n                        />\n                    </div>\n                    <div className=\"space-y-2 md:col-span-2\">\n                        <Label>说明（可选）</Label>\n                        <Textarea\n                            value={form.description}\n                            onChange={(e) => setForm((p) => ({ ...p, description: e.target.value }))}\n                            rows={3}\n                        />\n                    </div>\n                </div>\n\n                <DialogFooter>\n                    <Button variant=\"outline\" onClick={() => setOpen(false)} disabled={creating}>\n                        取消\n                    </Button>\n                    <Button\n                        disabled={!canCreate || creating}\n                        onClick={async () => {\n                            setCreating(true)\n                            try {\n                                const amount = Number(form.amount)\n                                if (!Number.isFinite(amount) || amount <= 0) {\n                                    toast.error(\"金额格式不正确\")\n                                    return\n                                }\n                                const res = await createExpense({\n                                    caseId: initialCaseId || pickedCaseId,\n                                    category: form.category.trim(),\n                                    amount,\n                                    description: form.description.trim() || undefined,\n                                    expenseDate: new Date(form.expenseDate + \"T00:00:00\"),\n                                })\n                                if (!res.success) {\n                                    toast.error(\"创建失败\", { description: res.error })\n                                    return\n                                }\n                                toast.success(\"已记录费用\")\n                                setOpen(false)\n                                setForm({ category: \"\", amount: \"\", expenseDate: new Date().toISOString().slice(0, 10), description: \"\" })\n                                router.refresh()\n                                onSuccess?.()\n                            } catch (e) {\n                                toast.error(\"创建失败\")\n                            } finally {\n                                setCreating(false)\n                            }\n                        }}\n                    >\n                        {creating ? \"保存中...\" : \"保存\"}\n                    </Button>\n                </DialogFooter>\n            </DialogContent>\n        </Dialog>\n    )\n}\n","usedDeprecatedRules":[]},{"filePath":"D:\\Desktop\\LawClick_NEW\\lawclick-next\\src\\components\\finance\\CreateInvoiceDialog.tsx","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":32,"column":52,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":32,"endColumn":55,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1076,1079],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1076,1079],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'e' is defined but never used.","line":208,"column":38,"nodeType":null,"messageId":"unusedVar","endLine":208,"endColumn":39}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":2,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\"\n\nimport { useMemo, useState } from \"react\"\nimport { useRouter } from \"next/navigation\"\nimport { toast } from \"sonner\"\nimport { Plus } from \"lucide-react\"\n\nimport { createInvoice } from \"@/actions/finance-actions\"\nimport { getCases } from \"@/actions/cases\"\nimport { Button } from \"@/components/ui/button\"\nimport { Dialog, DialogContent, DialogFooter, DialogHeader, DialogTitle, DialogTrigger } from \"@/components/ui/dialog\"\nimport { Input } from \"@/components/ui/input\"\nimport { Label } from \"@/components/ui/label\"\nimport { Textarea } from \"@/components/ui/textarea\"\n\nexport function CreateInvoiceDialog({\n    caseId: initialCaseId,\n    triggerLabel = \"创建发票\",\n    triggerVariant = \"default\",\n    onSuccess,\n}: {\n    caseId?: string\n    triggerLabel?: string\n    triggerVariant?: \"default\" | \"outline\"\n    onSuccess?: () => void\n}) {\n    const router = useRouter()\n    const [open, setOpen] = useState(false)\n    const [creating, setCreating] = useState(false)\n\n    const [caseQuery, setCaseQuery] = useState(\"\")\n    const [caseResults, setCaseResults] = useState<any[]>([])\n    const [pickedCaseId, setPickedCaseId] = useState<string | undefined>(initialCaseId)\n    const [pickedCaseLabel, setPickedCaseLabel] = useState<string>(\"\")\n\n    const [form, setForm] = useState({\n        amount: \"\",\n        tax: \"\",\n        dueDate: \"\",\n        description: \"\",\n    })\n\n    const canCreate = useMemo(() => {\n        const amount = Number(form.amount)\n        return Number.isFinite(amount) && amount > 0\n    }, [form.amount])\n\n    const searchCases = async (q: string) => {\n        setCaseQuery(q)\n        const query = q.trim()\n        if (query.length < 2) {\n            setCaseResults([])\n            return\n        }\n        try {\n            const rows = await getCases(query, \"all\", \"all\")\n            setCaseResults((rows || []).slice(0, 10))\n        } catch {\n            setCaseResults([])\n        }\n    }\n\n    return (\n        <Dialog\n            open={open}\n            onOpenChange={(v) => {\n                setOpen(v)\n                if (v) {\n                    setPickedCaseId(initialCaseId)\n                }\n            }}\n        >\n            <DialogTrigger asChild>\n                <Button variant={triggerVariant}>\n                    <Plus className=\"h-4 w-4 mr-2\" />\n                    {triggerLabel}\n                </Button>\n            </DialogTrigger>\n            <DialogContent className=\"sm:max-w-[720px]\">\n                <DialogHeader>\n                    <DialogTitle>创建发票</DialogTitle>\n                </DialogHeader>\n\n                {!initialCaseId ? (\n                    <div className=\"space-y-2\">\n                        <Label>关联案件（可选）</Label>\n                        {pickedCaseId ? (\n                            <div className=\"flex items-center justify-between rounded-md border px-3 py-2\">\n                                <div className=\"text-sm\">{pickedCaseLabel || pickedCaseId}</div>\n                                <Button\n                                    variant=\"ghost\"\n                                    size=\"sm\"\n                                    onClick={() => {\n                                        setPickedCaseId(undefined)\n                                        setPickedCaseLabel(\"\")\n                                    }}\n                                >\n                                    清除\n                                </Button>\n                            </div>\n                        ) : (\n                            <div className=\"space-y-2\">\n                                <Input\n                                    value={caseQuery}\n                                    onChange={(e) => searchCases(e.target.value)}\n                                    placeholder=\"搜索案件（标题/案号/客户）\"\n                                />\n                                {caseResults.length > 0 ? (\n                                    <div className=\"max-h-40 overflow-auto rounded-md border bg-white/50 p-2 space-y-1\">\n                                        {caseResults.map((c) => (\n                                            <button\n                                                key={c.id}\n                                                type=\"button\"\n                                                className=\"w-full text-left text-sm px-2 py-1 rounded hover:bg-slate-50\"\n                                                onClick={() => {\n                                                    setPickedCaseId(c.id)\n                                                    setPickedCaseLabel(`${c.caseCode ? c.caseCode + \" · \" : \"\"}${c.title}`)\n                                                    setCaseResults([])\n                                                    setCaseQuery(\"\")\n                                                }}\n                                            >\n                                                {c.caseCode ? `${c.caseCode} · ` : \"\"}\n                                                {c.title}\n                                            </button>\n                                        ))}\n                                    </div>\n                                ) : null}\n                            </div>\n                        )}\n                    </div>\n                ) : null}\n\n                <div className=\"grid grid-cols-1 md:grid-cols-2 gap-4\">\n                    <div className=\"space-y-2\">\n                        <Label>发票金额</Label>\n                        <Input\n                            value={form.amount}\n                            onChange={(e) => setForm((p) => ({ ...p, amount: e.target.value }))}\n                            placeholder=\"例如：50000\"\n                        />\n                    </div>\n                    <div className=\"space-y-2\">\n                        <Label>税额（可选）</Label>\n                        <Input\n                            value={form.tax}\n                            onChange={(e) => setForm((p) => ({ ...p, tax: e.target.value }))}\n                            placeholder=\"例如：3000\"\n                        />\n                    </div>\n                    <div className=\"space-y-2\">\n                        <Label>付款截止（可选）</Label>\n                        <Input\n                            type=\"date\"\n                            value={form.dueDate}\n                            onChange={(e) => setForm((p) => ({ ...p, dueDate: e.target.value }))}\n                        />\n                    </div>\n                    <div className=\"space-y-2 md:col-span-2\">\n                        <Label>说明（可选）</Label>\n                        <Textarea\n                            value={form.description}\n                            onChange={(e) => setForm((p) => ({ ...p, description: e.target.value }))}\n                            rows={3}\n                            placeholder=\"例如：阶段性代理费（第一期）\"\n                        />\n                    </div>\n                </div>\n\n                <DialogFooter>\n                    <Button variant=\"outline\" onClick={() => setOpen(false)} disabled={creating}>\n                        取消\n                    </Button>\n                    <Button\n                        disabled={!canCreate || creating}\n                        onClick={async () => {\n                            setCreating(true)\n                            try {\n                                const amount = Number(form.amount)\n                                const tax = form.tax.trim() ? Number(form.tax) : undefined\n                                if (!Number.isFinite(amount) || amount <= 0) {\n                                    toast.error(\"金额格式不正确\")\n                                    return\n                                }\n                                if (form.tax.trim() && (!Number.isFinite(tax) || tax! < 0)) {\n                                    toast.error(\"税额格式不正确\")\n                                    return\n                                }\n\n                                const dueDate = form.dueDate ? new Date(form.dueDate + \"T00:00:00\") : undefined\n                                const res = await createInvoice({\n                                    caseId: initialCaseId || pickedCaseId,\n                                    amount,\n                                    tax,\n                                    description: form.description.trim() || undefined,\n                                    dueDate,\n                                })\n\n                                if (!res.success) {\n                                    toast.error(\"创建失败\", { description: res.error })\n                                    return\n                                }\n\n                                toast.success(\"已创建发票\")\n                                setOpen(false)\n                                setForm({ amount: \"\", tax: \"\", dueDate: \"\", description: \"\" })\n                                router.refresh()\n                                onSuccess?.()\n                            } catch (e) {\n                                toast.error(\"创建失败\")\n                            } finally {\n                                setCreating(false)\n                            }\n                        }}\n                    >\n                        {creating ? \"创建中...\" : \"创建\"}\n                    </Button>\n                </DialogFooter>\n            </DialogContent>\n        </Dialog>\n    )\n}\n","usedDeprecatedRules":[]},{"filePath":"D:\\Desktop\\LawClick_NEW\\lawclick-next\\src\\components\\finance\\RecordPaymentDialog.tsx","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":131,"column":60,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":131,"endColumn":63,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[5354,5357],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[5354,5357],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'e' is defined but never used.","line":151,"column":38,"nodeType":null,"messageId":"unusedVar","endLine":151,"endColumn":39}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":2,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\"\n\nimport { useMemo, useState } from \"react\"\nimport { useRouter } from \"next/navigation\"\nimport { toast } from \"sonner\"\nimport { DollarSign } from \"lucide-react\"\n\nimport { recordPayment } from \"@/actions/finance-actions\"\nimport { Button } from \"@/components/ui/button\"\nimport { Dialog, DialogContent, DialogFooter, DialogHeader, DialogTitle, DialogTrigger } from \"@/components/ui/dialog\"\nimport { Input } from \"@/components/ui/input\"\nimport { Label } from \"@/components/ui/label\"\nimport { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from \"@/components/ui/select\"\nimport { Textarea } from \"@/components/ui/textarea\"\n\nconst PAYMENT_METHODS = [\n    { value: \"BANK\", label: \"银行转账\" },\n    { value: \"CASH\", label: \"现金\" },\n    { value: \"CHECK\", label: \"支票\" },\n    { value: \"ONLINE\", label: \"在线支付\" },\n    { value: \"OTHER\", label: \"其他\" },\n] as const\n\nexport function RecordPaymentDialog({\n    invoiceId,\n    triggerLabel = \"收款\",\n    onSuccess,\n}: {\n    invoiceId: string\n    triggerLabel?: string\n    onSuccess?: () => void\n}) {\n    const router = useRouter()\n    const [open, setOpen] = useState(false)\n    const [saving, setSaving] = useState(false)\n\n    const [form, setForm] = useState({\n        amount: \"\",\n        method: \"BANK\",\n        receivedAt: new Date().toISOString().slice(0, 10),\n        reference: \"\",\n        note: \"\",\n    })\n\n    const canSave = useMemo(() => {\n        const amount = Number(form.amount)\n        return Number.isFinite(amount) && amount > 0\n    }, [form.amount])\n\n    return (\n        <Dialog open={open} onOpenChange={setOpen}>\n            <DialogTrigger asChild>\n                <Button size=\"sm\" className=\"gap-2\">\n                    <DollarSign className=\"h-4 w-4\" />\n                    {triggerLabel}\n                </Button>\n            </DialogTrigger>\n            <DialogContent className=\"sm:max-w-[640px]\">\n                <DialogHeader>\n                    <DialogTitle>记录收款</DialogTitle>\n                </DialogHeader>\n\n                <div className=\"grid grid-cols-1 md:grid-cols-2 gap-4\">\n                    <div className=\"space-y-2\">\n                        <Label>金额</Label>\n                        <Input\n                            value={form.amount}\n                            onChange={(e) => setForm((p) => ({ ...p, amount: e.target.value }))}\n                            placeholder=\"例如：30000\"\n                        />\n                    </div>\n                    <div className=\"space-y-2\">\n                        <Label>方式</Label>\n                        <Select value={form.method} onValueChange={(v) => setForm((p) => ({ ...p, method: v }))}>\n                            <SelectTrigger>\n                                <SelectValue placeholder=\"选择方式\" />\n                            </SelectTrigger>\n                            <SelectContent>\n                                {PAYMENT_METHODS.map((o) => (\n                                    <SelectItem key={o.value} value={o.value}>\n                                        {o.label}\n                                    </SelectItem>\n                                ))}\n                            </SelectContent>\n                        </Select>\n                    </div>\n                    <div className=\"space-y-2\">\n                        <Label>收款日期</Label>\n                        <Input\n                            type=\"date\"\n                            value={form.receivedAt}\n                            onChange={(e) => setForm((p) => ({ ...p, receivedAt: e.target.value }))}\n                        />\n                    </div>\n                    <div className=\"space-y-2\">\n                        <Label>参考号（可选）</Label>\n                        <Input\n                            value={form.reference}\n                            onChange={(e) => setForm((p) => ({ ...p, reference: e.target.value }))}\n                            placeholder=\"银行流水号/收据号\"\n                        />\n                    </div>\n                    <div className=\"space-y-2 md:col-span-2\">\n                        <Label>备注（可选）</Label>\n                        <Textarea\n                            value={form.note}\n                            onChange={(e) => setForm((p) => ({ ...p, note: e.target.value }))}\n                            rows={2}\n                        />\n                    </div>\n                </div>\n\n                <DialogFooter>\n                    <Button variant=\"outline\" onClick={() => setOpen(false)} disabled={saving}>\n                        取消\n                    </Button>\n                    <Button\n                        disabled={!canSave || saving}\n                        onClick={async () => {\n                            setSaving(true)\n                            try {\n                                const amount = Number(form.amount)\n                                if (!Number.isFinite(amount) || amount <= 0) {\n                                    toast.error(\"金额格式不正确\")\n                                    return\n                                }\n                                const receivedAt = new Date(form.receivedAt + \"T00:00:00\")\n                                const res = await recordPayment({\n                                    invoiceId,\n                                    amount,\n                                    method: form.method as any,\n                                    receivedAt,\n                                    reference: form.reference.trim() || undefined,\n                                    note: form.note.trim() || undefined,\n                                })\n                                if (!res.success) {\n                                    toast.error(\"记录失败\", { description: res.error })\n                                    return\n                                }\n                                toast.success(\"已记录收款\")\n                                setOpen(false)\n                                setForm({\n                                    amount: \"\",\n                                    method: \"BANK\",\n                                    receivedAt: new Date().toISOString().slice(0, 10),\n                                    reference: \"\",\n                                    note: \"\",\n                                })\n                                router.refresh()\n                                onSuccess?.()\n                            } catch (e) {\n                                toast.error(\"记录失败\")\n                            } finally {\n                                setSaving(false)\n                            }\n                        }}\n                    >\n                        {saving ? \"保存中...\" : \"保存\"}\n                    </Button>\n                </DialogFooter>\n            </DialogContent>\n        </Dialog>\n    )\n}\n","usedDeprecatedRules":[]},{"filePath":"D:\\Desktop\\LawClick_NEW\\lawclick-next\\src\\components\\floating\\ai-assistant-content.tsx","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":68,"column":34,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":68,"endColumn":37,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1645,1648],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1645,1648],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":95,"column":61,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":95,"endColumn":64,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[2805,2808],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[2805,2808],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has a missing dependency: 'context'. Either include it or remove the dependency array.","line":132,"column":8,"nodeType":"ArrayExpression","endLine":132,"endColumn":20,"suggestions":[{"desc":"Update the dependencies array to be: [context, contextKey]","fix":{"range":[4155,4167],"text":"[context, contextKey]"}}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":148,"column":28,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":148,"endColumn":31,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[4639,4642],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[4639,4642],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":156,"column":41,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":156,"endColumn":44,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[4923,4926],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[4923,4926],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":5,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\"\r\n\r\nimport { useState, useRef, useEffect, useTransition } from \"react\"\r\nimport { Button } from \"@/components/ui/button\"\r\nimport { Input } from \"@/components/ui/input\"\r\nimport { ScrollArea } from \"@/components/ui/scroll-area\"\r\nimport {\r\n    Select,\r\n    SelectContent,\r\n    SelectItem,\r\n    SelectTrigger,\r\n    SelectValue,\r\n} from \"@/components/ui/select\"\r\nimport {\r\n    Send,\r\n    Bot,\r\n    User,\r\n    Sparkles,\r\n    FileText,\r\n    Scale,\r\n    Briefcase,\r\n    Lightbulb,\r\n    RotateCcw,\r\n    Plus,\r\n    History,\r\n    Loader2\r\n} from \"lucide-react\"\r\nimport {\n    getConversations,\n    getConversation,\n    createConversation,\n    createConversationWithContext,\n    chatWithAIEnhanced\n} from \"@/actions/ai-actions\"\nimport type { AIContext } from \"@/actions/ai-actions\"\nimport { Badge } from \"@/components/ui/badge\"\n\r\ninterface Message {\r\n    id: string\r\n    role: \"user\" | \"assistant\"\r\n    content: string\r\n    time: string\r\n}\r\n\r\n// 快捷操作\r\nconst QUICK_ACTIONS = [\r\n    { icon: FileText, label: \"审查合同\", prompt: \"帮我审查一份合同的风险点\" },\r\n    { icon: Scale, label: \"法律研究\", prompt: \"帮我查找相关法律法规\" },\r\n    { icon: Briefcase, label: \"案例检索\", prompt: \"帮我检索类似案例\" },\r\n    { icon: Lightbulb, label: \"策略建议\", prompt: \"本案的诉讼策略建议\" }\r\n]\r\n\r\nconst INITIAL_MESSAGE: Message = {\r\n    id: \"initial\",\r\n    role: \"assistant\",\r\n    content: \"您好！我是您的AI法律助手。我可以帮助您进行法律研究、文书审查、案例检索等工作。有什么可以帮您的吗？\",\r\n    time: new Date().toLocaleTimeString('zh-CN', { hour: '2-digit', minute: '2-digit' })\r\n}\r\n\r\ninterface ConversationSummary {\n    id: string\n    title: string\n    messageCount: number\n    updatedAt: Date\n    context?: AIContext | null\n}\n\nfunction hasAnyContext(context?: any): context is AIContext {\n    if (!context || typeof context !== \"object\") return false\n    return Boolean(\n        context.caseId ||\n        context.documentId ||\n        context.taskId ||\n        context.approvalId ||\n        context.invoiceId ||\n        context.expenseId ||\n        context.contractId\n    )\n}\n\nfunction formatContextBadges(context?: AIContext | null) {\n    if (!context) return []\n    const badges: { key: string; label: string }[] = []\n    if (context.caseId) badges.push({ key: \"caseId\", label: \"案件上下文\" })\n    if (context.documentId) badges.push({ key: \"documentId\", label: \"文档上下文\" })\n    if (context.taskId) badges.push({ key: \"taskId\", label: \"任务上下文\" })\n    if (context.approvalId) badges.push({ key: \"approvalId\", label: \"审批上下文\" })\n    if (context.invoiceId) badges.push({ key: \"invoiceId\", label: \"发票上下文\" })\n    if (context.expenseId) badges.push({ key: \"expenseId\", label: \"费用上下文\" })\n    if (context.contractId) badges.push({ key: \"contractId\", label: \"合同上下文\" })\n    if (context.source) badges.push({ key: \"source\", label: `来源：${context.source}` })\n    return badges\n}\n\nexport function AIAssistantContent({ context }: { context?: any }) {\n    const [messages, setMessages] = useState<Message[]>([INITIAL_MESSAGE])\n    const [input, setInput] = useState(\"\")\n    const [isTyping, setIsTyping] = useState(false)\n    const [conversations, setConversations] = useState<ConversationSummary[]>([])\n    const [currentConversationId, setCurrentConversationId] = useState<string | null>(null)\n    const [activeContext, setActiveContext] = useState<AIContext | null>(null)\n    const [isPending, startTransition] = useTransition()\n    const scrollRef = useRef<HTMLDivElement>(null)\n    const contextKey = JSON.stringify(hasAnyContext(context) ? context : null)\n\r\n    // 加载会话列表\n    useEffect(() => {\n        loadConversations()\n    }, [])\n\n    // 上下文变化：自动创建“带上下文”的新会话（确保可追溯）\n    useEffect(() => {\n        if (!hasAnyContext(context)) {\n            setActiveContext(null)\n            return\n        }\n\n        const nextContext = context as AIContext\n        setActiveContext(nextContext)\n\n        startTransition(async () => {\n            const newId = await createConversationWithContext({\n                ...nextContext,\n                source: nextContext.source || \"floating_ai\",\n            })\n            if (newId) {\n                setCurrentConversationId(newId)\n                setMessages([INITIAL_MESSAGE])\n                await loadConversations()\n            }\n        })\n    }, [contextKey])\n\n    // 滚动到底部\r\n    useEffect(() => {\r\n        if (scrollRef.current) {\r\n            scrollRef.current.scrollTop = scrollRef.current.scrollHeight\r\n        }\r\n    }, [messages])\r\n\r\n    const loadConversations = async () => {\n        const result = await getConversations()\n        setConversations(result.map(c => ({\n            id: c.id,\n            title: c.title,\n            messageCount: c.messageCount,\n            updatedAt: c.updatedAt,\n            context: (c as any).context || null,\n        })))\n    }\n\r\n    const loadConversation = async (conversationId: string) => {\n        const result = await getConversation(conversationId)\n        if (result) {\n            setCurrentConversationId(conversationId)\n            setActiveContext((result as any).context || null)\n            const loaded = (result.messages || []).map((m, i) => ({\n                id: `${conversationId}-${i}`,\n                role: m.role === 'ai' ? 'assistant' as const : 'user' as const,\n                content: m.content,\n                time: new Date(m.timestamp).toLocaleTimeString('zh-CN', { hour: '2-digit', minute: '2-digit' })\n            }))\n            setMessages(loaded.length > 0 ? loaded : [INITIAL_MESSAGE])\n        }\n    }\n\r\n    const handleNewConversation = async () => {\n        startTransition(async () => {\n            const newId = activeContext ? await createConversationWithContext(activeContext) : await createConversation()\n            if (newId) {\n                setCurrentConversationId(newId)\n                setMessages([INITIAL_MESSAGE])\n                await loadConversations()\n            }\n        })\n    }\r\n\r\n    const handleSend = async (text?: string) => {\r\n        const messageText = text || input\r\n        if (!messageText.trim() || isTyping) return\r\n\r\n        // 如果没有会话，先创建一个\r\n        let conversationId = currentConversationId\n        if (!conversationId) {\n            conversationId = activeContext ? await createConversationWithContext(activeContext) : await createConversation()\n            if (conversationId) {\n                setCurrentConversationId(conversationId)\n            }\n        }\n\r\n        // 添加用户消息\r\n        const userMessage: Message = {\r\n            id: Date.now().toString(),\r\n            role: \"user\",\r\n            content: messageText,\r\n            time: new Date().toLocaleTimeString('zh-CN', { hour: '2-digit', minute: '2-digit' })\r\n        }\r\n        setMessages(prev => [...prev, userMessage])\r\n        setInput(\"\")\r\n        setIsTyping(true)\r\n\r\n        try {\n            // 调用真实AI API\n            const result = await chatWithAIEnhanced({\n                message: messageText,\n                conversationId,\n                context: activeContext,\n            })\n\r\n            const aiMessage: Message = {\r\n                id: (Date.now() + 1).toString(),\r\n                role: \"assistant\",\r\n                content: result.response || result.error || \"抱歉，我暂时无法回答这个问题。\",\r\n                time: new Date().toLocaleTimeString('zh-CN', { hour: '2-digit', minute: '2-digit' })\r\n            }\n            setMessages(prev => [...prev, aiMessage])\n        } catch {\n            const errorMessage: Message = {\n                id: (Date.now() + 1).toString(),\n                role: \"assistant\",\n                content: \"抱歉，AI服务暂时不可用，请稍后重试。\",\r\n                time: new Date().toLocaleTimeString('zh-CN', { hour: '2-digit', minute: '2-digit' })\r\n            }\r\n            setMessages(prev => [...prev, errorMessage])\r\n        } finally {\n            setIsTyping(false)\n            await loadConversations()\n        }\n    }\n\r\n    const handleReset = () => {\r\n        setCurrentConversationId(null)\r\n        setMessages([INITIAL_MESSAGE])\r\n    }\r\n\r\n    return (\n        <div className=\"flex flex-col h-full\">\n            {/* 头部：会话选择器 + 快捷操作 */}\n            <div className=\"p-3 border-b bg-gradient-to-r from-orange-50 to-amber-50\">\n                {activeContext && (\n                    <div className=\"flex flex-wrap gap-1.5 mb-2\">\n                        {formatContextBadges(activeContext).map((b) => (\n                            <Badge key={b.key} variant=\"secondary\" className=\"text-[10px] bg-white/80\">\n                                {b.label}\n                            </Badge>\n                        ))}\n                    </div>\n                )}\n                {/* 会话选择器 */}\n                <div className=\"flex items-center gap-2 mb-2\">\n                    <History className=\"h-4 w-4 text-orange-500\" />\n                    <Select\n                        value={currentConversationId || \"new\"}\r\n                        onValueChange={(value) => {\r\n                            if (value === \"new\") {\r\n                                handleNewConversation()\r\n                            } else {\r\n                                loadConversation(value)\r\n                            }\r\n                        }}\r\n                    >\r\n                        <SelectTrigger className=\"h-7 text-xs flex-1 bg-white/80\">\r\n                            <SelectValue placeholder=\"选择会话\" />\r\n                        </SelectTrigger>\r\n                        <SelectContent>\r\n                            <SelectItem value=\"new\">\r\n                                <span className=\"flex items-center gap-1\">\r\n                                    <Plus className=\"h-3 w-3\" /> 新建会话\r\n                                </span>\r\n                            </SelectItem>\r\n                            {conversations.map(conv => (\r\n                                <SelectItem key={conv.id} value={conv.id}>\r\n                                    <span className=\"truncate max-w-[180px]\">{conv.title}</span>\r\n                                </SelectItem>\r\n                            ))}\r\n                        </SelectContent>\r\n                    </Select>\r\n                    {isPending && <Loader2 className=\"h-4 w-4 animate-spin text-orange-500\" />}\r\n                </div>\r\n\r\n                {/* 快捷操作 */}\r\n                <div className=\"flex items-center gap-2 mb-2\">\r\n                    <Sparkles className=\"h-4 w-4 text-orange-500\" />\r\n                    <span className=\"text-xs font-medium text-orange-700\">快捷操作</span>\r\n                </div>\r\n                <div className=\"flex flex-wrap gap-1.5\">\r\n                    {QUICK_ACTIONS.map((action, index) => (\r\n                        <Button\r\n                            key={index}\r\n                            variant=\"outline\"\r\n                            size=\"sm\"\r\n                            className=\"h-7 text-xs bg-white/80 hover:bg-orange-100 hover:text-orange-700 hover:border-orange-200\"\r\n                            onClick={() => handleSend(action.prompt)}\r\n                            disabled={isTyping}\r\n                        >\r\n                            <action.icon className=\"h-3 w-3 mr-1\" />\r\n                            {action.label}\r\n                        </Button>\r\n                    ))}\r\n                </div>\r\n            </div>\r\n\r\n            {/* 消息区域 */}\r\n            <ScrollArea className=\"flex-1 p-3\" ref={scrollRef}>\r\n                <div className=\"space-y-4\">\r\n                    {messages.map((msg) => (\r\n                        <div\r\n                            key={msg.id}\r\n                            className={`flex gap-2 ${msg.role === \"user\" ? \"flex-row-reverse\" : \"\"}`}\r\n                        >\r\n                            <div className={`h-7 w-7 rounded-full flex items-center justify-center shrink-0 ${msg.role === \"assistant\"\r\n                                ? \"bg-gradient-to-br from-orange-400 to-amber-500 text-white\"\r\n                                : \"bg-slate-200\"\r\n                                }`}>\r\n                                {msg.role === \"assistant\" ? (\r\n                                    <Bot className=\"h-4 w-4\" />\r\n                                ) : (\r\n                                    <User className=\"h-4 w-4\" />\r\n                                )}\r\n                            </div>\r\n                            <div className={`max-w-[85%] ${msg.role === \"user\" ? \"text-right\" : \"\"}`}>\r\n                                <div className={`rounded-lg px-3 py-2 text-sm ${msg.role === \"user\"\r\n                                    ? \"bg-primary text-primary-foreground\"\r\n                                    : \"bg-muted\"\r\n                                    }`}>\r\n                                    <p className=\"whitespace-pre-wrap\">{msg.content}</p>\r\n                                </div>\r\n                                <p className={`text-[10px] text-muted-foreground mt-1 ${msg.role === \"user\" ? \"text-right\" : \"\"}`}>\r\n                                    {msg.time}\r\n                                </p>\r\n                            </div>\r\n                        </div>\r\n                    ))}\r\n                    {isTyping && (\r\n                        <div className=\"flex gap-2\">\r\n                            <div className=\"h-7 w-7 rounded-full bg-gradient-to-br from-orange-400 to-amber-500 flex items-center justify-center text-white\">\r\n                                <Bot className=\"h-4 w-4\" />\r\n                            </div>\r\n                            <div className=\"bg-muted rounded-lg px-3 py-2\">\r\n                                <div className=\"flex gap-1\">\r\n                                    <div className=\"h-2 w-2 bg-slate-400 rounded-full animate-bounce\" />\r\n                                    <div className=\"h-2 w-2 bg-slate-400 rounded-full animate-bounce delay-100\" />\r\n                                    <div className=\"h-2 w-2 bg-slate-400 rounded-full animate-bounce delay-200\" />\r\n                                </div>\r\n                            </div>\r\n                        </div>\r\n                    )}\r\n                </div>\r\n            </ScrollArea>\r\n\r\n            {/* 输入区域 */}\r\n            <div className=\"p-3 border-t bg-background\">\r\n                <div className=\"flex items-center gap-2\">\r\n                    <Button\r\n                        variant=\"ghost\"\r\n                        size=\"icon\"\r\n                        className=\"h-8 w-8 shrink-0\"\r\n                        onClick={handleReset}\r\n                        title=\"重置对话\"\r\n                    >\r\n                        <RotateCcw className=\"h-4 w-4\" />\r\n                    </Button>\r\n                    <Input\r\n                        placeholder=\"输入您的法律问题...\"\r\n                        value={input}\r\n                        onChange={(e) => setInput(e.target.value)}\r\n                        onKeyPress={(e) => e.key === \"Enter\" && handleSend()}\r\n                        className=\"flex-1 h-9\"\r\n                        disabled={isTyping}\r\n                    />\r\n                    <Button\r\n                        size=\"icon\"\r\n                        className=\"h-8 w-8 shrink-0\"\r\n                        onClick={() => handleSend()}\r\n                        disabled={!input.trim() || isTyping}\r\n                    >\r\n                        <Send className=\"h-4 w-4\" />\r\n                    </Button>\r\n                </div>\r\n            </div>\r\n        </div>\r\n    )\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"D:\\Desktop\\LawClick_NEW\\lawclick-next\\src\\components\\floating\\floating-chat.tsx","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":43,"column":55,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":43,"endColumn":58,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1049,1052],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1049,1052],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":46,"column":36,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":46,"endColumn":39,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1167,1170],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1167,1170],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":81,"column":41,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":81,"endColumn":44,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[2372,2375],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[2372,2375],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":82,"column":45,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":82,"endColumn":48,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[2421,2424],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[2421,2424],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'e' is defined but never used.","line":83,"column":22,"nodeType":null,"messageId":"unusedVar","endLine":83,"endColumn":23},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":110,"column":59,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":110,"endColumn":62,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[3202,3205],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[3202,3205],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":6,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\"\n\nimport { useEffect, useMemo, useRef, useState } from \"react\"\nimport { useSession } from \"next-auth/react\"\nimport { useRouter } from \"next/navigation\"\n\nimport {\n    getChatMessages,\n    getOrCreateCaseThread,\n    getOrCreateTeamThread,\n    sendChatMessage,\n} from \"@/actions/chat-actions\"\nimport { ScrollArea } from \"@/components/ui/scroll-area\"\nimport { Input } from \"@/components/ui/input\"\nimport { Button } from \"@/components/ui/button\"\nimport { Avatar, AvatarFallback } from \"@/components/ui/avatar\"\nimport { toast } from \"sonner\"\nimport { Briefcase, Hash, Send } from \"lucide-react\"\n\ntype ChatUserLite = {\n    id: string\n    name: string | null\n    email: string\n    avatarUrl: string | null\n}\n\ntype ThreadLite = {\n    id: string\n    type: \"TEAM\" | \"CASE\" | \"DIRECT\"\n    caseId?: string | null\n    title: string\n}\n\ntype MessageItem = {\n    id: string\n    content: string\n    createdAt: string | Date\n    senderId: string\n    sender: ChatUserLite\n    type: \"TEXT\" | \"SYSTEM\"\n}\n\nexport function FloatingChat({ context }: { context?: any }) {\n    const router = useRouter()\n    const { data: session } = useSession()\n    const myId = (session?.user as any)?.id as string | undefined\n\n    const [thread, setThread] = useState<ThreadLite | null>(null)\n    const [messages, setMessages] = useState<MessageItem[]>([])\n    const [loading, setLoading] = useState(true)\n    const [inputValue, setInputValue] = useState(\"\")\n\n    const messagesEndRef = useRef<HTMLDivElement>(null)\n\n    const resolvedContext = useMemo(() => {\n        return {\n            scope: context?.scope as string | undefined,\n            caseId: context?.caseId as string | undefined,\n            threadId: context?.threadId as string | undefined,\n        }\n    }, [context])\n\n    useEffect(() => {\n        const load = async () => {\n            try {\n                setLoading(true)\n\n                let threadId = resolvedContext.threadId\n\n                if (!threadId && resolvedContext.caseId) {\n                    const t = await getOrCreateCaseThread(resolvedContext.caseId)\n                    threadId = t.id\n                }\n\n                if (!threadId) {\n                    const t = await getOrCreateTeamThread()\n                    threadId = t.id\n                }\n\n                const res = await getChatMessages(threadId, 80)\n                setThread(res.thread as any)\n                setMessages(res.messages as any)\n            } catch (e) {\n                toast.error(\"加载聊天失败\")\n            } finally {\n                setLoading(false)\n            }\n        }\n\n        void load()\n    }, [resolvedContext.caseId, resolvedContext.threadId, resolvedContext.scope])\n\n    useEffect(() => {\n        messagesEndRef.current?.scrollIntoView({ behavior: \"smooth\" })\n    }, [messages.length])\n\n    const handleSend = async () => {\n        if (!thread?.id) return\n        const text = inputValue.trim()\n        if (!text) return\n\n        setInputValue(\"\")\n\n        const result = await sendChatMessage(thread.id, text)\n        if (!result.success) {\n            toast.error(\"发送失败\", { description: result.error })\n            return\n        }\n\n        setMessages((prev) => [...prev, result.message as any])\n    }\n\n    return (\n        <div className=\"flex flex-col h-full bg-white/80 backdrop-blur-xl dark:bg-black/80\">\n            {/* Header */}\n            <div className=\"flex items-center justify-between px-3 py-2 border-b border-slate-200/50\">\n                <div className=\"flex items-center gap-2 min-w-0\">\n                    {thread?.type === \"CASE\" ? (\n                        <Briefcase className=\"h-3.5 w-3.5 text-orange-500 shrink-0\" />\n                    ) : (\n                        <Hash className=\"h-3.5 w-3.5 text-blue-500 shrink-0\" />\n                    )}\n                    <span className=\"text-sm font-medium truncate\">\n                        {thread?.title || (thread?.type === \"CASE\" ? \"案件群聊\" : \"团队群聊\")}\n                    </span>\n                </div>\n                <Button\n                    variant=\"ghost\"\n                    size=\"sm\"\n                    className=\"h-7 text-xs\"\n                    onClick={() => router.push(\"/chat\")}\n                >\n                    打开完整页\n                </Button>\n            </div>\n\n            {/* Messages */}\n            <ScrollArea className=\"flex-1 p-3\">\n                {loading ? (\n                    <div className=\"text-sm text-muted-foreground text-center py-8\">加载中...</div>\n                ) : (\n                    <div className=\"space-y-3\">\n                        {messages.map((msg, index) => {\n                            const isMe = myId ? msg.senderId === myId : false\n                            const showAvatar = !isMe && (index === 0 || messages[index - 1].senderId !== msg.senderId)\n                            const showName = !isMe && showAvatar\n\n                            if (msg.type === \"SYSTEM\") {\n                                return (\n                                    <div key={msg.id} className=\"text-center text-xs text-muted-foreground\">\n                                        {msg.content}\n                                    </div>\n                                )\n                            }\n\n                            return (\n                                <div key={msg.id} className={`flex ${isMe ? \"justify-end\" : \"justify-start\"}`}>\n                                    <div className={`flex max-w-[85%] items-end gap-1.5 ${isMe ? \"flex-row-reverse\" : \"\"}`}>\n                                        {!isMe ? (\n                                            <div className=\"w-6 shrink-0\">\n                                                {showAvatar ? (\n                                                    <Avatar className=\"h-6 w-6\">\n                                                        <AvatarFallback className=\"text-[10px] bg-orange-100 text-orange-700\">\n                                                            {(msg.sender?.name || msg.sender?.email || \"U\").slice(0, 1)}\n                                                        </AvatarFallback>\n                                                    </Avatar>\n                                                ) : null}\n                                            </div>\n                                        ) : null}\n\n                                        <div className=\"flex flex-col\">\n                                            {showName ? (\n                                                <span className=\"text-[10px] text-muted-foreground mb-0.5 ml-1\">\n                                                    {msg.sender?.name || msg.sender?.email}\n                                                </span>\n                                            ) : null}\n                                            <div\n                                                className={`rounded-2xl px-3 py-1.5 text-sm whitespace-pre-wrap break-words ${isMe\n                                                    ? \"bg-primary text-primary-foreground rounded-br-sm\"\n                                                    : \"bg-muted rounded-bl-sm\"\n                                                    }`}\n                                            >\n                                                {msg.content}\n                                            </div>\n                                        </div>\n                                    </div>\n                                </div>\n                            )\n                        })}\n                        <div ref={messagesEndRef} />\n                    </div>\n                )}\n            </ScrollArea>\n\n            {/* Input */}\n            <div className=\"p-2 border-t border-slate-200/50 bg-white/50 dark:bg-black/50\">\n                <form\n                    onSubmit={(e) => {\n                        e.preventDefault()\n                        void handleSend()\n                    }}\n                    className=\"flex items-center gap-2\"\n                >\n                    <Input\n                        value={inputValue}\n                        onChange={(e) => setInputValue(e.target.value)}\n                        placeholder={thread ? \"输入消息...\" : \"加载中...\"}\n                        disabled={!thread}\n                        className=\"flex-1 h-8 text-sm\"\n                    />\n                    <Button type=\"submit\" size=\"icon\" className=\"h-8 w-8 rounded-full shrink-0\" disabled={!thread || !inputValue.trim()}>\n                        <Send className=\"h-4 w-4\" />\n                    </Button>\n                </form>\n            </div>\n        </div>\n    )\n}\n","usedDeprecatedRules":[]},{"filePath":"D:\\Desktop\\LawClick_NEW\\lawclick-next\\src\\components\\floating\\timer-content.tsx","messages":[{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook React.useEffect has a missing dependency: 'activeTimer'. Either include it or remove the dependency array.","line":99,"column":8,"nodeType":"ArrayExpression","endLine":99,"endColumn":106,"suggestions":[{"desc":"Update the dependencies array to be: [activeTimer.id, activeTimer.status, activeTimer.startTime, activeTimer.duration, updateTitle, activeTimer]","fix":{"range":[3381,3479],"text":"[activeTimer.id, activeTimer.status, activeTimer.startTime, activeTimer.duration, updateTitle, activeTimer]"}}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\"\n\nimport * as React from \"react\"\nimport { Loader2, Pause, Play, Square } from \"lucide-react\"\nimport { toast } from \"sonner\"\n\nimport { Button } from \"@/components/ui/button\"\nimport { Input } from \"@/components/ui/input\"\nimport { Label } from \"@/components/ui/label\"\nimport { cn } from \"@/lib/utils\"\nimport { useFloatStore } from \"@/store/float-store\"\nimport { useUserStatusStore } from \"@/store/user-status-store\"\nimport { getActiveTimer, pauseTimer, resumeTimer, stopTimer, updateTimeLog } from \"@/actions/timelogs-crud\"\n\ntype ActiveTimer = {\n    id: string\n    description: string\n    startTime: Date | string\n    duration: number\n    status: \"RUNNING\" | \"PAUSED\"\n    case?: { id: string; title: string; caseCode: string } | null\n    task?: { id: string; title: string } | null\n}\n\nfunction formatTime(totalSeconds: number) {\n    const h = Math.floor(totalSeconds / 3600)\n    const m = Math.floor((totalSeconds % 3600) / 60)\n    const s = totalSeconds % 60\n    return `${h.toString().padStart(2, \"0\")}:${m.toString().padStart(2, \"0\")}:${s.toString().padStart(2, \"0\")}`\n}\n\nexport function FloatingTimerContent() {\n    const { setStatus } = useUserStatusStore()\n    const { updateTitle } = useFloatStore()\n\n    const [loading, setLoading] = React.useState(true)\n    const [busy, setBusy] = React.useState(false)\n    const [activeTimer, setActiveTimer] = React.useState<ActiveTimer | null>(null)\n    const [elapsedSeconds, setElapsedSeconds] = React.useState(0)\n    const [draftDescription, setDraftDescription] = React.useState(\"\")\n\n    const loadActiveTimer = React.useCallback(async () => {\n        try {\n            const timer = (await getActiveTimer()) as ActiveTimer | null\n            setActiveTimer(timer)\n\n            if (!timer) {\n                setElapsedSeconds(0)\n                return\n            }\n\n            setDraftDescription(timer.description || \"\")\n\n            const base = timer.duration || 0\n            if (timer.status === \"PAUSED\") {\n                setElapsedSeconds(base)\n                return\n            }\n\n            const startMs = new Date(timer.startTime).getTime()\n            const extra = Math.max(0, Math.floor((Date.now() - startMs) / 1000))\n            setElapsedSeconds(base + extra)\n        } finally {\n            setLoading(false)\n        }\n    }, [])\n\n    React.useEffect(() => {\n        loadActiveTimer()\n    }, [loadActiveTimer])\n\n    React.useEffect(() => {\n        if (activeTimer?.status === \"RUNNING\") {\n            setStatus(\"FOCUS\", \"Deep Work: Billing Time\")\n        } else if (activeTimer?.status === \"PAUSED\") {\n            setStatus(\"BUSY\", \"Timer Paused\")\n        } else {\n            setStatus(\"AVAILABLE\")\n        }\n    }, [activeTimer?.status, setStatus])\n\n    React.useEffect(() => {\n        if (!activeTimer || activeTimer.status !== \"RUNNING\") {\n            updateTitle(\"timer\", \"计时器\")\n            return\n        }\n\n        const tick = () => {\n            const startMs = new Date(activeTimer.startTime).getTime()\n            const extra = Math.max(0, Math.floor((Date.now() - startMs) / 1000))\n            const nextElapsed = (activeTimer.duration || 0) + extra\n            setElapsedSeconds(nextElapsed)\n            updateTitle(\"timer\", `计时中 ${formatTime(nextElapsed)}`)\n        }\n\n        tick()\n        const interval = setInterval(tick, 1000)\n        return () => clearInterval(interval)\n    }, [activeTimer?.id, activeTimer?.status, activeTimer?.startTime, activeTimer?.duration, updateTitle])\n\n    const handleStart = async () => {\n        toast.error(\"请从案件/任务开始计时\", { description: \"建议在任务卡点击「计时」或在工时页选择案件开始\" })\n    }\n\n    const handlePauseResume = async () => {\n        if (!activeTimer) return\n\n        setBusy(true)\n        const res =\n            activeTimer.status === \"RUNNING\"\n                ? await pauseTimer(activeTimer.id)\n                : await resumeTimer(activeTimer.id)\n        setBusy(false)\n\n        if (!res.success) {\n            toast.error(\"操作失败\", { description: res.error })\n            return\n        }\n\n        await loadActiveTimer()\n    }\n\n    const handleStop = async () => {\n        if (!activeTimer) return\n\n        setBusy(true)\n        const res = await stopTimer(activeTimer.id)\n        setBusy(false)\n\n        if (!res.success) {\n            toast.error(\"停止计时失败\", { description: res.error })\n            return\n        }\n\n        toast.success(\"工时已保存\", {\n            description: `时长: ${formatTime(res.duration ?? elapsedSeconds)}`,\n        })\n\n        setDraftDescription(\"\")\n        await loadActiveTimer()\n    }\n\n    const handleDescriptionBlur = async () => {\n        if (!activeTimer) return\n        const description = draftDescription.trim()\n        if (!description || description === activeTimer.description) return\n\n        const res = await updateTimeLog({ id: activeTimer.id, description })\n        if (!res.success) {\n            toast.error(\"保存备注失败\", { description: res.error })\n            return\n        }\n\n        setActiveTimer((prev) => (prev ? { ...prev, description } : prev))\n    }\n\n    const statusLabel =\n        activeTimer?.status === \"RUNNING\"\n            ? \"RUNNING\"\n            : activeTimer?.status === \"PAUSED\"\n                ? \"PAUSED\"\n                : \"IDLE\"\n\n    if (loading) {\n        return (\n            <div className=\"flex h-full items-center justify-center text-muted-foreground\">\n                <Loader2 className=\"h-5 w-5 animate-spin\" />\n            </div>\n        )\n    }\n\n    return (\n        <div className=\"flex flex-col gap-4 h-full\">\n            <div className=\"flex flex-col items-center justify-center py-4 bg-muted/20 rounded-lg border border-white/5\">\n                <span className=\"text-4xl font-mono font-bold tracking-tight py-2 text-primary\">\n                    {formatTime(elapsedSeconds)}\n                </span>\n                <span\n                    className={cn(\n                        \"text-xs font-medium px-2 py-0.5 rounded-full uppercase tracking-wider\",\n                        activeTimer?.status === \"RUNNING\"\n                            ? \"bg-green-500/20 text-green-600 animate-pulse\"\n                            : \"bg-muted text-muted-foreground\"\n                    )}\n                >\n                    {statusLabel}\n                </span>\n            </div>\n\n            {activeTimer?.case && (\n                <div className=\"text-xs text-muted-foreground truncate\">\n                    {activeTimer.case.caseCode} · {activeTimer.case.title}\n                </div>\n            )}\n\n            {activeTimer?.task && (\n                <div className=\"text-xs text-muted-foreground truncate\">任务：{activeTimer.task.title}</div>\n            )}\n\n            <div className=\"flex items-center justify-center gap-4\">\n                {activeTimer ? (\n                    <Button\n                        size=\"icon\"\n                        variant={activeTimer.status === \"RUNNING\" ? \"secondary\" : \"default\"}\n                        className={cn(\n                            \"h-12 w-12 rounded-full shadow-brand hover:scale-105 active:scale-95 transition-all\",\n                            activeTimer.status === \"RUNNING\"\n                                ? \"bg-amber-100 text-amber-600 hover:bg-amber-200\"\n                                : \"\"\n                        )}\n                        aria-label={activeTimer.status === \"RUNNING\" ? \"暂停计时\" : \"继续计时\"}\n                        data-testid=\"floating-timer-toggle\"\n                        onClick={handlePauseResume}\n                        disabled={busy}\n                    >\n                        {activeTimer.status === \"RUNNING\" ? (\n                            <Pause className=\"h-5 w-5 fill-current\" />\n                        ) : (\n                            <Play className=\"h-5 w-5 fill-current\" />\n                        )}\n                    </Button>\n                ) : (\n                    <Button\n                        size=\"icon\"\n                        className=\"h-12 w-12 rounded-full shadow-brand hover:scale-105 active:scale-95 transition-all\"\n                        onClick={handleStart}\n                        disabled={busy || !draftDescription.trim()}\n                    >\n                        <Play className=\"h-5 w-5 fill-current\" />\n                    </Button>\n                )}\n\n                <Button\n                    size=\"icon\"\n                    variant=\"ghost\"\n                    className=\"h-10 w-10 text-destructive hover:bg-destructive/10\"\n                    aria-label=\"停止计时\"\n                    data-testid=\"floating-timer-stop\"\n                    onClick={handleStop}\n                    disabled={!activeTimer || busy}\n                >\n                    <Square className=\"h-4 w-4 fill-current\" />\n                </Button>\n            </div>\n\n            <div className=\"mt-auto\">\n                <Label className=\"text-xs text-muted-foreground mb-1.5 block\">备注</Label>\n                <Input\n                    placeholder=\"正在做什么...\"\n                    className=\"h-8 bg-transparent border-b border-0 border-white/20 rounded-none focus-visible:ring-0 focus-visible:border-primary px-0\"\n                    value={draftDescription}\n                    onChange={(e) => setDraftDescription(e.target.value)}\n                    onBlur={handleDescriptionBlur}\n                    disabled={busy}\n                />\n            </div>\n        </div>\n    )\n}\n","usedDeprecatedRules":[]},{"filePath":"D:\\Desktop\\LawClick_NEW\\lawclick-next\\src\\components\\layout\\Header.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\Desktop\\LawClick_NEW\\lawclick-next\\src\\components\\layout\\app-header.tsx","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":63,"column":40,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":63,"endColumn":43,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1805,1808],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1805,1808],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"'use client';\n\n// import Link from 'next/link';\nimport { useState, useEffect } from 'react';\nimport { signOut, useSession } from \"next-auth/react\"\nimport { Button } from '@/components/ui/button';\nimport { Avatar, AvatarFallback } from '@/components/ui/avatar';\nimport { useRole } from \"@/components/layout/role-context\"\n// Import from mocks\nimport { NotificationTrigger, GlobalSearch, PerformanceMonitor, useConfirmationDialog } from '@/components/layout/header-components';\n\r\nimport {\r\n    DropdownMenu,\r\n    DropdownMenuContent,\r\n    DropdownMenuItem,\r\n    DropdownMenuLabel,\r\n    DropdownMenuSeparator,\r\n    DropdownMenuTrigger,\r\n} from '@/components/ui/dropdown-menu';\r\nimport { Badge } from '@/components/ui/badge';\r\nimport { SidebarTrigger } from '@/components/ui/sidebar';\r\nimport {\r\n    // Bell,\r\n    Search,\r\n    // User,\r\n    // Settings,\r\n    LogOut,\r\n    ChevronDown,\r\n    Activity,\r\n    Bot,\r\n    Eye,\r\n    EyeOff,\r\n    MessageCircle,\n    Timer\n} from 'lucide-react';\nimport { useFloatStore } from '@/store/float-store';\n\nconst ROLE_LABELS: Record<string, string> = {\n    PARTNER: \"合伙人\",\n    SENIOR_LAWYER: \"高级律师\",\n    LAWYER: \"专职律师\",\n    TRAINEE: \"实习生\",\n    ADMIN: \"管理员\",\n    HR: \"人事\",\n    MARKETING: \"品牌\",\n    LEGAL_SECRETARY: \"法律秘书\",\n    CLIENT: \"客户\",\n    FIRM_ENTITY: \"律所\",\n}\n\nexport function AppHeader() {\n    const { data: session } = useSession()\n    const { currentRole } = useRole();\n    const [isSearchOpen, setIsSearchOpen] = useState(false);\n    const [isPerformanceOpen, setIsPerformanceOpen] = useState(false);\n    const { windows, openWindow, closeWindow } = useFloatStore();\n\n    const userName =\n        session?.user?.name ||\n        session?.user?.email?.split(\"@\")[0] ||\n        \"用户\"\n    const userEmail = session?.user?.email || \"\"\n    const userRole = (session?.user as any)?.role as string | undefined\n    const userRoleLabel = userRole ? (ROLE_LABELS[userRole] || userRole) : \"用户\"\n\n    // AI助手窗口状态和toggle\n    const isAIAssistantVisible = windows['ai-paralegal']?.isOpen ?? false;\n    const toggleAIAssistant = () => {\n        if (isAIAssistantVisible) {\n            closeWindow('ai-paralegal')\n        } else {\n            openWindow('ai-paralegal', 'AI_PARALEGAL', 'AI法律助手', null)\n        }\n    }\n\r\n    // Team Chat窗口状态和toggle  \r\n    const isChatVisible = windows['team-chat']?.isOpen ?? false;\r\n    const toggleChat = () => {\r\n        if (isChatVisible) {\n            closeWindow('team-chat')\n        } else {\n            openWindow('team-chat', 'CHAT', '团队消息', { scope: \"TEAM\" })\n        }\n    }\n\r\n    // Timer 窗口状态和 toggle\r\n    const isTimerVisible = windows['timer']?.isOpen ?? false;\r\n    const toggleTimer = () => {\r\n        if (isTimerVisible) {\r\n            closeWindow('timer')\r\n        } else {\r\n            openWindow('timer', 'TIMER', '计时器')\r\n        }\r\n    }\r\n    const { showConfirmation, ConfirmationDialog } = useConfirmationDialog();\r\n\r\n    // 安全退出登录处理函数\r\n    const handleLogout = () => {\r\n        showConfirmation({\r\n            title: '退出登录',\r\n            message: '确定要退出登录吗？\\n\\n为了您的账户安全，建议您：\\n• 清除浏览器缓存\\n• 关闭所有相关标签页\\n• 确保在安全环境下操作',\r\n            type: 'warning',\r\n            onConfirm: () => {\r\n                // 清除用户状态\n                try {\n                    localStorage.removeItem(\"lawclick-float-storage-v9\")\n                    localStorage.removeItem(\"lawclick-user-status-v9\")\n                    localStorage.removeItem(\"lawclick-timer-storage\")\n                } catch { }\n\n                void signOut({ callbackUrl: \"/auth/login\" })\n            }\n        });\n    };\n\r\n    // 键盘快捷键支持\r\n    useEffect(() => {\r\n        const handleKeyDown = (event: KeyboardEvent) => {\r\n            if ((event.metaKey || event.ctrlKey) && event.key === 'k') {\r\n                event.preventDefault();\r\n                setIsSearchOpen(true);\r\n            }\r\n        };\r\n\r\n        document.addEventListener('keydown', handleKeyDown);\r\n        return () => document.removeEventListener('keydown', handleKeyDown);\r\n    }, []);\r\n\r\n    return (\r\n        <header className=\"h-16 border-b border-border bg-white flex items-center justify-between px-2 sm:px-4 md:px-6 relative\">\r\n            {/* Left Section */}\r\n            <div className=\"flex items-center space-x-1 sm:space-x-2 md:space-x-4 min-w-0 flex-shrink-0\">\r\n                <SidebarTrigger />\r\n\r\n                {/* 全局搜索 - 桌面版 */}\r\n                <div className=\"hidden lg:flex items-center space-x-2\">\r\n                    <Button\r\n                        variant=\"outline\"\r\n                        className=\"w-64 xl:w-80 justify-start text-muted-foreground\"\r\n                        onClick={() => setIsSearchOpen(true)}\r\n                    >\r\n                        <Search className=\"w-4 h-4 mr-2 flex-shrink-0\" />\r\n                        <span className=\"truncate\">搜索案件、文档、仲裁员...</span>\r\n                        <kbd className=\"ml-auto pointer-events-none inline-flex h-5 select-none items-center gap-1 rounded border bg-muted px-1.5 font-mono text-[10px] font-medium text-muted-foreground opacity-100 flex-shrink-0\">\r\n                            <span className=\"text-xs\">⌘</span>K\r\n                        </kbd>\r\n                    </Button>\r\n                </div>\r\n\r\n                {/* 平板搜索按钮 */}\r\n                <div className=\"hidden md:flex lg:hidden\">\r\n                    <Button\r\n                        variant=\"outline\"\r\n                        size=\"sm\"\r\n                        onClick={() => setIsSearchOpen(true)}\r\n                        className=\"w-32\"\r\n                    >\r\n                        <Search className=\"w-4 h-4 mr-2\" />\r\n                        <span className=\"text-sm\">搜索</span>\r\n                    </Button>\r\n                </div>\r\n\r\n                {/* 移动端搜索按钮 */}\r\n                <div className=\"md:hidden\">\r\n                    <Button\r\n                        variant=\"ghost\"\r\n                        size=\"sm\"\r\n                        onClick={() => setIsSearchOpen(true)}\r\n                    >\r\n                        <Search className=\"w-4 h-4\" />\r\n                    </Button>\r\n                </div>\r\n            </div>\r\n\r\n            {/* Center Section - Role Switcher */}\r\n            <div className=\"hidden xl:flex items-center absolute left-1/2 transform -translate-x-1/2\">\r\n\r\n            </div>\r\n\r\n            {/* Spacer for mobile */}\r\n            <div className=\"flex-1 xl:hidden\" />\r\n\r\n            {/* Right Section */}\r\n            <div className=\"flex items-center space-x-1 sm:space-x-2 md:space-x-3 lg:space-x-4 flex-shrink-0\">\r\n                {/* Role Switcher for mobile/tablet */}\r\n                {/* Role Badge (Read Only) */}\r\n                <div className=\"xl:hidden\">\r\n                    <Badge variant=\"outline\" className=\"text-xs px-2 py-1 uppercase\">\r\n                        {currentRole}\r\n                    </Badge>\r\n                </div>\r\n\r\n                {/* Chat Toggle */}\r\n                <Button\r\n                    variant=\"ghost\"\r\n                    size=\"sm\"\r\n                    onClick={toggleChat}\r\n                    title={isChatVisible ? \"隐藏Team Chat\" : \"显示Team Chat\"}\r\n                    className={`relative flex-shrink-0 transition-all duration-200 ${isChatVisible ? 'bg-blue-50 text-blue-600 hover:bg-blue-100' : 'hover:bg-gray-100'\r\n                        }`}\r\n                >\r\n                    <MessageCircle className=\"w-4 h-4\" />\r\n                    {isChatVisible && (\r\n                        <span className=\"absolute -top-1 -right-1 w-2 h-2 bg-green-500 rounded-full\" />\r\n                    )}\r\n                </Button>\r\n\r\n                {/* Timer Toggle */}\r\n                <Button\r\n                    variant=\"ghost\"\r\n                    size=\"sm\"\r\n                    onClick={toggleTimer}\r\n                    title={isTimerVisible ? \"隐藏计时器\" : \"显示计时器\"}\r\n                    className={`relative flex-shrink-0 transition-all duration-200 ${isTimerVisible ? 'bg-green-50 text-green-600 hover:bg-green-100' : 'hover:bg-gray-100'\r\n                        }`}\r\n                >\r\n                    <Timer className=\"w-4 h-4\" />\r\n                    {isTimerVisible && (\r\n                        <span className=\"absolute -top-1 -right-1 w-2 h-2 bg-green-500 rounded-full\" />\r\n                    )}\r\n                </Button>\r\n\r\n                {/* AI Assistant Toggle */}\r\n                <Button\r\n                    variant=\"ghost\"\r\n                    size=\"sm\"\r\n                    onClick={toggleAIAssistant}\r\n                    title={isAIAssistantVisible ? \"隐藏AI助手\" : \"显示AI助手\"}\r\n                    className={`relative flex-shrink-0 transition-all duration-200 ${isAIAssistantVisible ? 'bg-orange-50 text-orange-600 hover:bg-orange-100' : 'hover:bg-gray-100'\r\n                        }`}\r\n                >\r\n                    <Bot className=\"w-4 h-4\" />\r\n                    {isAIAssistantVisible ? (\r\n                        <Eye className=\"w-2 h-2 absolute -top-1 -right-1 text-green-500\" />\r\n                    ) : (\r\n                        <EyeOff className=\"w-2 h-2 absolute -top-1 -right-1 text-gray-400\" />\r\n                    )}\r\n                </Button>\r\n\r\n                {/* Notifications */}\r\n                <NotificationTrigger />\r\n\r\n                {/* User Menu */}\r\n                <DropdownMenu>\r\n                    <DropdownMenuTrigger asChild>\r\n                        <Button variant=\"ghost\" className=\"flex items-center space-x-1 sm:space-x-2 h-auto p-1 sm:p-2 hover-lift group flex-shrink-0\">\r\n                            <Avatar className=\"w-7 h-7 sm:w-8 sm:h-8 group-hover:scale-110 transition-transform duration-300\">\r\n                                <AvatarFallback className=\"bg-gradient-to-r from-orange-500 to-orange-600 text-white text-xs sm:text-sm shadow-brand\">\r\n                                    {userName.charAt(0)}\n                                </AvatarFallback>\n                            </Avatar>\n                            <div className=\"hidden lg:flex flex-col items-start min-w-0\">\n                                <span className=\"text-sm font-medium text-gray-900 group-hover:text-orange-700 transition-colors truncate max-w-20 xl:max-w-none\">\n                                    {userName}\n                                </span>\n                                <span className=\"text-xs text-gray-600 group-hover:text-orange-500 transition-colors truncate max-w-20 xl:max-w-none\">\n                                    {userRoleLabel}\n                                </span>\n                            </div>\n                            <ChevronDown className=\"w-3 h-3 sm:w-4 sm:h-4 text-gray-600 group-hover:text-orange-500 transition-all duration-300 group-data-[state=open]:rotate-180 flex-shrink-0\" />\r\n                        </Button>\r\n                    </DropdownMenuTrigger>\r\n\r\n                    <DropdownMenuContent\r\n                        align=\"end\"\r\n                        className=\"w-56 shadow-brand-lg border border-orange-100 bg-white rounded-lg\"\r\n                        sideOffset={8}\r\n                    >\r\n                        <DropdownMenuLabel className=\"bg-gradient-to-r from-orange-50 to-orange-100 border-b border-orange-200\">\n                            <div className=\"flex flex-col space-y-1\">\n                                <span className=\"text-sm font-medium text-gray-900\">{userName}</span>\n                                <span className=\"text-xs text-gray-600\">{userEmail}</span>\n                            </div>\n                        </DropdownMenuLabel>\n\r\n                        <DropdownMenuSeparator />\r\n\r\n                        {/* 移除“设置与帮助”菜单项，避免与独立设置页重复入口 */}\r\n\r\n                        <DropdownMenuSeparator />\r\n\r\n                        <DropdownMenuItem\r\n                            className=\"flex items-center space-x-2 cursor-pointer hover:bg-orange-50 focus:bg-orange-50\"\r\n                            onClick={() => setIsPerformanceOpen(true)}\r\n                        >\r\n                            <Activity className=\"w-4 h-4 text-green-600\" />\r\n                            <span>性能监控</span>\r\n                        </DropdownMenuItem>\r\n\r\n                        <DropdownMenuSeparator />\r\n\r\n                        <DropdownMenuItem\r\n                            className=\"flex items-center space-x-2 cursor-pointer text-red-600 hover:bg-red-50 focus:bg-red-50\"\r\n                            onClick={handleLogout}\r\n                        >\r\n                            <LogOut className=\"w-4 h-4\" />\r\n                            <span>退出登录</span>\r\n                        </DropdownMenuItem>\r\n                    </DropdownMenuContent>\r\n                </DropdownMenu>\r\n            </div>\r\n\r\n            {/* 全局搜索组件 */}\r\n            <GlobalSearch\r\n                isOpen={isSearchOpen}\r\n                onClose={() => setIsSearchOpen(false)}\r\n            />\r\n\r\n            {/* 性能监控组件 */}\r\n            <PerformanceMonitor\r\n                isVisible={isPerformanceOpen}\r\n                onClose={() => setIsPerformanceOpen(false)}\r\n            />\r\n\r\n            {/* 确认对话框 */}\r\n            <ConfirmationDialog />\r\n        </header>\r\n    );\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"D:\\Desktop\\LawClick_NEW\\lawclick-next\\src\\components\\layout\\app-sidebar.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'base' is assigned a value but never used.","line":46,"column":15,"nodeType":null,"messageId":"unusedVar","endLine":46,"endColumn":19},{"ruleId":"react-hooks/set-state-in-effect","severity":1,"message":"Error: Calling setState synchronously within an effect can trigger cascading renders\n\nEffects are intended to synchronize state between React and external systems such as manually updating the DOM, state management libraries, or other platform APIs. In general, the body of an effect should do one or both of the following:\n* Update external systems with the latest state from React.\n* Subscribe for updates from some external system, calling setState in a callback function when external state changes.\n\nCalling setState synchronously within an effect body causes cascading renders that can hurt performance, and is not recommended. (https://react.dev/learn/you-might-not-need-an-effect).\n\nD:\\Desktop\\LawClick_NEW\\lawclick-next\\src\\components\\layout\\app-sidebar.tsx:56:40\n  54 |             }\n  55 |         });\n> 56 |         if (groupsToExpand.length > 0) setExpandedItems(prev => Array.from(new Set([...prev, ...groupsToExpand])));\n     |                                        ^^^^^^^^^^^^^^^^ Avoid calling setState() directly within an effect\n  57 |     }, [pathname, currentRole]);\n  58 |\n  59 |     // 根据用户角色获取导航项","line":56,"column":40,"nodeType":null,"endLine":56,"endColumn":56},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'e' is defined but never used.","line":73,"column":97,"nodeType":null,"messageId":"unusedVar","endLine":73,"endColumn":98},{"ruleId":"react-hooks/set-state-in-effect","severity":1,"message":"Error: Calling setState synchronously within an effect can trigger cascading renders\n\nEffects are intended to synchronize state between React and external systems such as manually updating the DOM, state management libraries, or other platform APIs. In general, the body of an effect should do one or both of the following:\n* Update external systems with the latest state from React.\n* Subscribe for updates from some external system, calling setState in a callback function when external state changes.\n\nCalling setState synchronously within an effect body causes cascading renders that can hurt performance, and is not recommended. (https://react.dev/learn/you-might-not-need-an-effect).\n\nD:\\Desktop\\LawClick_NEW\\lawclick-next\\src\\components\\layout\\app-sidebar.tsx:78:79\n  76 |         try {\n  77 |             const s = localStorage.getItem('sidebar_expanded');\n> 78 |             if (s) { const parsed = JSON.parse(s); if (Array.isArray(parsed)) setExpandedItems(parsed); }\n     |                                                                               ^^^^^^^^^^^^^^^^ Avoid calling setState() directly within an effect\n  79 |         } catch (e) { }\n  80 |     }, []);\n  81 |","line":78,"column":79,"nodeType":null,"endLine":78,"endColumn":95},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'e' is defined but never used.","line":79,"column":18,"nodeType":null,"messageId":"unusedVar","endLine":79,"endColumn":19},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":99,"column":53,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":99,"endColumn":56,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[3900,3903],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[3900,3903],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":131,"column":76,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":131,"endColumn":79,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[6445,6448],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[6445,6448],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":51,"column":28,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":51,"endColumn":31,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1506,1509],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1506,1509],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}],"suppressions":[{"kind":"directive","justification":""}]}],"errorCount":0,"fatalErrorCount":0,"warningCount":7,"fixableErrorCount":0,"fixableWarningCount":0,"source":"'use client';\r\n\r\nimport Link from 'next/link';\r\nimport { usePathname } from 'next/navigation';\r\nimport { useEffect, useState } from 'react';\r\n// import { cn } from '@/lib/utils';\r\nimport {\r\n    Sidebar,\r\n    SidebarContent,\r\n    SidebarHeader,\r\n    SidebarMenu,\r\n    SidebarMenuButton,\r\n    SidebarMenuItem,\r\n    SidebarFooter,\r\n} from '@/components/ui/sidebar';\r\nimport { Badge } from '@/components/ui/badge';\r\nimport {\r\n    Scale,\r\n    ChevronRight,\r\n    Settings,\r\n} from 'lucide-react';\r\nimport { getNavigationForRole } from '@/config/navigation';\r\nimport { useRole } from \"@/components/layout/role-context\";\r\n\r\n// 底部导航项\r\nconst bottomItems = [\r\n    {\r\n        name: '设置与帮助',\r\n        href: '/settings',\r\n        icon: Settings,\r\n    },\r\n];\r\n\r\nexport function AppSidebar() {\r\n    const pathname = usePathname();\r\n    const [expandedItems, setExpandedItems] = useState<string[]>([]);\r\n\r\n    // Use a sensible default if context is missing (though it shouldn't be)\r\n    const roleContext = useRole();\r\n    const currentRole = roleContext?.currentRole || \"lawyer\";\r\n\r\n    // 进入时默认展开包含当前路径的分组\r\n    useEffect(() => {\r\n        if (!pathname) return;\r\n        const segments = pathname.split('/').filter(Boolean);\r\n        const base = `/${segments[0] || ''}`;\r\n        // 如果 pathname 包含某分组 href 前缀，则展开该分组名称\r\n        const groupsToExpand: string[] = [];\r\n        const nav = getNavigationForRole(currentRole);\r\n        // eslint-disable-next-line @typescript-eslint/no-explicit-any\r\n        nav.forEach((item: any) => {\r\n            if (item.children && (pathname === item.href || pathname.startsWith(item.href + '/'))) {\r\n                groupsToExpand.push(item.name);\r\n            }\r\n        });\r\n        if (groupsToExpand.length > 0) setExpandedItems(prev => Array.from(new Set([...prev, ...groupsToExpand])));\r\n    }, [pathname, currentRole]);\r\n\r\n    // 根据用户角色获取导航项\r\n    const navigationItems = getNavigationForRole(currentRole);\r\n\r\n    const toggleExpanded = (itemName: string) => {\r\n        setExpandedItems(prev =>\r\n            prev.includes(itemName)\r\n                ? prev.filter(name => name !== itemName)\r\n                : [...prev, itemName]\r\n        );\r\n    };\r\n\r\n    const isExpanded = (itemName: string) => expandedItems.includes(itemName);\r\n    // 折叠状态持久化\r\n    useEffect(() => {\r\n        try { localStorage.setItem('sidebar_expanded', JSON.stringify(expandedItems)); } catch (e) { }\r\n    }, [expandedItems]);\r\n    useEffect(() => {\r\n        try {\r\n            const s = localStorage.getItem('sidebar_expanded');\r\n            if (s) { const parsed = JSON.parse(s); if (Array.isArray(parsed)) setExpandedItems(parsed); }\r\n        } catch (e) { }\r\n    }, []);\r\n\r\n\r\n    return (\r\n        <Sidebar variant=\"floating\" collapsible=\"icon\" className=\"bg-transparent border-none\">\r\n                <SidebarHeader className=\"p-4\">\r\n                    <Link href=\"/dashboard\" className=\"flex items-center space-x-2 group hover-lift\">\r\n                        <div className=\"w-8 h-8 bg-gradient-to-r from-primary-500 to-primary-600 rounded-lg flex items-center justify-center shadow-brand group-hover:shadow-brand-lg transition-all duration-300 group-hover:scale-110\">\r\n                            <Scale className=\"w-5 h-5 text-white\" />\r\n                        </div>\r\n                        <div className=\"flex flex-col group-data-[collapsible=icon]:hidden\">\r\n                            <span className=\"text-lg font-bold text-foreground group-hover:text-primary-700 transition-colors\">LawClick</span>\r\n                            <span className=\"text-xs text-muted-foreground -mt-1 group-hover:text-primary-500 transition-colors\">Legal ERP v9</span>\r\n                        </div>\r\n                    </Link>\r\n                </SidebarHeader>\r\n\r\n                <SidebarContent className=\"px-2\">\r\n                    <SidebarMenu>\r\n                        {navigationItems.map((item: any) => (\r\n                            <SidebarMenuItem key={item.name}>\r\n                                {item.children ? (\r\n                                    // 有子菜单的项目\r\n                                    <div>\r\n                                        <SidebarMenuButton\r\n                                            onClick={() => toggleExpanded(item.name)}\r\n                                            isActive={pathname === item.href || pathname.startsWith(item.href + '/')}\r\n                                            className=\"w-full nav-item hover-lift data-[active=true]:bg-primary/10 data-[active=true]:text-primary\"\r\n                                        >\r\n                                            <div className=\"flex items-center justify-between w-full\">\r\n                                                <div className=\"flex items-center space-x-3\">\r\n                                                    <item.icon className=\"w-5 h-5\" />\r\n                                                    <span>{item.name}</span>\r\n                                                </div>\r\n                                                <div className=\"flex items-center space-x-2\">\r\n                                                    {item.badge && (\r\n                                                        <Badge variant=\"secondary\" className=\"bg-primary text-primary-foreground shadow-brand\">\r\n                                                            {item.badge}\r\n                                                        </Badge>\r\n                                                    )}\r\n                                                    <div className={`transition-transform duration-300 ${isExpanded(item.name) ? 'rotate-90' : ''}`}>\r\n                                                        <ChevronRight className=\"w-4 h-4\" />\r\n                                                    </div>\r\n                                                </div>\r\n                                            </div>\r\n                                        </SidebarMenuButton>\r\n\r\n                                        {/* 子菜单动画容器 */}\r\n                                        <div className={`overflow-hidden transition-all duration-300 ease-in-out ${isExpanded(item.name) ? 'max-h-96 opacity-100' : 'max-h-0 opacity-0'\r\n                                            }`}>\r\n                                            <div className=\"ml-8 mt-2 space-y-1 animate-slide-up\">\r\n                                                {item.children.map((child: any, index: number) => (\r\n                                                    <SidebarMenuButton\r\n                                                        key={child.name}\r\n                                                        asChild\r\n                                                        isActive={pathname === child.href || pathname.startsWith(child.href + '/')}\r\n                                                        size=\"sm\"\r\n                                                        className=\"nav-item-animate hover-lift data-[active=true]:text-primary\"\r\n                                                        style={{ animationDelay: `${index * 0.1}s` }}\r\n                                                    >\r\n                                                        <Link href={child.href} className=\"text-sm text-muted-foreground hover:text-primary transition-colors\">\r\n                                                            {child.name}\r\n                                                        </Link>\r\n                                                    </SidebarMenuButton>\r\n                                                ))}\r\n                                            </div>\r\n                                        </div>\r\n                                    </div>\r\n                                ) : (\r\n                                    // 没有子菜单的项目\r\n                                    <SidebarMenuButton\r\n                                        asChild\r\n                                        isActive={pathname === item.href || pathname.startsWith(item.href + '/')}\r\n                                        className=\"w-full nav-item hover-lift data-[active=true]:bg-primary/10 data-[active=true]:text-primary\"\r\n                                    >\r\n                                        <Link href={item.href} className=\"flex items-center justify-between\">\r\n                                            <div className=\"flex items-center space-x-3\">\r\n                                                <item.icon className=\"w-5 h-5\" />\r\n                                                <span>{item.name}</span>\r\n                                            </div>\r\n                                            {item.badge && (\r\n                                                <Badge variant=\"secondary\" className=\"bg-primary text-primary-foreground shadow-brand\">\r\n                                                    {item.badge}\r\n                                                </Badge>\r\n                                            )}\r\n                                        </Link>\r\n                                    </SidebarMenuButton>\r\n                                )}\r\n                            </SidebarMenuItem>\r\n                        ))}\r\n                    </SidebarMenu>\r\n                </SidebarContent>\r\n\r\n                <SidebarFooter className=\"p-2\">\r\n                    <SidebarMenu>\r\n                        {bottomItems.map((item) => (\r\n                            <SidebarMenuItem key={item.name}>\r\n                                <SidebarMenuButton\r\n                                    asChild\r\n                                    isActive={pathname === item.href}\r\n                                    size=\"sm\"\r\n                                    className=\"hover:text-primary hover:bg-primary/5\"\r\n                                >\r\n                                    <Link href={item.href} className=\"flex items-center space-x-3\">\r\n                                        <item.icon className=\"w-4 h-4\" />\r\n                                        <span className=\"text-sm\">{item.name}</span>\r\n                                    </Link>\r\n                                </SidebarMenuButton>\r\n                            </SidebarMenuItem>\r\n                        ))}\r\n                    </SidebarMenu>\r\n                </SidebarFooter>\r\n        </Sidebar>\r\n    );\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"D:\\Desktop\\LawClick_NEW\\lawclick-next\\src\\components\\layout\\floating-layer.tsx","messages":[{"ruleId":"react-hooks/set-state-in-effect","severity":1,"message":"Error: Calling setState synchronously within an effect can trigger cascading renders\n\nEffects are intended to synchronize state between React and external systems such as manually updating the DOM, state management libraries, or other platform APIs. In general, the body of an effect should do one or both of the following:\n* Update external systems with the latest state from React.\n* Subscribe for updates from some external system, calling setState in a callback function when external state changes.\n\nCalling setState synchronously within an effect body causes cascading renders that can hurt performance, and is not recommended. (https://react.dev/learn/you-might-not-need-an-effect).\n\nD:\\Desktop\\LawClick_NEW\\lawclick-next\\src\\components\\layout\\floating-layer.tsx:18:9\n  16 |     // 仅用于检测客户端挂载，避免SSR水合问题\n  17 |     useEffect(() => {\n> 18 |         setMounted(true)\n     |         ^^^^^^^^^^ Avoid calling setState() directly within an effect\n  19 |     }, [])\n  20 |\n  21 |     if (!mounted) return null","line":18,"column":9,"nodeType":null,"endLine":18,"endColumn":19}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\"\r\n\r\nimport { useFloatStore } from \"@/store/float-store\"\r\nimport { FloatingWindowFrame } from \"@/components/layout/floating-window-frame\"\r\nimport { useEffect, useState } from \"react\"\r\n\r\n// Content Registry\r\nimport { FloatingChat } from \"@/components/floating/floating-chat\"\nimport { FloatingTimerContent } from \"@/components/floating/timer-content\"\nimport { AIAssistantContent } from \"@/components/floating/ai-assistant-content\"\n\r\nexport function FloatingLayer() {\r\n    const { windows } = useFloatStore()\r\n    const [mounted, setMounted] = useState(false)\r\n\r\n    // 仅用于检测客户端挂载，避免SSR水合问题\r\n    useEffect(() => {\r\n        setMounted(true)\r\n    }, [])\r\n\r\n    if (!mounted) return null\r\n\r\n    return (\r\n        <div className=\"fixed inset-0 pointer-events-none z-[100]\">\r\n            {\r\n                Object.values(windows).map((window) => {\r\n                    if (!window.isOpen) return null\r\n\r\n                    let Content = null\r\n                    switch (window.type) {\r\n                        case 'TIMER':\r\n                            Content = <FloatingTimerContent />\r\n                            break\r\n                        case 'CHAT':\n                            Content = <FloatingChat context={window.data} />\n                            break\n                        case 'AI_PARALEGAL':\n                            Content = <AIAssistantContent context={window.data} />\n                            break\n                        case 'NOTES':\r\n                            Content = <div className=\"p-4 text-muted-foreground text-center\">笔记功能开发中...</div>\r\n                            break\r\n                        default:\r\n                            Content = <div>Unknown Window Type</div>\r\n                    }\r\n\r\n                    return (\r\n                        <div key={window.id} className=\"pointer-events-auto\">\r\n                            <FloatingWindowFrame config={window}>\r\n                                {Content}\r\n                            </FloatingWindowFrame>\r\n                        </div>\r\n                    )\r\n                })\r\n            }\r\n        </div >\r\n    )\r\n}\r\n\r\n","usedDeprecatedRules":[]},{"filePath":"D:\\Desktop\\LawClick_NEW\\lawclick-next\\src\\components\\layout\\floating-window-frame.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\Desktop\\LawClick_NEW\\lawclick-next\\src\\components\\layout\\header-components.tsx","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":65,"column":47,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":65,"endColumn":50,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[2214,2217],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[2214,2217],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"react-hooks/set-state-in-effect","severity":1,"message":"Error: Calling setState synchronously within an effect can trigger cascading renders\n\nEffects are intended to synchronize state between React and external systems such as manually updating the DOM, state management libraries, or other platform APIs. In general, the body of an effect should do one or both of the following:\n* Update external systems with the latest state from React.\n* Subscribe for updates from some external system, calling setState in a callback function when external state changes.\n\nCalling setState synchronously within an effect body causes cascading renders that can hurt performance, and is not recommended. (https://react.dev/learn/you-might-not-need-an-effect).\n\nD:\\Desktop\\LawClick_NEW\\lawclick-next\\src\\components\\layout\\header-components.tsx:218:9\n  216 |     useEffect(() => {\n  217 |         if (!isOpen) return\n> 218 |         setQuery(\"\")\n      |         ^^^^^^^^ Avoid calling setState() directly within an effect\n  219 |         setGroups([])\n  220 |         setSelectedIndex(0)\n  221 |         setLoading(false)","line":218,"column":9,"nodeType":null,"endLine":218,"endColumn":17},{"ruleId":"react-hooks/set-state-in-effect","severity":1,"message":"Error: Calling setState synchronously within an effect can trigger cascading renders\n\nEffects are intended to synchronize state between React and external systems such as manually updating the DOM, state management libraries, or other platform APIs. In general, the body of an effect should do one or both of the following:\n* Update external systems with the latest state from React.\n* Subscribe for updates from some external system, calling setState in a callback function when external state changes.\n\nCalling setState synchronously within an effect body causes cascading renders that can hurt performance, and is not recommended. (https://react.dev/learn/you-might-not-need-an-effect).\n\nD:\\Desktop\\LawClick_NEW\\lawclick-next\\src\\components\\layout\\header-components.tsx:228:13\n  226 |         const q = query.trim()\n  227 |         if (q.length < 2) {\n> 228 |             setGroups([])\n      |             ^^^^^^^^^ Avoid calling setState() directly within an effect\n  229 |             setLoading(false)\n  230 |             return\n  231 |         }","line":228,"column":13,"nodeType":null,"endLine":228,"endColumn":22}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":3,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\"\n\nimport { useEffect, useMemo, useRef, useState, type KeyboardEventHandler } from \"react\"\nimport { useRouter } from \"next/navigation\"\nimport {\n    Activity,\n    Bell,\n    Briefcase,\n    CheckSquare,\n    FileText,\n    Loader2,\n    Search,\n    User2,\n} from \"lucide-react\"\n\nimport { globalSearch, type GlobalSearchGroup, type GlobalSearchItem } from \"@/actions/search-actions\"\nimport { getMyNotifications, markAllNotificationsRead, markNotificationRead } from \"@/actions/notification-actions\"\nimport { Button } from \"@/components/ui/button\"\nimport {\n    Dialog,\n    DialogContent,\n    DialogDescription,\n    DialogFooter,\n    DialogHeader,\n    DialogTitle,\n} from \"@/components/ui/dialog\"\nimport { Popover, PopoverContent, PopoverTrigger } from \"@/components/ui/popover\"\nimport { ScrollArea } from \"@/components/ui/scroll-area\"\n\ntype NotificationActor = { id: string; name: string | null; email: string; avatarUrl: string | null }\n\ntype NotificationItem = {\n    id: string\n    type: string\n    title: string\n    content: string | null\n    actionUrl: string | null\n    readAt: string | Date | null\n    createdAt: string | Date\n    actor: NotificationActor | null\n}\n\nfunction formatRelativeTime(value: string | Date) {\n    const d = typeof value === \"string\" ? new Date(value) : value\n    if (Number.isNaN(d.getTime())) return \"\"\n    const diffMs = Date.now() - d.getTime()\n    if (diffMs < 60_000) return \"刚刚\"\n    if (diffMs < 60 * 60_000) return `${Math.floor(diffMs / 60_000)} 分钟前`\n    if (diffMs < 24 * 60 * 60_000) return `${Math.floor(diffMs / (60 * 60_000))} 小时前`\n    return d.toLocaleString(\"zh-CN\", { month: \"2-digit\", day: \"2-digit\", hour: \"2-digit\", minute: \"2-digit\" })\n}\n\nexport function NotificationTrigger() {\n    const router = useRouter()\n    const [isOpen, setIsOpen] = useState(false)\n    const [notifications, setNotifications] = useState<NotificationItem[]>([])\n    const [unreadCount, setUnreadCount] = useState(0)\n    const [loading, setLoading] = useState(false)\n\n    const refresh = async (take = 20) => {\n        setLoading(true)\n        try {\n            const res = await getMyNotifications({ take })\n            if (res.success) {\n                setNotifications(res.items as any)\n                setUnreadCount(res.unreadCount || 0)\n            }\n        } finally {\n            setLoading(false)\n        }\n    }\n\n    useEffect(() => {\n        void refresh(10)\n    }, [])\n\n    useEffect(() => {\n        if (isOpen) void refresh(30)\n    }, [isOpen])\n\n    const markAsRead = async (id: string) => {\n        const target = notifications.find((n) => n.id === id)\n        if (!target || target.readAt) return\n\n        setNotifications((prev) => prev.map((n) => (n.id === id ? { ...n, readAt: new Date() } : n)))\n        setUnreadCount((prev) => Math.max(0, prev - 1))\n\n        await markNotificationRead(id)\n    }\n\n    const markAllAsRead = async () => {\n        await markAllNotificationsRead()\n        setNotifications((prev) => prev.map((n) => (n.readAt ? n : { ...n, readAt: new Date() })))\n        setUnreadCount(0)\n    }\n\n    const openAll = () => {\n        setIsOpen(false)\n        router.push(\"/notifications\")\n    }\n\n    return (\n        <Popover open={isOpen} onOpenChange={setIsOpen}>\n            <PopoverTrigger asChild>\n                <Button\n                    variant=\"ghost\"\n                    size=\"icon\"\n                    className=\"relative\"\n                    aria-label=\"通知\"\n                    data-testid=\"header-notifications-trigger\"\n                >\n                    <Bell className=\"h-5 w-5\" />\n                    {unreadCount > 0 && (\n                        <span className=\"absolute -top-0.5 -right-0.5 h-4 min-w-4 rounded-full bg-red-500 text-[10px] font-medium text-white flex items-center justify-center px-1\">\n                            {unreadCount > 99 ? \"99+\" : unreadCount}\n                        </span>\n                    )}\n                </Button>\n            </PopoverTrigger>\n            <PopoverContent className=\"w-80 p-0\" align=\"end\">\n                <div className=\"flex items-center justify-between p-3 border-b\">\n                    <h3 className=\"font-semibold text-sm\">通知</h3>\n                    {unreadCount > 0 && (\n                        <Button variant=\"ghost\" size=\"sm\" className=\"text-xs h-7\" onClick={markAllAsRead}>\n                            全部已读\n                        </Button>\n                    )}\n                </div>\n\n                <ScrollArea className=\"h-[320px]\">\n                    {loading ? (\n                        <div className=\"flex items-center justify-center h-32 text-muted-foreground\">\n                            <Loader2 className=\"h-4 w-4 mr-2 animate-spin\" />\n                            <span className=\"text-sm\">加载中...</span>\n                        </div>\n                    ) : notifications.length === 0 ? (\n                        <div className=\"flex flex-col items-center justify-center h-32 text-muted-foreground\">\n                            <Bell className=\"h-8 w-8 mb-2 opacity-50\" />\n                            <p className=\"text-sm\">暂无通知</p>\n                        </div>\n                    ) : (\n                        <div className=\"divide-y\">\n                            {notifications.map((notification) => {\n                                const time = formatRelativeTime(notification.createdAt)\n                                const unread = !notification.readAt\n\n                                const icon =\n                                    notification.type === \"CHAT_MESSAGE\" ? (\n                                        <Bell className=\"h-4 w-4 text-muted-foreground\" />\n                                    ) : notification.type.startsWith(\"CASE_\") ? (\n                                        <Briefcase className=\"h-4 w-4 text-orange-600\" />\n                                    ) : notification.type.startsWith(\"TASK_\") ? (\n                                        <CheckSquare className=\"h-4 w-4 text-blue-600\" />\n                                    ) : (\n                                        <Bell className=\"h-4 w-4 text-muted-foreground\" />\n                                    )\n\n                                return (\n                                    <div\n                                        key={notification.id}\n                                        className={`flex gap-3 p-3 hover:bg-muted/50 transition-colors cursor-pointer ${unread ? \"bg-primary/5\" : \"\"}`}\n                                        onClick={async () => {\n                                            await markAsRead(notification.id)\n                                            if (notification.actionUrl) {\n                                                setIsOpen(false)\n                                                router.push(notification.actionUrl)\n                                            }\n                                        }}\n                                    >\n                                        <div className=\"h-8 w-8 rounded-full bg-muted flex items-center justify-center shrink-0\">\n                                            {icon}\n                                        </div>\n                                        <div className=\"flex-1 min-w-0\">\n                                            <div className=\"flex items-start justify-between gap-2\">\n                                                <p className={`text-sm ${unread ? \"font-medium\" : \"\"}`}>\n                                                    {notification.title}\n                                                </p>\n                                                {unread && (\n                                                    <div className=\"h-2 w-2 rounded-full bg-primary shrink-0 mt-1.5\" />\n                                                )}\n                                            </div>\n                                            {notification.content ? (\n                                                <p className=\"text-xs text-muted-foreground line-clamp-2 mt-0.5\">\n                                                    {notification.content}\n                                                </p>\n                                            ) : null}\n                                            <p className=\"text-[10px] text-muted-foreground mt-1\">{time}</p>\n                                        </div>\n                                    </div>\n                                )\n                            })}\n                        </div>\n                    )}\n                </ScrollArea>\n\n                <div className=\"p-2 border-t\">\n                    <Button variant=\"ghost\" size=\"sm\" className=\"w-full text-xs\" onClick={openAll}>\n                        查看全部通知\n                    </Button>\n                </div>\n            </PopoverContent>\n        </Popover>\n    )\n}\n\nexport function GlobalSearch({ isOpen, onClose }: { isOpen: boolean; onClose: () => void }) {\n    const router = useRouter()\n    const [query, setQuery] = useState(\"\")\n    const [loading, setLoading] = useState(false)\n    const [groups, setGroups] = useState<GlobalSearchGroup[]>([])\n    const [selectedIndex, setSelectedIndex] = useState(0)\n    const requestSeq = useRef(0)\n\n    const flatItems = useMemo(() => groups.flatMap((g) => g.items), [groups])\n\n    useEffect(() => {\n        if (!isOpen) return\n        setQuery(\"\")\n        setGroups([])\n        setSelectedIndex(0)\n        setLoading(false)\n    }, [isOpen])\n\n    useEffect(() => {\n        if (!isOpen) return\n        const q = query.trim()\n        if (q.length < 2) {\n            setGroups([])\n            setLoading(false)\n            return\n        }\n\n        const seq = ++requestSeq.current\n        const timer = setTimeout(async () => {\n            setLoading(true)\n            const res = await globalSearch(q, { takePerType: 6 })\n            if (seq !== requestSeq.current) return\n            setGroups(res.success ? res.data.groups || [] : [])\n            setSelectedIndex(0)\n            setLoading(false)\n        }, 200)\n\n        return () => clearTimeout(timer)\n    }, [query, isOpen])\n\n    const pick = (item: GlobalSearchItem) => {\n        onClose()\n        router.push(item.url)\n    }\n\n    const onKeyDown: KeyboardEventHandler<HTMLInputElement> = (e) => {\n        if (e.key === \"Escape\") {\n            e.preventDefault()\n            onClose()\n            return\n        }\n        if (flatItems.length === 0) return\n\n        if (e.key === \"ArrowDown\") {\n            e.preventDefault()\n            setSelectedIndex((prev) => (prev + 1) % flatItems.length)\n        } else if (e.key === \"ArrowUp\") {\n            e.preventDefault()\n            setSelectedIndex((prev) => (prev - 1 + flatItems.length) % flatItems.length)\n        } else if (e.key === \"Enter\") {\n            e.preventDefault()\n            const item = flatItems[selectedIndex]\n            if (item) pick(item)\n        }\n    }\n\n    if (!isOpen) return null\n\n    return (\n        <div className=\"fixed inset-0 z-50 bg-black/50 flex items-start justify-center pt-20\" onClick={onClose}>\n            <div className=\"bg-white p-4 rounded-lg w-[640px] h-[420px]\" onClick={(e) => e.stopPropagation()}>\n                <div className=\"flex items-center gap-2 border-b pb-2\">\n                    <Search className=\"h-4 w-4\" />\n                    <input\n                        className=\"flex-1 outline-none\"\n                        placeholder=\"搜索案件、任务、文档、客户…（至少 2 个字）\"\n                        autoFocus\n                        value={query}\n                        onChange={(e) => setQuery(e.target.value)}\n                        onKeyDown={onKeyDown}\n                    />\n                    {loading ? <Loader2 className=\"h-4 w-4 animate-spin text-muted-foreground\" /> : null}\n                </div>\n\n                <ScrollArea className=\"h-[360px] pr-2\">\n                    <div className=\"py-3\">\n                        {query.trim().length < 2 ? (\n                            <div className=\"p-4 text-center text-muted-foreground text-sm\">输入至少 2 个字开始搜索</div>\n                        ) : !loading && groups.length === 0 ? (\n                            <div className=\"p-4 text-center text-muted-foreground text-sm\">无匹配结果</div>\n                        ) : (\n                            <div className=\"space-y-4\">\n                                {groups.map((group) => (\n                                    <div key={group.type} className=\"space-y-1\">\n                                        <div className=\"text-xs font-medium text-muted-foreground px-2\">\n                                            {group.label}\n                                        </div>\n                                        <div className=\"border rounded-md overflow-hidden\">\n                                            {group.items.map((item) => {\n                                                const idx = flatItems.findIndex(\n                                                    (x) => x.type === item.type && x.id === item.id\n                                                )\n                                                const selected = idx === selectedIndex\n\n                                                const icon =\n                                                    item.type === \"CASE\" ? (\n                                                        <Briefcase className=\"h-4 w-4 text-orange-600\" />\n                                                    ) : item.type === \"TASK\" ? (\n                                                        <CheckSquare className=\"h-4 w-4 text-blue-600\" />\n                                                    ) : item.type === \"DOCUMENT\" ? (\n                                                        <FileText className=\"h-4 w-4 text-slate-600\" />\n                                                    ) : (\n                                                        <User2 className=\"h-4 w-4 text-slate-600\" />\n                                                    )\n\n                                                return (\n                                                    <button\n                                                        key={item.id}\n                                                        type=\"button\"\n                                                        className={`w-full text-left px-3 py-2 flex items-start gap-3 hover:bg-muted/50 transition-colors ${selected ? \"bg-muted\" : \"\"}`}\n                                                        onMouseEnter={() => setSelectedIndex(Math.max(0, idx))}\n                                                        onClick={() => pick(item)}\n                                                    >\n                                                        <div className=\"mt-0.5\">{icon}</div>\n                                                        <div className=\"min-w-0 flex-1\">\n                                                            <div className=\"text-sm font-medium truncate\">\n                                                                {item.title}\n                                                            </div>\n                                                            <div className=\"text-xs text-muted-foreground truncate\">\n                                                                {item.subtitle}\n                                                            </div>\n                                                        </div>\n                                                    </button>\n                                                )\n                                            })}\n                                        </div>\n                                    </div>\n                                ))}\n                            </div>\n                        )}\n                    </div>\n                </ScrollArea>\n            </div>\n        </div>\n    )\n}\n\nexport function PerformanceMonitor({ isVisible, onClose }: { isVisible: boolean; onClose: () => void }) {\n    if (!isVisible) return null\n\n    type HeapMemory = { usedJSHeapSize?: number; jsHeapSizeLimit?: number }\n    const cores = typeof navigator !== \"undefined\" ? navigator.hardwareConcurrency : null\n    const maybeMemory = (\n        typeof performance !== \"undefined\" ? (performance as unknown as { memory?: HeapMemory }).memory : undefined\n    ) as HeapMemory | undefined\n    const usedMB = maybeMemory?.usedJSHeapSize ? Math.round(maybeMemory.usedJSHeapSize / 1024 / 1024) : null\n    const limitMB = maybeMemory?.jsHeapSizeLimit ? Math.round(maybeMemory.jsHeapSizeLimit / 1024 / 1024) : null\n\n    return (\n        <div className=\"fixed inset-0 z-50 flex items-center justify-center bg-black/50\" onClick={onClose}>\n            <div className=\"bg-white p-6 rounded-lg shadow-xl\" onClick={(e) => e.stopPropagation()}>\n                <h3 className=\"text-lg font-bold mb-2 flex items-center gap-2\">\n                    <Activity className=\"h-5 w-5 text-green-600\" />\n                    性能与环境（浏览器侧）\n                </h3>\n                <p className=\"text-xs text-muted-foreground mb-4\">\n                    说明：本面板仅展示客户端可获取的运行时信息，不代表服务器负载。\n                </p>\n                <div className=\"space-y-2 text-sm\">\n                    <p>逻辑 CPU 核心：{cores ?? \"未知\"}</p>\n                    <p>\n                        JS Heap：{\" \"}\n                        {usedMB != null && limitMB != null\n                            ? `${usedMB}MB / ${limitMB}MB`\n                            : \"浏览器不支持\"}\n                    </p>\n                </div>\n                <Button onClick={onClose} className=\"mt-4 w-full\">\n                    关闭\n                </Button>\n            </div>\n        </div>\n    )\n}\n\nexport function useConfirmationDialog() {\n    const [isOpen, setIsOpen] = useState(false)\n    const [config, setConfig] = useState<{\n        title: string\n        message: string\n        type: \"warning\" | \"info\"\n        onConfirm: () => void\n    } | null>(null)\n\n    const showConfirmation = (cfg: {\n        title: string\n        message: string\n        type: \"warning\" | \"info\"\n        onConfirm: () => void\n    }) => {\n        setConfig(cfg)\n        setIsOpen(true)\n    }\n\n    const ConfirmationDialog = () => (\n        <Dialog open={isOpen} onOpenChange={setIsOpen}>\n            <DialogContent>\n                <DialogHeader>\n                    <DialogTitle>{config?.title}</DialogTitle>\n                    <DialogDescription className=\"whitespace-pre-wrap\">{config?.message}</DialogDescription>\n                </DialogHeader>\n                <DialogFooter>\n                    <Button variant=\"outline\" onClick={() => setIsOpen(false)}>\n                        取消\n                    </Button>\n                    <Button\n                        variant={config?.type === \"warning\" ? \"destructive\" : \"default\"}\n                        onClick={() => {\n                            config?.onConfirm()\n                            setIsOpen(false)\n                        }}\n                    >\n                        确认\n                    </Button>\n                </DialogFooter>\n            </DialogContent>\n        </Dialog>\n    )\n\n    return { showConfirmation, ConfirmationDialog }\n}\n","usedDeprecatedRules":[]},{"filePath":"D:\\Desktop\\LawClick_NEW\\lawclick-next\\src\\components\\layout\\role-context.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\Desktop\\LawClick_NEW\\lawclick-next\\src\\components\\layout\\split-screen.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\Desktop\\LawClick_NEW\\lawclick-next\\src\\components\\profile\\ProfileClient.tsx","messages":[{"ruleId":"@next/next/no-img-element","severity":1,"message":"Using `<img>` could result in slower LCP and higher bandwidth. Consider using `<Image />` from `next/image` or a custom image loader to automatically optimize images. This may incur additional usage or cost from your provider. See: https://nextjs.org/docs/messages/no-img-element","line":47,"column":37,"nodeType":"JSXOpeningElement","endLine":47,"endColumn":122}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\"\r\n\r\nimport React, { useState } from 'react'\r\nimport { useRouter } from 'next/navigation'\r\nimport { Button } from \"@/components/ui/button\"\r\nimport { Switch } from \"@/components/ui/switch\"\r\nimport { User, X, ChevronRight, Briefcase, Bell, UserCircle } from 'lucide-react'\r\nimport { cn } from \"@/lib/utils\"\r\n\r\ninterface ProfileClientProps {\r\n    user: {\r\n        name?: string | null\r\n        email?: string | null\r\n        image?: string | null\r\n    }\r\n}\r\n\r\nexport function ProfileClient({ user }: ProfileClientProps) {\r\n    const router = useRouter()\r\n    const [virtualHumanEnabled, setVirtualHumanEnabled] = useState(false)\r\n\r\n    const projects = [\r\n        { code: \"00\", name: \"临时未立项业务工作\", color: \"bg-green-500\" },\r\n        { code: \"02\", name: \"丰城住总, 常年顾问, 2023-2024\", color: \"bg-blue-500\" },\r\n        { code: \"02\", name: \"供应链, 常年顾问, 2024-2025\", color: \"bg-orange-500\" },\r\n        { code: \"01\", name: \"某某诉讼案件, 一审\", color: \"bg-purple-500\" },\r\n        { code: \"03\", name: \"企业合规专项服务\", color: \"bg-teal-500\" },\r\n    ]\r\n\r\n    return (\r\n        <div className=\"flex justify-center min-h-screen bg-muted/20\">\r\n            <div className=\"w-full max-w-md bg-background shadow-lg min-h-screen flex flex-col\">\r\n                {/* Header */}\r\n                <header className=\"flex-shrink-0 p-4 flex items-center justify-end border-b\">\r\n                    <Button variant=\"ghost\" size=\"icon\" onClick={() => router.back()}>\r\n                        <X className=\"w-6 h-6 text-muted-foreground\" />\r\n                    </Button>\r\n                </header>\r\n\r\n                {/* Main Content */}\r\n                <main className=\"flex-grow overflow-y-auto p-0\">\r\n                    {/* Profile Header */}\r\n                    <div className=\"p-6 bg-background\">\r\n                        <div className=\"flex items-start gap-4\">\r\n                            <div className=\"h-20 w-20 bg-blue-100 dark:bg-blue-900/30 rounded-full flex items-center justify-center flex-shrink-0\">\r\n                                {user.image ? (\r\n                                    <img src={user.image} alt=\"Avatar\" className=\"h-20 w-20 rounded-full object-cover\" />\r\n                                ) : (\r\n                                    <User className=\"w-10 h-10 text-blue-600 dark:text-blue-400\" />\r\n                                )}\r\n                            </div>\r\n                            <div className=\"flex-grow pt-1\">\r\n                                <h2 className=\"text-2xl font-bold\">{user.name || \"Demo Lawyer\"}</h2>\r\n                                <p className=\"text-sm mt-1 text-muted-foreground\">江西凌科安时律师事务所</p>\r\n                                <p className=\"text-sm mt-1 text-muted-foreground\">{user.email || \"lawyer@lawclick.com\"}</p>\r\n                            </div>\r\n                        </div>\r\n                    </div>\r\n\r\n                    <div className=\"h-2 bg-muted/20\" />\r\n\r\n                    {/* Project List */}\r\n                    <div className=\"bg-background\">\r\n                        <div className=\"p-4 flex justify-between items-center border-b\">\r\n                            <h3 className=\"font-bold flex items-center gap-2\">\r\n                                <Briefcase className=\"w-4 h-4\" />\r\n                                当前项目\r\n                            </h3>\r\n                            <span className=\"text-sm text-muted-foreground\">共 {projects.length}</span>\r\n                        </div>\r\n                        <div className=\"p-4 flex flex-col gap-4\">\r\n                            {projects.map((project, index) => (\r\n                                <div key={index} className=\"flex items-center gap-3 p-2 rounded-lg hover:bg-muted/50 transition-colors cursor-pointer\">\r\n                                    <span className={cn(\"h-3 w-3 rounded-full flex-shrink-0\", project.color)}></span>\r\n                                    <span className=\"text-sm font-mono text-muted-foreground\">{project.code},</span>\r\n                                    <span className=\"flex-grow font-medium truncate text-sm\">{project.name}</span>\r\n                                </div>\r\n                            ))}\r\n                        </div>\r\n                    </div>\r\n\r\n                    <div className=\"h-2 bg-muted/20\" />\r\n\r\n                    {/* Settings List */}\r\n                    <div className=\"bg-background\">\r\n                        <div className=\"flex items-center p-4 border-b cursor-pointer hover:bg-muted/50 transition-colors\">\r\n                            <span className=\"font-medium flex-grow\">统计报告</span>\r\n                            <ChevronRight className=\"w-5 h-5 text-muted-foreground\" />\r\n                        </div>\r\n\r\n                        <h3 className=\"font-bold px-4 py-3 text-sm text-muted-foreground bg-muted/10\">个性化</h3>\r\n\r\n                        <div className=\"flex items-center p-4 border-b cursor-pointer hover:bg-muted/50 transition-colors\">\r\n                            <Bell className=\"w-5 h-5 mr-3 text-muted-foreground\" />\r\n                            <span className=\"font-medium flex-grow\">通知提醒</span>\r\n                            <ChevronRight className=\"w-5 h-5 text-muted-foreground\" />\r\n                        </div>\r\n\r\n                        <div className=\"flex items-center p-4 border-b cursor-pointer hover:bg-muted/50 transition-colors\">\r\n                            <UserCircle className=\"w-5 h-5 mr-3 text-muted-foreground\" />\r\n                            <span className=\"font-medium flex-grow\">主页形象</span>\r\n                            <ChevronRight className=\"w-5 h-5 text-muted-foreground\" />\r\n                        </div>\r\n\r\n                        <div className=\"flex items-center p-4 cursor-pointer hover:bg-muted/50 transition-colors justify-between\">\r\n                            <span className=\"font-medium\">虚拟人打招呼</span>\r\n                            <Switch\r\n                                checked={virtualHumanEnabled}\r\n                                onCheckedChange={setVirtualHumanEnabled}\r\n                            />\r\n                        </div>\r\n                    </div>\r\n                </main>\r\n            </div>\r\n        </div>\r\n    )\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"D:\\Desktop\\LawClick_NEW\\lawclick-next\\src\\components\\providers\\session-provider.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\Desktop\\LawClick_NEW\\lawclick-next\\src\\components\\tasks\\TaskDetailDialog.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\Desktop\\LawClick_NEW\\lawclick-next\\src\\components\\tasks\\TaskKanban.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\Desktop\\LawClick_NEW\\lawclick-next\\src\\components\\timelog\\TimeApprovalClient.tsx","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":48,"column":46,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":48,"endColumn":49,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1562,1565],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1562,1565],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\"\n\nimport * as React from \"react\"\nimport { toast } from \"sonner\"\nimport { Loader2 } from \"lucide-react\"\n\nimport { Card, CardContent, CardDescription, CardHeader, CardTitle } from \"@/components/ui/card\"\nimport { Button } from \"@/components/ui/button\"\nimport { Badge } from \"@/components/ui/badge\"\nimport {\n    approveTimeLog,\n    getTimeLogsPendingApproval,\n    markTimeLogBilled,\n    unapproveTimeLog,\n    unmarkTimeLogBilled,\n} from \"@/actions/timelogs-crud\"\n\ntype ApprovalLog = {\n    id: string\n    description: string\n    duration: number\n    status: \"COMPLETED\" | \"APPROVED\" | \"BILLED\"\n    isBillable: boolean\n    user?: { id: string; name: string | null; email: string } | null\n    case?: { id: string; title: string; caseCode: string } | null\n    task?: { id: string; title: string } | null\n}\n\nfunction formatDurationCompact(seconds: number) {\n    const s = Math.max(0, Math.floor(seconds))\n    const h = Math.floor(s / 3600)\n    const m = Math.floor((s % 3600) / 60)\n    if (h > 0) return `${h}h ${m}m`\n    return `${m}m`\n}\n\nexport function TimeApprovalClient({ enabled, onChanged }: { enabled: boolean; onChanged?: () => void }) {\n    const [loading, setLoading] = React.useState(true)\n    const [logs, setLogs] = React.useState<ApprovalLog[]>([])\n\n    const load = React.useCallback(async () => {\n        if (!enabled) return\n        setLoading(true)\n        const res = await getTimeLogsPendingApproval({\n            take: 100,\n            status: [\"COMPLETED\", \"APPROVED\", \"BILLED\"],\n        })\n        if (res.success) setLogs(res.data as any)\n        setLoading(false)\n    }, [enabled])\n\n    React.useEffect(() => {\n        load()\n    }, [load])\n\n    const mutate = async (fn: () => Promise<{ success: boolean; error?: string }>) => {\n        const res = await fn()\n        if (!res.success) {\n            toast.error(\"操作失败\", { description: res.error })\n            return\n        }\n        toast.success(\"已更新\")\n        await load()\n        onChanged?.()\n    }\n\n    if (!enabled) {\n        return (\n            <Card>\n                <CardHeader>\n                    <CardTitle className=\"text-base\">待审批</CardTitle>\n                    <CardDescription>当前角色无 timelog:approve 权限</CardDescription>\n                </CardHeader>\n            </Card>\n        )\n    }\n\n    return (\n        <Card>\n            <CardHeader>\n                <CardTitle className=\"text-base\">待审批 / 已审批 / 已计费</CardTitle>\n                <CardDescription>工时状态流：COMPLETED → APPROVED → BILLED</CardDescription>\n            </CardHeader>\n            <CardContent>\n                {loading ? (\n                    <div className=\"flex items-center justify-center py-10 text-muted-foreground\">\n                        <Loader2 className=\"h-5 w-5 animate-spin mr-2\" />\n                        加载中...\n                    </div>\n                ) : logs.length === 0 ? (\n                    <div className=\"text-center py-10 text-muted-foreground\">暂无记录</div>\n                ) : (\n                    <div className=\"space-y-2\">\n                        {logs.map((log) => (\n                            <div\n                                key={log.id}\n                                className=\"flex items-center justify-between gap-4 p-3 rounded-lg border bg-background hover:bg-muted/30 transition-colors\"\n                            >\n                                <div className=\"min-w-0\">\n                                    <div className=\"font-medium truncate\">{log.description}</div>\n                                    <div className=\"text-xs text-muted-foreground mt-1\">\n                                        {log.user?.name || log.user?.email} · {formatDurationCompact(log.duration)} ·{\" \"}\n                                        {log.isBillable ? \"可计费\" : \"不计费\"}\n                                    </div>\n                                    {log.case && (\n                                        <div className=\"text-xs text-muted-foreground mt-1 truncate\">\n                                            {log.case.caseCode} · {log.case.title}\n                                            {log.task ? ` · ${log.task.title}` : \"\"}\n                                        </div>\n                                    )}\n                                </div>\n                                <div className=\"flex items-center gap-2 flex-shrink-0\">\n                                    <Badge\n                                        variant={\n                                            log.status === \"BILLED\"\n                                                ? \"default\"\n                                                : log.status === \"APPROVED\"\n                                                    ? \"secondary\"\n                                                    : \"outline\"\n                                        }\n                                    >\n                                        {log.status}\n                                    </Badge>\n\n                                    {log.status === \"COMPLETED\" && (\n                                        <Button size=\"sm\" onClick={() => mutate(() => approveTimeLog(log.id))}>\n                                            审批\n                                        </Button>\n                                    )}\n\n                                    {log.status === \"APPROVED\" && (\n                                        <>\n                                            <Button size=\"sm\" variant=\"outline\" onClick={() => mutate(() => unapproveTimeLog(log.id))}>\n                                                撤销\n                                            </Button>\n                                            <Button size=\"sm\" onClick={() => mutate(() => markTimeLogBilled(log.id))}>\n                                                计费\n                                            </Button>\n                                        </>\n                                    )}\n\n                                    {log.status === \"BILLED\" && (\n                                        <Button size=\"sm\" variant=\"outline\" onClick={() => mutate(() => unmarkTimeLogBilled(log.id))}>\n                                            撤销计费\n                                        </Button>\n                                    )}\n                                </div>\n                            </div>\n                        ))}\n                    </div>\n                )}\n            </CardContent>\n        </Card>\n    )\n}\n\n","usedDeprecatedRules":[]},{"filePath":"D:\\Desktop\\LawClick_NEW\\lawclick-next\\src\\components\\timelog\\TimeLogClient.tsx","messages":[],"suppressedMessages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":31,"column":12,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":31,"endColumn":15,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1059,1062],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1059,1062],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}],"suppressions":[{"kind":"directive","justification":""}]}],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\Desktop\\LawClick_NEW\\lawclick-next\\src\\components\\timelog\\TimeTrackingClient.tsx","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":61,"column":64,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":61,"endColumn":67,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[2130,2133],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[2130,2133],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":61,"column":101,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":61,"endColumn":104,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[2167,2170],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[2167,2170],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":28,"column":18,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":28,"endColumn":21,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[917,920],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[917,920],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}],"suppressions":[{"kind":"directive","justification":""}]}],"errorCount":0,"fatalErrorCount":0,"warningCount":2,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\"\n\nimport * as React from \"react\"\nimport type { Role } from \"@prisma/client\"\nimport { useRouter } from \"next/navigation\"\nimport { Timer } from \"lucide-react\"\n\nimport { Button } from \"@/components/ui/button\"\nimport { Tabs, TabsContent, TabsList, TabsTrigger } from \"@/components/ui/tabs\"\nimport { TimeApprovalClient } from \"@/components/timelog/TimeApprovalClient\"\nimport { TimeLogClient } from \"@/components/timelog/TimeLogClient\"\nimport { TimerWidget } from \"@/components/timelog/TimerWidget\"\nimport { hasPermission } from \"@/lib/permissions\"\nimport { useFloatStore } from \"@/store/float-store\"\n\ntype CaseOption = { id: string; title: string; caseCode: string }\n\nexport function TimeTrackingClient({\n    userId,\n    userRole,\n    cases,\n    initialLogs,\n}: {\n    userId: string\n    userRole: Role\n    cases: CaseOption[]\n    // eslint-disable-next-line @typescript-eslint/no-explicit-any\n    initialLogs: any[]\n}) {\n    const router = useRouter()\n    const { openWindow } = useFloatStore()\n    const canApprove = hasPermission(userRole, \"timelog:approve\")\n\n    return (\n        <div className=\"space-y-6\">\n            <div className=\"flex items-center justify-between gap-4\">\n                <div>\n                    <h1 className=\"text-2xl font-bold tracking-tight\">工时追踪</h1>\n                    <p className=\"text-muted-foreground\">案件/任务 → 计时 → 复盘/计费</p>\n                </div>\n                <Button variant=\"outline\" onClick={() => openWindow(\"timer\", \"TIMER\", \"计时器\")}>\n                    <Timer className=\"h-4 w-4 mr-2\" />\n                    打开计时器\n                </Button>\n            </div>\n\n            <TimerWidget\n                cases={cases}\n                onTimerChanged={() => {\n                    router.refresh()\n                }}\n            />\n\n            <Tabs defaultValue=\"logs\">\n                <TabsList>\n                    <TabsTrigger value=\"logs\">我的记录</TabsTrigger>\n                    {canApprove && <TabsTrigger value=\"approve\">审批</TabsTrigger>}\n                </TabsList>\n\n                <TabsContent value=\"logs\">\n                    <TimeLogClient initialLogs={initialLogs as any} userId={userId} cases={cases as any} />\n                </TabsContent>\n\n                {canApprove && (\n                    <TabsContent value=\"approve\">\n                        <TimeApprovalClient enabled={true} onChanged={() => router.refresh()} />\n                    </TabsContent>\n                )}\n            </Tabs>\n        </div>\n    )\n}\n","usedDeprecatedRules":[]},{"filePath":"D:\\Desktop\\LawClick_NEW\\lawclick-next\\src\\components\\timelog\\TimerWidget.tsx","messages":[{"ruleId":"react-hooks/set-state-in-effect","severity":1,"message":"Error: Calling setState synchronously within an effect can trigger cascading renders\n\nEffects are intended to synchronize state between React and external systems such as manually updating the DOM, state management libraries, or other platform APIs. In general, the body of an effect should do one or both of the following:\n* Update external systems with the latest state from React.\n* Subscribe for updates from some external system, calling setState in a callback function when external state changes.\n\nCalling setState synchronously within an effect body causes cascading renders that can hurt performance, and is not recommended. (https://react.dev/learn/you-might-not-need-an-effect).\n\nD:\\Desktop\\LawClick_NEW\\lawclick-next\\src\\components\\timelog\\TimerWidget.tsx:94:9\n  92 |\n  93 |     useEffect(() => {\n> 94 |         loadActiveTimer()\n     |         ^^^^^^^^^^^^^^^ Avoid calling setState() directly within an effect\n  95 |     }, [loadActiveTimer])\n  96 |\n  97 |     // 计时器更新","line":94,"column":9,"nodeType":null,"endLine":94,"endColumn":24}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\"\r\n\r\nimport * as React from \"react\"\r\nimport { useState, useEffect, useCallback } from \"react\"\r\nimport { Card, CardContent } from \"@/components/ui/card\"\r\nimport { Button } from \"@/components/ui/button\"\r\nimport { Badge } from \"@/components/ui/badge\"\r\nimport { Input } from \"@/components/ui/input\"\r\nimport {\r\n    Dialog,\r\n    DialogContent,\r\n    DialogHeader,\r\n    DialogTitle,\r\n    DialogFooter,\r\n} from \"@/components/ui/dialog\"\r\nimport { Label } from \"@/components/ui/label\"\r\nimport {\r\n    Select,\r\n    SelectContent,\r\n    SelectItem,\r\n    SelectTrigger,\r\n    SelectValue,\r\n} from \"@/components/ui/select\"\r\nimport {\r\n    Play,\r\n    Pause,\r\n    Square,\r\n    Clock,\r\n    Briefcase,\r\n    Loader2\r\n} from \"lucide-react\"\r\nimport {\r\n    startTimer,\r\n    stopTimer,\r\n    pauseTimer,\r\n    resumeTimer,\r\n    getActiveTimer\r\n} from \"@/actions/timelogs-crud\"\r\nimport { toast } from \"sonner\"\r\n\r\n// ==============================================================================\r\n// Types\r\n// ==============================================================================\r\n\r\ninterface TimerWidgetProps {\r\n    cases?: Array<{ id: string; title: string; caseCode: string }>\r\n    onTimerChanged?: () => void\r\n}\r\n\r\ninterface ActiveTimer {\r\n    id: string\r\n    description: string\r\n    startTime: Date\r\n    duration: number\r\n    status: 'RUNNING' | 'PAUSED'\r\n    case?: { id: string; title: string; caseCode: string } | null\r\n    task?: { id: string; title: string } | null\r\n}\r\n\r\n// ==============================================================================\r\n// Component\r\n// ==============================================================================\r\n\r\nexport function TimerWidget({ cases = [], onTimerChanged }: TimerWidgetProps) {\r\n    const [activeTimer, setActiveTimer] = useState<ActiveTimer | null>(null)\r\n    const [elapsedSeconds, setElapsedSeconds] = useState(0)\r\n    const [loading, setLoading] = useState(true)\r\n    const [showStartDialog, setShowStartDialog] = useState(false)\r\n    const [starting, setStarting] = useState(false)\r\n    const [stopping, setStopping] = useState(false)\r\n\r\n    const [newTimer, setNewTimer] = useState({\r\n        description: '',\r\n        caseId: ''\r\n    })\r\n\r\n    // 加载活动计时\r\n    const loadActiveTimer = useCallback(async () => {\r\n        const timer = await getActiveTimer()\r\n        setActiveTimer(timer as ActiveTimer | null)\r\n        if (timer) {\r\n            // 计算已过时间\r\n            const now = new Date()\r\n            const start = new Date(timer.startTime)\r\n            const elapsed = Math.floor((now.getTime() - start.getTime()) / 1000) + timer.duration\r\n            setElapsedSeconds(elapsed)\r\n        } else {\r\n            setElapsedSeconds(0)\r\n        }\r\n        setLoading(false)\r\n    }, [])\r\n\r\n    useEffect(() => {\r\n        loadActiveTimer()\r\n    }, [loadActiveTimer])\r\n\r\n    // 计时器更新\r\n    useEffect(() => {\r\n        if (activeTimer?.status === 'RUNNING') {\r\n            const interval = setInterval(() => {\r\n                setElapsedSeconds(prev => prev + 1)\r\n            }, 1000)\r\n            return () => clearInterval(interval)\r\n        }\r\n    }, [activeTimer?.status])\r\n\r\n    // 开始计时\r\n    const handleStart = async () => {\r\n        if (!newTimer.description.trim()) return\r\n        if (cases.length > 0 && !newTimer.caseId) {\r\n            toast.error(\"请选择案件\")\r\n            return\r\n        }\r\n\r\n        setStarting(true)\r\n        const result = await startTimer({\r\n            description: newTimer.description,\r\n            caseId: newTimer.caseId || undefined\r\n        })\r\n\r\n        if (!result.success) {\r\n            toast.error(\"开始计时失败\", { description: result.error })\r\n            setStarting(false)\r\n            return\r\n        }\r\n\r\n        await loadActiveTimer()\r\n        setShowStartDialog(false)\r\n        setNewTimer({ description: '', caseId: '' })\r\n        onTimerChanged?.()\r\n        setStarting(false)\r\n    }\r\n\r\n    // 停止计时\r\n    const handleStop = async () => {\r\n        if (!activeTimer) return\r\n\r\n        setStopping(true)\r\n        const result = await stopTimer(activeTimer.id)\r\n\r\n        if (result.success) {\r\n            setActiveTimer(null)\r\n            setElapsedSeconds(0)\r\n            onTimerChanged?.()\r\n        }\r\n        setStopping(false)\r\n    }\r\n\r\n    // 暂停/恢复\r\n    const handlePauseResume = async () => {\r\n        if (!activeTimer) return\r\n\r\n        if (activeTimer.status === 'RUNNING') {\r\n            await pauseTimer(activeTimer.id)\r\n        } else {\r\n            await resumeTimer(activeTimer.id)\r\n        }\r\n        await loadActiveTimer()\r\n    }\r\n\r\n    // 格式化显示时间\r\n    const formatTime = (seconds: number) => {\r\n        const hours = Math.floor(seconds / 3600)\r\n        const mins = Math.floor((seconds % 3600) / 60)\r\n        const secs = seconds % 60\r\n        return `${hours.toString().padStart(2, '0')}:${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`\r\n    }\r\n\r\n    if (loading) {\r\n        return (\r\n            <Card className=\"bg-gradient-to-r from-orange-50 to-amber-50 border-orange-200\">\r\n                <CardContent className=\"p-4 flex items-center justify-center\">\r\n                    <Loader2 className=\"h-5 w-5 animate-spin text-orange-500\" />\r\n                </CardContent>\r\n            </Card>\r\n        )\r\n    }\r\n\r\n    return (\r\n        <>\r\n            <Card className={`border-2 transition-colors ${activeTimer?.status === 'RUNNING'\r\n                ? 'bg-gradient-to-r from-orange-50 to-amber-50 border-orange-300'\r\n                : activeTimer?.status === 'PAUSED'\r\n                    ? 'bg-gradient-to-r from-yellow-50 to-amber-50 border-yellow-300'\r\n                    : 'border-gray-200'\r\n                }`}>\r\n                <CardContent className=\"p-4\">\r\n                    {activeTimer ? (\r\n                        <div className=\"space-y-3\">\r\n                            {/* 计时显示 */}\r\n                            <div className=\"flex items-center justify-between\">\r\n                                <div className=\"flex items-center gap-2\">\r\n                                    <Clock className={`h-5 w-5 ${activeTimer.status === 'RUNNING' ? 'text-orange-500 animate-pulse' : 'text-yellow-500'}`} />\r\n                                    <span className=\"font-mono text-2xl font-bold\">\r\n                                        {formatTime(elapsedSeconds)}\r\n                                    </span>\r\n                                    {activeTimer.status === 'PAUSED' && (\r\n                                        <Badge variant=\"secondary\" className=\"bg-yellow-100 text-yellow-700\">\r\n                                            已暂停\r\n                                        </Badge>\r\n                                    )}\r\n                                </div>\r\n                                <div className=\"flex gap-2\">\r\n                                    <Button\n                                        size=\"icon\"\n                                        variant=\"outline\"\n                                        onClick={handlePauseResume}\n                                        title={activeTimer.status === 'RUNNING' ? '暂停' : '继续'}\n                                        aria-label={activeTimer.status === 'RUNNING' ? '暂停计时' : '继续计时'}\n                                        data-testid=\"timer-widget-toggle\"\n                                    >\n                                        {activeTimer.status === 'RUNNING' ? (\r\n                                            <Pause className=\"h-4 w-4\" />\r\n                                        ) : (\r\n                                            <Play className=\"h-4 w-4\" />\r\n                                        )}\r\n                                    </Button>\r\n                                    <Button\n                                        size=\"icon\"\n                                        variant=\"destructive\"\n                                        onClick={handleStop}\n                                        disabled={stopping}\n                                        title=\"停止\"\n                                        aria-label=\"停止计时\"\n                                        data-testid=\"timer-widget-stop\"\n                                    >\n                                        {stopping ? (\r\n                                            <Loader2 className=\"h-4 w-4 animate-spin\" />\r\n                                        ) : (\r\n                                            <Square className=\"h-4 w-4\" />\r\n                                        )}\r\n                                    </Button>\r\n                                </div>\r\n                            </div>\r\n\r\n                            {/* 描述 */}\r\n                            <div className=\"text-sm text-muted-foreground\">\r\n                                {activeTimer.description}\r\n                            </div>\r\n\r\n                            {/* 关联案件 */}\r\n                            {activeTimer.case && (\r\n                                <div className=\"flex items-center gap-2 text-xs\">\r\n                                    <Briefcase className=\"h-3 w-3 text-blue-500\" />\r\n                                    <span className=\"text-blue-600\">\r\n                                        {activeTimer.case.caseCode} - {activeTimer.case.title}\r\n                                    </span>\r\n                                </div>\r\n                            )}\r\n                        </div>\r\n                    ) : (\r\n                        <div className=\"flex items-center justify-between\">\r\n                            <div className=\"flex items-center gap-2 text-muted-foreground\">\r\n                                <Clock className=\"h-5 w-5\" />\r\n                                <span>未在计时</span>\r\n                            </div>\r\n                            <Button\r\n                                onClick={() => setShowStartDialog(true)}\r\n                                className=\"bg-orange-500 hover:bg-orange-600\"\r\n                            >\r\n                                <Play className=\"h-4 w-4 mr-1\" />\r\n                                开始计时\r\n                            </Button>\r\n                        </div>\r\n                    )}\r\n                </CardContent>\r\n            </Card>\r\n\r\n            {/* 开始计时对话框 */}\r\n            <Dialog open={showStartDialog} onOpenChange={setShowStartDialog}>\r\n                <DialogContent>\r\n                    <DialogHeader>\r\n                        <DialogTitle>开始计时</DialogTitle>\r\n                    </DialogHeader>\r\n                    <div className=\"space-y-4 py-4\">\r\n                        <div>\r\n                            <Label htmlFor=\"description\">工作描述 *</Label>\r\n                            <Input\r\n                                id=\"description\"\r\n                                placeholder=\"您正在做什么？\"\r\n                                value={newTimer.description}\r\n                                onChange={e => setNewTimer(prev => ({ ...prev, description: e.target.value }))}\r\n                            />\r\n                        </div>\r\n                        {cases.length > 0 && (\r\n                            <div>\r\n                                <Label>关联案件</Label>\r\n                                <Select\r\n                                    value={newTimer.caseId}\r\n                                    onValueChange={v => setNewTimer(prev => ({ ...prev, caseId: v }))}\r\n                                >\r\n                                    <SelectTrigger>\r\n                                        <SelectValue placeholder=\"选择案件（可选）\" />\r\n                                    </SelectTrigger>\r\n                                    <SelectContent>\r\n                                        {cases.map(c => (\r\n                                            <SelectItem key={c.id} value={c.id}>\r\n                                                {c.caseCode} - {c.title}\r\n                                            </SelectItem>\r\n                                        ))}\r\n                                    </SelectContent>\r\n                                </Select>\r\n                            </div>\r\n                        )}\r\n                    </div>\r\n                    <DialogFooter>\r\n                        <Button variant=\"outline\" onClick={() => setShowStartDialog(false)}>\r\n                            取消\r\n                        </Button>\r\n                        <Button\r\n                            onClick={handleStart}\r\n                            disabled={starting || !newTimer.description.trim()}\r\n                            className=\"bg-orange-500 hover:bg-orange-600\"\r\n                        >\r\n                            {starting ? (\r\n                                <>\r\n                                    <Loader2 className=\"h-4 w-4 mr-2 animate-spin\" />\r\n                                    开始中...\r\n                                </>\r\n                            ) : (\r\n                                <>\r\n                                    <Play className=\"h-4 w-4 mr-1\" />\r\n                                    开始\r\n                                </>\r\n                            )}\r\n                        </Button>\r\n                    </DialogFooter>\r\n                </DialogContent>\r\n            </Dialog>\r\n        </>\r\n    )\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"D:\\Desktop\\LawClick_NEW\\lawclick-next\\src\\components\\ui\\alert-dialog.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\Desktop\\LawClick_NEW\\lawclick-next\\src\\components\\ui\\avatar.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\Desktop\\LawClick_NEW\\lawclick-next\\src\\components\\ui\\badge.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\Desktop\\LawClick_NEW\\lawclick-next\\src\\components\\ui\\button.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\Desktop\\LawClick_NEW\\lawclick-next\\src\\components\\ui\\calendar.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\Desktop\\LawClick_NEW\\lawclick-next\\src\\components\\ui\\card.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\Desktop\\LawClick_NEW\\lawclick-next\\src\\components\\ui\\command.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\Desktop\\LawClick_NEW\\lawclick-next\\src\\components\\ui\\dialog.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\Desktop\\LawClick_NEW\\lawclick-next\\src\\components\\ui\\dropdown-menu.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\Desktop\\LawClick_NEW\\lawclick-next\\src\\components\\ui\\glass-panel.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\Desktop\\LawClick_NEW\\lawclick-next\\src\\components\\ui\\hover-card.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\Desktop\\LawClick_NEW\\lawclick-next\\src\\components\\ui\\input.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\Desktop\\LawClick_NEW\\lawclick-next\\src\\components\\ui\\label.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\Desktop\\LawClick_NEW\\lawclick-next\\src\\components\\ui\\popover.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\Desktop\\LawClick_NEW\\lawclick-next\\src\\components\\ui\\progress.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\Desktop\\LawClick_NEW\\lawclick-next\\src\\components\\ui\\radio-group.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\Desktop\\LawClick_NEW\\lawclick-next\\src\\components\\ui\\scroll-area.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\Desktop\\LawClick_NEW\\lawclick-next\\src\\components\\ui\\select.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\Desktop\\LawClick_NEW\\lawclick-next\\src\\components\\ui\\separator.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\Desktop\\LawClick_NEW\\lawclick-next\\src\\components\\ui\\sheet.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\Desktop\\LawClick_NEW\\lawclick-next\\src\\components\\ui\\sidebar.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\Desktop\\LawClick_NEW\\lawclick-next\\src\\components\\ui\\skeleton.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\Desktop\\LawClick_NEW\\lawclick-next\\src\\components\\ui\\sonner.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\Desktop\\LawClick_NEW\\lawclick-next\\src\\components\\ui\\switch.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\Desktop\\LawClick_NEW\\lawclick-next\\src\\components\\ui\\table.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\Desktop\\LawClick_NEW\\lawclick-next\\src\\components\\ui\\tabs.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\Desktop\\LawClick_NEW\\lawclick-next\\src\\components\\ui\\textarea.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\Desktop\\LawClick_NEW\\lawclick-next\\src\\components\\ui\\tooltip.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\Desktop\\LawClick_NEW\\lawclick-next\\src\\config\\navigation.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\Desktop\\LawClick_NEW\\lawclick-next\\src\\hooks\\use-mobile.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\Desktop\\LawClick_NEW\\lawclick-next\\src\\hooks\\use-permission.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\Desktop\\LawClick_NEW\\lawclick-next\\src\\lib\\calculators.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\Desktop\\LawClick_NEW\\lawclick-next\\src\\lib\\dashboard-widgets.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\Desktop\\LawClick_NEW\\lawclick-next\\src\\lib\\dashboard\\types.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\Desktop\\LawClick_NEW\\lawclick-next\\src\\lib\\litigation-stages.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\Desktop\\LawClick_NEW\\lawclick-next\\src\\lib\\non-litigation-stages.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\Desktop\\LawClick_NEW\\lawclick-next\\src\\lib\\notifications.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\Desktop\\LawClick_NEW\\lawclick-next\\src\\lib\\party-labels.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\Desktop\\LawClick_NEW\\lawclick-next\\src\\lib\\pdf.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\Desktop\\LawClick_NEW\\lawclick-next\\src\\lib\\permissions.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\Desktop\\LawClick_NEW\\lawclick-next\\src\\lib\\prisma.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\Desktop\\LawClick_NEW\\lawclick-next\\src\\lib\\queue.ts","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":11,"column":42,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":11,"endColumn":45,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[284,287],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[284,287],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { prisma } from \"@/lib/prisma\"\r\n\r\nexport enum TaskType {\r\n    GENERATE_DOCUMENT = \"GENERATE_DOCUMENT\",\r\n    GENERATE_REPORT = \"GENERATE_REPORT\",\r\n    SEND_EMAIL = \"SEND_EMAIL\",\r\n    AUDIT_LOG = \"AUDIT_LOG\"\r\n}\r\n\r\nexport const queue = {\r\n    async enqueue(type: string, payload: any) {\r\n        try {\r\n            const job = await prisma.taskQueue.create({\r\n                data: {\r\n                    type,\r\n                    payload,\r\n                    status: 'PENDING'\r\n                }\r\n            })\r\n            return job\r\n        } catch (error) {\r\n            console.error(\"Failed to enqueue task:\", error)\r\n            throw error\r\n        }\r\n    },\r\n\r\n    async processNext() {\r\n        // Find next pending job\r\n        const job = await prisma.taskQueue.findFirst({\r\n            where: { status: 'PENDING' },\r\n            orderBy: { createdAt: 'asc' }\r\n        })\r\n\r\n        if (!job) return null\r\n\r\n        try {\r\n            // Lock job\r\n            await prisma.taskQueue.update({\r\n                where: { id: job.id },\r\n                data: { status: 'PROCESSING' }\r\n            })\r\n\r\n            // Simulate Processing\r\n            console.log(`Processing Job ${job.id} [${job.type}]...`)\r\n\r\n            // ... Actual logic handler switch would go here ...\r\n            await new Promise(resolve => setTimeout(resolve, 2000)) // Fake work\r\n\r\n            // Complete\r\n            await prisma.taskQueue.update({\r\n                where: { id: job.id },\r\n                data: {\r\n                    status: 'COMPLETED',\r\n                    result: { success: true, timestamp: new Date().toISOString() }\r\n                }\r\n            })\r\n\r\n            return job.id\r\n        } catch (error) {\r\n            await prisma.taskQueue.update({\r\n                where: { id: job.id },\r\n                data: {\r\n                    status: 'FAILED',\r\n                    result: { error: String(error) }\r\n                }\r\n            })\r\n            return null\r\n        }\r\n    }\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"D:\\Desktop\\LawClick_NEW\\lawclick-next\\src\\lib\\s3.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\Desktop\\LawClick_NEW\\lawclick-next\\src\\lib\\schemas.test.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\Desktop\\LawClick_NEW\\lawclick-next\\src\\lib\\schemas.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\Desktop\\LawClick_NEW\\lawclick-next\\src\\lib\\server-auth.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\Desktop\\LawClick_NEW\\lawclick-next\\src\\lib\\task-types.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\Desktop\\LawClick_NEW\\lawclick-next\\src\\lib\\templates\\registry.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\Desktop\\LawClick_NEW\\lawclick-next\\src\\lib\\utils.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\Desktop\\LawClick_NEW\\lawclick-next\\src\\lib\\vector.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\Desktop\\LawClick_NEW\\lawclick-next\\src\\proxy.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\Desktop\\LawClick_NEW\\lawclick-next\\src\\store\\ai-assistant.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\Desktop\\LawClick_NEW\\lawclick-next\\src\\store\\dispatch-store.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\Desktop\\LawClick_NEW\\lawclick-next\\src\\store\\float-store.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\Desktop\\LawClick_NEW\\lawclick-next\\src\\store\\index.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\Desktop\\LawClick_NEW\\lawclick-next\\src\\store\\timer-store.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\Desktop\\LawClick_NEW\\lawclick-next\\src\\store\\user-status-store.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\Desktop\\LawClick_NEW\\lawclick-next\\src\\types\\next-auth.d.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\Desktop\\LawClick_NEW\\lawclick-next\\tailwind.config.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\Desktop\\LawClick_NEW\\lawclick-next\\tests\\e2e\\auth.spec.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\Desktop\\LawClick_NEW\\lawclick-next\\tests\\e2e\\case-tab-deeplink.spec.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\Desktop\\LawClick_NEW\\lawclick-next\\tests\\e2e\\chat-notification.spec.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\Desktop\\LawClick_NEW\\lawclick-next\\tests\\e2e\\mainline.spec.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]}]
