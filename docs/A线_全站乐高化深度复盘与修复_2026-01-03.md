# A线：全站乐高化（DIY/可拖拽/可记忆/可恢复）深度复盘与修复（2026-01-03）

> 本文目标：针对“覆盖审计偷懒、仅页面包一层 Workspace 不等于真乐高化、局部区域（如卡片栏/侧栏/详情页 tabs）仍可能不可 DIY/不可记忆/不可恢复”等批评点，做一次 **更严格** 的复盘，并给出已落实的工程证据。

---

## 1. 批判性复盘：之前哪里容易“看起来完成但实际上不够”

### 1.1 “页面级 Wrapper”不足以证明“任意区域”可 DIY

- 仅命中 `PageWorkspace/SectionWorkspace/LegoDeck` 的静态标记，最多只能证明“具备 DIY 基础设施”，无法证明：
  - 页面内部是否拆成多个可拖拽模块（而非一个巨大容器）
  - Tab/侧栏/卡片栏等“局部区域”是否也具备可配置、可记忆、可恢复能力

### 1.2 “需要手动点保存”导致的体验风险

- 旧行为：用户进入编辑模式拖拽后，若直接退出编辑而未点击保存，修改会被静默丢弃。
- 这会让“可记忆/可恢复”在真实使用中表现为“不可靠”，属于典型的“功能看似存在但体验不达标”。

---

## 2. 已落地修复（代码级）

### 2.1 退出编辑前强制确认（防止未保存布局丢失）

- `lawclick-next/src/components/layout/section-workspace.tsx`：退出编辑时若检测到未保存变更，弹出确认框（继续编辑 / 放弃修改 / 保存并退出）。
- `lawclick-next/src/components/layout/page-workspace.tsx`：同上，覆盖页面级 Workspace（全站 pages 的 widget 布局编辑）。

### 2.2 “案件详情 Tabs”从单一 block 升级为多模块（局部乐高化）

> 深度审计发现：多个 case tabs 仅有 1 个 block（等价于“Tab 内不可 DIY”）。

- `lawclick-next/src/components/cases/CaseDetailClient.tsx`
  - `case_tab_parties`：拆为“当事人 + 团队成员”两模块
  - `case_tab_tasks`：拆为“任务看板 + 计时器”两模块
  - `case_tab_documents`：拆为“案件文档 + 文档统计”两模块
  - `case_tab_timelog`：拆为“工时记录 + 计时器”两模块
  - `case_tab_events`：拆为“相关日程 + 团队成员”两模块
  - `case_tab_timeline`：拆为“时间线 + 案件阶段/客户信息”两模块
  - `case_tab_billing`：拆为“账务与发票 + 工时汇总”两模块

> 同时把“团队/阶段/客户信息”等重复模块的内容复用 `sidebarCatalog`（以 `sidebarContentById` 的方式），避免复制粘贴与逻辑漂移。

---

## 3. 审计工具与证据（可重复复跑）

### 3.1 新增“深度审计”脚本（避免只做“标记命中”）

- 新增：`lawclick-next/scripts/lego-diy-depth-audit.js`
  - 统计每个 `<SectionWorkspace/>` / `<LegoDeck/>` 的 `catalog` 规模（可推导时）
  - 区分：
    - **明确薄弱点**：`max(catalog)<2`（直接失败）
    - **需要人工确认**：动态生成导致无法静态推导（不失败，但列出抽样点）

### 3.2 A线证据索引（2026-01-03）

- 入口：`pnpm -C lawclick-next audit:business-completeness`
  - 产物：`docs/_artifacts/business_completeness_audit_2026-01-03.md`
- 全站 DIY 覆盖：`pnpm -C lawclick-next audit:lego-diy-coverage -- --all-app`
  - 产物：`docs/_artifacts/lego_diy_coverage_audit_all_2026-01-03.md`
- DIY 深度审计：`pnpm -C lawclick-next audit:lego-diy-depth`
  - 产物：`docs/_artifacts/lego_diy_depth_audit_2026-01-03.md`
- 固定布局残留扫描：
  - `docs/_artifacts/lego_coverage_audit_2026-01-03.md`（fixed grid candidates: 0）
  - `docs/_artifacts/lego_freeform_coverage_audit_2026-01-03.md`（fixed stack candidates: 0）

---

## 4. 仍需保持批判性抽样确认的点

- `lego_diy_depth_audit` 中“无法静态推导 catalog 的点”，多为 `.map(...)` / 动态组合生成；
  - 这类通常是“卡片栏随数据规模变化”的正常情况，但仍建议抽样打开 UI 确认：
    - 可拖拽是否真实生效
    - 保存后刷新/换设备是否保持
    - “恢复默认”是否能回到可用布局

---

## 5. 下一步：进入 B 线（全域审计与逐条落地修复）

> B 线将对：代码结构、安全性、性能、数据库设计、API 设计一致性、错误处理与日志、依赖项健康度、DevOps 就绪度、国际化/本地化、业务逻辑完整性、可维护性等进行“挑刺式审计 + 逐条修复 + 证据沉淀”。

