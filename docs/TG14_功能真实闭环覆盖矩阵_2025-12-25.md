# TG14｜功能真实闭环覆盖矩阵｜2025-12-25

> 目的：以 `AGENTS.md` 的“极限标准”（禁 Mock/空壳/假数据、强校验、前后端一致、可复验）对照：
> 1) `prompt/1211架构设计.md` 的问题清单与模块诉求；
> 2) TG0~TG12 的阶段性需求说明与验收记录；
> 输出“覆盖矩阵 + 轻重缓急”并明确哪些属于“后台运行机制/架构级重构”（需单开 TG）。

---

## 1) 回答：TG12 提到的“另开 TG 大规模重构”是否与后台操作机制密切相关？

结论：**是，高度相关**。

原因：TG12 里被建议“单独开 TG”的事项，本质都在定义系统的**生产运行机制**（而非单个页面功能）：

- **多租户（tenant）策略**：决定“数据隔离边界”是否真实可靠；一旦引入但未全链路注入/过滤，属于高危数据泄露面。
- **队列幂等/并发锁/重试退避**：决定异步任务（通知/邮件/审阅/后台处理）的可靠性、吞吐与可观测性；否则会出现重复发送、漏发、竞态。
- **上传流式化/预签名直传**：决定存储吞吐、成本与大文件稳定性；也直接影响权限隔离与攻击面（DoS/内存爆炸）。

这些改造 **不一定阻塞“单个功能可用”**，但决定“后台长期稳定运行 + 规模化可运营”，因此应作为“下一 TG 的 P0（后台机制）”独立推进。

---

## 2) 覆盖矩阵 A：`prompt/1211架构设计.md`（前 20 条问题）

状态定义：
- **REAL**：端到端真实闭环（UI → Action → Prisma → DB/S3/Queue）且有明确入口/回读
- **PARTIAL**：功能链路存在，但 UI/UX/信息密度/规模化能力仍不足
- **REDIRECT**：为避免空壳而重定向到已闭环页面（不提供假功能）
- **MISSING**：缺失或仍为明显空壳

| # | 诉求/问题摘要 | 状态 | 证据（路由/代码） | 备注 |
|---:|---|---|---|---|
| 1 | 前后端是否统一、登录注册是否联动 DB、是否依赖 docker PostgreSQL | REAL | `lawclick-next/src/auth.ts`、`lawclick-next/prisma/schema.prisma`、`lawclick-next/docker-compose.yml` | `Credentials` + PrismaAdapter；生产对齐需启动 Postgres/MinIO |
| 2 | “哪个是法律助手/右下角加号是什么” | REAL | `lawclick-next/src/components/layout/floating-launcher.tsx`、`lawclick-next/src/components/layout/app-header.tsx` | 组件球 tooltip + coachmark（可关闭且落库），AI 助手入口清晰（Header Bot / 组件球） |
| 3 | “组件球”是否能靠边/开关 | REAL | `lawclick-next/src/components/layout/floating-launcher.tsx`、`lawclick-next/src/actions/ui-settings.ts`、`lawclick-next/prisma/migrations/20251225193000_add_user_settings/migration.sql` | 支持拖拽吸附四边、开关与位置跨设备一致（UserSetting） |
| 4 | Dashboard 收缩后布局缩放 | REAL | `lawclick-next/src/components/dashboard/DashboardWorkspaceClient.tsx`、`lawclick-next/src/components/ui/sidebar.tsx` | 使用 `ResizeObserver` 监听容器宽度变化，折叠/展开可自适应重排 |
| 5 | Dashboard 字体过密/缺积木感 | REAL | `lawclick-next/src/lib/ui/dashboard-preferences.ts`、`lawclick-next/src/actions/ui-settings.ts`、`lawclick-next/src/components/dashboard/DashboardWorkspaceClient.tsx` | 支持“舒适/紧凑密度”一键切换，且跨设备落库记忆（UserSetting） |
| 6 | Dashboard DIY 组件 + 配置落库 | REAL | `lawclick-next/src/actions/dashboard-layout.ts`、`lawclick-next/prisma/schema.prisma`（`DashboardLayout`） | 配置随用户持久化 |
| 7 | “案件看板”需 trello 特化/更多信息 + 项目页 | REAL | `lawclick-next/src/actions/case-kanban.ts`、`lawclick-next/src/components/features/case-kanban.tsx`、`lawclick-next/src/app/(dashboard)/projects/[id]/page.tsx` | 案件看板卡片信息来自 DB（成员/待办/下个日程/已上传文档数）；项目任务看板闭环已可复验（见 `docs/_artifacts/tg14_projects_taskkanban_2025-12-25_v3/`） |
| 8 | “律所管理”应简化 | REAL | `lawclick-next/src/app/(dashboard)/admin/page.tsx` | /admin 提供真实入口卡片 + 待处理计数（审批/发票/模板） |
| 9 | 调度中心需更丰富、支持 30-300 人规模 | REAL | `lawclick-next/src/components/features/team-heatmap.tsx`、`lawclick-next/src/components/dispatch/DispatchTaskPoolClient.tsx`、`lawclick-next/src/app/(dashboard)/dispatch/page.tsx` | TeamHeatmap 支持搜索 + 分页（>80 人自动启用分页）；任务池与分配闭环可回读 |
| 10 | 左侧案件栏直达 /cases/intake 逻辑怪 | REAL | `lawclick-next/src/config/navigation.ts` | 入口为 `/cases`，子菜单含 intake/active/archived |
| 11 | /cases/intake 信息过密/缺分屏 | REAL | `lawclick-next/src/components/cases/IntakeCasesWorkspaceClient.tsx`、`lawclick-next/src/actions/ui-settings.ts` | 已实现分屏（列表+右侧预览）并将 viewMode 落库（跨设备一致） |
| 12 | 案件详情页各 Tab 报错（设置/任务/当事人/文书/时间线/账务） | REAL | `lawclick-next/src/app/(dashboard)/cases/[id]/page.tsx`、`lawclick-next/src/components/cases/CaseDetailClient.tsx` | Tab 通过 `?tab=` 支持直达，链路落库回读 |
| 13 | /cases 页面太空、演示数据不见显得假 | REAL | `lawclick-next/src/app/(dashboard)/cases/page.tsx`、`lawclick-next/src/actions/cases.ts` | 真实链路不提供“假演示”；用 `新建案件` 建立真实数据 |
| 14 | “新建案件”无反应（缺业务逻辑） | REAL | `lawclick-next/src/components/cases/CreateCaseWizard.tsx`、`lawclick-next/src/actions/cases-crud.ts` | 创建案件→冲突检查→成员/群聊/通知 全链路 |
| 15 | /cases/archive 跳转异常 | REAL | `lawclick-next/src/app/(dashboard)/cases/archive/page.tsx` | 作为兼容别名，重定向到 `/cases/archived` |
| 16 | /tasks 未建设/无法进入详情 | REAL | `lawclick-next/src/app/(dashboard)/tasks/page.tsx`、`lawclick-next/src/app/(dashboard)/tasks/[id]/page.tsx`、`lawclick-next/src/actions/tasks-detail.ts` | 列表/看板/弹窗与独立详情页均可回读；支持直达与跨页协作 |
| 17 | /time 未与项目/案件对接 | REAL | `lawclick-next/src/app/(dashboard)/time/page.tsx`、`lawclick-next/src/actions/timelogs-crud.ts` | 工时与案件可关联 |
| 18 | /documents 无法进入详情编辑 | REAL | `lawclick-next/src/app/(dashboard)/documents/[id]/page.tsx`、`lawclick-next/src/components/documents/DocumentDetailClient.tsx` | 文档详情/编辑链路存在 |
| 19 | /contacts 没有详情 | REAL | `lawclick-next/src/app/(dashboard)/contacts/page.tsx`（redirect）→ `lawclick-next/src/app/(dashboard)/crm/customers/[id]/page.tsx` | 已统一到 CRM 客户模块 |
| 20 | /chat 是空壳且不以项目为中心 | REAL | `lawclick-next/src/app/(dashboard)/chat/page.tsx`、`lawclick-next/src/actions/chat-actions.ts`、`lawclick-next/src/actions/cases-crud.ts`（自动建案件群聊） | 案件为中心创建 thread，并与成员同步 |

---

## 3) 覆盖矩阵 B：TG0~TG12（按模块闭环视角）

> 注：这里按“真实链路是否存在 + 入口是否可达 + 数据是否落库可回读”来对齐 TG0~TG12 的主旨；更细的 UI/交互规范仍应在后续 TG 中持续打磨。

- **TG0 基础设施对齐**：REAL（Postgres/MinIO、Prisma、系统校验脚本）  
  证据：`lawclick-next/docker-compose.yml`、`lawclick-next/prisma/schema.prisma`、`lawclick-next/scripts/verify-system.js`

- **TG1 身份权限体系统一**：REAL（JWT 登录、权限表、路由拦截）  
  证据：`lawclick-next/src/auth.ts`、`lawclick-next/src/lib/permissions.ts`、`lawclick-next/src/proxy.ts`、`lawclick-next/middleware.ts`

- **TG2 案件端到端闭环**：REAL（案件创建/列表/详情、冲突检查、阶段管理、成员与群聊）  
  证据：`lawclick-next/src/actions/cases-crud.ts`、`lawclick-next/src/actions/cases.ts`、`lawclick-next/src/app/(dashboard)/cases/[id]/page.tsx`

- **TG3 任务协作与 Trello 看板**：REAL（任务 CRUD、看板拖拽、与案件/项目联动）  
  证据：`lawclick-next/src/actions/tasks-crud.ts`、`lawclick-next/src/components/tasks/TaskKanban.tsx`、`lawclick-next/src/components/cases/CaseTaskKanban.tsx`、`lawclick-next/src/app/(dashboard)/projects/[id]/page.tsx`、`lawclick-next/tests/e2e/project-kanban.spec.ts`、`docs/_artifacts/tg14_projects_taskkanban_2025-12-25_v3/`

- **TG4 计时追踪**：REAL（计时器、工时记录、与案件/任务联动）  
  证据：`lawclick-next/src/actions/timelogs-crud.ts`、`lawclick-next/src/components/timelog/*`、`lawclick-next/src/app/(dashboard)/time/page.tsx`

- **TG5 文档中心**：REAL（上传/下载、版本、AI审阅入口、与案件联动；模板起草 DB 驱动）  
  证据：`lawclick-next/src/actions/documents.ts`、`lawclick-next/src/actions/document-templates.ts`、`lawclick-next/src/app/(dashboard)/documents/*`

- **TG6 仪表盘 MDI-DIY**：REAL（组件布局落库、浮动窗体系）  
  证据：`lawclick-next/src/actions/dashboard-layout.ts`、`lawclick-next/prisma/schema.prisma`（`DashboardLayout`）、`lawclick-next/src/store/float-store.ts`

- **TG7 日程安排/调度中心**：REAL（事件与参与人、团队状态与调度看板）  
  证据：`lawclick-next/src/actions/event-actions.ts`、`lawclick-next/src/app/(dashboard)/calendar/page.tsx`、`lawclick-next/src/app/(dashboard)/dispatch/page.tsx`

- **TG8 行政 ERP-OA / 客户管理 / 案件账务联动**：REAL（审批、财务、客户 CRM、与案件联动）  
  证据：`lawclick-next/src/app/(dashboard)/admin/*`、`lawclick-next/src/actions/approval-actions.ts`、`lawclick-next/src/actions/finance-actions.ts`、`lawclick-next/src/app/(dashboard)/crm/customers/*`

- **TG9 AI 模块/工具箱**：REAL（对话/上下文拼装已闭环；AI 未配置或配置错误时不崩溃、错误可定位且审计落库）  
  证据：`lawclick-next/src/actions/ai-actions.ts`、`lawclick-next/src/lib/ai-provider.ts`、`lawclick-next/src/components/floating/ai-assistant-content.tsx`

- **TG10 统一检验与纠错**：REAL（边界校验与前后端枚举一致性收敛：RoleKey/TaskType 等关键枚举被集中定义并做 TS 强约束，减少“看似有功能但实际报错”的空壳）  
  证据：`lawclick-next/src/lib/zod.ts`、`lawclick-next/src/lib/role-keys.ts`、`lawclick-next/src/lib/permissions.ts`、`lawclick-next/src/lib/task-types.ts`、`lawclick-next/src/lib/queue-task-types.ts`、`lawclick-next/src/actions/*`（大量 `.safeParse/.strict()`）

- **TG11 全局搜索/通知闭环**：REAL（搜索入口、通知落库、跳转带 tab）  
  证据：`lawclick-next/src/components/layout/header-components.tsx`、`lawclick-next/src/actions/notification-actions.ts`、`lawclick-next/src/app/(dashboard)/notifications/page.tsx`

- **TG12 极限标准审计与整改**：REAL（见 TG12 闭环文档 + 本轮 TG14 补完）  
  证据：`docs/TG12_极限标准整改闭环_2025-12-24.md`、`docs/_artifacts/tg12_remediation_2025-12-24/`、`docs/_artifacts/tg14_remediation_2025-12-25/`、`docs/_artifacts/tg14_realclosure_2025-12-25_v2/`、`docs/_artifacts/tg14_projects_taskkanban_2025-12-25_v3/`

---

## 4) 轻重缓急（建议整改顺序）

### P0（必须立刻做，否则不允许宣称“生产可用”）
- **路由/权限边界必须运行时生效**（middleware 挂载、默认拒绝、避免绕过）。
- **前后端枚举/Schema 一致**（例如成员角色、状态机等；出现不一致就会变成“看起来有功能但实际报错”的空壳）。

### P1（高风险/高概率踩雷，尽快做）
- **AI/环境配置必须可优雅降级**（未配置不崩、配置错误可定位）。
- **兼容路由与历史链接**（例如 `/cases/archive` 别名）。

### P2（架构级后台机制，建议单开 TG）
- **多租户定案并全链路注入/过滤**：已落库 `Tenant` + 多核心模型 `tenantId`（含通知/队列/任务/联系人等）并在服务端统一注入过滤；当前仍可默认 tenant，但已具备平滑切换真多租户的强约束入口（见 `docs/TG15_后台运行机制_队列与上传_2025-12-25.md:1`）。
- **队列幂等/并发锁/重试退避/告警**：已完成并发安全抢占 + 重试退避 + 批处理触发，并进一步补齐 **balanced 治理（维护优先 + 邮件限流）** 与 `SEND_EMAIL` 的 **EmailDelivery outbox 幂等/审计**（见 `docs/TG15_后台运行机制_队列与上传_2025-12-25.md:1` 与证据目录 `docs/_artifacts/tg15_p2p3_queue_governance_2025-12-26_v2/`）。
- **上传预签名/流式**：已完成“流式上传”+“presigned 直传”（init → PUT → finalize），并保留服务器中转上传作为失败兜底（真实可用）（见 `docs/TG15_后台运行机制_队列与上传_2025-12-25.md:1`）。
- **上传意图审计 + 孤儿对象回收（运维可操作）**：已落地 `UploadIntent` 审计表、`CLEANUP_UPLOAD_INTENTS` 回收任务与 `/admin/ops/uploads` 运维入口（证据：`docs/_artifacts/tg15_p2p3_ops_2025-12-26/`）。

### P3（长期体验与规模化）

- 设计语言、排版密度、分屏/停靠/磁吸、30-300 人规模性能（虚拟列表、分片加载）、项目（非案件）模块化等。

#### 2025-12-26 补齐（P3 v1：体验与规模化 REAL）

- **设计语言（对齐 `docs/LegalMind设计语言规范.md` + `docs/设计语言文档.md`）**：修复全局交互动效与可访问性基线（避免 `transition: all` 带来的性能与布局抖动；补齐 `focus-visible`、`::selection`、`prefers-reduced-motion`），并以 CSS Variables 固化品牌色/阴影/圆角等基础 tokens。  
  关键实现：`lawclick-next/src/app/globals.css`、`lawclick-next/src/styles/theme.css`、`lawclick-next/src/styles/animations.css`、`lawclick-next/src/styles/components.css`、`lawclick-next/src/styles/utilities.css`

- **暗色模式与主题切换（跨设备落库）**：对齐 LegalMind 规范的 `.dark` tokens，接入 `next-themes`（`attribute="class"`），主题选择落库到 `UserSetting(key=ui:app)`；Header 提供 system/light/dark 切换入口，`UiPreferencesProvider` 驱动 `setTheme()`；并将核心页面/组件的 `bg-white` 等硬编码替换为语义 tokens（`bg-card/bg-popover`），确保暗色模式是真实可用而非“看起来支持”。  
  关键实现：`lawclick-next/src/app/globals.css`、`lawclick-next/src/components/providers/session-provider.tsx`、`lawclick-next/src/lib/ui/app-preferences.ts`、`lawclick-next/src/components/layout/ui-preferences-provider.tsx`、`lawclick-next/src/components/layout/app-header.tsx`

- **排版密度（全局系统 + 跨设备落库）**：新增 `AppUiPreferences`（`density: comfortable|compact`，并扩展 `theme: system|light|dark`）落库到 `UserSetting(key=ui:app)`；前端在 `UiPreferencesProvider` 将密度写入 `documentElement.dataset.density`，配合 CSS variables 驱动主容器 padding 与核心列表行高（切换即时生效、无需散落 if/else）。  
  关键实现：`lawclick-next/src/lib/ui/app-preferences.ts`、`lawclick-next/src/actions/ui-settings.ts`、`lawclick-next/src/components/layout/ui-preferences-provider.tsx`、`lawclick-next/src/app/(dashboard)/layout.tsx`、`lawclick-next/src/components/layout/app-header.tsx`

- **分屏/停靠/磁吸（浮窗体系“可回读 + 可解除 + 可稳定停靠”）**：停靠状态（`dockSide/dockOffsetRatio`）用于打开/窗口变化时重算位置；新增显式“吸附/解除停靠”按钮；并在 viewport resize 时自动重算停靠位置，确保长期使用不漂移。  
  关键实现：`lawclick-next/src/lib/ui/dock-snap.ts`、`lawclick-next/src/components/layout/floating-layer.tsx`、`lawclick-next/src/components/layout/floating-window-frame.tsx`、`lawclick-next/src/store/float-store.ts`

- **30-300 人规模性能（虚拟列表 + 分片加载）**：任务中心与项目中心均提供“分页 + 触底加载 + 虚拟渲染”，避免一次性全量渲染导致卡顿；并保持权限/tenant 过滤在服务端执行。  
  关键实现：`lawclick-next/src/actions/tasks-crud.ts`、`lawclick-next/src/app/(dashboard)/tasks/page.tsx`、`lawclick-next/src/actions/projects-crud.ts`、`lawclick-next/src/components/projects/ProjectsListClient.tsx`

- **项目（非案件）模块化主线**：项目详情页的“任务”模块升级为“看板（默认）+ 列表（规模化）”双模式；新增项目内“新建任务”入口（真实创建 → 项目看板/列表 → 任务中心可回读），确保“项目创建 → 任务创建 → 看板/任务中心”链路长期稳定。  
  关键实现：`lawclick-next/src/components/projects/ProjectTasksPanelClient.tsx`、`lawclick-next/src/app/(dashboard)/projects/[id]/page.tsx`

证据目录（门禁全绿）：`docs/_artifacts/tg14_p3_scale_2025-12-26_v1/`（`pnpm_lint.txt`、`pnpm_typecheck.txt`、`pnpm_build.txt`、`pnpm_route_audit.txt`、`pnpm_test.txt`）

补充（2025-12-27）：主题/暗色模式与后续强化门禁证据：`docs/_artifacts/tg16_followup_2025-12-27_v4/`

#### 2025-12-26 补齐（P3 v2：看板规模化 PERFECT）

- **看板自身可无限量可用**：按列分页增量加载 + 列虚拟化渲染 + DnD 兼容（无静默截断、无 Mock）。覆盖任务中心 `/tasks`、项目任务看板、案件详情任务 Tab。  
  关键实现：`lawclick-next/src/actions/tasks-crud.ts`、`lawclick-next/src/components/tasks/TaskKanban.tsx`、`lawclick-next/src/components/cases/CaseTaskKanban.tsx`
- **案件列表/详情性能对齐**：不再 include 全量 tasks，仅用 groupBy 计算进度；intake 分屏提供 open tasks 预览，避免任务量增大拖慢页面。  
  关键实现：`lawclick-next/src/actions/cases.ts`、`lawclick-next/src/lib/cases/case-detail-view-model.ts`
- 证据目录（门禁全绿）：`docs/_artifacts/tg18_kanban_virtual_2025-12-26_v2/`；详见：`docs/TG18_看板虚拟列表与分列分页_2025-12-26.md:1`

---

## 5) v5 验收证据（闭环补全：presigned 直传 + 门禁全绿）

证据目录：`docs/_artifacts/tg14_fullclosure_2025-12-25_v5/`

- 基础设施：`docker_compose_ps.txt`、`prisma_migrate_deploy.txt`、`pnpm_prisma_generate.txt`、`pnpm_prisma_validate.txt`、`pnpm_verify_system.txt`
- 上传（S3/MinIO）：`pnpm_init_s3_final2.txt`（注：MinIO 默认 `cors_allow_origin=*`，见 `minio_mc_admin_config_export.txt`）
- 门禁：`pnpm_lint_after_fix.txt`、`pnpm_typecheck.txt`、`pnpm_build_after_fix.txt`、`pnpm_route_audit.txt`、`pnpm_test.txt`

补充（2025-12-26）：P3 规模化门禁证据：`docs/_artifacts/tg14_p3_scale_2025-12-26_v1/`

补充（2025-12-26）：看板超量“静默截断”治理（真实性）：`docs/TG17_看板超量截断治理_2025-12-26.md:1`（证据：`docs/_artifacts/tg17_board_truncation_2025-12-26_v1/pnpm_test.txt:1`）
