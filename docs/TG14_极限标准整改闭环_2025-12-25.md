# TG14「极限标准整改闭环」（2025-12-25）

> 目标：在 TG12 已完成的整改基础上，补完仍会导致“功能看起来存在但运行时不成立”的关键断裂点，确保 **真实链路**、**前后端一致**、**可复验**。
>
> 约束：按指令忽略版本控制问题，仅关注功能/链路真实性与工程门禁。

---

## 1) 本轮结论（简版）

- **路由/权限边界“从存在到生效”**：新增 `lawclick-next/middleware.ts` 正式挂载 `src/proxy.ts`，使登录态与角色路由拦截在运行时真实执行。
- **前后端一致性修复**：Case 成员邀请的 role 从错误的 `EDITOR` 统一为 `MEMBER`（并在后端做一次性兼容映射），避免 Prisma 枚举报错导致“空壳体验”。
- **AI 环境变量解析不再“未配置也崩”**：`parseEnv()` 对 ZodObject 先 pick 所需 key 再 parse，允许 `.strict()` 安全使用。
- **历史路由兼容**：新增 `/cases/archive` → `/cases/archived` 别名，修复旧文档/旧入口跳转失效。
- **案件列表状态显示纠偏**：`CaseListClient` 的状态色彩/文案与 `CaseStatus` 状态机一致（LEAD/INTAKE/ACTIVE/SUSPENDED/CLOSED/ARCHIVED）。

### v2（功能真实闭环：覆盖矩阵落地）

- **UI 偏好/新手引导全部落库（跨设备一致）**：新增 `UserSetting` + `src/actions/ui-settings.ts`，统一承载组件球开关/停靠/位置、Dashboard 密度、/cases 视图模式、新手引导已读等。
- **案件看板不再假数据**：看板卡片补齐成员/待办数/下个日程等真实信息（Action→Prisma→DB）。
- **任务详情“可直达页面”**：补齐 `/tasks/[id]` 详情路由，列表点击直达，弹窗提供“在页面打开”入口。
- **/cases/intake 分屏预览**：列表+右侧预览（成员/任务/日程），并将 viewMode 落库；URL 与状态同步。
- **调度中心补齐“待分配任务池”**：与既有分配机制闭环（选择成员→分配任务→通知/回读）。
- **E2E 可复验稳定性**：Playwright 启动前自动 `prisma migrate deploy`；toast 位置与 coachmark 层级调整避免遮挡关键操作。

### v3（项目任务闭环：项目创建 → 项目任务创建 → 看板 → 任务中心）

- **修复“项目页任务看板永远 0 项”的真实断裂点**：`getAccessibleTasksForBoard()` 的 `take` 校验上限与调用端不一致（`take: 500` 被 Zod 拒绝后返回空数组），已统一为可控上限并抽出 `query-limits` 常量，避免“看起来有看板但运行时不成立”。
- **项目页看板快速新建任务真实落库**：项目页列头 `+` 可创建项目任务（UI → Action → Prisma → DB → 回读），并在任务中心 `/tasks` 可检索回读。
- **项目任务不再暴露空壳计时**：暂不扩展 `TimeLog`（避免大迁移与计费口径漂移），项目任务卡片与详情隐藏计时入口，仅案件任务可计时。
- **E2E 覆盖并通过**：新增 `project-kanban.spec.ts` 覆盖“项目→任务→看板→任务中心”主线，且验证刷新后仍可回读。

---

## 2) 变更清单（按闭环链路）

### 2.1 路由拦截（运行时生效）

- 新增 `lawclick-next/middleware.ts`：Next.js middleware 入口，调用 `src/proxy.ts` 并内联 `config.matcher`（满足 Next 静态解析要求）。

### 2.2 成员邀请 role 前后端统一

- `lawclick-next/src/lib/schemas.ts`：`AddMemberSchema.role` 改为 `VIEWER/MEMBER/OWNER`，并对 `caseId` 做 UUID 校验。
- `lawclick-next/src/actions/members.ts`：将旧值 `EDITOR` 兼容映射到 `MEMBER`；创建成员时不再 `as CaseRole` 盲转，改为显式映射。
- `lawclick-next/src/components/cases/CaseTeamCard.tsx`：前端下拉值改为 `MEMBER`；成员角色徽章改为中文显示。

### 2.3 环境变量解析（防御性）

- `lawclick-next/src/lib/server-env.ts`：`parseEnv()` 对 ZodObject 先 pick schema keys 再 parse，避免 `.strict()` 与 `process.env` 的天然冗余键冲突。

### 2.4 路由兼容 & 状态文案一致

- `lawclick-next/src/app/(dashboard)/cases/archive/page.tsx`：兼容别名重定向。
- `lawclick-next/src/components/cases/CaseListClient.tsx`：状态色彩/文案与 CaseStatus 对齐；统计卡口径纠偏（待处理=LEAD+INTAKE，已结案/归档=CLOSED+ARCHIVED）。

### 2.5 用户偏好/组件球/新手引导落库（UserSetting）

- `lawclick-next/prisma/schema.prisma`、`lawclick-next/prisma/migrations/20251225193000_add_user_settings/migration.sql`：新增 `UserSetting`（跨设备 UI 偏好真源）。
- `lawclick-next/src/actions/ui-settings.ts`：严格 Zod 校验的 get/update（组件球/仪表盘/案件页/新手引导）。
- `lawclick-next/src/components/layout/ui-preferences-provider.tsx`：统一注入与持久化 patch。
- `lawclick-next/src/components/layout/floating-launcher.tsx`、`lawclick-next/src/lib/ui/floating-launcher.ts`：组件球拖拽吸附四边、位置落库、可开关、coachmark 可关闭并落库。

### 2.6 案件看板真实数据补齐

- `lawclick-next/src/actions/case-kanban.ts`、`lawclick-next/src/components/features/case-kanban.tsx`：成员/待办数/下个日程全部来自 DB。

### 2.7 任务详情页路由补齐

- `lawclick-next/src/app/(dashboard)/tasks/[id]/page.tsx`、`lawclick-next/src/actions/tasks-detail.ts`：任务详情页真链路。
- `lawclick-next/src/components/tasks/TaskDetailDialog.tsx`：弹窗提供“在页面打开”。

### 2.8 /cases/intake 分屏预览

- `lawclick-next/src/app/(dashboard)/cases/intake/page.tsx`、`lawclick-next/src/components/cases/IntakeCasesWorkspaceClient.tsx`：分屏布局 + URL 同步。
- `lawclick-next/src/components/cases/CaseIntakeDetailPanel.tsx`：右侧预览真实数据（成员/任务/日程）。

### 2.9 行政中心简化入口

- `lawclick-next/src/app/(dashboard)/admin/page.tsx`：/admin 卡片入口 + 真实待处理计数。

### 2.10 调度中心待分配任务池

- `lawclick-next/src/actions/dispatch-tasks.ts`、`lawclick-next/src/components/dispatch/DispatchTaskPoolClient.tsx`：未分配任务池与分配闭环。

### 2.11 E2E 可复验（迁移与遮挡）

- `lawclick-next/playwright.config.ts`：webServer 启动前执行 `prisma migrate deploy`，避免新表缺失导致运行时报错。
- `lawclick-next/src/components/ui/sonner.tsx`、`lawclick-next/src/components/layout/floating-launcher.tsx`：避免 toast/coachmark 遮挡关键按钮导致 E2E 不稳定。
- `lawclick-next/tests/e2e/project-kanban.spec.ts`、`lawclick-next/tests/e2e/e2e-helpers.ts`：项目任务看板真实闭环 E2E。

---

## 3) 可复验证据（忠实落盘）

证据目录（v1）：`docs/_artifacts/tg14_remediation_2025-12-25/`

- `pnpm_lint.txt`
- `pnpm_typecheck.txt`
- `pnpm_build.txt`
- `pnpm_test.txt`
- `pnpm_route_audit.txt`
- `pnpm_prisma_validate.txt`

证据目录（v2：功能真实闭环）：`docs/_artifacts/tg14_realclosure_2025-12-25_v2/`

- `pnpm_lint.txt`
- `pnpm_typecheck.txt`
- `pnpm_build.txt`
- `pnpm_test.txt`
- `pnpm_audit_routes.txt`
- `pnpm_prisma_validate.txt`

证据目录（v5：presigned 直传闭环 + 全门禁绿）：`docs/_artifacts/tg14_fullclosure_2025-12-25_v5/`

- `docker_compose_ps.txt`
- `pnpm_verify_system.txt`
- `pnpm_init_s3_final2.txt`
- `pnpm_lint_after_fix.txt`
- `pnpm_typecheck.txt`
- `pnpm_build_after_fix.txt`
- `pnpm_route_audit.txt`
- `pnpm_test.txt`
- `pnpm_prisma_generate.txt`
- `pnpm_prisma_migrate_deploy.txt`

证据目录（v3：项目任务看板闭环）：`docs/_artifacts/tg14_projects_taskkanban_2025-12-25_v3/`

- `pnpm_lint.txt`
- `pnpm_typecheck.txt`
- `pnpm_build.txt`
- `pnpm_test.txt`
- `pnpm_audit_routes.txt`
- `pnpm_prisma_validate.txt`
