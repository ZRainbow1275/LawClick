# 深入代码审阅批判性审计报告 (2025-12-29)

> **审计范围**: `lawclick-next/src/` - Server Actions、页面组件、核心业务逻辑  
> **审计方式**: 直接代码阅读与模式分析（非依赖历史文档）  
> **审计日期**: 2025-12-29

---

## 一、审计结论概要

| 维度 | 评估 | 发现 |
|------|------|------|
| 后端真实性 | ✅ **真实** | 所有核心 actions 均通过 Prisma 访问 PostgreSQL |
| 权限控制 | ✅ **完整** | 统一的 `server-auth.ts` + 租户级权限矩阵 |
| Mock 数据 | ✅ **无残留** | grep 搜索 `MOCK_`、`fake`、`hardcoded` 无结果 |
| 空壳页面 | ✅ **已处理** | `/settings` 已重定向；`/profile` 使用真实数据 |
| 输入校验 | ✅ **覆盖** | 全量使用 Zod Schema 校验 |

---

## 二、核心模块代码审阅结果

### 2.1 Server Actions 层 (`src/actions/`)

#### ✅ 案件管理 (`cases.ts`, `cases-crud.ts`)

```typescript
// 权限校验示例（line 19-23, cases.ts）
ctx = await getActiveTenantContextWithPermissionOrThrow("dashboard:view")
// ...
const caseAccessWhere = canViewCases ? getCaseListAccessWhereOrNull(viewer, "case:view") : null
```

**特点**：
- 使用 `getActiveTenantContextWithPermissionOrThrow` 强制登录与权限
- 通过 `getCaseListAccessWhereOrThrow` 实现基于角色的案件可见性过滤
- Zod Schema 校验所有输入
- 使用 `revalidatePath` 触发前端缓存失效

**结论**: ✅ 真实后端集成，无 mock 数据

---

#### ✅ 计时追踪 (`timelogs-crud.ts` - 1240 行)

```typescript
// 权限+关联校验（line 163-181）
const ctx = await getActiveTenantContextOrThrow()
requireTenantPermission(ctx, "case:view")
// ...
await requireCaseAccess(caseId, user, "case:view")
```

**完整实现**：
- `startTimer` / `stopTimer` / `pauseTimer` / `resumeTimer` - 完整计时状态机
- `addManualTimeLog` - 手动工时录入
- `getMyTimeLogs` / `getMyTimeSummary` - 日期范围查询
- `getCaseTimeSummary` - 案件维度汇总
- 审批流: `getTimeLogsPendingApproval` / `approveTimeLog` / `rejectTimeLog`

**结论**: ✅ 功能完整，包含审批流

---

#### ✅ 文档管理 (`documents.ts` - 1600 行)

```typescript
// MinIO 集成（line 7, line 764）
import { getStorageProvider, type HeadObjectOutput } from "@/lib/s3"
const storage = getStorageProvider()
```

**关键能力**：
- 预签名上传 (`initPresignedUpload` / `finalizePresignedUpload`)
- 版本控制 (`DocumentVersion` 表)
- MinIO/S3 对象存储真实集成
- 文档模板生成 (`generateDocument`)

**结论**: ✅ 真实文件存储集成

---

#### ✅ 任务看板 (`tasks-crud.ts` - 1622 行)

```typescript
// 看板移动逻辑（line 631-800）
export async function moveTaskOnKanban(input: MoveTaskOnKanbanInput) {
    // Planka 风格 position/gap 排序算法
    const { order: newOrder, needsReindex } = computePersistedOrder(effectivePrevOrder, effectiveNextOrder)
}
```

**特点**：
- 拖拽排序使用 "gap 策略"（类似 Planka/Focalboard）
- 支持案件任务 + 项目任务
- 任务分配触发通知 (`notifyUsersWithEmailQueue`)
- 实时信号 (`touchTenantSignal`)

**结论**: ✅ 专业级看板实现

---

#### ✅ 聊天沟通 (`chat-actions.ts` - 384 行)

```typescript
// 真实数据库交互（line 73-86）
const thread = await prisma.chatThread.upsert({
    where: { tenantId_key: { tenantId, key } },
    // ...
})
await ensureParticipant(thread.id, user.id)
```

**功能**：
- 团队群聊 / 案件群聊 / 私聊（三种线程类型）
- 消息发送触发通知
- 未读计数逻辑

**结论**: ✅ 真实数据库驱动

---

#### ✅ AI 助手 (`ai-actions.ts` - 947 行)

```typescript
// AI 调用审计（line 594-608）
await prisma.aIInvocation.create({
    data: {
        type: "CHAT",
        userId: user.id,
        conversationId,
        context: toPrismaJson(normalizeContext(context) ?? undefined),
        prompt: clampText(message, 4000),
        response: clampText(response, 20_000),
        provider,
        model,
        status: "SUCCESS",
        tokenUsage: toPrismaJson(completion.usage),
    },
})
```

**特点**：
- 每次 AI 调用写入 `AIInvocation` 表（审计追溯）
- 上下文感知（案件/文档/任务/审批等）
- 文档分析（摘要/要点/风险/时间线）

**结论**: ✅ 审计可追溯的 AI 集成

---

#### ✅ 全局搜索 (`search-actions.ts` - 251 行)

```typescript
// 权限过滤搜索（line 62-88）
const casePromise = canViewCases
    ? prisma.case.findMany({
        where: {
            AND: [
                caseAccessWhere ?? {},
                { OR: [...] },  // 搜索条件
            ],
        },
        // ...
    })
    : Promise.resolve([])
```

**功能**：
- 案件/任务/文档/联系人聚合搜索
- 基于权限的结果过滤
- 分组返回

**结论**: ✅ 后端权限过滤

---

### 2.2 权限系统 (`src/lib/server-auth.ts` - 433 行)

```typescript
// 双层权限矩阵（line 62-109）
const TENANT_PERMISSION_MIN_ROLE: Record<Permission, TenantMembershipRole> = {
    "dashboard:view": TenantMembershipRole.VIEWER,
    "case:create": TenantMembershipRole.MEMBER,
    "case:delete": TenantMembershipRole.ADMIN,
    // ...
}
```

**架构**：
1. **用户角色层**: `Role` (PARTNER/ASSOCIATE/ADMIN/CLIENT)
2. **租户成员层**: `TenantMembershipRole` (OWNER/ADMIN/MEMBER/VIEWER)
3. **权限校验**: `requireTenantPermission(ctx, "permission:name")`

**关键函数**：
- `requireCaseAccess` - 案件级别访问控制
- `requireProjectAccess` - 项目级别访问控制
- `getCaseListAccessWhereOrThrow` - 构建可见案件 Where 条件

**结论**: ✅ 企业级权限模型

---

### 2.3 页面组件代码审阅

#### ✅ `/profile` 页面 - 真实数据

```typescript
// src/app/(dashboard)/profile/page.tsx (line 46-105)
const [
    caseCount,
    recentCases,
    taskCountsRaw,
    recentTasks,
    monthTimeAgg,
    unreadNotificationsCount,
    recentNotifications,
] = await Promise.all([
    prisma.case.count({ where: caseWhere }),
    prisma.case.findMany({ where: caseWhere, ... }),
    prisma.task.groupBy({ ... }),
    prisma.task.findMany({ ... }),
    prisma.timeLog.aggregate({ ... }),
    prisma.notification.count({ ... }),
    prisma.notification.findMany({ ... }),
])
```

**结论**: ✅ 7 个并行 Prisma 查询，完全真实数据

---

#### ✅ `/settings` 页面 - 已重定向

```typescript
// src/app/(dashboard)/settings/page.tsx (line 4-6)
// TG12 审计：禁止可达"空壳/假数据"页面。
redirect("/profile")
```

**结论**: ✅ 空壳页面已下线

---

#### ✅ `/dispatch` 页面 - 真实数据

```typescript
// src/app/(dashboard)/dispatch/page.tsx (line 29-34)
const [kanbanCases, unassignedTasks, teamResult, invitesResult] = await Promise.all([
    getCaseKanbanCards({ status: ["LEAD", "INTAKE"], take: 300 }),
    getUnassignedTasksForDispatch({ take: 120 }),
    getTeamStatus(),
    getMyInvites('received')
])
```

**结论**: ✅ 调用 4 个真实 Server Actions

---

#### ✅ `/calendar` 页面 - 真实数据

```typescript
// src/app/(dashboard)/calendar/page.tsx (line 26-29)
const [occRes, teamRes] = await Promise.all([
    getEventOccurrencesInRange({ from, to, userIds: [userId] }),
    getTeamDirectory({ take: 200 }),
])
```

**结论**: ✅ 真实日程数据

---

#### ✅ `/chat` 页面 - 真实数据

```typescript
// src/app/(dashboard)/chat/page.tsx (line 9)
const bootstrap = await getMyChatThreads()
// ...
const initialMessagesRes = initialThreadId ? await getChatMessages(initialThreadId, 80) : null
```

**结论**: ✅ 真实聊天线程与消息

---

#### ✅ `/admin` 页面 - 真实数据

```typescript
// src/app/(dashboard)/admin/page.tsx (line 36-66)
const [pendingApprovals, pendingInvoices, templateCount, failedJobs, cleanupCandidates, openAlerts] = await Promise.all([
    canApprovals ? prisma.approvalRequest.count({ where: { status: ApprovalStatus.PENDING, ... } }) : Promise.resolve(0),
    canFinance ? prisma.invoice.count({ where: { status: {...}, ... } }) : Promise.resolve(0),
    // ...
])
```

**结论**: ✅ 6 个条件权限查询

---

#### ✅ `/tools` 页面 - 混合模式

```typescript
// src/app/(dashboard)/tools/page.tsx
// 1. 纯前端计算器组件（诉讼费/利息/期限）
// 2. DB 工具模块（getToolModules、triggerModuleWebhook）
```

**结论**: ✅ 前端计算器 + DB 模块管理

---

## 三、潜在问题与技术债

### 3.1 大型组件需拆分

| 文件 | 行数 | 建议 |
|------|------|------|
| `tasks-crud.ts` | 1622 | 拆分为 CRUD、Kanban、通知 三个模块 |
| `documents.ts` | 1600 | 拆分为 CRUD、Upload、Template 三个模块 |
| `timelogs-crud.ts` | 1240 | 拆分为 Timer、Manual、Approval 三个模块 |
| `TaskKanban.tsx` | 1200+ | 拆分为 Column、Card、DnD 子组件 |
| `tools/page.tsx` | 1083 | 拆分为计算器组件 + 模块管理面板 |

### 3.2 Rust 后端与 Next.js 边界

项目存在两套后端：
- **Next.js Server Actions** - 全栈 UI 联动
- **Rust Axum** - 高性能 API 网关

**潜在风险**：
1. Schema 变更需同步两边 (Prisma vs SeaORM)
2. 权限逻辑需保持一致
3. 需明确职责边界文档

### 3.3 Client 组件数据依赖

部分 `"use client"` 组件通过 props 接收服务端预取数据，但也通过 `useEffect` 刷新：

```typescript
// TaskKanban.tsx 示例模式
const [tasks, setTasks] = useState<TaskForKanban[]>(initialTasks)
useEffect(() => {
    refreshTasks()  // 客户端刷新
}, [deps])
```

**建议**: 考虑使用 TanStack Query 或 SWR 统一数据获取层

---

## 四、代码质量指标

### 4.1 输入校验覆盖

检查所有 Server Actions 是否使用 Zod：

| 模块 | Zod 使用 | 校验完整度 |
|------|----------|------------|
| cases.ts | ✅ | 完整 |
| tasks-crud.ts | ✅ | 完整 |
| timelogs-crud.ts | ✅ | 完整 |
| documents.ts | ✅ | 完整 |
| chat-actions.ts | ✅ | 完整 |
| ai-actions.ts | ✅ | 完整 |
| search-actions.ts | ✅ | 完整 |

### 4.2 错误处理模式

```typescript
// 统一模式（观察到的最佳实践）
try {
    const parsed = SomeSchema.safeParse(input)
    if (!parsed.success) {
        return { success: false, error: parsed.error.issues[0]?.message || "输入校验失败" }
    }
    // ... 业务逻辑
    return { success: true, data: result }
} catch (error) {
    console.error("操作失败:", error)
    return { success: false, error: "操作失败" }
}
```

**结论**: ✅ 错误处理统一

### 4.3 revalidatePath 使用

所有写操作都正确调用 `revalidatePath` 触发缓存失效：

```typescript
revalidatePath(`/cases/${caseId}`)
revalidatePath("/tasks")
revalidatePath("/documents")
```

**结论**: ✅ 缓存失效正确

---

## 五、与架构设计的对齐度

### 5.1 "无前端不后端" 原则

| 功能 | 前端 | 后端 Action | Schema | ✓ |
|------|------|-------------|--------|---|
| 案件 CRUD | ✅ | `cases.ts` | `Case` | ✅ |
| 任务看板 | ✅ | `tasks-crud.ts` | `Task` | ✅ |
| 计时追踪 | ✅ | `timelogs-crud.ts` | `TimeLog` | ✅ |
| 文档管理 | ✅ | `documents.ts` | `Document` | ✅ |
| 聊天沟通 | ✅ | `chat-actions.ts` | `ChatThread/ChatMessage` | ✅ |
| AI 助手 | ✅ | `ai-actions.ts` | `AIConversation/AIInvocation` | ✅ |
| 全局搜索 | ✅ | `search-actions.ts` | 聚合查询 | ✅ |
| 工具箱 | ✅ | `tool-actions.ts` | `ToolModule/ToolInvocation` | ✅ |

### 5.2 "No Mock Data" 原则

**搜索结果**：
- `MOCK_` → 0 结果
- `fake` → 0 结果
- `hardcoded` → 0 结果

**结论**: ✅ 无 mock 数据残留

### 5.3 "后端强权限" 原则

所有 actions 开头都调用：
```typescript
await getActiveTenantContextWithPermissionOrThrow("permission:xxx")
requireTenantPermission(ctx, "permission:yyy")
await requireCaseAccess(caseId, user, "case:view")
```

**结论**: ✅ 权限后端强校验

---

## 六、总结

### 代码审阅结论

**LawClick 项目代码实现了其架构设计承诺**：

1. ✅ **所有核心功能都有真实的 Server Actions**，通过 Prisma 与 PostgreSQL 交互
2. ✅ **无 mock 数据残留**，空壳页面已下线或重定向
3. ✅ **统一的权限模型**，双层（用户角色 + 租户成员角色）校验
4. ✅ **完整的输入校验**，全量 Zod Schema
5. ✅ **审计可追溯**，AI 调用、工具 webhook 等均落库

### 待改进项

1. **大型模块拆分** - 提升可维护性
2. **Rust/Next.js 边界文档化** - 明确职责
3. **数据获取层统一** - 考虑引入 TanStack Query

---

*代码审阅完成时间: 2025-12-29 19:14 CST*

---

## 七、深度安全审计补充 (2025-12-29 22:00)

### 7.1 安全检查通过项

| 检查项 | 结果 | 说明 |
|--------|------|------|
| XSS 风险 |  无 | 无 dangerouslySetInnerHTML/innerHTML |
| 代码注入 |  无 | 无 eval/new Function |
| SQL 注入 |  安全 | Prisma.sql 模板参数化 |
| 密码存储 |  安全 | bcrypt 加密 |
| 密钥管理 |  安全 | 仅存于环境变量 |

### 7.2 发现的潜在问题

1. **缺少 API Rate Limiting** - 风险: 暴力破解/API滥用
2. **错误处理模式不一致** - 部分 throw(47处)，部分 return
3. **console.error 生产使用** - 244处，建议结构化日志
4. **大型文件需拆分** - tasks-crud(1622行)、documents(1600行)

### 7.3 代码卫生 

TODO/FIXME/HACK: 0 | eslint-disable: 1 | console.log: 2

---

## 八、最终评估

| 维度 | 评级 |
|------|------|
| 安全性 |  良好 |
| 代码质量 |  需优化 |
| 生产就绪 |  需补充 |

*深度审计时间: 2025-12-29 22:00 CST*


---

## 九、前后端功能一致性审计 (2025-12-29 22:15)

### 9.1 模块覆盖率统计

| 模块 | 后端 Actions | 前端调用点 | 覆盖率 |
|------|-------------|-----------|--------|
| 案件管理 | 11 | 7 组件 |  完整 |
| 任务看板 | 47 | 6 组件 |  完整 |
| 计时追踪 | 21 | 13 组件 |  完整 |
| 文档管理 | 34 | 8 组件 |  部分缺失 |
| 审批流程 | 7 | 4 组件 |  完整 |
| 聊天沟通 | 5 | 3 组件 |  完整 |
| 日历事件 | 6 | 11 组件 |  完整 |
| 通知系统 | 3 | 2 组件 |  完整 |

### 9.2 发现的不一致问题

#### 问题 1: 文档删除功能缺 UI
**后端**: \deleteDocument\ 已实现（line 381-427）
**前端**: \DocumentListClient\ 未调用此 action
**建议**: 添加删除确认对话框

#### 问题 2: 案件删除功能缺后端
**UI**: \CaseSettingsTab\ 有删除按钮（line 245）但被禁用
**后端**: \cases-crud.ts\ 无 \deleteCase\ 实现
**建议**: 实现软删除 + 关联数据归档

#### 问题 3: 文档版本历史 UI 待完善
**后端**: \DocumentVersion\ 表 + 版本创建逻辑完整
**前端**: 版本列表展示可能不完整

### 9.3 功能完整性总结

核心业务流程前后端一致:
-  案件 CRUD + 状态流转
-  任务 Kanban 拖拽持久化
-  Timer 状态机 (start/stop/pause/resume)
-  文档上传/下载/预览链路
-  审批创建/批准/驳回/撤回

*一致性审计时间: 2025-12-29 22:15 CST*


---

## 十、深度前后端一致性补充审计 (2025-12-29 22:20)

### 10.1 后端 Actions 存在但 UI 未调用

| Action | 文件 | 说明 |
|--------|------|------|
| deleteDocument | documents.ts:381 | 文档删除功能 UI 未实现 |
| deleteTimeLog | timelogs-crud.ts:974 | 工时删除功能 UI 未实现 |
| updateToolModule | tool-actions.ts:137 | 工具模块编辑 UI 未实现 |
| deleteToolModule | tool-actions.ts:180 | 工具模块删除 UI 未实现 |
| updateInvoiceStatus | finance-actions.ts:185 | 发票状态更新 UI 未实现 |
| getPayments | finance-actions.ts:375 | 收款记录独立查看 UI 未实现 |

### 10.2 前端 UI 存在但后端未实现

| UI 位置 | 说明 | 建议 |
|---------|------|------|
| CaseSettingsTab:245 | 删除案件按钮(禁用) | 实现 deleteCase 软删除 |
| - | 项目更新/删除 | 实现 updateProject/deleteProject |
| - | 合同删除 | 实现 deleteContract |

### 10.3 功能完整性缺口汇总

1. **删除功能系统性缺失** - 案件/项目/合同/工具模块/工时均缺删除 UI/后端
2. **编辑功能部分缺失** - 工具模块/项目缺更新功能
3. **列表查看功能** - 收款记录、文档版本历史独立查看页面缺失

### 10.4 建议优先级

| 优先级 | 功能 | 原因 |
|--------|------|------|
| P0 | 案件软删除 | UI 已有占位，用户预期存在 |
| P1 | 工时删除 | 录入错误需修正 |
| P1 | 文档删除 | 文件管理基础功能 |
| P2 | 工具模块编辑/删除 | 管理功能完整性 |
| P2 | 项目 CRUD 完善 | 内部项目管理 |

*深度一致性审计时间: 2025-12-29 22:20 CST*

