# LawClick 批判性全维度审计与修复报告

> **审查类型**：全维度批判性审计（结构 / 安全 / 性能 / 可访问性 / 依赖健康度 / DB 设计 / API 设计一致性 / 错误处理与日志 / DevOps 就绪度 / 国际化 / 可维护性）  
> **审查范围**：`lawclick-next/`（Web mainline）  
> **审查日期**：2026-01-03  
> **审查原则**：挑刺、可复现、可落地；不接受“仅写 UI / 仅写后端 / 仅做引用覆盖”的空壳交付。

---

## 一、证据（原始审计产物）

以下均为可复现产物（位于 `docs/_artifacts/`）：

- 代码结构：`docs/_artifacts/code_structure_audit_2026-01-04.md`
- 安全：`docs/_artifacts/security_audit_2026-01-04.md`
- 性能：`docs/_artifacts/performance_audit_2026-01-04.md`
- 可访问性（A11y）：`docs/_artifacts/a11y_audit_2026-01-03.md`
- 依赖健康度：`docs/_artifacts/deps_health_audit_2026-01-04.md`
- DB 设计：`docs/_artifacts/db_design_audit_2026-01-04.md`
- API 设计一致性：`docs/_artifacts/api_design_audit_2026-01-04.md`
- 错误处理与日志：`docs/_artifacts/error_logging_audit_2026-01-04.md`
- DevOps 就绪度：`docs/_artifacts/devops_readiness_audit_2026-01-04.md`
- 国际化/本地化：`docs/_artifacts/i18n_l10n_audit_2026-01-04.md`
- 可维护性：`docs/_artifacts/maintainability_audit_2026-01-04.md`
- 业务完整性（补充门禁）：`docs/_artifacts/business_completeness_audit_2026-01-04.md`
- Actions 限流覆盖：`docs/_artifacts/action_rate_limit_coverage_audit_2026-01-04.md`

---

## 二、关键发现（必须整改）

### 2.1 本地审计稳定性缺陷：Playwright webServer 与开发服务器互斥

**现象**：当本地已运行 `pnpm dev` 时，`pnpm -C lawclick-next audit:a11y` 可能报错：

- `Unable to acquire lock at ...\\.next\\dev\\lock, is another instance of next dev running?`

**根因**：Playwright 配置启动 `next dev` 会争用同一个 `.next/dev/lock`，导致同时存在两个 dev server 时必然失败（与端口无关）。

**落地修复（已完成）**：

- 使用 `NextConfig.distDir` 做隔离：Playwright webServer 运行在独立目录 `.next-playwright/`，不再与 `.next/` 冲突。
- 同步修复 ESLint 与 Git 忽略：避免把 `.next-playwright/` 当作源码扫描（否则 lint 会在生成文件内产生大量误报并直接失败）。

**改动点**：

- `lawclick-next/next.config.ts`
- `lawclick-next/playwright.config.ts`
- `lawclick-next/eslint.config.mjs`
- `lawclick-next/.gitignore`

**验证**：

- 在 `pnpm -C lawclick-next dev` 运行期间，`pnpm -C lawclick-next audit:a11y` 仍可通过（不再出现 lock 冲突）。

---

## 三、非阻断但必须纳入治理计划（可追溯）

### 3.1 依赖过期（需制定升级策略）

见：`docs/_artifacts/deps_health_audit_2026-01-04.md`

- `@tanstack/react-virtual` 小版本更新可择机升级。
- `prisma` / `@prisma/client` 存在 **大版本跃迁（5 → 7）**：需要迁移评估（生成器、Client API、迁移兼容性、潜在 breaking changes），不建议在“功能缺口仍大量存在”阶段盲升。

### 3.2 大文件风险（影响可维护性与一致性治理）

见：`docs/_artifacts/code_structure_audit_2026-01-04.md`

- `lawclick-next/src/actions/tasks-crud.ts`
- `lawclick-next/src/actions/documents.ts`
- `lawclick-next/src/actions/timelogs-crud.ts`
- `lawclick-next/src/components/tasks/TaskKanban.tsx`

建议：在“前后端一致性缺口收敛”后，按领域拆分为更细粒度模块（同时保持权限/校验/错误处理模式一致）。

---

## 四、结论

- B 线（结构/安全/性能/可访问性/DB/API/日志/DevOps/i18n/可维护性）总体通过现有审计门禁。
- 已补齐一个真实阻断：本地 A11y 审计稳定性与 lint 误扫生成目录问题。
- 下一阶段应回到主矛盾：按 `docs/前后端功能缺失专项审查_2025-12-30.md` 的“挑刺式方法”复跑功能一致性并逐条端到端补齐。

