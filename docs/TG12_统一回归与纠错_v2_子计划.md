# TG12｜统一回归验收与纠错 v2（路由断链巡检 + 告警收敛）

> 范围：`lawclick-next/`（主工程）+ 根目录文档体系  
> 约束：遵循 `prompt/1211架构设计.md`、`.agent/rules/lawclick.md`、`docs/LegalMind设计语言规范.md`  
> 核心原则：**无前端不后端 / 无假数据 / 权限后端强校验 / MDI + LEGO**

---

## 0. 背景与问题
TG0～TG11 已完成主要模块闭环，但仍需进入“统一回归 + 纠错”阶段，确保在**真实 Postgres + 真实角色**下稳定可用，并把剩余的：
- 路由断链 / 入口 404
- 跳转闭环缺失（通知/搜索 actionUrl）
- 构建期告警噪音（dynamic server usage）
收敛到“可持续迭代”的状态。

---

## 1. Done Definition（完成标准）
1. **DB 真源可重复**：在可连接 Postgres 的环境完成 `migrate deploy + 导入脱敏生产快照`，可重复执行（禁止 synthetic seed）。
2. **主线回归可走通**：案件→任务→计时→文档→日程/调度→聊天→通知→搜索全链路可回读。
3. **入口级断链为 0**：Sidebar/Header/通知/搜索等入口不再出现 404 或“可点但无响应”。
4. **告警收敛**：`next build` 不再输出 `Dynamic server usage` 错误（允许保留非阻塞提示，但必须记录原因与策略）。

---

## 2. 工作拆分（DID 落地）

### 2.1 Design（巡检口径与回归脚本）
- 入口巡检口径：以 `src/config/navigation.ts` + Header 入口为准。
- 跳转闭环口径：通知 `actionUrl`、全局搜索 `url` 的路由必须存在且可定位（`/cases/:id?tab=...`、`/chat?threadId=...`）。
- 回归脚本：至少跑 2 个角色（`partner1` 与 `lawyer1`），并记录截图/问题列表。

### 2.2 Implement（最小修复策略）
- 路由缺失：优先补齐 **redirect/alias**（避免入口 404），再做 UX 抛光。
- 构建告警：对依赖 session/headers 的页面显式标记 `force-dynamic`，避免构建期静态渲染尝试产生噪音。
- 工具化：新增 `route-audit` 静态脚本，作为“断链守门人”防回归。

### 2.3 Deliver（可复现验收）
- 命令级：`audit:routes`、`build`、`prisma validate`
- DB 可用环境：`migrate deploy`、`restore snapshot`
- 浏览器级：按主线脚本回归并记录到验收文档

---

## 3. 产出物清单（本 TG 必须更新）
- `docs/TG12_统一回归与纠错_v2_子计划.md`（本文件）
- `docs/TG12_统一回归与纠错_v2_验收记录.md`
- `2_active_task.md`（切到 TG12 状态）
- `0_archive_context.md`（追加关键决策与取舍）
- （必要时）`1_project_context.md`（更新“唯一事实来源”）

---

## 4. 验收脚本

### 4.1 命令级（本仓库即可）
- `pnpm -C lawclick-next audit:routes`
- `pnpm -C lawclick-next build`
- `pnpm -C lawclick-next prisma:validate`

### 4.2 DB 可用环境（你本机）
1. `cd lawclick-next; docker compose up -d`
2. `cd lawclick-next; pnpm exec prisma migrate deploy`
3. 导入脱敏生产快照（推荐用本仓库脚本，避免误操作）：
   - `pnpm -C lawclick-next restore:snapshot -- --file <path-to-dump> --reset --yes`     
4. `pnpm -C lawclick-next dev`

> 说明：`pnpm -C lawclick-next exec prisma db seed` 依据 TG0 极限标准会默认拒绝造数，
> 这是“防止假闭环”的守门策略；若需要最小可见数据，请用“脱敏快照导入”或通过 E2E
> 流程在真实 UI 操作中自然产生数据。

### 4.3 浏览器级（至少 2 角色）
1. `partner1` 登录 → `/dashboard` → 新建案件 → 进入案件 → 新建任务并分配给 `lawyer1`
2. `lawyer1` 登录 → 通知角标变化 → 点击通知跳转到案件 `?tab=tasks` → 启动计时 → 停止 → `/time` 可回读
3. 上传文档 → `/documents` 列表可见 → 进入详情页 → 受控下载
4. 创建日程并发邀请 → `/dispatch` 处理 → 通知回执跳转闭环
5. `/chat` 发送消息 → 对方收到通知 → `/chat?threadId=...` 定位会话
6. Header `Ctrl/Cmd + K` 搜索：Case/Task/Document/Contact 均可跳转

---

## 5. 风险与回滚
- 风险：入口修复分散导致遗漏 → 通过 `audit:routes` 工具化收敛风险。
- 风险：强制 dynamic 可能影响静态优化 → 本项目以“会话/权限后端强校验”为先，动态渲染符合预期。
- 回滚：若当前工作区包含 git 历史则以 git 为准；若无 `.git/`（例如拷贝目录），则以 `docs/_artifacts/` 的证据包与变更记录为准，必要时通过文件级回退恢复。
