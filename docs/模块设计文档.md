# 律时ERP系统 - 模块设计文档

## 文档信息
- **版本**: 2.0
- **创建日期**: 2025-01-22
- **最后更新**: 2025-01-22
- **作者**: 架构团队
- **验证状态**: ✅ 已通过Context7技术验证

## 系统架构概览

### 整体架构图
```
┌─────────────────────────────────────────────────────────────────┐
│                        前端层 (Frontend Layer)                    │
├─────────────────┬─────────────────┬─────────────────────────────┤
│   Web前台       │   Web后台       │      移动端App              │
│  (Next.js)      │  (Next.js)      │   (Flutter) ✅ 原始需求     │
└─────────────────┴─────────────────┴─────────────────────────────┘
                              │
┌─────────────────────────────────────────────────────────────────┐
│                      API网关层 (API Gateway)                     │
│                        (Axum + Tower)                           │
└─────────────────────────────────────────────────────────────────┘
                              │
┌─────────────────────────────────────────────────────────────────┐
│                      业务服务层 (Business Layer)                  │
├─────────────┬─────────────┬─────────────┬─────────────────────┤
│  案件管理   │  用户管理   │  AI服务     │   工作流集成        │
│  模块       │  模块       │  模块       │   模块              │
└─────────────┴─────────────┴─────────────┴─────────────────────┘
                              │
┌─────────────────────────────────────────────────────────────────┐
│                      数据访问层 (Data Layer)                      │
├─────────────┬─────────────┬─────────────┬─────────────────────┤
│ PostgreSQL  │   Redis     │Elasticsearch│   文件存储          │
│ (主数据库)  │  (缓存)     │  (搜索)     │   (MinIO/S3)        │
└─────────────┴─────────────┴─────────────┴─────────────────────┘
```

## 核心模块设计

### 1. API网关模块 (api-gateway)

#### 1.1 模块职责
- 统一API入口和路由管理
- 请求认证和授权
- 限流和熔断保护
- 请求/响应日志记录
- API版本管理

#### 1.2 技术实现
```rust
// 主要依赖 (Cargo.toml)
// axum = "0.7.2"
// tower = "0.4.13"
// tower-http = "0.5.0"
// tokio = "1.35.1"

use axum::{Router, middleware};
use tower::{ServiceBuilder, limit::ConcurrencyLimitLayer};
use tower_http::{cors::CorsLayer, trace::TraceLayer};

// 核心结构
pub struct ApiGateway {
    router: Router,
    auth_service: AuthService,
    rate_limiter: RateLimiter,
}

// 路由配置
impl ApiGateway {
    pub fn new() -> Self {
        let router = Router::new()
            .nest("/api/v1/auth", auth_routes())
            .nest("/api/v1/cases", case_routes())
            .nest("/api/v1/users", user_routes())
            .nest("/api/v1/ai", ai_routes())
            .layer(
                ServiceBuilder::new()
                    .layer(TraceLayer::new_for_http())
                    .layer(CorsLayer::permissive())
                    .layer(ConcurrencyLimitLayer::new(1000))
            );

        Self { router, auth_service, rate_limiter }
    }
}
```

#### 1.3 接口设计
- **认证接口**: `/api/v1/auth/*`
- **业务接口**: `/api/v1/{module}/*`
- **AI接口**: `/api/v1/ai/*`
- **工作流接口**: `/api/v1/workflows/*`

### 2. 用户管理模块 (user-management)

#### 2.1 模块职责
- 用户注册、登录、注销
- 角色权限管理 (RBAC)
- 用户信息维护
- 会话管理
- 多因子认证

#### 2.2 数据模型
```rust
// 依赖版本 (Cargo.toml)
// serde = "1.0.193"
// sea-orm = "0.12.10"
// uuid = "1.6.1"
// chrono = "0.4.31"

use serde::{Deserialize, Serialize};
use sea_orm::entity::prelude::*;

#[derive(Clone, Debug, PartialEq, DeriveEntityModel, Serialize, Deserialize)]
#[sea_orm(table_name = "users")]
pub struct Model {
    #[sea_orm(primary_key)]
    pub id: Uuid,
    pub email: String,
    pub password_hash: String,
    pub name: String,
    pub role: UserRole,
    pub status: UserStatus,
    pub created_at: DateTimeUtc,
    pub updated_at: DateTimeUtc,
}

#[derive(Debug, Clone, PartialEq, EnumIter, DeriveActiveEnum, Serialize, Deserialize)]
#[sea_orm(rs_type = "String", db_type = "Enum", enum_name = "user_role")]
pub enum UserRole {
    #[sea_orm(string_value = "admin")]
    Admin,
    #[sea_orm(string_value = "lawyer")]
    Lawyer,
    #[sea_orm(string_value = "client")]
    Client,
    #[sea_orm(string_value = "staff")]
    Staff,
}
```

#### 2.3 核心服务
```rust
pub struct UserService {
    db: DatabaseConnection,
    redis: RedisPool,
    password_hasher: PasswordHasher,
}

impl UserService {
    pub async fn authenticate(&self, email: &str, password: &str) -> Result<AuthToken> {
        // 用户认证逻辑
    }
    
    pub async fn create_user(&self, user_data: CreateUserRequest) -> Result<User> {
        // 用户创建逻辑
    }
    
    pub async fn update_permissions(&self, user_id: Uuid, permissions: Vec<Permission>) -> Result<()> {
        // 权限更新逻辑
    }
}
```

### 3. 案件管理模块 (case-management)

#### 3.1 模块职责
- 案件生命周期管理
- 案件文档管理
- 时间记录和计费
- 案件进度跟踪
- 相关方管理

#### 3.2 数据模型
```rust
#[derive(Clone, Debug, PartialEq, DeriveEntityModel, Serialize, Deserialize)]
#[sea_orm(table_name = "cases")]
pub struct Model {
    #[sea_orm(primary_key)]
    pub id: Uuid,
    pub case_number: String,
    pub title: String,
    pub description: Option<String>,
    pub case_type: CaseType,
    pub status: CaseStatus,
    pub client_id: Uuid,
    pub assigned_lawyer_id: Uuid,
    pub created_at: DateTimeUtc,
    pub updated_at: DateTimeUtc,
}

#[derive(Debug, Clone, PartialEq, EnumIter, DeriveActiveEnum)]
#[sea_orm(rs_type = "String", db_type = "Enum", enum_name = "case_status")]
pub enum CaseStatus {
    #[sea_orm(string_value = "draft")]
    Draft,
    #[sea_orm(string_value = "active")]
    Active,
    #[sea_orm(string_value = "closed")]
    Closed,
    #[sea_orm(string_value = "archived")]
    Archived,
}
```

#### 3.3 核心服务
```rust
pub struct CaseService {
    db: DatabaseConnection,
    document_service: DocumentService,
    time_tracking_service: TimeTrackingService,
}

impl CaseService {
    pub async fn create_case(&self, case_data: CreateCaseRequest) -> Result<Case> {
        // 案件创建逻辑
    }
    
    pub async fn update_case_status(&self, case_id: Uuid, status: CaseStatus) -> Result<()> {
        // 状态更新逻辑
    }
    
    pub async fn get_case_timeline(&self, case_id: Uuid) -> Result<Vec<CaseEvent>> {
        // 案件时间线查询
    }
}
```

### 4. AI服务模块 (ai-service)

#### 4.1 模块职责
- AI模型接口封装
- 语音转文字服务
- 文档OCR识别
- 智能合同审查
- AI助手对话

#### 4.2 核心架构
```rust
pub trait AIProvider: Send + Sync {
    async fn chat_completion(&self, messages: Vec<ChatMessage>) -> Result<ChatResponse>;
    async fn speech_to_text(&self, audio_data: Vec<u8>) -> Result<String>;
    async fn document_analysis(&self, document: Vec<u8>) -> Result<DocumentAnalysis>;
}

pub struct OpenAIProvider {
    client: reqwest::Client,
    api_key: String,
}

pub struct AIService {
    providers: HashMap<String, Box<dyn AIProvider>>,
    cache: RedisPool,
}

impl AIService {
    pub async fn process_voice_input(&self, audio: Vec<u8>) -> Result<String> {
        // 语音处理逻辑
    }
    
    pub async fn analyze_contract(&self, contract: Vec<u8>) -> Result<ContractAnalysis> {
        // 合同分析逻辑
    }
}
```

### 5. 工作流集成模块 (workflow-integration)

#### 5.1 模块职责
- n8n工作流平台集成
- Cherry Studio集成
- WebHook处理
- 工作流状态同步
- 自定义节点开发

#### 5.2 集成架构
```rust
pub trait WorkflowPlatform: Send + Sync {
    async fn create_workflow(&self, definition: WorkflowDefinition) -> Result<String>;
    async fn execute_workflow(&self, workflow_id: &str, input: serde_json::Value) -> Result<WorkflowExecution>;
    async fn get_workflow_status(&self, execution_id: &str) -> Result<WorkflowStatus>;
}

pub struct N8nIntegration {
    client: reqwest::Client,
    base_url: String,
    api_key: String,
}

impl WorkflowPlatform for N8nIntegration {
    async fn create_workflow(&self, definition: WorkflowDefinition) -> Result<String> {
        // n8n工作流创建
    }
}

pub struct WorkflowService {
    platforms: HashMap<String, Box<dyn WorkflowPlatform>>,
    webhook_handler: WebhookHandler,
}
```

#### 5.3 WebHook处理
```rust
pub struct WebhookHandler {
    routes: HashMap<String, WebhookRoute>,
}

#[derive(Debug, Clone)]
pub struct WebhookRoute {
    pub path: String,
    pub method: HttpMethod,
    pub handler: fn(WebhookPayload) -> Result<WebhookResponse>,
}

impl WebhookHandler {
    pub async fn handle_webhook(&self, path: &str, payload: WebhookPayload) -> Result<WebhookResponse> {
        // WebHook处理逻辑
    }
}
```

## 模块间通信

### 1. 同步通信
- **HTTP API**: 模块间REST API调用
- **gRPC**: 高性能内部服务通信
- **直接函数调用**: 同进程内模块调用

### 2. 异步通信
- **消息队列**: Redis Streams / RabbitMQ
- **事件总线**: 内存事件分发
- **WebSocket**: 实时数据推送

### 3. 数据共享
- **共享数据库**: PostgreSQL主数据库
- **缓存共享**: Redis缓存层
- **文件共享**: MinIO对象存储

## 部署架构

### 1. 单体部署
```yaml
# docker-compose.yml
version: '3.8'
services:
  lawtime-api:
    image: lawtime/api:latest
    ports:
      - "8080:8080"
    environment:
      - DATABASE_URL=postgresql://...
      - REDIS_URL=redis://...
    depends_on:
      - postgres
      - redis
```

### 2. 微服务部署
```yaml
# kubernetes deployment
apiVersion: apps/v1
kind: Deployment
metadata:
  name: case-service
spec:
  replicas: 3
  selector:
    matchLabels:
      app: case-service
  template:
    spec:
      containers:
      - name: case-service
        image: lawtime/case-service:latest
        ports:
        - containerPort: 8080
```

## 扩展性设计

### 1. 水平扩展
- **无状态服务**: 所有业务服务设计为无状态
- **负载均衡**: Nginx/HAProxy负载均衡
- **数据库分片**: 按租户或业务域分片

### 2. 垂直扩展
- **模块拆分**: 按业务域拆分独立服务
- **资源隔离**: 容器资源限制和隔离
- **性能优化**: 缓存策略和查询优化

## 前端模块设计

### Web端架构 (Next.js 15.1.8)

#### 1. 项目目录结构
**文件位置**: `D:\Desktop\LawClick_NEW\apps\web-frontend\`

```
apps/web-frontend/
├── src/app/                  # Next.js 15 App Router
│   ├── layout.tsx            # 根布局组件
│   ├── page.tsx              # 首页
│   ├── login/                # 认证模块 (参照auth_login.html)
│   ├── dashboard/            # 仪表盘模块 (参照lawyer_dashboard.html)
│   ├── cases/                # 案件管理模块 (参照lawyer_case_*.html)
│   ├── calendar/             # 日历模块 (参照lawyer_calendar_view.html)
│   └── time-logs/            # 时间记录模块 (参照lawyer_time_log.html)
├── src/components/           # 可复用组件库
│   ├── ui/                   # Radix UI基础组件
│   ├── forms/                # 表单组件
│   ├── layout/               # 布局组件
│   └── charts/               # 图表组件
├── src/lib/                  # 工具库和配置
│   ├── api.ts                # API客户端
│   ├── auth.ts               # 认证工具
│   └── utils.ts              # 通用工具
└── src/store/                # Zustand状态管理
```

#### 2. 模块职责划分
- **认证模块**: 用户登录、角色选择、权限验证
- **仪表盘模块**: 数据概览、快速操作、统计图表
- **案件管理模块**: 案件CRUD、状态管理、搜索过滤
- **日历模块**: 日程安排、时间视图、事件管理
- **时间记录模块**: 工时记录、计费管理、统计报告

---

**注**: 本模块设计文档将随着系统开发进展持续更新和完善。
