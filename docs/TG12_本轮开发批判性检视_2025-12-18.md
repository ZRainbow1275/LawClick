# TG12 本轮开发批判性检视（忠实记录）

> 审计日期：2025-12-18  
> 审计目标：以“可用性/一致性/无空壳”视角，检查本轮开发产出是否真实可运行、是否存在前后端不一致、组件冗余与工程混乱；并对 lint/build/test 输出与技术债做忠实记录。  
> 重点工程：`lawclick-next/`（TG12 工作主要落地处）  

---

## 0. 运行环境（复现前提）

- Node.js：`v22.15.0`
- npm：`11.6.4`
- pnpm：`8.12.1`
- Rust：`cargo/rustc` **未安装**（因此无法对根目录 Rust 工作区做真实编译验证）
- Flutter：当前安装 `Flutter 3.4.0-17.2.pre (Dart 2.19)`，与 `apps/mobile/pubspec.yaml` 要求的 `>=3.16.5 / Dart >=3.2.3` **不兼容**

---

## 1. 一句话结论（可用性分级）

- ✅ **可运行（通过 lint/build/typecheck/e2e）**：`lawclick-next/`
- ❌ **名义开发但当前不可用（无法 lint/build/typecheck/test）**：`apps/web-frontend/`
- ❌ **当前环境下不可用（依赖约束不满足，pub get 失败）**：`apps/mobile/`
- ⚠️ **架构/文档宣称存在，但代码缺失或不对齐**：根目录 Rust 工作区与 `/api/v1` 文档体系

---

## 2. 关键检查结果（含原始日志落盘）

### 2.1 `lawclick-next/`（通过）

本轮在该目录下执行以下检查，均返回 0：

- `npm -C lawclick-next run lint`  
  证据：`docs/_artifacts/lint_2025-12-18_codex.txt`
- `npm -C lawclick-next run audit:routes`（路由断链审计）  
  证据：`docs/_artifacts/route_audit_2025-12-18_codex.txt`
- `cd lawclick-next; npx tsc --noEmit`  
  证据：`docs/_artifacts/tsc_2025-12-18_codex.txt`
- `npm -C lawclick-next run build`  
  证据：`docs/_artifacts/build_2025-12-18_codex.txt`
- `cd lawclick-next; npx prisma validate`  
  证据：`docs/_artifacts/prisma_validate_2025-12-18_codex.txt`
- `cd lawclick-next; npx playwright test`  
  证据：`docs/_artifacts/playwright_2025-12-18_codex.txt`

### 2.2 `apps/web-frontend/`（失败，且失败是“工程级/配置级”）

- `pnpm -C apps/web-frontend lint`：失败  
  根因：`.eslintrc.json` 中 `extends` 写为 `@typescript-eslint/recommended`，导致 `next lint` 无法加载该配置（应为 `plugin:@typescript-eslint/recommended`）  
  证据：`docs/_artifacts/web-frontend_lint_2025-12-18_codex.txt`

- `pnpm -C apps/web-frontend type-check`：失败（大量 TS 错误，包含 JSX 类型不匹配、axios config 扩展字段、Jest 类型缺失等）  
  证据：`docs/_artifacts/web-frontend_typecheck_2025-12-18_codex.txt`

- `pnpm -C apps/web-frontend build`：失败（同时受 ESLint 配置错误 + TS 错误影响）  
  证据：`docs/_artifacts/web-frontend_build_2025-12-18_codex.txt`

- `pnpm -C apps/web-frontend test`：失败（Jest 未配置 TSX/JSX 转换，直接解析失败）  
  证据：`docs/_artifacts/web-frontend_test_2025-12-18_codex.txt`

### 2.3 根目录 workspace（失败）

- `pnpm lint`：失败（递归执行到 `apps/web-frontend` 即中断）  
  证据：`docs/_artifacts/pnpm_root_lint_2025-12-18_codex.txt`

### 2.4 `apps/mobile/`（失败，原因是环境/版本不对齐）

- `flutter analyze`：失败（Dart SDK 版本不满足 `pubspec.yaml` 约束，`flutter pub get` 直接失败）  
  证据：`docs/_artifacts/mobile_flutter_analyze_2025-12-18_codex.txt`

---

## 3. 前后端一致性与“名义功能”风险

### 3.1 文档 API（`/api/v1`）与真实实现不一致

- 文档定义：`docs/API接口文档.md` 使用 `Base URL: /api/v1`
- 真实实现（`lawclick-next/`）：仅存在少量 Next API routes（从目录可见）
  - `lawclick-next/src/app/api/auth/[...nextauth]/route.ts`
  - `lawclick-next/src/app/api/documents/[id]/file/route.ts`
  - `lawclick-next/src/app/api/queue/process/route.ts`

结论：仓库层面存在两套“后端设想”（Rust `/api/v1` vs Next.js actions/routes），需要明确**唯一权威**的 API/后端来源，否则文档与实现长期漂移。

### 3.2 `apps/web-frontend/` 的“前后端”当前不闭环（大量 mock/占位）

即便忽略其工程无法通过 lint/build，该前端内部也存在明确的“假实现”：

- 登录与鉴权为 mock：`apps/web-frontend/src/store/auth.ts` 内使用 `mockUser/mockToken`，并标注 `// TODO: 实现实际的API调用`
- 多页面标注 `// TODO: 实际API调用`、`// TODO: 保存到API` 等  
  证据汇总：`docs/_artifacts/todo_comments_2025-12-18_codex.txt`

结论：该前端属于“原型/占位态”，**不能作为可用交付物**。

### 3.3 `lawclick-next/` 内仍存在“闭环不完整”的点（虽可构建/测试）

以下属于“能跑但非生产级”的真实缺口（需视为技术债，而非已交付功能）：

- 密码重置邮件为控制台模拟：`lawclick-next/src/actions/auth.ts`（`[Mock Email] ...`）
- 队列处理为假逻辑：`lawclick-next/src/lib/queue.ts`（`// Fake work` + 注释说明真实 handler 未实现）
  证据汇总：`docs/_artifacts/lawclick-next_mock_scan_2025-12-18_codex.txt`

---

## 4. 组件冗余/工程混乱（结构性问题）

### 4.1 多套前端并存且技术栈割裂

- `apps/web-frontend/`：Next.js 15.1.8 + React 18 + Tailwind v3（且当前无法 build）
- `lawclick-next/`：Next.js 16.0.6 + React 19.2 + Tailwind v4（通过 lint/build/e2e）
- `Prototype/`：包含独立的原型项目与依赖目录（`node_modules` 等）

同时存在多套包管理与锁文件（容易产生“装得上但跑不起来/依赖漂移”）：

- 根目录使用 `pnpm-lock.yaml`
- `lawclick-next/` 使用 `package-lock.json`（npm）
- `Prototype/` 也存在 `package-lock.json`

结论：存在明显的“同域功能重复实现”，需要决定：
1) 以 `lawclick-next/` 为唯一主工程并归档其他；或  
2) 以 `apps/web-frontend/` 为主并补齐后端/修复工程；  
否则会持续产生组件冗余与维护混乱。

### 4.2 版本管理不对齐（流程级技术债）

`lawclick-next/` 存在 `.git`，但当前仅有初始提交，工作区呈现大量未纳入版本管理的变更/新增：

- 当前 HEAD：`aed7f7e`（Initial commit）
- `git status --porcelain`：`total=53 untracked=45 modified_or_deleted=8`

这会直接导致：
- 无法追溯“本轮开发”真实变更边界
- 无法做可靠回滚/Code Review/验收对齐

### 4.3 文档/目录命名不对齐

- 根目录 `README.md` 引用 `./doc/...`，但仓库实际为 `docs/`（不存在 `doc/` 目录），导致链接/图片断链。

### 4.4 “宣称存在但实际缺失”的工程骨架

- 根目录 `package.json` 提供 `dev:web-backend` / `build:web-backend`，但实际不存在 `apps/web-backend/`（脚本不可用）。
- 根目录存在 `Cargo.toml`（Rust workspace/服务设想），但缺少 `src/`、`migration/`、`services/` 等成员目录，且当前环境未安装 `cargo/rustc`，因此“Rust 后端”在本仓库状态下不可验证/不可运行。

---

## 5. 扫描型证据（按需查阅）

- TODO/占位/假实现扫描：`docs/_artifacts/todo_scan_2025-12-18_codex.txt`
- TODO（仅注释形式）汇总：`docs/_artifacts/todo_comments_2025-12-18_codex.txt`
- `console.log` 扫描：`docs/_artifacts/console_log_scan_2025-12-18_codex.txt`
- TS 注释（`@ts-expect-error` 等）扫描：`docs/_artifacts/ts_comment_scan_2025-12-18_codex.txt`

---

## 6. 建议的下一步（不做美化，只给可执行收敛方向）

1. 明确“唯一主工程”（建议以 `lawclick-next/` 为主），并把 `apps/web-frontend/` 标记为 `Prototype/` 或归档，避免双线漂移。  
2. 统一 API 权威来源：要么落地 Rust `/api/v1`，要么更新文档与前端为 Next.js actions/routes（否则“前后端一致性”永远无法成立）。  
3. 将 `lawclick-next/` 的本轮变更纳入 git（至少一次可审计的提交），并把 `playwright-report/`、`test-results/`、`.tmp-*.json` 等产物加入 ignore，降低噪音。  
4. 对 `lawclick-next/` 的“模拟邮件/假队列处理”建立明确标记与替换计划（否则属于“名义功能”风险点）。

---

## 7. 2025-12-18 修复闭环（Web 质量门禁：全通过）

本节记录“从问题清单 → 结构性收敛 → 可复现全通过”的闭环动作与证据。

### 7.1 结构性修复（消除根因）

- **确立 Web 主工程**：以 `lawclick-next/` 作为唯一生产 Web 主工程（TG12 主线）。  
- **隔离原型/空壳**：将 `apps/web-frontend/` 从 pnpm workspace 中排除（保留源码但不纳入主线质量门禁），避免其 mock/TODO 与工程级错误阻塞主线。  
  - 配置：`pnpm-workspace.yaml`（使用 `!` 排除规则）
- **根脚本对齐主工程**：根目录 `package.json` 的 `lint/type-check/build/test` 全部改为直接跑 `lawclick-next`，并为 `lawclick-next` 补齐 `type-check/test/prisma:*` 脚本，确保“一键全通过”可复现。  
- **修复文档坏入口**：根 `README.md` 的 `doc/` 断链修复为 `docs/`，并补齐 `docs/assets/logo.svg` 资源。

### 7.2 全通过证据（可复现）

根目录执行以下命令均成功（0 exit code）：

- `pnpm lint`：`docs/_artifacts/pnpm_lint_2025-12-18_web.txt`
- `pnpm type-check`：`docs/_artifacts/pnpm_typecheck_2025-12-18_web.txt`
- `pnpm build`：`docs/_artifacts/pnpm_build_2025-12-18_web.txt`
- `pnpm prisma:validate`：`docs/_artifacts/pnpm_prisma_validate_2025-12-18_web.txt`
- `pnpm audit:routes`：`docs/_artifacts/pnpm_route_audit_2025-12-18_web.txt`
- `pnpm test`（Playwright E2E）：`docs/_artifacts/pnpm_test_2025-12-18_web.txt`

### 7.3 仍保留的显式技术债（未隐瞒）

以下项不影响质量门禁通过，但仍需后续收敛（避免“名义功能”）：

- 密码重置邮件仍为控制台模拟：`lawclick-next/src/actions/auth.ts`
- 队列处理仍为假逻辑（handler 未落地）：`lawclick-next/src/lib/queue.ts`
