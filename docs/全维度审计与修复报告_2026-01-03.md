# LawClick 全维度审计与修复报告（2026-01-03）

> 范围：仅 `lawclick-next/`（Next.js App Router + Prisma）主线；Rust/Axum 原型不作为主线门禁。
>
> 方法：以“前后端一致性 + 可扩展 + 强类型 + 防御性 + 无占位/无 Mock”为标准，先复跑门禁与全套脚本审计，再对残留问题列出可执行修复清单并落地。

---

## 0. 本轮变更摘要（必须真实可复核）

### 0.1 已修复
- 修复 `lawclick-next/src/actions/event-actions.ts` 的重构残留：移除重复 DTO/Schema/工具函数定义，统一改为从 `src/lib/events/event-domain.ts` 引用，避免 TS 重名冲突并恢复可编译状态。
- 完成 `lawclick-next/src/actions/collaboration-actions.ts` 的结构治理收尾：将 `getMyInvites/getUserActivity/getTeamActivity` 的实现抽到 `server-only` 领域模块（`src/lib/collaboration/*`），actions 仅保留最薄 wrapper，并将该文件降到 <900 行（large files 7→6）。
- 完成 `lawclick-next/src/actions/tenant-actions.ts` 的结构治理：将“成员/邀请”重逻辑抽到 `server-only` 领域模块（`src/lib/tenant/*`），actions 仅保留 wrapper + revalidate，并将该文件降到 <900 行（large files 6→5）。

### 0.2 门禁结果
- `pnpm -C lawclick-next type-check`：通过
- `pnpm -C lawclick-next lint`：通过
- `pnpm -C lawclick-next build`：通过

---

## 1. 全套审计（覆盖用户要求的维度）

以下审计均已复跑并写入 `docs/_artifacts/`（可直接打开复核）：

### 1.1 代码结构审查
- `docs/_artifacts/code_structure_audit_2026-01-03.md`

### 1.2 安全性审计
- `docs/_artifacts/security_audit_2026-01-03.md`

### 1.3 性能审计（静态候选）
- `docs/_artifacts/performance_audit_2026-01-03.md`

### 1.4 可访问性审计（E2E / Playwright + axe）
- `docs/_artifacts/a11y_audit_2026-01-03.md`

### 1.5 依赖项健康度
- `docs/_artifacts/deps_health_audit_2026-01-03.md`

### 1.6 数据库设计审计
- `docs/_artifacts/db_design_audit_2026-01-03.md`

### 1.7 API 设计一致性审计
- `docs/_artifacts/api_design_audit_2026-01-03.md`
- `docs/_artifacts/api_surface_audit_2026-01-03.md`（含 Next API vs Rust 原型端点重叠检查）

### 1.8 错误处理与日志审计
- `docs/_artifacts/error_logging_audit_2026-01-03.md`

### 1.9 业务逻辑完整性（聚合门禁/证据链）
- `docs/_artifacts/business_completeness_audit_2026-01-03.md`

### 1.10 DevOps 就绪度审计
- `docs/_artifacts/devops_readiness_audit_2026-01-03.md`

### 1.11 国际化/本地化审计（候选）
- `docs/_artifacts/i18n_l10n_audit_2026-01-03.md`

### 1.12 代码可维护性审计
- `docs/_artifacts/maintainability_audit_2026-01-03.md`

---

## 2. 关键发现（本轮仍需继续修复的“真实问题”）

> 说明：多数审计为 0 offenders，并不代表“功能已 100% 完整”。本节只列出仍客观存在、且可立即落地的工程性缺口。

### 2.1 大文件治理仍未完成（结构债务）
`code_structure_audit_2026-01-03.md` 仍存在 5 个 ≥900 行文件（后续需按领域抽出 `server-only` domain/service，降低文件复杂度与认知负担）：
- `lawclick-next/src/actions/tasks-crud.ts`
- `lawclick-next/src/actions/documents.ts`
- `lawclick-next/src/actions/timelogs-crud.ts`
- `lawclick-next/src/components/tasks/TaskKanban.tsx`
- `lawclick-next/src/components/cases/CaseDetailClient.tsx`

### 2.2 依赖升级存在“可选但高风险”的大版本跃迁
`deps_health_audit_2026-01-03.md` 显示：
- Prisma：`5.22.0 -> 7.x` 为大版本升级（需要评估迁移、生成器、运行时兼容性）
- Node types：`@types/node 20 -> 25` 可能引入类型与运行时假设变化

本轮不直接强行升级大版本，避免引入不可控回归；后续会以“单一变更 + 可回滚 + 门禁全绿”为策略拆分落地。

---

## 3. 下一步执行序列（B 线继续）

1) 继续拆分 ≥900 行文件：优先从 `tasks-crud.ts` / `documents.ts` / `timelogs-crud.ts` 开始，将输入 Schema、DTO、权限/可见性规则、查询构造器抽到对应 `src/lib/<domain>/`，actions 只保留最薄的 orchestration。
2) 在结构治理完成后，重新跑一轮“前后端功能缺失专项审查”并生成新文件（对齐 `docs/前后端功能缺失专项审查_2025-12-30.md` 的方法，但要求更严格：必须证明 UI 入口真实可达、非死代码调用）。
