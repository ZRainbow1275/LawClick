# TG12｜本轮开发批判性检视（2025-12-19）

> 审计范围：仓库整体（重点：`lawclick-next/` 作为 Web 主工程）  
> 对照基准：  
> - 计划：`docs/TG0_基础设施对齐_子计划.md`、`docs/TG1_身份权限体系统一_子计划.md`、`docs/TG2_案件端到端闭环_子计划.md`、`docs/TG3_任务协作与Trello看板_子计划.md`、`docs/TG3_看板对齐增强（参照Focalboard_Planka）_子计划.md`、`docs/TG4_计时追踪_子计划.md`、`docs/TG5_文档中心_子计划.md`、`docs/TG6_仪表盘_MDI-DIY_子计划.md`、`docs/TG7_日程安排_调度中心_子计划.md`、`docs/TG8_案件账务联动_子计划.md`、`docs/TG9_AI模块_工具箱_子计划.md`、`docs/TG11_全局搜索_通知闭环_子计划.md`、`docs/TG12_统一回归与纠错_v2_子计划.md`  
> - 红线：仓库 README 明确的“Web 主工程真可用优先”与“禁止空壳/假数据/权限后端强校验”  
> 审计目标：用“可运行证据 + 对照子计划”判断：哪些是真闭环、哪些是名义开发/空壳、哪些存在前后端/文档不一致与技术债。  
> 证据包（本次新增）：`docs/_artifacts/critical_audit_2025-12-19/`

---

## 1. 结论摘要（先给结论）

### 1.1 “能不能用”的结论
- **Web 主工程 `lawclick-next/`：可以作为主线使用**  
  - `lint / type-check / build / route-audit / migrate / seed / e2e` 在本机 Docker(Postgres+MinIO) 可跑通（见第 2 节证据包）。
- **仓库中仍存在“名义开发/非主线”的部分：**
  1. `apps/mobile/`：仅有 `pubspec.yaml`，缺少 `lib/main.dart` 等 Flutter 工程骨架，**当前不可运行/不可验收**。
  2. 根目录 Rust `src/`（Axum/SeaORM）：能 `cargo check`，但大量未使用/未接入，且与 Web 主工程（Next Server Actions + Prisma）架构口径不一致，**更像“规划占位/试验分支”而非可用后端**。
  3. `_archived/web-frontend/`：历史原型（含 mock/TODO），虽已隔离但仍在仓库内，**需要持续明确其“非主线”边界**。

### 1.2 “是否满足子计划”的结论（TG0-TG12）
- TG0/TG1/TG2/TG4/TG5/TG6/TG7/TG8/TG9/TG11/TG12：**以当前代码与可运行证据看，主线实现基本满足子计划的“真闭环”要求**（前提：Postgres+MinIO 可用，且 AI 需要真实 `OPENAI_API_KEY`）。
- TG3：看板能力（含 Planka gap 排序/撤销/详情弹窗）在代码层已出现并可通过主线 E2E 间接覆盖，但**文档侧缺少“TG3 验收记录”式的闭环归档**（属于“过程对齐缺口”，不是功能缺失）。

---

## 2. 工程守门证据（忠实记录）

> 本节只给“结论 + 原始输出路径”，不美化输出；原始输出均落盘在：`docs/_artifacts/critical_audit_2025-12-19/`

### 2.1 `lawclick-next/` 质量门禁

- 路由断链巡检：通过  
  - 输出：`docs/_artifacts/critical_audit_2025-12-19/pnpm_audit-routes.txt`
- ESLint：通过（0 error / 0 warning）  
  - 输出：`docs/_artifacts/critical_audit_2025-12-19/pnpm_lint.txt`
- TypeScript：通过（`tsc --noEmit`）  
  - 输出：`docs/_artifacts/critical_audit_2025-12-19/pnpm_type-check.txt`
- Next Build：通过  
  - 输出：`docs/_artifacts/critical_audit_2025-12-19/pnpm_build.txt`
- Playwright E2E：**一次失败 → 修复后全绿**  
  - 失败输出：`docs/_artifacts/critical_audit_2025-12-19/pnpm_test_playwright.txt`  
  - 修复后输出：`docs/_artifacts/critical_audit_2025-12-19/pnpm_test_playwright_after_case_tab_fix.txt`

### 2.2 基础设施与真源数据（TG0 关键）
- Docker Compose：Postgres 已运行；MinIO 启动成功，但 compose 输出含 warning（见第 4 节）  
  - 输出：`docs/_artifacts/critical_audit_2025-12-19/docker_compose_up.txt`
- 系统连通验证（DB+MinIO）：通过，但 Node 输出包含 experimental/module-type 警告（见第 4 节）  
  - 输出：`docs/_artifacts/critical_audit_2025-12-19/verify-system.txt`
- Prisma migrate deploy：无 pending migrations（同时提示 Prisma major update 可用，见第 4 节）  
  - 输出：`docs/_artifacts/critical_audit_2025-12-19/prisma_migrate_deploy.txt`
- Prisma seed：成功生成真实业务数据（用户/客户/案件/任务/工时/日程/文档/工具箱/通知）  
  - 输出：`docs/_artifacts/critical_audit_2025-12-19/prisma_db_seed.txt`
- MinIO bucket 初始化：bucket 已存在（同样有 Node warnings）  
  - 输出：`docs/_artifacts/critical_audit_2025-12-19/init-s3.txt`

### 2.3 Rust（根目录 `src/`）可用性证据
- `cargo check`：可编译，但产生大量 unused/dead_code 警告（见第 4 节“名义开发/不对齐”）  
  - 输出：`docs/_artifacts/critical_audit_2025-12-19/cargo_check.txt`

---

## 3. 子计划对齐矩阵（TG0-TG12）

> 这里只记录“是否具备可复现闭环 + 关键证据”，不重复子计划全文。

| TG | 子计划目标（压缩） | 当前实现状态 | 关键证据（文件/命令） |
|---|---|---|---|
| TG0 | Postgres+MinIO+迁移+seed 真可跑 | ✅ | `verify-system.txt`、`prisma_migrate_deploy.txt`、`prisma_db_seed.txt` |
| TG1 | 权限底座统一 + actions 强校验 + 路由拦截 | ✅ | `lawclick-next/src/lib/permissions.ts`、`lawclick-next/src/lib/server-auth.ts`、`lawclick-next/src/proxy.ts` |
| TG2 | 案件主线闭环（创建→详情→联动→归档） | ✅ | E2E `mainline.spec.ts`（由 `pnpm test` 覆盖）+ `/cases/[id]` 真实数据绑定 |
| TG3 | 看板/任务中心拖拽落库 + 详情弹窗 + 撤销 | ✅（功能）/ ⚠️（文档闭环） | `tasks-crud.ts`（gap order + moveTaskOnKanban）+ `TaskKanban.tsx`（撤销/弹窗） |
| TG4 | 计时真闭环（秒口径/单 active/联动） | ✅ | `/time`、`timelogs-crud.ts`、E2E 主线包含“启动计时→停止→回读” |
| TG5 | 文档上传 MinIO + 受控下载 + 版本链 + 详情页 | ✅ | `documents.ts`、`/api/documents/[id]/file`、seed 生成文档、MinIO bucket 可见 |
| TG6 | Dashboard MDI/DIY + 布局落库 | ✅ | `dashboard-layout.ts` + `/dashboard` build 输出为动态页 |
| TG7 | /calendar + /dispatch 真数据 + 邀请闭环 | ✅ | `event-actions.ts` + `collaboration-actions.ts` + E2E 覆盖 chat/通知跳转 |
| TG8 | CRM/OA/财务/合同 + 案件账务 Tab 联动 | ✅ | seed 覆盖 TG8 数据；`CaseBillingTab.tsx` + admin 页面可 build |
| TG9 | AI+工具箱 DB 驱动 + 审计落库 + 安全策略 | ✅（代码）/ ⚠️（需真实 key） | `ai-actions.ts`（无 key 短路+审计）+ `tool-actions.ts`（allowlist） |
| TG11 | 全局搜索 + 通知落库 + 触发点接入 | ✅ | `search-actions.ts`、`notification-actions.ts`、Header 组件、seed 通知 |
| TG12 | 回归守门：route-audit + build 噪音收敛 + e2e | ✅ | `pnpm_audit-routes.txt`、`pnpm_build.txt`、`pnpm_test_playwright_after_case_tab_fix.txt` |

---

## 4. 发现的问题与技术债（忠实记录）

### P0（高风险/上线阻断级）
> 本次未发现 `lawclick-next/` 主线的“构建/类型/测试阻断级”问题（均可复现通过）。

### P1（会导致“看似可用但不稳定/不一致”的问题）
1. **（已修复）案件详情 Tab 与 URL 不同步，导致通知/搜索 deep-link 可靠性下降**  
   - 现象：Playwright `case-tab-deeplink.spec.ts` 期望点击“文档”Tab 后 URL 变为 `?tab=documents`，但实际未变化（见失败输出）。  
   - 证据：`docs/_artifacts/critical_audit_2025-12-19/pnpm_test_playwright.txt`  
   - 修复：将 `window.history.replaceState` 改为 `router.replace(..., { scroll:false })`，让 Next Router 状态与 URL 同步。  
   - 修复文件：`lawclick-next/src/components/cases/CaseDetailClient.tsx`  
   - 复验：`docs/_artifacts/critical_audit_2025-12-19/pnpm_test_playwright_after_case_tab_fix.txt`

2. **`/api/queue/process` 缺少任何鉴权/防护**（潜在安全/误触发风险）  
   - 现状：`lawclick-next/src/app/api/queue/process/route.ts` 允许任何请求触发队列处理；且 middleware matcher 排除了 `/api`，不会被登录拦截。  
   - 风险：若部署到公网，可能被外部反复触发；即便当前 queue 未被业务使用，也属于“裸露内部按钮”。  

### P2（工程噪音/长期维护成本）
1. **Node 运行 TS 脚本的 warning 噪音**  
   - `node --experimental-strip-types` 会输出 ExperimentalWarning；`MODULE_TYPELESS_PACKAGE_JSON` 提示未声明 module type。  
   - 影响：命令输出噪音，且在某些 CI/脚本环境中可能被当作失败条件。  
   - 证据：`verify-system.txt`、`init-s3.txt`、`prisma_db_seed.txt`

2. **Docker Compose 文件格式提示**  
   - `docker-compose.yml` 使用 `version:` 字段会触发 “obsolete” warning（Docker 已忽略该字段）。  
   - 证据：`docker_compose_up.txt`

3. **Prisma 版本存在 major update 提示（5→7）**  
   - 现状：`prisma migrate deploy` 输出提示 5.22.0 → 7.2.0。  
   - 风险：后续依赖升级可能带来 breaking changes；需规划升级窗口与兼容策略。  
   - 证据：`prisma_migrate_deploy.txt`

4. **仓库存在多套“后端/架构口径”，容易造成团队误解与文档漂移**  
   - `lawclick-next/`：明确以 Next Server Actions + Prisma 为后端真源（主线）。  
   - 根目录 Rust：实现了 `/api/v1/*` 风格路由，与 `docs/API接口文档.md`“不使用 /api/v1”口径相冲突，且代码内存在 demo/未接入痕迹（大量 unused/dead_code）。  
   - 结论：Rust 部分目前更像“规划占位/试验”，若继续保留建议更强隔离（避免被误认为生产后端）。  

5. **主线 actions 存在“旧接口/新接口”并存的冗余**（可运行但易漂移）  
   - 示例：`src/actions/tasks.ts` vs `src/actions/tasks-crud.ts`；`src/actions/timelogs.ts` vs `src/actions/timelogs-crud.ts`；以及 `src/app/actions.ts` 聚合导出旧 action。  
   - 风险：权限/返回结构/业务口径可能长期漂移，最终出现“某些页面调用旧 action 绕过新规则”的隐患。  

6. **文档层存在“描述与实现不一致”**（不是代码 bug，但会误导协作）  
   - 例：`docs/API接口文档.md` 中 action 命名/返回结构、`/api/documents/[id]/file` 描述为 presigned，但实现是受控流式返回。  
   - 风险：新成员按文档开发会走偏。  

### P3（非主线，但会影响“整体项目可信度”）
1. `apps/mobile/` 非可运行 Flutter 工程（缺少目录/入口文件/资源）；若对外展示需明确标注“未开始/占位”。  
2. `_archived/` 中保留的历史原型与 mock/TODO：虽然已隔离，但仍建议持续保持“不可被误接入主线”的结构与说明。

---

## 5. “是否空壳/是否真实数据”的结论（按模块）

### 5.1 `lawclick-next/`（主线）
- 数据：真实 Postgres（Prisma）+ MinIO（S3）。seed 可生成真实业务数据并可回读（见 `prisma_db_seed.txt`）。  
- Mock：主线代码中未发现 `MOCK_*` 形式的可达假数据；阶段文书的 `fileUrl=''` 属“占位文书待上传”业务模型，不是前端 mock。  
- 限制（真实但需声明）：  
  - AI：未配置真实 `OPENAI_API_KEY` 时会短路并写 ERROR 审计（属于“可预期降级”，不属于假数据）。  
  - 文档 AI 审查：MVP 内容源为 `notes/粘贴文本`，不做 PDF/DOCX 全文抽取（UI 已明确提示）。

### 5.2 根目录 Rust（非主线）
- 编译：可通过 `cargo check`，但大量未使用/未接入，且路由列表与实际 nest 存在不一致。  
- 架构口径：`/api/v1/*` 与 Web 主工程“Server Actions”口径冲突，若不明确隔离，容易造成“名义上有后端、实际上不用/不一致”的误判。

### 5.3 `apps/mobile/`（非主线）
- 当前不可运行（缺少 Flutter 工程最小骨架），属于“名义占位”。

---

## 6. 本次对代码的最小修复（为回归守门服务）

> 本次审计中，为保证 TG12 回归守门链路真实可持续，做了 1 处最小修复：
- `lawclick-next/src/components/cases/CaseDetailClient.tsx`：Tab 切换写 URL 由 `window.history.replaceState` 改为 `router.replace`（修复 deep-link 可靠性），对应 E2E 已复验全绿（见第 2.1）。

---

## 7. 整改后复验补充（2025-12-19 → 2025-12-20）

> 本节补充“整改后状态”，用于对齐你追加的“极限标准”红线；不覆盖上方作为“当时审计快照”的原始记录。

### 7.1 本轮检视中标出问题的整改状态
1. `/api/queue/process` 鉴权缺失 → 已修复：`lawclick-next/src/app/api/queue/process/route.ts` 增加 secret header 或 admin 权限门禁。
2. Node TS 脚本 warning 噪音 → 已修复：将 `lawclick-next/scripts/*.ts` 改为 `*.js`（新增 `verify:system` / `init:s3` 脚本），避免 `--experimental-strip-types` 与 module-type 警告噪音。
3. Docker Compose `version:` warning → 已修复：`lawclick-next/docker-compose.yml` 移除 `version:` 字段。
4. actions “旧/新接口并存”漂移风险 → 已缓解：
   - `lawclick-next/src/actions/tasks.ts`、`lawclick-next/src/actions/timelogs.ts` 已改为对 `*-crud.ts` 的薄封装（输入校验 + 委托），避免规则分叉。
   - `lawclick-next/src/actions/register.ts` 已删除，统一使用 `lawclick-next/src/actions/auth.ts` 的 `registerUser`。
5. 文档与实现不一致 → 已修复：`docs/API接口文档.md` 已按主线实现更新（受控下载、队列鉴权、AI provider 抽象等）。
6. TG3 过程对齐缺口（缺少验收记录）→ 已补齐：
   - `docs/TG3_任务协作与Trello看板_验收记录.md`
   - `docs/TG3_看板对齐增强（参照Focalboard_Planka）_验收记录.md`
7. “真实数据/禁止造数”冲突（seed）→ 已按极限标准调整：
   - `lawclick-next/prisma/seed.ts`/`seed.js` 默认拒绝 synthetic 造数，改为导入脱敏生产快照（因此本报告第 2.2/5.1 中“seed 造数成功”的描述属于当时快照，不再作为整改后口径）。
8. Queue 系统“名义存在但业务不使用”→ 已修复：案件/任务/邀请/成员通知会同步写入 `TaskQueue.SEND_EMAIL`（见 `lawclick-next/src/lib/notifications.ts`），并移除未实现的 `GENERATE_*` job 类型（见 `lawclick-next/src/lib/job-handlers.ts`、`lawclick-next/src/lib/queue.ts`）。

### 7.2 复验证据（整改后）
- 复验输出统一落盘：`docs/_artifacts/tg12_remediation_2025-12-19/`（含 lint/type-check/build/test/route-audit 与扫描快照）。
- 整改闭环总览：`docs/TG12_极限标准整改闭环_2025-12-19.md`

### 7.3 仍需持续治理（不在本轮阻断范围）
- Prisma 5→7 major 升级窗口与兼容策略（需单独 TG/窗口）。
- 根目录 Rust 原型与 Web 主线的“边界隔离”（避免被误认为生产后端）。
- `apps/mobile/`（本轮按你要求忽略；待 Web 主线完全后再启动移动端开发）。





