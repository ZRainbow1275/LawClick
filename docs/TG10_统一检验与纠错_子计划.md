# TG10 统一检验与纠错（全链路回归 + 残留 mock/空壳清理）子计划

> 约束：`prompt/1211架构设计.md` + `.agent/rules/lawclick.md`  
> 主工程：`lawclick-next/`（Next.js App Router + Prisma + Postgres + MinIO）  
> 方法论：DID = Design → Implement → Deliver（每个子模块都要闭环）

## 0. 背景与问题定位（为什么要做 TG10）
TG0~TG9 已完成核心模块落地，但在统一回归中仍发现少量“入口级别”的遗留问题会让系统呈现为“空壳/假数据”，直接违背硬性规则：
- `AppHeader` 仍使用 `mockUser/mockProfile`，退出登录逻辑与 NextAuth 不一致；
- 仪表盘入口的 `NewCaseWizard` 仍为“模拟创建/模拟冲突检查”，没有真实落库；
- `/chat` 页面与浮窗 `FloatingChat` 仍为 mock 聊天数据；
- Header 中的通知/全局搜索/性能面板存在 mock 或空壳倾向（至少不能再展示伪数据）。

TG10 的目标是：围绕“案件业务流为主线”，把这些入口补齐为**可登录、可创建案件、可沟通协作**的真实闭环，并完成一次全链路回归。

## 1. 目标与验收标准（必须做到）
### 1.1 总体验收（端到端）
1. 登录后顶部栏展示真实登录用户信息（name/email/role），退出登录走 NextAuth `signOut`；
2. 仪表盘「新建案件」可真实创建案件（落库 Case + CaseMember + ConflictCheck），创建后能跳转到 `/cases/[id]`；
3. `/chat` 页面为真实数据：会话列表来自 DB，消息发送会落库并可刷新回放；
4. 浮窗聊天（MDI Window `CHAT`）与 `/chat` 使用同一套后端数据源，不再出现 mock 数据；
5. 回归：`pnpm -C lawclick-next build` 通过（DB 不可用时以编译为准，DB 可用时补做 migrate deploy + 脱敏快照导入验证）。

### 1.2 “无假数据/无空壳”硬性验收
- 所有仍对用户可见的功能入口：必须具备 Schema（如需要）+ Server Actions/API + 权限校验 + 真实落库/读取。
- 任何无法闭环的入口：必须从 UI 移除或显式标注为不可用且无伪数据（本 TG 优先选择“实现闭环”）。

## 2. 范围划分（主次明确）
### 2.1 本 TG 主范围（必须完成）
**A. Header 登录态统一**
- AppHeader 替换 mock 用户数据为 NextAuth `useSession` 真会话数据；
- 退出登录改为 `signOut({ callbackUrl: "/auth/login" })`；
- 清理 `useUserStore` 默认 mock 用户（避免未来误用）。

**B. 新建案件向导真实化（以案件为核心）**
- `NewCaseWizard` 改为调用真实 Server Actions：
  - 拉取可选客户：`getClientsForSelect`
  - 拉取可选团队成员：`getLawyersForSelect`
  - 冲突检查预览：新增 `previewConflictCheck`（不落库，仅用于向导展示）
  - 创建案件：`createCase`（落库 Case + CaseMember + ConflictCheck）
- 向导收集的“案件详情/计费配置”等信息不允许丢失：落到 `Case.metadata`（最小可扩展）。

**C. 消息沟通模块真实闭环（以案件/团队为中心）**
- 新增 Chat 领域模型（Prisma）：`ChatThread / ChatParticipant / ChatMessage`（含 `key` 唯一约束，支持 TEAM/CASE/DIRECT）
- Server Actions：
  - 获取我的会话列表（含未读数/最后一条消息摘要）
  - 获取会话消息（分页/最近 N 条）
  - 发送消息（权限校验、落库、更新 lastReadAt）
  - 保障 TEAM/CASE/DIRECT 会话可 get-or-create
- UI：
  - `/chat` 页面由 mock → DB 驱动；
  - 浮窗 `FloatingChat` 由 mock → DB 驱动；支持 `window.data` 传入 `caseId/threadId` 作为上下文默认会话。
- 与案件业务流联动：
  - 创建案件时自动创建 `CASE:{caseId}` 群聊，并把案件成员加入会话参与人（至少 handler + originator + memberIds）。

### 2.2 本 TG 次范围（尽量做但不阻塞主线）
- Header 的通知/全局搜索/性能面板：至少移除伪数据展示；若可快速闭环，则以最小真实实现替换。

### 2.3 明确不做（本 TG 不扩张）
- Chat 附件/语音/视频通话/实时 WebSocket（先保证“可用+可追溯”，实时后续迭代）。
- 复杂的组织/多租户隔离（当前以 `default-tenant` 与现有权限体系为准）。

## 3. DID 方案设计
### 3.1 Design（领域与数据/接口）
#### 3.1.1 Chat 数据模型设计（最小可扩展）
- `ChatThreadType`：`TEAM | CASE | DIRECT`
- `ChatMessageType`：`TEXT | SYSTEM`（MVP 先用 TEXT）
- `ChatThread.key`（唯一）：
  - TEAM：`TEAM:default`
  - CASE：`CASE:{caseId}`
  - DIRECT：`DIRECT:{minUserId}:{maxUserId}`
- 未读数：基于 `ChatParticipant.lastReadAt` 与消息时间计算（不引入额外 counter，避免一致性问题）。

#### 3.1.2 Case 创建向导字段落地策略
- `Case` 领域保持精简：主要字段（title/serviceType/billingMode/client/handler/contractValue/description）写入主表；
- “向导扩展字段”（争议金额/管辖/紧急程度/预估费用/费率等）写入 `Case.metadata`（Json）：
  - `intake.disputeAmount`
  - `intake.jurisdiction`
  - `intake.filingDate`
  - `intake.urgencyLevel`
  - `billing.billingRate`
  - `billing.estimatedAmount`

#### 3.1.3 权限与访问控制（必须在后端）
- Header：仅展示；退出调用 NextAuth。
- NewCaseWizard：
  - `getClientsForSelect`：`case:view`
  - `getLawyersForSelect`：`case:create`
  - `previewConflictCheck`：`case:create`
  - `createCase`：`case:create`
- Chat：
  - TEAM：`team:view`
  - CASE：`requireCaseAccess(caseId, userId, role, "case:view")`
  - DIRECT：仅参与者

### 3.2 Implement（实现顺序）
1. **Schema & Migration**：补齐 Chat（以及必要的索引/唯一约束），并确保“运行期自举”策略覆盖：TEAM thread 在首次进入聊天时自动创建；CASE thread 在首次访问/发消息时按案件真实落库创建（不依赖 seed 造数）。
2. **Server Actions**：实现 chat-actions + previewConflictCheck + createCase 扩展（metadata/冲突参数/创建 CASE 群聊）。
3. **UI 改造**：
   - AppHeader 去 mock + 退出登录改为 signOut；
   - NewCaseWizard 去 mock + 真实拉取/冲突检查/创建；
   - `/chat` & `FloatingChat` 去 mock + 真实会话/消息。
4. **联动补齐**：案件成员变更时，尽量同步 chat participant（如有现成入口）。

### 3.3 Deliver（交付与回归）
- 编译/构建：`pnpm -C lawclick-next build`
- DB 可用时补做：
  - `pnpm -C lawclick-next exec prisma migrate deploy`
  - 导入脱敏生产快照：`pnpm -C lawclick-next restore:snapshot -- --file <path-to-dump> --reset --yes`
- 手工回归清单：
  1) 登录 → Dashboard 头部信息正确；  
  2) Dashboard 新建案件 → /cases/[id] 可打开；  
  3) /chat 可见 TEAM 会话；发送消息后刷新仍在；  
  4) 案件详情（或从创建后的案件）打开 chat 上下文（若提供入口）可看到 CASE 群聊。

## 4. 交付物清单（本 TG 结束必须更新）
- 子计划（本文件）：`docs/TG10_统一检验与纠错_子计划.md`
- 验收记录：`docs/TG10_统一检验与纠错_验收记录.md`
- 总计划更新：`docs/1211_架构落地开发总计划_v1.md` 增补 TG10 状态
- 快照更新：`2_active_task.md`
- 归档追加：`0_archive_context.md`（记录 TG10 的关键决策：Chat 数据模型 key 策略、Case.metadata 落地策略等）
