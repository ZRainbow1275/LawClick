# 全项目启动与实地测试手册（2025-12-20）

> 范围：`lawclick-next/`（Web 主线）+ 根目录 `src/`（Rust 原型）；本轮忽略 `apps/mobile/`。  
> 标准：极限标准（真数据、全量校验、拒绝空壳、显式错误、生产对齐）。

---

## 0. 前置条件（必须满足）

- Node.js ≥ 18.19、pnpm ≥ 8
- Rust ≥ 1.75（`cargo` 可用）
- Docker Desktop（能运行 Linux 容器）

端口占用要求：
- Web：默认 `3000`（若 3000 被 WSL/Docker 转发占用，会自动切换到 `3010` 等可用端口；以终端输出为准）
- Rust API：`8080`（可用 `PORT` 改）
- Postgres：`5434`
- MinIO：`9000/9001`

---

## 1. 环境变量与密钥（生产对齐：缺失即失败）

### 1.1 Web（`lawclick-next/.env`）

最少需要：
- `DATABASE_URL`
- `NEXTAUTH_URL=http://localhost:3000`（dev 启动脚本会按实际端口自动覆写为 `http://localhost:<port>`）
- `NEXTAUTH_SECRET`（建议 ≥ 32 字符；Rust 侧强制 ≥ 32）
- `S3_ENDPOINT`、`S3_ACCESS_KEY`、`S3_SECRET_KEY`、`S3_BUCKET_NAME`       

可选（不配则 AI 显式失败）：`OPENAI_API_KEY`、`OPENAI_BASE_URL`、`OPENAI_MODEL`

生成强密钥（Windows PowerShell）：
```powershell
node -e "console.log(require('crypto').randomBytes(32).toString('hex'))"
```

### 1.2 Rust（根目录 `src/`，启动 `server`）

必需：
- `DATABASE_URL`（与 Web 指向同一个 Postgres）
- `JWT_SECRET`（≥32，用于 Rust 自签 Token）
- `NEXTAUTH_SECRET`（或 `AUTH_SECRET`，≥32，必须与 Web 一致，用于解密 Auth.js JWE）
- `S3_ENDPOINT`、`S3_ACCESS_KEY`、`S3_SECRET_KEY`、`S3_BUCKET_NAME`（与 Web 一致）

可选：`PORT`、`CORS_ALLOW_ANY` / `CORS_ALLOW_ORIGINS`、`OPENAI_API_KEY` 等

---

## 2. 启动基础设施（Postgres + MinIO）

首次启动建议先安装依赖（否则 `verify:system/init:s3` 无法运行）：
```powershell
pnpm install:web
```

在 `lawclick-next/` 下执行：
```powershell
cd lawclick-next
docker compose up -d
pnpm -C lawclick-next verify:system
pnpm -C lawclick-next init:s3
```

验证：
- MinIO Console：http://localhost:9001（默认账号来自 `docker-compose.yml`）
- Postgres 可连：`DATABASE_URL` 指向 `127.0.0.1:5434`

---

## 3. 数据库 Schema 与数据（严禁“脚本造数”）

### 3.1 应用迁移（必须）
```powershell
cd lawclick-next
pnpm exec prisma migrate deploy
pnpm prisma:validate
```

### 3.2 数据准备（两种路径）

**路径 A（推荐：生产对齐）**：导入“脱敏生产快照”
- 说明：`pnpm exec prisma db seed` 默认会拒绝运行（见 `lawclick-next/prisma/seed.js`）。
- 规范：见 `docs/脱敏生产快照_导入规范.md`（必须脱敏、严禁提交快照、导入后必须跑门禁）。
- 导入示例（推荐使用仓库脚本，避免误操作）：
```powershell
pnpm restore:snapshot -- --file <path-to-dump> --reset --yes
```

**路径 B（允许空库起步：靠系统真实写入产生数据）**
- 直接启动 Web → 访问 `/auth/register` 注册账号（会真实写入 DB），再登录使用。
- 注意：注册默认角色为 `LAWYER`；若要测试 `PARTNER/ADMIN` 专属功能，应使用路径 A（或在测试库中显式修改 role，并记录为“非生产对齐操作”）。

---

## 4. 启动 Web（主线）

从仓库根目录：
```powershell
pnpm install:web
pnpm dev
```

访问：http://localhost:3000  
> 若本机已有其他服务（尤其是 WSL/Docker 转发）占用 3000，`pnpm dev` 会自动改用 3010 等端口；请以终端输出的 `Local:` 地址为准。
冒烟检查（建议按顺序）：
1) 注册/登录 → `/dashboard` 可见  
2) 新建案件 → 案件详情页可进（含 tabs）  
3) 新建任务 → 分配 → 通知中心出现未读并可跳转定位  
4) 工时追踪：开始/停止后，列表可见记录  
5) 文档中心：上传→列表可见→下载可用（MinIO 中对象存在）  
6) 日程：创建事件→受邀人通知落库→范围查询可见  
7) AI：未配 `OPENAI_API_KEY` 时应显式报错；配置后返回真实结果

---

## 5. 启动 Rust API（原型，真实闭环）

建议在新的终端窗口（仓库根目录）：

### 5.1 复用 Web 的 `.env`（减少漂移）
```powershell
Get-Content lawclick-next/.env | ForEach-Object {
  if($_ -match '^(\\s*#|\\s*$)') { return }
  $k, $v = $_ -split '=', 2
  $env:$k = $v
}
$env:JWT_SECRET = (node -e "console.log(require('crypto').randomBytes(32).toString('hex'))")
cargo run --bin server
```

### 5.2 健康检查
```powershell
curl.exe http://localhost:8080/health
curl.exe http://localhost:8080/api/v1
```

### 5.3 鉴权联调（两条路）

**路 A：Rust 自签 Token**
- `POST /api/v1/auth/login` 获取 `accessToken` → 用 `Authorization: Bearer <token>` 调用其他接口。

**路 B：复用 NextAuth/Auth.js Session（推荐：统一鉴权）**
- 先在 Web 登录，然后从浏览器取 `authjs.session-token`（或 `__Secure-*`）Cookie。
- 调 Rust：携带 `Cookie: authjs.session-token=<token>`（支持 cookie chunking 自动拼接）。
- 例：`GET /api/v1/auth/me` 应返回 DB 真源用户信息（含 role/isActive 的最新状态）。

---

## 6. 质量门禁（建议每次实地测试都跑）

Web（仓库根目录）：
```powershell
pnpm lint
pnpm type-check
pnpm build
pnpm audit:routes
pnpm test
```

Rust（仓库根目录）：
```powershell
cargo check --all-targets
cargo test --all-targets
```

> 如需留痕，建议将输出重定向到 `docs/_artifacts/<date>/`（PowerShell 下可用 `cmd /c \"... > file 2>&1\"` 方式）。
