# TG12｜全仓挑刺（极限标准审计）｜2025-12-24

> 更新（2025-12-24）：已完成对应整改闭环与可复验日志，见 `docs/TG12_极限标准整改闭环_2025-12-24.md` 与 `docs/_artifacts/tg12_remediation_2025-12-24/`。本文保留为“审计快照”。

> 范围：`LawClick_NEW/` 全仓（含 `lawclick-next/` Web 主线、`docs/`、根目录 Rust 原型、`apps/mobile/`）。
>
> 方法：仅做静态审阅与结构/脚本扫描（未在本次审计中执行 `pnpm lint/type-check/build/test`、未启动 Docker/DB；原因：当前运行环境为只读沙盒 + 受限网络）。

## 0. 审计基准（必须对齐）

- `AGENTS.md`：**严禁 Mock / 空壳交付 / 强类型 / 显式错误处理 / 生产一致性 1:1**。
- `.agent/rules/lawclick.md`：**NO FRONTEND WITHOUT BACKEND**、MDI/可停靠窗口、禁止假数据、必须可回归验证。

## 1. 一句话结论（不客气版）

当前项目在“极限标准”下**最大的问题不是代码细节**，而是“工程可追溯性 + 主线可复现性”已经失守：  
`lawclick-next/` 处于“只有初始模板提交，其余大量文件未纳入版本控制”的状态；同时存在明确的 mock/shell 代码、关键鉴权拦截缺失（middleware 实际未启用）、以及测试/脚本与 pnpm 工作流不一致的问题。

## 2. P0（必须立即整改，否则不允许宣称 Production-Ready）

### P0-1｜版本控制形同虚设：Web 主线只有初始 commit，大量核心代码未纳入 Git

- 现象：`lawclick-next/` Git 仅 1 个初始提交，核心目录（`src/actions/`、`src/components/`、`prisma/`、`tests/`、`scripts/` 等）均处于 `??` 未跟踪状态。
- 影响：无法 code review、无法回滚、无法做 CI/CD、无法证明“生产对齐”，也无法对外协作。
- 证据：
  - `lawclick-next/.git/` 存在；但 `git log -1` 显示 `Initial commit from Create Next App`。
  - `git status --porcelain` 显示大量 `?? src/actions/ ... ?? prisma/ ... ?? tests/ ...`（详见终端输出）。
- 建议（最短闭环）：
  1. 先做一次**仓库收敛**：把应追踪的源码/配置全部纳入 Git；把临时产物全部加入 `.gitignore`。
  2. 明确“单仓”策略：根目录是否应为 Git 根？如果是，禁止嵌套 Git（或明确 submodule 规则）。

### P0-2｜鉴权拦截缺失：存在 middleware 备份但未启用，路由访问边界靠“自觉”

- 现象：
  - `lawclick-next/src/middleware.ts.bak` 存在，但实际 `lawclick-next/middleware.ts` 与 `lawclick-next/src/middleware.ts` 均不存在。
  - 另有 `lawclick-next/src/proxy.ts` 实现了 token 校验与 role 路由限制，但**未看到被 Next.js middleware 引用/挂载**。
- 影响：用户可能可直接访问受保护页面（至少 UI 层面），与“边界显式、权限强校验”冲突；E2E/回归可能在某些环境直接失真。
- 证据：
  - `lawclick-next/src/middleware.ts.bak`
  - `lawclick-next/src/proxy.ts`
- 建议：
  1. 明确唯一入口：要么恢复 `middleware.ts` 并在其中调用 `proxy()`；要么删掉 `proxy.ts`，统一用 `auth()` middleware。
  2. `canAccessPage()` 逻辑必须“默认拒绝”（见 P1-3），否则新增路由会自动放行。

### P0-3｜明确存在 Mock/Shell 代码（违反“严禁 Mock / 拒绝空壳交付”）

- 现象：`ConflictCheckWizard` 内置 `setTimeout` + 伪冲突匹配（包含 “Mock conflict search” 注释）。
- 影响：一旦该组件进入主线 UI（当前已从 `features/index.ts` 导出），将直接违背“无假数据/无空壳”，并误导业务流程（利益冲突审查属高风险环节）。
- 证据：
  - `lawclick-next/src/components/features/conflict-check-wizard.tsx`
  - `lawclick-next/src/components/features/index.ts`
- 建议：
  - 改为真实链路（Server Action → Prisma → `ConflictCheck` 表落库 → UI 渲染）。

## 3. P1（高风险/高概率踩雷）

### P1-1｜Playwright 使用 `npm run dev`：与 pnpm 工作流冲突，且可能导致 `package-lock.json`/依赖漂移

- 现象：`lawclick-next/playwright.config.ts` 的 `webServer.command` 是 `npm run dev -- -p ${PORT}`。
- 影响：与仓库主推的 `pnpm` 工作流不一致；容易生成/污染 `package-lock.json`、导致依赖解析不同步；CI 环境与本地行为不一致。
- 证据：`lawclick-next/playwright.config.ts`
- 建议：统一为 `pnpm dev -- -p ${PORT}`（或 `pnpm -C lawclick-next dev -- -p ...`，取决于执行目录）。

### P1-2｜Prisma 目录存在 `dev.db`（SQLite）残留：与 PostgreSQL 主线冲突，且可能携带脏数据/PII

- 现象：`lawclick-next/prisma/dev.db`、`dev.db-journal` 存在；但 `schema.prisma` datasource 为 PostgreSQL。
- 影响：真实开发数据可能被误放进仓库目录；误导新成员；破坏“生产一致性 1:1”。
- 证据：`lawclick-next/prisma/dev.db`、`lawclick-next/prisma/schema.prisma`
- 建议：清理 SQLite 残留并写入忽略规则；统一仅通过 Docker Postgres 运行。

### P1-3｜路由权限默认放行：`canAccessPage()` 未命中配置时返回 `true`

- 现象：`canAccessPage()` 未找到 path 配置直接 `return true`。
- 影响：新增页面/路径如果忘记登记，会对所有角色默认开放，属于“默认不安全”。
- 证据：`lawclick-next/src/lib/permissions.ts`
- 建议：改为默认拒绝（并强制在 route-audit/CI 中校验“所有 page.tsx 都在配置表中”）。

### P1-4｜密码重置与邮件存在安全硬伤：用户枚举 / token 明文 / HTML 注入

- 现象：
  - `requestPasswordReset()` 明确返回“邮箱未注册”（用户枚举）。
  - reset token 以明文写入 DB（DB 泄露即直接接管）。
  - `sendNotificationEmail()` 直接拼接 `title/content` 到 HTML（未转义），存在邮件 HTML 注入风险。
- 证据：
  - `lawclick-next/src/actions/auth.ts`
  - `lawclick-next/src/lib/email.ts`
- 建议：
  - 重置请求统一返回成功文案；token 改为 hash 存储 + 单次使用；邮件模板内容必须 escape。

### P1-5｜文件上传缺少“尺寸/类型/流式”边界：易被大文件打爆内存/成本失控

- 现象：上传直接 `Buffer.from(await file.arrayBuffer())`，未限制 `file.size`、未校验 `file.type` 白名单。
- 影响：DoS/成本/合规风险；与“防御性编程”冲突。
- 证据：`lawclick-next/src/actions/documents.ts`（`uploadDocument()`）
- 建议：限制大小（硬阈值 + 业务阈值）、类型白名单、优先流式上传（或 presigned URL）。

### P1-6｜AI 环境变量解析可能“必崩”：对 `process.env` 使用 Zod `.strict()`

- 现象：`OpenAIEnvSchema.strict()` + `schema.parse(process.env)`。
- 影响：一旦启用 AI 功能，`process.env` 里存在大量非 schema keys，会导致解析失败（严格模式拒绝未知字段）。
- 证据：`lawclick-next/src/lib/ai-provider.ts`、`lawclick-next/src/lib/server-env.ts`
- 建议：只 pick 需要的 env 字段再 parse，或改 `.passthrough()`。

### P1-7｜多租户设计不一致：schema 出现 `tenantId`，但代码侧未统一注入/过滤

- 现象：schema 中出现 `tenantId`（且默认 `default-tenant`），但 actions 查询/写入未见 tenant 维度；`getTenantId()` 直接返回常量。
- 影响：未来一旦引入多租户，极易出现跨租户数据泄露；当前字段存在“伪多租户”风险。
- 证据：
  - `lawclick-next/prisma/schema.prisma`（`tenantId`）
  - `lawclick-next/src/lib/server-auth.ts`（`getTenantId()`）
- 建议：要么彻底单租户并删除该字段，要么全链路强制 tenant 注入 + where 过滤 + 唯一键/索引对齐。

## 4. P2（中等技术债/可预期维护成本）

### P2-1｜队列处理为“手动/单条”模式：缺少 worker/并发锁/重试退避策略

- 现象：`TaskQueue` 通过 API `/api/queue/process` 手动触发，每次只 `processNext()` 一条。
- 影响：通知/邮件等异步任务延迟不可控；并发调用可能造成重复处理/竞态。
- 证据：`lawclick-next/src/lib/queue.ts`、`lawclick-next/src/app/api/queue/process/route.ts`
- 建议：引入独立 worker（或 cron 批处理）、加锁/幂等、失败重试与告警。

### P2-2｜`ensureBucketExists()` 失败后“永久失败”：失败 promise 被缓存

- 现象：`ensureBucketPromise` 缓存 reject 后不会重试。
- 影响：短暂故障会导致进程生命周期内永久不可用。
- 证据：`lawclick-next/src/lib/s3.ts`
- 建议：失败时清空缓存，允许下一次重试；同时记录可观测日志。

### P2-3｜文档字段命名语义混乱：`fileUrl` 实际存的是对象 key

- 现象：上传/下载路径里 `fileUrl` 用作 S3 key。
- 影响：后续接入 CDN/外链、权限签名时容易踩坑。
- 证据：`lawclick-next/src/actions/documents.ts`、`lawclick-next/src/app/api/documents/[id]/file/route.ts`
- 建议：拆分为 `fileKey` / `fileUrl`（或统一 key 命名）。

### P2-4｜大量可生成/临时产物驻留仓库目录，且缺少统一落盘策略

- 现象：`playwright-report/`、`test-results/`、`eslint-report.json`、`lint-results.json`、`build_*.txt` 等散落在 `lawclick-next/` 根目录。
- 影响：污染工作区、干扰提交、难以形成可追溯证据链（应统一落 `docs/_artifacts/`）。
- 证据：`lawclick-next/` 目录现状 & `git status` 大量 `??` 产物。
- 建议：制定“产物落盘规范”：运行脚本输出统一写入 `docs/_artifacts/<date>/`，并在 `.gitignore` 忽略本地临时文件。

## 5. P3（低优先级，但会持续消耗注意力）

### P3-1｜根目录 README/脚本与实际状态存在不一致

- 现象：README 提到的版本/文件（如 LICENSE）与仓库当前文件不完全对齐；根目录脚本包含 `dev:mobile` 但 `apps/mobile/` 仅有 `pubspec.yaml`。
- 影响：新同学上手成本升高；与“可执行交付”冲突。
- 建议：明确哪些是“主线可运行”，哪些是“占位/原型”，并在 README 顶部写清。

## 6. 建议整改顺序（Tracer Bullet：从可复现到可扩展）

1. **收敛版本控制**：确定 Git 根与提交策略 → 清理/忽略产物 → 首次落盘全量源码。
2. **恢复鉴权拦截**：补齐 middleware（或明确替代方案）→ 默认拒绝策略 → 路由审计纳入 gate。
3. **清零 Mock/Shell**：移除或打通 `ConflictCheckWizard` 真实链路（DB + Server Action + UI）。
4. **统一工具链**：Playwright/脚本全部改为 pnpm；去除 `package-lock.json` 等干扰。
5. **安全加固**：密码重置、邮件 escape、上传限制、队列幂等等。
6. **多租户策略定案**：要么删 tenantId，要么全链路强制 tenant 过滤。
