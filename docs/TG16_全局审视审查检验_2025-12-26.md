# TG16｜全局审视审查检验｜2025-12-26

> 目的：回答“是否所有问题都整改到位”，以 `AGENTS.md` 极高标准做一次可复验的全局审查，并把证据与未尽事项（按轻重缓急）落盘。
>
> 说明：本次审查以 `lawclick-next/`（Next.js App Router + Prisma）为主线；根目录 Rust/Flutter 原型不作为生产门禁主线。

---

## 1) 结论（严谨口径）

1. **以 TG14（P0-P3）与 TG15（P2/P3）文档定义为准：关键问题已闭环并可复验。**  
   - TG14 的 P3（长期体验与规模化）已补齐并在矩阵中落盘：`docs/TG14_功能真实闭环覆盖矩阵_2025-12-25.md:118`
   - 本次审查运行门禁与系统验证均通过（见证据目录）。
   - 补充（v4）：暗色模式与主题切换已真实落地（tokens + Provider + UI 落库），工具 Webhook 已改为 outbox+queue 并可回读，队列健康监控已升级为快照+告警闭环（见最新证据目录）。
   - 补充（2025-12-27 v5）：真多租户（`activeTenantId` + `TenantMembership/TenantInvite`）已落地并接入 Header/租户页；Event/TimeLog/协作邀请/文档下载等 tenant-scope 漏洞已修复；迁移与索引补齐并通过门禁（见 v5 证据目录）。
   - 补充（2025-12-27 v6）：修复协作邀请响应的“存在性泄露”缺口；文档版本下载查询收敛为 document-scope；看板多人协作“可感知”终态落地（TenantSignal + SSE + SignalBus + tenant/kind 共享 DB poll 兜底），并把 TASKS_CHANGED 信号纳入运维 KANBAN_HEALTH 快照（见 v6 证据目录）。
   - 补充（2025-12-28 v8）：补齐“真多租户终态”的残留边界漏洞（`User.tenantId` 与 `TenantMembership` 混用导致的成员筛选偏差）；看板 ordered board 关键查询索引补齐（Task 复合索引，降低大任务量下拖拽/分页查询延迟）；全量清理 Tailwind palette 硬编码（统一使用语义 tokens/tone，暗色/主题扩展稳定一致）；并完成 `migrate deploy` 与门禁全绿（见 v8 证据目录）。
   - 补充（2025-12-28 v11）：真多租户“防呆层”进一步升到 DB 访问层（Prisma `tenant-scope-guard`）：对所有含 `tenantId` 的模型默认强制 tenant scope；对 `findUnique/update/delete/upsert` 统一要求 `where` 含匹配 `tenantId`（避免跨租户误读/误写与存在性泄露）；并补齐关键写链路的 where 口径（审批/发票/邮件 outbox/队列超限失败处理/UploadIntent 幂等查重）。看板可观测性快照补齐 `reindexedTaskCount`；设计 tokens 进一步 DRY：Card/Button/Input/Select 统一绑定 `--lc-card-padding/--lc-stack-gap/--lc-control-height`，密度切换下排版一致（见 v11 证据目录）。
   - 补充（2025-12-28 v14）：修复 `tenant-scope-guard` 加严后在后台队列链路的真实失败（`TaskQueue.updateMany` 补齐显式 `tenantId` 过滤，避免无 request context 时抛错并卡住 PROCESSING 锁）；UploadIntent 清理入队增加自愈（PENDING 退避加速、PROCESSING 超时解锁），避免运维“手动触发”受历史卡锁阻塞；并适配 Next 16 `searchParams` 异步约束（消除运维页 issue overlay 干扰）。门禁全绿见 v14 证据目录。
   - 补充（2025-12-28 v15）：终态收口（真多租户可运营入口 + tenant-scope 覆盖证明脚本 + 看板协作增量自愈 + Sidebar tokens 收敛 + E2E 稳定性）已落地，门禁全绿见 v15 证据目录。

2. **以“全产品无限扩展/极致 DRY/全域多租户终态”为口径：仍存在下一阶段需要单开 TG 的架构演进点。**  
   - 典型：真多租户组织模型（Firm/User/Tenant + 全域约束 + 可选 RLS）、看板在超大任务量下的策略（分页/虚拟化/可观测性）、全域设计 tokens 的进一步统一（减少重复样式来源）。

---

## 2) 可复验证据（门禁 + 系统验证）

证据目录：`docs/_artifacts/tg16_audit_2025-12-26_v1/`

- 门禁（全绿）：  
  - `docs/_artifacts/tg16_audit_2025-12-26_v1/pnpm_lint.txt:1`  
  - `docs/_artifacts/tg16_audit_2025-12-26_v1/pnpm_typecheck.txt:1`  
  - `docs/_artifacts/tg16_audit_2025-12-26_v1/pnpm_build.txt:1`  
  - `docs/_artifacts/tg16_audit_2025-12-26_v1/pnpm_route_audit.txt:1`  
  - `docs/_artifacts/tg16_audit_2025-12-26_v1/pnpm_test.txt:1`

- 生产对齐验证：  
  - DB/MinIO 连通性：`docs/_artifacts/tg16_audit_2025-12-26_v1/pnpm_verify_system.txt:1`  
  - Prisma schema 合法：`docs/_artifacts/tg16_audit_2025-12-26_v1/pnpm_prisma_validate.txt:1`  
  - Prisma client 生成：`docs/_artifacts/tg16_audit_2025-12-26_v1/pnpm_prisma_generate.txt:1`

补充（2025-12-26，TG18）：看板规模化改造后门禁重跑（全绿）：`docs/_artifacts/tg18_kanban_virtual_2025-12-26_v2/`  
（`pnpm_lint.txt`、`pnpm_typecheck.txt`、`pnpm_build.txt`、`pnpm_route_audit.txt`、`pnpm_test.txt`）

补充（2025-12-26 v2）：极限标准后续强化（tokens 分层 + tenant/队列幂等 + 运维健康快照）门禁全绿：`docs/_artifacts/tg16_followup_2025-12-26_v2/`  
（`pnpm_lint.txt`、`pnpm_typecheck.txt`、`pnpm_build.txt`、`pnpm_route_audit.txt`、`pnpm_prisma_validate.txt`、`pnpm_prisma_generate.txt`、`pnpm_test.txt`）

补充（2025-12-27 v4）：暗色模式（tokens + ThemeProvider + UI 落库）+ 工具 Webhook outbox+queue + 队列健康快照/告警闭环 门禁全绿：`docs/_artifacts/tg16_followup_2025-12-27_v4/`  
（`pnpm_lint.txt`、`pnpm_typecheck.txt`、`pnpm_build.txt`、`pnpm_route_audit.txt`、`pnpm_prisma_validate.txt`、`pnpm_prisma_generate.txt`、`pnpm_test.txt`）

补充（2025-12-27 v5）：真多租户终态推进（tenant 切换 + 全域关键点 tenant-scope + 迁移修复 + case-scoped 索引）门禁全绿：`docs/_artifacts/tg16_followup_2025-12-27_v5/`  
（`pnpm_lint.txt`、`pnpm_typecheck.txt`、`pnpm_build.txt`、`pnpm_route_audit.txt`、`pnpm_prisma_validate.txt`、`pnpm_prisma_generate.txt`、`pnpm_test.txt`、`pnpm_verify_system.txt`、`prisma_migrate_deploy.txt`）

补充（2025-12-27 v6）：TenantSignal 实时协作提示（SSE+SignalBus+共享poll）+ 运维快照增加实时信号指标 + 设计 tokens 新增“权威蓝灰”强调色 门禁全绿：`docs/_artifacts/tg16_followup_2025-12-27_v6/`  
（`pnpm_lint.txt`、`pnpm_typecheck.txt`、`pnpm_build.txt`、`pnpm_route_audit.txt`、`pnpm_prisma_validate.txt`、`pnpm_prisma_generate.txt`、`prisma_migrate_deploy.txt`、`pnpm_test.txt`）

补充（2025-12-28 v8）：真多租户边界回归 + 看板索引补齐 + tokens 收敛 + 门禁与 migrate deploy 全绿：`docs/_artifacts/tg16_followup_2025-12-28_v8/`  
（`pnpm_lint.txt`、`pnpm_typecheck.txt`、`pnpm_build.txt`、`pnpm_route_audit.txt`、`pnpm_prisma_validate.txt`、`pnpm_prisma_generate.txt`、`pnpm_verify_system.txt`、`prisma_migrate_deploy.txt`、`prisma_migrate_status.txt`、`pnpm_test.txt`）

补充（2025-12-28 v11）：真多租户防呆层 + 看板可观测性补齐 + 设计 tokens DRY 门禁全绿 + 生产对齐验证：`docs/_artifacts/tg16_followup_2025-12-28_v11/`  
（`pnpm_lint.txt`、`pnpm_typecheck.txt`、`pnpm_build.txt`、`pnpm_route_audit.txt`、`pnpm_prisma_validate.txt`、`pnpm_prisma_generate.txt`、`prisma_migrate_deploy.txt`、`prisma_migrate_status.txt`、`pnpm_verify_system.txt`、`pnpm_test.txt`）

补充（2025-12-28 v14）：队列链路 tenant 强约束回归修复 + UploadIntent 清理任务自愈（运维可用性）+ Next 16 运维页 searchParams 异步适配 门禁全绿：`docs/_artifacts/tg16_followup_2025-12-28_v14/`  
（`pnpm_lint.txt`、`pnpm_typecheck.txt`、`pnpm_build.txt`、`pnpm_route_audit.txt`、`pnpm_prisma_validate.txt`、`pnpm_prisma_generate.txt`、`pnpm_test.txt`）

补充（2025-12-28 v15）：终态收口（Firm 可运营入口 + tenant-scope 覆盖证明脚本 + 看板协作增量同步 + Sidebar tokens 收敛 + E2E 稳定性）门禁全绿：`docs/_artifacts/tg16_followup_2025-12-28_v15/`  
（`pnpm_lint.txt`、`pnpm_typecheck.txt`、`pnpm_build.txt`、`pnpm_route_audit.txt`、`pnpm_prisma_validate.txt`、`pnpm_prisma_generate.txt`、`pnpm_audit_tenant_scope.txt`、`pnpm_test.txt`）

---

## 3) 关键审查项与结果（挑刺式）

### 3.1 设计语言与性能（motion/a11y）

- ✅ 已消除“全局 `transition: all`”类风险，避免无意触发布局属性过渡。  
  - 全量扫描结果为空：`docs/_artifacts/tg16_audit_2025-12-26_v1/rg_transition_all_after_fix.txt:1`
- ✅ `focus-visible / ::selection / prefers-reduced-motion` 具备可访问性基线：`lawclick-next/src/app/globals.css:1`
- ✅ tokens 与样式来源进一步收敛为分层结构（减少重复与无效 CSS）：`lawclick-next/src/styles/theme.css:1`、`lawclick-next/src/styles/animations.css:1`、`lawclick-next/src/styles/components.css:1`、`lawclick-next/src/styles/utilities.css:1`
- ✅ 设计 tokens DRY：核心 UI 组件统一绑定 CSS variables（`--lc-card-padding/--lc-stack-gap/--lc-control-height`），确保 density 切换下排版/控件高度一致：`lawclick-next/src/app/globals.css:1`、`lawclick-next/src/components/ui/card.tsx:1`、`lawclick-next/src/components/ui/button.tsx:1`、`lawclick-next/src/components/ui/input.tsx:1`、`lawclick-next/src/components/ui/select.tsx:1`
- ✅ 暗色模式与主题切换（REAL，不是“看起来支持”）：
  - `.dark` tokens 覆盖（对齐 `docs/LegalMind设计语言规范.md`）：`lawclick-next/src/app/globals.css:1`
  - ThemeProvider（`attribute="class"`）接入：`lawclick-next/src/components/providers/session-provider.tsx:1`
  - 主题选择落库到 `UserSetting(key=ui:app)` 并由 `UiPreferencesProvider` 驱动 `setTheme()`：`lawclick-next/src/lib/ui/app-preferences.ts:1`、`lawclick-next/src/components/layout/ui-preferences-provider.tsx:1`
  - Header 提供 system/light/dark 切换入口：`lawclick-next/src/components/layout/app-header.tsx:1`
  - 核心页面/组件去除 `bg-white` 等硬编码，统一改为语义 tokens（`bg-card/bg-popover`）确保暗色模式全局一致（见 v4 门禁目录）。

### 3.2 禁 Mock / 禁空壳（真实性）

- ✅ `verify:system` 真实连通 DB 与 MinIO（非假环境）：`docs/_artifacts/tg16_audit_2025-12-26_v1/pnpm_verify_system.txt:1`
- ✅ 源码关键字扫描未发现“TODO/FIXME/coming soon/暂未开放”等明显空壳提示（注意：UI `placeholder="..."` 属正常输入占位文案，不属于 Mock）：`docs/_artifacts/tg16_audit_2025-12-26_v1/rg_mock_shell_keywords_src.txt:1`
- ✅ 未发现 `any`/`as any` 典型弱类型痕迹（按 grep 规则）：`docs/_artifacts/tg16_audit_2025-12-26_v1/rg_any_usage_src.txt:1`

补充说明：
- 上传链路中 `arrayBuffer()` 仅作为 Node 环境不支持 `Readable.fromWeb()` 的兜底，不是主路径：`docs/_artifacts/tg16_audit_2025-12-26_v1/rg_arraybuffer_usage_src.txt:1`
- `Math.random()` 出现在队列退避 jitter（治理策略），非模拟业务数据：`docs/_artifacts/tg16_audit_2025-12-26_v1/rg_suspicious_fake_data_src.txt:1`

### 3.3 30-300 人规模（虚拟列表/分片加载）

- ✅ 任务中心：分页 + 虚拟列表 + 触底加载，服务端权限/tenant 过滤（真实闭环）：`lawclick-next/src/app/(dashboard)/tasks/page.tsx:1`、`lawclick-next/src/actions/tasks-crud.ts:1`
- ✅ 项目中心：分页 + 虚拟列表 + 触底加载（真实闭环）：`lawclick-next/src/app/(dashboard)/projects/page.tsx:1`、`lawclick-next/src/components/projects/ProjectsListClient.tsx:1`、`lawclick-next/src/actions/projects-crud.ts:1`
- ✅ 看板自身规模化（按列分页 + 列虚拟化）：覆盖任务中心 / 项目任务 / 案件任务 Tab（无静默截断）：`docs/TG18_看板虚拟列表与分列分页_2025-12-26.md:1`

### 3.4 项目主线连通性（项目→任务→看板→任务中心）

- ✅ 项目详情页任务模块：看板（默认）+ 列表（规模化）双模式；新增项目内“新建任务”入口（真实创建并可回读到任务中心）：  
  - `lawclick-next/src/app/(dashboard)/projects/[id]/page.tsx:1`  
  - `lawclick-next/src/components/projects/ProjectTasksPanelClient.tsx:1`  
  - 端到端 E2E 验证：`docs/_artifacts/tg16_audit_2025-12-26_v1/pnpm_test.txt:1`

### 3.5 后台运行机制（队列健康 + 外部副作用 outbox）

- ✅ 队列健康监控“可运营化”：持久化快照 + 告警（ack/snooze/resolve）+ 运维手动触发：`lawclick-next/src/app/(dashboard)/admin/ops/queue/page.tsx:1`、`lawclick-next/src/actions/ops-queue-monitoring.ts:1`
- ✅ 工具 Webhook 外部副作用：触发侧 outbox 入队、执行侧重试退避、调用记录可回读：`lawclick-next/src/actions/tool-actions.ts:1`、`lawclick-next/src/lib/job-handlers.ts:1`、`lawclick-next/src/app/(dashboard)/tools/page.tsx:1`

---

## 4) 终态收口（v15：已完成）

> 口径：以“真实链路 + 可复验门禁 + 可运营入口 + 不留跨租户/空壳风险”为标准，将原“建议单开 TG 的更高阶点”收口到可交付终态；超出当前阶段边界的项，仅作为可选演进列出。

1. **真多租户终态（应用层 + 覆盖证明）**：Firm/User/Tenant 的组织关系具备可运营入口，tenant scope 覆盖具备可复验的自动审计（并与 Prisma `tenant-scope-guard` 一致性断言），主线 E2E 证明跨租户数据不可见/不可访问。
   - 证据：`docs/_artifacts/tg16_followup_2025-12-28_v15/pnpm_audit_tenant_scope.txt:1`、`docs/_artifacts/tg16_followup_2025-12-28_v15/pnpm_test.txt:1`
2. **看板规模化终态体验/可观测性**：TG18（列分页 + 列虚拟化 + ordered board DnD）基础上，协作层从“提示刷新”升级为“增量自愈同步”（TenantSignal SSE → taskId delta fetch → upsert/remove），并在详情编辑态暂停同步避免抖动。
   - 证据：`docs/_artifacts/tg16_followup_2025-12-28_v15/pnpm_test.txt:1`
3. **设计 tokens 终态（DRY + 主题扩展）**：继续收敛 tokens 权威来源，补齐 Sidebar 语义 tokens 与字体栈，确保暗色/主题/密度切换下组件一致。
   - 证据：`docs/_artifacts/tg16_followup_2025-12-28_v15/pnpm_build.txt:1`

### 4.1 可选下一阶段（不阻塞现阶段门禁）

- DB 级 RLS（若需要在数据库层进一步硬隔离）
- 高对比/多品牌 tokens 全域补齐（UI 主题矩阵扩展）
- 更细粒度看板性能指标（列加载耗时、SSE 延迟 P50/P95、错误率阈值告警策略）

---

## 5) 与 TG14/TG15 的关系回写

- TG14 P3 补齐已回写：`docs/TG14_功能真实闭环覆盖矩阵_2025-12-25.md:118`
- TG15 后台运行机制与运维入口保持不变，本次仅做“全局审查 + 证据补齐”。
- TG15 v4 已追加“工具 Webhook outbox + 队列健康告警闭环”说明：`docs/TG15_后台运行机制_队列与上传_2025-12-25.md:1`
- TG18 看板规模化升级已新增 TG 文档与门禁证据：`docs/TG18_看板虚拟列表与分列分页_2025-12-26.md:1`
- 本轮（v15）终态收口与门禁证据已落盘：`docs/_artifacts/tg16_followup_2025-12-28_v15/`
