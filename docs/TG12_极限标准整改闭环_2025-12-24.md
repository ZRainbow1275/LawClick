# TG12「极限标准整改闭环」（2025-12-24）

> 目标：在不引入 Mock/空壳/假数据的前提下，将 `lawclick-next/` 的关键链路改为 **真实端到端闭环**（UI → Server Actions → Prisma → DB/S3/Queue），并提供可复验证据。
>
> 说明：按指令 **忽略版本控制问题**（不讨论 git 追踪/提交）。

---

## 1. 本轮结论（简版）

- 关键断裂点已修复：`DocumentTemplate` DB 驱动模板起草、模板管理后台、密码重置闭环、S3 失败可重试、上传大小/类型限制、Playwright webServer 启动修正。
- 质量门禁可复验：`lint/type-check/build/test + audit:routes` 全部通过（证据见 `docs/_artifacts/tg12_remediation_2025-12-24/`）。

---

## 2. 整改项（按执行顺序）

### 2.1 路由边界：默认拒绝 + 中间层统一拦截

- `lawclick-next/src/lib/permissions.ts`：`canAccessPage()` 默认拒绝（未命中配置返回 `false`），补齐 `/research`、`/settings` 配置。
- `lawclick-next/src/proxy.ts`：按 `next-auth/jwt getToken()` 做登录态与角色路由访问控制；未登录统一跳转 `/auth/login`，未授权跳转到角色 home。
- 补充（2025-12-25）：新增 `lawclick-next/middleware.ts` 挂载 `proxy()`，使上述拦截在运行时真实生效（证据见 `docs/_artifacts/tg14_remediation_2025-12-25/`）。

### 2.2 清零 Mock：ConflictCheckWizard

- `lawclick-next/src/components/features/conflict-check-wizard.tsx`：移除 `setTimeout`/伪匹配逻辑，改为直接走真实案件创建链路（落库 `ConflictCheck`）。

### 2.3 模板起草：从硬编码改为 DB 驱动（全链路）

- Prisma 新增：`lawclick-next/prisma/schema.prisma` 增加 `DocumentTemplate`。
- Actions 新增/增强：
  - `lawclick-next/src/actions/document-templates.ts`：模板列表/创建/更新 + 占位符引用校验 + 编辑详情拉取。
  - `lawclick-next/src/actions/documents.ts`：`generateDocument()` 改为按 `templateCode` 读取 DB 模板并校验变量/占位符后生成草稿。
- UI 调整：
  - `lawclick-next/src/components/cases/new-draft-dialog.tsx`：模板下拉来自 DB（Server Action），并按变量定义渲染输入项。
  - 新增后台页 `/admin/document-templates`：
    - `lawclick-next/src/app/(dashboard)/admin/document-templates/page.tsx`
    - `lawclick-next/src/components/admin/DocumentTemplatesClient.tsx`
  - `lawclick-next/src/config/navigation.ts`：补齐「行政中心 → 文书模板」入口。
  - `lawclick-next/src/lib/permissions.ts`：为 `ADMIN` 增加 `document:template_manage`。

### 2.4 工具链：Playwright webServer 统一到 pnpm/next

- `lawclick-next/playwright.config.ts`：`webServer.command` 改为 `pnpm exec next dev -p ${PORT}`，修复 Windows 下 `--` 参数被当作目录的问题。

### 2.5 安全与稳定性：密码重置、邮件、S3、上传

- 密码重置闭环修复（避免用户枚举 + token 哈希存储）：
  - Prisma 新增：`PasswordResetToken`（并与 `User` 建立关系）。
  - `lawclick-next/src/actions/auth.ts`：`requestPasswordReset()` 统一返回成功文案（不暴露邮箱是否存在）；token `sha256` 哈希存储；`resetPassword()` 一次性令牌 + 事务更新。
  - `lawclick-next/src/app/(auth)/auth/reset-password/page.tsx` + `ResetPasswordClient.tsx`：同一路由同时支持「申请重置」与「设置新密码」。
- 邮件 HTML 注入防护：
  - `lawclick-next/src/lib/email.ts`：对 title/content/url 做 HTML 转义；actionUrl 仅允许合法绝对 URL（非法则降级为无链接）。
- S3 稳定性：
  - `lawclick-next/src/lib/s3.ts`：`ensureBucketExists()` 失败后清空缓存 promise，允许后续重试。
- 上传安全：
  - `lawclick-next/src/actions/documents.ts`：增加上传大小上限（25MB）与 MIME 白名单（PDF/DOC/DOCX/TXT），并对空文件/未知类型拒绝。

---

## 3. 可复验证据（忠实落盘）

证据目录：`docs/_artifacts/tg12_remediation_2025-12-24/`

- `pnpm_lint.txt`
- `pnpm_typecheck.txt`
- `pnpm_build.txt`
- `pnpm_test.txt`
- `pnpm_route_audit.txt`
- `prisma_migrate_status.txt`
- `docker_ps.txt`

---

## 4. 仍需后续定案/治理（不在本轮强行扩张）

> 这些项属于架构级决策或更大规模重构，建议单独开 TG，避免“改一处崩一片”。

1. **多租户策略**：目前仅 `Case.tenantId` 存在但未全链路注入/过滤；需明确「删字段（单租户）」或「全链路 where/写入 tenant」。
2. **队列幂等与并发锁**：`queue.processNext()` 仍是单条扫描+更新模式，需事务锁/抢占策略与重试退避。
3. **上传流式化/预签名**：当前为限制大小的 server-side putObject；若要大文件与更强隔离，应改为 presigned URL + 客户端直传。
