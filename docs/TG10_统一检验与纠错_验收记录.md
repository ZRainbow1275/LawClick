# TG10 统一检验与纠错（全链路回归 + 残留 mock/空壳清理）验收记录

## 文档信息
- 日期：2025-12-14
- 主工程：`lawclick-next/`
- 对齐约束：`prompt/1211架构设计.md`、`.agent/rules/lawclick.md`
- 子计划：`docs/TG10_统一检验与纠错_子计划.md`

---

## 1. 本 TG 完成内容（变更摘要）

### 1.1 Header：真实登录态 & 退出登录统一
- `lawclick-next/src/components/layout/app-header.tsx`
  - 移除 `mockUser/mockProfile`，改为 `next-auth/react` 的 `useSession` 读取真实会话用户；
  - 退出登录改为 `signOut({ callbackUrl: "/auth/login" })`，并清理本地持久化（浮窗/计时/状态 store）。
- 清理遗留 mock：
  - 删除 `lawclick-next/src/lib/mock-data.ts`
  - `lawclick-next/src/store/index.ts` 默认用户改为 `null`（避免误用 mock）
- `lawclick-next/src/components/layout/header-components.tsx`
  - 通知面板不再展示 mock 通知；
  - 性能面板不再展示伪造 CPU/Latency，改为浏览器侧可获取信息（JS heap/运行时间/CPU 核心数）。

### 1.2 仪表盘新建案件入口：从 mock → 真实创建闭环
- `lawclick-next/src/components/features/new-case-wizard.tsx`
  - 将 Dashboard 的 `NewCaseWizard` 改为对真实 `CreateCaseWizard` 的封装（统一走 `createCase` 落库）。

### 1.3 消息沟通（Chat）：从 mock → DB 驱动闭环
- Prisma（Schema + Migration）：
  - `lawclick-next/prisma/schema.prisma` 新增：`ChatThread / ChatParticipant / ChatMessage` + enums（TEAM/CASE/DIRECT）
  - `lawclick-next/prisma/migrations/20251214170000_tg10_chat/migration.sql`
- Server Actions：
  - `lawclick-next/src/actions/chat-actions.ts`
    - TEAM/CASE/DIRECT 会话 get-or-create
    - 会话列表（含未读数、最后消息）
    - 消息拉取与发送（后端权限强制）
- UI：
  - `/chat` 页面：`lawclick-next/src/app/(dashboard)/chat/page.tsx`（server）+ `lawclick-next/src/components/chat/ChatPageClient.tsx`（client）
  - 浮窗聊天：`lawclick-next/src/components/floating/floating-chat.tsx`（DB 驱动，不再 mock）
  - 浮窗层传参：`lawclick-next/src/components/layout/floating-layer.tsx`（CHAT 传入 `window.data`）
  - 案件详情联动入口：`lawclick-next/src/components/cases/CaseDetailClient.tsx` 新增「聊天」按钮（打开带 `caseId` 上下文的浮窗）
- 与案件业务流联动（确保“以案件为核心”）：
  - `lawclick-next/src/actions/cases-crud.ts`：创建案件时自动创建 `CASE:{caseId}` 群聊并加入参与人；
  - `lawclick-next/src/actions/members.ts`：案件成员增删同步 chat participant；
  - `lawclick-next/src/actions/collaboration-actions.ts`：接受案件邀请后同步 chat participant。
- Seed：
  - 主线禁止 synthetic seed；当前 `prisma db seed` 为守门硬失败（防止假闭环）。聊天/案件等数据由真实链路写入或脱敏快照提供。

---

## 2. 构建与验证结果
- 构建：`pnpm -C lawclick-next build` ✅ 通过
  - 说明：Next.js 在构建阶段对部分动态页面做静态尝试，会打印 “Dynamic server usage” 提示，但最终路由被标记为 `ƒ`（动态渲染），不影响构建产物。

---

## 3. DB 迁移/真源数据（你本地 Docker/DB 可用后必做）
在 `lawclick-next/` 下执行：
1. `pnpm exec prisma migrate deploy`
2. 导入脱敏生产快照：`pnpm -C lawclick-next restore:snapshot -- --file <path-to-dump> --reset --yes`

> 说明：自 2025-12-19 “极限标准”起，`pnpm exec prisma db seed` 默认会拒绝 synthetic 造数，用于防止假闭环。

---

## 4. 手工验收脚本（建议按顺序）
1. 登录任意内部账号进入 `/dashboard`（账号取决于脱敏快照内容；也可先在 `/auth/register` 注册）：
   - Header 展示真实用户（name/email/role）；
   - 点击「新建案件」→ 完成创建 → 自动跳转 `/cases/[id]`；
2. 进入 `/chat`：
   - 能看到「团队群聊」与若干「案件群聊」；
   - 发送消息后刷新页面仍存在；
3. 进入任意案件详情 `/cases/[id]`：
   - 点击「聊天」打开浮窗；
   - 在浮窗发送消息后 `/chat` 中可回放。

---

## 5. 已知限制与下一步建议
- Header 的“全局搜索/通知”目前已去除伪数据展示，但仍未形成完整后端闭环；建议下一 TG 实现：
  - 全局搜索（Case/Task/Document/Contact 聚合搜索）
  - 通知落库（至少覆盖：案件分配/任务分配/新消息提醒）
