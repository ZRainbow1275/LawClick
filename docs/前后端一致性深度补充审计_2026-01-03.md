# LawClick 前后端一致性深度补充审计（行为级）

> **审查类型**：批判性补充审计（从“静态引用覆盖”升级为“行为级闭环可达性”）  
> **审查范围**：`lawclick-next/`  
> **审查日期**：2026-01-03  
> **核心原则**：不接受“Action 已被调用/被引用”就算完成；必须验证 **UI 行为与 DB 结果一致**，且用户不会停留在“已删除对象的详情页”这种假象状态。

---

## 一、为何需要本补充审计

现有自动化静态门禁（如 actions↔UI 调用覆盖、禁用按钮扫描、限流覆盖等）已能捕获大量“缺入口/伪覆盖”问题，但它们无法识别如下类型的缺陷：

- Action 执行成功、DB 已变化，但 UI 没有正确跳转/刷新，导致用户仍停留在旧页面（看起来像没删掉/或后续变 404）。
- UI 逻辑存在“跳转被吞/被阻断”的场景（例如 router 导航在某些交互栈下不生效）。

这种问题在“前后端一致性”视角里属于 **高危体验缺陷**：用户会以为系统不可信、删除无效，且难以追踪真实状态。

---

## 二、本轮新增发现（真实缺陷）

### 2.1 文档删除：DB 已删除但页面仍停留在 `/documents/:id`

**现象**：

- 在文档详情页点击“删除 → 输入确认信息 → 确认删除”后：
  - DB 中该 `Document` 已被删除（硬删除）
  - 但浏览器仍停留在 `http://.../documents/:id`，页面继续展示旧数据（直到刷新才变 404/或用户自行返回）

**风险**：

- 用户以为删除失败（但实际上删除已成功）
- 后续操作（如编辑/上传版本）会触发“文档不存在”的错觉性错误

### 2.2 案件删除：DB 已软删除但页面仍停留在 `/cases/:id?tab=settings`

**现象**：

- 在案件设置页执行“删除案件”后：
  - DB 中 `Case.deletedAt` 已设置（软删除成功）
  - 但页面未跳转回 `/cases`，仍停留在已删除案件的设置页

---

## 三、证据（可复现）

新增行为级 E2E 覆盖，保证“UI→Actions→DB”闭环且可回归：

- `lawclick-next/tests/e2e/deletion-flows.spec.ts`
  - 验证：文档硬删除后回到 `/documents` 且列表不可见；案件软删除后回到 `/cases` 且列表不可见
  - 同时用 Prisma 直查 DB 断言：
    - `Document` 记录为 `null`
    - `Case.deletedAt` 非空

为保证测试稳定性并贴近真实租户权限模型，补齐 E2E 辅助能力：

- `lawclick-next/tests/e2e/e2e-helpers.ts`
  - `getUserTenantIdByEmail`：取用户当前租户
  - `addUserToTenantByEmail`：把指定用户加入目标租户（满足 `getLawyersForSelect` 的租户成员筛选）

---

## 四、修复落地（已完成）

### 4.1 删除后跳转从 `router.push` 改为强一致的硬跳转

为了确保删除后 **一定** 离开已删除对象页面（不依赖客户端路由在复杂交互栈下的稳定性）：

- 文档详情删除成功后：`window.location.assign("/documents")`
  - `lawclick-next/src/components/documents/DocumentDetailClient.tsx`
- 案件设置删除成功后：`window.location.assign("/cases")`
  - `lawclick-next/src/components/cases/CaseSettingsTab.tsx`
- 项目设置删除成功后：`window.location.assign("/projects")`
  - `lawclick-next/src/components/projects/ProjectSettingsPanelClient.tsx`
- 客户删除成功后：`window.location.assign("/crm/customers")`
  - `lawclick-next/src/components/crm/CustomerDeleteButton.tsx`
- 合同详情删除成功后：`window.location.assign(caseId ? "/cases/:id" : "/admin/finance")`
  - `lawclick-next/src/components/finance/ContractDetailClient.tsx`

---

## 五、回归结论

- `pnpm -C lawclick-next type-check`：✅ 通过  
- `pnpm -C lawclick-next lint`：✅ 通过  
- `pnpm -C lawclick-next exec playwright test tests/e2e/deletion-flows.spec.ts --reporter=line`：✅ 通过

---

## 六、下一步（继续挑刺）

建议继续用同样的“行为级”方法抽样验证：

1. 回收站恢复：恢复成功后列表与详情状态是否一致（避免“恢复成功但 UI 仍旧过滤”）
2. 文档版本上传：上传成功后版本列表是否即时更新（避免 DB 已有版本但 UI 仍显示 0）
3. 批量删除/批量归档：列表页批量操作完成后是否一致刷新与可恢复（避免“操作成功但 UI 不同步”）
