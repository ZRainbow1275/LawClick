# TG15「后台运行机制」闭环：队列可靠性 + 上传流式化 + tenant 预备（2025-12-25）

> 目标：落实 `docs/TG14_功能真实闭环覆盖矩阵_2025-12-25.md` 的 P2（后台操作机制）优先项，消灭“生产跑起来就会出事”的基础设施缺口：
> - 队列：并发锁、重试退避、任务可控处理；
> - 上传：避免 `arrayBuffer()` 全量入内存；
> - tenant：从“伪多租户字段”升级为“可平滑扩展的强约束入口”（即使当前仍为默认 tenant）。
>
> 约束：不引入 mock/空壳/假数据；所有改造必须是可运行的真实链路。

> 2025-12-26 补充：补齐 TG15 的 P2/P3 关键缺口（**上传意图审计 + 孤儿对象回收 + 运维入口**），并将队列手动执行能力升级为 **tenant/type 过滤**（避免被无关任务“饿死”）。
>
> 2025-12-26（v2）补充：继续落地 TG15 的 P2/P3 “队列幂等深化 + 容量与治理”——默认启用 **balanced 执行策略（维护优先 + 邮件限流）**，并为 `SEND_EMAIL` 引入 **EmailDelivery outbox（DB 幂等 + messageId/lastError 可追踪）**；同时补齐 `/admin/ops/queue` 的 **类型概览 + 按 type 精确执行** 与回读信息密度。
>
> 2025-12-26（v3）补充：将 `TaskQueue.idempotencyKey` 从“全局唯一”升级为 **tenant-scoped**（避免跨租户去重冲突），并为 `/admin/ops/queue` 增加 **队列健康快照 + tenant 提示**（证据：`docs/_artifacts/tg16_followup_2025-12-26_v2/`）。
>
> 2025-12-27（v4）补充：补齐“外部副作用”执行链路（工具 Webhook 改为 outbox+queue 并可回读），并将队列观测升级为 **健康快照 + 持久化告警（ack/snooze/resolve）** 运维闭环；同时修复迁移脚本兼容性（Postgres 不支持 `ADD CONSTRAINT IF NOT EXISTS`）导致的 deploy 阻塞（证据：`docs/_artifacts/tg16_followup_2025-12-27_v4/`）。
>
> 2025-12-28（v14）补充：修复 `tenant-scope-guard` 加严后队列处理链路的真实失败（`TaskQueue.updateMany` 显式补齐 `tenantId` 过滤，避免无 request context 时抛错并遗留 PROCESSING 卡锁）；并为 UploadIntent 清理任务入队增加自愈（PENDING 退避加速、PROCESSING 超时解锁），确保 `/admin/ops/uploads` 的“入队+立即执行”在历史遗留卡锁场景仍可用（证据：`docs/_artifacts/tg16_followup_2025-12-28_v14/`）。

---

## 1) 本轮结论（简版）

- **队列从“扫描+更新”升级为“可并发安全抢占+重试退避”**，支持批处理触发，避免重复处理/竞态。
- **文档上传从“全量 Buffer 入内存”升级为“流式上传”**（在现有 25MB 上限下仍显著降低内存峰值）。
- **tenant 预备从“字段存在但无约束”升级为“服务端强约束入口”**：案件可见性与案件创建已注入 tenant 维度，未来切换真实 tenantId 时不会“默认全局放行”。
- **上传一致性深化为“可追溯 + 可回收”**：新增 `UploadIntent` 审计与 `CLEANUP_UPLOAD_INTENTS` 队列回收任务，并提供 `/admin/ops/uploads` 运维入口可手动触发与回读结果。

---

## 2) 队列（后台任务）可靠性闭环

### 2.1 DB Schema（TaskQueue 增强）

- `lawclick-next/prisma/schema.prisma:1257`：`TaskQueue` 新增
  - `availableAt`（下一次可执行时间）
  - `lockedAt/lockedBy`（抢占锁）
  - `priority`（优先级）
  - `maxAttempts/lastError`（重试上限与错误）
  - `idempotencyKey`（可选去重键，tenant-scoped：`@@unique([tenantId, idempotencyKey])`）
- 迁移：`lawclick-next/prisma/migrations/20251225111000_tg15_queue_reliability/migration.sql:1`
  - 补充迁移：`lawclick-next/prisma/migrations/20251226190000_tg16_taskqueue_idempotency_per_tenant/migration.sql:1`

### 2.2 并发安全抢占（避免重复处理）

- `lawclick-next/src/lib/queue.ts:1`：使用 `UPDATE ... WHERE id = (SELECT ... FOR UPDATE SKIP LOCKED LIMIT 1) RETURNING *` 抢占任务。
- 处理完成/失败更新使用 `updateMany(where: { id, lockedBy, status: PROCESSING })`，避免“锁丢失/被回收”时误写状态。

### 2.3 重试退避（避免失败风暴）

- `lawclick-next/src/lib/queue.ts:1`：失败后若未达 `maxAttempts`：
  - 任务回到 `PENDING`
  - `availableAt` 写入指数退避 + 抖动（jitter）
  - 达到上限才标记 `FAILED`

### 2.4 批处理触发（Cron/运维友好）

- `lawclick-next/src/app/api/queue/process/route.ts:1`：支持 `?max=...&budgetMs=...` 批处理运行（默认 1 个，最大 50 个，时间预算默认 20s）。
- 补充（运维级精确执行）：支持 `?type=...`（按任务类型过滤）与（仅 secret 模式）`?tenantId=...`，且 **非 secret 模式默认按登录用户 tenant 过滤**。

### 2.5 容量与治理（balanced 策略 + 外部副作用幂等）

- **默认执行策略升级为 balanced（避免被高吞吐任务“饿死”）**：
  - `lawclick-next/src/lib/queue.ts:1`：新增 `excludeTypes` 与 `processBalancedBatch()`（维护任务优先、`SEND_EMAIL` 限流）。
  - `lawclick-next/src/app/api/queue/process/route.ts:1`：无 `type` 时默认走 `mode=balanced`；支持 `mode=legacy` 回退；可通过 `emailMax/cleanupMax/auditMax` 覆盖限流策略（严格参数校验）。
- **队列生产侧统一默认 priority（避免“重要运维任务排队靠后”）**：
  - `lawclick-next/src/lib/queue-policy.ts:1`：集中定义 `QUEUE_TASK_PRIORITY` 与默认限流策略。
  - `lawclick-next/src/lib/notifications.ts:1`：`SEND_EMAIL` 默认低优先级（不抢占运维）。
  - `lawclick-next/src/actions/upload-intents.ts:1`：`CLEANUP_UPLOAD_INTENTS` 默认高优先级（保证可回收）。
- **邮件幂等深化（发送后崩溃→重试不重复发，且可观测）**：
  - Prisma：`lawclick-next/prisma/schema.prisma`（`EmailDelivery` + `EmailDeliveryStatus`），迁移：`lawclick-next/prisma/migrations/20251226120000_tg15_email_delivery_outbox/`
  - 实现：`lawclick-next/src/lib/email-delivery.ts`（payloadHash 校验 + 幂等短路 + 状态机落库）、`lawclick-next/src/lib/job-handlers.ts`（`SEND_EMAIL` handler 接入 outbox）
  - 辅助：`lawclick-next/src/lib/email.ts`（`getEmailProviderDiagnostics()`，未配置时错误语义一致且可定位）
- **工具 Webhook 外部副作用 outbox（审计 + 重试 + 回读）**：
  - 触发侧：`triggerModuleWebhook()` 写入 `ToolInvocation(status=PENDING)` 并入队 `TaskQueue(type=TRIGGER_TOOL_WEBHOOK)`（拒绝不安全 URL）  
  - 执行侧：`TRIGGER_TOOL_WEBHOOK` handler 负责重试退避并将 response/lastError 回写到 `ToolInvocation`  
  - 回读：`/tools` 页面可查看每个模块的调用记录（payload/响应/错误）

---

## 3) 上传：流式 + presigned 直传

- `lawclick-next/src/lib/s3.ts:1`：`putObject` 的 `body` 支持 `Readable/ReadableStream/Uint8Array`。
- `lawclick-next/src/actions/documents.ts:1`：上传时改用 `Readable.fromWeb(file.stream())`（fallback 才使用 `arrayBuffer()`）。
- `lawclick-next/src/lib/s3.ts:1`：新增 `presignPutObject()`（签名 `Content-Type`，避免客户端随意伪造头）。
- `lawclick-next/src/actions/documents.ts:1`：新增 `initPresignedDocumentUpload()` / `finalizePresignedDocumentUpload()`（HEAD 校验对象存在/大小/类型后落库，且 finalize 幂等）。
- `lawclick-next/src/lib/document-upload-client.ts:1`：客户端直传 `PUT`（失败自动 fallback 到服务器中转上传，保证真实可用）。
- **上传意图审计（UploadIntent）+ 孤儿对象回收（队列）**：
  - Prisma：`lawclick-next/prisma/schema.prisma`（`UploadIntent` + `UploadIntentStatus/Kind`）
  - 迁移：`lawclick-next/prisma/migrations/20251225223656_tg15_upload_intents_audit_cleanup/`
  - 直传 init/finalize 与服务端中转上传均写入/更新 UploadIntent：`lawclick-next/src/actions/documents.ts`
  - 回收任务：`lawclick-next/src/lib/job-handlers.ts`（`CLEANUP_UPLOAD_INTENTS`），运维入队：`lawclick-next/src/actions/upload-intents.ts`
  - 运维入口：`/admin/ops/uploads` + `/admin/ops/queue`

> 说明：本仓库的 MinIO（S3 兼容）在部分版本下不支持 `PutBucketCors`（501 NotImplemented），但 MinIO 提供全局 `api cors_allow_origin`；本地默认通常为 `*`，可用 `mc admin config export <alias>/ | findstr cors_allow_origin` 验证。

---

## 4) tenant 预备（从伪字段到强约束入口）

- `lawclick-next/src/lib/server-auth.ts:51`：
  - `getTenantId()` 支持从 `LAWCLICK_TENANT_ID` 读取（默认 `default-tenant`）。
  - `requireCaseAccess()` 即使是 `PARTNER/ADMIN` 也必须命中 tenant（不再“全局放行”）。
- `lawclick-next/src/lib/case-visibility.ts:1`：`buildCaseVisibilityWhere` 强制注入 `tenantId`。
- `lawclick-next/src/actions/cases-crud.ts:1`：创建案件显式写入 `tenantId`。
- `lawclick-next/src/actions/cases.ts:1`：`getCaseDetails()` 改为 `findFirst({ AND: [id, accessWhere] })`，在查询层面就完成 tenant+可见性过滤。

> 说明：已新增 `Tenant` 表，并将 `tenantId` 扩展到通知/队列/任务/联系人等核心模型；对未直接持有 `tenantId` 的域（如审批/合同/发票）采用“关系推导 tenant + 查询层 scope”防止跨租户读。真多租户的组织模型与（可选）RLS 仍建议单开 TG 继续深化。

---

## 5) 可复验证据（忠实落盘）

证据目录：`docs/_artifacts/tg15_backend_ops_2025-12-25/`

- `pnpm_lint.txt`
- `pnpm_typecheck.txt`
- `pnpm_build.txt`
- `pnpm_test.txt`
- `pnpm_route_audit.txt`
- `pnpm_prisma_validate.txt`
- `prisma_migrate_deploy.txt`
- `prisma_migrate_status.txt`
- `pnpm_prisma_generate.txt`

补充（本轮追加：presigned 直传闭环）证据目录：`docs/_artifacts/tg14_fullclosure_2025-12-25_v5/`

补充（2025-12-26：上传意图审计 + 孤儿对象回收 + 运维入口 + 门禁全绿）证据目录：`docs/_artifacts/tg15_p2p3_ops_2025-12-26/`

补充（2025-12-26 v2：队列治理 balanced + EmailDelivery outbox + 运维类型概览 + 门禁全绿）证据目录：`docs/_artifacts/tg15_p2p3_queue_governance_2025-12-26_v2/`

补充（2025-12-27 v6：门禁重跑全绿，含 `/admin/ops/uploads` 运维 E2E 回归）：`docs/_artifacts/tg16_followup_2025-12-27_v6/`

---

## 6) 下一步（继续落地的 P2/P3）

1. **真多租户定案**（建议 TG16）：User/Firm/tenant 关系落库 + 全域 tenant filter +（可选）RLS。
2. **队列幂等深化**：已落地（EmailDelivery outbox 覆盖 `SEND_EMAIL` + ToolInvocation outbox 覆盖工具 Webhook）；下一步可扩展到更多“外部副作用任务”（短信/支付/支付网关/外部集成）。
3. **队列容量与治理**：已落地（默认 balanced + 邮件限流 + 运维按 type 执行 + 队列健康快照/告警闭环）；下一步可深化趋势与分位（积压曲线、耗时 P95、失败率阈值告警策略）。
