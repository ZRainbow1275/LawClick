# TG13｜Rust 原型治理与闭环（2025-12-20）

> 范围：根目录 `src/`（Axum/SeaORM）Rust 后端原型；按要求忽略 `apps/mobile/`。  
> 裁判：`AGENTS.md` + `.agent/rules/lawclick.md` 的“极限标准”（真数据、全量校验、拒绝空壳、显式错误、强类型、生产对齐）。

---

## 1. 背景（来自 TG12 的问题）

在 `docs/TG12_本轮开发批判性检视_2025-12-19.md` 与 `docs/TG12_极限标准整改闭环_2025-12-19.md` 中，根目录 Rust `src/` 被判定为：

- 可 `cargo check`，但大量未接入/未使用，容易形成“名义后端”的认知混乱。
- 与 Web 主线（Next Server Actions + Prisma）口径不一致，缺少真实闭环的鉴权/落库/错误语义。

本 TG 的目标是把 Rust 原型拉回“可编译 + 可运行 + 可鉴权 + 可落库 + 可复验”的真实状态，并对齐主库（Prisma/Postgres）。

---

## 2. 已完成的闭环能力（Rust 侧）

### 2.1 生产对齐（严格配置）

- `DATABASE_URL` 为必需项；缺失即启动失败（拒绝隐式成功）。
- `JWT_SECRET`（长度 ≥ 32）为必需项：用于 Rust API 自签 Token（用于直接调用 Rust API）。
- `NEXTAUTH_SECRET`（或回退 `AUTH_SECRET`，长度 ≥ 32）为必需项：用于解密 Web 主线 NextAuth/Auth.js 的 Session Token（JWE）。
- `S3_ENDPOINT`、`S3_ACCESS_KEY`、`S3_SECRET_KEY`、`S3_BUCKET_NAME` 为必需项：用于文档中心真实上传/下载闭环（MinIO/S3）。
- CORS 默认收敛，必须显式 `CORS_ALLOW_ANY` 或 `CORS_ALLOW_ORIGINS` 才放开。
- AI 未配置 `OPENAI_API_KEY` 时显式失败（不提供演示/占位回复）。

### 2.2 鉴权与校验（零信任）

- `Claims` 抽取器：优先读取 `Authorization: Bearer <token>`；缺失时兜底读取 `Cookie`（`authjs.session-token` / `__Secure-*` / `next-auth.*`，含 cookie chunking 拼接）；未登录直接 401（避免“后端未鉴权但接口可用”的空壳风险）。
- `ValidatedJson<T>`：JSON 解析 + `validator` runtime 校验一体化；失败返回结构化 `details`。
- 密码校验：支持 bcrypt（对齐 Web 主线 bcryptjs），兼容 argon2 以防历史数据。
- `CurrentUser`：每次请求强制查库，以 DB 的 `User` 作为 role/isActive 真源（拒绝信任 Token 的陈旧字段）。

### 2.3 实体对齐 Prisma（同库同字段）

已对齐并接入的核心实体（SeaORM）：

- `User`、`Case`、`CaseMember`
- `Task`、`TimeLog`
- `ConflictCheck`（利益冲突检查记录）
- `ChatThread`、`ChatParticipant`（案件群聊闭环）
- `Document`、`DocumentVersion`（文档中心 + 版本闭环）
- `Event`、`EventParticipant`（日程/调度）
- `Notification`（通知闭环）

---

## 3. API 竖切（Tracer Bullet）

### 3.1 案件（含利益冲突 + 群聊）

- `POST /api/v1/cases`：案号生成（`LC-{year}-{type}-{seq}`）、成员写入、利益冲突检查（基于 `Contact` ILIKE + 在办案件）、自动创建案件群聊并写入参与人。
- `GET /api/v1/cases`：分页 + 搜索 + 状态筛选；非 PARTNER/ADMIN 按 originator/handler/members 过滤。
- `GET /api/v1/cases/:id`：同样的可见性规则（拒绝用哑值伪装“查无数据”）。

### 3.2 任务（Kanban 排序）

- `GET /api/v1/tasks?caseId=...`：按 `order` 返回案件任务。
- `POST /api/v1/tasks`：`task:create` + `case:view`，按同列最大 `order + 1024` 生成排序。
- `PATCH /api/v1/tasks/:id`：`task:edit` + `case:view`，显式更新 `updatedAt`（Prisma 的 `@updatedAt` 非 DB trigger，Rust 必须手动维护）。
- `DELETE /api/v1/tasks/:id`：`task:delete` + `case:view`。

### 3.3 工时（开始/暂停/恢复/停止 + 计费快照）

- `POST /api/v1/timelogs/start`：必须关联案件/任务；同一用户仅允许 1 个 RUNNING/PAUSED；计时记录真实落库。
- `POST /api/v1/timelogs/:id/pause|resume|stop`：仅允许本人操作；`stop` 时快照费率并计算金额（秒→小时）。
- `GET /api/v1/timelogs/active`：返回当前活动计时（RUNNING/PAUSED）。

### 3.4 其它

- `POST /api/v1/auth/login`、`GET /api/v1/auth/me`、`POST /api/v1/auth/refresh`
- `GET /api/v1/users`（`user:view_all`）、`GET /api/v1/users/:id`（本人或 `user:view_all`）
- `POST /api/v1/ai/chat`、`POST /api/v1/ai/analyze`（真实 OpenAI 调用）
- 文档中心：`GET /api/v1/documents`、`GET /api/v1/documents/:id`、`POST /api/v1/documents/upload`、`GET /api/v1/documents/:id/file`
- 日程：`GET|POST /api/v1/events`
- 通知：`GET /api/v1/notifications`、`POST /api/v1/notifications/:id/read`、`POST /api/v1/notifications/read-all`

> 说明：Rust API 的请求/响应均已收敛为 `camelCase`（对齐 Next/Prisma 客户端习惯）。

---

## 4. 复验与证据（忠实落盘）

证据目录：

- `docs/_artifacts/tg13_rust_backend_2025-12-20/`（白天阶段性闭环）
- `docs/_artifacts/tg13_rust_backend_2025-12-20_nightly/`（夜间追加：NextAuth Cookie 兜底 + DTO 命名对齐 + 清理名义代码）

- Rust：`cargo_check_after_vertical_slice.txt`、`cargo_test_after_vertical_slice.txt`
- Rust（nightly）：`cargo_check_after_cookie_auth_2025-12-20.txt`、`cargo_test_after_cookie_auth_2025-12-20.txt`、`cargo_check_after_dto_alignment_2025-12-20.txt`、`cargo_test_after_dto_alignment_2025-12-20.txt`
- Web 门禁复验（未改动主线但仍复跑留证）：`pnpm_lint_web_2025-12-20.txt`、`pnpm_typecheck_web_2025-12-20.txt`、`pnpm_build_web_2025-12-20.txt`、`pnpm_audit-routes_web_2025-12-20.txt`、`pnpm_prisma_validate_web_2025-12-20.txt`、`pnpm_test_web_2025-12-20.txt`

---

## 5. 运行说明（Rust）

必要环境变量：

- `DATABASE_URL`（指向与 `lawclick-next` 同一个 Postgres）
- `JWT_SECRET`（≥32）
- `NEXTAUTH_SECRET`（或 `AUTH_SECRET`，≥32）
- `S3_ENDPOINT`、`S3_ACCESS_KEY`、`S3_SECRET_KEY`、`S3_BUCKET_NAME`
- 可选：`CORS_ALLOW_ORIGINS` / `CORS_ALLOW_ANY`、`OPENAI_API_KEY`

启动：

- `cargo run --bin server`

登录获取 Token：

- `POST /api/v1/auth/login` → 返回 `accessToken`，后续以 `Authorization: Bearer <token>` 调用。
- Web 主线复用：也可直接携带 NextAuth/Auth.js Session Token（JWE）调用：
  - `Authorization: Bearer <authjs.session-token>`，或
  - `Cookie: authjs.session-token=<token>`（支持 cookie chunking 拼接）。

---

## 6. 仍需继续治理（下一阶段）

- **消息沟通闭环**：补齐 `ChatMessage` 实体与消息发送/未读/lastMessageAt 更新，并与 `Notification(CHAT_MESSAGE)` 联动。
- **全局搜索（TG11）**：补齐跨 `Case/Task/Document` 的统一搜索 API（至少 ILIKE + 分页），并明确权限与可见性边界。
- **账务联动（TG8）**：补齐案件账务（费用/发票/回款）与 `TimeLog` 的计费状态联动，避免“看板可用但财务不可核算”。
- **仪表盘配置真源（TG6）**：补齐 `DashboardLayout` 的读写接口与权限边界，为 MDI/LEGO 的序列化落库提供 Rust 侧闭环能力。
