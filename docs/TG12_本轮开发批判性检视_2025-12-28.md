# TG12｜本轮开发批判性检视（2025-12-28）

> 范围：`lawclick-next/`（主工程）+ 根目录 `docs/` 计划体系  
> 核心关注：**真实数据 / 无 mock&空壳 / 权限后端强制 / 前后端一致 / 质量门禁可复现**  
> 证据目录：
> - v1（基线审计）：`docs/_artifacts/critical_review_2025-12-28_v1/`
> - v2（本轮整改闭环）：`docs/_artifacts/critical_review_2025-12-28_v2/`
> - v3（追加治理收敛）：`docs/_artifacts/critical_review_2025-12-28_v3/`
> - v4（VIEWER 只读闭环）：`docs/_artifacts/critical_review_2025-12-28_v4/`
> - v5（文档只读治理）：`docs/_artifacts/critical_review_2025-12-28_v5/`
> - v6（文档可见性修复）：`docs/_artifacts/critical_review_2025-12-28_v6/`
> - v7（租户权限快照治理：修复 VIEWER 账务等交互空壳）：`docs/_artifacts/critical_review_2025-12-28_v7/`
> - v8（侧边栏按租户权限过滤：避免“可见但无权限”的页面入口）：`docs/_artifacts/critical_review_2025-12-28_v8/`

---

## 0. 结论先行（可用性 vs 断链）

### 0.1 这不是“名义开发”
- 命令级门禁全绿（v2）：`lint / type-check / build / test / audit:routes / audit:tenant-scope / prisma:validate / prisma:generate` 均通过（见 `docs/_artifacts/critical_review_2025-12-28_v2/`）。
- E2E 覆盖到主线与多租户隔离（v2）：Playwright 10/10 通过（见 `docs/_artifacts/critical_review_2025-12-28_v2/pnpm_test_after_ai_event_task_view_align.txt`）。

### 0.2 但仍存在“真实链路断点”（必须正视）
- v1 记录的断点已在 v2 完成闭环：
  - **P0（已修复）：CaseDetail “记工时 / 新建日程”从空壳→真实落库**（见下文 P0 更新记录 + E2E `tests/e2e/case-detail-timelog-events-invites.spec.ts`）。
  - **P1（已补齐）：会议邀请从“模型存在但不可操作”→可邀请/可响应/可跳转**（见下文 P1 更新记录 + `/invites`）。

> 重要：整改过程中曾出现新的门禁阻塞（P0）：任务分配“UI 显示已选择但未落库”（导致既有 E2E 失败），已在 v2 修复并留痕（见 `docs/_artifacts/critical_review_2025-12-28_v2/pnpm_test_after_task_assignee_fix.txt`）。

---

## 1. 命令级门禁与原始日志（必须可复现）

所有原始输出均已落到证据目录：

**v8（侧边栏按租户权限过滤：避免“可见但无权限”的页面入口）**
- `pnpm lint`：`docs/_artifacts/critical_review_2025-12-28_v8/pnpm_lint_after_sidebar_tenant_permission_filter.txt`（exitCode=0）
- `pnpm type-check`：`docs/_artifacts/critical_review_2025-12-28_v8/pnpm_typecheck_after_sidebar_tenant_permission_filter.txt`（exitCode=0）
- `pnpm build`：`docs/_artifacts/critical_review_2025-12-28_v8/pnpm_build_after_sidebar_tenant_permission_filter.txt`（exitCode=0）
- `pnpm test`：`docs/_artifacts/critical_review_2025-12-28_v8/pnpm_test_after_sidebar_tenant_permission_filter.txt`（exitCode=0）
- `pnpm audit:routes`：`docs/_artifacts/critical_review_2025-12-28_v8/pnpm_audit_routes_after_sidebar_tenant_permission_filter.txt`（exitCode=0）
- `pnpm audit:tenant-scope`：`docs/_artifacts/critical_review_2025-12-28_v8/pnpm_audit_tenant_scope_after_sidebar_tenant_permission_filter.txt`（exitCode=0）
- `pnpm prisma:validate`：`docs/_artifacts/critical_review_2025-12-28_v8/pnpm_prisma_validate_after_sidebar_tenant_permission_filter.txt`（exitCode=0）
- `pnpm prisma:generate`：`docs/_artifacts/critical_review_2025-12-28_v8/pnpm_prisma_generate_after_sidebar_tenant_permission_filter.txt`（exitCode=0）

**v7（租户权限快照治理：修复 VIEWER 账务等交互空壳）**
- `pnpm lint`：`docs/_artifacts/critical_review_2025-12-28_v7/pnpm_lint_after_tenant_permission_snapshot.txt`（exitCode=0）
- `pnpm type-check`：`docs/_artifacts/critical_review_2025-12-28_v7/pnpm_typecheck_after_tenant_permission_snapshot.txt`（exitCode=0）
- `pnpm build`：`docs/_artifacts/critical_review_2025-12-28_v7/pnpm_build_after_tenant_permission_snapshot.txt`（exitCode=0）
- `pnpm test`：`docs/_artifacts/critical_review_2025-12-28_v7/pnpm_test_after_tenant_permission_snapshot.txt`（exitCode=0）
- `pnpm audit:routes`：`docs/_artifacts/critical_review_2025-12-28_v7/pnpm_audit_routes_after_tenant_permission_snapshot.txt`（exitCode=0）
- `pnpm audit:tenant-scope`：`docs/_artifacts/critical_review_2025-12-28_v7/pnpm_audit_tenant_scope_after_tenant_permission_snapshot.txt`（exitCode=0）
- `pnpm prisma:validate`：`docs/_artifacts/critical_review_2025-12-28_v7/pnpm_prisma_validate_after_tenant_permission_snapshot.txt`（exitCode=0）
- `pnpm prisma:generate`：`docs/_artifacts/critical_review_2025-12-28_v7/pnpm_prisma_generate_after_tenant_permission_snapshot.txt`（exitCode=0）

**v6（文档可见性修复）**
- `pnpm lint`：`docs/_artifacts/critical_review_2025-12-28_v6/pnpm_lint_after_documents_visibility_fix.txt`（exitCode=0）
- `pnpm type-check`：`docs/_artifacts/critical_review_2025-12-28_v6/pnpm_typecheck_after_documents_visibility_fix.txt`（exitCode=0）
- `pnpm build`：`docs/_artifacts/critical_review_2025-12-28_v6/pnpm_build_after_documents_visibility_fix.txt`（exitCode=0）
- `pnpm test`：`docs/_artifacts/critical_review_2025-12-28_v6/pnpm_test_after_documents_visibility_fix.txt`（exitCode=0）
- `pnpm audit:routes`：`docs/_artifacts/critical_review_2025-12-28_v6/pnpm_audit_routes_after_documents_visibility_fix.txt`（exitCode=0）
- `pnpm audit:tenant-scope`：`docs/_artifacts/critical_review_2025-12-28_v6/pnpm_audit_tenant_scope_after_documents_visibility_fix.txt`（exitCode=0）
- `pnpm prisma:validate`：`docs/_artifacts/critical_review_2025-12-28_v6/pnpm_prisma_validate_after_documents_visibility_fix.txt`（exitCode=0）
- `pnpm prisma:generate`：`docs/_artifacts/critical_review_2025-12-28_v6/pnpm_prisma_generate_after_documents_visibility_fix.txt`（exitCode=0）

**v5（文档只读治理）**
- `pnpm lint`：`docs/_artifacts/critical_review_2025-12-28_v5/pnpm_lint_after_documents_capabilities_readonly.txt`（exitCode=0）
- `pnpm type-check`：`docs/_artifacts/critical_review_2025-12-28_v5/pnpm_typecheck_after_documents_capabilities_readonly.txt`（exitCode=0）
- `pnpm build`：`docs/_artifacts/critical_review_2025-12-28_v5/pnpm_build_after_documents_capabilities_readonly.txt`（exitCode=0）
- `pnpm test`（首次失败留痕）：`docs/_artifacts/critical_review_2025-12-28_v5/pnpm_test_after_documents_capabilities_readonly.txt`（exitCode=1）
- `pnpm test`（修复复绿）：`docs/_artifacts/critical_review_2025-12-28_v5/pnpm_test_after_documents_capabilities_readonly_fix.txt`（exitCode=0）
- `pnpm audit:routes`：`docs/_artifacts/critical_review_2025-12-28_v5/pnpm_audit_routes_after_documents_capabilities_readonly_fix.txt`（exitCode=0）
- `pnpm audit:tenant-scope`：`docs/_artifacts/critical_review_2025-12-28_v5/pnpm_audit_tenant_scope_after_documents_capabilities_readonly_fix.txt`（exitCode=0）
- `pnpm prisma:validate`：`docs/_artifacts/critical_review_2025-12-28_v5/pnpm_prisma_validate_after_documents_capabilities_readonly_fix.txt`（exitCode=0）
- `pnpm prisma:generate`：`docs/_artifacts/critical_review_2025-12-28_v5/pnpm_prisma_generate_after_documents_capabilities_readonly_fix.txt`（exitCode=0）

**v4（VIEWER 只读闭环）**
- `pnpm lint`：`docs/_artifacts/critical_review_2025-12-28_v4/pnpm_lint_after_task_viewer_role_align.txt`（exitCode=0）
- `pnpm type-check`：`docs/_artifacts/critical_review_2025-12-28_v4/pnpm_typecheck_after_task_viewer_role_align.txt`（exitCode=0）
- `pnpm build`：`docs/_artifacts/critical_review_2025-12-28_v4/pnpm_build_after_task_viewer_role_align.txt`（exitCode=0）
- `pnpm test`：`docs/_artifacts/critical_review_2025-12-28_v4/pnpm_test_after_task_viewer_role_align.txt`（exitCode=0）
- `pnpm audit:routes`：`docs/_artifacts/critical_review_2025-12-28_v4/pnpm_audit_routes_after_task_viewer_role_align.txt`（exitCode=0）
- `pnpm audit:tenant-scope`：`docs/_artifacts/critical_review_2025-12-28_v4/pnpm_audit_tenant_scope_after_task_viewer_role_align.txt`（exitCode=0）
- `pnpm prisma:validate`：`docs/_artifacts/critical_review_2025-12-28_v4/pnpm_prisma_validate_after_task_viewer_role_align.txt`（exitCode=0）
- `pnpm prisma:generate`：`docs/_artifacts/critical_review_2025-12-28_v4/pnpm_prisma_generate_after_task_viewer_role_align.txt`（exitCode=0）

**v3（追加治理收敛）**
- `pnpm lint`：`docs/_artifacts/critical_review_2025-12-28_v3/pnpm_lint_after_project_view_perm_align.txt`（exitCode=0）
- `pnpm type-check`：`docs/_artifacts/critical_review_2025-12-28_v3/pnpm_typecheck_after_project_view_perm_align.txt`（exitCode=0）
- `pnpm build`：`docs/_artifacts/critical_review_2025-12-28_v3/pnpm_build_after_project_view_perm_align.txt`（exitCode=0）
- `pnpm test`：`docs/_artifacts/critical_review_2025-12-28_v3/pnpm_test_after_project_view_perm_align.txt`（exitCode=0）
- `pnpm audit:routes`：`docs/_artifacts/critical_review_2025-12-28_v3/pnpm_audit_routes_after_project_view_perm_align.txt`（exitCode=0）
- `pnpm audit:tenant-scope`：`docs/_artifacts/critical_review_2025-12-28_v3/pnpm_audit_tenant_scope_after_project_view_perm_align.txt`（exitCode=0）
- `pnpm prisma:validate`：`docs/_artifacts/critical_review_2025-12-28_v3/pnpm_prisma_validate_after_project_view_perm_align.txt`（exitCode=0）
- `pnpm prisma:generate`：`docs/_artifacts/critical_review_2025-12-28_v3/pnpm_prisma_generate_after_project_view_perm_align.txt`（exitCode=0）

**v2（本轮整改闭环）**
- `pnpm lint`：`docs/_artifacts/critical_review_2025-12-28_v2/pnpm_lint_after_ai_event_task_view_align.txt`（exitCode=0）
- `pnpm type-check`：`docs/_artifacts/critical_review_2025-12-28_v2/pnpm_typecheck_after_ai_event_task_view_align.txt`（exitCode=0）
- `pnpm build`：`docs/_artifacts/critical_review_2025-12-28_v2/pnpm_build_after_ai_event_task_view_align.txt`（exitCode=0）
- `pnpm test`：`docs/_artifacts/critical_review_2025-12-28_v2/pnpm_test_after_ai_event_task_view_align.txt`（exitCode=0）
- `pnpm audit:routes`：`docs/_artifacts/critical_review_2025-12-28_v2/pnpm_audit_routes_after_ai_event_task_view_align.txt`（exitCode=0）
- `pnpm audit:tenant-scope`：`docs/_artifacts/critical_review_2025-12-28_v2/pnpm_audit_tenant_scope_after_ai_event_task_view_align.txt`（exitCode=0）
- `pnpm prisma:validate`：`docs/_artifacts/critical_review_2025-12-28_v2/pnpm_prisma_validate_after_ai_event_task_view_align.txt`（exitCode=0）
- `pnpm prisma:generate`：`docs/_artifacts/critical_review_2025-12-28_v2/pnpm_prisma_generate_after_ai_event_task_view_align.txt`（exitCode=0）
- 门禁失败过程留痕（整改迭代）：
  - `pnpm test`（修复前失败）：`docs/_artifacts/critical_review_2025-12-28_v2/pnpm_test_after_task_assignee_fix.txt`（exitCode=1）
  - `pnpm test`（邀请回执 deeplink 修复后）：`docs/_artifacts/critical_review_2025-12-28_v2/pnpm_test_after_invite_receipt_actionurl_fix.txt`（exitCode=0）
  - `pnpm test`（任务权限前端治理引入后失败）：`docs/_artifacts/critical_review_2025-12-28_v2/pnpm_test_after_task_capabilities_ui_gates.txt`（exitCode=1）

**v1（基线审计）**

下列基线证据仍保留于 `docs/_artifacts/critical_review_2025-12-28_v1/`，用于对照“发现 → 修复”全过程：

- 环境与版本：`docs/_artifacts/critical_review_2025-12-28_v1/env_versions.txt`
- `pnpm lint`：`docs/_artifacts/critical_review_2025-12-28_v1/pnpm_lint.txt`（exitCode=0）
- `pnpm type-check`：`docs/_artifacts/critical_review_2025-12-28_v1/pnpm_typecheck.txt`（exitCode=0）
- `pnpm build`：`docs/_artifacts/critical_review_2025-12-28_v1/pnpm_build.txt`（exitCode=0）
- `pnpm test`：`docs/_artifacts/critical_review_2025-12-28_v1/pnpm_test.txt`（exitCode=0）
- `pnpm audit:routes`：`docs/_artifacts/critical_review_2025-12-28_v1/pnpm_audit_routes.txt`（exitCode=0）
- `pnpm audit:tenant-scope`：`docs/_artifacts/critical_review_2025-12-28_v1/pnpm_audit_tenant_scope.txt`（exitCode=0）
- `pnpm prisma:validate`：`docs/_artifacts/critical_review_2025-12-28_v1/pnpm_prisma_validate.txt`（exitCode=0）
- `pnpm prisma:generate`：`docs/_artifacts/critical_review_2025-12-28_v1/pnpm_prisma_generate.txt`（exitCode=0）
- TG0 系统连通：`pnpm -C lawclick-next verify:system`：`docs/_artifacts/critical_review_2025-12-28_v1/pnpm_verify_system.txt`（exitCode=0）
- MinIO bucket 初始化：`pnpm -C lawclick-next init:s3`：`docs/_artifacts/critical_review_2025-12-28_v1/pnpm_init_s3.txt`（exitCode=0）
- Docker 运行态快照：`docs/_artifacts/critical_review_2025-12-28_v1/docker_ps.txt`

---

## 2. TG0～TG12 计划对齐检查（按“计划 → 证据 → 缺口”）

> 说明：此处是“现状验证”，不等同于历史 `验收记录.md` 的自述；以代码/门禁/可复现脚本为准。

### TG0｜基础设施对齐
- 证据：
  - `docker-compose.yml` 存在且 Postgres/MinIO 可用（见 `docs/_artifacts/critical_review_2025-12-28_v1/docker_ps.txt`）。
  - `verify:system` 通过（见 `docs/_artifacts/critical_review_2025-12-28_v1/pnpm_verify_system.txt`）。
  - `init:s3` 通过（见 `docs/_artifacts/critical_review_2025-12-28_v1/pnpm_init_s3.txt`）。
- 关键现状/争议点：
  - Prisma seed 已被“极限标准”锁死为**禁止造数**：`lawclick-next/prisma/seed.js` 永远 exit 1。
  - 证据：`docs/_artifacts/critical_review_2025-12-28_v1/prisma_db_seed.txt`（exitCode=1，明确提示必须导入脱敏生产快照）。
- 风险：
  - 新环境“零门槛启动”不可用（必须先有脱敏快照导入）；这符合“生产对齐”，但会显著降低新成员上手速度，需要组织层面配套流程与数据交付。

### TG1｜身份/权限体系统一
- 证据：
  - 路由层统一拦截存在：`lawclick-next/middleware.ts` → `lawclick-next/src/proxy.ts`。
  - 权限后端强制：Actions 普遍使用 `getActiveTenantContextWithPermissionOrThrow / requireTenantPermission / requireCaseAccess`（抽样见 `lawclick-next/src/actions/cases-crud.ts`、`lawclick-next/src/actions/tasks-crud.ts` 等）。
  - E2E 覆盖登录/重定向：`tests/e2e/auth.spec.ts` 通过（见 `docs/_artifacts/.../pnpm_test.txt`）。
- 主要问题：未发现明显“仅前端校验”的越权入口（同时有 `audit:tenant-scope` 作为守门）。

### TG2｜案件端到端闭环
- 证据：
  - 路由存在：`/cases`、`/cases/[id]`、`/cases/active`、`/cases/archived`（build 输出可见）。
  - 后端闭环：`createCase` 真实落库，并创建案件群聊与通知（见 `lawclick-next/src/actions/cases-crud.ts`）。
  - E2E 主线覆盖：`tests/e2e/mainline.spec.ts` 通过（见 `docs/_artifacts/.../pnpm_test.txt`）。
- v1 缺口：CaseDetail 的工时/日程“创建入口”空壳；v2 已闭环（见 P0 更新记录）。

### TG3｜任务协作 + 看板（含 TG3 对齐增强）
- 证据：
  - 看板 move 使用 gap/必要时 reindex：`lawclick-next/src/actions/tasks-crud.ts` 的 `moveTaskOnKanban`（配套 `TASK_POSITION_GAP`）。
  - 前端支持撤销：`lawclick-next/src/components/tasks/TaskKanban.tsx` toast undo。
  - E2E 覆盖：`tests/e2e/case-tab-deeplink.spec.ts`、`tests/e2e/project-kanban.spec.ts` 通过。
- 风险：
  - 主要是性能/一致性风险（高频拖拽 + 局部重排写放大），但当前实现至少有“gap → reindex”策略，不属于空壳。

### TG4｜计时追踪
- 证据：
  - `/time` 已接入真实 `getMyTimeLogs`（`lawclick-next/src/app/(dashboard)/time/page.tsx`）。
  - 浮窗计时器使用后端真源 `getActiveTimer/pause/resume/stop`（`lawclick-next/src/components/floating/timer-content.tsx`）。
  - 状态机关键漏洞已修复：`startTimer` 禁止 RUNNING/PAUSED 并发；`stopTimer` 正确累计秒数（`lawclick-next/src/actions/timelogs-crud.ts`）。
- v1 缺口：案件详情页“记工时”按钮无动作；v2 已闭环（见 P0 更新记录）。

### TG5｜文档中心
- 证据：
  - 受控下载/预览路由存在并后端校验：`lawclick-next/src/app/api/documents/[id]/file/route.ts`。
  - 文档 AI 审查页已替换静态假内容：`lawclick-next/src/app/(dashboard)/documents/[id]/review/page.tsx`。
- 备注：
  - v2 已补齐“真实上传→预览/下载→版本链”浏览器级复核（见 `lawclick-next/tests/e2e/documents-browser-path-ai.spec.ts`）。

### TG6｜仪表盘（MDI/DIY）
- 证据：
  - `/dashboard` 使用 `DashboardWorkspaceClient` + `react-grid-layout`，并通过 `saveMyDashboardConfig` 写 DB（`lawclick-next/src/components/dashboard/DashboardWorkspaceClient.tsx` + `lawclick-next/src/actions/dashboard-layout.ts`）。
  - `build` 未出现 dynamic server usage 阻塞（见 `docs/_artifacts/.../pnpm_build.txt`）。

### TG7｜日程安排/调度中心
- 证据：
  - `/calendar` 使用 `CanvasCalendar`，支持 week/day/month/list 视图且拉取真实数据（`lawclick-next/src/components/calendar/CanvasCalendar.tsx`）。
  - `/dispatch` 存在团队状态、排班泳道与待处理邀请面板（`lawclick-next/src/app/(dashboard)/dispatch/page.tsx`）。
  - 后端存在 `EventParticipant` 与 busy-only 脱敏策略（`lawclick-next/src/actions/event-actions.ts`）。
  - 会议邀请 tracer bullet 已闭环：`createEvent` 会创建 `CollaborationInvite(type=MEETING)` + 通知接收人；受邀人可在 `/invites` 接受/拒绝并同步 `EventParticipant`（见 `lawclick-next/src/actions/event-actions.ts` + `lawclick-next/src/actions/collaboration-actions.ts` + `lawclick-next/src/app/(dashboard)/invites/page.tsx`）。
  - E2E 覆盖：`lawclick-next/tests/e2e/case-detail-timelog-events-invites.spec.ts` 通过（v2 `pnpm_test_after_ai_event_task_view_align.txt`）。

### TG8｜案件账务联动
- 证据：
  - 案件详情“账务”Tab 存在并拉取真实数据：`lawclick-next/src/components/cases/CaseBillingTab.tsx`，复用 `billing-actions/finance-actions/approval-actions/contract-actions`。
  - 客户信息展示来自真实字段（电话/邮箱为空显示“未填写”，不再硬编码）：`lawclick-next/src/components/cases/CaseDetailClient.tsx` 右侧栏。
- 风险：缺少 E2E 覆盖，需人工回归（本轮仅记录，不做主观背书）。

### TG9｜AI 模块/工具箱
- 证据：
  - AI provider 不再允许 mock key：`lawclick-next/src/lib/ai-provider.ts` 会短路并返回明确原因；`ai-actions.ts` 会写入 `AIInvocation(ERROR)`。
  - `/tools` 读取 DB `ToolModule`、Webhook 调用审计落库 `ToolInvocation`，并强制 `https + allowlist + 禁止私网`：`lawclick-next/src/actions/tool-actions.ts` + `lawclick-next/src/lib/webhook-safety.ts`。
- 风险：
  - 没有配置 `OPENAI_API_KEY` 时 AI 不可用（但这是“预期的硬失败”，非隐式假闭环）。
  - 没有配置 `TOOL_WEBHOOK_ALLOWLIST` 时 Webhook 触发将被拒绝（预期安全策略）。

### TG11｜全局搜索/通知闭环
- 证据：
  - Server Actions 存在：`lawclick-next/src/actions/search-actions.ts`、`lawclick-next/src/actions/notification-actions.ts`。
  - E2E 覆盖：聊天通知跳转、任务通知 deeplink（见 `tests/e2e/chat-notification.spec.ts`、`tests/e2e/case-tab-deeplink.spec.ts`）。
- v1 风险（P2，v2 已修复）：
  - `globalSearch` 曾以 `task:edit` 作为“能否搜索任务”的权限门槛，语义偏重；v2 已引入 `task:view` 并将搜索/任务列表权限语义对齐到“可见≠可编辑”。

### TG12｜统一回归与纠错 v2
- 证据：
  - `audit:routes` 通过（v2：`docs/_artifacts/critical_review_2025-12-28_v2/pnpm_audit_routes_after_ai_event_task_view_align.txt`；v1：`docs/_artifacts/critical_review_2025-12-28_v1/pnpm_audit_routes.txt`）。
  - `build` 通过且无阻塞告警（v2：`docs/_artifacts/critical_review_2025-12-28_v2/pnpm_build_after_ai_event_task_view_align.txt`；v1：`docs/_artifacts/critical_review_2025-12-28_v1/pnpm_build.txt`）。
  - E2E 通过（v2：`docs/_artifacts/critical_review_2025-12-28_v2/pnpm_test_after_ai_event_task_view_align.txt`；v1：`docs/_artifacts/critical_review_2025-12-28_v1/pnpm_test.txt`）。

---

## 3. 空壳/Mock 检查（必须零容忍）

- mock 关键字扫描（v1 基线）：`docs/_artifacts/critical_review_2025-12-28_v1/rg_mock_shell_scan.txt`（无命中）。
- v1 发现的“空壳交互”（v2 已修复并补 E2E）：
  - CaseDetail “记工时 / 新建日程”点击无响应 → 已实现 Dialog → Server Actions → DB 落库（见 `lawclick-next/src/components/cases/CaseDetailClient.tsx`；E2E：`lawclick-next/tests/e2e/case-detail-timelog-events-invites.spec.ts`）。
- 结论（v2）：主链路不再存在“点击无响应”的 UI 空壳；仍需持续以 E2E 覆盖新增入口，避免回归。

---

## 4. 问题与技术债清单（忠实记录）

> 严重级别：P0=阻塞主链路/违背硬约束；P1=明显断链或高风险；P2=可优化/易混乱。

### P0（必须尽快修复）
1. **（v1 发现，v2 已修复）案件详情页（CaseDetail）“记工时 / 新建日程”按钮空壳**
   - 位置：`lawclick-next/src/components/cases/CaseDetailClient.tsx`
   - v1 现象：按钮可点击但无 `onClick`，不会打开对话框/不会落库/不会跳转（违反“无空壳”）。
   - v2 修复：已实现“弹窗 → Zod 校验 → Server Action → DB 落库 → 刷新”，并新增 E2E 覆盖（`lawclick-next/tests/e2e/case-detail-timelog-events-invites.spec.ts`）。

2. **（整改过程新增 P0，v2 已修复）任务分配：UI 可选但未落库（导致既有 E2E 失败）**
   - 现象：任务详情中选择负责人后点击保存，卡片可短暂显示已选但 DB `Task.assigneeId` 仍为 `null`，导致主线断链与通知闭环不可复现。
   - 根因：任务详情 Dialog 的表单初始化时机不稳定，存在“打开瞬间异步初始化覆盖用户输入”的竞态窗口。
   - v2 修复：将表单初始化改为受控的 layout-effect + 防重入策略，避免覆盖用户已输入状态（见 `lawclick-next/src/components/tasks/TaskDetailDialog.tsx`）；门禁已复绿（见 `docs/_artifacts/critical_review_2025-12-28_v2/pnpm_test_after_task_dialog_init_fix.txt`）。

3. **（v5 发现，v6 已修复）文档中心列表未按案件可见性过滤（潜在跨案件数据泄露）**
   - 现象：`getDocuments()` 仅按 tenant 过滤文档（`case.tenantId`），未叠加案件可见性约束，导致“非案件成员也可能在 `/documents` 看见其他案件文档”的权限语义偏差。
   - 修复：`getDocuments` 列表 where 改为 `case: buildCaseVisibilityWhere({ userId, role, tenantId })`，将可见性与 `case:view` 语义对齐（`lawclick-next/src/actions/documents.ts`）。
   - 回归：新增 E2E “非成员不可见”（`lawclick-next/tests/e2e/documents-case-visibility.spec.ts`），并以 v6 门禁复绿为证（`docs/_artifacts/critical_review_2025-12-28_v6/pnpm_test_after_documents_visibility_fix.txt`）。

### P1（强烈建议补齐闭环）

1. **会议邀请链路 UI 缺失（EventParticipant vs CollaborationInvite）**
   - v1：后端能力存在，但前端闭环缺口：事件创建/详情未提供邀请发起与响应入口。
   - v2（已补齐）：新增 `/invites` 入口 + 通知跳转对齐 + 事件详情支持受邀人接受/拒绝，并新增 E2E 覆盖（`lawclick-next/tests/e2e/case-detail-timelog-events-invites.spec.ts`）。

2. **版本控制/仓库卫生风险：lawclick-next git 工作区大量未跟踪文件**
   - 证据：`docs/_artifacts/critical_review_2025-12-28_v1/git_status_lawclick-next.txt`
   - 影响：协作/回滚/定位回归风险显著；`docs` 与主工程也不在同一 git 根，版本语义混乱。

3. **（整改过程新增 P1，v2 已修复）邀请回执通知 deeplink 误指向 `/dispatch`（角色不一致导致点击即 403/无权限）**
   - 现象：受邀人接受/拒绝后，发起人收到回执通知；但 `actionUrl` 固定为 `/dispatch`，多数非合伙人/高级律师角色无法访问，导致通知闭环断链。
   - 修复：
     - 回执通知 `actionUrl` 按邀请类型落到安全目标：案件→`/cases/:id`；任务→`/tasks/:id`；会议→`/calendar`；兜底→`/invites`（见 `lawclick-next/src/actions/collaboration-actions.ts`）。
     - 侧边栏补齐 `/invites` 导航入口（见 `lawclick-next/src/config/navigation.ts`）。
     - E2E 增补“发起人收到会议邀请已接受通知→点击跳转到 `/calendar`”（见 `lawclick-next/tests/e2e/case-detail-timelog-events-invites.spec.ts`）。

### P2（建议纳入后续 TG/持续治理）
1. **（v1 风险，v2 已修复）全局搜索任务权限语义偏重**
   - v1：以 `task:edit` 作为任务搜索权限门槛。
   - v2：已新增 `task:view` 并将任务“可见/可编辑”语义拆分与落地。

2. **（v1 风险，v2 已修复）Dashboard 数据获取容错可能掩盖真实错误**
   - v1：catch 后返回空数组，会让“后端错误”表现为“业务无数据”。
   - v2：改为显式返回 `{ success, error }` 并由页面展示错误横幅，避免吞错。

3. **（整改过程新增 P2，v2 已修复）任务读取接口权限语义不一致：看板/详情读取曾使用 `task:edit/task:create`**
   - 风险：未来引入只读角色（类似 Planka 的 VIEWER/EDITOR）时，会出现“可见但无法打开看板/详情”的隐性断链。
   - 修复：将读取侧 Server Actions 统一改为 `task:view`（看板读取：`lawclick-next/src/actions/tasks-crud.ts`；详情读取：`lawclick-next/src/actions/tasks-detail.ts`），写入动作仍由 `task:edit` 强制。

4. **（整改过程新增 P2，v2 已修复）前端未显式区分“可见/可编辑/可创建”导致未来只读角色易出现交互空壳**
   - 现象：仅后端拒绝会让用户误以为“点击无响应/坏掉”；同时新增 `onCapabilitiesChange` 时曾触发 TaskKanban 重载循环（表现为看板列持续 loading，见失败日志）。
   - 修复：
     - `TaskKanban` 引入服务端下发 `TaskCapabilities`，在前端禁用拖拽/快速新增/保存/删除，并用 ref 固化回调避免重载循环（`lawclick-next/src/components/tasks/TaskKanban.tsx`）。
     - `TaskDetailDialog` 支持只读模式：字段禁用、隐藏保存/删除（`lawclick-next/src/components/tasks/TaskDetailDialog.tsx`）。
     - 快速新建任务权限错误显式化（`lawclick-next/src/actions/tasks.ts` + `lawclick-next/src/components/tasks/QuickCreateTaskDialog.tsx`）。

5. **（整改过程新增 P2，v2 已修复）AI/日程引用项目任务的访问校验语义偏重（误用 `task:edit`）**
   - 风险：未来只读角色可见任务但无法用 AI/创建日程引用该任务，出现“能力存在但被过度收紧”的断链。
   - 修复：读取/引用场景统一改为 `task:view`（AI：`lawclick-next/src/actions/ai-actions.ts`；日程：`lawclick-next/src/actions/event-actions.ts`）。

6. **（v3 追加治理）项目中心/实时信号读取权限语义偏重（误用 `task:create`）**
   - 风险：未来只读角色仅有 `task:view` 时，项目中心/实时订阅会被误挡；且 API 未登录/无权抛异常可能导致 500，不利于前端处理与审计。
   - 修复：
     - 项目中心/详情读取统一改用 `task:view`，创建按钮按 `task:create` 显式控制（`lawclick-next/src/app/(dashboard)/projects/page.tsx`、`lawclick-next/src/app/(dashboard)/projects/[id]/page.tsx`、`lawclick-next/src/actions/projects-crud.ts`、`lawclick-next/src/lib/server-auth.ts`）。
     - `GET /api/realtime/signals` 改用 `task:view` 且显式返回 401/403，并新增 E2E 覆盖（`lawclick-next/src/app/api/realtime/signals/route.ts`、`lawclick-next/tests/e2e/api-realtime-signals-auth.spec.ts`）。
     - dispatch 项目可见性过滤改用 `task:view`（`lawclick-next/src/actions/dispatch-tasks.ts`）。

7. **（v4 追加治理）TenantMembershipRole.VIEWER 与 `task:view` 语义落地（参照 Planka 的 VIEWER/EDITOR）**
   - 风险：虽然已有租户角色层级（VIEWER/MEMBER/…），但 `task:view` 最小租户角色若仍为 MEMBER，会导致“只读成员”无法查看任务看板/任务详情，前后端语义不一致。
   - 修复：
     - 将 `TENANT_PERMISSION_MIN_ROLE["task:view"]` 从 MEMBER 调整为 VIEWER（`lawclick-next/src/lib/server-auth.ts`）。
     - 新增 E2E 覆盖“VIEWER 成员：任务可见但只读（不可新建/不可保存）”（`lawclick-next/tests/e2e/task-viewer-readonly.spec.ts`），并补齐测试侧 membership 调整 helper（`lawclick-next/tests/e2e/e2e-helpers.ts`）。

8. **（v5 追加治理）文档中心 capabilities 显式只读（避免“可点但失败”的交互空壳）**
   - 风险：当成员仅具备 `document:view`（例如租户角色 VIEWER）时，若前端仍展示“上传/编辑标签/编辑备注”等入口，会形成“按钮存在但点击即报权限错误”的空壳体验。
   - 修复：
     - 引入 `DocumentCapabilities` 并由服务端下发，在 UI 侧隐藏上传/编辑入口，并展示只读提示（`lawclick-next/src/lib/capabilities/document-capabilities.ts`、`lawclick-next/src/app/(dashboard)/documents/page.tsx`、`lawclick-next/src/components/documents/DocumentListClient.tsx`）。
     - 新增 E2E 覆盖 “VIEWER 文档中心无上传入口”（`lawclick-next/tests/e2e/documents-viewer-readonly.spec.ts`）。

9. **（v5 迭代留痕）CaseDetail Tabs 由 onClick 改为可导航链接（提升 deeplink 与测试稳定性）**
   - 现象：E2E 中“点击 Tab 后 URL 应包含 `?tab=...`”在 hydration 时序下曾出现不稳定（v5 首次 `pnpm test` 失败留痕见 `docs/_artifacts/critical_review_2025-12-28_v5/pnpm_test_after_documents_capabilities_readonly.txt`）。
   - 修复：将 Tab trigger 改为 `Link`（仍保留按钮语义），确保点击可立即产生 URL 变化并与 `tab` deeplink 对齐（`lawclick-next/src/components/cases/CaseDetailClient.tsx`）。

10. **（v7 追加治理）前端 `usePermission` 仅按全局 Role 判断，无法体现租户角色门槛（TenantMembershipRole），导致 VIEWER 场景在“账务/审批/工具箱”等出现交互空壳**
   - 现象：当用户全局角色为 `LAWYER/…` 但租户角色被降为 `VIEWER` 时，UI 仍可能展示“创建发票/记录费用/新建审批/工具管理”等入口；点击后才被服务端以“当前工作区权限不足”拒绝（违反“避免可点但失败”的要求）。
   - 修复：
     - 在 Dashboard layout 由服务端计算租户权限快照（基于 `hasTenantPermission`），客户端通过 `TenantPermissionProvider` 注入，`usePermission` 优先使用快照判断（`lawclick-next/src/app/(dashboard)/layout.tsx`、`lawclick-next/src/components/providers/TenantPermissionProvider.tsx`、`lawclick-next/src/hooks/use-permission.ts`、`lawclick-next/src/lib/permissions.ts`）。
     - 新增 E2E 覆盖“VIEWER 案件账务 Tab 无创建入口”（`lawclick-next/tests/e2e/case-billing-viewer-readonly.spec.ts`）。

11. **（v8 追加治理）侧边栏导航仅按全局 Role / `canAccessPage` 过滤，未按租户权限过滤，导致 VIEWER/CLIENT 出现“入口可见但进入后无权限/被重定向”的 UX 断链**
   - 现象：租户角色为 `VIEWER` 时，侧边栏仍可能展示 `crm/team/admin/chat` 等入口；进入后页面返回“无权限访问”。`CLIENT` 角色曾被特殊放行显示“工作台/文档/消息”，但实际会被 middleware 重定向，形成明显空壳体验。
   - 修复：为导航项/子项补充 `permission` 元数据，并在 `AppSidebar` 中结合租户权限快照（`usePermission`）二次过滤；同时移除 `CLIENT` 的“按名称硬编码放行”，以 `canAccessPage` 为准（`lawclick-next/src/config/navigation.ts`、`lawclick-next/src/components/layout/app-sidebar.tsx`）。

---

## 5. 备注：浏览器级复核（v2 已补齐）

- 文档上传（MinIO PutObject）用户路径：已补齐 E2E 覆盖“上传→预览/下载→版本链”，并验证受控下载 Header（见 `lawclick-next/tests/e2e/documents-browser-path-ai.spec.ts`）。
- AI 实际调用：未配置 `OPENAI_API_KEY` 时按设计会硬失败；v2 E2E 仅验证“失败可追溯/审计落库”，不对模型输出质量背书。
