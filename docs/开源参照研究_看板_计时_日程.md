# 开源参照研究：看板（Focalboard/Planka）+ 计时/日程（Cal.com）

> 目的：在不复制代码的前提下，借鉴成熟产品的**数据模型、交互范式、并发/一致性策略**，并映射到律时的 TG 规划与实现。

## 0. 合规声明（必须遵守）
- 本文只记录“理念/结构/交互/算法思路”，**不复制/粘贴**任何开源项目的实现代码。
- 参考项目包含 AGPL 组件（Planka、Cal.com、Focalboard 部分），因此：
  - 我们只借鉴“通用工程思想”，不复用其源代码与文件结构。
  - 若未来需要引入其具体实现，必须先做许可证合规评估与隔离方案。

## 1. 看板参照：Focalboard（Mattermost）
### 1.1 核心建模思路（可借鉴）
- 把 Board / View / Card 视作统一的“Block”体系（更像 Notion），View 负责“展示形态 + 排序 + 分组”。
- **手动排序**常以“view 级别的 cardOrder 数组”持久化：即 **排序属于视图**，不是卡片本体。
- 交互侧强调：
  - 拖拽后先本地更新（乐观 UI）
  - 再通过“mutator/patch”同步后端
  - 支持 Undo/Redo 的“操作组（undo group）”语义

### 1.2 对律时的映射建议
- 律时当前以 `Task.order` 维护列内顺序（排序属于任务本体）。后续若要支持多视图（按负责人/阶段/标签）：
  - 可引入“View 实体 + viewCardOrder”将排序从任务本体剥离（类似 Focalboard）
  - 或保留本体排序，但为不同视图提供独立排序字段（需要权衡）

## 2. 看板参照：Planka（Trello-like）
### 2.1 核心建模与排序（可借鉴）
- Board/List/Card 为典型 Trello 结构。
- Card/List 的排序用 `position:number` 表示（常配合 gap）：
  - 拖拽时只更新被移动对象的 `position`（必要时小范围重排）
  - 后端使用“插入到 positionables”一类算法，避免每次全量 renumber
- 实时协作通过 WebSocket 广播变更事件（多人一致性更强）

### 2.2 对律时的映射建议
- 律时 TG3 采用 `order:int` 批量 renumber 的方式完成最小闭环；对大列频繁拖拽会产生批量写入。
- 后续优化路线（建议在 TG7/协作实时化时落地）：
  1. 在不改 schema 的前提下引入 **gap order**（如 `1024` 步长 + 取中位数插入）
  2. 当 gap 不足时对局部区间 reindex
  3. 未来进一步升级为 **分数索引/LexoRank**（更适配并发）

## 3. 计时/日程参照：Cal.com
### 3.1 核心思想（可借鉴）
- 全链路时区敏感：用户 profile 存储 `timeZone`；展示时明确“组织者时区 vs 访客时区”。
- 可用性计算是服务化聚合（AvailableSlotsService 思路）：
  - 规则（availability）+ 已有事件（bookings/calendar events）+ OOO + 限制（booking/duration limits）
  - 通过缓存与“预留 slot”降低并发双占风险
- 预约/事件状态机清晰（PENDING/ACCEPTED/CANCELLED/RESCHEDULED 等）

### 3.2 对律时的映射建议
- 律时内部日程（TG7）可借鉴：
  - **UTC 存储 + 展示时区转换**
  - 冲突检测：本系统 Event + 外部日历（未来可接入）+ 庭审/截止期硬约束
  - 预留机制：避免多人同时拖拽排期导致“双占”
- 律时计时（TG4）可借鉴：
  - 状态机明确（RUNNING/PAUSED/COMPLETED/APPROVED/BILLED）
  - 单用户“同一时刻仅允许一个 RUNNING”作为硬约束
  - 把计时与任务/案件上下文绑定，支持复盘与计费

## 4. 已采纳/待采纳清单（映射到 TG）
### 4.1 已采纳（TG3 已落地）
- 乐观拖拽 + 落库（Kanban 基本体验）
- 后端事务化更新（保证一致性）
- 看板 position/gap 排序（Planka 思路）：默认只更新被移动任务，必要时局部 reindex
- Add card 快速新建 + 卡片详情弹窗编辑（Planka 交互范式）
- 拖拽失败回滚 + 一次撤销（Undo）（Focalboard 体验对齐）

### 4.2 待采纳（后续 TG）
- 分数索引/LexoRank（进一步提升并发与稳定性）
- 多视图排序与属性系统（对齐 Focalboard 的 View 思路）
- 日程可用性/冲突检测/时区策略（对齐 Cal.com，落在 TG7）
