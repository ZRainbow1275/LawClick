# TG12｜批判性审计：问题与技术债清单（忠实记录）

> 主工程：`lawclick-next/`  
> 审计时间：2025-12-17（本地环境）  
> 目标：以“批判性眼光”审视 TG0-TG12 的真实可用性、前后端一致性、冗余与混乱点，并对 lint/测试/构建输出中的问题与技术债做**忠实记录**。  
> 红线依据：`.agent/rules/lawclick.md` + `@continue/01_核心架构与关键决策.md`（无空壳/无假数据/权限后端强校验/入口闭环/MDI+LEGO）。  

---

## 0. 证据包（可复现）

本次审计的“事实来源”全部落盘在 `docs/_artifacts/`：
- Lint 原始输出：`docs/_artifacts/lint_2025-12-17.txt`
- ESLint JSON：`docs/_artifacts/eslint_2025-12-17.json`
- ESLint 汇总（Top Rules/Files）：`docs/_artifacts/eslint_summary_2025-12-17.md`
- Next Build：`docs/_artifacts/build_2025-12-17.txt`
- 路由断链巡检：`docs/_artifacts/route_audit_2025-12-17.txt`
- Playwright：`docs/_artifacts/playwright_2025-12-17.txt`
- Prisma Validate：`docs/_artifacts/prisma_validate_2025-12-17.txt`

> 说明：本次仅记录“实际运行输出”，即便输出中包含噪音/乱码也不做美化处理（以便追溯真实状态）。

### 0.1 2025-12-18 整改复验证据（新增）

本轮整改与复验同样全部落盘在 `docs/_artifacts/`：
- ESLint JSON：`docs/_artifacts/eslint_2025-12-18.json`
- ESLint 汇总：`docs/_artifacts/eslint_summary_2025-12-18.md`
- Next Build：`docs/_artifacts/build_2025-12-18.txt`
- Playwright：`docs/_artifacts/playwright_2025-12-18.txt`

---

## 1. 审计结论（摘要）

### 1.1 工程守门结论（可运行性）
- `next build`：通过（见 `docs/_artifacts/build_2025-12-17.txt`）
- 路由断链：未发现断链引用（见 `docs/_artifacts/route_audit_2025-12-17.txt`）
- `prisma validate`：通过（见 `docs/_artifacts/prisma_validate_2025-12-17.txt`）
- Playwright：测试通过（见 `docs/_artifacts/playwright_2025-12-17.txt`），但输出包含 `ECONNRESET`/`aborted` 等噪音（需关注稳定性）
- ESLint：**0 error，但 269 warnings**（见 `docs/_artifacts/lint_2025-12-17.txt` / `docs/_artifacts/eslint_summary_2025-12-17.md`）

### 1.2 红线违背（P0：必须面对的事实）
以下问题与 `.agent/rules/lawclick.md` 的“无空壳/无假数据/入口闭环”直接冲突，且存在真实可达入口：
1. **`/settings`（设置与帮助）为可达“空壳+假数据”页面**：UI 有大量“看似可编辑”的字段与开关，但**未接入任何后端 action/API/落库**，并内置硬编码默认值（姓名/电话/邮箱/公司信息等）。  
   - 入口：侧边栏底部“设置与帮助”（`lawclick-next/src/components/layout/app-sidebar.tsx`）  
   - 页面：`lawclick-next/src/app/(dashboard)/settings/page.tsx`
2. **`/profile`（个人中心）存在硬编码“项目列表/组织信息/功能入口”**，属于“假数据展示”，且页面结构暗示可用功能（统计报告、通知提醒、主页形象等）但无闭环。  
   - 页面：`lawclick-next/src/components/profile/ProfileClient.tsx`、`lawclick-next/src/app/(dashboard)/profile/page.tsx`

### 1.3 一致性风险（P1：会导致“名义可用、实际不可用/不可维护”）
- **权限与导航不一致**：`/settings` 在 `PAGE_ACCESS_CONFIG` 仅允许 `PARTNER/ADMIN`，但侧边栏底部按钮对所有角色显示（未做过滤），造成“可见但点击后被 middleware 重定向”的 UX 不一致风险。  
  - 权限配置：`lawclick-next/src/lib/permissions.ts`  
  - 导航渲染：`lawclick-next/src/components/layout/app-sidebar.tsx`
- **类型安全策略妥协**：为保证 TG12 回归守门链路可持续，ESLint 中部分规则降级为 `warn`（导致“0 error 但大量 warning”）；同时 NextAuth 字段在类型层标为可选以兼容依赖树差异。该策略本身必须被视为“技术债”，不能永久化。  
  - 规则：`lawclick-next/eslint.config.mjs`
  - Auth 类型：`lawclick-next/src/auth.ts`、`lawclick-next/src/types/next-auth.d.ts`

---

## 2. Lint 忠实记录（当前真实状态）

### 2.1 总览
- 结论：`0 errors, 269 warnings`（见 `docs/_artifacts/lint_2025-12-17.txt`）
- Top Rules（见 `docs/_artifacts/eslint_summary_2025-12-17.md`）：
  - `@typescript-eslint/no-explicit-any`：188
  - `@typescript-eslint/no-unused-vars`：64
  - `react-hooks/set-state-in-effect`：9
  - `react-hooks/exhaustive-deps`：7
  - `@next/next/no-img-element`：1

### 2.2 重要 warning 样例（对可用性/一致性影响最大）
- `react-hooks/set-state-in-effect`：集中在全局搜索与计时器组件（高频交互点），可能导致不必要的渲染级联与性能抖动。  
  - `lawclick-next/src/components/layout/header-components.tsx`  
  - `lawclick-next/src/components/timelog/TimerWidget.tsx`
- `no-img-element`：`ProfileClient` 使用 `<img>`（影响 Next.js image 优化与 LCP），虽非阻断但属于质量债。  
  - `lawclick-next/src/components/profile/ProfileClient.tsx`

> 备注：warning 的存在不等于功能不可用，但在“TG12 回归阶段”仍需被当作风险库存档，并按模块逐步清零。

---

## 3. “空壳/假数据/不可用功能”盘点（按可达性排序）

### P0｜可达空壳（必须整改或下线）
1. `/settings`：表单字段、通知开关、主题选择等均未落库；部分 UI 行为仅改变本地 state（刷新即丢失），属于“名义功能”。  
   - `lawclick-next/src/app/(dashboard)/settings/page.tsx`
2. `/profile`：硬编码项目列表与组织信息，且多个入口无后端闭环（统计报告、通知提醒、主页形象、虚拟人开关等）。  
   - `lawclick-next/src/components/profile/ProfileClient.tsx`

### P1｜可达但明确占位（应显式下线/重定向/或补齐闭环）
1. `/research`：明确 toast “TG13+ 开发中”，当前仅 UI 占位。  
   - `lawclick-next/src/app/(dashboard)/research/page.tsx`

### P2｜当前未挂载，但代码中存在 mock/占位（易被误接入）
> 这些文件虽然目前不在主入口上出现，但它们代表“未来接入时会违反红线”的风险点，必须留痕。
- `CommandPalette`（命令面板）：✅ 已删除（2025-12-18）。  
  - `lawclick-next/src/components/features/command-palette.tsx`
- `ChatInterface`：✅ 已删除（2025-12-18）。  
  - `lawclick-next/src/components/features/cws/chat-interface.tsx`
- `SimilarCases`：✅ 已删除（2025-12-18）。  
  - `lawclick-next/src/components/cases/similar-cases.tsx`
- `FirmOverview`：✅ 已删除（2025-12-18）。  
  - `lawclick-next/src/components/dashboard/firm-overview.tsx`
- 浮窗 `NOTES`：✅ 已移除窗口类型与占位渲染（2025-12-18）。  
  - `lawclick-next/src/components/layout/floating-layer.tsx`
  - `lawclick-next/src/store/float-store.ts`

---

## 4. TG1-TG12 一致性核对（高层结论）

> 判定口径：以 `@continue/01_核心架构与关键决策.md` 的“闭环要求/权限后端强校验/无空壳”为基准；以 `@continue/02_业务主线与模块现状（TG0-TG11）.md` 的主线回归脚本为验收路径；以 TG12 的“回归守门链路”作为最低运行门槛。

### 4.1 一致性基本面（总体向好）
- TG1（身份/权限）：middleware（`lawclick-next/src/proxy.ts`）负责登录态与页面级 gate；actions/API 层普遍存在 `getSessionUserOrThrow + requirePermission/requireCaseAccess` 的后端强校验思路，符合 TG1 原则。
- TG11（全局搜索/通知）：主入口保留 Header GlobalSearch + 通知闭环；已移除重复入口（命令面板挂载点），方向一致。
- TG12（统一回归）：已落盘 build/lint/route-audit/playwright/prisma validate 等证据，回归守门链路可复现。

### 4.2 明确的不一致/偏离（必须忠实记录）
1. **“无空壳/无假数据”与现状冲突**：`/settings`、`/profile` 在可达路径上存在大量硬编码与非闭环 UI，属于明确偏离。  
2. **TG7 子计划 vs 实际交付口径不完全一致**：TG7 子计划强调 `/dispatch` 的“待分配池/调度闭环”，但当前实现更接近“状态 + 泳道 + 邀请闭环”，对“分配”仅有 UI 选择与 toast（非落库动作）。该差异是否接受需由产品口径裁决，但工程上应留痕。  
   - 计划：`docs/TG7_日程安排_调度中心_子计划.md`
   - 验收：`docs/TG7_日程安排_调度中心_验收记录.md`
3. **工程质量门槛的策略性妥协**：ESLint 以“0 error”为目标对部分规则降级为 warning；该策略在 TG12 阶段合理，但必须被明确标记为“待清零的技术债”，否则会在 TG13+ 继续累积并反噬迭代效率。

---

## 5. 问题清单（可执行整改 Backlog）

> 标注：P0=红线/阻断可用性；P1=高风险不一致；P2=技术债/易腐点；P3=体验/规范问题。  
> 状态：本清单为“审计输出”，不自动代表已修复。

| ID | 优先级 | 问题 | 影响 | 证据（文件/入口） | 建议处置 |
|---|---:|---|---|---|---|
| LC-TG12-AUDIT-001 | P0 | `/settings` 空壳+假数据且可达 | 违反红线；误导用户；功能名义化 | `lawclick-next/src/components/layout/app-sidebar.tsx`、`lawclick-next/src/app/(dashboard)/settings/page.tsx` | 二选一：A) 补齐闭环（schema+action+落库+回读）；B) 直接 redirect/404 并移除导航入口 |
| LC-TG12-AUDIT-002 | P0 | `/profile` 存在硬编码项目与入口空壳 | 违反“无假数据”；名义功能 | `lawclick-next/src/components/profile/ProfileClient.tsx`、`lawclick-next/src/app/(dashboard)/profile/page.tsx` | 以真实数据替换（例如“我的案件/我的任务/我的工时”）；无闭环入口先隐藏/下线 |
| LC-TG12-AUDIT-003 | P1 | 侧边栏底部“设置与帮助”未按权限过滤 | UX 与权限策略不一致 | `lawclick-next/src/components/layout/app-sidebar.tsx`、`lawclick-next/src/lib/permissions.ts` | UI 层按 `canAccessPage` 过滤；并明确无权限提示策略 |
| LC-TG12-AUDIT-004 | P1 | `/research` 占位页可被直接访问 | 名义功能；影响产品可信度 | `lawclick-next/src/app/(dashboard)/research/page.tsx` | 若未进入 TG13+，建议 redirect 到 `/tools` 或隐藏路由（或加明确“不可用”状态页） |
| LC-TG12-AUDIT-005 | P2 | ESLint 269 warnings（any/unused-vars/hooks） | 长期侵蚀可维护性；隐藏真实 bug | `docs/_artifacts/lint_2025-12-17.txt` | 设定“按模块清零”里程碑；新增 CI gate（例如警告阈值上限逐步收紧） |
| LC-TG12-AUDIT-006 | P2 | 未挂载的 mock/占位组件仍存在 | 后续误接入会直接踩红线 | `lawclick-next/src/components/features/cws/chat-interface.tsx` 等 | 明确：删除/隔离到 prototype 目录/加注释与测试阻断（择一） |
| LC-TG12-AUDIT-007 | P2 | Playwright 输出存在 `ECONNRESET/aborted` 噪音 | 可能影响稳定性与排障效率 | `docs/_artifacts/playwright_2025-12-17.txt` | 排查 webServer 生命周期与日志管控；必要时调整 Playwright webServer 配置 |
| LC-TG12-AUDIT-008 | P3 | UI 文案中存在英文/乱码（如 Research 页） | 影响专业度与一致性 | `lawclick-next/src/app/(dashboard)/research/page.tsx`、`lawclick-next/src/app/(dashboard)/settings/page.tsx` | 统一为简体中文；清理乱码字符来源（复制粘贴/编码） |

---

## 6. 外部项目经验（MCP 参考结论摘要）

本轮参考了 Cal.com 的工程实践（DeepWiki）以对照“如何避免名义功能进入主干”：
- 强制后端校验与输入校验（server-side permission checks + schema validation）
- 通过 lint/type-check/test/E2E 在 CI 中卡住“空壳/不一致”进入主分支
- 建议本项目逐步引入类似 gate：对“可达页面”要求至少具备最小闭环（schema/action/落库/回读），否则必须 redirect/下线

> 参考来源：DeepWiki `calcom/cal.com`（问题：前后端一致性与防空壳的工程机制）

---

## 7. 下一步建议（面向“可完整运行”）

优先按 P0/P1 清理“红线违背与入口级不一致”，否则 TG13+ 的任何新功能都会被“产品可信度与维护成本”反噬：
1. 处理 `/settings` 与 `/profile`：要么补齐闭环，要么下线入口（推荐先下线，避免继续误导）
2. 设立 lint warning 清零计划（先 unused-vars + hooks，再 any）
3. 把“可达页面空壳检测”纳入守门（route-audit 的下一层：page-audit）

---

## 8. 2025-12-18 整改复验记录（闭环结果）

### 8.1 复验结论
- ✅ `next build`：通过（见 `docs/_artifacts/build_2025-12-18.txt`）
- ✅ ESLint：`0 errors / 0 warnings`（见 `docs/_artifacts/eslint_summary_2025-12-18.md` / `docs/_artifacts/eslint_2025-12-18.json`）
- ✅ Playwright：通过且无 `ECONNRESET/aborted` 噪音（见 `docs/_artifacts/playwright_2025-12-18.txt`）

### 8.2 Backlog 对照整改状态（逐项清零）

| ID | 状态 | 处置方式（与红线一致） | 证据 |
|---|---|---|---|
| LC-TG12-AUDIT-001 | ✅ 已清零 | `/settings` 下线为服务端重定向（避免可达空壳） | `lawclick-next/src/app/(dashboard)/settings/page.tsx` |
| LC-TG12-AUDIT-002 | ✅ 已清零 | `/profile` 改为真实数据闭环展示（移除硬编码“项目/组织/入口空壳”） | `lawclick-next/src/app/(dashboard)/profile/page.tsx` |
| LC-TG12-AUDIT-003 | ✅ 已清零 | 侧边栏入口按 `canAccessPage` 权限过滤，避免“可见但点了被拦截”的不一致 | `lawclick-next/src/components/layout/app-sidebar.tsx` |
| LC-TG12-AUDIT-004 | ✅ 已清零 | `/research` 下线为服务端重定向到 `/tools`（避免占位页可达） | `lawclick-next/src/app/(dashboard)/research/page.tsx` |
| LC-TG12-AUDIT-005 | ✅ 已清零 | ESLint warnings 全量清零（从 269 → 0） | `docs/_artifacts/eslint_summary_2025-12-18.md` |
| LC-TG12-AUDIT-006 | ✅ 已清零 | 删除未挂载 mock/占位组件与浮窗占位（避免未来误接入踩红线） | `lawclick-next/src/components/features/command-palette.tsx`（已删除）、`lawclick-next/src/components/features/cws/chat-interface.tsx`（已删除）、`lawclick-next/src/components/cases/similar-cases.tsx`（已删除）、`lawclick-next/src/components/dashboard/firm-overview.tsx`（已删除）、`lawclick-next/src/components/layout/floating-layer.tsx`、`lawclick-next/src/store/float-store.ts` |
| LC-TG12-AUDIT-007 | ✅ 已清零 | Playwright 输出噪音收敛（webServer 生命周期/日志） | `docs/_artifacts/playwright_2025-12-18.txt` |
| LC-TG12-AUDIT-008 | ✅ 已清零 | UI 英文/乱码集中清理并中文化 | `lawclick-next/src/app/(dashboard)/research/page.tsx`、`lawclick-next/src/app/(dashboard)/settings/page.tsx` |

> 备注：本表为“审计清单 → 整改闭环”的对照状态；不替代 TG12 的主线回归验收记录。
