# TG12｜极限标准审计（2025-12-19）

> 你指定的审计标准（极限）：  
> 1) **数据绝对真实 / 生产对齐**（严禁 mock/占位；全量 schema 校验；dev=prod 1:1）  
> 2) **拒绝空壳交付**（Tracer Bullet：UI→逻辑→持久化→错误处理必须贯通）  
> 3) **架构优先 + 过度设计 + 极致 DRY**（接口/抽象优先；零容忍重复）  
> 4) **防御性 + 强类型**（TS Strict；禁止 any；边界显式错误语义化）  
>
> 审计范围：仓库整体（重点：`lawclick-next/` Web 主工程）。  
> 证据包（本次新增）：`docs/_artifacts/extreme_audit_2025-12-19/`（ripgrep 输出、tsconfig 快照等）。  
> 备注：本报告按“极限标准”裁判，因此会刻意比常规工程标准更严苛；部分结论会指出与现有 TG0‑TG12 交付方式（尤其是 seed）存在原则冲突。

---

## 0. 先给结论（在极限标准下）

### 0.1 `lawclick-next/` 的结论
- **在“常规工程标准”下：主线可用**（此前已可复现 lint/type-check/build/migrate/seed/e2e）。
- **在“你指定的极限标准”下：不合格（存在 P0 级违背）**，核心原因集中在：
  1) **生产对齐不足**：存在“未配置即回退成功”的行为（邮件、S3 默认值等），会在生产误配置时表现为“看似正常、实际未达真实闭环”。  
  2) **全量输入校验缺失**：绝大多数 Server Actions 未做 Zod 等 runtime schema 校验，仅靠 TS 类型与局部 if 判断。  
  3) **仍存在“占位”业务记录**：阶段文书以 `fileUrl=''` / `fileType='pending'` 表达“待上传”，以及“智能起草生成，占位文档”的文字与空字段。  
  4) **强类型不达标**：`tsconfig.strict=false` 且代码中仍存在 `any` 与 eslint-disable。  

### 0.2 仓库整体的结论
- `apps/mobile/`：仅 `pubspec.yaml`，缺少 Flutter 最小工程骨架（如 `lib/main.dart`），**属于名义占位/空壳**。  
- 根目录 Rust（Axum/SeaORM）：可 `cargo check` 但大量 dead_code/unused，且 API 口径与 Web 主工程的 “Server Actions” 架构不一致，**易造成“名义有后端、实际不闭环”的认知混乱**。  

---

## 1. 标准 1｜数据绝对真实 / 生产对齐（Real-World Data / Production Parity）

### P0｜严禁 mock/占位 —— 当前存在违背

#### 1) 邮件：未配置密钥时“模拟发送且返回 success”
- 文件：`lawclick-next/src/lib/email.ts`
  - `RESEND_API_KEY` 缺失时回退 `ConsoleProvider`，并返回 `{ success: true }`。
- 在极限标准下，这等价于 **“生产误配置→系统仍宣称成功”**，属于“假闭环”。

#### 2) S3/MinIO：默认 endpoint/默认凭证 + catch-all 创建 bucket
- 文件：`lawclick-next/src/lib/s3.ts`
  - 默认 `endpoint=http://127.0.0.1:9000`、默认 `minioadmin/minioadmin`。
  - `ensureBucketExists()` 对任意 error 一律尝试创建 bucket（无法区分 NotFound vs AuthDenied vs 网络错误）。
- 在极限标准下，默认值与吞错会导致 **生产与开发不一致**，并可能掩盖真实故障。

#### 3) Prisma seed：生成“示例业务数据”本质是 mock data
- 证据：`docs/_artifacts/critical_audit_2025-12-19/prisma_db_seed.txt`
- 极限标准要求“禁止生成任何形式模拟数据”，因此现有 seed 策略与该标准**原则冲突**。  
  - 若要满足该标准，需要改为：**匿名化生产快照/脱敏导入**（或与生产同构的 staging 数据源），而不是脚本造数。

### P1｜真实脏数据/缺失字段/异常格式 —— 防御不足

#### 4) “待上传文书”用空字符串/魔法值表达（脏数据/异常格式）
- 文件：`lawclick-next/src/actions/stage-management.ts`（证据见 `docs/_artifacts/extreme_audit_2025-12-19/stage-management_placeholder_snippet.txt`）
  - `fileUrl: ''` + `fileType: 'pending'` 属于**哑值/占位符**，长期会污染查询与逻辑分支（需要处处特殊判断）。
- 在极限标准下，推荐改为**显式建模**：`Document.fileUrl` 允许 `null` 或引入 `DocumentStorageState` / `RequiredDocument` 独立表。

#### 5) 搜索/列表权限过滤使用 `id="__forbidden__"` 哑值
- 证据：`docs/_artifacts/extreme_audit_2025-12-19/rg_sentinel_placeholder_values.txt`
- 这属于“通过非法值制造空结果集”的技巧，在极限标准下应替换为：
  - 明确抛 `PermissionError`（或返回 `{ success:false, error:'...' }`），避免把权限问题伪装成“查无数据”。

---

## 2. 标准 2｜拒绝空壳交付（No Shells / Tracer Bullet）

### P0｜存在“接口可达但无闭环/无鉴权”的空壳风险

#### 1) `/api/queue/process`：可触发队列处理但无任何鉴权
- 文件：`lawclick-next/src/app/api/queue/process/route.ts`
  - middleware matcher 排除 `/api`，所以该 route 不受登录拦截。
  - 在极限标准下，属于“内部运维接口裸露”，且 queue 本身没有被业务触发（见下一条），因此是高风险空壳。

#### 2) Queue 系统：存在处理器占位（GENERATE_DOCUMENT/GENERATE_REPORT）且未接入业务
- 文件：`lawclick-next/src/lib/job-handlers.ts`（证据：`docs/_artifacts/extreme_audit_2025-12-19/rg_mock_placeholder_todo.txt`）
  - 明确 TODO/占位逻辑。
- 同时：未发现 `queue.enqueue()` 的实际调用（意味着“看似有系统，实际上不使用”）。

### P1｜仓库层面的空壳/名义交付
- `apps/mobile/`：当前不可运行 Flutter 工程（仅 pubspec）。
- 根目录 Rust：`cargo check` 有大量 unused/dead_code（更像规划/试验而非闭环服务）。

---

## 3. 标准 3｜架构优先 + 过度设计 + 极致 DRY（Architecture First）

> 这一标准与当前主线（以 Next Server Actions + Prisma 为核心）存在方法论差异：当前实现更偏“可落地闭环”，而非“接口/抽象优先 + 过度设计”。

### P1｜缺少“接口隔离层”（对未来扩展不友好）
- AI：虽有 `provider/model` 字段，但 `ai-actions.ts` 仍强绑定 OpenAI SDK，未抽象 `AIProvider` 接口（多模型/多供应商扩展会侵入业务层）。
- 存储：`s3.ts` 暴露具体 `S3Client`，缺少 `StorageProvider` 抽象（未来迁移到真实 S3/OSS/私有存储会扩散改动）。
- 数据访问：actions 内普遍直接使用 Prisma（缺少 Repository/Service 接口），导致权限/事务/错误处理模式在多处重复。

### P2｜DRY 零容忍下的重复实例（当前不满足）
- 常量重复：`POSITION_GAP=1024` 同时存在于服务端与前端（证据：`docs/_artifacts/extreme_audit_2025-12-19/rg_position_gap_duplicates.txt`）。
- Case 可见性过滤（`originator/handler/members`）在多个 actions 内重复拼接（例如 `cases.ts`、`search-actions.ts` 等）。

---

## 4. 标准 4｜防御性 + 强类型（Defensive & Strict Typing）

### P0｜TS Strict 未开启
- 文件：`lawclick-next/tsconfig.json`（证据：`docs/_artifacts/extreme_audit_2025-12-19/lawclick-next_tsconfig.json`）
  - `"strict": false` 直接违背“类型洁癖/最严格静态检查”。

### P0｜存在 `any` 与 eslint-disable
- 证据：`docs/_artifacts/extreme_audit_2025-12-19/rg_any_usage.txt`、`docs/_artifacts/extreme_audit_2025-12-19/rg_no-explicit-any_disables.txt`
- 典型位置：
  - `lawclick-next/src/components/admin/FinanceCenterClient.tsx`（`invoices/expenses/contracts/stats: any`）
  - `lawclick-next/src/actions/approval-actions.ts`（`metadata: Record<string, any>`）
  - `lawclick-next/src/components/admin/ApprovalsBoardClient.tsx`、dashboard widgets 等

### P1｜“全量 Schema 校验”明显不足（多数 actions 无 runtime 校验）
- 证据矩阵：`docs/_artifacts/extreme_audit_2025-12-19/actions_safeparse_matrix.txt`
  - 仅 `auth.ts / register.ts / tasks.ts / timelogs.ts / members.ts` 有 `safeParse`。
  - 关键主线 actions（`cases-crud.ts / tasks-crud.ts / timelogs-crud.ts / documents.ts / event-actions.ts / finance-actions.ts / tool-actions.ts / ai-actions.ts / ...`）主要依赖 TS 类型与局部 if，并未做 Zod/Pydantic 式严格拒绝。

### P1｜存在“吞异常/空 catch”
- 证据：`docs/_artifacts/extreme_audit_2025-12-19/rg_empty_catch.txt`
- 典型位置：
  - `lawclick-next/src/components/layout/app-sidebar.tsx`：localStorage 持久化失败被静默吞掉。
  - `lawclick-next/src/components/layout/app-header.tsx`：清理 localStorage 失败被静默吞掉。
- 在极限标准下，哪怕是客户端 localStorage 也应：至少记录结构化错误或上报（并区分 Quota/禁用等）。

### P2｜Schema 与真实枚举不一致（会产生脏数据）
- `lawclick-next/src/lib/schemas.ts` 的 `CreateTaskSchema.priority` 包含 `"URGENT"`，但 Prisma `TaskPriority` 为 `P0_URGENT/P1_HIGH/...`（存在类型/校验口径漂移风险）。

---

## 5. 建议整改路线（按“极限标准”排序）

### 5.1 P0 优先（先消除“假闭环/生产误配置不报错”）
1. 邮件：移除 `ConsoleProvider` 的 “success=true” 回退；生产缺配置直接失败（dev 也应失败或显式模拟标志位）。  
2. S3：移除默认 endpoint/凭证；`ensureBucketExists` 仅在明确 NotFound 时创建 bucket，并对其它错误显式失败。  
3. TS：开启 `strict=true` + 清理所有 `any`/eslint-disable（先从 admin/finance/approvals/widgets 开始）。  
4. `/api/queue/process`：加鉴权（至少 admin 权限 + CSRF/secret），或直接下线直到真正接入。  

### 5.2 P1（全量校验 + 去占位）
1. 为所有 Server Actions 定义 Zod schema（输入 + 关键输出），拒绝隐式信任。  
2. 把“待上传文书/占位文档”改为显式建模（允许 null/独立表/状态机），避免空字符串哑值。  
3. 统一错误模型：禁止 catch 后返回空数组伪装成功；改为 `{ success:false, code, message }` 并在 UI 处理。  

### 5.3 P2（过度设计/DRY）
1. 抽象 Provider：`AIProvider` / `StorageProvider` / `EmailProvider` / `NotificationProvider`（并引入依赖注入或工厂）。  
2. 抽象 Repository/Domain Service：统一 case 可见性过滤、权限校验、事务包装、错误映射。  
3. 提取共享常量与排序算法（例如 `POSITION_GAP`）为单一真源（server/client 共用模块）。  

---

## 6. 证据索引（本次）

- 代码扫描：
  - `docs/_artifacts/extreme_audit_2025-12-19/rg_mock_placeholder_todo.txt`
  - `docs/_artifacts/extreme_audit_2025-12-19/rg_sentinel_placeholder_values.txt`
  - `docs/_artifacts/extreme_audit_2025-12-19/rg_any_usage.txt`
  - `docs/_artifacts/extreme_audit_2025-12-19/rg_no-explicit-any_disables.txt`
  - `docs/_artifacts/extreme_audit_2025-12-19/actions_safeparse_matrix.txt`
  - `docs/_artifacts/extreme_audit_2025-12-19/rg_empty_catch.txt`
  - `docs/_artifacts/extreme_audit_2025-12-19/lawclick-next_tsconfig.json`
- 运行证据（复用此前）：`docs/_artifacts/critical_audit_2025-12-19/`

---

## 7. 整改后复验（2025-12-19 → 2025-12-20）

> 本节为整改闭环补充：不改动上方“当时审计快照”的结论与措辞，只记录整改后状态、对应改动与证据位置。

### 7.1 复验结论
- `lawclick-next/`：本报告列出的 **P0 级违背已清零**；目前以“真实数据/显式失败/强类型/全量输入校验”为硬门槛，可作为 Web 主线继续推进。
- 残留风险（不属于本轮阻断项）：Prisma 5→7 升级窗口、根目录 Rust 原型的边界治理、移动端（本轮忽略）。

### 7.2 关键问题对照（已修复）
1. 邮件未配置仍回退 success → `lawclick-next/src/lib/email.ts`：未配置直接 `success:false`；`NEXTAUTH_URL` 无效直接失败。
2. S3 默认值/吞错 → `lawclick-next/src/lib/s3.ts`：强制 env schema；仅 NotFound 才创建 bucket；新增 `StorageProvider` 抽象。
3. Prisma seed 造数（synthetic）→ `lawclick-next/prisma/seed.ts`、`lawclick-next/prisma/seed.js`：默认拒绝造数，改为导入脱敏生产快照；`lawclick-next/package.json` seed 指向 `seed.js`。
4. 阶段文书哑值占位（`fileUrl:''`/`pending`）→ `lawclick-next/src/actions/stage-management.ts`：改为 `fileUrl/fileType = null`，并补齐输入校验。
5. 权限过滤哑值（`__forbidden__`）→ `lawclick-next/src/lib/server-auth.ts` 等：改为显式 where/null/throw，避免“权限问题伪装成查无数据”。
6. `/api/queue/process` 裸露 → `lawclick-next/src/app/api/queue/process/route.ts`：增加 secret header 或 admin 权限门禁。
7. Queue 空壳（无业务调用/占位 handler）→
   - `lawclick-next/src/lib/notifications.ts`：新增 `notifyUsersWithEmailQueue`，在案件/任务/邀请/成员通知场景同步写入 `TaskQueue.SEND_EMAIL`（队列开始被业务真实使用）。
   - `lawclick-next/src/lib/job-handlers.ts`、`lawclick-next/src/lib/queue.ts`：移除未实现的 `GENERATE_*` job 类型，避免名义交付。
8. TS strict/any/禁用 → `lawclick-next/tsconfig.json`：`strict:true`；主线清理 `any` 与相关 eslint disable。
9. Schema 漂移（TaskPriority）→ `lawclick-next/src/lib/schemas.ts`：priority 与 Prisma 枚举对齐。
10. “吞异常” → `lawclick-next/src/components/layout/app-sidebar.tsx`、`lawclick-next/src/components/layout/app-header.tsx`：catch 记录结构化 warn（不再静默）。

### 7.3 复验证据（整改后）
- 复验输出统一落盘：`docs/_artifacts/tg12_remediation_2025-12-19/`（含 lint/type-check/build/test/route-audit 与扫描快照）。
- 整改闭环总览：`docs/TG12_极限标准整改闭环_2025-12-19.md`
