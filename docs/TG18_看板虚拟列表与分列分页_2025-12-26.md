# TG18｜看板虚拟列表与分列分页｜2025-12-26

> 目标：把“看板超量”从 **TG17 的“显式提示 + 可切换分页列表（避免静默截断）”**，升级为 **看板自身可无限量可用**：
> - **按列分页增量加载**（真实从 DB 分页取数、可回读、无 Mock）
> - **虚拟列表渲染**（大数据量不掉帧）
> - **拖拽/排序真实落库**（ordered board 的排序语义严格、不做“看起来对”的假排序）
>
> 范围：`lawclick-next/`（Next.js App Router + Prisma）主线。

---

## 1) REAL/PERFECT 定义（本 TG 口径）

- **REAL**：UI → Server Action → Prisma → DB 全链路闭环；数据来自真实 DB；所有输入有 Zod 校验；错误不吞；权限/tenant 过滤在服务端执行。
- **PERFECT（本 TG）**：在任务量上千时仍可用、不卡顿、不静默截断，并能解释“当前已加载多少/总数多少/是否可继续加载”。

---

## 2) 关键改造点

### 2.1 服务端：看板按列计数 + 分页取数（真实 DB）

- 新增看板专用入口（避免一次性全量拉取）：
  - `getAccessibleTaskKanbanStatusCounts`：按 `status` groupBy 得到每列真实数量 + total
  - `getAccessibleTaskKanbanStatusPage`：按列分页 `skip/take(+1)`，返回 `hasMore`
- 统一看板 select（避免多处 select 漏字段/不一致）。
- 限制策略：`KANBAN_COLUMN_TAKE_DEFAULT / KANBAN_COLUMN_TAKE_MAX`（只影响单次分页大小，不是静默截断；`hasMore=true` 时 UI 必须可继续加载）。

关键实现：
- `lawclick-next/src/actions/tasks-crud.ts`
- `lawclick-next/src/lib/query-limits.ts`

### 2.2 前端：remote 模式 + 虚拟列表 + DnD 兼容

- `TaskKanban` 新增 `dataMode="remote"`：
  - 首次加载：counts + 每列第 1 页
  - 滚动触底/按钮：按列继续加载（合并去重，保持一致性）
  - 列头展示：`已加载/总数`，并在加载中展示 spinner
- 虚拟列表：使用 `react-window` v2 `List`，每列只渲染可视范围 + overscan
- DnD：使用 `@hello-pangea/dnd` 的 virtual list 模式（`mode="virtual" + renderClone`），并通过 `isUsingPlaceholder` 让虚拟列表多渲染一行占位，避免拖拽时高度错乱。

关键实现：
- `lawclick-next/src/components/tasks/TaskKanban.tsx`
- `lawclick-next/src/lib/ui/use-element-size.ts`

### 2.3 有序看板的真实性：未全量加载也可拖拽排序（服务端补齐邻居）

- 对 **ordered board**（`caseId`/`projectId`）：
  - 允许在 `hasMore=true` 的情况下继续拖拽排序；
  - 当客户端仅能提供 `beforeTaskId` 或 `afterTaskId` 时，服务端会在同列内**自动查询相邻任务（predecessor/successor）**来补齐 `prev/next`，并在必要时触发局部重排（gap 重建），以保证最终排序语义真实。
- 对 **全局看板**（`/tasks`，非 ordered）：
  - 允许跨列移动（不依赖列内 order 的完整 before/after 语义）。

---

## 3) 覆盖到的链路（强调“连通性”）

- **案件详情 → 任务 Tab**：`CaseTaskKanban` 改为直接使用 `TaskKanban(dataMode="remote")`，任务量增大仍可流畅使用。
  - `lawclick-next/src/components/cases/CaseTaskKanban.tsx`
- **项目详情 → 任务模块**：项目看板改为 remote（按列分页 + 虚拟渲染），确保“项目创建 → 任务创建 → 项目看板/任务中心可回读”。
  - `lawclick-next/src/components/projects/ProjectTasksPanelClient.tsx`
- **任务中心 `/tasks`**：看板视图改为 remote（按列分页 + 虚拟渲染），避免一次性全量渲染导致卡顿。
  - `lawclick-next/src/app/(dashboard)/tasks/page.tsx`

补充（性能一致性）：
- 案件列表/详情不再 include 全量 tasks：通过 groupBy 计算任务进度 + intake 分屏提供 open tasks 预览，避免大任务量拖慢页面。
  - `lawclick-next/src/actions/cases.ts`
  - `lawclick-next/src/lib/cases/case-detail-view-model.ts`

---

## 4) 可复验证据（门禁全绿）

证据目录（v2，门禁全绿）：`docs/_artifacts/tg18_kanban_virtual_2025-12-26_v2/`

- `pnpm_lint.txt`
- `pnpm_typecheck.txt`
- `pnpm_build.txt`
- `pnpm_route_audit.txt`
- `pnpm_test.txt`
