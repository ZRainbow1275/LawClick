# 律时（LawClick / LegalTime）1211 架构落地开发总计划 v1

## 文档信息
- 版本：v1.0
- 创建日期：2025-12-12
- 作者：Codex 架构代理（GPT‑5.2）
- 适用代码基线：`lawclick-next/`（Next.js 全栈主工程）
- 约束来源：`prompt/1211架构设计.md`、`.agent/rules/lawclick.md`、`docs/LegalMind设计语言规范.md`
- 目标读者：后续所有开发者/架构代理（保证中断后可续写）

---

## 0. 背景与总体目标
当前律时项目存在大量“空壳/假数据/断链路”问题（案件、任务、计时、文档、仪表盘等均未形成真实闭环）。本计划旨在：
1. 以 **案件/项目工作流** 为第一性主线，按主次分模块端到端补齐血肉。
2. 严格遵循 **MDI + LEGO** 架构与 **无前端不后端/无假数据** 原则。
3. 建立可持续的本地真实数据与验证体系，保证每个模块完整可用。

**第一性目标（唯一正确的北极星）**：
- 让律师能在系统内完成从收案到归档的全流程协作（案件 → 任务 → 计时 → 文档 → 日程/看板），并在仪表盘中实时可视化。

---

## 1. 现状基线（基于 lawclick-next 代码）
### 1.1 数据层（Prisma + Postgres）
- `lawclick-next/prisma/schema.prisma` 已包含核心领域模型与枚举：
  - 主业务流：`Case`、`CaseTemplate`、`CaseMember`、`Party`、`ConflictCheck`
  - 协作/执行：`Task`、`TimeLog`、`Event`
  - 文档：`Document`
  - 辅助模块：`Contact/CRM`、`Approval`、`Invoice/Expense/Finance`、`ToolModule`、`AIConversation` 等
- `lawclick-next/docker-compose.yml` 提供：Postgres(5434) + MinIO。

### 1.2 业务逻辑层（Server Actions）
- `lawclick-next/src/actions/` 已存在大量 CRUD/业务 actions：
  - 案件：`cases-crud.ts`、`cases.ts`、`party-actions.ts`、`stage-management.ts`、`timeline-actions.ts`
  - 任务/看板：`tasks-crud.ts`、`collaboration-actions.ts`
  - 计时：`timelogs-crud.ts`
  - 文档：`document-actions.ts`
  - 日程：`event-actions.ts`
  - 其他：`customer-actions.ts`、`finance-actions.ts`、`approval-actions.ts`、`ai-actions.ts` 等
- 说明：业务底座基本齐全，但“UI 入口/路由/绑定/权限/状态机”未形成稳定闭环。

### 1.3 UI/路由层（Next.js App Router）
- `lawclick-next/src/app/(dashboard)/` 下已有主要页面骨架：`/cases`、`/tasks`、`/time`、`/documents`、`/contacts`、`/chat`、`/dashboard`、`/dispatch`、`/calendar` 等。
- 关键缺口：
  1. 多处按钮/入口未与 actions 真实绑定（如“新建案件”无响应）。
  2. 详情子页路由/数据缺失导致报错（案件详情的设置/任务/当事人/文书/时间线/账务等）。
  3. 仪表盘/看板/调度中心仍是静态或假数据，且缺少 MDI/DIY 持久化能力。

---

## 2. 硬性架构与开发守则（不可违背）
### 2.1 MDI + LEGO UI（强制）
- 所有“工作台类主页面”必须基于 MDI 多文档界面底座：
  - 支持 **拖拽/停靠/分屏/多窗口**（参考 `react-grid-layout` 或 `golden-layout` 逻辑）。
  - 统一 **Z-index / Focus / Window Manager**。
  - 所有组件支持 **Container Queries (`@container`)**，以 Bento/LEGO 方式自适应。
- 用户可自定义组件组合与布局，**布局/开关/泳道等配置必须序列化到数据库**，跨设备一致。

### 2.2 无前端不后端 / 无假数据
- 任意 UI 表单/功能改造必须同时具备：
  1. **Schema 校验/扩展**（`schema.prisma`）
  2. **Server Action / API Handler**
  3. **真实数据基线（脱敏快照导入）/迁移策略**
  4. **UI 真实数据绑定与提交**
- 禁止 Mock/静态演示数据；所有列表/仪表盘/看板必须来自 Postgres。

### 2.3 权限与身份统一
- 权限校验必须落在 actions/API 层（含行级可见性 RLS 设计），UI 只做展示兜底。
- 角色层级按 `Role` 与业务域统一，避免“多身份多权限不一致”。

### 2.4 设计语言与体验
- 视觉、排版、间距、动效完全遵循 `docs/LegalMind设计语言规范.md`。
- 目标质感：Premium SaaS（Linear/Raycast/Figma 级别），信息密度适中、卡片化、积木感强。

---

## 3. DID 执行模板（每个模块必须按此走）
**DID = Design（设计/领域）→ Implement（实现/集成）→ Deliver（交付/验证）**

- **Design‑1 领域澄清**：对齐 1211 文档业务流/角色/边界，列出功能清单与不做项。
- **Design‑2 数据与接口设计**：
  - 核对/补齐 `schema.prisma` 字段与约束；
  - 定义 actions/API（入参/出参/权限点/错误码）；
  - 设计数据基线（脱敏生产快照导入）与迁移策略；
  - 输出 `docs/TGx_子计划.md`。
- **Implement‑1 后端实现**：先 actions/API + 状态机 + 权限，再写最小单元测试。
- **Implement‑2 UI 实现**：基于 MDI 容器拆 LEGO 组件并绑定真实数据。
- **Deliver‑1 浏览器验收**：按固定脚本操作，截图+记录问题。
- **Deliver‑2 文档归档**：更新对应 TG 的“验收记录/变更日志”。

**产出物**：子计划、schema/action/UI/测试/验收清单，缺一不可。

---

## 4. 模块优先级与任务组（Task Groups）
> 主模块围绕“案件/项目工作流”，其余模块作为辅助；按主次顺序推进。

### TG0 基础设施对齐（Phase1）
**目标**：建立真实数据库基线，消除“空壳/假数据”根因。
- 子任务：
  1. 检查 Docker Postgres/MinIO 启动与 `DATABASE_URL` 联通。
  2. 复核当前 Prisma migrations；必要时补齐迁移。
  3. 提供“脱敏生产快照”导入工具链（`restore:snapshot`），并以 `prisma db seed` 作为守门提示（禁止任何 synthetic 造数）。
- 验收：
  - 本地一键启动 DB + `migrate deploy` + 导入脱敏快照后，`/dashboard`、`/cases`、`/tasks`、`/time`、`/documents` 均有真实数据可见。

### TG1 身份/权限体系统一（Phase1‑2）
**目标**：统一律所/角色/外部主体与行级权限。
- 范围：用户角色层级、案件成员权限、数据可见性。
- 子任务：
  1. 复核 `User/Role` 与 1211 的身份矩阵；若需“律所/组织(Firm)”模型，补充最小可行版。
  2. 在 actions 层统一 `requireRole/requireCaseAccess` 等权限中间件。
  3. 设计并预留 RLS 方案（以 tenantId + caseMembership 为主）。
- 验收：
  - 不同 Role 访问案件/任务/文档时权限正确，无越权。

### TG2 案件主业务流端到端（首个里程碑，Phase1‑4）
**目标**：打通“新建案件 → 列表/详情/仪表盘/看板/计时/文档联动”的真实闭环。

**Phase1_Analysis & Schema**
1. 复核 `Case/CaseTemplate/CaseMember/Party/ConflictCheck` 字段与 1211 业务流（收案接洽、立案、庭前、庭审、结案、归档）。
2. 明确 `CaseStatus` 与 `currentStage` 的状态机迁移表（允许/禁止的流转）。
3. 定义 `CaseTemplate.stages/requiredDocs/defaultTasks` JSON 结构规范，并确保可在真实数据基线（脱敏快照）或管理能力中落库（禁止 seed 造数）。

**Phase2_Core Logic**
1. 校验/补齐 `cases-crud.ts`：
   - updateCase（基本信息/模板/阶段）
   - changeStatus（含合法迁移校验）
   - archiveCase（归档与只读保护）
   - add/removeMember（团队）
   - upsertParties（当事人）
2. 对接 `stage-management.ts`/`timeline-actions.ts` 形成阶段‑任务‑文书‑时间线联动。
3. Jest 单元测试覆盖：
   - 案号生成、冲突审查、状态流转、权限控制。

**Phase3_UI**
1. `/cases` 列表页：
   - 真实绑定 `getCases`，支持 query/status/type 过滤。
   - 修复“新建案件”入口：用 MDI 子窗口/弹窗承载创建表单，提交 `createCase`。
   - 列表字段按 1211：名称、案号、类型、主办/协办、金额、创建时间、进度、标签、备注。
2. `/cases/[id]` 详情页：
   - 构建 MDI 多面板：概览、设置、任务、当事人、文书/档案、时间线、账务、计时。
   - 修复所有子页报错（缺路由/缺数据/缺 actions 绑定）。
3. 左侧导航：
   - “我的案件”始终到 `/cases`（非空）；“立案侦查/INTAKE”作为案件详情或列表的子入口。
4. UI/UX：信息密度、字体间距、卡片积木感、动效对齐设计语言。

**Phase4_Browser Verification**
1. 以 Lawyer A 登录：新建案件 → 进入详情 → 添加任务/文书/计时 → 返回 `/dashboard`、`/dispatch`、看板确认同步。
2. 截图与问题记录到 `docs/v9_enhancement_log.md`（或新建 TG2 验收记录）。

**验收标准**
- 新建案件真实落库，刷新/重登仍存在。
- 案件详情全部 Tab 可访问且无报错。
- 仪表盘/看板/计时/文档模块能看到该案件的联动数据。

### TG3 任务协作 + Trello式看板（Phase1‑4）
**目标**：案件/未来项目的任务拆分与协作看板闭环。
- 子任务：
  1. 复核 `Task` 字段（swimlane/order/checklist/stage/taskType）满足看板需要；必要时补最小字段。
  2. 校验/补齐 `tasks-crud.ts`（增删改查、泳道/排序、批量移动、权限）。
  3. `/tasks` 页面改造为 MDI 看板：
     - 按案件/阶段/泳道分组
     - 支持拖拽排序、批量指派
  4. 与日历/计时联动：任务可直接生成日程/计时。
- 验收：任务在看板‑日历‑计时三处一致，跨刷新保持排序/泳道。

**状态**：已完成（2025-12-12）
- 新增通用 `TaskKanban`（`@hello-pangea/dnd`）并在案件详情/全局任务中心复用，支持列内排序与跨列拖拽落库。
- `tasks-crud.ts` 扩展 `reorderTasks`（order/status/swimlane/stage），`createCaseTask` 按列取 max(order)，`getCaseTasksByStatus` 补权限校验。
- `/tasks` 页面移除 mock，列表/看板真实化；任务卡片提供“计时/日程”最小联动入口。

**补充：看板对齐增强（参照 Focalboard / Planka）已完成（2025-12-12）**
- 子计划文档：`docs/TG3_看板对齐增强（参照Focalboard_Planka）_子计划.md`
- 排序机制升级：新增 `moveTaskOnKanban`（position/gap + 必要时局部 reindex），减少整列 renumber 写放大。
- 交互增强：案件看板列头支持快速新建（Add card），卡片详情弹窗支持编辑/删除并真实落库。
- 体验增强：拖拽成功提供“撤销”，失败自动回滚；全局任务中心看板禁用同列手动重排，仅保留跨列状态移动（避免跨案件 order 语义混乱）。

### TG4 计时追踪（Phase1‑4）
**目标**：工时必须绑定任务/案件，可用于复盘与计费。
- 子任务：
  1. 校验 `TimeLog` 与 `Task/Case` 关联；完善 `timelogs-crud.ts` 的开始/暂停/完成/审批流。
  2. `/time`、`/timelog` 页面 MDI 化：支持从任务/案件一键开计时。
  3. 仪表盘/案件详情展示计时动态与统计。
- 验收：任一计时记录均能回溯到案件/任务，统计正确。

**状态**：已完成（2025-12-13）
- 子计划文档：`docs/TG4_计时追踪_子计划.md`
- 验收记录：`docs/TG4_计时追踪_验收记录.md`

### TG5 文档中心（Phase1‑4）
**目标**：文档即业务，必须围绕案件阶段与模板。
- 子任务：
  1. 校验 `Document` 字段（version/tags/summary/权限/阶段文书）与模板联动。
  2. 打通 MinIO 上传/下载/预览/版本链。
  3. `/documents`、`/documents/[id]` MDI 化：管理页+详情实时编辑工作台。
  4. 文档权限与审计（下载/分享/保密）。
- 验收：文档可上传‑预览‑编辑‑版本回滚‑权限控制全链路可用。

**状态**：已完成（2025-12-13）
- 子计划文档：`docs/TG5_文档中心_子计划.md`
- 验收记录：`docs/TG5_文档中心_验收记录.md`

### TG6 仪表盘 MDI/DIY（Phase3‑4）
**目标**：仪表盘不是静态页面，而是可DIY的工作台。
- 子任务：
  1. 新增最小 DashboardConfig/WidgetLayout 数据模型（若现有 schema 无对应）。
  2. 实现 MDI 容器 + LEGO 组件注册中心（Schedule/Time Tracking/Kanban/Stats 等）。
  3. 用户拖拽/开关/布局保存到 DB；跨端恢复。
  4. 修复工具栏收缩后的自适应与字体密度问题。
- 验收：不同用户可保存不同仪表盘布局，刷新/换机一致。

**状态**：已完成（2025-12-13）
- 子计划文档：`docs/TG6_仪表盘_MDI-DIY_子计划.md`
- 验收记录：`docs/TG6_仪表盘_MDI-DIY_验收记录.md`

### TG7 日程安排 & 调度中心（Phase3‑4）
**目标**：全所视角的时间与协作调度平台。
- 子任务：
  1. 复核 `Event` 与 Case/Task 关联；支持批量/泳道视图。
  2. `/calendar`、`/dispatch` 页面按飞书日历 + Trello 调度方式重构（虚拟列表/分页支持30‑300人）。
  3. 人员状态（UserStatus）与协作邀请联动。
- 验收：全所日程与人员状态可视化，操作流畅。

**状态**：已完成（2025-12-14）
- 子计划文档：`docs/TG7_日程安排_调度中心_子计划.md`
- 验收记录：`docs/TG7_日程安排_调度中心_验收记录.md`

### TG8 行政ERP/OA、客户管理（Phase3‑4）
**目标**：参考成熟ERP流程，确保与案件/项目联动。
- 说明：优先做最小闭环（审批‑费用‑发票‑合同），并预留 AI 自动填报 hooks。

**状态**：已完成（2025-12-14）
- 子计划文档：`docs/TG8_行政ERP-OA_客户管理_子计划.md`
- 子模块计划（案件账务联动）：`docs/TG8_案件账务联动_子计划.md`
- 验收记录：`docs/TG8_行政ERP-OA_客户管理_验收记录.md`

### TG9 AI 模块 & 工具箱（最后落地）
**目标**：AI 驱动文书/项目/ERP/工作台；工具箱开放 N8N 扩展。
- 说明：AI 最后做，但所有模块前期需预留可调用点与上下文（caseId/documentId/userId）。

**状态**：已完成（2025-12-14）
- 子计划文档：`docs/TG9_AI模块_工具箱_子计划.md`
- 验收记录：`docs/TG9_AI模块_工具箱_验收记录.md`

### TG10 统一检验与纠错（入口级空壳清理）
**目标**：统一回归关键业务流并清理遗留 mock/空壳，确保系统具备“可登录、可新建案件、可沟通协作”的最小完整形态。
- 子任务：
  1. Header 登录态/退出登录统一到 NextAuth，移除 mock 用户与伪造面板数据；
  2. Dashboard 新建案件入口切换为真实 `CreateCaseWizard`；
  3. 消息沟通（Chat）新增 Schema + Actions + `/chat` + 浮窗，并与案件创建/成员变更联动。

**状态**：已完成（2025-12-14）
- 子计划文档：`docs/TG10_统一检验与纠错_子计划.md`
- 验收记录：`docs/TG10_统一检验与纠错_验收记录.md`

### TG11 全局搜索 / 通知闭环（清理剩余空壳入口）
**目标**：把 Header 的“全局搜索/通知”从空壳改为真实后端闭环，并将通知触发点绑定到案件业务流（案件/任务/协作/聊天）。
- 子任务：
  1. Prisma 新增 `Notification`（落库、未读统计、actor/metadata）并补齐 migration；
  2. 实现 `globalSearch` 聚合查询（Case/Task/Document/Contact）并做权限过滤；
  3. 通知 Server Actions：列表/未读数/标记已读；
  4. 触发点覆盖：新消息、案件分配/成员加入、任务分配、协作邀请与回执；
  5. Header UI 真接入 + 新增 `/notifications` 通知列表页；跳转闭环（`/chat?threadId`、`/cases/:id?tab=`）。

**状态**：已完成（2025-12-14）
- 子计划文档：`docs/TG11_全局搜索_通知闭环_子计划.md`
- 验收记录：`docs/TG11_全局搜索_通知闭环_验收记录.md`

---

## 5. 跨模块公共能力
1. **MDI Window Manager**：统一窗口容器、Dock/Float、Focus/Z-index、Layout 序列化。
2. **LEGO 组件注册中心**：组件元数据（title/icon/minSize/permissions/dataSource）。
3. **统一搜索/过滤**：跨 Case/Task/Document/Contact。
4. **通知与审计日志**：关键动作可追溯。
5. **文件存储适配层**：MinIO presign、权限校验、断点续传预留。

---

## 6. 测试与质量策略
- 单元测试：覆盖 actions 层关键业务（案件状态机、权限、计费、冲突审查）。
- E2E（Playwright）：TG2/TG3/TG6 核心路径。
- 质量门禁：`lint`、`type-check`、`test` 通过后方可进入下一 TG。

---

## 7. 风险与对策
- **Schema 与 UI 不一致**：每 TG Phase1 必做 Schema Review + DB 真链路验证（快照导入或真实操作产生数据）。        
- **MDI 复杂度高**：先实现最小闭环容器，再逐步增强。
- **大规模团队性能**：看板/调度中心采用虚拟列表、分页与懒加载。
- **AI 最终接入风险**：前期全部模块保留“AI 上下文/任务队列/触发点”。

---

## 8. 执行约定（保证连续性）
1. **每个 TG 开工前**必须在 `docs/` 下新增 `TGx_子计划.md`（按 DID 模板输出），经确认后再写代码。
2. **每个 TG 完成后**必须产出“验收记录 + 截图/日志 + 变更摘要”。
3. 开发过程中如出现“空壳/假数据”反馈，立即回退到 TG0/Phase1 基础设施排查。

---

## 9. 变更记录
- v1.0（2025‑12‑12）：基于 1211 架构设计与 lawclick-next 基线制定总计划。
