# 批判性项目审计报告 (2025-12-29)

> **审计范围**: `lawclick-next/`（Next.js全栈主工程）+ 根目录 Rust 后端  
> **审计日期**: 2025-12-29  
> **审计目的**: 批判性检视项目是否满足 TG0-TG12 子计划要求，识别功能缺失、前后端不一致、组件冗余、mock 数据残留等问题  
> **基准文档**: `prompt/1211架构设计.md`、`.agent/rules/lawclick.md`、各 TG 子计划文档

---

## 📋 审计结论概要

### ✅ 工程健康状态（Pass）

| 检查项 | 状态 | 备注 |
|--------|------|------|
| `tsc --noEmit` | ✅ 通过 | 无 TypeScript 类型错误 |
| `pnpm lint` | ✅ 通过 | 0 errors，0 warnings |
| `pnpm build` | ✅ 通过 | Next.js 16.0.6 (Turbopack) 构建成功 |
| Prisma Schema | ✅ 健全 | 1836 行，涵盖完整业务领域 |

### 📊 TG 子计划完成状态

| TG | 名称 | 状态 | 验收记录 |
|----|------|------|----------|
| TG0 | 基础设施对齐 | ✅ 已完成 | 极限标准复核 2025-12-19 |
| TG1 | 身份权限体系统一 | ✅ 已完成 | 验收结果记录于子计划 |
| TG2 | 案件端到端闭环 | ✅ 已完成 | 验收结果记录于子计划 |
| TG3 | 任务协作与Trello看板 | ✅ 已完成 | 含看板对齐增强 |
| TG4 | 计时追踪 | ✅ 已完成 | 验收记录存在 |
| TG5 | 文档中心 | ✅ 已完成 | 验收记录存在 |
| TG6 | 仪表盘MDI-DIY | ✅ 已完成 | 验收记录存在 |
| TG7 | 日程安排调度中心 | ✅ 已完成 | 验收记录存在 |
| TG8 | 案件账务联动 | ✅ 已完成 | 验收记录存在 |
| TG9 | AI模块工具箱 | ✅ 已完成 | 验收记录存在 |
| TG10 | 统一检验与纠错 | ✅ 已完成 | 验收记录存在 |
| TG11 | 全局搜索通知闭环 | ✅ 已完成 | 验收记录存在 |
| TG12 | 统一回归与纠错v2 | ✅ 已完成 | 批判性审计问题已清零 |

---

## 一、架构与设计一致性分析

### 1.1 与 1211 架构设计的对齐程度

#### ✅ 已满足的核心要求

1. **MDI 多文档界面架构**
   - 仪表盘支持 `react-grid-layout` 实现拖拽布局
   - 布局配置持久化到 `DashboardLayout` 表
   - 浮窗系统（Timer/Chat/AI）已实现并可独立控制

2. **无前端不后端原则**
   - 核心业务均有 Server Actions 实现
   - `src/actions/` 目录包含 37 个 action 文件
   - Prisma Schema 涵盖所有业务实体

3. **权限后端强校验**
   - `src/lib/server-auth.ts` 提供统一鉴权入口
   - `requirePermission` / `requireCaseAccess` 在 actions 层强制执行
   - `src/proxy.ts` 实现路由层登录态与页面访问控制

4. **案件主线业务流**
   - 案件创建 → 列表 → 详情 → 任务 → 文档 → 计时 → 账务 全链路可用
   - 支持案件状态机迁移（LEAD → INTAKE → ACTIVE ↔ SUSPENDED → CLOSED → ARCHIVED）

#### ⚠️ 部分满足的要求

1. **"乐高"组件化 DIY 感**
   - 仪表盘支持 widget 拖拽配置
   - 但案件详情页等核心工作界面仍为固定布局
   - Container Queries (`@container`) 应用不够普遍

2. **30-300人规模调度支持**
   - `/dispatch` 已实现团队状态与泳道
   - 但虚拟列表/分页策略需要在大数据量下验证

3. **AI 驱动全流程准备**
   - AI 对话落库可追溯
   - 但 AI 生成文书、AI 辅助案件创建等深度集成尚未完全闭环

---

## 二、功能实现完整性检查

### 2.1 核心功能闭环状态

| 功能模块 | 数据源 | 状态 | 闭环程度 |
|----------|--------|------|----------|
| 案件管理 | PostgreSQL | ✅ 真实 | 完整CRUD+状态机 |
| 任务看板 | PostgreSQL | ✅ 真实 | 拖拽排序落库 |
| 计时追踪 | PostgreSQL | ✅ 真实 | 开始/暂停/停止/审批 |
| 文档中心 | PostgreSQL + MinIO | ✅ 真实 | 上传/版本/受控下载 |
| 日程日历 | PostgreSQL | ✅ 真实 | CRUD+参与人 |
| 调度中心 | PostgreSQL | ✅ 真实 | 团队状态+邀请处理 |
| 聊天沟通 | PostgreSQL | ✅ 真实 | 线程+消息+参与人 |
| 通知系统 | PostgreSQL | ✅ 真实 | 落库+触发点覆盖 |
| 全局搜索 | PostgreSQL | ✅ 真实 | 聚合查询+权限过滤 |
| 工具箱 | PostgreSQL | ✅ 真实 | DB模块+webhook审计 |
| AI助手 | PostgreSQL | ✅ 真实 | 对话落库+调用审计 |

### 2.2 Mock 数据残留检查

**搜索结果**: 代码中几乎无 mock 数据残留

- `MOCK` 关键字仅在 `ai-provider.ts` 中用于检测无效 API key（防护逻辑，非mock数据）
- 未发现 `MOCK_*` 常量数组作为数据源
- 未发现 `fake` 关键字用于数据生成

### 2.3 已清理的空壳/占位

根据 TG12 批判性审计记录，以下空壳已被处理：

- `/settings` → 重定向下线
- `/research` → 重定向到 `/tools`
- `/profile` → 改为真实数据展示
- 未挂载的 mock 组件已删除（CommandPalette、ChatInterface、SimilarCases、FirmOverview 等）
- 浮窗 NOTES 占位已移除

---

## 三、前后端一致性分析

### 3.1 Next.js 全栈架构

| 层级 | 技术栈 | 状态 |
|------|--------|------|
| 数据库 | PostgreSQL (Prisma ORM) | ✅ 共享 |
| 存储 | MinIO (S3 兼容) | ✅ 集成 |
| 后端逻辑 | Server Actions + API Routes | ✅ 统一 |
| 前端 | React 19 + Next.js 16 | ✅ 同工程 |
| 认证 | NextAuth (Credentials) | ✅ 统一 |

### 3.2 Rust 后端补充

项目包含独立的 Rust 后端（`src/` 目录），作为高性能 API 网关：

- **框架**: Axum 0.8 + SeaORM
- **共享数据库**: 与 `lawclick-next` 使用同一 PostgreSQL
- **API 端点**: `/api/v1/{auth,cases,users,tasks,timelogs,documents,events,notifications,ai}`
- **Entity 层**: 14 个 SeaORM entity 文件，与 Prisma Schema 对应

#### ⚠️ 潜在不一致风险

1. **双 ORM 并行**
   - Next.js 使用 Prisma
   - Rust 使用 SeaORM
   - Schema 变更需同步两边 entity 定义

2. **API 路由重叠**
   - Rust 提供 `/api/v1/*` 路由
   - Next.js 也有 `/api/*` 路由
   - 需明确两者的职责边界与部署策略

3. **权限逻辑一致性**
   - Next.js actions 使用 `server-auth.ts` 统一鉴权
   - Rust 使用 `security/permissions.rs`
   - 需确保两者权限矩阵一致

---

## 四、组件与代码组织分析

### 4.1 组件分布统计

| 目录 | 文件数量 | 用途 |
|------|----------|------|
| `src/actions/` | 37 | Server Actions |
| `src/components/` | 107 | UI 组件 |
| `src/lib/` | 72 | 工具类与业务逻辑 |
| `src/app/(dashboard)/` | 20 个子目录 | 页面路由 |

### 4.2 组件职责清晰度

**✅ 良好的组织**
- 按功能域分组（`cases/`, `tasks/`, `documents/`, `timelog/` 等）
- 客户端组件后缀 `*Client.tsx`
- 服务端数据获取在 `page.tsx` 完成

**⚠️ 可改进点**
- `src/components/features/` 下部分组件（如 `case-kanban.tsx`）职责过大
- 部分 UI 组件行数超过 1000 行（如 `TaskKanban.tsx` 1200+行）

### 4.3 Actions 层设计

**✅ 统一的模式**
- 所有 actions 使用 `"use server"` 指令
- 统一使用 `getSessionUserOrThrow()` 获取用户
- 使用 `requirePermission` / `requireCaseAccess` 校验权限
- 使用 `revalidatePath` 触发重新验证

---

## 五、技术债与已知问题

### 5.1 TG12 已清零的问题

根据 `docs/TG12_批判性审计_问题与技术债清单.md`，以下问题已于 2025-12-18 清零：

| ID | 问题 | 处置方式 |
|----|------|----------|
| LC-TG12-AUDIT-001 | `/settings` 空壳 | 重定向下线 |
| LC-TG12-AUDIT-002 | `/profile` 硬编码 | 改为真实数据展示 |
| LC-TG12-AUDIT-003 | 侧边栏权限不一致 | 按 `canAccessPage` 过滤 |
| LC-TG12-AUDIT-004 | `/research` 占位 | 重定向到 `/tools` |
| LC-TG12-AUDIT-005 | ESLint 269 warnings | 全量清零 |
| LC-TG12-AUDIT-006 | 未挂载 mock 组件 | 已删除 |
| LC-TG12-AUDIT-007 | Playwright噪音 | 已收敛 |
| LC-TG12-AUDIT-008 | UI 英文/乱码 | 已中文化 |

### 5.2 当前仍存在的技术债

1. **Rust 后端与 Next.js 的职责边界不明确**
   - 两套后端并行存在
   - 建议明确：Rust 用于高并发场景，Next.js 用于全栈 UI 联动

2. **大型组件重构需求**
   - `TaskKanban.tsx` 1200+ 行
   - `tools/page.tsx` 1000+ 行
   - 建议拆分为更小的子组件

3. **E2E 测试覆盖待扩展**
   - 当前主要覆盖主线冒烟
   - 边缘场景、权限测试可进一步补充

4. **TG7 实现与计划的细微偏差**
   - 计划强调"分配"动作落库
   - 实现更侧重"状态+泳道+邀请闭环"
   - 该偏差需产品口径确认

---

## 六、与子计划的对齐度验证

### 6.1 TG0 基础设施对齐

| 要求 | 状态 | 备注 |
|------|------|------|
| Docker Postgres/MinIO 一键启动 | ✅ | `docker-compose.yml` |
| Prisma 迁移一致 | ✅ | `migrate deploy` 可用 |
| 禁止 synthetic seed | ✅ | `seed.js` 守门拒绝造数 |
| 脱敏快照导入工具链 | ✅ | `restore:snapshot` 脚本 |

### 6.2 TG1 身份权限体系

| 要求 | 状态 | 备注 |
|------|------|------|
| 统一权限矩阵 | ✅ | `permissions.ts` |
| 去除 Demo 身份污染 | ✅ | `auth.ts` 已移除自动创建 |
| actions 层强校验 | ✅ | `server-auth.ts` helper |
| 路由层统一拦截 | ✅ | `proxy.ts` |

### 6.3 TG2 案件端到端

| 要求 | 状态 | 备注 |
|------|------|------|
| 案件创建落库 | ✅ | `CreateCaseWizard` 接入 |
| 列表真实数据 | ✅ | `getCases` |
| 详情页全量可用 | ✅ | 各 Tab 真实 actions |
| 状态机与阶段一致 | ✅ | `cases-crud.ts` |

### 6.4 TG3-TG11 验收

**全部通过**: 每个 TG 均有对应的验收记录文档，记录了浏览器验收脚本的执行结果。

### 6.5 TG12 统一回归

| 要求 | 状态 | 备注 |
|------|------|------|
| 路由断链为 0 | ✅ | `audit:routes` 通过 |
| 构建告警收敛 | ✅ | `force-dynamic` 标记 |
| Playwright 冒烟 | ✅ | 5 个测试通过 |
| 批判性审计清零 | ✅ | 8 项问题已修复 |

---

## 七、可扩展性与 MDI/LEGO 评估

### 7.1 MDI 实现程度

| 能力 | 状态 | 实现方式 |
|------|------|----------|
| 仪表盘 Widget 拖拽 | ✅ | `react-grid-layout` |
| 布局持久化 | ✅ | `DashboardLayout` 表 |
| 浮窗系统 | ✅ | `float-store` + `floating-layer` |
| Z-index 管理 | ✅ | `FloatingWindowFrame` |
| 多窗口工作台 | ⚠️ 部分 | 仪表盘支持，其他页面固定 |

### 7.2 LEGO 组件化

| 能力 | 状态 |
|------|------|
| 原子组件库 | ✅ `src/components/ui/` (shadcn) |
| 业务组件拆分 | ⚠️ 部分组件过大 |
| Widget 注册中心 | ✅ `dashboard-widgets.ts` |
| Container Queries | ⚠️ 应用不够普遍 |

### 7.3 可扩展性设计

| 能力 | 状态 | 备注 |
|------|------|------|
| 多租户预留 | ✅ | `tenantId` 字段贯穿全链路 |
| 模板系统 | ✅ | `CaseTemplate`、`DocumentTemplate` |
| 工具箱扩展 | ✅ | `ToolModule` + N8N webhook |
| AI 上下文联动 | ✅ | `AIInvocation.context` |

---

## 八、总结与建议

### 8.1 项目整体评价

**LawClick 项目已完成 TG0-TG12 的核心功能开发**，具备以下特点：

1. **真实可用**: 核心业务流（案件→任务→计时→文档→日程→协作）形成闭环
2. **架构健全**: 权限后端强校验、数据持久化、状态机管理
3. **工程质量**: 零 lint 错误、构建通过、E2E 测试覆盖主线
4. **代码清洁**: Mock 数据残留已清理、空壳入口已下线

### 8.2 后续建议

#### P0 - 短期必做

1. **Rust 后端与 Next.js 职责边界文档化**
   - 明确两者的使用场景与部署策略
   - 确保 Schema 变更时两边同步

2. **大型组件拆分**
   - `TaskKanban.tsx`、`tools/page.tsx` 等超过 1000 行的组件
   - 提取子组件提升可维护性

#### P1 - 中期改进

1. **Container Queries 普及**
   - 在案件详情、任务详情等页面应用
   - 提升 Bento Grid 自适应能力

2. **E2E 测试扩展**
   - 权限边界测试
   - 大数据量下的性能测试

3. **MDI 工作台扩展**
   - 将 MDI 模式扩展到案件详情页
   - 支持多选项卡/多窗口工作方式

#### P2 - 长期演进

1. **AI 深度集成**
   - AI 生成法律文书
   - AI 辅助案件分析与建议

2. **多端联动**
   - APP 端、小程序端接入
   - 考虑使用 Rust 后端作为统一 API 网关

---

## 附录：证据链接

- TG12 批判性审计: [docs/TG12_批判性审计_问题与技术债清单.md](file:///d:/Desktop/LawClick_NEW/docs/TG12_批判性审计_问题与技术债清单.md)
- TG12 验收记录: [docs/TG12_统一回归与纠错_v2_验收记录.md](file:///d:/Desktop/LawClick_NEW/docs/TG12_统一回归与纠错_v2_验收记录.md)
- 架构落地总计划: [docs/1211_架构落地开发总计划_v1.md](file:///d:/Desktop/LawClick_NEW/docs/1211_架构落地开发总计划_v1.md)
- 1211 架构设计: [prompt/1211架构设计.md](file:///d:/Desktop/LawClick_NEW/prompt/1211架构设计.md)

---

*审计报告生成时间: 2025-12-29 18:27 CST*
