# TG11｜全局搜索 / 通知闭环（清理剩余空壳入口）— 子计划

> 范围：`lawclick-next/`（主工程）  
> 约束：遵循 `prompt/1211架构设计.md`、`.agent/rules/lawclick.md`  
> 核心原则：以“案件（Case）业务流”为主线；**禁止 mock/空壳**；权限必须在 Server Actions/API 层强制校验。

---

## 0. 背景与问题

当前 Header 中的两个入口仍属于“空壳”：

1. **全局搜索**：UI 存在，但未接入任何真实索引/查询链路。
2. **通知中心**：Popover 存在，但数据为前端本地 state，且默认空数组，不具备真实落库、未读统计、点击跳转闭环。

TG11 的目标是把这两条入口改造成“可用且可验证”的真实闭环，并将通知触发点绑定到**案件业务流**（案件创建/分配、成员加入、任务分配、聊天新消息）。

---

## 1. 交付目标（Done Definition）

### 1.1 全局搜索（真实）
- Header `Ctrl/Cmd + K` 打开搜索面板。
- 输入关键词（>= 2 字）触发 Server Action 查询，聚合：
  - `Case`（案件：`caseCode/title/description`）
  - `Task`（任务：`title/description`，并带 `case` 上下文）
  - `Document`（文档：`title/notes/tags`，并带 `case` 上下文）
  - `Contact`（客户/联系人：`name/email/phone`，跳转至 CRM 客户详情）
- 结果可点击跳转（至少 Case/Document/Contact 为“单条可直达”；Task 至少能跳到任务中心或案件页并可定位）。
- 权限与可见性：**后端强制过滤**（Partner/Admin 全量；其他角色按 case membership 可见）。

### 1.2 通知系统（真实落库）
- 新增 `Notification` 数据模型 + migration。
- 提供 Server Actions：
  - `getMyNotifications`（列表 + 未读数）
  - `markNotificationRead`
  - `markAllNotificationsRead`
- Header `NotificationTrigger`：
  - 初始显示真实未读数（DB count）。
  - Popover 展示最近通知（DB list），点击可标记已读并跳转 `actionUrl`。
  - “查看全部通知”按钮不再空壳：跳转到 `/notifications` 页面。
- 新增 `/notifications` 页面：可查看全部通知、标记已读/全部已读。

### 1.3 通知触发点（围绕案件主链路）
至少覆盖以下触发点，并保证 **写入 DB**：
1. **聊天新消息**：`sendChatMessage` 写入消息后，给同线程其他参与人写通知（排除 sender，尊重 muted）。
2. **案件创建/分配**：`createCase` 成功后，对承办人/案源人/成员写通知（排除当前操作者）。
3. **案件成员加入**：
   - `addCaseMember` 成功后对被加入者写通知。
   - `respondToInvite` 接受 `CASE` 邀请后对被邀请者/或发起者写通知（至少一条闭环）。
4. **任务分配**：
   - `createCaseTask` 若指定 `assigneeId`，写通知。
   - `updateTask` 若 `assigneeId` 发生变化，写通知。
   - `createCollaborationInvite` 发起 `TASK/CASE/MEETING` 邀请时，对 receiver 写通知（引导其去 `/dispatch` 处理）。

---

## 2. 设计与架构（DID 原则落地）

这里采用 **DID（Domain / Interface / Data）** 的落地方式：

1. **Data（数据层）**：Prisma Schema + Migration + Seed（Notification、索引、约束）。
2. **Domain（领域层）**：`src/lib/notifications.ts` 提供“写通知”的统一服务（含去重/裁剪/标题规范/metadata）。
3. **Interface（接口层）**：
   - `src/actions/notification-actions.ts`：读/写/标记已读的 Server Actions（统一权限、统一返回结构）。
   - `src/actions/search-actions.ts`：全局搜索 Server Action（聚合查询 + 权限过滤 + URL 映射）。
4. **UI（展示层）**：
   - `src/components/layout/header-components.tsx`：GlobalSearch + NotificationTrigger 真实接入。
   - `src/app/(dashboard)/notifications/page.tsx`：通知列表页闭环。

---

## 3. 数据模型设计（Notification）

### 3.1 字段建议
- `id`：uuid
- `userId`：接收人（User FK）
- `type`：枚举（建议 `NotificationType`：`CHAT_MESSAGE/CASE_ASSIGNED/CASE_MEMBER_ADDED/TASK_ASSIGNED/INVITE_RECEIVED/...`）
- `title`：标题（短）
- `content`：正文（可选，短文本）
- `actionUrl`：点击跳转（`/cases/:id`、`/chat?threadId=...`、`/dispatch`、`/documents/:id` 等）
- `actorId`：触发人（可选，User FK）
- `metadata`：JSON（可选，存 `{caseId, taskId, threadId, messageId}` 等）
- `readAt`：已读时间（null=未读）
- `createdAt`：创建时间

### 3.2 索引
- `@@index([userId, createdAt])`
- `@@index([userId, readAt])`
- （可选）`@@index([type, createdAt])`

---

## 4. 后端实现清单

### 4.1 `src/actions/search-actions.ts`
- `globalSearch(query, {takePerType})`：
  - query trim + 最小长度校验（<2 直接返回空）
  - `Promise.all` 并发查询 Case/Task/Document/Contact
  - 非 Partner/Admin 追加 case 可见性过滤：
    - `originatorId = me` OR `handlerId = me` OR `members some userId = me`
  - 返回结构建议：
    - `{ query, groups: [{ type, label, items: [...] }], total }`
  - 每条 item 包含 `{ id, type, title, subtitle, url }`

### 4.2 `src/actions/notification-actions.ts`
- `getMyNotifications({take, unreadOnly})`：返回 `{ items, unreadCount }`
- `markNotificationRead(notificationId)`：仅允许标记自己的通知
- `markAllNotificationsRead()`：updateMany（userId + readAt null）

### 4.3 `src/lib/notifications.ts`（领域服务）
统一的写入入口（避免各处拼字符串、逻辑分散）：
- `notifyUsers({userIds, type, title, content, actionUrl, actorId, metadata})`
- 内置裁剪：content 最多 N 字（例如 200），避免超长
- 去重策略（可选）：短时间同类型同对象合并（先不做强去重，保持简单可用）

---

## 5. 触发点接入清单（必须落库）

### 5.1 Chat：`src/actions/chat-actions.ts`
- `sendChatMessage` 成功后：
  - 查询线程参与人（`ChatParticipant`，过滤 `muted=true`，排除 sender）
  - 批量写入 Notification：
    - `type=CHAT_MESSAGE`
    - `title=“新消息”`（或带案件/群聊标识）
    - `content=“{senderName}: {text}”`（裁剪）
    - `actionUrl=/chat?threadId=...`

### 5.2 Case：`src/actions/cases-crud.ts`
- `createCase` 成功后：
  - 对 `handlerId/originatorId/memberIds`（排除 currentUser）写入：
    - `type=CASE_ASSIGNED/CASE_MEMBER_ADDED`
    - `actionUrl=/cases/{caseId}`
- `updateCase` 若 `handlerId` 发生变化：通知新承办人。

### 5.3 Members：`src/actions/members.ts`
- `addCaseMember` 成功后：通知被加入者（`CASE_MEMBER_ADDED`，`/cases/{caseId}`）。

### 5.4 Collaboration Invites：`src/actions/collaboration-actions.ts`
- `createCollaborationInvite` 创建后：通知 receiver（`INVITE_RECEIVED`，`/dispatch`）。
- `respondToInvite` 接受/拒绝后：通知 sender（`INVITE_ACCEPTED/INVITE_REJECTED`，可跳 `/dispatch` 或目标对象页）。

### 5.5 Tasks：`src/actions/tasks-crud.ts`
- `createCaseTask` 若指定 `assigneeId` 且不是操作者：通知 assignee（`TASK_ASSIGNED`，跳转到 `/tasks` 或 `/cases/{caseId}?tab=tasks`）。
- `updateTask` 若 `assigneeId` 变化：通知新的 assignee。

---

## 6. 前端改造清单

### 6.1 Header：`src/components/layout/header-components.tsx`
- `GlobalSearch`：
  - 输入框 + debounce + loading 状态
  - 分组展示结果（案件/任务/文档/客户）
  - 点击结果：`router.push(url)` + `onClose()`
  - 支持键盘上下选择、回车跳转、Esc 关闭
- `NotificationTrigger`：
  - 初始加载 `unreadCount`
  - Popover 打开时加载最新 items
  - 点击 item：`markNotificationRead` + 跳转 `actionUrl`
  - “全部已读”：`markAllNotificationsRead`
  - “查看全部通知”：跳 `/notifications`

### 6.2 通知页：`src/app/(dashboard)/notifications/page.tsx`
- 展示全部通知（分页可后续做，先 take 100）
- 支持：单条已读、全部已读、点击跳转

### 6.3 Chat 页增强：`src/app/(dashboard)/chat/page.tsx`
- 支持 `?threadId=` 作为初始选中会话（便于通知跳转闭环）。

---

## 7. 迁移与种子数据

### 7.1 Prisma
- 更新 `prisma/schema.prisma`：新增 `Notification`（+ enum）。
- 生成 migration：`pnpm -C lawclick-next exec prisma migrate dev --name tg11_notifications_search`
- `pnpm -C lawclick-next exec prisma generate`

### 7.2 Seed
不在 `prisma db seed` 中生成任何“示例通知”（避免假闭环）。通知必须完全由真实业务触发：
- 创建案件/分配成员/指派任务
- 发送聊天消息
- 发起并处理协作邀请（CASE/TASK/MEETING）

---

## 8. 验收清单（必须可复现）

### 8.1 命令级验收
- `pnpm -C lawclick-next exec prisma migrate deploy`
- 导入脱敏生产快照：`pnpm -C lawclick-next restore:snapshot -- --file <path-to-dump> --reset --yes`
- `pnpm -C lawclick-next build`

### 8.2 业务流验收（建议用 partner1 登录）
1. 打开任意页面 Header，通知角标显示真实未读数（来自 DB）。
2. 点击通知 Popover：能看到由真实业务触发生成的通知；点击后变为已读，未读数减少。
3. 在团队聊天或案件聊天发送消息：其他账号登录后能收到“新消息”通知并可跳转 `/chat?threadId=...`。
4. 创建案件并指定承办人/成员：对应用户登录后收到案件通知，点击可进入案件详情页。
5. `Ctrl/Cmd + K` 搜索：能返回 Case/Task/Document/Contact 结果，点击可正确跳转。

---

## 9. 风险与回滚
- 风险：通知触发点分散在多个 actions，易遗漏；通过“统一通知领域服务 + 验收脚本”降低风险。
- 回滚：migration 可通过 Prisma migrate 回滚（本地环境）；若当前工作区包含 git 历史则以 git 为准；否则以证据包与变更记录为准。
