# TG17｜看板超量截断治理｜2025-12-26

> 目的：补齐 TG16 审查中点出的“看板查询存在 `take` 上限导致**静默截断**”风险，使其在真实数据规模下也满足 `AGENTS.md` 的极高标准：**数据绝对真实 + 不误导用户 + 前后端一致 + 可复验**。

---

## 1) 问题定义（为什么必须修）

此前任务/项目任务看板通过 `take: 500` 拉取任务列表：

- 当真实任务总量 `> 500` 时，UI 会**无提示地只显示前 500 条**；
- 用户会误以为自己看到了“全部任务”，构成事实偏差（**非 REAL**，属于真实性风险）。

---

## 2) 改造方案（真实性 + 可用性）

### 2.1 服务端：为看板提供“可感知”的真实统计

- 新增/统一看板 where 构造：`lawclick-next/src/actions/tasks-crud.ts`
  - `buildAccessibleTasksWhereForBoard(...)`：统一 tenant/权限/可见性/caseId|projectId access/search/assignee 校验。
  - `buildTaskSearchWhere(search)`：列表/看板搜索语义对齐（任务标题/描述 + 案件/项目 code/title + 负责人 name/email）。
- 新增看板统计 Action：
  - `getAccessibleTasksForBoardMeta(...)`：返回 `{ total, limit, hasMore }`（`count` 真实查询，不做假数据）。

### 2.2 前端：看板超量时“明确提示 + 一键切换到完整列表”

- 任务中心：`lawclick-next/src/app/(dashboard)/tasks/page.tsx`
  - 并行拉取 `getAccessibleTasksForBoard` + `getAccessibleTasksForBoardMeta`。
  - `hasMore=true` 时展示 amber 提示卡：明确“仅显示前 N / total”，并提供“切换到列表”（列表为真分页/虚拟列表，不会静默截断）。
- 项目详情的“项目任务”模块：`lawclick-next/src/components/projects/ProjectTasksPanelClient.tsx`
  - 同样接入 `getAccessibleTasksForBoardMeta` 与提示卡，保证“项目创建 → 任务创建 → 看板/列表 → 任务中心”链路在大数据量下依旧不误导。

### 2.3 同类风险顺手治理（take=500）

- 周工时表（TimesheetCalendar）：`lawclick-next/src/components/features/timesheet/timesheet-calendar.tsx`
  - 新增 `getMyTimeLogsMeta`（`lawclick-next/src/actions/timelogs-crud.ts`）并在超量时显示提示，避免静默截断。

---

## 3) 可复验证据（门禁全绿）

证据目录：`docs/_artifacts/tg17_board_truncation_2025-12-26_v1/`

- `pnpm_lint.txt`
- `pnpm_typecheck.txt`
- `pnpm_build.txt`
- `pnpm_route_audit.txt`
- `pnpm_test.txt`

