# TG12｜项目现状批判性审计（对齐 TG0~TG12 + 1211 架构）｜2025-12-29

> 审计目标：以“批判性、可复现、证据导向”的方式确认当前仓库是否存在空壳/假数据/断链路/前后端不一致/组件冗余/计划不对齐，并把所有发现忠实记录。
> 审计范围：以 `lawclick-next/`（Next.js 主工程）为唯一生产主线；根目录 `src/`（Rust 原型）与 `apps/mobile/`（Flutter 占位）不纳入 Web 主线可用性门禁，仅记录其现状。

---

## 0. 结论摘要（先给结论）

1. **主工程不是“名义开发的空壳”**：在本机 Docker Postgres/MinIO 已运行的前提下，`lint/type-check/build/e2e` 全部通过，主线 E2E（案件→任务→计时→文档→日程/调度→聊天→通知→搜索→多租户隔离）可跑通。
2. **前后端一致性总体良好**：路由引用静态巡检通过，核心页面均在 Server Actions 层读取/写入 Prisma/Postgres，权限也主要在服务端 enforce。
3. **存在一个“强策略但影响可用性”的关键矛盾点**：`prisma db seed` 当前被设计为**硬失败**（禁止 synthetic seed），这会让“新环境可一键拉起并看到可用数据”的体验变差，并与部分 TG 文档中“migrate dev + db seed 可重复执行”的验收口径存在冲突。

---

## 1. 可复现证据（命令输出已落盘）

所有原始输出见：`docs/_artifacts/critical_review_2025-12-28_v9/`

- 环境与版本：`docs/_artifacts/critical_review_2025-12-28_v9/env_versions.txt`
- Docker 运行态：`docs/_artifacts/critical_review_2025-12-28_v9/docker_ps.txt`
- 系统联通性（DB/MinIO）：`docs/_artifacts/critical_review_2025-12-28_v9/pnpm_verify-system.txt`
- 质量门禁：
  - `pnpm lint`：`docs/_artifacts/critical_review_2025-12-28_v9/pnpm_lint.txt`
  - `pnpm type-check`：`docs/_artifacts/critical_review_2025-12-28_v9/pnpm_type-check.txt`
  - `pnpm build`：`docs/_artifacts/critical_review_2025-12-28_v9/pnpm_build.txt`
  - `pnpm audit:routes`：`docs/_artifacts/critical_review_2025-12-28_v9/pnpm_audit-routes.txt`
  - `pnpm audit:tenant-scope`：`docs/_artifacts/critical_review_2025-12-28_v9/pnpm_audit-tenant-scope.txt`
  - `pnpm prisma:validate`：`docs/_artifacts/critical_review_2025-12-28_v9/pnpm_prisma-validate.txt`
  - `pnpm test`（Playwright，15/15 通过）：`docs/_artifacts/critical_review_2025-12-28_v9/pnpm_test.txt`
- 关键矛盾点（Seed 被禁止）：`docs/_artifacts/critical_review_2025-12-28_v9/prisma_db_seed.txt`

整改后复测输出见：`docs/_artifacts/critical_review_2025-12-28_v11/`
- 质量门禁（lint/type-check/build/test）：`docs/_artifacts/critical_review_2025-12-28_v11/`
- 系统联通性（verify:system/init:s3）：`docs/_artifacts/critical_review_2025-12-28_v11/`
- 快照导入工具帮助：`docs/_artifacts/critical_review_2025-12-28_v11/pnpm_restore-snapshot_help.txt`
- Seed 守门输出（更新后的指引文案）：`docs/_artifacts/critical_review_2025-12-28_v11/prisma_db_seed.txt`

> 注：`pnpm test` 输出中出现一次非阻塞 Warning（NO_COLOR/FORCE_COLOR），已在原始日志中保留，未做任何“美化”处理。

---

## 2. 与 1211 架构要求的对齐情况（重点项）

### 2.1 MDI + LEGO + “磁吸/分屏/可拓展”

已落地且可在代码层确认的能力（不依赖假数据）：

- **浮窗/MDI**：存在统一浮窗层与窗口状态管理（含 `zIndex`、拖拽、吸附边缘、持久化偏好等）。
- **组件球（Floating Launcher）**：支持拖拽到屏幕边缘自动吸附，且可在 Header 中开关；配置可持久化（而非 local-only）。
- **分屏（Split View）**：`/cases/intake` 支持 `split/list` 两种视图模式，并将默认模式落入用户偏好（非一次性 UI）。
- **仪表盘 DIY（Grid Layout）**：`/dashboard` 使用 DB 中的布局配置渲染可编辑的工作台（不是静态卡片拼图）。

仍然需要你“肉眼验收”的部分（工具无法替代主观体验判断）：

- “字体密度/积木感/工具栏收缩自适应”等纯视觉体验项：代码看起来已做了响应式与偏好控制，但最终是否达到 `docs/LegalMind设计语言规范.md` 的质感，需要你在浏览器里按既定脚本验收并截图归档。

### 2.2 无 Mock / 无空壳 / Tracer Bullet 全链路

从本次审计证据看：

- **主线闭环可跑通**：E2E 覆盖“注册/登录 → 新建案件 → 案件任务看板新增任务并指派 → 案件详情记工时/新建日程/邀请 → Header 通知跳转 chat/case tab → 全局搜索 → 多租户隔离”等，且 15/15 通过。
- **路由断链为 0**：`audit:routes` 通过（路由存在性与引用一致性 OK）。
- **“空壳页面”策略更偏向 redirect/alias**：对未交付模块，不提供假页面，而是显式重定向（例如 `/research`→`/tools`），这比“展示静态假内容”更符合极限标准。

需要明确指出的现实取舍：

- 当前以“禁止 synthetic seed”来确保 dev=prod 对齐，但这也导致**新环境开箱即用性下降**（见下一节的矛盾点）。

---

## 3. 关键问题与技术债（忠实记录）

### 3.1 Seed 策略与 TG 文档口径存在冲突（重要）

事实：

- `lawclick-next/prisma/seed.js` 当前会直接退出并提示“禁止 synthetic seed，要求导入脱敏生产快照”，导致 `pnpm exec prisma db seed` **无法成功完成**（见 `prisma_db_seed.txt`）。

影响：

- 这会让“新开发者/新机器”在没有脱敏快照的情况下，**很难快速获得可用数据与可见 UI 效果**，从而产生“系统很空/像没做完”的主观印象（即使代码链路真实）。
- 与部分文档/脚本期望存在冲突：例如 TG12 的回归脚本中包含 `db seed` 步骤，但现实是该步骤会失败（除非切换策略或提供快照导入流程自动化）。

建议（方向已落地，见第 6 节整改闭环）：

- 统一 TG0/TG12 的“可复现口径”：明确“必须导入脱敏快照才算通过”，并提供 `restore:snapshot` 导入脚本（保留 `prisma db seed` 守门硬失败，禁止造数），避免“文档写要 seed，但 seed 被设计为失败”的内在矛盾。

### 3.2 文档漂移（计划/验收记录与当前实现不完全一致）

本次审计中发现多处“文档记录仍停留在旧状态”的迹象（不一定影响功能，但会误导复核）：

- 早期 TG 文档中提到的 `research/page.tsx` TypeScript 语法错误：当前已改为明确 redirect，不再阻塞 `type-check`。
- TG0 内既出现过“seed 生成 10 案件/40 任务…”的验收记录，又在后续“极限标准复核”里改为禁止造数；当前代码以“禁止造数”为准，但文档存在历史段落并置，容易造成对真实策略的误读。
- 多处文档默认假设仓库是 git repo（提及回滚/分支/提交策略），但当前工作区未包含 `.git/`（本机环境事实）。这会影响“按 git 追溯”的流程可执行性。

### 3.3 组件/路由层的“别名重定向”带来的认知成本（中等）

现状是通过 alias/redirect 来消除 404 与空壳入口（这是对的），但也会带来“路径很多、入口分散”的认知成本，需要在文档或导航层明确：

- `/contacts` → `/crm/customers`
- `/cases/archive` → `/cases/archived`
- `/timelog` → `/time`
- `/settings` → `/profile`
- `/research` → `/tools`

建议（已落实）：

- 在 `docs/` 或 `src/config/navigation.ts` 附近提供一份“路由别名/历史兼容映射表”，避免用户误判为“点击错了/跳转怪”。（已落地：`docs/路由别名_重定向映射表.md`）

---

## 4. TG0~TG12 对齐复核（按子计划逐项给出结论）

> 说明：这里按“子计划要求的最小闭环”对照当前代码与 E2E 证据；不做“美术/交互质感”的主观打分。

- **TG0 基础设施对齐**：通过（Docker Postgres/MinIO 运行；`verify:system` 通过；`prisma validate` 通过）。风险：`db seed` 被禁止，需在文档口径中明确“快照导入即验收”。
- **TG1 身份权限体系统一**：通过（中间件拦截存在；Server Actions 普遍采用服务端鉴权；多角色只读/可写在 E2E 中有验证）。
- **TG2 案件端到端闭环**：通过（E2E 覆盖新建案件、案件详情、deeplink 到 Tab、案件内新增任务/工时/日程/邀请）。
- **TG3 任务协作与看板（含增强）**：通过（案件看板与项目看板均有 E2E；拖拽/排序落库逻辑存在；只读角色限制有 E2E）。
- **TG4 计时追踪**：通过（`/time` 为主入口；案件详情可记工时；E2E 覆盖“案件详情记工时”）。
- **TG5 文档中心**：通过（文档列表/详情/AI 审查路由存在；受可见性限制的只读行为有 E2E）。
- **TG6 仪表盘 MDI/DIY**：代码层已落地（dashboard config + workspace）；建议你补一次纯浏览器验收截图，确认“积木感/自适应”是否达标。
- **TG7 日程安排/调度中心**：通过（`/calendar`、`/dispatch` 路由存在；邀请处理与案件联动在 E2E 中出现）。
- **TG8 案件账务联动**：通过（案件账务 Tab 存在且包含工时/发票/费用/审批/合同；只读角色限制有 E2E）。
- **TG9 AI 模块/工具箱**：部分通过（工具箱本体存在且 DB 模块/审计接口已接入；AI Provider 明确拒绝 mock key）。注意：AI 是否“真正可用”取决于 `OPENAI_*` 真实配置与运行时调用质量，本次审计未对外部模型输出做正确性评估，仅验证链路不空壳且错误可预期。
- **TG11 全局搜索/通知闭环**：通过（Header 接入真实 Server Actions；通知跳转 chat/thread 定位有 E2E；搜索入口在代码层存在）。
- **TG12 统一回归与纠错 v2**：通过（`audit:routes` 通过；`build` 通过；`test` 通过）。口径已统一为“migrate deploy + 脱敏快照导入”，并提供 `restore:snapshot`（见 6）。

---

## 5. 你需要做的“人工验收”清单（建议补充截图证据）

为避免“代码通过但体验不达标”，建议你按以下脚本补一轮截图并归档到 `docs/_artifacts/critical_review_2025-12-28_v11/`：

1. `/dashboard`：工具栏收缩/展开时布局自适应；Widget 密度与积木感是否符合设计语言。
2. `/cases/intake`：split/list 切换是否顺畅；分屏信息密度是否可读。
3. 组件球：拖拽吸附到四边、展开菜单、打开计时/消息/AI 是否符合“磁吸+分屏”的直觉。

---

## 6. 整改闭环（2025-12-29）
1. **快照导入工具链补齐**：新增 `lawclick-next/scripts/restore-snapshot.js`，并在根目录与 `lawclick-next/` 提供 `restore:snapshot` 命令入口。
2. **文档口径统一**：将“migrate dev + db seed 可复现”的口径统一改为“migrate deploy + 导入脱敏生产快照”（保留 `prisma db seed` 守门硬失败，禁止造数）。
3. **路由别名显式化**：新增 `docs/路由别名_重定向映射表.md`，降低 alias/redirect 的认知成本。
4. **整改后复测证据归档**：`docs/_artifacts/critical_review_2025-12-28_v11/`（含 lint/type-check/build/test/audit 等输出）。
5. **TS 严格类型补强**：移除 `@ts-expect-error`（pdf-parse 导入），改用 `pdf-parse` 官方 API（`lawclick-next/src/lib/pdf.ts`）。
