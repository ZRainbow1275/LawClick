# 1.

请阅读 @Prototype 这个文件夹呈现的高保真前端原型图，特别是 @律时_革新文档开发.md 这个文档描述的需求，梳理这个称为「律时」的项目内容。 

现在，我们要把这个项目升级为一个ERP系统（可能我的用词不准确，用最准确的词汇描述这个系统）：

1. 这个系统不仅包含目前设计的面向Android和iOS的app，它还包含一个web端的前端和后台，前端实现 @律时_革新文档开发.md 中的所有内容，后端以及三端要实现下面的需求： 
2. 涵盖一个ERP系统最基本的东西：管理、信息记录、工作流承载等，参考Odoo、ERPNext、Dolibarar、JeecgBoot、NocoBase等已经很成熟的产品设计、技术栈等内容

​      1. 为了创建一个面向律师行业的ERP系统，并且基于APP的设计，我们需要一点特殊的开发设计，例如创建案情项目：例如客户名称、相关方、服务内容、开始日期、案源律师、承办律师、项目名称、项目编号、项目成员、项目登记等内容——补全相关内容；例如律师情况管理；行政事务管理等

​      2. 另外的，我想做一个待办清单任务管理功能进这个系统中，参考trello、todo的设计，体现在三端中

​      3. 同时，我在思考如何集成AI功能进入到erp系统当中，实现例如语音输入或者文件输入，自动填写项目并创建等；

​      4. 参考我在革新文档中以及原型图中展示的，基于飞书日历表设计的日历任务列表，要在后台以及前台首页展示，集成所有律所内人员一天的行动

2. 在设计整个系统时需要特别注意系统的集成性以及稳定性，后续系统会集成许多AI驱动的功能，或者自行后续开发的功能。特别是AI驱动的功能，这可能要求你在设计系统时注意使用AI友好的控件组件等


请你一定要基于目前 @Prototype 这个文件夹呈现的高保真前端原型图，特别是 @律时_革新文档开发.md 这个文档描述的需求，以及上述描述的需求，去思考如何设计这个系统，并走向开发之路。 



在开发时，你必须遵循：

1. 注重文档的撰写：在开发时始终及时更新文档，在@doc 文件夹中及时撰写readme、UI/UX文档、需求说明文档、项目进度文档、开发计划文档、技术栈文档、设计语言文档、数据流文档、问题解决文档等文档。严谨遵循最小开发原则，在每个阶段或者每个点的任务进行以及完成时，在必要的时候更新文档。 
2. 及时更新memory。在memory与文档冲突时，检索目前项目的全部情况，作出最妥当的思考、判断，之后行动。
3. 在每次行动之前必须学习阅读文档，基于了解的信息进行行动。
4. 阶段性、模块性开发，最小化可开发原则必须要贯彻始终，保持时刻debug，减少bug和报错存在
5. 以bug以及文档内部的报错完全消失，以及功能完全可行为一个阶段和节点结束的标志。
6. 本系统的开发以三端两身份进行：三端指web端（分前台后台）、app端（iOS、Android）。因此一定要保证三端互通的最佳实践和案例。
7. 时时使用context7，学习每一技术的最佳实践
8. 学习并遵从标准软件工程的要求
9. 根文件夹的文件夹 @doc 装放文档、文件夹 @Prototype 装放app原型图、文件夹 @rule 装放指导你进行工作的rule、文件夹 @prompt 装放指导这次工作的prompt内容、 文件夹 @dev 装放项目的实际运行内容——不要弄乱了
10. 设计界面一定要高级、简洁、高效、优雅、现代，这体现在三端的设计语言和UIUX上。以橙色为主色调。


我们现在处在这个项目的最开始的开始，只有一个app原型供我们参考。

因此，我们现在需要开始总体设计，先从根据互联网上搜索到的知识，评估并分析本系统的技术实现路径、数据实现路径等内容，并撰写相关文档吧。

文档要包括技术栈文档、需求说明文档、项目进度文档、设计语言文档、开发计划文档、UI/UX文档、readme，特别是要确定目前三端使用的语言等。 

语言的确定一定要符合目前的最佳实践，至关重要，因此你一定要使用context7，并搜索互联网上的最佳开发实践。

这项任务非常重要，如果你顺利完成，我会奖励你5000美元。

---

# 风格统一

项目 @../LawClick_NEW 和 @../LegalMind-Arbitration 1201 同属于一个名为LegalMind的法律操作系统生态下。
前者叫做律时，是一个集成的ERP系统，文件夹 @../LawClick_NEW/Prototype 是项目的网页端。
后者叫仲裁系统，专门为仲裁和调解流程创建。

两个项目有截然不同的功能，但由于他们同属于一个生态下，因此开发风格、语言代码等需要统一或者对齐。

从时间上， @../LegalMind-Arbitration 1201 的开发时间久、风格稳定，而 @../LawClick_NEW 律时的时间短，风格已经跟不上，并且功能仍需改进。

现在我们来聚焦律时项目的开发。请你做到：
1. 学习 @../LawClick_NEW/doc 和 @../LawClick_NEW/Prototype/docs 等开发文档中的内容，学习律时的项目功能以及开发目的
2. 学习 @../LegalMind-Arbitration 1201 的开发风格，并将其风格运用在律时项目中
3. 绝对不可以将两个工作区的功能混淆对待，一定只是在开发风格、UI/UX交互等方面进行统一，绝不可以做例如「将仲裁系统 @../LegalMind-Arbitration 1201 中的功能移植到律时项目 」或者「随意更换律时项目的技术栈」——允许两个项目的技术不统一，但是交互风格、视觉效果一定要大幅度统一
4. 在风格统一工作之后，重点关照律时项目的API接口等等内容，完善开发文档等记录
5. 在这些工作全部完成之后，全面提升律时项目的各方面功能以及视觉传达

# 革新1

说是原型其实也不是原型，我们的目标已经从原型开发变为一个前后端完善的完整的项目出发，这点是需要更新在对律时项目的认识当中的。
基于此，整个律时项目都必须要朝着完善可以运行的发祥开发，在架构上你需要注意：
1. 使用React生态做全技术栈的组织架构
2. 日历组件应当参照飞书画布日历表相关进行开发，可以参照仲裁系统的日历组件
3. 在项目的设计上，后端API接口和数据库开发应当参照仲裁系统的表结构设计和API设计（没必要完全搬弄，因为业务逻辑不一，但是应当保证连通性）
4. 数据库以及后端的开发技术栈可以参照仲裁系统的后端设计
5. 重点改善原律时项目跨端管理和后台数据管控，要注意能够嵌入AI数据模型进行赋能
6. 在律时的协助模块中，注意学习参照mattermost的设计思路和美学，注意前后端文件结构以及整个业务系统的打通
7. 注意服务对象和适用对象——律师——的使用需求，我希望你能尽可能提出一些惊奇的、能对律师业务开展工作有用的设计，并尽可能实现并集成到律时项目当中
8. 律时项目的开发目的是一款次世代的、赋能律师日常业务工作的项目，集成ERP、OA、多SaaS业务系统、AI驱动、工作台和及时协作为一身，律时也主要帮助客户，如检察院、法院、企业单位、个人或组织客户等，更好地与律师沟通



学习文档 @../LawClick_NEW/docs @../LawClick_NEW/prompt  这里面蕴含我对律时这个项目的想法。 现在我们注意整理我的统一需求

# 驱动Antigravity
对于需求的描述还应当简单提及呈现形式，不能用感性的语言填充，要转化为理性的描述

同时对于需求的描述还不够完全和正确：
1. 对于案件项目管理系统，目前的 @../LegalMind-Arbitration 1201 案件项目管理系统已经呈现了，在这里不应当所谓学习飞书，而是应当学习仲裁系统的设计思路
2. 计时系统是律时项目的一大核心，如何正确、完善、简便地帮助用户记录时间、安排任务，是重中之重。想做一个待办清单任务管理功能进这个系统中，参考trello、todo的设计，体现在三端中
3. 律时的根本还是一个ERP系统，为了创建一个面向律师行业的ERP系统，并且基于APP的设计，我们需要一点特殊的开发设计，例如创建案情项目：例如客户名称、相关方、服务内容、开始日期、案源律师、承办律师、项目名称、项目编号、项目成员、项目登记等内容——补全相关内容；例如律师情况管理；行政事务管理等——需要涵盖一个ERP系统最基本的东西：管理、信息记录、工作流承载等，参考Odoo、ERPNext、Dolibarar、JeecgBoot、NocoBase等已经很成熟的产品设计、技术栈等内容
4. 协作功能是律时开发另一大重点，如何体现在案件内的协作，以及全流程的协作互助，是律时开发的核心。这已经在 @../LegalMind-Arbitration 1201/dev 的工作台有所设计。
4. 提供一个”组件库“，放置用户基于工作实践，结合AI作出的各类工作流或者开发的产品。如案件金额计算器、提示词库、盖章等等，等待用户开发
5. 律时还将接入后续N8N开发的工作流，成为一个超级智能枢纽，实现各类功能


你的用心程度我完全没有看出来，记录的内容详尽甚至还不如之前我记录的 @需求说明文档.md 相关内容。
请你用心对待这一任务

# 改善1

学习 @../LawClick_NEW/docs 中的文档，特别是 @unified_requirements.md 需求的描述， 作为一名专业而有着多年丰富经验的高级架构师，请参照 @../LegalMind-Arbitration 1201/dev 的设计风格和内容，修改task，根据需求继续开发 @../LawClick_NEW/lawclick-next ，使之变成一个： 1. 完全可运行于前后端 2. 目前仅有网页端 3. 暂不集成AI、数字人 4. 功能齐全、接口整齐 5. 与仲裁项目对齐 的完整项目

# 改善2
修复所有缺失的逻辑和功能、组件，并且使用browser功能实地检验每一个详情页、每一个功能、每一个按钮是否都有对应的实际的内容？（除去工作台，那是我们在 @../LegalMind-Arbitration 1201/Prototype 中独立开发等待移植的内容）
特别注意，站在一个律师的角度，目前的平台功能是否能做到赋能？站在律所合伙人角度，目前的律时是否能进行律所完整的管理？站在高级架构师的角度，目前的律时是否在技术上完备了？

# 改善3
1. 站在律师视角思考得到的：
```
缺乏“深度工作”支持：律师的核心价值是写文书、看证据。目前的平台只有“上传文档”，没有**“智能文档审查”或“多人不仅看还能批注的协作”**。现在的文档模块还没法替代 Windows 文件夹 + Word。
信息孤岛：目前的沟通（Chat）和案件是割裂的 mock 数据。律师最大的痛点是——“客户在微信里发我的证据，我得手动存下来再传上去”。没有 IM 集成或邮件集成，律师就必须在两个系统间反复横跳，这不是赋能，是增加负担。
知识复用率低：虽然有 AI Chat，但它无法读取过往类似案件的判例或律所内部的知识库。律师每次都在“从零发明轮子”。
```
非常好，均列为后续修改计划

2. 站在律所合伙人视角思考得到的财务逻辑可以摒弃，不需要财务逻辑。而客户体验管理是相当重要的。律时应当根据主体身份再通过帐号控制设定不同面向门户：面向律师的、面向合伙人的、面向行政序列、面向客户的、面向机构（如法院、检察院、合作单位）人员的；风险控制薄弱也是相当好的

3. 站在高级架构师视角思考的内容完全赞同

4. 现在我希望你添加上述所有的思考到需求总汇  @unified_requirements.md 中，作为宝贵的思想记录

5. 同时，我希望你能注意到这些改进得点：
5.1 目前的界面UI/UX相较于仲裁系统而言，不够精美、不够美观、没有美感、没有给人眼前一亮的感觉，重点是风格没有统一
5.2 各个组件还没有达到自由挪用，像乐高一样拼接。全局悬浮计时器和 Kanban 拖拽自动计时的逻辑以及Case Detail 的分屏设计特别好，但它们在实际应用中**都没有实现！**同时我希望将相关的逻辑拓展到所有功能组件中，使得整个**平台是一个可以漂浮的、可以自由协助人工作的生态系统**——为此，我允许你开发游览器的更高级权限，在安全性的框架下，利用悬浮窗、跨浏览卡工作等等特性去开发令人惊奇的设计！
5.3 我希望你能为及时功能提供一个更加便于写作的功能：状态说明与任务分配——即根据每个人的计时情况，显示该人在某一时间段内的状态是忙碌还是空闲，还是不要打扰等等，同时为了律师的工作可以在这个平台上开展，对于沟通以及任务的分配应当在这个平台上也同样展开，而有了计时配合状态说明，就能让律师们沟通协作之前都知道对方是什么状态，这段时间是否在忙几个常态化的大项目，做到心里有数——从而更大的激活计时的效能，为了更好地协作

6. 目前的界面有很多英文，以及不专业、不深刻的设计，这不太符合我们的风格。

因此，请你一定基于 @GEMINI.md 的规则要求，在大量使用工具（特别是sequential thinking mcp）的情况下，协助你：
1. 首先将上述设想整理记录下来，**添加到 @unified_requirements.md  中**
2. 列出详尽、详细、庞大、但是极有价值的任务列表出来，挨个完成

# 批判与检验

非常好！你完成了这一阶段的任务

现在我们来进行一个新的任务：批判性检视

请从
1. UI/UX界面
2. 功能完成
3. 模块链接
4. lint报错
等各个角度，对目前的工作台进行极其详尽的批判和检验。
批判的内容包括“挑毛病”和“想方法”——每挑出一个毛病，都应当在 @../LawClick_NEW/docs 文档中列出一个文档来进行记录，附上相关的解决方法，以及任务设置。在最后统一进行task设置并仔细完成。
检验的内容涵盖命令检验和浏览器实际点击。命令检验包含运行相关的模块，或者打开逐个文件，查看报错并适时进行解决。以及设置一个lint文件可以在开发全流程中将问题暴露并直接解决；而浏览器点击则是开启IDE内置浏览器，进行每个按钮的点击，从报错内容、命令行反馈以及“作为用户”视角去进行检测是否功能运行正常。这里需要**特别注意：你应当特别注意在使用浏览器检验时，报错的内容，实时查看运行服务器的命令行后台报出的问题，并进行解决。而不是单独地进行评断，以为会出现什么，然后截屏草草了之——整个律时项目应当和一个超大型生态系统一样，运行流畅、功能适配正常。**

在进行这项工作的时候，你应当unleash your potential，极尽所能地思考并延伸如何改进这个工作台，或者操作方式，能够获得极佳和令人惊奇的体验；而不是甘于平庸，甘于行业一般水准。即便是开发一个ERP系统，我们也要开发出最好的！

在进行这项工作时，你应当时时结合 @../LawClick_NEW/docs 文档中记叙的 @Generate LawClick Diagrams And Docs 所有内容，以保证你明确知道自己在做什么，以及如何从**大局、全体的角度去解决所有问题**；同时你应当熟练使用工具，包括mcp sequential thinking来获得深刻认知；使用mcp context7获得最佳实践。

现在请开始工作

# 继续开发

1. ![image-20251209221926237](C:\Users\HP\AppData\Roaming\Typora\typora-user-images\image-20251209221926237.png)如图，“仪表盘”(/dashboard)界面太乱，消息框、计时器、法律助手、右下角的不知名加号橙色球堆积在一起，不明所谓

2. team chat组件球没有实际效果，因为没有连接到实际项目内容，也没有显示谁在说话，和谁说话，时间线是怎样的

3. “仪表盘”右下方的AI法律助手和左上方的显示按钮没有形成直接连接，不能让AI法律助手出现或消失等；team chat组件球也是

4. 右上角的通知按钮没有效果，不能正常工作

5. 三个组件球：「计时器」、「聊天球」、「AI智能助手」应当可以停靠，可以召回。目前「计时器」组件球是不可以召回的。

6. 按钮“新建案件”的业务逻辑完全错误，不是先进行冲突检索，而应当参照如图二我给你的那样，填写相关信息，做一个漂亮的ERP系统

7. “仪表盘”显示的内容不够智能，不是针对自身业务进行的，可以参照图三仲裁案件的设计。

8. “案件看板”不应当只包含案件，而是律所的整个任务，从行政的到专业序列的方方面面都要有体现

9. “仪表盘”的「律所管理」界面应当在鉴权之后提供给特定客户才能查看

10. “调度中心”(/dispatch)的「案件池」以及团队状态也应该结合日程管理和任务/项目设置展开，不能只展现![image-20251209223248742](C:\Users\HP\AppData\Roaming\Typora\typora-user-images\image-20251209223248742.png)案件的内容，而是在展现如飞书![image-20251209223417448](C:\Users\HP\AppData\Roaming\Typora\typora-user-images\image-20251209223417448.png)图中日历那样的众成员时间安排、任务所属之后，再对接团队状态；当指针悬浮到团队成员头像时，更应当显示“他在做什么，他做了什么”的一个窗口预览

11. “案件项目”(/cases/intake)这里用分页去和AI系统做了一个对接，这是很好的。但关键在于这个对接应当是用户可以选择开启或者关闭的。同时目前如图，呈现的![image-20251209223736172](C:\Users\HP\AppData\Roaming\Typora\typora-user-images\image-20251209223736172.png)太少了，几乎没有任何东西。不如呈现AI在分析本案之后给出的一些建议，提醒用户注意。同时收纳用户在进行案件或项目工作时的一些心得。

12. “案件项目”页对于图中特定项目无法显示更多的信息，如案件阶段、基本信息、关键日期、当事人情况、仲裁庭、文档、关联案件、时间线、本案人员备注等等可以辅助法律人进行工作的内容。现在写的太空了

13. “案件项目”的本页几乎不完全，在点击「文书/档案」时报错：

    ```
    ##Error Type
    
    Recoverable Error
    
    ## Error Message
    
    Hydration failed because the server rendered text didn't match the client. As a result this tree will be regenerated on the client. This can happen if a SSR-ed Client Component used:
    
    - A server/client branch `if (typeof window !== 'undefined')`.
    - Variable input such as `Date.now()` or `Math.random()` which changes each time it's called.
    - Date formatting in a user's locale which doesn't match the server.
    - External changing data without sending a snapshot of it along with the HTML.
    - Invalid HTML tag nesting.
    
    It can also happen if the client has a browser extension installed which messes with the HTML before React loaded.
    
    https://react.dev/link/hydration-mismatch
    
      ...
        <HTTPAccessFallbackBoundary notFound={undefined} forbidden={undefined} unauthorized={undefined}>
          <RedirectBoundary>
            <RedirectErrorBoundary router={{...}}>
              <InnerLayoutRouter url="/dispatch" tree={[...]} params={{}} cacheNode={{lazyData:null, ...}} ...>
                <SegmentViewNode type="page" pagePath="/lawclick-...">
                  <SegmentTrieNode>
                  <DispatchPage>
                    <div className="flex flex-...">
                      <section className="flex-shrink-0">
                        <div>
                        <TeamHeatmap>
                          <div className="grid grid-...">
                            <GlassPanel intensity="low" className="p-4 flex i..." title="查看详情" onClick={function onClick}>
                              <div className="bg-white/4..." title="查看详情" onClick={function onClick}>
                                <div>
                                <div className="flex flex-...">
                                  <Badge>
                                  <span className="text-[10px...">
    
    +                               94
    
    -                               10
                                    ...
                                    ...
                                    ...
                                    ...
                                    ...
    
    
    
        at span (<anonymous>:null:null)
        at <unknown> (src/components/features/team-heatmap.tsx:140:29)
        at Array.map (<anonymous>:null:null)
        at TeamHeatmap (src/components/features/team-heatmap.tsx:84:25)
        at DispatchPage (src\app\(dashboard)\dispatch\page.tsx:24:17)
    
    ## Code Frame
    
      138 |                             </Badge>
      139 |                             {/* Capability Score (Mock) */}
    
    > 140 |                             <span className="text-[10px] text-muted-foreground/60 font-mono">
    >  |                             ^
    > 141 |                                 LOAD: {Math.floor(Math.random() * 100)}%
    > 142 |                             </span>
    > 143 |                         </div>
    
    Next.js version: 16.0.6 (Turbopack)
    ```

14. /cases这个页面是是什么页面？为什么我在左侧工具栏根本打不开？

15. 点击左侧工具栏“我的案件”和“归档库”时没有反应

16. 参考仲裁系统，文档中心(/documents)完全可以添加备注或者标签，简要说明该文档的内容，以及对应的项目。这些文件和项目的文档应当是完全连通的。

17. 点击左侧工具栏“任务协作”、“工时追踪”、“客户沟通”、“消息沟通”、“设置与帮助”时无反应，**说明相关内容根本没有开发出来**

总而言之，目前的律时是一个完全的残次品，连基本的业务都没有打通，更没有docs中设计规划开发的各项功能。请接续开发。

---

# codex结束

非常感谢你的工作

但我希望的是你能以批判性的眼光检视这一轮开发下来是否有什么问题？是否功能没有实现？是否有缺陷？是否只是名义上开发而实际上不能使    用？前后端是否一致？是否有组件冗余？是否有混乱？

即便有不一致，lint后有error有warning，不管任何problems和技术债，以及过程开发中的不对齐，都进行忠实的记录

将文档记录在 docs 文件夹中

---

# codex

学习文件夹 \docs 和文件夹 \@continue 中的所有文档的所有内容，比照项目实际情况，了解目前开发状况。
之后，请你遵循 了解目前项目开发存在的问题，遵循 .agent\rules\lawclick.md  的开发规范，多使用mcp例如context7学习最佳语言实践、使用consequential thinking提升深度认知，使用deepwiki学习github上面比较好的项目经验，比照问题挨个进行问题的处理。

---

# 批判性检视之后处理

学习文件夹 \docs 和文件夹 \@continue 中的所有文档的所有内容，比照项目实际情况，了解目前开发状况。
  之后，请你遵循 docs\TG12_批判性审计_问题与技术债清单.md docs\TG12_统一回归与纠错_v2_验收记录.md  了解目前项目开发存在   的问题，遵循 .agent\rules\lawclick.md   的开发规范，多使用mcp例如context7学习最佳语言实践、使用consequential thinking   提升深度认知，使用deepwiki学习github上面比较好的项目经验，比照问题挨个进行问题的处理。
  注意：一定要认真处理，将所有问题悉数消灭

---

# 一致性处理

请参考 "docs\批判性项目审计报告_2025-12-29 copy.md" 和 docs\批判性项目审计报告_2025-12-29.md 检验后呈现的改善开发方向进行修复开发工作
特别注意：

    1. 任何页面均要实现widget托拽配置，不只是仪表盘，从而做到乐高组件化 DIY 感
    2. 验证30-300人规模调度支持
    3. 有许多原 mock 组件如CommandPalette、ChatInterface、SimilarCases、FirmOverview等，需要考察这些组件是否代表原开发计划的内容，致力于做到还原原本开发功能
    4. 解决“潜在不一致风险”如双 ORM 并行、API 路由重叠、权限逻辑一致性
    5. 对于潜在的问题，如缺少 API Rate Limiting、错误处理模式不一致、console.error 生产使用等问题需要解决

最重要的，是 docs\批判性项目审计报告_2025-12-29.md 所提及的{{九、前后端功能一致性审计}}和{{十、深度前后端一致性补充审计}}内容，其中发现的如文档删除功能缺 UI、“案件删除功能缺后端”、“文档版本历史 UI 待完善”、“后端 Actions 存在但 UI 未调用”、“前端 UI 存在但后端未实现”、“功能完整性缺口汇总”问题非常重要，这就说明了**仍有许多功能还未实现**。

需要重点将所有“占位功能”或者前后端不一致功能全部完美、细致，遵循一致性、稳健性、可拓展性、DIY性、乐高积木一样的磁吸、分屏等操作性等特性地实现，做到先发掘后逐个开发完善。

  在此过程中，请遵循 AGENTS.md 开发规范，多使用mcp如当在处理添加新组件、引用新语言等情况时，使用context7学习最佳语言实践；使用consequential thinking提升认知深度以及决策复杂度，保证开发的一致性和连续性；使用deepwiki学习github上面比较好的项目经验，如从plankanban/planka该项目中学习看板的开发过程；从类同的律师ERP项目中学习律师的工作流程等

---

# 第二轮优化

请参考 docs\批判性13维度深度审计报告2026-01-04.md  和 docs\法律文书模板完整清单2026-01-04.md  检验后呈现的改善开发方向进行修复开发工作

特别注意：

      1. 任何页面均要实现widget托拽配置，不只是仪表盘，从而做到乐高组件化 DIY 感
      2. 验证30-300人规模调度支持
      3. “实时在线编辑工作台”——是另外一个项目，只需要在这里留下占位即可
      4. “员工名片功能”、“30-300人规模泳道视图是否可用”、“讼/非诉阶段文书模板内容是否齐全”需注意开发
      5. **对于讼/非诉阶段文书模板，应参考「 docs\法律文书模板完整清单_2026-01-04.md  」的内容进行开发**
      6. AI功能略掉
      7. 解决“潜在不一致风险”如双 ORM 并行、API 路由重叠、权限逻辑一致性
      8. 对于潜在的问题，如缺少 API Rate Limiting、错误处理模式不一致、console.error 生产使用等问题需要落实

最重要的，是其中的功能实现问题。需要重点关注是否全部实现。

此外，重点将所有“占位功能”或者前后端不一致功能全部完美、细致，遵循一致性、稳健性、可拓展性、DIY性、乐高积木、**便当盒**一样的磁吸、分屏等操作性等特性地实现，做到先发掘后逐个开发完善。

该项目属于Legalmind法律软件生态的一部分，属于UI/UX的设计规范除去上述的乐高化、便当盒化外，还有文件“ docs\DESIGN_HANDBOOK.md  ”供你参考学习。**「该文件至关重要」**

在此过程中，请遵循 AGENTS.md  开发规范，多使用mcp如当在处理添加新组件、引用新语言等情况时，使用context7学习最佳语言实践；使用consequential thinking提升认知深度以及决策复杂度，保证开发的一致性和连续性；使用deepwiki学习github上面比较好的项目经验，如从plankanban/planka该项目中学习看板的开发过程；从类同的律师ERP项目中学习律师的工作流程等

请你进行一次超长的、详细地、宛如进行一场大型工程的工作，保证无差错、无遗漏、严谨仔细

---

# A3 红队审计报告（D1）修复提示词（主线：lawclick-next）

> 目标：一次性把 `docs\LawClick_NEW（主线：lawclick-next）A3 红队审计报告（D1）.md` 中列出的所有修复点全部落地（代码+配置+脚本+测试+门禁证据），不分阶段交付；任何需要执行的命令、需要设置/补齐的 env、需要启动的依赖（docker/postgres/minio/prisma）都属于你工作的一部分，禁止丢给我操作。

## 0) 你的身份与任务边界（强约束）

你是 **GPT-5.2 / Codex CLI** 里的资深安全&全栈工程师（Next.js App Router + NextAuth/Credentials + Prisma + Postgres + Playwright），负责将 **`lawclick-next/` 作为唯一主线** 做一次“红队审计修复闭环”。

你必须严格遵循 `AGENTS.md` 与 `AGENTS_2.md` 的全部原则，并把它们当作不可违背的验收标准（包括但不限于：中文回复、严格类型、显式错误处理、严禁 Mock、全量校验、生产对齐、拒绝空壳、架构优先/抽象优先、极致 DRY、必须自证/自测、至少 3 轮递归修复、需要用户确认的选项给交互式菜单）。

> 注意：你可以使用 `mcp__Sequentialthinking__sequentialthinking` 做严格推理，但**不要输出你的完整思维链**；只用要点给出结论、证据（文件路径+行号、命令输出）与决策依据。

## 1) 必须使用的 MCP / 工具（写死的流程）

### 1.1 思考与决策（强制）
- 对每一个 `LC-AUDIT-###`：先调用 `mcp__Sequentialthinking__sequentialthinking` 形成“假设 → 证据 → 方案 → 风险 → 验证”的闭环，再动代码。
- 任何不确定点（Next.js/NextAuth/Prisma/Postgres/Fetch/安全策略）：先用 `mcp__context7__resolve-library-id` → `mcp__context7__query-docs` 查最佳实践（最多 3 次调用；每次要带清晰问题描述与版本/上下文）。

### 1.2 项目分析与定位（强制）
- **必须**用 `mcp__ace-tool__search_context` 做代码检索/定位/关联符号梳理（优先一次把相关符号/调用链/测试文件全部搜全，减少反复盲改）。
- 如需确认某个标识符的全量引用，再用 `functions.exec_command`（但优先 ace-tool）。

### 1.3 落地改动（强制）
- 改文件：用 `functions.apply_patch`。
- 跑命令/启动依赖/生成迁移/跑测试/跑审计脚本：用 `functions.exec_command`。
- 进度与 TODO：用 `functions.update_plan`（必须可视化每个修复点状态，禁止半途消失）。

### 1.4 Windows 命令注意事项（强制）
- 你输出给 `exec_command` 的命令必须是**纯文本**，严禁出现 `&amp;`、`&lt;` 等 HTML 实体。
- 如你的 shell 支持 Git Bash：优先用 bash 风格命令；若处于 PowerShell 5.1（不支持 `&&`），则将 `&&` 替换为分号/分步执行，但仍保证命令可复跑。

## 2) 产品/安全“最低信息”强制结论（必须落到代码与测试）

审计报告中提到“回复的最小信息”时，你的最终结论必须体现为以下三条（并且对应实现必须可验证）：

1. **先不允许生产开放注册**：生产环境默认必须关闭 public register；只能走邀请制/后台创建/受控开关；禁止新用户“直落库进 default-tenant”。
2. **“停用成员/离职”硬要求（允许自愈迁移一次）**：登录/自愈/修复路径允许做一次“自愈迁移”（你需要明确“一次”的判定与幂等保证），且必须区分：
   - **停用（DISABLED / 冷冻）**：账号/成员关系必须被冷冻，禁止登录/获取会话，且不得被任何“自愈”逻辑偷偷写回 ACTIVE。
   - **离职（OFFBOARDED / 交接）**：必须将该成员名下所有文件/资源/归属关系进行交接转移（或补充处理策略），避免出现孤儿数据/权限残留/访问越权。
3. **执行命令/设置 env 属于修复的一部分**：包括 docker/prisma/pnpm/test 等一切操作，都由你完成并在最终输出中给出可复验的命令与结果摘要。

## 3) 执行打法（必须按顺序，且一次性闭环）

### 3.1 启动前：建立“可审计”的 TODO/计划
1. 读取并内化：`AGENTS.md`、`AGENTS_2.md`、`docs\LawClick_NEW（主线：lawclick-next）A3 红队审计报告（D1）.md`。
2. 从报告中提取全部 `LC-AUDIT-###` 条目，建立清单（建议按 P0→P1→P2 排序），用 `functions.update_plan` 展示整体进度；如条目太多，plan 用高层分组，但你仍需在工作台里维护逐条状态（例如在报告末尾追加“修复状态表”，优先编辑现有文档；必须新建文件时先征求确认）。

### 3.2 基线复跑（第 1 轮：先验再改）
在不改任何代码前，先把当前 HEAD 的门禁与依赖跑通并记录基线结果（失败也要记录失败原因与堆栈）：

```bash
pnpm install:web
pnpm -C lawclick-next lint
pnpm -C lawclick-next type-check
pnpm -C lawclick-next build
pnpm -C lawclick-next test
pnpm -C lawclick-next audit:routes
pnpm -C lawclick-next audit:tenant-scope
pnpm -C lawclick-next audit:permissions-sync
```

如依赖环境缺失：在 `lawclick-next/` 内启动并对齐生产形态（Postgres + MinIO），再执行 prisma 迁移与 seed（dev only，但禁止 Mock/占位数据——使用真实 schema/真实约束/真实流程）：

```bash
cd lawclick-next
docker compose up -d
pnpm exec prisma migrate deploy
pnpm exec prisma db seed
```

> 关键要求：`.env*` 不可提交；但为了让门禁可跑，你必须自行在本地配置/生成所需 env（不泄露 secrets），并确保默认配置在生产态是安全的（例如注册默认关闭、tenant-scope 灾难开关默认不可用/不可在 prod 生效）。

### 3.3 逐条修复（不允许跳过）
对每个 `LC-AUDIT-###`，严格执行同一模板：
1. **证据对齐**：用 ace-tool 精确定位报告里的 evidence 行号对应代码；确认当前 HEAD 是否一致（不要把猜测当事实）。
2. **风险建模**：明确攻击面/误用路径/多租户影响面/回归风险。
3. **设计方案（抽象优先）**：至少给出 2 个方案对比（安全性/可维护性/扩展性/与现有架构一致性）。若需用户决策，用交互式菜单（y/n/c/r/u）一次问清 1-2 个关键问题。
4. **落地实现（全链路贯通）**：前端交互 → server action/route → DB/事务 → 错误处理/日志 → 权限/tenant-scope → 观测性（至少日志字段一致）。
5. **测试补齐（TDD 倾向）**：优先在现有 `lawclick-next/tests/e2e/` 或现有单测位置补测；必须覆盖“正常/边界/恶意输入/多租户隔离/回归点”。能不新建文件就不新建；必须新建时先说明必要性并征求确认。
6. **复跑验证（局部→全量）**：先跑最小相关命令，再跑全量门禁。
7. **证据落盘**：把关键命令输出/修复摘要写进 `docs/_artifacts/` 或既有审计跟进文档（同样遵循“优先编辑现有文件”与“新建需确认”）。

### 3.4 强制覆盖的 P0/P1 方向（至少包含这些）
你必须确保以下在代码里真实被修复并可验证（条目以报告为准，这里是最低覆盖提醒）：
- `LC-AUDIT-001`：停用成员状态不得在登录自愈里写回 `ACTIVE`；并落地“停用 vs 离职”分流策略（含一次性自愈迁移）。
- `LC-AUDIT-002`：生产环境关闭开放注册；禁止默认落库进 `default-tenant`；走邀请/后台创建/显式受控开关。
- `LC-AUDIT-003`：Credentials 登录不得在 `NODE_ENV=development` 下形成“password=null 账号可被任意密码接管”的后门；同时考虑环境误配与存量脏数据。
- `LC-AUDIT-004`：Webhook SSRF 防护必须覆盖 30x 重定向（禁止跟随或校验最终落点）；补齐 allowlist/denylist 与测试。
- `LC-AUDIT-005`：`LAWCLICK_ALLOW_UNSCOPED_TENANT_QUERIES=1` 这种“灾难开关”必须加硬保护（至少 prod 禁用 + 审计可见 + 测试覆盖）。
- `LC-AUDIT-006`：路由访问控制消除“双源漂移”（middleware 与页面/组件权限源一致且可审计）。
- `LC-AUDIT-007`：`User.isActive` 在登录/会话层强制，禁用账号无法登录/续期/拿到会话。
- `LC-AUDIT-008`：注册与登录 email 归一化策略必须一致（大小写/trim），并保证唯一性与回归测试。

### 3.5 递归修复至少 3 轮（硬指标）
- 第 1 轮：只做基线复跑，收集真实失败/风险。
- 第 2 轮：完成所有修复点实现 + 相关测试，确保全绿。
- 第 3 轮：做一次“回归清理/一致性收敛”（消除重复、统一错误处理/日志、补齐缺失校验），再次全量门禁全绿。

## 4) 输出要求（你最终回复我时必须满足）

你最终只输出“可验收的信息”，格式要求如下：

1. **修复完成矩阵**：按 `LC-AUDIT-###` 列表逐条给出：状态（fixed）、关键改动文件路径、验证命令、验证结果摘要。
2. **最小信息结论**：必须明确写出第 2 节的三条结论（生产关闭注册；停用/离职分流且一次自愈迁移；命令/env 已由你完成）。
3. **风险与兼容性说明**：只写事实与证据；不确定处必须标注“待确认”并说明你缺少哪类证据。
4. **禁止事项**：禁止让我手动补跑命令、手动改 env 才能让修复成立；禁止“只修 UI/不落库”的空壳；禁止引入 `any`；禁止吞异常；禁止编造通过的测试结果。
